  - sensor:
      - name: "current time"
        state: >-
          {{now().strftime('%H:%M %p')}}
      - name: "Bedroom Lights Color"
        state: >-
          {% if state_attr('light.group_bedroom_lights', 'rgb_color')  %}
            {{state_attr('light.group_bedroom_lights', 'rgb_color') }}
          {% endif %}
      - name: "Closet Lights Brightness"
        state: >-
          {% if state_attr('light.group_closet_lights', 'brightness')  %}
            {{state_attr('light.group_closet_lights', 'brightness') }}
           {% else %}
              1
          {% endif %}
      - name: "Playing on Bedroom Speaker"
        state: >-
          {% if state_attr('media_player.bedroom_speaker', 'media_series_title') %}
            {{ state_attr('media_player.bedroom_speaker', 'media_series_title') }}
          {% elif  state_attr('media_player.bedroom_speaker', 'media_album_name') %}
           {{ state_attr('media_player.bedroom_speaker', 'media_title') }}  -  {{ state_attr('media_player.bedroom_speaker', 'media_album_name') }} by {{ state_attr('media_player.bedroom_speaker', 'media_artist') }}
          {% elif  state_attr('media_player.bedroom_speaker', 'media_title') %}
            {{ state_attr('media_player.bedroom_speaker', 'media_title') }}
           {% elif  state_attr('media_player.bedroom_speaker', 'app_name') %}
            {{ state_attr('media_player.bedroom_speaker', 'app_name') }}
          {% endif %}
      - name: "Playing on home group Speaker"
        state: >-
          {% if state_attr('media_player.group_home_group', 'media_series_title') %}
            {{ state_attr('media_player.group_home_group', 'media_series_title') }}
          {% elif  state_attr('media_player.group_home_group', 'media_album_name') %}
           {{ state_attr('media_player.group_home_group', 'media_title') }}  -  {{ state_attr('media_player.group_home_group', 'media_album_name') }} by {{ state_attr('media_player.group_home_group', 'media_artist') }}
          {% elif  state_attr('media_player.group_home_group', 'media_title') %}
            {{ state_attr('media_player.group_home_group', 'media_title') }}
           {% elif  state_attr('media_player.group_home_group', 'app_name') %}
            {{ state_attr('media_player.group_home_group', 'app_name') }}
          {% endif %}
      - name: "Maxis Current Game"
        unique_id: "currentgamemaxi" 
        state: >-
            {% if state_attr('sensor.maxi1134_8202', 'game') %}
            {{ state_attr('sensor.maxi1134_8202', 'game') }}
            {% elif  state_attr('sensor.steam_maxi', 'game') %}
            {{state_attr('sensor.steam_maxi', 'game')}}
            {% else %} idle
            {% endif %}
      - name: "Maxis Current Discord Game"
        state: >-
            {% if state_attr('sensor.maxi1134_8202', 'game') %}
            {{ state_attr('sensor.maxi1134_8202', 'game') }}
            {% else %}idle
            {% endif %}
      - name: "Maxis Current Steam Game"
        state: >-
            {% if  state_attr('sensor.steam_maxi', 'game') %}
            {{state_attr('sensor.steam_maxi', 'game')}}
            {% else %}idle
            {% endif %}
      - name: "Where is maxi sleeping?"
        unique_id: maxi_sleeping_spot
        state: >-
          {% set ns = namespace(sleeper=0) %}
          {% set ns = namespace(sleeparraystates=[]) %}
          {% set ns = namespace(roomname="initial") %}
          {% set ns = namespace(control='') %}
          {% set ns = namespace(sleeparray=[]) %}

          {% if states.binary_sensor.maxi_alone.state == "on" %}
            {% set room = states.sensor.b7bracelet1.state %}  
            {% for input_booleans in states.input_boolean %}
                {% if 'sleeper' in input_booleans.entity_id %} 
                  {% set entity_id = input_booleans.entity_id %}
                  {% set room_name = (input_booleans.entity_id.split('_') | last) %}
                  {% if input_booleans.state == "on" %}
                    {%- set ns.sleeparray = ns.sleeparray + [entity_id] -%}        
                  {% endif %}            
                {% endif %} 
            {% endfor %}  
            {% if ns.sleeparray | length > 1 %} 
              {% set room = states.sensor.b7bracelet1.state %}
              {% for input_booleans in states.input_boolean %}
                {% if 'sleeper' in input_booleans.entity_id %}
                  {% if input_booleans.state == "on" %}        
                  {% if room in input_booleans.entity_id %}         
                    {%set ns.roomname = input_booleans.entity_id.split('_') | last%} 
                  {% else %}
                  {% set ns.roomname = "unsure" %}                      
                    {% endif %}       
                  {% endif %} 
                {% endif %} 
              {% endfor %}  
            {% elif ns.sleeparray | length == 1 %} 
              {% for input_booleans in states.input_boolean %}
                {% if 'sleeper' in input_booleans.entity_id %}
                  {% if input_booleans.state == "on" %}
                    {%set ns.roomname = input_booleans.entity_id.split('_') | last%}
                {% endif %} 
              {% endif %} 
            {% endfor %}  
            {% else %}
              {%set ns.roomname = "unsure" %}
            {% endif %}   
          {% elif states.binary_sensor.maxi_alone.state == "off" %}
            {% set room = states.sensor.b7bracelet1.state %}  
            {% set ns.roomname = "unsure" %}    
              {% for input_booleans in states.input_boolean %}
                {% if 'sleeper' in input_booleans.entity_id %}
                  {% if input_booleans.state == "on" %}
                  {% if room in input_booleans.entity_id %}
                    {% set ns.roomname = input_booleans.entity_id.split('_') | last %}
                  {% endif %} 
                {% endif %} 
              {% endif %} 
            {% endfor %}  
          {% else %}
          EDGECASE
          {% endif %}
          {{ ns.roomname }}
      - name: "Where is maxi sleeping?(Chat GPT Improved)"
        unique_id: maxi_sleeping_spot_chatgpt
        state: >-
          {% set ns = namespace(sleeper=0, sleeparraystates=[], roomname="initial", control='', sleeparray=[]) %}

          {% set room = states.sensor.b7bracelet1.state %}

          {% if states.binary_sensor.maxi_alone.state == "on" %}
            {% set sleeparray = states.input_boolean | selectattr('entity_id', 'contains', 'sleeper') | selectattr('state', 'eq', 'on') | map(attribute='entity_id') | list %}
            {% if sleeparray | length > 1 %} 
              {% for input_boolean in states.input_boolean %}
                {% if input_boolean.entity_id in sleeparray %}         
                  {% if room in input_boolean.entity_id %}         
                    {%set ns.roomname = input_boolean.entity_id.split('_') | last%} 
                  {% else %}
                    {% set ns.roomname = "unsure" %}                      
                  {% endif %}       
                {% endif %} 
              {% endfor %}  
            {% elif sleeparray | length == 1 %} 
              {% set ns.roomname = sleeparray[0].split('_') | last %}
            {% else %}
              {%set ns.roomname = "unsure" %}
            {% endif %}   
          {% elif states.binary_sensor.maxi_alone.state == "off" %}
            {% for input_boolean in states.input_boolean %}
              {% if input_boolean.entity_id | contains('sleeper') and input_boolean.state == "on" and room in input_boolean.entity_id %}
                {% set ns.roomname = input_boolean.entity_id.split('_') | last %}
              {% endif %} 
            {% endfor %}  
          {% else %}
            EDGECASE
          {% endif %}
          {{ ns.roomname }}

      - name: "Where is maxi sleeping?(V2)"
        unique_id: maxi_sleeping_spot_v2
        state: >-
          {% set ns = namespace(sleeper=0, sleeparraystates=[], allowed_ids=[], roomname="initial", control='', sleeparray=[], motionarrays=[], motion_sensors=[]) %}  {# create a namespace object to store variables #}
          {% set room = states.sensor.b7bracelet1.state %}  {# get the current room sensor state #}

          {% if states.binary_sensor.maxi_alone.state == "on" %}  {# if the maxi_alone sensor is on, indicating there is only maxi present #}
            {% set sleeparray = states.input_boolean | selectattr('entity_id', 'contains', 'sleeper') | selectattr('state', 'eq', 'on') | map(attribute='entity_id') | list %}  {# get a list of all the input_boolean entities that are "sleeper" and are "on" #}
            {% if sleeparray | length > 1 %}  {# if there is more than one "sleeper" input_boolean that is "on" #}
              {% for input_boolean in states.input_boolean %}  {# loop through each input_boolean #}
                {% if input_boolean.entity_id in sleeparray %}  {# if the current input_boolean is in the list of "sleeper" input_booleans that are "on" #}
                  {% if room in input_boolean.entity_id %}  {# if the current input_boolean is in the current room #}
                    {% set ns.roomname = input_boolean.entity_id.split('_') | last %}  {# set the roomname to the last part of the entity_id, after splitting it by '_' #}
                  {% elif not room in input_boolean.entity_id and ns.roomname == "initial" %}  {# if the current input_boolean is not in the current room and the previous if has not changed it#}
                          {% for name in sleeparray %}
                          {% set sleepername = name.split('_') | last %}      
                          {% set ns.allowed_ids = ns.allowed_ids + [sleepername] %}      
                          {% endfor %}      
                          {% for state in states.binary_sensor -%} 
                                  {%- if state.attributes.get('device_class') == 'motion' -%}
                                      {% for allowed_rooms in ns.allowed_ids %}                        
                                        {% set index = loop.index0 %}
                                        {% if ns.allowed_ids[index] in state.entity_id and "binary_sensor.sensor_" in state.entity_id %} 
                                          {% set sensor = {'entity_id': state.entity_id, 'last_changed': state.last_changed} %}
                                          {% set ns.motion_sensors = ns.motion_sensors + [sensor] %}
                                        {%- endif %}
                                      {% endfor %}
                                  {% endif %}
                          {% endfor %}            
                    {% set sorted_sensors = ns.motion_sensors | sort(attribute='last_changed') %}
                    {% set last_sensor = sorted_sensors | last %}
                    {% set room_before_split =last_sensor.entity_id | replace('binary_sensor.sensor_','')| replace('_motion_occupancy','')%}
                    {% set ns.roomname = room_before_split.split('_') | first %}
                  {% endif %}
                {% endif %} 
              {% endfor %} 
            {% elif sleeparray | length == 1 %}  {# if there is only one "sleeper" input_boolean that is "on" #}
              {% set ns.roomname = sleeparray[0].split('_') | last %}  {# set the roomname to the last part of the entity_id of the only "sleeper" input_boolean that is "on" #}
            {% else %}  {# if there are no "sleeper" input_booleans that are "on" #}
              {% set ns.roomname = "unsure" %}  {# set the roomname to "unsure" #}
            {% endif %}   
          {% elif states.binary_sensor.maxi_alone.state == "off" %}  {# if the maxi_alone sensor is off, it indicates that there is more than maxi present #}
            {% for input_boolean in states.input_boolean %}
              {% if input_boolean.entity_id | contains('sleeper') and input_boolean.state == "on" and room in input_boolean.entity_id %}
                {% set ns.roomname = input_boolean.entity_id.split('_') | last %}
              {% endif %} 
            {% endfor %}  
          {% else %}
            EDGECASE
          {% endif %}
          {{ ns.roomname}}

  - binary_sensor:
      - name: "All Present Sleeping"
        delay_off:
          minutes: 7
        state: >
         {% if ((is_state('person.maximiliano', 'home') and is_state('binary_sensor.maxi_sleeping', 'on' ) ) or not is_state('person.maximiliano', 'home' ))  %}on{% else  %}off{% endif %}
      - name: "Sensor Patio Occupancy"
        delay_off:
          minutes: 7
        state: >
         {{ not is_state('sensor.patiocam_person_count', "0")
             or not is_state('binary_sensor.sensor_patio_motion_occupancy', 'off')
             or not is_state('binary_sensor.sensor_patio_ceiling_motion_occupancy', 'off')
             }}
      - name: "Bathroom Occupancy"
        delay_off:
          minutes: 2
        state: >
         {{ is_state('binary_sensor.sensor_bathroom_motion_occupancy', "on")
             or is_state('binary_sensor.sensor_bathroom_door_contact', 'off') and is_state('switch.bathroom_fan', 'on')
             }}
      - name: "Maxi's ears busy"
        unique_id: "maxisearsbusy" 
        state: >
         {{ (not is_state('sensor.currentgamemaxi', "idle") and is_state('sensor.b7bracelet1', "office" ))
             or (is_state('media_player.maxi_pc_mediaplayer', 'playing') and ("chrome" in "sensor.maxi_pc_activewindow"))
             or ( is_state('media_player.bedroom_chromecast', 'playing') and state_attr('media_player.bedroom_chromecast', 'is_volume_muted') == false )
             or is_state('binary_sensor.maxi_pc_microphoneactive', 'on')
             }}
