
########################## MAXI PC ##########################
  
  - name: "Maxi PC MediaPlayer"
    platform: hass_agent_mediaplayer
    host: 192.168.0.69
    port: 5115

####################################################################

# WIIM PLAYERS #


  - platform: linkplay
    host: 192.168.40.78
    name: Wiim Office
    volume_step: 1
    icecast_metadata: 'StationNameSongTitle'
    multiroom_wifidirect: False
  - platform: linkplay
    host: 192.168.40.76
    name: Wiim Hotbox
    volume_step: 1
    icecast_metadata: 'StationNameSongTitle'
    multiroom_wifidirect: False
  - platform: linkplay
    host: 192.168.40.74
    name: Wiim LivingRoom
    volume_step: 1
    icecast_metadata: 'StationNameSongTitle'
    multiroom_wifidirect: False


########################## TEMPLATE SPEAKERS ##########################


  - platform: media_player_template
    media_players:
      template_group_home_speakers:
        friendly_name: Template Group Home Speakers
        device_class: speaker
        value_template: >
                {% set ns = namespace( cast_entity = "media_player.group_home_speakers", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Varibles#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id  %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if ( media_title | string ) in state_attr( ns.cast_entity, 'media_title') %}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.final_entity != ns.cast_entity %}
                  {{states(ns.final_entity)}}
                {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                  {{states(ns.cast_entity)}}
                {% else %}
                  off
                {% endif %}
        next:
          service: media_player.media_seek
          data_template:
            entity_id: media_player.group_home_speakers
            seek_position: 56000
        turn_on:
          service: media_player.turn_on
          data_template:
            entity_id: media_player.group_home_speakers
        stop:
          service: media_player.media_stop
          data_template:
            entity_id: media_player.group_home_speakers
        turn_off:
          service: media_player.turn_off
          data_template:
            entity_id: media_player.group_home_speakers
        volume_up:
          service: media_player.volume_up
          data_template:
            entity_id: media_player.group_home_speakers
        play:
          service: media_player.media_play
          data_template:
            entity_id: media_player.group_home_speakers
        pause:
          service: media_player.media_pause
          data_template:
            entity_id: media_player.group_home_speakers
        volume_down:
          service: media_player.volume_down
          data_template:
            entity_id: media_player.group_home_speakers
        mute:
          service: media_player.volume_mute
          data_template:
            is_volume_muted: "true"
            entity_id: media_player.group_home_speakers
        set_volume:
          service: media_player.volume_set
          data_template:
            entity_id: media_player.group_home_speakers
            volume_level: "{{ volume }}"
        current_is_muted_template: "{{state_attr( 'media_player.group_home_speakers', 'is_volume_muted') }}"
        media_image_url_template: >
                {% set ns = namespace( cast_entity = "media_player.group_home_speakers", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id  %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if ( media_title | string ) in state_attr( ns.cast_entity, 'media_title') %}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.template_entity != ns.cast_entity and ns.template_entity != "" %}                   
                  {{state_attr(ns.template_entity, 'entity_picture')}}
                {% elif state_attr( ns.cast_entity, 'entity_picture')  %} 
                  {{state_attr(ns.cast_entity, 'entity_picture')}} 
                {% else %}
                  off
                {% endif %}
        title_template: "{{state_attr( 'media_player.group_home_speakers', 'media_title') }}"
        album_template: "{{ state_attr( 'media_player.group_home_speakers', 'media_album_name')}}"
        artist_template: >
                {% if state_attr( 'media_player.office_speaker', 'media_album_artist') %}
                {{ state_attr( 'media_player.office_speaker', 'media_album_artist') }}
                {% elif state_attr( 'media_player.office_speaker', 'media_artist') %}                
                {{ state_attr( 'media_player.office_speaker', 'media_artist') }}
                {% endif %}
        unique_id: template_group_home_speakers
        media_content_type_template: music



      template_hotbox_down_wiim_speaker:
        friendly_name: Template Hotbox Wiim Speaker
        device_class: speaker
        value_template: >
                {% set ns = namespace( cast_entity = "media_player.hotbox_down_wiim_speaker", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Varibles#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id  %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if ( media_title | string ) in state_attr( ns.cast_entity, 'media_title') %}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.final_entity != ns.cast_entity %}
                  {{states(ns.template_entity)}}
                {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                  {{states(ns.cast_entity)}}
                {% else %}
                  off
                {% endif %}
        next:
          service: media_player.media_seek
          data_template:
            entity_id: media_player.hotbox_down_wiim_speaker
            seek_position: 56000
        turn_on:
          service: media_player.turn_on
          data_template:
            entity_id: media_player.hotbox_down_wiim_speaker
        stop:
          service: media_player.media_stop
          data_template:
            entity_id: media_player.hotbox_down_wiim_speaker
        turn_off:
          service: media_player.turn_off
          data_template:
            entity_id: media_player.hotbox_down_wiim_speaker
        volume_up:
          service: media_player.volume_up
          data_template:
            entity_id: media_player.hotbox_down_wiim_speaker
        play:
          service: media_player.media_play
          data_template:
            entity_id: media_player.hotbox_down_wiim_speaker
        pause:
          service: media_player.media_pause
          data_template:
            entity_id: media_player.hotbox_down_wiim_speaker
        volume_down:
          service: media_player.volume_down
          data_template:
            entity_id: media_player.hotbox_down_wiim_speaker
        mute:
          service: media_player.volume_mute
          data_template:
            is_volume_muted: "true"
            entity_id: media_player.hotbox_down_wiim_speaker
        set_volume:
          service: media_player.volume_set
          data_template:
            entity_id: media_player.hotbox_down_wiim_speaker
            volume_level: "{{ volume }}"
        current_is_muted_template: "{{state_attr( 'media_player.hotbox_down_wiim_speaker', 'is_volume_muted') }}"
        media_image_url_template: >
                {% set ns = namespace( cast_entity = "media_player.hotbox_down_wiim_speaker", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id  %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if ( media_title | string ) in state_attr( ns.cast_entity, 'media_title') %}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.template_entity != ns.cast_entity and ns.template_entity != "" %}                   
                  {{state_attr(ns.template_entity, 'entity_picture')}}
                {% elif state_attr( ns.cast_entity, 'entity_picture')  %} 
                  {{state_attr(ns.cast_entity, 'entity_picture')}} 
                {% else %}
                  off
                {% endif %}
        title_template: "{{state_attr( 'media_player.hotbox_down_wiim_speaker', 'media_title') }}"
        album_template: "{{ state_attr( 'media_player.hotbox_down_wiim_speaker', 'media_album_name')}}"
        artist_template: >
                {% if state_attr( 'media_player.office_speaker', 'media_album_artist') %}
                {{ state_attr( 'media_player.office_speaker', 'media_album_artist') }}
                {% elif state_attr( 'media_player.office_speaker', 'media_artist') %}                
                {{ state_attr( 'media_player.office_speaker', 'media_artist') }}
                {% endif %}
        unique_id: template_hotbox_down_wiim_speaker
        media_content_type_template: music






      template_livingroom_wiim_speaker:
        friendly_name: Template Livingroom Wiim Speaker
        device_class: speaker
        value_template: >
                {% set ns = namespace( cast_entity = "media_player.livingroom_wiim_speaker", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Varibles#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id  %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if ( media_title | string ) in state_attr( ns.cast_entity, 'media_title') %}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.final_entity != ns.cast_entity %}
                  {{states(ns.template_entity)}}
                {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                  {{states(ns.cast_entity)}}
                {% else %}
                  off
                {% endif %}
        next:
          service: media_player.media_seek
          data_template:
            entity_id: media_player.livingroom_wiim_speaker
            seek_position: 56000
        turn_on:
          service: media_player.turn_on
          data_template:
            entity_id: media_player.livingroom_wiim_speaker
        stop:
          service: media_player.media_stop
          data_template:
            entity_id: media_player.livingroom_wiim_speaker
        turn_off:
          service: media_player.turn_off
          data_template:
            entity_id: media_player.livingroom_wiim_speaker
        volume_up:
          service: media_player.volume_up
          data_template:
            entity_id: media_player.livingroom_wiim_speaker
        play:
          service: media_player.media_play
          data_template:
            entity_id: media_player.livingroom_wiim_speaker
        pause:
          service: media_player.media_pause
          data_template:
            entity_id: media_player.livingroom_wiim_speaker
        volume_down:
          service: media_player.volume_down
          data_template:
            entity_id: media_player.livingroom_wiim_speaker
        mute:
          service: media_player.volume_mute
          data_template:
            is_volume_muted: "true"
            entity_id: media_player.livingroom_wiim_speaker
        set_volume:
          service: media_player.volume_set
          data_template:
            entity_id: media_player.livingroom_wiim_speaker
            volume_level: "{{ volume }}"
        current_is_muted_template: "{{state_attr( 'media_player.livingroom_wiim_speaker', 'is_volume_muted') }}"
        media_image_url_template: >
                {% set ns = namespace( cast_entity = "media_player.livingroom_wiim_speaker", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id  %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if ( media_title | string ) in state_attr( ns.cast_entity, 'media_title') %}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.template_entity != ns.cast_entity and ns.template_entity != "" %}                   
                  {{state_attr(ns.template_entity, 'entity_picture')}}
                {% elif state_attr( ns.cast_entity, 'entity_picture')  %} 
                  {{state_attr(ns.cast_entity, 'entity_picture')}} 
                {% else %}
                  off
                {% endif %}
        title_template: "{{state_attr( 'media_player.livingroom_wiim_speaker', 'media_title') }}"
        album_template: "{{ state_attr( 'media_player.livingroom_wiim_speaker', 'media_album_name')}}"
        artist_template: >
                {% if state_attr( 'media_player.office_speaker', 'media_album_artist') %}
                {{ state_attr( 'media_player.office_speaker', 'media_album_artist') }}
                {% elif state_attr( 'media_player.office_speaker', 'media_artist') %}                
                {{ state_attr( 'media_player.office_speaker', 'media_artist') }}
                {% endif %}
        unique_id: template_livingroom_wiim_speaker
        media_content_type_template: music




      template_office_wiim_speaker:
        friendly_name: Template Office Wiim Speaker
        device_class: speaker
        value_template: >
                {% set ns = namespace( cast_entity = "media_player.office_speaker", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Varibles#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id  %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if ( media_title | string ) in state_attr( ns.cast_entity, 'media_title') %}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.final_entity != ns.cast_entity %}
                  {{states(ns.template_entity)}}
                {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                   {{states(ns.cast_entity)}}
                {% else %}
                  off
                {% endif %}
        next:
          service: media_player.media_seek
          data_template:
            entity_id: media_player.office_speaker
            seek_position: 56000
        turn_on:
          service: media_player.turn_on
          data_template:
            entity_id: media_player.office_speaker
        stop:
          service: media_player.media_stop
          data_template:
            entity_id: media_player.office_speaker
        turn_off:
          service: media_player.turn_off
          data_template:
            entity_id: media_player.office_speaker
        volume_up:
          service: media_player.volume_up
          data_template:
            entity_id: media_player.office_speaker
        play:
          service: media_player.media_play
          data_template:
            entity_id: media_player.office_speaker
        pause:
          service: media_player.media_pause
          data_template:
            entity_id: media_player.office_speaker
        volume_down:
          service: media_player.volume_down
          data_template:
            entity_id: media_player.office_speaker
        mute:
          service: media_player.volume_mute
          data_template:
            is_volume_muted: "true"
            entity_id: media_player.office_speaker
        set_volume:
          service: media_player.volume_set
          data_template:
            entity_id: media_player.office_speaker
            volume_level: "{{ volume }}"
        current_is_muted_template: "{{state_attr( 'media_player.office_speaker', 'is_volume_muted') }}"
        media_image_url_template: >
                {% set ns = namespace( cast_entity = "media_player.office_speaker", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id  %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if ( media_title | string ) in state_attr( ns.cast_entity, 'media_title') %}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.template_entity != ns.cast_entity and ns.template_entity != "" %}                   
                  {{state_attr(ns.template_entity, 'entity_picture')}}
                {% elif state_attr( ns.cast_entity, 'entity_picture')  %} 
                  {{state_attr(ns.cast_entity, 'entity_picture')}} 
                {% else %}
                  off
                {% endif %}
        title_template: "{{state_attr( 'media_player.office_speaker', 'media_title') }}"
        album_template: "{{ state_attr( 'media_player.office_speaker', 'media_album_name')}}"
        artist_template: >
                {% if state_attr( 'media_player.office_speaker', 'media_album_artist') %}
                {{ state_attr( 'media_player.office_speaker', 'media_album_artist') }}
                {% elif state_attr( 'media_player.office_speaker', 'media_artist') %}                
                {{ state_attr( 'media_player.office_speaker', 'media_artist') }}
                {% endif %}
        unique_id: template_office_wiim_speaker
        media_content_type_template: music


        
      template_kitchen_speaker:
        friendly_name: Template Kitchen Speaker
        device_class: speaker
        value_template: >
                {% set ns = namespace( cast_entity = "media_player.kitchen_speaker", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Varibles#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id  %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if ( media_title | string ) in state_attr( ns.cast_entity, 'media_title') %}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.final_entity != ns.cast_entity %}
                  {{states(ns.template_entity)}}
                {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                  {{states(ns.cast_entity)}}
                {% else %}
                  off
                {% endif %}
        next:
          service: media_player.media_seek
          data_template:
            entity_id: media_player.kitchen_speaker
            seek_position: 56000
        turn_on:
          service: media_player.turn_on
          data_template:
            entity_id: media_player.kitchen_speaker
        stop:
          service: media_player.media_stop
          data_template:
            entity_id: media_player.kitchen_speaker
        turn_off:
          service: media_player.turn_off
          data_template:
            entity_id: media_player.kitchen_speaker
        volume_up:
          service: media_player.volume_up
          data_template:
            entity_id: media_player.kitchen_speaker
        play:
          service: media_player.media_play
          data_template:
            entity_id: media_player.kitchen_speaker
        pause:
          service: media_player.media_pause
          data_template:
            entity_id: media_player.kitchen_speaker
        volume_down:
          service: media_player.volume_down
          data_template:
            entity_id: media_player.kitchen_speaker
        mute:
          service: media_player.volume_mute
          data_template:
            is_volume_muted: "true"
            entity_id: media_player.kitchen_speaker
        set_volume:
          service: media_player.volume_set
          data_template:
            entity_id: media_player.kitchen_speaker
            volume_level: "{{ volume }}"
        current_is_muted_template: "{{state_attr( 'media_player.kitchen_speaker', 'is_volume_muted') }}"
        media_image_url_template: >
                {% set ns = namespace( cast_entity = "media_player.kitchen_speaker", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id  %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if ( media_title | string ) in state_attr( ns.cast_entity, 'media_title') %}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.template_entity != ns.cast_entity and ns.template_entity != "" %}                   
                  {{state_attr(ns.template_entity, 'entity_picture')}}
                {% elif state_attr( ns.cast_entity, 'entity_picture')  %} 
                  {{state_attr(ns.cast_entity, 'entity_picture')}} 
                {% else %}
                  off
                {% endif %}
        title_template: "{{state_attr( 'media_player.kitchen_speaker', 'media_title') }}"
        album_template: "{{ state_attr( 'media_player.kitchen_speaker', 'media_album_name')}}"
        artist_template: >
                {% if state_attr( 'media_player.office_speaker', 'media_album_artist') %}
                {{ state_attr( 'media_player.office_speaker', 'media_album_artist') }}
                {% elif state_attr( 'media_player.office_speaker', 'media_artist') %}                
                {{ state_attr( 'media_player.office_speaker', 'media_artist') }}
                {% endif %}
        unique_id: template_kitchen_speaker
        media_content_type_template: music

        
      template_hallway_speaker:
        friendly_name: Template Hallway Speaker
        device_class: speaker
        value_template: >
                {% set ns = namespace( cast_entity = "media_player.hallway_speaker", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Varibles#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id  %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if ( media_title | string ) in state_attr( ns.cast_entity, 'media_title') %}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.final_entity != ns.cast_entity %}
                  {{states(ns.template_entity)}}
                {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                  {{states(ns.cast_entity)}}
                {% else %}
                  off
                {% endif %}
        next:
          service: media_player.media_seek
          data_template:
            entity_id: media_player.hallway_speaker
            seek_position: 56000
        turn_on:
          service: media_player.turn_on
          data_template:
            entity_id: media_player.hallway_speaker
        stop:
          service: media_player.media_stop
          data_template:
            entity_id: media_player.hallway_speaker
        turn_off:
          service: media_player.turn_off
          data_template:
            entity_id: media_player.hallway_speaker
        volume_up:
          service: media_player.volume_up
          data_template:
            entity_id: media_player.hallway_speaker
        play:
          service: media_player.media_play
          data_template:
            entity_id: media_player.hallway_speaker
        pause:
          service: media_player.media_pause
          data_template:
            entity_id: media_player.hallway_speaker
        volume_down:
          service: media_player.volume_down
          data_template:
            entity_id: media_player.hallway_speaker
        mute:
          service: media_player.volume_mute
          data_template:
            is_volume_muted: "true"
            entity_id: media_player.hallway_speaker
        set_volume:
          service: media_player.volume_set
          data_template:
            entity_id: media_player.hallway_speaker
            volume_level: "{{ volume }}"
        current_is_muted_template: "{{state_attr( 'media_player.kitchen_speaker', 'is_volume_muted') }}"
        media_image_url_template: >
                {% set ns = namespace( cast_entity = "media_player.kitchen_speaker", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id  %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if ( media_title | string ) in state_attr( ns.cast_entity, 'media_title') %}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.final_entity != ns.cast_entity %}                  
                  {{state_attr(ns.template_entity, 'entity_picture')}}
                {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                  {{state_attr(ns.cast_entity, 'entity_picture')}} 
                {% else %}
                  off
                {% endif %}
        title_template: "{{state_attr( 'media_player.kitchen_speaker', 'media_title') }}"
        album_template: "{{ state_attr( 'media_player.kitchen_speaker', 'media_album_name')}}"
        artist_template: >
                {% if state_attr( 'media_player.office_speaker', 'media_album_artist') %}
                {{ state_attr( 'media_player.office_speaker', 'media_album_artist') }}
                {% elif state_attr( 'media_player.office_speaker', 'media_artist') %}                
                {{ state_attr( 'media_player.office_speaker', 'media_artist') }}
                {% endif %}
        unique_id: template_hallway_speaker
        media_content_type_template: music

########################## TEMPLATE CHROMECASTS ##########################



      template_hotbox_top_chromecast:
        friendly_name: Template hotbox top Chromecast
        device_class: speaker
        value_template: >
                {% set ns = namespace( cast_entity = "media_player.hotbox_top_chromecast", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                    {% set media_series_title = state_attr( entity, 'media_series_title') %}
                    {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                    {% set media_series_season = state_attr( entity, 'media_season') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% elif state_attr( ns.final_entity, 'media_series_title') %}
                        {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}                      
                  {% endif %}                  
                {% endfor %}                
                {% if ns.template_entity == "" %}
                    {% set ns.template_entity = ns.cast_entity %}
                {% endif %}
                {% if ns.template_entity != ns.cast_entity %}                  
                  {{states(ns.template_entity)}}
                {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                  {{states(ns.cast_entity)}}
                {% else %}
                  off
                {% endif %}
        next:
          service: media_player.media_seek
          data_template:
            entity_id: media_player.hotbox_top_chromecast
            seek_position: 56000
        turn_on:
          service: media_player.turn_on
          data_template:
            entity_id: media_player.hotbox_top_chromecast
        stop:
          service: media_player.media_stop
          data_template:
            entity_id: media_player.hotbox_top_chromecast
        turn_off:
          service: media_player.turn_off
          data_template:
            entity_id: media_player.hotbox_top_chromecast
        volume_up:
          service: media_player.volume_up
          data_template:
            entity_id: media_player.hotbox_top_chromecast
        volume_down:
          service: media_player.volume_down
          data_template:
            entity_id: media_player.hotbox_top_chromecast
        mute:
          service: media_player.volume_mute
          data_template:
            is_volume_muted: "true"
            entity_id: media_player.hotbox_top_chromecast
        set_volume:
          service: media_player.volume_set
          data_template:
            entity_id: media_player.hotbox_top_chromecast
            volume_level: "{{ volume }}"
        current_is_muted_template: "{{state_attr( 'media_player.hotbox_top_chromecast', 'is_volume_muted') }}"
        media_image_url_template: >
                {% set ns = namespace( cast_entity = "media_player.hotbox_top_chromecast", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                    {% set media_series_title = state_attr( entity, 'media_series_title') %}
                    {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                    {% set media_series_season = state_attr( entity, 'media_season') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% elif state_attr( ns.final_entity, 'media_series_title') %}
                        {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}                      
                  {% endif %}                  
                {% endfor %}                
                {% if ns.template_entity == "" %}
                    {% set ns.template_entity = ns.cast_entity %}
                {% endif %}
                {% if ns.template_entity != ns.cast_entity %}                  
                  {{state_attr(ns.template_entity, 'entity_picture')}}
                {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                  {{state_attr(ns.cast_entity, 'entity_picture')}} 
                {% else %}
                  off
                {% endif %}
        media_series_title_template: "{{state_attr( 'media_player.hotbox_top_chromecast', 'media_series_title') }}"
        title_template: "{{state_attr( 'media_player.hotbox_top_chromecast', 'media_title') }}"
        media_episode_template: "{{state_attr( 'media_player.hotbox_top_chromecast', 'media_episode') }}"
        media_season_template: "{{state_attr( 'media_player.hotbox_top_chromecast', 'media_season') }}"
        unique_id: template_hotbox_top_chromecast



      template_hotbox_down_chromecast:
        friendly_name: Template hotbox down Chromecast
        device_class: speaker
        value_template: >
                {% set ns = namespace( cast_entity = "media_player.hotbox_down_chromecast", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                    {% set media_series_title = state_attr( entity, 'media_series_title') %}
                    {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                    {% set media_series_season = state_attr( entity, 'media_season') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% elif state_attr( ns.final_entity, 'media_series_title') %}
                        {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}                      
                  {% endif %}                  
                {% endfor %}                
                {% if ns.template_entity == "" %}
                    {% set ns.template_entity = ns.cast_entity %}
                {% endif %}
                {% if ns.template_entity != ns.cast_entity %}                  
                  {{states(ns.template_entity)}}
                {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                  {{states(ns.cast_entity)}}
                {% else %}
                  off
                {% endif %}
        next:
          service: media_player.media_seek
          data_template:
            entity_id: media_player.hotbox_down_chromecast
            seek_position: 56000
        turn_on:
          service: media_player.turn_on
          data_template:
            entity_id: media_player.hotbox_down_chromecast
        stop:
          service: media_player.media_stop
          data_template:
            entity_id: media_player.hotbox_down_chromecast
        turn_off:
          service: media_player.turn_off
          data_template:
            entity_id: media_player.hotbox_down_chromecast
        volume_up:
          service: media_player.volume_up
          data_template:
            entity_id: media_player.hotbox_down_chromecast
        volume_down:
          service: media_player.volume_down
          data_template:
            entity_id: media_player.hotbox_down_chromecast
        mute:
          service: media_player.volume_mute
          data_template:
            is_volume_muted: "true"
            entity_id: media_player.hotbox_down_chromecast
        set_volume:
          service: media_player.volume_set
          data_template:
            entity_id: media_player.hotbox_down_chromecast
            volume_level: "{{ volume }}"
        current_is_muted_template: "{{state_attr( 'media_player.hotbox_down_chromecast', 'is_volume_muted') }}"
        media_image_url_template: >
                {% set ns = namespace( cast_entity = "media_player.hotbox_down_chromecast", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                    {% set media_series_title = state_attr( entity, 'media_series_title') %}
                    {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                    {% set media_series_season = state_attr( entity, 'media_season') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% elif state_attr( ns.final_entity, 'media_series_title') %}
                        {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}                      
                  {% endif %}                  
                {% endfor %}                
                {% if ns.template_entity == "" %}
                    {% set ns.template_entity = ns.cast_entity %}
                {% endif %}
                {% if ns.template_entity != ns.cast_entity %}                  
                  {{state_attr(ns.template_entity, 'entity_picture')}}
                {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                  {{state_attr(ns.cast_entity, 'entity_picture')}} 
                {% else %}
                  off
                {% endif %}
        media_series_title_template: "{{state_attr( 'media_player.hotbox_down_chromecast', 'media_series_title') }}"
        title_template: "{{state_attr( 'media_player.hotbox_down_chromecast', 'media_title') }}"
        media_episode_template: "{{state_attr( 'media_player.hotbox_down_chromecast', 'media_episode') }}"
        media_season_template: "{{state_attr( 'media_player.hotbox_down_chromecast', 'media_season') }}"
        unique_id: template_hotbox_down_chromecast



      template_office_chromecast:
        friendly_name: Template Office Chromecast
        device_class: speaker
        value_template: >
                {% set ns = namespace( cast_entity = "media_player.office_chromecast", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                    {% set media_series_title = state_attr( entity, 'media_series_title') %}
                    {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                    {% set media_series_season = state_attr( entity, 'media_season') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% elif state_attr( ns.final_entity, 'media_series_title') %}
                        {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}                      
                  {% endif %}                  
                {% endfor %}                
                {% if ns.template_entity == "" %}
                    {% set ns.template_entity = ns.cast_entity %}
                {% endif %}
                {% if ns.template_entity != ns.cast_entity %}                  
                  {{states(ns.template_entity)}}
                {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                  {{states(ns.cast_entity)}}
                {% else %}
                  off
                {% endif %}
        next:
          service: media_player.media_seek
          data_template:
            entity_id: media_player.office_chromecast
            seek_position: 56000
        turn_on:
          service: media_player.turn_on
          data_template:
            entity_id: media_player.office_chromecast
        stop:
          service: media_player.media_stop
          data_template:
            entity_id: media_player.office_chromecast
        turn_off:
          service: media_player.turn_off
          data_template:
            entity_id: media_player.office_chromecast
        volume_up:
          service: media_player.volume_up
          data_template:
            entity_id: media_player.office_chromecast
        volume_down:
          service: media_player.volume_down
          data_template:
            entity_id: media_player.office_chromecast
        mute:
          service: media_player.volume_mute
          data_template:
            is_volume_muted: "true"
            entity_id: media_player.office_chromecast
        set_volume:
          service: media_player.volume_set
          data_template:
            entity_id: media_player.office_chromecast
            volume_level: "{{ volume }}"
        current_is_muted_template: "{{state_attr( 'media_player.office_chromecast', 'is_volume_muted') }}"
        media_image_url_template: >
                {% set ns = namespace( cast_entity = "media_player.office_chromecast", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                    {% set media_series_title = state_attr( entity, 'media_series_title') %}
                    {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                    {% set media_series_season = state_attr( entity, 'media_season') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% elif state_attr( ns.final_entity, 'media_series_title') %}
                        {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}                      
                  {% endif %}                  
                {% endfor %}                
                {% if ns.template_entity == "" %}
                    {% set ns.template_entity = ns.cast_entity %}
                {% endif %}
                {% if ns.template_entity != ns.cast_entity %}                  
                  {{state_attr(ns.template_entity, 'entity_picture')}}
                {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                  {{state_attr(ns.cast_entity, 'entity_picture')}} 
                {% else %}
                  off
                {% endif %}
        media_series_title_template: "{{state_attr( 'media_player.office_chromecast', 'media_series_title') }}"
        title_template: "{{state_attr( 'media_player.office_chromecast', 'media_title') }}"
        media_episode_template: "{{state_attr( 'media_player.office_chromecast', 'media_episode') }}"
        media_season_template: "{{state_attr( 'media_player.office_chromecast', 'media_season') }}"
        unique_id: template_office_chromecast



      template_livingroom_chromecast:
        friendly_name: Template livingroom Chromecast
        device_class: speaker
        value_template: >
                {% set ns = namespace( cast_entity = "media_player.livingroom_chromecast", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                    {% set media_series_title = state_attr( entity, 'media_series_title') %}
                    {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                    {% set media_series_season = state_attr( entity, 'media_season') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% elif state_attr( ns.final_entity, 'media_series_title') %}
                        {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}                      
                  {% endif %}                  
                {% endfor %}                
                {% if ns.template_entity == "" %}
                    {% set ns.template_entity = ns.cast_entity %}
                {% endif %}
                {% if ns.template_entity != ns.cast_entity %}                  
                  {{states(ns.template_entity)}}
                {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                  {{states(ns.cast_entity)}}
                {% else %}
                  off
                {% endif %}
        next:
          service: media_player.media_seek
          data_template:
            entity_id: media_player.livingroom_chromecast
            seek_position: 56000
        turn_on:
          service: media_player.turn_on
          data_template:
            entity_id: media_player.livingroom_chromecast
        stop:
          service: media_player.media_stop
          data_template:
            entity_id: media_player.livingroom_chromecast
        turn_off:
          service: media_player.turn_off
          data_template:
            entity_id: media_player.livingroom_chromecast
        volume_up:
          service: media_player.volume_up
          data_template:
            entity_id: media_player.livingroom_chromecast
        volume_down:
          service: media_player.volume_down
          data_template:
            entity_id: media_player.livingroom_chromecast
        mute:
          service: media_player.volume_mute
          data_template:
            is_volume_muted: "true"
            entity_id: media_player.livingroom_chromecast
        set_volume:
          service: media_player.volume_set
          data_template:
            entity_id: media_player.livingroom_chromecast
            volume_level: "{{ volume }}"
        current_is_muted_template: "{{state_attr( 'media_player.livingroom_chromecast', 'is_volume_muted') }}"
        media_image_url_template: >
                {% set ns = namespace( cast_entity = "media_player.livingroom_chromecast", template_entity = "" ) %}
                {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                {% for media_player in states.media_player %} 
                  {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                    {% set media_series_title = state_attr( entity, 'media_series_title') %}
                    {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                    {% set media_series_season = state_attr( entity, 'media_season') %}
                      {% if state_attr( ns.final_entity, 'media_title') %}
                        {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% elif state_attr( ns.final_entity, 'media_series_title') %}
                        {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                        {% set ns.template_entity = entity %}
                        {% endif %}
                      {% endif %}                      
                  {% endif %}                  
                {% endfor %}                
                {% if ns.template_entity == "" %}
                    {% set ns.template_entity = ns.cast_entity %}
                {% endif %}
                {% if ns.template_entity != ns.cast_entity %}                  
                  {{state_attr(ns.template_entity, 'entity_picture')}}
                {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                  {{state_attr(ns.cast_entity, 'entity_picture')}} 
                {% else %}
                  off
                {% endif %}
        media_series_title_template: "{{state_attr( 'media_player.livingroom_chromecast', 'media_series_title') }}"
        title_template: "{{state_attr( 'media_player.livingroom_chromecast', 'media_title') }}"
        media_episode_template: "{{state_attr( 'media_player.livingroom_chromecast', 'media_episode') }}"
        media_season_template: "{{state_attr( 'media_player.livingroom_chromecast', 'media_season') }}"
        unique_id: template_livingroom_chromecast








      template_following_speaker:
        friendly_name: Template Following speaker
        device_class: tv
        value_template: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id  and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set state = media_player.state %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}                  
                {% for entity in ns.entities %}  
                {% set is_muted = state_attr(entity, "is_volume_muted") %}
                    {% set state = states( entity ) %}
                    {% if "speaker" in entity and "template" in entity and state != none %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                {% endfor %}
                {% if ns.final_entities | length > 0 %}
                {{ states(ns.final_entities | first )  }}
                {% else %}
                  off
                {% endif %}
        next:
          service: media_player.media_seek
          data_template:
            entity_id: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id  and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}  
                
                {% for entity in ns.entities %}  
                     {% if "speaker" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                    {% if ns.final_entities | length == 0 %}
                     {% if "speaker" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}                
                {% if ns.final_entities | length > 0 %}
                {{ ns.final_entities }}
                {% endif %}
            seek_position: 56000
        turn_on:
          service: media_player.turn_on
          data_template:
            entity_id: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id  and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}  
                
                {% for entity in ns.entities %}  
                     {% if "speaker" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                    {% if ns.final_entities | length == 0 %}
                     {% if "speaker" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}                
                {% if ns.final_entities | length > 0 %}
                {{ ns.final_entities }}
                {% endif %}
        stop:
          service: media_player.media_stop
          data_template:
            entity_id: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id  and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}  
                
                {% for entity in ns.entities %}  
                     {% if "speaker" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                    {% if ns.final_entities | length == 0 %}
                     {% if "speaker" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}                
                {% if ns.final_entities | length > 0 %}
                {{ ns.final_entities }}
                {% endif %}
        turn_off:
          service: media_player.turn_off
          data_template:
            entity_id: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id  and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}  
                
                {% for entity in ns.entities %}  
                     {% if "speaker" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                    {% if ns.final_entities | length == 0 %}
                     {% if "speaker" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}                
                {% if ns.final_entities | length > 0 %}
                {{ ns.final_entities }}
                {% endif %}
        volume_up:
          service: media_player.volume_up
          data_template:
            entity_id: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id  and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}  
                
                {% for entity in ns.entities %}  
                     {% if "speaker" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                    {% if ns.final_entities | length == 0 %}
                     {% if "speaker" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}                
                {% if ns.final_entities | length > 0 %}
                {{ ns.final_entities }}
                {% endif %}
        volume_down:
          service: media_player.volume_down
          data_template:
            entity_id: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id  and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}  
                
                {% for entity in ns.entities %}  
                     {% if "speaker" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                    {% if ns.final_entities | length == 0 %}
                     {% if "speaker" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}                
                {% if ns.final_entities | length > 0 %}
                {{ ns.final_entities }}
                {% endif %}
        mute:
          service: media_player.volume_mute
          data_template:
            is_volume_muted: "true"
            entity_id: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id  and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}  
                
                {% for entity in ns.entities %}  
                     {% if "speaker" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                    {% if ns.final_entities | length == 0 %}
                     {% if "speaker" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}                
                {% if ns.final_entities | length > 0 %}
                {{ ns.final_entities }}
                {% endif %}
        set_volume:
          service: media_player.volume_set
          data_template:
            entity_id: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id  and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}  
                
                {% for entity in ns.entities %}  
                     {% if "speaker" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                    {% if ns.final_entities | length == 0 %}
                     {% if "speaker" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}                
                {% if ns.final_entities | length > 0 %}
                {{ ns.final_entities }}
                {% endif %}
            volume_level: "{{ volume }}"
        current_is_muted_template: "{{state_attr( 'media_player.office_speaker', 'is_volume_muted') }}"
        media_image_url_template: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set entity_picture = state_attr( entity, 'entity_picture') %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}                  
                {% for entity in ns.entities %}  
                {% set is_muted = state_attr(entity, "is_volume_muted") %}
                {% if is_muted == false %}
                    {% set entity_picture = state_attr( entity, 'entity_picture') %}
                    {% if "speaker" in entity and entity_picture != none %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.final_entities | length > 0 %}
                {{state_attr( ns.final_entities | first , 'entity_picture' ) }}
                {% endif %}
        title_template: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}                  
                {% for entity in ns.entities %}  
                {% set is_muted = state_attr(entity, "is_volume_muted") %}
                {% if is_muted == false %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                    {% if "speaker" in entity and media_title != none %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.final_entities | length > 0 %}
                {{state_attr( ns.final_entities | first , 'media_title' ) }}
                {% endif %}
        album_template: >                
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set media_album_name = state_attr( entity, 'media_album_name') %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}                  
                {% for entity in ns.entities %}  
                {% set is_muted = state_attr(entity, "is_volume_muted") %}
                {% if is_muted == false %}
                    {% set media_album_name = state_attr( entity, 'media_album_name') %}
                    {% if "speaker" in entity and media_album_name != none %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.final_entities | length > 0 %}
                {{state_attr( ns.final_entities | random , 'media_album_name' ) }}
                {% endif %}
        artist_template: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set media_artist = state_attr( entity, 'media_artist') %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}                  
                {% for entity in ns.entities %}  
                {% set is_muted = state_attr(entity, "is_volume_muted") %}
                {% if is_muted == false %}
                    {% set media_artist = state_attr( entity, 'media_artist') %}
                    {% if "speaker" in entity and media_artist != none %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.final_entities | length > 0 %}
                {{state_attr( ns.final_entities | random , 'media_artist' ) }}
                  {% endif %}
        unique_id: template_following_speaker

###################################################################################################
      template_following_chromecast:
        friendly_name: Template Following Chromecast
        device_class: tv
        value_template: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set state = media_player.state %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}                  
                {% for entity in ns.entities %}  
                {% set is_muted = state_attr(entity, "is_volume_muted") %}
                    {% set state = states( entity ) %}
                    {% if "chromecast" in entity and "template" in entity and state != none %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                {% endfor %}
                {% if ns.final_entities | length > 0 %}
                {{ states(ns.final_entities | first )  }}
                {% else %}
                  off
                {% endif %}
        next:
          service: media_player.media_seek
          data_template:
            entity_id: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}  
                
                {% for entity in ns.entities %}  
                     {% if "chromecast" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                    {% if ns.final_entities | length == 0 %}
                     {% if "chromecast" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}                
                {% if ns.final_entities | length > 0 %}
                {{ ns.final_entities }}
                {% endif %}
            seek_position: 56000
        turn_on:
          service: media_player.turn_on
          data_template:
            entity_id: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}  
                
                {% for entity in ns.entities %}  
                     {% if "chromecast" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                    {% if ns.final_entities | length == 0 %}
                     {% if "chromecast" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}                
                {% if ns.final_entities | length > 0 %}
                {{ ns.final_entities }}
                {% endif %}
        stop:
          service: media_player.media_stop
          data_template:
            entity_id: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}  
                
                {% for entity in ns.entities %}  
                     {% if "chromecast" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                    {% if ns.final_entities | length == 0 %}
                     {% if "chromecast" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}                
                {% if ns.final_entities | length > 0 %}
                {{ ns.final_entities }}
                {% endif %}
        turn_off:
          service: media_player.turn_off
          data_template:
            entity_id: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}  
                
                {% for entity in ns.entities %}  
                     {% if "chromecast" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                    {% if ns.final_entities | length == 0 %}
                     {% if "chromecast" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}                
                {% if ns.final_entities | length > 0 %}
                {{ ns.final_entities }}
                {% endif %}
        volume_up:
          service: media_player.volume_up
          data_template:
            entity_id: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}  
                
                {% for entity in ns.entities %}  
                     {% if "chromecast" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                    {% if ns.final_entities | length == 0 %}
                     {% if "chromecast" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}                
                {% if ns.final_entities | length > 0 %}
                {{ ns.final_entities }}
                {% endif %}
        volume_down:
          service: media_player.volume_down
          data_template:
            entity_id: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}  
                
                {% for entity in ns.entities %}  
                     {% if "chromecast" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                    {% if ns.final_entities | length == 0 %}
                     {% if "chromecast" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}                
                {% if ns.final_entities | length > 0 %}
                {{ ns.final_entities }}
                {% endif %}
        mute:
          service: media_player.volume_mute
          data_template:
            is_volume_muted: "true"
            entity_id: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}  
                
                {% for entity in ns.entities %}  
                     {% if "chromecast" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                    {% if ns.final_entities | length == 0 %}
                     {% if "chromecast" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}                
                {% if ns.final_entities | length > 0 %}
                {{ ns.final_entities }}
                {% endif %}
        set_volume:
          service: media_player.volume_set
          data_template:
            entity_id: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}  
                
                {% for entity in ns.entities %}  
                     {% if "chromecast" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                    {% if ns.final_entities | length == 0 %}
                     {% if "chromecast" in entity %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}                
                {% if ns.final_entities | length > 0 %}
                {{ ns.final_entities }}
                {% endif %}
            volume_level: "{{ volume }}"
        current_is_muted_template: "{{state_attr( 'media_player.office_chromecast', 'is_volume_muted') }}"
        media_image_url_template: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set entity_picture = state_attr( entity, 'entity_picture') %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}                  
                {% for entity in ns.entities %}  
                {% set is_muted = state_attr(entity, "is_volume_muted") %}
                {% if is_muted == false %}
                    {% set entity_picture = state_attr( entity, 'entity_picture') %}
                    {% if "chromecast" in entity and entity_picture != none %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.final_entities | length > 0 %}
                {{state_attr( ns.final_entities | first , 'entity_picture' ) }}
                {% endif %}
        title_template: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}                  
                {% for entity in ns.entities %}  
                {% set is_muted = state_attr(entity, "is_volume_muted") %}
                {% if is_muted == false %}
                    {% set media_title = state_attr( entity, 'media_title') %}
                    {% if "chromecast" in entity and media_title != none %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.final_entities | length > 0 %}
                {{state_attr( ns.final_entities | first , 'media_title' ) }}
                {% endif %}
        album_template: >                
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set media_album_name = state_attr( entity, 'media_album_name') %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}                  
                {% for entity in ns.entities %}  
                {% set is_muted = state_attr(entity, "is_volume_muted") %}
                {% if is_muted == false %}
                    {% set media_album_name = state_attr( entity, 'media_album_name') %}
                    {% if "chromecast" in entity and media_album_name != none %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.final_entities | length > 0 %}
                {{state_attr( ns.final_entities | random , 'media_album_name' ) }}
                {% endif %}
        artist_template: >
                {% set location = states('sensor.maxi_location_v3') %}  
                {% set ns = namespace( entities = [], final_entities = []  )%}
                
                {% for media_player in states.media_player %} 
                  {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                    {% set entity = media_player.entity_id %}
                    {% set media_artist = state_attr( entity, 'media_artist') %}
                    {% set ns.entities = ns.entities + [entity] %}
                  {% endif %}                  
                {% endfor %}                  
                {% for entity in ns.entities %}  
                {% set is_muted = state_attr(entity, "is_volume_muted") %}
                {% if is_muted == false %}
                    {% set media_artist = state_attr( entity, 'media_artist') %}
                    {% if "chromecast" in entity and media_artist != none %}
                       {% set ns.final_entities = ns.final_entities + [entity] %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
                {% if ns.final_entities | length > 0 %}
                {{state_attr( ns.final_entities | random , 'media_artist' ) }}
                  {% endif %}
        unique_id: template_following_chromecast