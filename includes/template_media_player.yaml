  ########################## TEMPLATE SPEAKERS ##########################         
  
  # template_hotbox_top_speakers_v4:
  #       friendly_name: Template Hotbox Top Speakers
  #       device_class: speaker
  #       value_template: >
  #             {% if  states("media_player.hotbox_top_speaker") == "off"  %}
  #               off
  #             {% elif states("media_player.hotbox_top_speaker") == "buffering"  %}
  #               playing
  #             {% else %}
  #              {{ states("media_player.hotbox_top_speaker")   }}
  #             {% endif %} 
  #       next:
  #         service: media_player.media_seek
  #         data_template:
  #           entity_id: media_player.hotbox_top_speaker
  #           seek_position: >
  #                   {{ state_attr( "media_player.hotbox_top_speaker", "media_duration" )  }} 
  #       turn_on:
  #         service: media_player.turn_on
  #         data_template:
  #           entity_id:            
  #             -  media_player.hotbox_top_speaker
  #       stop:
  #         service: media_player.media_stop
  #         data_template:
  #           entity_id:            
  #             -  media_player.hotbox_top_speaker
  #       turn_off:
  #         service: media_player.turn_off
  #         data_template:
  #           entity_id:            
  #             -  media_player.hotbox_top_speaker
  #       volume_up:
  #         service: media_player.volume_up
  #         data_template:
  #           entity_id:            
  #             -  media_player.hotbox_top_speaker
  #       play:
  #         service: media_player.media_play
  #         data_template:
  #           entity_id:            
  #             -  media_player.hotbox_top_speaker
  #       play_pause:
  #         service: media_player.media_play_pause
  #         data_template:
  #           entity_id:            
  #             -  media_player.hotbox_top_speaker
  #       pause:
  #         service: media_player.media_pause
  #         data_template:
  #           entity_id:            
  #             -  media_player.hotbox_top_speaker
  #       volume_down:
  #         service: media_player.volume_down
  #         data_template:
  #           entity_id:            
  #             -  media_player.hotbox_top_speaker
  #       mute:
  #         service: media_player.volume_mute
  #         data_template:
  #           is_volume_muted: "true"
  #           entity_id:            
  #             -  media_player.hotbox_top_speaker
  #       set_volume:
  #         service: media_player.volume_set
  #         data_template:            
  #           volume_level: "{{ volume }}"
  #           entity_id:            
  #             -  media_player.hotbox_top_speaker
  #       current_is_muted_template: >
  #               {{ state_attr('media_player.hotbox_top_speaker', 'is_volume_muted') }}
  #       current_volume_template: >
  #               {{ state_attr('media_player.hotbox_top_speaker', 'volume_level') }}
  #       media_image_url_template: >
  #               {% set ns = namespace( cast_entity = "media_player.hotbox_top_speaker" ) %}
  #               {% if state_attr( ns.cast_entity, "entity_picture") and states( ns.cast_entity) != "off"  %}
  #                     {{ state_attr( ns.cast_entity, "entity_picture") }}
  #               {% else %}                   
  #                     {# Look for a media player playing the same media as the main speaker in order to extract the media image #}
  #                     {# Pull all non-off media players#}
  #                     {% set ns = namespace( entities = [], final_entities = [],cast_entity = "media_player.hotbox_top_speaker"  )%}                      
  #                     {% for media_player in states.media_player %} 
  #                       {% if  media_player.state != "off" and media_player.state != "unavailable" and "template" not in media_player.entity_id%}
  #                         {% set entity = media_player.entity_id %}
  #                         {% set ns.entities = ns.entities + [entity] %}
  #                       {% endif %}                  
  #                     {% endfor %}  
  #                     {# /Pull all non-off media players#}
  #                     {# Look for a player with the same song playing and output the entity_picture #}
  #                     {% for entity in ns.entities %}                                
  #                         {% set media_title = state_attr( entity, "media_title") %}
  #                         {% set media_album_name = state_attr( entity, "media_album_name") %}
  #                         {% set media_album_artist = state_attr( entity, "media_album_artist") %}                          
  #                         {% set cast_media_title = state_attr( ns.cast_entity, "media_title") %}
  #                         {% set cast_media_album_name = state_attr( ns.cast_entity, "media_album_name") %}
  #                         {% set cast_media_album_artist = state_attr( ns.cast_entity, "media_album_artist") %}
  #                         {% if media_title is not none and media_album_name is not none and media_album_artist is not none and cast_media_title is not none and cast_media_album_name is not none and cast_media_album_artist is not none and (( media_title | string | length ) > 0 and ( media_title | string ) in cast_media_title) and (( media_album_name | string ) in cast_media_album_name) and (( media_album_artist | string ) in cast_media_album_artist) and (( state_attr(entity, 'entity_picture') )) %}
  #                             {{state_attr(entity, 'entity_picture')}}
  #                             {% break %}
  #                       {% endif %}
  #                     {% endfor %}  
  #                     {#/Look for a player with the same song playing and output the entity_picture #}                  
  #                     {# /Look for a media player playing the same media as the main speaker in order to extract the media image #}
  #               {% endif %}
  #       title_template: >
  #               {% if state_attr( 'media_player.hotbox_top_speaker', "media_title") %}
  #                 {{ state_attr( 'media_player.hotbox_top_speaker', "media_title") }}
  #               {% endif %}
  #       album_template: >
  #               {% if state_attr( 'media_player.hotbox_top_speaker', "media_album_name") %}
  #                 {{ state_attr( 'media_player.hotbox_top_speaker', "media_album_name") }}
  #               {% endif %}
  #       artist_template: >
  #               {% if state_attr( 'media_player.hotbox_top_speaker', "media_artist") %}
  #                 {{ state_attr( 'media_player.hotbox_top_speaker', "media_artist") }}
  #               {% endif %}
  #       unique_id: template_hotbox_top_speakers_v4
  #       media_content_type_template: music
 


  # template_hotbox_down_speakers_v4:
  #       friendly_name: Template Hotbox Down Speakers
  #       device_class: speaker
  #       value_template: >
  #             {% if  states("media_player.hotbox_down_wiim_speaker") == "off"  %}
  #               off
  #             {% elif states("media_player.hotbox_down_wiim_speaker") == "buffering"  %}
  #               playing
  #             {% else %}
  #              {{ states("media_player.hotbox_down_wiim_speaker")   }}
  #             {% endif %} 
  #       next:
  #         service: media_player.media_seek
  #         data_template:
  #           entity_id: media_player.hotbox_down_wiim_speaker
  #           seek_position: >
  #                   {{ state_attr( "media_player.hotbox_down_wiim_speaker", "media_duration" )  }} 
  #       turn_on:
  #         service: media_player.turn_on
  #         data_template:
  #           entity_id:            
  #             -  media_player.hotbox_down_wiim_speaker
  #       stop:
  #         service: media_player.media_stop
  #         data_template:
  #           entity_id:            
  #             -  media_player.hotbox_down_wiim_speaker
  #       turn_off:
  #         service: media_player.turn_off
  #         data_template:
  #           entity_id:            
  #             -  media_player.hotbox_down_wiim_speaker
  #       volume_up:
  #         service: media_player.volume_up
  #         data_template:
  #           entity_id:            
  #             -  media_player.hotbox_down_wiim_speaker
  #       play:
  #         service: media_player.media_play
  #         data_template:
  #           entity_id:            
  #             -  media_player.hotbox_down_wiim_speaker
  #       play_pause:
  #         service: media_player.media_play_pause
  #         data_template:
  #           entity_id:            
  #             -  media_player.hotbox_down_wiim_speaker
  #       pause:
  #         service: media_player.media_pause
  #         data_template:
  #           entity_id:            
  #             -  media_player.hotbox_down_wiim_speaker
  #       volume_down:
  #         service: media_player.volume_down
  #         data_template:
  #           entity_id:            
  #             -  media_player.hotbox_down_wiim_speaker
  #       mute:
  #         service: media_player.volume_mute
  #         data_template:
  #           is_volume_muted: "true"
  #           entity_id:            
  #             -  media_player.hotbox_down_wiim_speaker
  #       set_volume:
  #         service: media_player.volume_set
  #         data_template:            
  #           volume_level: "{{ volume }}"
  #           entity_id:            
  #             -  media_player.hotbox_down_wiim_speaker
  #       current_is_muted_template: >
  #               {{ state_attr('media_player.hotbox_down_wiim_speaker', 'is_volume_muted') }}
  #       current_volume_template: >
  #               {{ state_attr('media_player.hotbox_down_wiim_speaker', 'volume_level') }}
  #       media_image_url_template: >
  #               {% set ns = namespace( cast_entity = "media_player.hotbox_down_wiim_speaker" ) %}
  #               {% if state_attr( ns.cast_entity, "entity_picture") and states( ns.cast_entity) != "off"  %}
  #                     {{ state_attr( ns.cast_entity, "entity_picture") }}
  #               {% else %}                   
  #                     {# Look for a media player playing the same media as the main speaker in order to extract the media image #}
  #                     {# Pull all non-off media players#}
  #                     {% set ns = namespace( entities = [], final_entities = [],cast_entity = "media_player.hotbox_down_wiim_speaker"  )%}                      
  #                     {% for media_player in states.media_player %} 
  #                       {% if  media_player.state != "off" and media_player.state != "unavailable" and "template" not in media_player.entity_id%}
  #                         {% set entity = media_player.entity_id %}
  #                         {% set ns.entities = ns.entities + [entity] %}
  #                       {% endif %}                  
  #                     {% endfor %}  
  #                     {# /Pull all non-off media players#}
  #                     {# Look for a player with the same song playing and output the entity_picture #}
  #                     {% for entity in ns.entities %}                                
  #                         {% set media_title = state_attr( entity, "media_title") %}
  #                         {% set media_album_name = state_attr( entity, "media_album_name") %}
  #                         {% set media_album_artist = state_attr( entity, "media_album_artist") %}                          
  #                         {% set cast_media_title = state_attr( ns.cast_entity, "media_title") %}
  #                         {% set cast_media_album_name = state_attr( ns.cast_entity, "media_album_name") %}
  #                         {% set cast_media_album_artist = state_attr( ns.cast_entity, "media_album_artist") %}
  #                         {% if media_title is not none and media_album_name is not none and media_album_artist is not none and cast_media_title is not none and cast_media_album_name is not none and cast_media_album_artist is not none and (( media_title | string | length ) > 0 and ( media_title | string ) in cast_media_title) and (( media_album_name | string ) in cast_media_album_name) and (( media_album_artist | string ) in cast_media_album_artist) and (( state_attr(entity, 'entity_picture') )) %}
  #                             {{state_attr(entity, 'entity_picture')}}
  #                             {% break %}
  #                       {% endif %}
  #                     {% endfor %}  
  #                     {#/Look for a player with the same song playing and output the entity_picture #}                  
  #                     {# /Look for a media player playing the same media as the main speaker in order to extract the media image #}
  #               {% endif %}
  #       title_template: >
  #               {% if state_attr( 'media_player.hotbox_down_wiim_speaker', "media_title") %}
  #                 {{ state_attr( 'media_player.hotbox_down_wiim_speaker', "media_title") }}
  #               {% endif %}
  #       album_template: >
  #               {% if state_attr( 'media_player.hotbox_down_wiim_speaker', "media_album_name") %}
  #                 {{ state_attr( 'media_player.hotbox_down_wiim_speaker', "media_album_name") }}
  #               {% endif %}
  #       artist_template: >
  #               {% if state_attr( 'media_player.hotbox_down_wiim_speaker', "media_artist") %}
  #                 {{ state_attr( 'media_player.hotbox_down_wiim_speaker', "media_artist") }}
  #               {% endif %}
  #       unique_id: template_hotbox_down_speakers_v4
  #       media_content_type_template: music
 




  # template_group_home_speakers_v4:
  #       friendly_name: Template group home  speakers
  #       device_class: speaker
  #       value_template: >
  #             {% if  states("media_player.group_home_speakers") == "off"  %}
  #               off
  #             {% elif states("media_player.group_home_speakers") == "buffering"  %}
  #               playing
  #             {% else %}
  #              {{ states("media_player.group_home_speakers")   }}
  #             {% endif %} 
  #       next:
  #         service: media_player.media_seek
  #         data_template:
  #           entity_id: media_player.group_home_speakers
  #           seek_position: >
  #                   {{ state_attr( "media_player.group_home_speakers", "media_duration" ) }} 
  #       turn_on:
  #         service: media_player.turn_on
  #         data_template:
  #           entity_id: media_player.group_home_speakers
  #       stop:
  #         service: media_player.media_stop
  #         data_template:
  #           entity_id: media_player.group_home_speakers
  #       turn_off:
  #         service: media_player.turn_off
  #         data_template:
  #           entity_id: media_player.group_home_speakers
  #       volume_up:
  #         service: media_player.volume_up
  #         data_template:
  #           entity_id: media_player.group_home_speakers
  #       play:
  #         service: media_player.media_play
  #         data_template:
  #           entity_id: media_player.group_home_speakers
  #       play_pause:
  #         service: media_player.media_play_pause

  #         data_template:
  #           entity_id: media_player.group_home_speakers
  #       pause:
  #         service: media_player.media_pause
  #         data_template:
  #           entity_id: media_player.group_home_speakers
  #       volume_down:
  #         service: media_player.volume_down
  #         data_template:
  #           entity_id: media_player.group_home_speakers
  #       mute:
  #         service: media_player.volume_mute
  #         data_template:
  #           is_volume_muted: "true"
  #           entity_id: media_player.group_home_speakers
  #       set_volume:
  #         service: media_player.volume_set
  #         data_template:            
  #           volume_level: "{{ volume }}"
  #           entity_id: >  
  #                 {% if state_attr('media_player.group_home_speakers', 'is_volume_muted') == false %}
  #                 {% set ns = namespace( entities = [], final_entities = []  )%}                  
  #                 {% for media_player in states.media_player %} 
  #                   {% if "following" not in media_player.entity_id and "group" not in media_player.entity_id and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"   %}
  #                   {% set is_muted = state_attr(media_player.entity_id, "is_volume_muted") %}
  #                   {% if is_muted == false %}
  #                     {% set entity = media_player.entity_id %}
  #                     {% set ns.entities = ns.entities + [entity] %}
  #                   {% endif %} 
  #                   {% endif %} 
  #                 {% endfor %}  
                  
  #                 {% for entity in ns.entities %}  
  #                     {% if "speaker" in entity %}
  #                       {% set ns.final_entities = ns.final_entities + [entity] %}
  #                     {% endif %}
  #                     {% if ns.final_entities | length == 0 %}
  #                     {% if "speaker" in entity %}
  #                       {% set ns.final_entities = ns.final_entities + [entity] %}
  #                     {% endif %}
  #                   {% endif %}
  #                 {% endfor %}                
  #                 {% if ns.final_entities | length > 0 %}
  #                 {{ ns.final_entities }}
  #                 {% endif %}
  #                 {% else %}
  #                 media_player.group_home_speakers
  #                 {% endif %}
  #       current_is_muted_template: >
  #                 {{ state_attr("media_player.group_home_speakers", "is_volume_muted") }}
  #       current_volume_template: >
  #                 {{state_attr("media_player.group_home_speakers", "volume_level") }}
  #       media_image_url_template: >
  #               {% set ns = namespace( cast_entity = "media_player.group_home_speakers" ) %}
  #               {% if state_attr( ns.cast_entity, "entity_picture") and states( ns.cast_entity) != "off"  %}
  #                     {{ state_attr( ns.cast_entity, "entity_picture") }}
  #               {% else %}                   
  #                     {# Look for a media player playing the same media as the main speaker in order to extract the media image #}
  #                     {# Pull all non-off media players#}
  #                     {% set ns = namespace( entities = [], final_entities = [],cast_entity = "media_player.group_home_speakers"  )%}                      
  #                     {% for media_player in states.media_player %} 
  #                       {% if  media_player.state != "off" and media_player.state != "unavailable" and "template" not in media_player.entity_id%}
  #                         {% set entity = media_player.entity_id %}
  #                         {% set ns.entities = ns.entities + [entity] %}
  #                       {% endif %}                  
  #                     {% endfor %}  
  #                     {# /Pull all non-off media players#}
  #                     {# Look for a player with the same song playing and output the entity_picture #}
  #                     {% for entity in ns.entities %}                                
  #                         {% set media_title = state_attr( entity, "media_title") %}
  #                         {% set media_album_name = state_attr( entity, "media_album_name") %}
  #                         {% set media_album_artist = state_attr( entity, "media_album_artist") %}                          
  #                         {% set cast_media_title = state_attr( ns.cast_entity, "media_title") %}
  #                         {% set cast_media_album_name = state_attr( ns.cast_entity, "media_album_name") %}
  #                         {% set cast_media_album_artist = state_attr( ns.cast_entity, "media_album_artist") %}
  #                         {% if media_title is not none and media_album_name is not none and media_album_artist is not none and cast_media_title is not none and cast_media_album_name is not none and cast_media_album_artist is not none and (( media_title | string | length ) > 0 and ( media_title | string ) in cast_media_title) and (( media_album_name | string ) in cast_media_album_name) and (( media_album_artist | string ) in cast_media_album_artist) and (( state_attr(entity, 'entity_picture') )) %}
  #                             {{state_attr(entity, 'entity_picture')}}
  #                             {% break %}
  #                       {% endif %}
  #                     {% endfor %}  
  #                     {#/Look for a player with the same song playing and output the entity_picture #}                  
  #                     {# /Look for a media player playing the same media as the main speaker in order to extract the media image #}
  #               {% endif %}
  #       title_template: >
  #               {% if state_attr( 'media_player.group_home_speakers', "media_title") %}
  #                 {{ state_attr( 'media_player.group_home_speakers', "media_title") }}
  #               {% endif %}
  #       artist_template: >
  #               {% if state_attr( 'media_player.group_home_speakers', 'media_album_artist') %}
  #               {{ state_attr( 'media_player.group_home_speakers', 'media_album_artist') }}
  #               {% elif state_attr( 'media_player.group_home_speakers', 'media_artist') %}                
  #               {{ state_attr( 'media_player.group_home_speakers', 'media_artist') }}
  #               {% endif %}
  #       unique_id: template_group_home_speakers_v4
  #       media_content_type_template: music

  # template_closet_wiim_speakers_v4:
  #       friendly_name: Template Closet Speakers
  #       device_class: speaker
  #       value_template: >
  #             {{ states("media_player.closet_wiim_speaker")   }}
  #       next:
  #         service: media_player.media_seek
  #         data_template:
  #           entity_id: media_player.closet_wiim_speaker
  #           seek_position: >
  #                   {{ state_attr( "media_player.closet_wiim_speaker", "media_duration" )  }} 
  #       turn_on:
  #         service: media_player.turn_on
  #         data_template:
  #           entity_id:            
  #             -  media_player.closet_wiim_speaker
  #       stop:
  #         service: media_player.media_stop
  #         data_template:
  #           entity_id:            
  #             -  media_player.closet_wiim_speaker
  #       turn_off:
  #         service: media_player.turn_off
  #         data_template:
  #           entity_id:            
  #             -  media_player.closet_wiim_speaker
  #       volume_up:
  #         service: media_player.volume_up
  #         data_template:
  #           entity_id:            
  #             -  media_player.closet_wiim_speaker
  #       play:
  #         service: media_player.media_play
  #         data_template:
  #           entity_id:            
  #             -  media_player.closet_wiim_speaker
  #       play_pause:
  #         service: media_player.media_play_pause
  #         data_template:
  #           entity_id:            
  #             -  media_player.closet_wiim_speaker
  #       pause:
  #         service: media_player.media_pause
  #         data_template:
  #           entity_id:            
  #             -  media_player.closet_wiim_speaker
  #       volume_down:
  #         service: media_player.volume_down
  #         data_template:
  #           entity_id:            
  #             -  media_player.closet_wiim_speaker
  #       mute:
  #         service: media_player.volume_mute
  #         data_template:
  #           is_volume_muted: "true"
  #           entity_id:            
  #             -  media_player.closet_wiim_speaker
  #       set_volume:
  #         service: media_player.volume_set
  #         data_template:            
  #           volume_level: "{{ volume }}"
  #           entity_id:            
  #             -  media_player.closet_wiim_speaker
  #       current_is_muted_template: >
  #               {{ state_attr('media_player.closet_wiim_speaker', 'is_volume_muted') }}
  #       current_volume_template: >
  #               {{ state_attr('media_player.closet_wiim_speaker', 'volume_level') }}
  #       media_image_url_template: >
  #               {% set ns = namespace( cast_entity = "media_player.closet_wiim_speaker" ) %}
  #               {% if state_attr( ns.cast_entity, "entity_picture") and states( ns.cast_entity) != "off"  %}
  #                     {{ state_attr( ns.cast_entity, "entity_picture") }}
  #               {% else %}                   
  #                     {# Look for a media player playing the same media as the main speaker in order to extract the media image #}
  #                     {# Pull all non-off media players#}
  #                     {% set ns = namespace( entities = [], final_entities = [],cast_entity = "media_player.closet_wiim_speaker"  )%}                      
  #                     {% for media_player in states.media_player %} 
  #                       {% if  media_player.state != "off" and media_player.state != "unavailable" and "template" not in media_player.entity_id%}
  #                         {% set entity = media_player.entity_id %}
  #                         {% set ns.entities = ns.entities + [entity] %}
  #                       {% endif %}                  
  #                     {% endfor %}  
  #                     {# /Pull all non-off media players#}
  #                     {# Look for a player with the same song playing and output the entity_picture #}
  #                     {% for entity in ns.entities %}                                
  #                         {% set media_title = state_attr( entity, "media_title") %}
  #                         {% set media_album_name = state_attr( entity, "media_album_name") %}
  #                         {% set media_album_artist = state_attr( entity, "media_album_artist") %}                          
  #                         {% set cast_media_title = state_attr( ns.cast_entity, "media_title") %}
  #                         {% set cast_media_album_name = state_attr( ns.cast_entity, "media_album_name") %}
  #                         {% set cast_media_album_artist = state_attr( ns.cast_entity, "media_album_artist") %}
  #                         {% if media_title is not none and media_album_name is not none and media_album_artist is not none and cast_media_title is not none and cast_media_album_name is not none and cast_media_album_artist is not none and (( media_title | string | length ) > 0 and ( media_title | string ) in cast_media_title) and (( media_album_name | string ) in cast_media_album_name) and (( media_album_artist | string ) in cast_media_album_artist) and (( state_attr(entity, 'entity_picture') )) %}
  #                             {{state_attr(entity, 'entity_picture')}}
  #                             {% break %}
  #                       {% endif %}
  #                     {% endfor %}  
  #                     {#/Look for a player with the same song playing and output the entity_picture #}                  
  #                     {# /Look for a media player playing the same media as the main speaker in order to extract the media image #}
  #               {% endif %}
  #       title_template: >
  #               {% if state_attr( 'media_player.closet_wiim_speaker', "media_title") %}
  #                 {{ state_attr( 'media_player.closet_wiim_speaker', "media_title") }}
  #               {% endif %}
  #       album_template: >
  #               {% if state_attr( 'media_player.closet_wiim_speaker', 'media_album_artist') %}
  #               {{ state_attr( 'media_player.closet_wiim_speaker', 'media_album_artist') }}
  #               {% elif state_attr( 'media_player.closet_wiim_speaker', 'media_artist') %}                
  #               {{ state_attr( 'media_player.closet_wiim_speaker', 'media_artist') }}
  #               {% endif %}
  #       artist_template: >
  #               {% if state_attr( 'media_player.closet_wiim_speaker', "media_artist") %}
  #               {{ state_attr( 'media_player.closet_wiim_speaker', "media_artist") }}
  #               {% endif %}
  #       unique_id: template_closet_wiim_speakers_v4
  #       media_content_type_template: music
  
  # template_group_office_speakers_v4:
  #       friendly_name: Template Group Office Speakers
  #       device_class: speaker
  #       value_template: >
  #             {% if  states("media_player.office_wiim_speaker") == "off"  %}
  #               off
  #             {% elif states("media_player.office_wiim_speaker") == "buffering"  %}
  #               playing
  #             {% else %}
  #              {{ states("media_player.office_wiim_speaker")   }}
  #             {% endif %}        
  #       next:
  #         service: media_player.media_seek
  #         data_template:
  #           entity_id: media_player.office_wiim_speaker
  #           seek_position: >
  #                   {{ state_attr( "media_player.office_wiim_speaker", "media_duration" )  }} 
  #       turn_on:
  #         service: media_player.turn_on
  #         data_template:
  #           entity_id:            
  #             -  media_player.office_speaker
  #             -  media_player.office_wiim_speaker
  #       stop:
  #         service: media_player.media_stop
  #         data_template:
  #           entity_id:            
  #             -  media_player.office_speaker
  #             -  media_player.office_wiim_speaker
  #       turn_off:
  #         service: media_player.turn_off
  #         data_template:
  #           entity_id:            
  #             -  media_player.office_speaker
  #             -  media_player.office_wiim_speaker
  #       volume_up:
  #         service: media_player.volume_up
  #         data_template:
  #           entity_id:            
  #             -  media_player.office_speaker
  #             -  media_player.office_wiim_speaker
  #       play:
  #         service: media_player.media_play
  #         data_template:
  #           entity_id:            
  #             -  media_player.office_speaker
  #             -  media_player.office_wiim_speaker
  #       play_pause:
  #         service: media_player.media_play_pause
  #         data_template:
  #           entity_id:            
  #             -  media_player.office_speaker
  #             -  media_player.office_wiim_speaker
  #       pause:
  #         service: media_player.media_pause
  #         data_template:
  #           entity_id:            
  #             -  media_player.office_speaker
  #             -  media_player.office_wiim_speaker
  #       volume_down:
  #         service: media_player.volume_down
  #         data_template:
  #           entity_id:            
  #             -  media_player.office_speaker
  #             -  media_player.office_wiim_speaker
  #       mute:
  #         service: media_player.volume_mute
  #         data_template:
  #           is_volume_muted: "true"
  #           entity_id:            
  #             -  media_player.office_speaker
  #             -  media_player.office_wiim_speaker
  #       set_volume:
  #         service: media_player.volume_set
  #         data_template:            
  #           volume_level: "{{ volume }}"
  #           entity_id:            
  #             -  media_player.office_speaker
  #             -  media_player.office_wiim_speaker
  #       current_is_muted_template: >
  #               {% if state_attr('media_player.office_speaker', 'is_volume_muted') == false and state_attr('media_player.office_wiim_speaker', 'is_volume_muted') == false %}
  #                 {{ state_attr('media_player.office_speaker', 'is_volume_muted') }}
  #               {% else%}
  #                 true
  #               {% endif %}
  #       current_volume_template: >
  #               {{ ( state_attr('media_player.office_speaker', 'volume_level') + state_attr('media_player.office_wiim_speaker', 'volume_level') ) / 2}}
  #       media_image_url_template: >
  #               {% set ns = namespace( cast_entity = "media_player.office_wiim_speaker" ) %}
  #               {% if state_attr( ns.cast_entity, "entity_picture") and states( ns.cast_entity) != "off"  %}
  #                     {{ state_attr( ns.cast_entity, "entity_picture") }}
  #               {% else %}                   
  #                     {# Look for a media player playing the same media as the main speaker in order to extract the media image #}
  #                     {# Pull all non-off media players#}
  #                     {% set ns = namespace( entities = [], final_entities = [],cast_entity = "media_player.office_wiim_speaker"  )%}                      
  #                     {% for media_player in states.media_player %} 
  #                       {% if  media_player.state != "off" and media_player.state != "unavailable" and "template" not in media_player.entity_id%}
  #                         {% set entity = media_player.entity_id %}
  #                         {% set ns.entities = ns.entities + [entity] %}
  #                       {% endif %}                  
  #                     {% endfor %}  
  #                     {# /Pull all non-off media players#}
  #                     {# Look for a player with the same song playing and output the entity_picture #}
  #                     {% for entity in ns.entities %}                                
  #                         {% set media_title = state_attr( entity, "media_title") %}
  #                         {% set media_album_name = state_attr( entity, "media_album_name") %}
  #                         {% set media_album_artist = state_attr( entity, "media_album_artist") %}                          
  #                         {% set cast_media_title = state_attr( ns.cast_entity, "media_title") %}
  #                         {% set cast_media_album_name = state_attr( ns.cast_entity, "media_album_name") %}
  #                         {% set cast_media_album_artist = state_attr( ns.cast_entity, "media_album_artist") %}
  #                         {% if media_title is not none and media_album_name is not none and media_album_artist is not none and cast_media_title is not none and cast_media_album_name is not none and cast_media_album_artist is not none and (( media_title | string | length ) > 0 and ( media_title | string ) in cast_media_title) and (( media_album_name | string ) in cast_media_album_name) and (( media_album_artist | string ) in cast_media_album_artist) and (( state_attr(entity, 'entity_picture') )) %}
  #                             {{state_attr(entity, 'entity_picture')}}
  #                             {% break %}
  #                       {% endif %}
  #                     {% endfor %}  
  #                     {#/Look for a player with the same song playing and output the entity_picture #}                  
  #                     {# /Look for a media player playing the same media as the main speaker in order to extract the media image #}
  #               {% endif %}
  #       title_template: >
  #               {% if state_attr( 'media_player.office_wiim_speaker', "media_title") %}
  #                 {{ state_attr( 'media_player.office_wiim_speaker', "media_title") }}
  #               {% elif state_attr( 'media_player.office_speaker', "media_title" ) %}
  #                 {{ state_attr( 'media_player.office_speaker', "media_title") }}
  #               {% endif %}
  #       album_template: >
  #               {% if state_attr( 'media_player.office_wiim_speaker', "media_album_name") %}
  #                 {{ state_attr( 'media_player.office_wiim_speaker', "media_album_name") }}
  #               {% elif state_attr( 'media_player.office_speaker', "media_album_name" ) %}
  #                 {{ state_attr( 'media_player.office_speaker', "media_album_name") }}
  #               {% endif %}
  #       artist_template: >
  #               {% if state_attr( 'media_player.office_wiim_speaker', "media_artist") %}
  #                 {{ state_attr( 'media_player.office_wiim_speaker', "media_artist") }}
  #               {% elif state_attr( 'media_player.office_wiim_speaker', "media_album_artist" ) %}
  #                 {{ state_attr( 'media_player.office_wiim_speaker', "media_album_artist") }}
  #               {% elif state_attr( 'media_player.office_speaker', "media_artist" ) %}
  #                 {{ state_attr( 'media_player.office_speaker', "media_artist") }}
  #               {% elif state_attr( 'media_player.office_speaker', "media_album_artist" ) %}
  #                 {{ state_attr( 'media_player.office_speaker', "media_album_artist") }}
  #               {% endif %}
  #       media_content_type_template: music
  #       unique_id: template_group_office_speakers_v4

  # template_group_livingroom_speakers_v4:
  #       friendly_name: Template Group livingroom Speakers
  #       device_class: speaker
  #       value_template: >
  #             {% if  states("media_player.livingroom_wiim_speaker") == "off"  %}
  #               off
  #             {% elif states("media_player.livingroom_wiim_speaker") == "buffering"  %}
  #               playing
  #             {% else %}
  #              {{ states("media_player.livingroom_wiim_speaker")   }}
  #             {% endif %}
  #       next:
  #         service: media_player.media_seek
  #         data_template:
  #           entity_id: media_player.livingroom_wiim_speaker
  #           seek_position: >
  #                   {{ state_attr( "media_player.livingroom_wiim_speaker", "media_duration" )  }} 
  #       turn_on:
  #         service: media_player.turn_on
  #         data_template:
  #           entity_id:            
  #             -  media_player.livingroom_speaker
  #             -  media_player.livingroom_wiim_speaker
  #       stop:
  #         service: media_player.media_stop
  #         data_template:
  #           entity_id:            
  #             -  media_player.livingroom_speaker
  #             -  media_player.livingroom_wiim_speaker
  #       turn_off:
  #         service: media_player.turn_off
  #         data_template:
  #           entity_id:            
  #             -  media_player.livingroom_speaker
  #             -  media_player.livingroom_wiim_speaker
  #       volume_up:
  #         service: media_player.volume_up
  #         data_template:
  #           entity_id:            
  #             -  media_player.livingroom_speaker
  #             -  media_player.livingroom_wiim_speaker
  #       play:
  #         service: media_player.media_play
  #         data_template:
  #           entity_id:            
  #             -  media_player.livingroom_speaker
  #             -  media_player.livingroom_wiim_speaker
  #       play_pause:
  #         service: media_player.media_play_pause
  #         data_template:
  #           entity_id:            
  #             -  media_player.livingroom_speaker
  #             -  media_player.livingroom_wiim_speaker
  #       pause:
  #         service: media_player.media_pause
  #         data_template:
  #           entity_id:            
  #             -  media_player.livingroom_speaker
  #             -  media_player.livingroom_wiim_speaker
  #       volume_down:
  #         service: media_player.volume_down
  #         data_template:
  #           entity_id:            
  #             -  media_player.livingroom_speaker
  #             -  media_player.livingroom_wiim_speaker
  #       mute:
  #         service: media_player.volume_mute
  #         data_template:
  #           is_volume_muted: "true"
  #           entity_id:            
  #             -  media_player.livingroom_speaker
  #             -  media_player.livingroom_wiim_speaker
  #       set_volume:
  #         service: media_player.volume_set
  #         data_template:            
  #           volume_level: "{{ volume }}"
  #           entity_id:            
  #             -  media_player.livingroom_speaker
  #             -  media_player.livingroom_wiim_speaker
  #       current_is_muted_template: >
  #               {% if state_attr('media_player.livingroom_speaker', 'is_volume_muted') == false and state_attr('media_player.livingroom_wiim_speaker', 'is_volume_muted') == false %}
  #                 {{ state_attr('media_player.livingroom_speaker', 'is_volume_muted') }}
  #               {% else%}
  #                 true
  #               {% endif %}
  #       current_volume_template: >
  #               {{ ( state_attr('media_player.livingroom_speaker', 'volume_level') + state_attr('media_player.livingroom_wiim_speaker', 'volume_level') ) / 2}}
  #       media_image_url_template: >
  #               {% set ns = namespace( cast_entity = "media_player.livingroom_wiim_speaker" ) %}
  #               {% if state_attr( ns.cast_entity, "entity_picture") and states( ns.cast_entity) != "off"  %}
  #                     {{ state_attr( ns.cast_entity, "entity_picture") }}
  #               {% else %}                   
  #                     {# Look for a media player playing the same media as the main speaker in order to extract the media image #}
  #                     {# Pull all non-off media players#}
  #                     {% set ns = namespace( entities = [], final_entities = [],cast_entity = "media_player.livingroom_wiim_speaker"  )%}                      
  #                     {% for media_player in states.media_player %} 
  #                       {% if  media_player.state != "off" and media_player.state != "unavailable" and "template" not in media_player.entity_id%}
  #                         {% set entity = media_player.entity_id %}
  #                         {% set ns.entities = ns.entities + [entity] %}
  #                       {% endif %}                  
  #                     {% endfor %}  
  #                     {# /Pull all non-off media players#}
  #                     {# Look for a player with the same song playing and output the entity_picture #}
  #                     {% for entity in ns.entities %}                                
  #                         {% set media_title = state_attr( entity, "media_title") %}
  #                         {% set media_album_name = state_attr( entity, "media_album_name") %}
  #                         {% set media_album_artist = state_attr( entity, "media_album_artist") %}                          
  #                         {% set cast_media_title = state_attr( ns.cast_entity, "media_title") %}
  #                         {% set cast_media_album_name = state_attr( ns.cast_entity, "media_album_name") %}
  #                         {% set cast_media_album_artist = state_attr( ns.cast_entity, "media_album_artist") %}
  #                         {% if media_title is not none and media_album_name is not none and media_album_artist is not none and cast_media_title is not none and cast_media_album_name is not none and cast_media_album_artist is not none and (( media_title | string | length ) > 0 and ( media_title | string ) in cast_media_title) and (( media_album_name | string ) in cast_media_album_name) and (( media_album_artist | string ) in cast_media_album_artist) and (( state_attr(entity, 'entity_picture') )) %}
  #                             {{state_attr(entity, 'entity_picture')}}
  #                             {% break %}
  #                       {% endif %}
  #                     {% endfor %}  
  #                     {#/Look for a player with the same song playing and output the entity_picture #}                  
  #                     {# /Look for a media player playing the same media as the main speaker in order to extract the media image #}
  #               {% endif %}
  #       title_template: >
  #               {% if state_attr( 'media_player.livingroom_wiim_speaker', "media_title") %}
  #                 {{ state_attr( 'media_player.livingroom_wiim_speaker', "media_title") }}
  #               {% elif state_attr( 'media_player.livingroom_speaker', "media_title" ) %}
  #                 {{ state_attr( 'media_player.livingroom_speaker', "media_title") }}
  #               {% endif %}
  #       album_template: >
  #               {% if state_attr( 'media_player.livingroom_wiim_speaker', "media_album_name") %}
  #                 {{ state_attr( 'media_player.livingroom_wiim_speaker', "media_album_name") }}
  #               {% elif state_attr( 'media_player.livingroom_speaker', "media_album_name" ) %}
  #                 {{ state_attr( 'media_player.livingroom_speaker', "media_album_name") }}
  #               {% endif %}
  #       artist_template: >
  #               {% if state_attr( 'media_player.livingroom_wiim_speaker', "media_artist") %}
  #                 {{ state_attr( 'media_player.livingroom_wiim_speaker', "media_artist") }}
  #               {% elif state_attr( 'media_player.livingroom_wiim_speaker', "media_album_artist" ) %}
  #                 {{ state_attr( 'media_player.livingroom_wiim_speaker', "media_album_artist") }}
  #               {% elif state_attr( 'media_player.livingroom_speaker', "media_artist" ) %}
  #                 {{ state_attr( 'media_player.livingroom_speaker', "media_artist") }}
  #               {% elif state_attr( 'media_player.livingroom_speaker', "media_album_artist" ) %}
  #                 {{ state_attr( 'media_player.livingroom_speaker', "media_album_artist") }}
  #               {% endif %}
  #       unique_id: template_group_livingroom_speakers_v4
  #       media_content_type_template: music
    
  # template_group_kitchen_speakers_v4:
  #       friendly_name: Template Group kitchen Speakers
  #       device_class: speaker
  #       value_template: >
  #             {{ states("media_player.kitchen_wiim_speaker")   }}
  #       next:
  #         service: media_player.media_seek
  #         data_template:
  #           entity_id: media_player.kitchen_wiim_speaker
  #           seek_position: >
  #                   {{ state_attr( "media_player.kitchen_wiim_speaker", "media_duration" )  }} 
  #       turn_on:
  #         service: media_player.turn_on
  #         data_template:
  #           entity_id:            
  #             -  media_player.kitchen_speaker
  #             -  media_player.kitchen_wiim_speaker
  #       stop:
  #         service: media_player.media_stop
  #         data_template:
  #           entity_id:            
  #             -  media_player.kitchen_speaker
  #             -  media_player.kitchen_wiim_speaker
  #       turn_off:
  #         service: media_player.turn_off
  #         data_template:
  #           entity_id:            
  #             -  media_player.kitchen_speaker
  #             -  media_player.kitchen_wiim_speaker
  #       volume_up:
  #         service: media_player.volume_up
  #         data_template:
  #           entity_id:            
  #             -  media_player.kitchen_speaker
  #             -  media_player.kitchen_wiim_speaker
  #       play:
  #         service: media_player.media_play
  #         data_template:
  #           entity_id:            
  #             -  media_player.kitchen_speaker
  #             -  media_player.kitchen_wiim_speaker
  #       play_pause:
  #         service: media_player.media_play_pause
  #         data_template:
  #           entity_id:            
  #             -  media_player.kitchen_speaker
  #             -  media_player.kitchen_wiim_speaker
  #       pause:
  #         service: media_player.media_pause
  #         data_template:
  #           entity_id:            
  #             -  media_player.kitchen_speaker
  #             -  media_player.kitchen_wiim_speaker
  #       volume_down:
  #         service: media_player.volume_down
  #         data_template:
  #           entity_id:            
  #             -  media_player.kitchen_speaker
  #             -  media_player.kitchen_wiim_speaker
  #       mute:
  #         service: media_player.volume_mute
  #         data_template:
  #           is_volume_muted: "true"
  #           entity_id:            
  #             -  media_player.kitchen_speaker
  #             -  media_player.kitchen_wiim_speaker
  #       set_volume:
  #         service: media_player.volume_set
  #         data_template:            
  #           volume_level: "{{ volume }}"
  #           entity_id:            
  #             -  media_player.kitchen_speaker
  #             -  media_player.kitchen_wiim_speaker
  #       current_is_muted_template: >-
  #               {% if state_attr('media_player.kitchen_speaker', 'is_volume_muted') == false and state_attr('media_player.kitchen_wiim_speaker', 'is_volume_muted') == false %}
  #                 {{ state_attr('media_player.kitchen_speaker', 'is_volume_muted') }}
  #               {% else%}
  #                 true
  #               {% endif %}
  #       current_volume_template: >
  #               {{ ( state_attr('media_player.kitchen_speaker', 'volume_level') + state_attr('media_player.kitchen_wiim_speaker', 'volume_level') ) / 2}}
  #       media_image_url_template: >
  #               {% set ns = namespace( cast_entity = "media_player.kitchen_wiim_speaker" ) %}
  #               {% if state_attr( ns.cast_entity, "entity_picture") and states( ns.cast_entity) != "off"  %}
  #                     {{ state_attr( ns.cast_entity, "entity_picture") }}
  #               {% else %}                   
  #                     {# Look for a media player playing the same media as the main speaker in order to extract the media image #}
  #                     {# Pull all non-off media players#}
  #                     {% set ns = namespace( entities = [], final_entities = [],cast_entity = "media_player.kitchen_wiim_speaker"  )%}                      
  #                     {% for media_player in states.media_player %} 
  #                       {% if  media_player.state != "off" and media_player.state != "unavailable" and "template" not in media_player.entity_id%}
  #                         {% set entity = media_player.entity_id %}
  #                         {% set ns.entities = ns.entities + [entity] %}
  #                       {% endif %}                  
  #                     {% endfor %}  
  #                     {# /Pull all non-off media players#}
  #                     {# Look for a player with the same song playing and output the entity_picture #}
  #                     {% for entity in ns.entities %}                                
  #                         {% set media_title = state_attr( entity, "media_title") %}
  #                         {% set media_album_name = state_attr( entity, "media_album_name") %}
  #                         {% set media_album_artist = state_attr( entity, "media_album_artist") %}                          
  #                         {% set cast_media_title = state_attr( ns.cast_entity, "media_title") %}
  #                         {% set cast_media_album_name = state_attr( ns.cast_entity, "media_album_name") %}
  #                         {% set cast_media_album_artist = state_attr( ns.cast_entity, "media_album_artist") %}
  #                         {% if media_title is not none and media_album_name is not none and media_album_artist is not none and cast_media_title is not none and cast_media_album_name is not none and cast_media_album_artist is not none and (( media_title | string | length ) > 0 and ( media_title | string ) in cast_media_title) and (( media_album_name | string ) in cast_media_album_name) and (( media_album_artist | string ) in cast_media_album_artist) and (( state_attr(entity, 'entity_picture') )) %}
  #                             {{state_attr(entity, 'entity_picture')}}
  #                             {% break %}
  #                       {% endif %}
  #                     {% endfor %}  
  #                     {#/Look for a player with the same song playing and output the entity_picture #}                  
  #                     {# /Look for a media player playing the same media as the main speaker in order to extract the media image #}
  #               {% endif %}
  #       title_template: >
  #               {% if state_attr( 'media_player.kitchen_wiim_speaker', "media_title") %}
  #                 {{ state_attr( 'media_player.kitchen_wiim_speaker', "media_title") }}
  #               {% elif state_attr( 'media_player.kitchen_speaker', "media_title" ) %}
  #                 {{ state_attr( 'media_player.kitchen_speaker', "media_title") }}
  #               {% endif %}
  #       album_template: >
  #               {% if state_attr( 'media_player.kitchen_wiim_speaker', "media_album_name") %}
  #                 {{ state_attr( 'media_player.kitchen_wiim_speaker', "media_album_name") }}
  #               {% elif state_attr( 'media_player.kitchen_speaker', "media_album_name" ) %}
  #                 {{ state_attr( 'media_player.kitchen_speaker', "media_album_name") }}
  #               {% endif %}
  #       artist_template: >
  #               {% if state_attr( 'media_player.kitchen_wiim_speaker', "media_artist") %}
  #                 {{ state_attr( 'media_player.kitchen_wiim_speaker', "media_artist") }}
  #               {% elif state_attr( 'media_player.kitchen_wiim_speaker', "media_album_artist" ) %}
  #                 {{ state_attr( 'media_player.kitchen_wiim_speaker', "media_album_artist") }}
  #               {% elif state_attr( 'media_player.kitchen_speaker', "media_artist" ) %}
  #                 {{ state_attr( 'media_player.kitchen_speaker', "media_artist") }}
  #               {% elif state_attr( 'media_player.kitchen_speaker', "media_album_artist" ) %}
  #                 {{ state_attr( 'media_player.kitchen_speaker', "media_album_artist") }}
  #               {% endif %}
  #       unique_id: template_group_kitchen_speakers_v4
  #       media_content_type_template: music


########################## TEMPLATE CHROMECASTS ##########################



  template_hotbox_top_chromecast:
          friendly_name: Template hotbox top Chromecast
          device_class: speaker
          value_template: >
                  {% set ns = namespace( cast_entity = "media_player.hotbox_top_chromecast", template_entity = "" ) %}
                  {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                  {% for media_player in states.media_player %} 
                    {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_title = state_attr( entity, 'media_title') %}
                      {% set media_series_title = state_attr( entity, 'media_series_title') %}
                      {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                      {% set media_series_season = state_attr( entity, 'media_season') %}
                        {% if state_attr( ns.final_entity, 'media_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% elif state_attr( ns.final_entity, 'media_series_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% endif %}                      
                    {% endif %}                  
                  {% endfor %}                
                  {% if ns.template_entity == "" %}
                      {% set ns.template_entity = ns.cast_entity %}
                  {% endif %}
                  {% if ns.template_entity != ns.cast_entity %}                  
                    {{states(ns.template_entity)}}
                  {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                    {{states(ns.cast_entity)}}
                  {% else %}
                    off
                  {% endif %}
          next:
            service: media_player.media_seek
            data_template:
              entity_id: media_player.hotbox_top_chromecast
              seek_position: 56000
          turn_on:
            service: media_player.turn_on
            data_template:
              entity_id: media_player.hotbox_top_chromecast
          stop:
            service: media_player.media_stop
            data_template:
              entity_id: media_player.hotbox_top_chromecast
          turn_off:
            service: media_player.turn_off
            data_template:
              entity_id: media_player.hotbox_top_chromecast
          play:
            service: media_player.media_play
            data_template:
              entity_id: media_player.hotbox_top_chromecast
          play_pause:
            service: media_player.media_play_pause
            data_template:
              entity_id: media_player.hotbox_top_chromecast
          pause:
            service: media_player.media_pause
            data_template:
              entity_id: media_player.hotbox_top_chromecast
          volume_up:
            service: media_player.volume_up
            data_template:
              entity_id: media_player.hotbox_top_chromecast
          volume_down:
            service: media_player.volume_down
            data_template:
              entity_id: media_player.hotbox_top_chromecast
          mute:
            service: media_player.volume_mute
            data_template:
              entity_id: media_player.hotbox_top_chromecast
              is_volume_muted: "true"
          set_volume:
            service: media_player.volume_set
            data_template:
              entity_id: media_player.hotbox_top_chromecast
              volume_level: "{{ volume }}"
          current_is_muted_template: "{{state_attr( 'media_player.hotbox_top_chromecast', 'is_volume_muted') }}"
          current_volume_template: "{{state_attr( 'media_player.hotbox_top_chromecast', 'volume_level') }}"
          media_image_url_template: >
                  {% set ns = namespace( cast_entity = "media_player.hotbox_top_chromecast", template_entity = "" ) %}
                  {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                  {% for media_player in states.media_player %} 
                    {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_title = state_attr( entity, 'media_title') %}
                      {% set media_series_title = state_attr( entity, 'media_series_title') %}
                      {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                      {% set media_series_season = state_attr( entity, 'media_season') %}
                        {% if state_attr( ns.final_entity, 'media_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% elif state_attr( ns.final_entity, 'media_series_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% endif %}                      
                    {% endif %}                  
                  {% endfor %}                
                  {% if ns.template_entity == "" %}
                      {% set ns.template_entity = ns.cast_entity %}
                  {% endif %}
                  {% if ns.template_entity != ns.cast_entity %}                  
                    {{state_attr(ns.template_entity, 'entity_picture')}}
                  {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                    {{state_attr(ns.cast_entity, 'entity_picture')}} 
                  {% else %}
                    off
                  {% endif %}
          media_series_title_template: "{{state_attr( 'media_player.hotbox_top_chromecast', 'media_series_title') }}"
          title_template: "{{state_attr( 'media_player.hotbox_top_chromecast', 'media_title') }}"
          media_episode_template: "{{state_attr( 'media_player.hotbox_top_chromecast', 'media_episode') }}"
          media_season_template: "{{state_attr( 'media_player.hotbox_top_chromecast', 'media_season') }}"
          unique_id: template_hotbox_top_chromecast



  template_hotbox_down_chromecast:
          friendly_name: Template hotbox down Chromecast
          device_class: speaker
          value_template: >
                  {% set ns = namespace( cast_entity = "media_player.hotbox_down_chromecast", template_entity = "" ) %}
                  {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                  {% for media_player in states.media_player %} 
                    {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_title = state_attr( entity, 'media_title') %}
                      {% set media_series_title = state_attr( entity, 'media_series_title') %}
                      {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                      {% set media_series_season = state_attr( entity, 'media_season') %}
                        {% if state_attr( ns.final_entity, 'media_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% elif state_attr( ns.final_entity, 'media_series_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% endif %}                      
                    {% endif %}                  
                  {% endfor %}                
                  {% if ns.template_entity == "" %}
                      {% set ns.template_entity = ns.cast_entity %}
                  {% endif %}
                  {% if ns.template_entity != ns.cast_entity %}                  
                    {{states(ns.template_entity)}}
                  {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                    {{states(ns.cast_entity)}}
                  {% else %}
                    off
                  {% endif %}
          play:
            service: media_player.media_play
            data_template:
              entity_id: media_player.hotbox_down_chromecast
          play_pause:
            service: media_player.media_play_pause
            data_template:
              entity_id: media_player.hotbox_down_chromecast
          pause:
            service: media_player.media_pause
            data_template:
              entity_id: media_player.hotbox_down_chromecast
          next:
            service: media_player.media_seek
            data_template:
              entity_id: media_player.hotbox_down_chromecast
              seek_position: 56000
          turn_on:
            service: media_player.turn_on
            data_template:
              entity_id: media_player.hotbox_down_chromecast
          stop:
            service: media_player.media_stop
            data_template:
              entity_id: media_player.hotbox_down_chromecast
          turn_off:
            service: media_player.turn_off
            data_template:
              entity_id: media_player.hotbox_down_chromecast
          volume_up:
            service: media_player.volume_up
            data_template:
              entity_id: media_player.hotbox_down_chromecast
          volume_down:
            service: media_player.volume_down
            data_template:
              entity_id: media_player.hotbox_down_chromecast
          mute:
            service: media_player.volume_mute
            data_template:
              entity_id: media_player.hotbox_down_chromecast
              is_volume_muted: "true"
          set_volume:
            service: media_player.volume_set
            data_template:
              entity_id: media_player.hotbox_down_chromecast
              volume_level: "{{ volume }}"
          current_is_muted_template: "{{state_attr( 'media_player.hotbox_down_chromecast', 'is_volume_muted') }}"
          current_volume_template: "{{state_attr( 'media_player.hotbox_down_chromecast', 'volume_level') }}"
          media_image_url_template: >
                  {% set ns = namespace( cast_entity = "media_player.hotbox_down_chromecast", template_entity = "" ) %}
                  {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                  {% for media_player in states.media_player %} 
                    {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_title = state_attr( entity, 'media_title') %}
                      {% set media_series_title = state_attr( entity, 'media_series_title') %}
                      {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                      {% set media_series_season = state_attr( entity, 'media_season') %}
                        {% if state_attr( ns.final_entity, 'media_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% elif state_attr( ns.final_entity, 'media_series_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% endif %}                      
                    {% endif %}                  
                  {% endfor %}                
                  {% if ns.template_entity == "" %}
                      {% set ns.template_entity = ns.cast_entity %}
                  {% endif %}
                  {% if ns.template_entity != ns.cast_entity %}                  
                    {{state_attr(ns.template_entity, 'entity_picture')}}
                  {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                    {{state_attr(ns.cast_entity, 'entity_picture')}} 
                  {% else %}
                    off
                  {% endif %}
          media_series_title_template: "{{state_attr( 'media_player.hotbox_down_chromecast', 'media_series_title') }}"
          title_template: "{{state_attr( 'media_player.hotbox_down_chromecast', 'media_title') }}"
          media_episode_template: "{{state_attr( 'media_player.hotbox_down_chromecast', 'media_episode') }}"
          media_season_template: "{{state_attr( 'media_player.hotbox_down_chromecast', 'media_season') }}"
          unique_id: template_hotbox_down_chromecast



  template_office_chromecast:
          friendly_name: Template Office Chromecast
          device_class: speaker
          value_template: >
                  {% set ns = namespace( cast_entity = "media_player.office_chromecast", template_entity = "" ) %}
                  {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                  {% for media_player in states.media_player %} 
                    {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_title = state_attr( entity, 'media_title') %}
                      {% set media_series_title = state_attr( entity, 'media_series_title') %}
                      {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                      {% set media_series_season = state_attr( entity, 'media_season') %}
                        {% if state_attr( ns.final_entity, 'media_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% elif state_attr( ns.final_entity, 'media_series_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% endif %}                      
                    {% endif %}                  
                  {% endfor %}                
                  {% if ns.template_entity == "" %}
                      {% set ns.template_entity = ns.cast_entity %}
                  {% endif %}
                  {% if ns.template_entity != ns.cast_entity %}                  
                    {{states(ns.template_entity)}}
                  {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                    {{states(ns.cast_entity)}}
                  {% else %}
                    off
                  {% endif %}
          next:
            service: media_player.media_seek
            data_template:
              entity_id: media_player.office_chromecast
              seek_position: 56000
          turn_on:
            service: media_player.turn_on
            data_template:
              entity_id: media_player.office_chromecast
          stop:
            service: media_player.media_stop
            data_template:
              entity_id: media_player.office_chromecast
          turn_off:
            service: media_player.turn_off
            data_template:
              entity_id: media_player.office_chromecast
          volume_up:
            service: media_player.volume_up
            data_template:
              entity_id: media_player.office_chromecast
          volume_down:
            service: media_player.volume_down
            data_template:
              entity_id: media_player.office_chromecast
          play:
            service: media_player.media_play
            data_template:
              entity_id: media_player.office_chromecast
          play_pause:
            service: media_player.media_play_pause
            data_template:
              entity_id: media_player.office_chromecast
          pause:
            service: media_player.media_pause
            data_template:
              entity_id: media_player.office_chromecast
          mute:
            service: media_player.volume_mute
            data_template:
              entity_id: media_player.office_chromecast
              is_volume_muted: "true"
          set_volume:
            service: media_player.volume_set
            data_template:
              entity_id: media_player.office_chromecast
              volume_level: "{{ volume }}"
          current_is_muted_template: "{{state_attr( 'media_player.office_chromecast', 'is_volume_muted') }}"
          current_volume_template: "{{state_attr( 'media_player.office_chromecast', 'volume_level') }}"
          media_image_url_template: >
                  {% set ns = namespace( cast_entity = "media_player.office_chromecast", template_entity = "" ) %}
                  {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                  {% for media_player in states.media_player %} 
                    {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_title = state_attr( entity, 'media_title') %}
                      {% set media_series_title = state_attr( entity, 'media_series_title') %}
                      {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                      {% set media_series_season = state_attr( entity, 'media_season') %}
                        {% if state_attr( ns.final_entity, 'media_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% elif state_attr( ns.final_entity, 'media_series_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% endif %}                      
                    {% endif %}                  
                  {% endfor %}                
                  {% if ns.template_entity == "" %}
                      {% set ns.template_entity = ns.cast_entity %}
                  {% endif %}
                  {% if ns.template_entity != ns.cast_entity %}                  
                    {{state_attr(ns.template_entity, 'entity_picture')}}
                  {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                    {{state_attr(ns.cast_entity, 'entity_picture')}} 
                  {% else %}
                    off
                  {% endif %}
          media_series_title_template: "{{state_attr( 'media_player.office_chromecast', 'media_series_title') }}"
          title_template: "{{state_attr( 'media_player.office_chromecast', 'media_title') }}"
          media_episode_template: "{{state_attr( 'media_player.office_chromecast', 'media_episode') }}"
          media_season_template: "{{state_attr( 'media_player.office_chromecast', 'media_season') }}"
          unique_id: template_office_chromecast



  template_livingroom_chromecast:
          friendly_name: Template livingroom Chromecast
          device_class: speaker
          value_template: >
                  {% set ns = namespace( cast_entity = "media_player.livingroom_chromecast", template_entity = "" ) %}
                  {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                  {% for media_player in states.media_player %} 
                    {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_title = state_attr( entity, 'media_title') %}
                      {% set media_series_title = state_attr( entity, 'media_series_title') %}
                      {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                      {% set media_series_season = state_attr( entity, 'media_season') %}
                        {% if state_attr( ns.final_entity, 'media_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% elif state_attr( ns.final_entity, 'media_series_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% endif %}                      
                    {% endif %}                  
                  {% endfor %}                
                  {% if ns.template_entity == "" %}
                      {% set ns.template_entity = ns.cast_entity %}
                  {% endif %}
                  {% if ns.template_entity != ns.cast_entity %}                  
                    {{states(ns.template_entity)}}
                  {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                    {{states(ns.cast_entity)}}
                  {% else %}
                    off
                  {% endif %}
          next:
            service: media_player.media_seek
            data_template:
              entity_id: media_player.livingroom_chromecast
              seek_position: 56000
          turn_on:
            service: media_player.turn_on
            data_template:
              entity_id: media_player.livingroom_chromecast
          stop:
            service: media_player.media_stop
            data_template:
              entity_id: media_player.livingroom_chromecast
          turn_off:
            service: media_player.turn_off
            data_template:
              entity_id: media_player.livingroom_chromecast
          volume_up:
            service: media_player.volume_up
            data_template:
              entity_id: media_player.livingroom_chromecast
          volume_down:
            service: media_player.volume_down
            data_template:
              entity_id: media_player.livingroom_chromecast
          play:
            service: media_player.media_play
            data_template:
              entity_id: media_player.livingroom_chromecast
          play_pause:
            service: media_player.media_play_pause
            data_template:
              entity_id: media_player.livingroom_chromecast
          pause:
            service: media_player.media_pause
            data_template:
              entity_id: media_player.livingroom_chromecast
          mute:
            service: media_player.volume_mute
            data_template:
              entity_id: media_player.livingroom_chromecast              
              is_volume_muted: "true"
          set_volume:
            service: media_player.volume_set
            data_template:
              entity_id: media_player.livingroom_chromecast
              volume_level: "{{ volume }}"
          current_is_muted_template: "{{state_attr( 'media_player.livingroom_chromecast', 'is_volume_muted') }}"
          current_volume_template: "{{state_attr( 'media_player.livingroom_chromecast', 'volume_level') }}"
          media_image_url_template: >
                  {% set ns = namespace( cast_entity = "media_player.livingroom_chromecast", template_entity = "" ) %}
                  {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
                  {% for media_player in states.media_player %} 
                    {% if "plex" in media_player.entity_id and media_player.state != "unavailable" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_title = state_attr( entity, 'media_title') %}
                      {% set media_series_title = state_attr( entity, 'media_series_title') %}
                      {% set media_series_episode = state_attr( entity, 'media_espisode') %}
                      {% set media_series_season = state_attr( entity, 'media_season') %}
                        {% if state_attr( ns.final_entity, 'media_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_title') in ( media_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% elif state_attr( ns.final_entity, 'media_series_title') %}
                          {% if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title | string )%}
                          {% set ns.template_entity = entity %}
                          {% endif %}
                        {% endif %}                      
                    {% endif %}                  
                  {% endfor %}                
                  {% if ns.template_entity == "" %}
                      {% set ns.template_entity = ns.cast_entity %}
                  {% endif %}
                  {% if ns.template_entity != ns.cast_entity %}                  
                    {{state_attr(ns.template_entity, 'entity_picture')}}
                  {% elif state_attr( ns.cast_entity, 'media_title')  %} 
                    {{state_attr(ns.cast_entity, 'entity_picture')}} 
                  {% else %}
                    off
                  {% endif %}
          media_series_title_template: "{{state_attr( 'media_player.livingroom_chromecast', 'media_series_title') }}"
          title_template: "{{state_attr( 'media_player.livingroom_chromecast', 'media_title') }}"
          media_episode_template: "{{state_attr( 'media_player.livingroom_chromecast', 'media_episode') }}"
          media_season_template: "{{state_attr( 'media_player.livingroom_chromecast', 'media_season') }}"
          unique_id: template_livingroom_chromecast




# template_hotbox_wiim_speaker:
#           friendly_name: Template hotbox Wiim Speaker
#           device_class: speaker
#           value_template: >
#                   {% set ns = namespace( cast_entity = "media_player.hotbox_wiim_speaker", template_entity = "" ) %}
#                   {% set ns.final_entity = ns.cast_entity %}   {# Declare Varibles#}                
#                   {% for media_player in states.media_player %} 
#                     {% if "plex" in media_player.entity_id  %}
#                       {% set entity = media_player.entity_id %}
#                       {% set media_title = state_attr( entity, 'media_title') %}
#                         {% if state_attr( ns.final_entity, 'media_title') %}
#                           {% if ( media_title | string ) in state_attr( ns.cast_entity, 'media_title') %}
#                           {% set ns.template_entity = entity %}
#                           {% endif %}
#                         {% endif %}
#                     {% endif %}
#                   {% endfor %}
#                   {% if ns.final_entity != ns.cast_entity %}
#                     {{states(ns.template_entity)}}
#                   {% elif state_attr( ns.cast_entity, 'media_title')  %} 
#                     {{states(ns.cast_entity)}}
#                   {% else %}
#                         
#                       {% set location = "hotbox" %}  
#                       {% set ns = namespace( entities = [], final_entities = [""]  )%}
#                       
#                       {% for media_player in states.media_player %} 
#                         {% if location in media_player.entity_id  and "plex" not in media_player.entity_id  and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
#                           {% set entity = media_player.entity_id %}
#                           {% set ns.entities = ns.entities + [entity] %}
#                         {% endif %}                  
#                       {% endfor %}  
#                       
#                       {% for entity in ns.entities %}  
#                           {% if "speaker" in entity %}
#                             {% set ns.final_entities = ns.final_entities + [entity] %}
#                           {% endif %}
#                           {% if ns.final_entities | length == 0 %}
#                           {% if "speaker" in entity %}
#                             {% set ns.final_entities = ns.final_entities + [entity] %}
#                           {% endif %}
#                         {% endif %}
#                       {% endfor %}                
#                       {% if ns.final_entities | length > 0 %}
#                       {{states(ns.final_entities | first)}}
#                       {% endif %}
#                       
#                   {% endif %}
#           next:
#             service: media_player.media_seek
#             data_template:
#               entity_id: >
#                   {% set location = "hotbox" %}  
#                   {% set ns = namespace( entities = [], final_entities = [""]  )%}
#                   
#                   {% for media_player in states.media_player %} 
#                     {% if location in media_player.entity_id  and "plex" not in media_player.entity_id  and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
#                       {% set entity = media_player.entity_id %}
#                       {% set ns.entities = ns.entities + [entity] %}
#                     {% endif %}                  
#                   {% endfor %}  
#                   
#                   {% for entity in ns.entities %}  
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                       {% if ns.final_entities | length == 0 %}
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                     {% endif %}
#                   {% endfor %}                
#                   {% if ns.final_entities | length > 0 %}
#                   {{ ns.final_entities }}
#                   {% endif %}
#               seek_position: 56000
#           turn_on:
#             service: media_player.turn_on
#             data_template:
#               entity_id: >
#                   {% set location = "hotbox" %}  
#                   {% set ns = namespace( entities = [], final_entities = [""]  )%}
#                   
#                   {% for media_player in states.media_player %} 
#                     {% if location in media_player.entity_id  and "plex" not in media_player.entity_id  and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
#                       {% set entity = media_player.entity_id %}
#                       {% set ns.entities = ns.entities + [entity] %}
#                     {% endif %}                  
#                   {% endfor %}  
#                   
#                   {% for entity in ns.entities %}  
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                       {% if ns.final_entities | length == 0 %}
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                     {% endif %}
#                   {% endfor %}                
#                   {% if ns.final_entities | length > 0 %}
#                   {{ ns.final_entities }}
#                   {% endif %}
#           stop:
#             service: media_player.media_stop
#             data_template:
#               entity_id: >
#                   {% set location = "hotbox" %}  
#                   {% set ns = namespace( entities = [], final_entities = [""]  )%}
#                   
#                   {% for media_player in states.media_player %} 
#                     {% if location in media_player.entity_id  and "plex" not in media_player.entity_id  and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
#                       {% set entity = media_player.entity_id %}
#                       {% set ns.entities = ns.entities + [entity] %}
#                     {% endif %}                  
#                   {% endfor %}  
#                   
#                   {% for entity in ns.entities %}  
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                       {% if ns.final_entities | length == 0 %}
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                     {% endif %}
#                   {% endfor %}                
#                   {% if ns.final_entities | length > 0 %}
#                   {{ ns.final_entities }}
#                   {% endif %}
#           turn_off:
#             service: media_player.turn_off
#             data_template:
#               entity_id: >
#                   {% set location = "hotbox" %}  
#                   {% set ns = namespace( entities = [], final_entities = [""]  )%}
#                   
#                   {% for media_player in states.media_player %} 
#                     {% if location in media_player.entity_id  and "plex" not in media_player.entity_id  and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
#                       {% set entity = media_player.entity_id %}
#                       {% set ns.entities = ns.entities + [entity] %}
#                     {% endif %}                  
#                   {% endfor %}  
#                   
#                   {% for entity in ns.entities %}  
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                       {% if ns.final_entities | length == 0 %}
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                     {% endif %}
#                   {% endfor %}                
#                   {% if ns.final_entities | length > 0 %}
#                   {{ ns.final_entities }}
#                   {% endif %}
#           volume_up:
#             service: media_player.volume_up
#             data_template:
#               entity_id: >
#                   {% set location = "hotbox" %}  
#                   {% set ns = namespace( entities = [], final_entities = [""]  )%}
#                   
#                   {% for media_player in states.media_player %} 
#                     {% if location in media_player.entity_id  and "plex" not in media_player.entity_id  and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
#                       {% set entity = media_player.entity_id %}
#                       {% set ns.entities = ns.entities + [entity] %}
#                     {% endif %}                  
#                   {% endfor %}  
#                   
#                   {% for entity in ns.entities %}  
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                       {% if ns.final_entities | length == 0 %}
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                     {% endif %}
#                   {% endfor %}                
#                   {% if ns.final_entities | length > 0 %}
#                   {{ ns.final_entities }}
#                   {% endif %}
#           play:
#             service: media_player.media_play
#             data_template:
#               entity_id: >
#                   {% set location = "hotbox" %}  
#                   {% set ns = namespace( entities = [], final_entities = [""]  )%}
#                   
#                   {% for media_player in states.media_player %} 
#                     {% if location in media_player.entity_id  and "plex" not in media_player.entity_id  and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
#                       {% set entity = media_player.entity_id %}
#                       {% set ns.entities = ns.entities + [entity] %}
#                     {% endif %}                  
#                   {% endfor %}  
#                   
#                   {% for entity in ns.entities %}  
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                       {% if ns.final_entities | length == 0 %}
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                     {% endif %}
#                   {% endfor %}                
#                   {% if ns.final_entities | length > 0 %}
#                   {{ ns.final_entities }}
#                   {% endif %}
#           play_pause:
#             service: media_player.media_play_pause
#             data_template:
#               entity_id: >
#                   {% set location = "hotbox" %}  
#                   {% set ns = namespace( entities = [], final_entities = [""]  )%}
#                   
#                   {% for media_player in states.media_player %} 
#                     {% if location in media_player.entity_id  and "plex" not in media_player.entity_id  and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
#                       {% set entity = media_player.entity_id %}
#                       {% set ns.entities = ns.entities + [entity] %}
#                     {% endif %}                  
#                   {% endfor %}  
#                   
#                   {% for entity in ns.entities %}  
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                       {% if ns.final_entities | length == 0 %}
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                     {% endif %}
#                   {% endfor %}                
#                   {% if ns.final_entities | length > 0 %}
#                   {{ ns.final_entities }}
#                   {% endif %}
#           pause:
#             service: media_player.media_pause
#             data_template:
#               entity_id: >
#                   {% set location = "hotbox" %}  
#                   {% set ns = namespace( entities = [], final_entities = [""]  )%}
#                   
#                   {% for media_player in states.media_player %} 
#                     {% if location in media_player.entity_id  and "plex" not in media_player.entity_id  and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
#                       {% set entity = media_player.entity_id %}
#                       {% set ns.entities = ns.entities + [entity] %}
#                     {% endif %}                  
#                   {% endfor %}  
#                   
#                   {% for entity in ns.entities %}  
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                       {% if ns.final_entities | length == 0 %}
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                     {% endif %}
#                   {% endfor %}                
#                   {% if ns.final_entities | length > 0 %}
#                   {{ ns.final_entities }}
#                   {% endif %}
#           volume_down:
#             service: media_player.volume_down
#             data_template:
#               entity_id: >
#                   {% set location = "hotbox" %}  
#                   {% set ns = namespace( entities = [], final_entities = [""]  )%}
#                   
#                   {% for media_player in states.media_player %} 
#                     {% if location in media_player.entity_id  and "plex" not in media_player.entity_id  and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
#                       {% set entity = media_player.entity_id %}
#                       {% set ns.entities = ns.entities + [entity] %}
#                     {% endif %}                  
#                   {% endfor %}  
#                   
#                   {% for entity in ns.entities %}  
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                       {% if ns.final_entities | length == 0 %}
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                     {% endif %}
#                   {% endfor %}                
#                   {% if ns.final_entities | length > 0 %}
#                   {{ ns.final_entities }}
#                   {% endif %}
#           mute:
#             service: media_player.volume_mute
#             data_template:
#               entity_id: >
#                   {% set location = "hotbox" %}  
#                   {% set ns = namespace( entities = [], final_entities = [""]  )%}
#                   
#                   {% for media_player in states.media_player %} 
#                     {% if location in media_player.entity_id  and "plex" not in media_player.entity_id  and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
#                       {% set entity = media_player.entity_id %}
#                       {% set ns.entities = ns.entities + [entity] %}
#                     {% endif %}                  
#                   {% endfor %}  
#                   
#                   {% for entity in ns.entities %}  
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                       {% if ns.final_entities | length == 0 %}
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                     {% endif %}
#                   {% endfor %}                
#                   {% if ns.final_entities | length > 0 %}
#                   {{ ns.final_entities }}
#                   {% endif %}            
#           set_volume:
#             service: media_player.volume_set
#             data_template:
#               entity_id: >
#                   {% set location = "hotbox" %}  
#                   {% set ns = namespace( entities = [], final_entities = [""]  )%}
#                   
#                   {% for media_player in states.media_player %} 
#                     {% if location in media_player.entity_id  and "plex" not in media_player.entity_id  and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
#                       {% set entity = media_player.entity_id %}
#                       {% set ns.entities = ns.entities + [entity] %}
#                     {% endif %}                  
#                   {% endfor %}  
#                   
#                   {% for entity in ns.entities %}  
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                       {% if ns.final_entities | length == 0 %}
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                     {% endif %}
#                   {% endfor %}                
#                   {% if ns.final_entities | length > 0 %}
#                   {{ ns.final_entities }}
#                   {% endif %}
#               volume_level: "{{ volume }}"
#           current_is_muted_template: >
#                   {% set location = "hotbox" %}  
#                   {% set ns = namespace( entities = [], final_entities = [""]  )%}
#                   
#                   {% for media_player in states.media_player %} 
#                     {% if location in media_player.entity_id  and "plex" not in media_player.entity_id  and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
#                       {% set entity = media_player.entity_id %}
#                       {% set ns.entities = ns.entities + [entity] %}
#                     {% endif %}                  
#                   {% endfor %}  
#                   
#                   {% for entity in ns.entities %}  
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                       {% if ns.final_entities | length == 0 %}
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                     {% endif %}
#                   {% endfor %}         
#                   {{state_attr( ns.final_entities | first, 'is_volume_muted') }}
#           current_volume_template: >
#                   {% set location = "hotbox" %}  
#                   {% set ns = namespace( entities = [], final_entities = [""]  )%}
#                   
#                   {% for media_player in states.media_player %} 
#                     {% if location in media_player.entity_id  and "plex" not in media_player.entity_id  and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
#                       {% set entity = media_player.entity_id %}
#                       {% set ns.entities = ns.entities + [entity] %}
#                     {% endif %}                  
#                   {% endfor %}  
#                   
#                   {% for entity in ns.entities %}  
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                       {% if ns.final_entities | length == 0 %}
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                     {% endif %}
#                   {% endfor %}         
#                   {{state_attr( ns.final_entities | first, 'volume_level') }}
#           media_image_url_template: >
#                   {% set location = "hotbox" %}  
#                   {% set ns = namespace( entities = [], final_entities = [""]  )%}
#                   
#                   {% for media_player in states.media_player %} 
#                     {% if location in media_player.entity_id  and "plex" not in media_player.entity_id  and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
#                       {% set entity = media_player.entity_id %}
#                       {% set ns.entities = ns.entities + [entity] %}
#                     {% endif %}                  
#                   {% endfor %}  
#                   
#                   {% for entity in ns.entities %}  
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                       {% if ns.final_entities | length == 0 %}
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                     {% endif %}
#                   {% endfor %}                   
#                   {% set ns = namespace( cast_entity = ns.final_entities | last, template_entity = "" ) %}
#                   {% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}                
#                   {% for media_player in states.media_player %} 
#                     {% if "plex" in media_player.entity_id  %}
#                       {% set entity = media_player.entity_id %}
#                       {% set media_title = state_attr( entity, 'media_title') %}
#                         {% if state_attr( ns.final_entity, 'media_title') %}
#                           {% if ( media_title | string ) in state_attr( ns.cast_entity, 'media_title') %}
#                           {% set ns.template_entity = entity %}
#                           {% endif %}
#                         {% endif %}
#                     {% endif %}
#                   {% endfor %}
#                   {% if ns.template_entity != ns.cast_entity and ns.template_entity != "" %}                   
#                     {{state_attr(ns.template_entity, 'entity_picture')}}
#                   {% elif state_attr( ns.cast_entity, 'entity_picture')  %} 
#                     {{state_attr(ns.cast_entity, 'entity_picture')}} 
#                   {% else %}
#                     off
#                   {% endif %}
#           title_template: >
#                   {% set location = "hotbox" %}  
#                   {% set ns = namespace( entities = [], final_entities = [""]  )%}
#                   
#                   {% for media_player in states.media_player %} 
#                     {% if location in media_player.entity_id  and "plex" not in media_player.entity_id  and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
#                       {% set entity = media_player.entity_id %}
#                       {% set ns.entities = ns.entities + [entity] %}
#                     {% endif %}                  
#                   {% endfor %}  
#                   
#                   {% for entity in ns.entities %}  
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                       {% if ns.final_entities | length == 0 %}
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                     {% endif %}
#                   {% endfor %}     
#                   {% if state_attr( ns.final_entities | first, 'media_title') %}
#                   {{ state_attr( ns.final_entities | first, 'media_title') }}
#                   {% endif %}
#           album_template: >
#                   {% set location = "hotbox" %}  
#                   {% set ns = namespace( entities = [], final_entities = [""]  )%}
#                   
#                   {% for media_player in states.media_player %} 
#                     {% if location in media_player.entity_id  and "plex" not in media_player.entity_id  and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
#                       {% set entity = media_player.entity_id %}
#                       {% set ns.entities = ns.entities + [entity] %}
#                     {% endif %}                  
#                   {% endfor %}  
#                   
#                   {% for entity in ns.entities %}  
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                       {% if ns.final_entities | length == 0 %}
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                     {% endif %}
#                   {% endfor %}     
#                   {% if state_attr( ns.final_entities | first, 'media_album_name') %}
#                   {{ state_attr( ns.final_entities | first, 'media_album_name') }}
#                   {% endif %}
#           artist_template: >
#                   {% set location = "hotbox" %}  
#                   {% set ns = namespace( entities = [], final_entities = [""]  )%}
#                   
#                   {% for media_player in states.media_player %} 
#                     {% if location in media_player.entity_id  and "plex" not in media_player.entity_id  and "template" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
#                       {% set entity = media_player.entity_id %}
#                       {% set ns.entities = ns.entities + [entity] %}
#                     {% endif %}                  
#                   {% endfor %}  
#                   
#                   {% for entity in ns.entities %}  
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                       {% if ns.final_entities | length == 0 %}
#                       {% if "speaker" in entity %}
#                         {% set ns.final_entities = ns.final_entities + [entity] %}
#                       {% endif %}
#                     {% endif %}
#                   {% endfor %}     
#                   {% if state_attr( ns.final_entities | first, 'media_album_artist') %}
#                   {{ state_attr( ns.final_entities | first, 'media_album_artist') }}
#                   {% elif state_attr( ns.final_entities | first, 'media_artist') %}                
#                   {{ state_attr( ns.final_entities | first, 'media_artist') }}
#                   {% endif %}
#           unique_id: template_hotbox_wiim_speaker
#           media_content_type_template: music




  ################# FOLLOWING SPEAKER ####################



  template_following_speaker:
          friendly_name: Template Following speaker
          device_class: tv
          value_template: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set state = media_player.state %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                  {% set is_muted = state_attr(entity, "is_volume_muted") %}
                      {% set state = states( entity ) %}
                      {% if "speaker" in entity and state != none %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                  {% endfor %}
                  {% if ns.final_entities | length > 0 %}
                  {{ states(ns.final_entities | first )  }}
                  {% else %}
                    off
                  {% endif %}
          next:
            service: media_player.media_seek
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
              seek_position: 56000
          turn_on:
            service: media_player.turn_on
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          stop:
            service: media_player.media_stop
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          play_pause:
            service: media_player.media_play_pause
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          play:
            service: media_player.media_play
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          pause:
            service: media_player.media_pause
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          turn_off:
            service: media_player.turn_off
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          volume_up:
            service: media_player.volume_up
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          volume_down:
            service: media_player.volume_down
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          mute:
            service: media_player.volume_mute
            data_template:
              is_volume_muted: "true"
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          set_volume:
            service: media_player.volume_set
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
              volume_level: "{{ volume }}"
          current_is_muted_template: "{{state_attr( 'media_player.office_speaker', 'is_volume_muted') }}"
          current_volume_template: "{{state_attr( 'media_player.livingroom_chromecast', 'volume_level') }}"
          media_image_url_template: >                
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [],entity_picture = ""  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id and "roku" not in media_player.entity_id and "speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% if  state_attr( entity, 'entity_picture') != none %}
                          {% set ns.entity_picture = state_attr( entity, 'entity_picture') %}
                      {% elif  state_attr( entity, 'entity_picture_local') != none %}
                          {% set ns.entity_picture = state_attr( entity, 'entity_picture_local') %}
                      {% endif %}  
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                      {% if  state_attr( entity, 'entity_picture') != none %}
                          {% set ns.entity_picture = state_attr( entity, 'entity_picture') %}
                      {% elif  state_attr( entity, 'entity_picture_local') != none %}
                          {% set ns.entity_picture = state_attr( entity, 'entity_picture_local') %}
                      {% endif %}                    
                  {% endfor %}
                  {{ns.entity_picture }}
          title_template: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_title = state_attr( entity, 'media_title') %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                  {% set is_muted = state_attr(entity, "is_volume_muted") %}
                  {% if is_muted == false %}
                      {% set media_title = state_attr( entity, 'media_title') %}
                      {% if "speaker" in entity and media_title != none %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.final_entities | length > 0 %}
                  {{state_attr( ns.final_entities | first , 'media_title' ) }}
                  {% endif %}
          album_template: >                
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_album_name = state_attr( entity, 'media_album_name') %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                  {% set is_muted = state_attr(entity, "is_volume_muted") %}
                  {% if is_muted == false %}
                      {% set media_album_name = state_attr( entity, 'media_album_name') %}
                      {% if "speaker" in entity and media_album_name != none %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.final_entities | length > 0 %}
                  {{state_attr( ns.final_entities | random , 'media_album_name' ) }}
                  {% endif %}
          artist_template: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_artist = state_attr( entity, 'media_artist') %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                  {% set is_muted = state_attr(entity, "is_volume_muted") %}
                  {% if is_muted == false %}
                      {% set media_artist = state_attr( entity, 'media_artist') %}
                      {% if "speaker" in entity and media_artist != none %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.final_entities | length > 0 %}
                  {{state_attr( ns.final_entities | random , 'media_artist' ) }}
                    {% endif %}
          unique_id: template_following_speaker

  ######################################Template Following Chromecast#############################################################
  template_following_chromecast:
          friendly_name: Template Following Chromecast
          device_class: tv
          value_template: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set state = media_player.state %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                  {% set is_muted = state_attr(entity, "is_volume_muted") %}
                      {% set state = states( entity ) %}
                      {% if "chromecast" in entity and "template" in entity and state != none %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                  {% endfor %}
                  {% if ns.final_entities | length > 0 %}
                  {{ states(ns.final_entities | first )  }}
                  {% else %}
                    off
                  {% endif %}
          next:
            service: media_player.media_seek
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
              seek_position: 56000
          turn_on:
            service: media_player.turn_on
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          play_pause:
            service: media_player.media_play_pause
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "plex" not in media_player.entity_id and "template" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          play:
            service: media_player.media_play
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "plex" not in media_player.entity_id and "template" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          pause:
            service: media_player.media_pause
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "plex" not in media_player.entity_id and "template" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          stop:
            service: media_player.media_stop
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          turn_off:
            service: media_player.turn_off
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          volume_up:
            service: media_player.volume_up
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          volume_down:
            service: media_player.volume_down
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          mute:
            service: media_player.volume_mute
            data_template:
              is_volume_muted: "true"
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          set_volume:
            service: media_player.volume_set
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
              volume_level: "{{ volume }}"
          current_is_muted_template: "{{state_attr( 'media_player.office_chromecast', 'is_volume_muted') }}"
          media_image_url_template: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [],entity_picture = ""  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id and "roku" not in media_player.entity_id and "chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% if  state_attr( entity, 'entity_picture') != none %}
                          {% set ns.entity_picture = state_attr( entity, 'entity_picture') %}
                      {% elif  state_attr( entity, 'entity_picture_local') != none %}
                          {% set ns.entity_picture = state_attr( entity, 'entity_picture_local') %}
                      {% endif %}  
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                      {% if  state_attr( entity, 'entity_picture') != none %}
                          {% set ns.entity_picture = state_attr( entity, 'entity_picture') %}
                      {% elif  state_attr( entity, 'entity_picture_local') != none %}
                          {% set ns.entity_picture = state_attr( entity, 'entity_picture_local') %}
                      {% endif %}                    
                  {% endfor %}
                  {{ ns.entity_picture }}
          title_template: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], title = []  )%}                
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_title = state_attr( entity, 'media_title') %}                    
                      {% if  state_attr( entity, 'media_title') != none %}
                          {% set ns.title = state_attr( entity, 'media_title') %}
                      {% elif  state_attr( entity, 'media_series_title') != none %}
                          {% set ns.title = state_attr( entity, 'media_series_title') %}
                      {% endif %}                        
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                 
                  {% endfor %}                  
                  {% for entity in ns.entities %}                     
                      {% if  state_attr( entity, 'media_title') != none %}
                          {% set ns.title = state_attr( entity, 'media_title') %}
                      {% elif  state_attr( entity, 'media_series_title') != none %}
                          {% set ns.title = state_attr( entity, 'media_series_title') %}
                      {% endif %}  
                  {% endfor %}
                  {{ ns.title }}
                  
          album_template: >                
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_album_name = state_attr( entity, 'media_album_name') %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                  {% set is_muted = state_attr(entity, "is_volume_muted") %}
                  {% if is_muted == false %}
                      {% set media_album_name = state_attr( entity, 'media_album_name') %}
                      {% if "chromecast" in entity and media_album_name != none %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.final_entities | length > 0 %}
                  {{state_attr( ns.final_entities | random , 'media_album_name' ) }}
                  {% endif %}
          artist_template: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_artist = state_attr( entity, 'media_artist') %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                  {% set is_muted = state_attr(entity, "is_volume_muted") %}
                  {% if is_muted == false %}
                      {% set media_artist = state_attr( entity, 'media_artist') %}
                      {% if "chromecast" in entity and media_artist != none %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.final_entities | length > 0 %}
                  {{state_attr( ns.final_entities | random , 'media_artist' ) }}
                    {% endif %}
          unique_id: template_following_chromecast


  ##################### Conditional MEdia players ###################







  ###################### FOLLOWING MEDIA PLAYER COMPOUND #################
  template_following_media_player:
          friendly_name: Template Following Media Player
          value_template: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = media_player.entity_id %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = media_player.entity_id %}
                  {% endif %}                  
                {% endfor %}
                {{ states(ns.following_media_player_entity)  }}
        
          
          play:
            service: media_player.media_play
            data_template: 
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}

          play_pause:
            service: media_player.media_play_pause
            data_template: 
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}

          pause:
            service: media_player.media_pause
            data_template: 
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}


          next:
            service: media_player.media_seek
            data_template:
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}


              seek_position: >
                        {{ state_attr( "media_player.group_home_speakers", "media_duration" ) }} 

          turn_on:
            service: media_player.turn_on
            data_template:
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}
          stop:
            service: media_player.media_stop
            data_template:
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}
          turn_off:
            service: media_player.turn_off
            data_template:
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}
          volume_up:
            service: media_player.volume_up
            data_template:
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}
          volume_down:
            service: media_player.volume_down
            data_template:
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}
          mute:
            service: media_player.volume_mute
            data_template:
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}
          set_volume:
            service: media_player.volume_set
            data_template:
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}
              volume_level: "{{ volume }}"
          current_is_muted_template: >
                  {% set following_speaker = states('media_player.template_following_speaker') %}
                  {% set following_chromecast = states('media_player.template_following_chromecast') %}
                  {% set ns = namespace( following_media_player_entity = "none"  ) %}
                  {% for media_player in states.media_player %} 
                    {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"%}
                    {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% endif %}                  
                  {% endfor %}
                  {{ state_attr(ns.following_media_player_entity,'is_volume_muted') }}

          media_image_url_template: >
                  {% set following_speaker = states('media_player.template_following_speaker') %}
                  {% set following_chromecast = states('media_player.template_following_chromecast') %}
                  {% set ns = namespace( following_media_player_entity = "none"  ) %}
                  {% for media_player in states.media_player %} 
                    {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                      {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% endif %}                  
                  {% endfor %}
                  {{ state_attr(ns.following_media_player_entity,'entity_picture_local') }}
          title_template: >
                  {% set following_speaker = states('media_player.template_following_speaker') %}
                  {% set following_chromecast = states('media_player.template_following_chromecast') %}
                  {% set ns = namespace( following_media_player_entity = "none"  ) %}
                  {% for media_player in states.media_player %} 
                    {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"%}
                    {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% endif %}                  
                  {% endfor %}
                  {{ state_attr(ns.following_media_player_entity,'media_title') }}


          album_template: >
                  {% set following_speaker = states('media_player.template_following_speaker') %}
                  {% set following_chromecast = states('media_player.template_following_chromecast') %}
                  {% set ns = namespace( following_media_player_entity = "none"  ) %}
                  {% for media_player in states.media_player %} 
                    {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"%}
                    {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% endif %}                  
                  {% endfor %}
                  {{ state_attr(ns.following_media_player_entity,'media_album_name') }}
          artist_template: >
                  {% set following_speaker = states('media_player.template_following_speaker') %}
                  {% set following_chromecast = states('media_player.template_following_chromecast') %}
                  {% set ns = namespace( following_media_player_entity = "none"  ) %}
                  {% for media_player in states.media_player %} 
                    {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"%}
                    {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% endif %}                  
                  {% endfor %}
                  {{ state_attr(ns.following_media_player_entity,'media_artist') }}
          unique_id: template_following_media_player