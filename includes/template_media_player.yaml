  ################# FOLLOWING SPEAKER ####################



  template_following_speaker:
          friendly_name: Template Following speaker
          device_class: tv
          value_template: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set state = media_player.state %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                  {% set is_muted = state_attr(entity, "is_volume_muted") %}
                      {% set state = states( entity ) %}
                      {% if "speaker" in entity and state != none %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                  {% endfor %}
                  {% if ns.final_entities | length > 0 %}
                  {{ states(ns.final_entities | first )  }}
                  {% else %}
                    off
                  {% endif %}
          next:
            service: media_player.media_seek
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
              seek_position: 56000
          turn_on:
            service: media_player.turn_on
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          stop:
            service: media_player.media_stop
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          play_pause:
            service: media_player.media_play_pause
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          play:
            service: media_player.media_play
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          pause:
            service: media_player.media_pause
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          turn_off:
            service: media_player.turn_off
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          volume_up:
            service: media_player.volume_up
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          volume_down:
            service: media_player.volume_down
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          mute:
            service: media_player.volume_mute
            data_template:
              is_volume_muted: "true"
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          set_volume:
            service: media_player.volume_set
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "v4" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "speaker" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
              volume_level: "{{ volume }}"
          current_is_muted_template: "{{state_attr( 'media_player.office_speaker', 'is_volume_muted') }}"
          current_volume_template: "{{state_attr( 'media_player.livingroom_chromecast', 'volume_level') }}"
          media_image_url_template: >                
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [],entity_picture = ""  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id and "roku" not in media_player.entity_id and "speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% if  state_attr( entity, 'entity_picture') != none %}
                          {% set ns.entity_picture = state_attr( entity, 'entity_picture') %}
                      {% elif  state_attr( entity, 'entity_picture_local') != none %}
                          {% set ns.entity_picture = state_attr( entity, 'entity_picture_local') %}
                      {% endif %}  
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                      {% if  state_attr( entity, 'entity_picture') != none %}
                          {% set ns.entity_picture = state_attr( entity, 'entity_picture') %}
                      {% elif  state_attr( entity, 'entity_picture_local') != none %}
                          {% set ns.entity_picture = state_attr( entity, 'entity_picture_local') %}
                      {% endif %}                    
                  {% endfor %}
                  {{ns.entity_picture }}
          title_template: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_title = state_attr( entity, 'media_title') %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                  {% set is_muted = state_attr(entity, "is_volume_muted") %}
                  {% if is_muted == false %}
                      {% set media_title = state_attr( entity, 'media_title') %}
                      {% if "speaker" in entity and media_title != none %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.final_entities | length > 0 %}
                  {{state_attr( ns.final_entities | first , 'media_title' ) }}
                  {% endif %}
          album_template: >                
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_album_name = state_attr( entity, 'media_album_name') %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                  {% set is_muted = state_attr(entity, "is_volume_muted") %}
                  {% if is_muted == false %}
                      {% set media_album_name = state_attr( entity, 'media_album_name') %}
                      {% if "speaker" in entity and media_album_name != none %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.final_entities | length > 0 %}
                  {{state_attr( ns.final_entities | random , 'media_album_name' ) }}
                  {% endif %}
          artist_template: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_artist = state_attr( entity, 'media_artist') %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                  {% set is_muted = state_attr(entity, "is_volume_muted") %}
                  {% if is_muted == false %}
                      {% set media_artist = state_attr( entity, 'media_artist') %}
                      {% if "speaker" in entity and media_artist != none %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.final_entities | length > 0 %}
                  {{state_attr( ns.final_entities | random , 'media_artist' ) }}
                    {% endif %}
          unique_id: template_following_speaker

  ######################################Template Following Chromecast#############################################################
  template_following_chromecast:
          friendly_name: Template Following Chromecast
          device_class: tv
          value_template: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set state = media_player.state %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                  {% set is_muted = state_attr(entity, "is_volume_muted") %}
                      {% set state = states( entity ) %}
                      {% if "chromecast" in entity and "template" in entity and state != none %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                  {% endfor %}
                  {% if ns.final_entities | length > 0 %}
                  {{ states(ns.final_entities | first )  }}
                  {% else %}
                    off
                  {% endif %}
          next:
            service: media_player.media_seek
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
              seek_position: 56000
          turn_on:
            service: media_player.turn_on
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          play_pause:
            service: media_player.media_play_pause
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "plex" not in media_player.entity_id and "template" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          play:
            service: media_player.media_play
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "plex" not in media_player.entity_id and "template" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          pause:
            service: media_player.media_pause
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and "plex" not in media_player.entity_id and "template" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          stop:
            service: media_player.media_stop
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          turn_off:
            service: media_player.turn_off
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          volume_up:
            service: media_player.volume_up
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          volume_down:
            service: media_player.volume_down
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          mute:
            service: media_player.volume_mute
            data_template:
              is_volume_muted: "true"
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
          set_volume:
            service: media_player.volume_set
            data_template:
              entity_id: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id  and  "template" not in media_player.entity_id and "plex" not in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}  
                  
                  {% for entity in ns.entities %}  
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                      {% if ns.final_entities | length == 0 %}
                      {% if "chromecast" in entity %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}                
                  {% if ns.final_entities | length > 0 %}
                  {{ ns.final_entities }}
                  {% endif %}
              volume_level: "{{ volume }}"
          current_is_muted_template: "{{state_attr( 'media_player.office_chromecast', 'is_volume_muted') }}"
          media_image_url_template: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [],entity_picture = ""  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id and "roku" not in media_player.entity_id and "chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% if  state_attr( entity, 'entity_picture') != none %}
                          {% set ns.entity_picture = state_attr( entity, 'entity_picture') %}
                      {% elif  state_attr( entity, 'entity_picture_local') != none %}
                          {% set ns.entity_picture = state_attr( entity, 'entity_picture_local') %}
                      {% endif %}  
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                      {% if  state_attr( entity, 'entity_picture') != none %}
                          {% set ns.entity_picture = state_attr( entity, 'entity_picture') %}
                      {% elif  state_attr( entity, 'entity_picture_local') != none %}
                          {% set ns.entity_picture = state_attr( entity, 'entity_picture_local') %}
                      {% endif %}                    
                  {% endfor %}
                  {{ ns.entity_picture }}
          title_template: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], title = []  )%}                
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_title = state_attr( entity, 'media_title') %}                    
                      {% if  state_attr( entity, 'media_title') != none %}
                          {% set ns.title = state_attr( entity, 'media_title') %}
                      {% elif  state_attr( entity, 'media_series_title') != none %}
                          {% set ns.title = state_attr( entity, 'media_series_title') %}
                      {% endif %}                        
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                 
                  {% endfor %}                  
                  {% for entity in ns.entities %}                     
                      {% if  state_attr( entity, 'media_title') != none %}
                          {% set ns.title = state_attr( entity, 'media_title') %}
                      {% elif  state_attr( entity, 'media_series_title') != none %}
                          {% set ns.title = state_attr( entity, 'media_series_title') %}
                      {% endif %}  
                  {% endfor %}
                  {{ ns.title }}
                  
          album_template: >                
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_album_name = state_attr( entity, 'media_album_name') %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                  {% set is_muted = state_attr(entity, "is_volume_muted") %}
                  {% if is_muted == false %}
                      {% set media_album_name = state_attr( entity, 'media_album_name') %}
                      {% if "chromecast" in entity and media_album_name != none %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.final_entities | length > 0 %}
                  {{state_attr( ns.final_entities | random , 'media_album_name' ) }}
                  {% endif %}
          artist_template: >
                  {% set location = states('sensor.maxi_location_v3') %}  
                  {% set ns = namespace( entities = [], final_entities = []  )%}
                  
                  {% for media_player in states.media_player %} 
                    {% if location in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set entity = media_player.entity_id %}
                      {% set media_artist = state_attr( entity, 'media_artist') %}
                      {% set ns.entities = ns.entities + [entity] %}
                    {% endif %}                  
                  {% endfor %}                  
                  {% for entity in ns.entities %}  
                  {% set is_muted = state_attr(entity, "is_volume_muted") %}
                  {% if is_muted == false %}
                      {% set media_artist = state_attr( entity, 'media_artist') %}
                      {% if "chromecast" in entity and media_artist != none %}
                        {% set ns.final_entities = ns.final_entities + [entity] %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                  {% if ns.final_entities | length > 0 %}
                  {{state_attr( ns.final_entities | random , 'media_artist' ) }}
                    {% endif %}
          unique_id: template_following_chromecast


  ##################### Conditional MEdia players ###################







  ###################### FOLLOWING MEDIA PLAYER COMPOUND #################
  template_following_media_player:
          friendly_name: Template Following Media Player
          value_template: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = media_player.entity_id %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = media_player.entity_id %}
                  {% endif %}                  
                {% endfor %}
                {{ states(ns.following_media_player_entity)  }}
        
          
          play:
            service: media_player.media_play
            data_template: 
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}

          play_pause:
            service: media_player.media_play_pause
            data_template: 
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}

          pause:
            service: media_player.media_pause
            data_template: 
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}


          next:
            service: media_player.media_seek
            data_template:
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}


              seek_position: >
                        {{ state_attr( "media_player.group_home_speakers", "media_duration" ) }} 

          turn_on:
            service: media_player.turn_on
            data_template:
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}
          stop:
            service: media_player.media_stop
            data_template:
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}
          turn_off:
            service: media_player.turn_off
            data_template:
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}
          volume_up:
            service: media_player.volume_up
            data_template:
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}
          volume_down:
            service: media_player.volume_down
            data_template:
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}
          mute:
            service: media_player.volume_mute
            data_template:
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}
          set_volume:
            service: media_player.volume_set
            data_template:
              entity_id: >
                {% set following_speaker = states('media_player.template_following_speaker') %}
                {% set following_chromecast = states('media_player.template_following_chromecast') %}
                {% set ns = namespace( following_media_player_entity = "none"  ) %}
                {% for media_player in states.media_player %} 
                  {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = [media_player.entity_id] %}
                  {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                  {% set ns.following_media_player_entity = [media_player.entity_id]  %}
                  {% endif %}                  
                {% endfor %}
                {{ ns.following_media_player_entity  }}
              volume_level: "{{ volume }}"
          current_is_muted_template: >
                  {% set following_speaker = states('media_player.template_following_speaker') %}
                  {% set following_chromecast = states('media_player.template_following_chromecast') %}
                  {% set ns = namespace( following_media_player_entity = "none"  ) %}
                  {% for media_player in states.media_player %} 
                    {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"%}
                    {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% endif %}                  
                  {% endfor %}
                  {{ state_attr(ns.following_media_player_entity,'is_volume_muted') }}

          media_image_url_template: >
                  {% set following_speaker = states('media_player.template_following_speaker') %}
                  {% set following_chromecast = states('media_player.template_following_chromecast') %}
                  {% set ns = namespace( following_media_player_entity = "none"  ) %}
                  {% for media_player in states.media_player %} 
                    {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                      {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"  %}
                    {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% endif %}                  
                  {% endfor %}
                  {{ state_attr(ns.following_media_player_entity,'entity_picture_local') }}
          title_template: >
                  {% set following_speaker = states('media_player.template_following_speaker') %}
                  {% set following_chromecast = states('media_player.template_following_chromecast') %}
                  {% set ns = namespace( following_media_player_entity = "none"  ) %}
                  {% for media_player in states.media_player %} 
                    {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"%}
                    {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% endif %}                  
                  {% endfor %}
                  {{ state_attr(ns.following_media_player_entity,'media_title') }}


          album_template: >
                  {% set following_speaker = states('media_player.template_following_speaker') %}
                  {% set following_chromecast = states('media_player.template_following_chromecast') %}
                  {% set ns = namespace( following_media_player_entity = "none"  ) %}
                  {% for media_player in states.media_player %} 
                    {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"%}
                    {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% endif %}                  
                  {% endfor %}
                  {{ state_attr(ns.following_media_player_entity,'media_album_name') }}
          artist_template: >
                  {% set following_speaker = states('media_player.template_following_speaker') %}
                  {% set following_chromecast = states('media_player.template_following_chromecast') %}
                  {% set ns = namespace( following_media_player_entity = "none"  ) %}
                  {% for media_player in states.media_player %} 
                    {% if "following_speaker" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off" %}
                      {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% elif "following_chromecast" in media_player.entity_id and media_player.state != "unavailable" and media_player.state != "off"%}
                    {% set ns.following_media_player_entity = media_player.entity_id %}
                    {% endif %}                  
                  {% endfor %}
                  {{ state_attr(ns.following_media_player_entity,'media_artist') }}
          unique_id: template_following_media_player