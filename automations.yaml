- id: '1691007313405'
  alias: Assist play specific artist
  description: ''
  trigger:
  - platform: conversation
    command:
    - play the artist {artist}
    - play some  [of] {artist}
  condition: []
  action:
  - service: mass.search
    data:
      limit: 1
      media_type:
      - artist
      name: '{{ trigger.slots.artist  }}'
    response_variable: found_artist
  - service: mass.play_media
    data:
      media_type: artist
      enqueue: replace
      media_id: '{{ found_artist.artists.0.name }}'
    target:
      entity_id: media_player.group_mass_home_airplay_speakers
  mode: single
- id: '1691088980213'
  alias: Assist Play Playlist
  description: ''
  trigger:
  - platform: conversation
    command:
    - start [the] {playlist} playlist
  condition: []
  action:
  - service: mass.play_media
    data:
      media_type: playlist
      enqueue: replace
      media_id: '{{ trigger.slots.playlist }}'
    target:
      entity_id: media_player.group_mass_home_airplay_speakers
  mode: single
- id: '1691094215164'
  alias: Assist Set Thermostats
  description: ''
  trigger:
  - platform: conversation
    command:
    - (set|change) [the] {thermostat} (AC|thermostat) to {temperature}
  condition: []
  action:
  - service: climate.set_temperature
    data:
      temperature: '{{ trigger.slots.temperature }}'
    target:
      entity_id: climate.{{ trigger.slots.thermostat| lower | replace('living room','livingroom')}}_ac
  mode: single
- id: '1693412216159'
  alias: Assist play specific song
  description: ''
  trigger:
  - platform: conversation
    command:
    - (start|play) [the] song {song}
  condition: []
  action:
  - data:
      media_content_type: music
      media_content_id: 'plex://{ "track_name": "{{ trigger.slots.song | replace(".","")
        }}", "allow_multiple": 1 ,"library_name": "Music" }'
    target:
      entity_id: media_player.group_mass_home_airplay_speakers
    action: media_player.play_media
  mode: single
- id: '1698434157594'
  alias: Update Map Extractor camera
  description: ''
  use_blueprint:
    path: PiotrMachowski/update_map_extractor.yaml
    input:
      vacuum: vacuum.xiaomi_vacuum_cleaner
      camera: camera.xiaomi_cloud_map_extractor
      mode_to_handle: turn_off_when_docked
- id: '1708472009602'
  alias: Play Music when maxi awakes at home
  description: This Automation will start music on the home group when maxi awakes
  trigger:
  - platform: state
    entity_id:
    - sensor.is_maxi_asleep
    from: asleep
    to: awake
    for:
      hours: 0
      minutes: 5
      seconds: 0
  condition:
  - condition: state
    entity_id: person.maximiliano
    state: home
  - condition: state
    entity_id: media_player.group_mass_home_airplay_speakers
    state: 'off'
  - condition: state
    entity_id: binary_sensor.all_present_sleeping
    state: 'off'
  action:
  - data:
      media_content_type: playlist
      media_content_id: 100 Random tracks (from library)
    action: media_player.play_media
    target:
      entity_id: media_player.group_mass_home_airplay_speakers
  mode: single
- id: '1708472370553'
  alias: Stop bedroom speaker when bedroom sleeper awake
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.sleeper_in_bedroom
    from: 'on'
    to: 'off'
    for:
      hours: 0
      minutes: 3
      seconds: 0
  condition: []
  action:
  - service: media_player.media_stop
    metadata: {}
    data: {}
    target:
      entity_id: media_player.bedroom_speaker
  mode: single
- id: '1711377375732'
  alias: Assist play song by artist next
  description: ''
  trigger:
  - platform: conversation
    command:
    - queue {song} by {artist}
    - cue {song} by {artist}
  condition: []
  action:
  - service: mass.search
    data:
      limit: 1
      media_type:
      - track
      name: '{{ trigger.slots.song  }}'
      artist: '{{ trigger.slots.artist  }}'
    response_variable: found_song
  - service: mass.play_media
    target:
      entity_id: media_player.group_mass_home_airplay_speakers
    data:
      media_type: track
      enqueue: next
      media_id: '{{ found_song.tracks.0.name }}'
      artist: '{{ trigger.slots.artist  }}'
  mode: single
- id: '1711377604136'
  alias: Assist Play song by artist now
  description: ''
  trigger:
  - platform: conversation
    command:
    - play {song} by {artist}
  condition: []
  action:
  - service: mass.search
    data:
      limit: 1
      media_type:
      - track
      name: '{{ trigger.slots.song  }}'
      artist: '{{ trigger.slots.artist  }}'
    response_variable: found_song
  - service: mass.play_media
    target:
      entity_id:
      - media_player.group_mass_home_airplay_speakers
    data:
      media_type: track
      enqueue: play
      media_id: '{{ found_song.tracks.0.name }}'
  - service: mass.play_media
    target:
      entity_id:
      - media_player.group_mass_home_airplay_speakers
    data:
      media_type: track
      enqueue: add
      media_id: '{{ found_song.tracks.0.name }}'
      radio_mode: true
  mode: single
- id: '1711565389493'
  alias: Assist Restart Music Assistant
  description: ''
  trigger:
  - platform: conversation
    command: Restart Music Assistant
  condition: []
  action:
  - service: hassio.addon_restart
    metadata: {}
    data:
      addon: d5369777_music_assistant_beta
  mode: single
- id: '1711576326986'
  alias: Assist play music (default)
  description: ''
  trigger:
  - platform: conversation
    command:
    - play music
  condition: []
  action:
  - data:
      media_type: playlist
      enqueue: replace
      media_id: local maxi
    action: mass.play_media
    target:
      entity_id: media_player.group_mass_home_airplay_speakers
  mode: single
- id: '1713377627308'
  alias: Mute Speakers in the office when computer mic is in use
  description: ''
  trigger:
  - type: turned_on
    platform: device
    device_id: 0cc46b896079dbc299255330f9ea856e
    entity_id: 470a4142c11434774d1b570a456f145b
    domain: binary_sensor
  condition:
  - condition: not
    conditions:
    - condition: state
      entity_id: media_player.universal_office_speakers
      state: 'off'
  action:
  - service: media_player.volume_mute
    metadata: {}
    data:
      is_volume_muted: true
    target:
      entity_id: media_player.universal_office_speakers
  mode: single
- id: '1713377704036'
  alias: Unmute Speakers in the office when computer mic goes off
  description: ''
  trigger:
  - type: turned_off
    platform: device
    device_id: 0cc46b896079dbc299255330f9ea856e
    entity_id: 470a4142c11434774d1b570a456f145b
    domain: binary_sensor
  condition:
  - condition: not
    conditions:
    - condition: state
      entity_id: media_player.universal_office_speakers
      state: 'off'
  action:
  - service: media_player.volume_mute
    metadata: {}
    data:
      is_volume_muted: false
    target:
      entity_id: media_player.universal_office_speakers
  mode: single
- id: '1713378517441'
  alias: Lock front door when it is closed for 5 seconds
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.sensor_front_outside_door_contact
    from:
    to: 'off'
    for:
      hours: 0
      minutes: 0
      seconds: 5
  condition:
  - condition: not
    conditions:
    - condition: state
      entity_id: lock.lock_front_door
      state: locked
  action:
  - service: lock.lock
    metadata: {}
    data: {}
    target:
      entity_id: lock.lock_front_door
  mode: single
- id: '1713378679048'
  alias: Lock front door 5 minutes after unlocking
  description: ''
  trigger:
  - platform: state
    entity_id:
    - lock.lock_front_door
    to: unlocked
    for:
      hours: 0
      minutes: 5
      seconds: 0
  condition:
  - condition: state
    entity_id: binary_sensor.sensor_front_outside_door_contact
    state: 'off'
  action:
  - service: lock.lock
    metadata: {}
    data: {}
    target:
      entity_id: lock.lock_front_door
  mode: single
- id: '1713378916074'
  alias: Alert that the front door remained open
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.sensor_front_door_contact
    to: 'on'
    for:
      hours: 0
      minutes: 5
      seconds: 0
  condition:
  - condition: state
    entity_id: input_boolean.aerating_appartment
    state: 'off'
  action:
  - service: script.broadcast_alert_in_the_house
    metadata: {}
    data:
      message: Entrance door is open
  mode: restart
- id: '1713399927983'
  alias: Alert that the vacuum is stuck
  description: ''
  trigger:
  - platform: state
    entity_id:
    - vacuum.xiaomi_vacuum_cleaner
    to: error
  condition: []
  action:
  - repeat:
      sequence:
      - service: script.broadcast_alert_in_the_house
        metadata: {}
        data:
          message: Vacuum Stuck
      - delay:
          hours: 0
          minutes: 10
          seconds: 0
          milliseconds: 0
      until:
      - condition: not
        conditions:
        - condition: state
          entity_id: vacuum.xiaomi_vacuum_cleaner
          state: error
  mode: single
- id: '1713407734344'
  alias: Lock back door when it is closed for 5 seconds
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.sensor_back_outside_door_contact
    from:
    to: 'off'
    for:
      hours: 0
      minutes: 0
      seconds: 5
  condition:
  - condition: not
    conditions:
    - condition: state
      entity_id: lock.back_door
      state: locked
  action:
  - service: lock.lock
    metadata: {}
    data: {}
    target:
      entity_id: lock.back_door
  mode: single
- id: '1713407853586'
  alias: Lock back door 5 minutes after unlocking
  description: ''
  trigger:
  - platform: state
    entity_id:
    - lock.back_door
    to: unlocked
    for:
      hours: 0
      minutes: 5
      seconds: 0
  condition:
  - condition: state
    entity_id: binary_sensor.sensor_back_outside_door_contact
    state: 'off'
  action:
  - service: lock.lock
    metadata: {}
    data: {}
    target:
      entity_id: lock.back_door
  mode: single
- id: '1713408006382'
  alias: Turn back door lights on when someone is detected
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.back_door_camera_person_occupancy
    to: 'on'
  condition: []
  action:
  - service: light.turn_on
    metadata: {}
    data:
      color_temp: 254
      brightness: 255
    target:
      entity_id: light.back_door_light
  - wait_for_trigger:
    - platform: state
      entity_id:
      - binary_sensor.back_door_camera_person_occupancy
      to: 'off'
      for:
        hours: 0
        minutes: 0
        seconds: 30
    timeout:
      hours: 0
      minutes: 0
      seconds: 0
      milliseconds: 0
  - service: light.turn_off
    metadata: {}
    data:
      transition: 30
    target:
      entity_id: light.back_door_light
  mode: single
- id: '1713451307697'
  alias: Sleep actions when "maxi is sleeping" is turned on
  description: Close the blinds, turn off the lights and turn on the sleep mode of
    Adaptative lighting
  triggers:
  - entity_id:
    - binary_sensor.maxi_sleeping
    to: 'on'
    for:
      hours: 0
      minutes: 5
      seconds: 0
    trigger: state
  conditions:
  - condition: state
    entity_id: input_boolean.kink_party
    state: 'off'
  - condition: state
    entity_id: input_boolean.acid_time
    state: 'off'
  - condition: state
    entity_id: input_boolean.party_mode
    state: 'off'
  actions:
  - metadata: {}
    data: {}
    target:
      entity_id: switch.adaptive_lighting_sleep_mode_adaptive_lighting
    action: switch.turn_on
  - metadata: {}
    data: {}
    target:
      entity_id:
      - cover.cover_livingroom_blinds
      - cover.cover_salon_blinds
      - cover.cover_kitchen_blinds
    action: cover.close_cover
  mode: single
- id: '1713451780517'
  alias: Turn off Sleeping mode for Adaptative lighting on "MAxi is sleeping" turns
    on off
  description: Turn off sleep mode for adaptative lighting
  triggers:
  - entity_id:
    - binary_sensor.maxi_sleeping
    to: 'off'
    trigger: state
  conditions: []
  actions:
  - target:
      entity_id: switch.adaptive_lighting_sleep_mode_adaptive_lighting
    data: {}
    action: switch.turn_off
  mode: single
- id: '1713451981404'
  alias: Turn on party mode when over 5 guests are over
  description: Also check that no psychedelic or kink event is going on
  trigger:
  - platform: numeric_state
    entity_id:
    - sensor.amount_friends_home
    above: 5
  condition:
  - condition: state
    entity_id: input_boolean.kink_party
    state: 'off'
  - condition: state
    entity_id: input_boolean.acid_time
    state: 'off'
  action:
  - service: input_boolean.turn_on
    target:
      entity_id: input_boolean.party_mode
    data: {}
  mode: single
- id: '1713452550061'
  alias: Close blinds when the house is empty
  description: 'Close blinds '
  trigger:
  - platform: numeric_state
    entity_id:
    - zone.home
    for:
      hours: 0
      minutes: 5
      seconds: 0
    below: 0.9
  condition: []
  action:
  - service: cover.close_cover
    metadata: {}
    data: {}
    target:
      entity_id:
      - cover.cover_office_blinds
      - cover.cover_livingroom_blinds
  mode: single
- id: '1713460807856'
  alias: Start visuals when Party mode is turned on
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.party_mode
    to: 'on'
  condition: []
  action:
  - service: script.start_visual_playlist_on_plex
    metadata: {}
    data:
      requested_playlist: All Visuals
  mode: single
- id: '1713464997452'
  alias: Change room lights to semi-saturated colors when party turns on
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.party_mode
    to: 'on'
  condition: []
  action:
  - variables:
      light_groups: '{{integration_entities(''group'')|  select(''search'', ''lights'')  |  select(''search'',
        ''^((?!all).)*$'') | list}}

        '
  - repeat:
      sequence:
      - service: script.change_received_lights_to_random_colors
        data:
          lights:
          - '{{light_groups[repeat.index - 1]}}'
          saturation: 60
      for_each: '{{ light_groups }}'
  mode: single
- id: '1713465737957'
  alias: Change all single lights to random saturated colors  when acid mode turns
    on
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.acid_time
    to: 'on'
  condition: []
  action:
  - variables:
      lights: "{% set ns = namespace(lights=[]) %} {% set groups = integration_entities('group')|
        \ select('search', '^light.')   | list %} {% for group in groups %}\n    {%
        set individual_lights = state_attr(group,'entity_id')%}\n    {% for individual_light
        in individual_lights %}\n    {% if \"group\" not in individual_light and state_attr(individual_light,
        'rgb_color') %}\n      {% set ns.lights = ns.lights  + [individual_light]
        %}\n    {% endif %}\n    {% endfor %}    \n{% endfor %} {{  ns.lights  }}\n"
  - repeat:
      sequence:
      - service: script.change_received_lights_to_random_colors
        data:
          lights:
          - '{{lights[repeat.index - 1]}}'
          saturation: 100
      for_each: '{{ lights }}'
  mode: single
- id: '1713468195069'
  alias: Start 4k visuals when acid time turns on
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.acid_time
    to: 'on'
  condition: []
  action:
  - service: script.start_visual_playlist_on_plex
    metadata: {}
    data:
      requested_playlist: 4k visuals
  mode: single
- id: '1713469587813'
  alias: Turn lights to purple when a movie is played
  description: ''
  trigger:
  - platform: state
    entity_id:
    - media_player.universal_office_chromecast
    - media_player.universal_livingroom_chromecast
    - media_player.universal_hotbox_top_chromecast
    - media_player.universal_hotbox_down_chromecast
    - media_player.universal_patio_chromecast
    to: playing
  condition: []
  action:
  - repeat:
      sequence:
      - variables:
          on_lights_in_room: '{{ [area_id(trigger.entity_id)] | map(''area_id'') |
            map(''area_entities'') | sum(start=[]) | select(''match'', ''^light.'')
            | select(''is_state'',''on'') | unique | list }}

            '
          entity_id: '{{ trigger.entity_id }}

            '
          trigger_full: '{{ trigger.to_state.attributes }}

            '
      - if:
        - condition: template
          value_template: '{{ trigger.to_state.attributes.media_content_type == "movie"
            }}'
        - condition: template
          value_template: '{{ not trigger.to_state.attributes.media_series_title }}'
        then:
        - service: light.turn_on
          metadata: {}
          data:
            rgb_color:
            - 255
            - 0
            - 255
            brightness_pct: '30'
          target:
            entity_id: '{{ on_lights_in_room | list }}'
      count: 1
    enabled: true
  - wait_for_trigger:
    - platform: template
      value_template: '{{ states(trigger.entity_id) == "off" }}'
    timeout:
      hours: 4
      minutes: 0
      seconds: 0
      milliseconds: 0
    continue_on_timeout: false
  - variables:
      on_lights_in_room: '{{ [area_id(trigger.entity_id)] | map(''area_id'') | map(''area_entities'')
        | sum(start=[]) | select(''match'', ''^light.'') | select(''is_state'',''on'')
        | unique | list }}

        '
      entity_id: '{{ trigger.entity_id }}

        '
      trigger_full: '{{ trigger.to_state.attributes }}

        '
  - service: light.turn_on
    metadata: {}
    data:
      rgb_color:
      - 255
      - 255
      - 255
      brightness_pct: '100'
    target:
      entity_id: '{{ on_lights_in_room | list}}'
  mode: restart
- id: '1713533595890'
  alias: Disarm alarm-away when "User Home" turns on
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.user_home
    to: 'on'
    from: 'off'
  condition:
  - condition: state
    entity_id: alarm_control_panel.home_alarm
    state: armed_away
  action:
  - service: alarm_control_panel.alarm_disarm
    metadata: {}
    data: {}
    target:
      entity_id: alarm_control_panel.home_alarm
  mode: single
- id: '1713533768680'
  alias: Arm Alarm-Away when "User home" is off for 10 minutes
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.user_home
    from: 'on'
    to: 'off'
    for:
      hours: 0
      minutes: 10
      seconds: 0
  condition: []
  action:
  - service: alarm_control_panel.alarm_arm_away
    metadata: {}
    data: {}
    target:
      entity_id: alarm_control_panel.home_alarm
  mode: single
- id: '1713534223873'
  alias: Turn ACs on and Off  depending on house occupancy
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.user_home
  condition: []
  action:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.user_home
        state: 'on'
      sequence:
      - service: climate.set_preset_mode
        metadata: {}
        data:
          preset_mode: none
        target:
          entity_id:
          - climate.hotbox_ac
          - climate.livingroom_ac
          - climate.office_ac
    - conditions:
      - condition: state
        entity_id: binary_sensor.user_home
        state: 'off'
      sequence:
      - service: climate.set_preset_mode
        metadata: {}
        data:
          preset_mode: away
        target:
          entity_id:
          - climate.hotbox_ac
          - climate.livingroom_ac
          - climate.office_ac
  mode: single
- id: '1713535684569'
  alias: Play Muzak in the bathroom when someone enters
  description: ''
  triggers:
  - entity_id:
    - binary_sensor.sensor_bathroom_motion_occupancy
    to: 'on'
    from: 'off'
    trigger: state
  conditions:
  - condition: not
    conditions:
    - condition: state
      entity_id: media_player.bathroom_speaker
      state: playing
  actions:
  - metadata: {}
    data:
      media_content_id: 'plex://{ "library_name": "Muzak", "shuffle": 1, "allow_multiple":
        1}'
      media_content_type: music
    target:
      entity_id: media_player.bathroom_speaker
    action: media_player.play_media
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.sensor_bathroom_door_contact
        state: 'on'
      sequence:
      - metadata: {}
        data:
          volume_level: 0.1
        target:
          entity_id: media_player.bathroom_speaker
        action: media_player.volume_set
    - conditions:
      - condition: state
        entity_id: binary_sensor.sensor_bathroom_door_contact
        state: 'off'
      sequence:
      - metadata: {}
        data:
          volume_level: 0.4
        target:
          entity_id: media_player.bathroom_speaker
        action: media_player.volume_set
  mode: restart
- id: '1713536409397'
  alias: Raise music on the playing speaker when the Bathroom fans goes on
  description: ''
  triggers:
  - entity_id:
    - switch.bathroom_fan
    from: 'off'
    to: 'on'
    trigger: state
  conditions:
  - condition: state
    entity_id: binary_sensor.sensor_bathroom_door_contact
    state: 'off'
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: media_player.bathroom_speaker
        state: 'off'
      sequence:
      - metadata: {}
        data: {}
        target:
          entity_id: media_player.bathroom_speaker
        action: media_player.volume_up
      - metadata: {}
        data: {}
        target:
          entity_id: media_player.bathroom_speaker
        action: media_player.volume_up
    - conditions:
      - condition: state
        entity_id: media_player.bathroom_speaker
        state: playing
      sequence:
      - metadata: {}
        data: {}
        target:
          entity_id:
          - media_player.bathroom_speaker
        enabled: true
        action: media_player.volume_up
      - metadata: {}
        data: {}
        target:
          entity_id:
          - media_player.bathroom_speaker
        enabled: true
        action: media_player.volume_up
  mode: single
- id: '1713536741103'
  alias: Start/stop bathroom fan when Bathroom humidity changes
  description: ''
  triggers:
  - entity_id:
    - binary_sensor.shower_in_use
    trigger: state
    to: 'on'
    for:
      hours: 0
      minutes: 1
      seconds: 0
  conditions: []
  actions:
  - metadata: {}
    data: {}
    target:
      entity_id: switch.bathroom_fan
    action: switch.turn_on
  - wait_for_trigger:
    - entity_id:
      - sensor.sensor_bathroom_temperature_humidity
      below: sensor.sensor_outside_temperature_humidity
      trigger: numeric_state
    continue_on_timeout: true
    timeout:
      hours: 0
      minutes: 45
      seconds: 0
      milliseconds: 0
  - metadata: {}
    data: {}
    target:
      entity_id: switch.bathroom_fan
    action: switch.turn_off
  mode: restart
- id: '1713538197256'
  alias: Control Hallway Tablet charging
  description: ''
  trigger:
  - platform: state
    entity_id:
    - sensor.hallway_tablet_battery
  condition: []
  action:
  - choose:
    - conditions:
      - condition: numeric_state
        entity_id: sensor.hallway_tablet_battery
        above: 90
      sequence:
      - service: switch.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: switch.plug_hallway_tablet
    - conditions:
      - condition: numeric_state
        entity_id: sensor.hallway_tablet_battery
        below: 15
      sequence:
      - service: switch.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: switch.plug_hallway_tablet
  mode: single
- id: '1713574201448'
  alias: Turn lights to white when we stop a movie
  description: ''
  trigger:
  - platform: state
    entity_id:
    - media_player.universal_office_chromecast
    - media_player.universal_livingroom_chromecast
    - media_player.universal_hotbox_top_chromecast
    - media_player.universal_hotbox_down_chromecast
    - media_player.universal_patio_chromecast
    to: 'off'
  condition:
  - condition: template
    value_template: '{{ trigger.from_state.attributes.media_content_type == "movie"
      }}'
  - condition: template
    value_template: '{{ not trigger.from_state.attributes.media_series_title }}'
  action:
  - repeat:
      sequence:
      - variables:
          off_lights_in_room: '{{ [area_id(trigger.entity_id)] | map(''area_id'')
            | map(''area_entities'') | sum(start=[]) | select(''match'', ''^light.'')
            | select(''is_state'',''on'') | unique | list }}

            '
          entity_id: '{{ trigger.entity_id }}

            '
          trigger_full: '{{ trigger.to_state.attributes }}

            '
      - repeat:
          sequence:
          - service: light.turn_on
            metadata: {}
            data:
              rgb_color:
              - 255
              - 255
              - 255
              brightness_pct: '100'
              transition: 150
            target:
              entity_id: '{{ off_lights_in_room[repeat.index - 1 ] }}'
          for_each: '{{off_lights_in_room}}'
        enabled: true
      count: 1
    enabled: true
  mode: restart
- id: '1713630060902'
  alias: Raise lights to 60% brightness when a movie is paused and the brightness
    is below 30%
  description: ''
  trigger:
  - platform: state
    entity_id:
    - media_player.universal_office_chromecast
    - media_player.universal_livingroom_chromecast
    - media_player.universal_hotbox_top_chromecast
    - media_player.universal_hotbox_down_chromecast
    - media_player.universal_patio_chromecast
    to: paused
    from: playing
  condition:
  - condition: template
    value_template: '{{ trigger.from_state.attributes.media_content_type == "movie"
      }}'
  - condition: template
    value_template: '{{ not trigger.from_state.attributes.media_series_title }}'
  action:
  - repeat:
      sequence:
      - variables:
          off_lights_in_room: '{{ [area_id(trigger.entity_id)] | map(''area_id'')
            | map(''area_entities'') | sum(start=[]) | select(''match'', ''^light.'')
            | select(''is_state'',''on'') | unique | list }}

            '
          entity_id: '{{ trigger.entity_id }}

            '
          trigger_full: '{{ trigger.to_state.attributes }}

            '
      - repeat:
          sequence:
          - if:
            - condition: template
              value_template: '

                {{ state_attr(off_lights_in_room[repeat.index - 1 ], "brightness")
                < 80 }}'
            then:
            - service: light.turn_on
              metadata: {}
              data:
                brightness_pct: '60'
              target:
                entity_id: '{{ off_lights_in_room[repeat.index - 1 ] }}'
          for_each: '{{off_lights_in_room}}'
        enabled: true
      count: 1
    enabled: true
  mode: parallel
  max: 6
- id: '1713631370622'
  alias: Turn off Closet fan after 5 minutes of non occupancy
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.group_closet_motion_occupancy
    from: 'on'
    to: 'off'
    for:
      hours: 0
      minutes: 5
      seconds: 0
  condition:
  - condition: state
    entity_id: input_boolean.sleeper_in_closet
    state: 'off'
  action:
  - service: switch.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: switch.plug_closet_fan
  mode: single
- id: '1713719722990'
  alias: Conditionally Unmute Speakers when a room is occupied
  description: 'This one uses motion groups '
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.group_patio_motion_occupancy
    - binary_sensor.group_closet_motion_occupancy
    - binary_sensor.group_office_motion_occupancy
    - binary_sensor.group_server_motion_occupancy
    - binary_sensor.group_bedroom_motion_occupancy
    - binary_sensor.group_hallway_motion_occupancy
    - binary_sensor.group_kitchen_motion_occupancy
    - binary_sensor.group_entrance_motion_occupancy
    - binary_sensor.group_hotbox_top_motion_occupancy
    - binary_sensor.group_livingroom_motion_occupancy
    - binary_sensor.group_hotbox_down_motion_occupancy
    - binary_sensor.group_workstation_motion_occupancy
    - binary_sensor.group_salon_motion_occupancy
    for:
      hours: 0
      minutes: 0
      seconds: 0
    to: 'on'
  condition:
  - condition: state
    entity_id: input_boolean.following_music
    state: 'on'
  - condition: template
    value_template: '{{ trigger.to_state.state == "on" }}'
    alias: Confirm Motion
  - alias: Make sure no sleeper is present
    condition: template
    value_template: '{{ area_id(trigger.entity_id) | lower not in states(''sensor.active_sleeper_rooms'')
      | string | lower }}'
  - alias: Make sure no unmuted TV is present
    condition: template
    value_template: '{{ area_id(trigger.entity_id) | lower not in state_attr(''sensor.active_chromecast_rooms'',
      ''unmuted_rooms'') | string | lower }}'
  - alias: Make sure no active microphone is present
    condition: template
    value_template: '{{ area_id(trigger.entity_id) | lower not in states(''sensor.active_microphones_rooms'')
      | string | lower }}'
  action:
  - variables:
      playing_speakers: '{{ [area_id(trigger.entity_id)]   | map(''area_entities'')
        | sum(start=[]) |    select(''search'', ''speakers'') | select(''is_state'',''playing'')
        | unique | list }}

        '
  - service: media_player.volume_mute
    metadata: {}
    data:
      is_volume_muted: false
    target:
      entity_id: '{{playing_speakers}}'
    alias: Unmute the speaker
  - alias: Set Speaker volume to median volume  if the room is  empty for a long time
    if:
    - condition: template
      value_template: '{{ now() - trigger.from_state.last_changed > timedelta(seconds=1000)
        }}'
      alias: Is it beene empty  over 1000 seconds?
    then:
    - service: media_player.volume_set
      metadata: {}
      data:
        volume_level: "{% if states('sensor.average_unmuted_speakers_volume') | float
          > \".45\" | float %}\n .45\n{% else %} {{ states('sensor.average_unmuted_speakers_volume')
          }} {% endif %}\n"
      target:
        entity_id: '{{playing_speakers}}'
      alias: Set volume to the average of the house (maximum 45%)
  mode: parallel
  max: 10
- id: '1713723493265'
  alias: Start visuals on all inactive TVs
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_button.start_visuals
    to:
  condition: []
  action:
  - service: script.start_visual_playlist_on_plex
    metadata: {}
    data:
      requested_playlist: All Visuals
  mode: single
- id: '1713813890992'
  alias: Reload tablets 4 minutes after HA restarts
  description: ''
  trigger:
  - platform: numeric_state
    entity_id:
    - sensor.bootminutes
    below: 5
    above: 3
  condition: []
  action:
  - service: button.press
    metadata: {}
    data: {}
    target:
      entity_id:
      - button.samsung_galaxy_tab_e_8_0_load_start_url
      - button.office_tablet_load_start_url
      - button.hallway_tablet_load_start_url
      - button.kitchen_tablet_load_start_url
      - button.livingroom_tablet_load_start_url
  mode: single
- id: '1713824382107'
  alias: Turn on lights automatically
  description: 'This one uses motion groups '
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.group_office_motion_occupancy
    - binary_sensor.group_hallway_motion_occupancy
    - binary_sensor.group_kitchen_motion_occupancy
    - binary_sensor.group_hotbox_top_motion_occupancy
    - binary_sensor.group_livingroom_motion_occupancy
    - binary_sensor.group_hotbox_down_motion_occupancy
    - binary_sensor.group_patio_motion_occupancy
    - binary_sensor.group_closet_motion_occupancy
    - binary_sensor.group_server_motion_occupancy
    - binary_sensor.group_bathroom_motion_occupancy
    - binary_sensor.group_bedroom_motion_occupancy
    - binary_sensor.group_entrance_motion_occupancy
    - binary_sensor.group_workstation_motion_occupancy
    - binary_sensor.group_salon_motion_occupancy
    for:
      hours: 0
      minutes: 0
      seconds: 0
  condition:
  - condition: template
    value_template: '{{ area_id(trigger.entity_id) | replace(''_top'','''') | replace(''_down'','''')
      not in states(''sensor.active_sleeper_rooms'') | string  }}'
  action:
  - variables:
      off_lights_in_room: "{% set ns = namespace(f = [] ) %} {% for i in ( [area_id(trigger.entity_id)]
        \ | map('area_entities') | sum(start=[]) | select('match', '^light.') | select('is_state','off')
        \ |  unique | list )  %} {% if i not in  label_entities(\"High Intensity Light\")
        | string %}\n  {% set ns.f = ns.f + [i] %}\n{% endif %} {% endfor %} {{ ns.f
        }}\n"
  - repeat:
      sequence:
      - metadata: {}
        data: {}
        target:
          entity_id: '{{off_lights_in_room[repeat.index - 1]    }}'
        action: light.turn_on
      for_each: '{{off_lights_in_room}}'
  mode: parallel
  max: 25
- id: '1713826329670'
  alias: Mute speakers when the room is empty
  description: 'This one uses motion groups '
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.group_patio_motion_occupancy
    - binary_sensor.group_closet_motion_occupancy
    - binary_sensor.group_office_motion_occupancy
    - binary_sensor.group_server_motion_occupancy
    - binary_sensor.group_hallway_motion_occupancy
    - binary_sensor.group_kitchen_motion_occupancy
    - binary_sensor.group_bathroom_motion_occupancy
    - binary_sensor.group_entrance_motion_occupancy
    - binary_sensor.group_hotbox_top_motion_occupancy
    - binary_sensor.group_livingroom_motion_occupancy
    - binary_sensor.group_hotbox_down_motion_occupancy
    - binary_sensor.group_workstation_motion_occupancy
    - binary_sensor.group_chillingroom_motion_occupancy
    for:
      hours: 0
      minutes: 5
      seconds: 0
  condition:
  - condition: state
    entity_id: input_boolean.following_music
    state: 'on'
  - condition: template
    value_template: '{{ states(''sensor.maxi_location_v3'') not in [area_id(trigger.entity_id)]
      | string  }}'
  action:
  - variables:
      playing_speakers: '{{ [area_id(trigger.entity_id)]   | map(''area_entities'')
        | sum(start=[]) |    select(''search'', ''speakers'') | select(''is_state'',''playing'')
        | unique | list }}

        '
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ trigger.to_state.state == "off" }}'
      sequence:
      - service: media_player.volume_mute
        metadata: {}
        data:
          is_volume_muted: true
        target:
          entity_id: '{{playing_speakers}}

            '
      alias: Motion is OFF
  mode: parallel
  max: 10
- id: '1714054125770'
  alias: Alert when dryer finishes!
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.dryer_dry_completed
    from: 'off'
    to: 'on'
  condition:
  - condition: state
    entity_id: binary_sensor.maxi_sleeping
    state: 'off'
  - condition: state
    entity_id: binary_sensor.all_present_sleeping
    state: 'off'
  action:
  - repeat:
      sequence:
      - service: script.1714666287611
        data: {}
      - delay:
          hours: 0
          minutes: 15
          seconds: 0
          milliseconds: 0
      until:
      - condition: state
        entity_id: binary_sensor.group_kitchen_motion_occupancy
        state: 'on'
  mode: single
- id: '1714058481200'
  alias: Alert when Microwave finishes
  description: ''
  trigger:
  - platform: numeric_state
    entity_id:
    - sensor.power_switch_electric_consumption_w_4
    above: 100
  condition:
  - condition: state
    entity_id: binary_sensor.maxi_sleeping
    state: 'off'
  - condition: state
    entity_id: binary_sensor.all_present_sleeping
    state: 'off'
  - condition: state
    entity_id: input_boolean.cooking_mode
    state: 'off'
  action:
  - wait_for_trigger:
    - platform: numeric_state
      entity_id:
      - sensor.power_switch_electric_consumption_w_4
      for:
        hours: 0
        minutes: 0
        seconds: 5
      below: 28
    continue_on_timeout: false
    timeout:
      hours: 0
      minutes: 20
      seconds: 0
      milliseconds: 0
  - repeat:
      sequence:
      - service: script.1714666287611
        data: {}
      - delay:
          hours: 0
          minutes: 4
          seconds: 0
          milliseconds: 0
      until:
      - condition: state
        entity_id: binary_sensor.group_kitchen_motion_occupancy
        state: 'on'
    enabled: false
  mode: single
- id: '1714058675432'
  alias: Alert when Washer finishes
  description: ''
  trigger:
  - platform: numeric_state
    entity_id:
    - sensor.zooz_kitchen_washer_electric_consumption_w
    above: 100
  condition:
  - condition: state
    entity_id: binary_sensor.maxi_sleeping
    state: 'off'
  - condition: state
    entity_id: binary_sensor.all_present_sleeping
    state: 'off'
  action:
  - wait_for_trigger:
    - platform: numeric_state
      entity_id:
      - sensor.zooz_washer_plug_electric_consumption_a
      for:
        hours: 0
        minutes: 1
        seconds: 0
      below: 1
  - service: script.broadcast_alert_in_the_house
    metadata: {}
    data:
      message: Washer finished
  mode: single
- id: '1714077180427'
  alias: Change light to random colors on press
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.random_colors
    to: 'on'
  condition: []
  action:
  - variables:
      lights: "{% set ns = namespace(lights=[]) %} {% set groups = integration_entities('group')|
        \ select('search', '^light.')   | list %} {% for group in groups %}\n    {%
        set individual_lights = state_attr(group,'entity_id')%}\n    {% for individual_light
        in individual_lights %}\n    {% if \"group\" not in individual_light and state_attr(individual_light,
        'rgb_color') %}\n      {% set ns.lights = ns.lights  + [individual_light]
        %}\n    {% endif %}\n    {% endfor %}    \n{% endfor %} {{  ns.lights  }}\n"
  - repeat:
      sequence:
      - service: script.change_received_lights_to_random_colors
        data:
          lights:
          - '{{lights[repeat.index - 1]}}'
          saturation: 100
      for_each: '{{ lights }}'
  mode: single
- id: '1714077215807'
  alias: Change light to random pastel colors on press
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.random_pastel_colors
    to: 'on'
  condition: []
  action:
  - variables:
      lights: "{% set ns = namespace(lights=[]) %} {% set groups = integration_entities('group')|
        \ select('search', '^light.')   | list %} {% for group in groups %}\n    {%
        set individual_lights = state_attr(group,'entity_id')%}\n    {% for individual_light
        in individual_lights %}\n    {% if \"group\" not in individual_light and state_attr(individual_light,
        'rgb_color') %}\n      {% set ns.lights = ns.lights  + [individual_light]
        %}\n    {% endif %}\n    {% endfor %}    \n{% endfor %} {{  ns.lights  }}\n"
  - repeat:
      sequence:
      - service: script.change_received_lights_to_random_colors
        data:
          lights:
          - '{{lights[repeat.index - 1]}}'
          saturation: 60
      for_each: '{{ lights }}'
  mode: single
- id: '1714150045572'
  alias: Mute chromecasts when they start visuals
  description: ''
  trigger:
  - platform: state
    entity_id:
    - media_player.universal_office_chromecast
    - media_player.universal_livingroom_chromecast
    - media_player.universal_hotbox_top_chromecast
    - media_player.universal_hotbox_down_chromecast
    - media_player.universal_patio_chromecast
    to: playing
  condition:
  - alias: Check if the chromecast already muted
    condition: template
    value_template: '{{trigger.to_state.attributes.is_volume_muted == false}}'
  - condition: template
    value_template: "                  {% set ns = namespace( cast_entity = trigger.entity_id,
      template_entity = \"\" ) %}\n                  {% set ns.final_entity = ns.cast_entity
      %}   {# Declare Variables#}                    \n                  {% for media_player
      in states.media_player %}                   \n                    {% if \"plex\"
      in media_player.entity_id and media_player.state != \"unavailable\" %}\n                      {%
      set entity = media_player.entity_id %}\n                      {% set media_title
      = state_attr( entity, 'media_title') %}\n                      {% set media_series_title
      = state_attr( entity, 'media_series_title') %}\n                      {% set
      media_series_episode = state_attr( entity, 'media_espisode') %}\n                      {%
      set media_series_season = state_attr( entity, 'media_season') %}                      \n
      \                       {% if state_attr( ns.final_entity, 'media_title') %}\n
      \                         {% if  state_attr( ns.cast_entity, 'media_title')
      in ( media_title | string )%}\n                          {% set ns.template_entity
      = entity %}\n                          {% endif %}                    \n                        {%
      elif state_attr( ns.final_entity, 'media_series_title') %}\n                          {%
      if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title
      | string )%}\n                          {% set ns.template_entity = entity %}\n
      \                         {% endif %}\n                        {% endif %}                      \n
      \                   {% endif %}                         \n                  {%
      endfor %}                   \n                  {% if ns.template_entity ==
      \"\" %}\n                      {% set ns.template_entity = ns.cast_entity %}\n
      \                 {% endif %}\n                  {% if ns.template_entity !=
      ns.cast_entity %}                  \n                    {{ state_attr(ns.template_entity,
      'media_library_title') == 'Visuals'}}\n                  {% endif %} "
  action:
  - service: media_player.volume_mute
    metadata: {}
    data:
      is_volume_muted: true
    target:
      entity_id: '{{trigger.entity_id}}'
    alias: Mute the chromecast
  mode: restart
- id: '1714151063007'
  alias: Turn off speakers after 15 minutes of pause
  description: ''
  trigger:
  - platform: state
    entity_id:
    - media_player.universal_office_speakers
    - media_player.universal_chillingroom_speakers
    - media_player.universal_hallway_speakers
    - media_player.universal_hotbox_top_speakers
    - media_player.universal_kitchen_speakers
    - media_player.universal_livingroom_speakers
    - media_player.universal_hotbox_down_speakers
    to: idle
    for:
      hours: 0
      minutes: 15
      seconds: 0
  condition: []
  action:
  - service: media_player.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: '{{ trigger.entity_id }}'
  mode: parallel
  max: 25
- id: '1714321256821'
  alias: Mute speakers in the room if maxi uses a microphone
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.maxi_is_talking
    to: 'on'
  condition:
  - condition: state
    entity_id: input_boolean.following_music
    state: 'on'
  action:
  - variables:
      playing_speakers: '{{ [area_id(states(''sensor.maxi_location_v3''))]   | map(''area_entities'')
        | sum(start=[]) |    select(''search'', ''speakers'') | select(''is_state'',''playing'')
        | unique | list }}

        '
  - service: media_player.volume_mute
    metadata: {}
    data:
      is_volume_muted: true
    target:
      entity_id: '{{playing_speakers}}

        '
  - alias: Unmute speaker after the call is done
    wait_for_trigger:
    - platform: state
      entity_id:
      - binary_sensor.maxi_is_talking
      to: 'off'
      for:
        hours: 0
        minutes: 0
        seconds: 0
    continue_on_timeout: false
  - service: media_player.volume_mute
    metadata: {}
    data:
      is_volume_muted: false
    target:
      entity_id: '{{playing_speakers}}

        '
  mode: parallel
  max: 10
- id: '1714403972538'
  alias: Mute speaers when chromecast start playing in the same room
  description: ''
  trigger:
  - platform: state
    entity_id:
    - media_player.universal_office_chromecast
    - media_player.universal_livingroom_chromecast
    - media_player.universal_hotbox_top_chromecast
    - media_player.universal_hotbox_down_chromecast
    - media_player.universal_patio_chromecast
    - media_player.universal_salon_chromecast
    to: playing
  condition:
  - alias: Check that the chromecast is not muted
    condition: template
    value_template: '{{trigger.to_state.attributes.is_volume_muted == false}}'
  - condition: template
    value_template: "{% set ns = namespace( cast_entity = trigger.entity_id, template_entity
      = \"\" ) %}\n{% set ns.final_entity = ns.cast_entity %}   {# Declare Variables#}
      \                   \n{% for media_player in states.media_player %}                   \n
      \ {% if \"plex\" in media_player.entity_id and media_player.state != \"unavailable\"
      %}\n    {% set entity = media_player.entity_id %}\n    {% set media_title =
      state_attr( entity, 'media_title') %}\n    {% set media_series_title = state_attr(
      entity, 'media_series_title') %}\n    {% set media_series_episode = state_attr(
      entity, 'media_espisode') %}\n    {% set media_series_season = state_attr( entity,
      'media_season') %}                      \n      {% if state_attr( ns.final_entity,
      'media_title') %}\n        {% if  state_attr( ns.cast_entity, 'media_title')
      in ( media_title | string )%}\n        {% set ns.template_entity = entity %}\n
      \       {% endif %}                    \n      {% elif state_attr( ns.final_entity,
      'media_series_title') %}\n        {% if  state_attr( ns.cast_entity, 'media_series_title')
      in ( media_series_title | string )%}\n        {% set ns.template_entity = entity
      %}\n        {% endif %}\n      {% endif %}                      \n  {% endif
      %}                         \n{% endfor %}                   \n{% if ns.template_entity
      == \"\" %}\n    {% set ns.template_entity = ns.cast_entity %}\n{% endif %}\n{%
      if ns.template_entity != ns.cast_entity %}                  \n  {{ state_attr(ns.template_entity,
      'media_library_title') != 'Visuals'}}\n{% endif %} \n"
  action:
  - variables:
      playing_speakers: '{{ [area_id(trigger.entity_id)]   | map(''area_entities'')
        | sum(start=[]) |    select(''search'', ''speakers'') | select(''is_state'',''playing'')
        | unique | list }}

        '
  - metadata: {}
    data:
      is_volume_muted: true
    target:
      entity_id: '{{ playing_speakers }}

        '
    action: media_player.volume_mute
  mode: restart
- id: '1714404201504'
  alias: Unmute speakers when TV stops
  description: ''
  trigger:
  - platform: state
    entity_id:
    - media_player.universal_office_chromecast
    - media_player.universal_livingroom_chromecast
    - media_player.universal_hotbox_top_chromecast
    - media_player.universal_hotbox_down_chromecast
    - media_player.universal_patio_chromecast
    to: paused
    from: playing
  - platform: state
    entity_id:
    - media_player.universal_office_chromecast
    - media_player.universal_livingroom_chromecast
    - media_player.universal_hotbox_top_chromecast
    - media_player.universal_hotbox_down_chromecast
    - media_player.universal_patio_chromecast
    to: 'off'
    from: paused
  - platform: state
    entity_id:
    - media_player.universal_office_chromecast
    - media_player.universal_livingroom_chromecast
    - media_player.universal_hotbox_top_chromecast
    - media_player.universal_hotbox_down_chromecast
    - media_player.universal_patio_chromecast
    to: 'off'
    from: playing
  condition:
  - alias: Check that the chromecast is not muted
    condition: template
    value_template: '{{trigger.to_state.attributes.is_volume_muted == false}}'
  - condition: template
    value_template: "                  {% set ns = namespace( cast_entity = trigger.entity_id,
      template_entity = \"\" ) %}\n                  {% set ns.final_entity = ns.cast_entity
      %}   {# Declare Variables#}                    \n                  {% for media_player
      in states.media_player %}                   \n                    {% if \"plex\"
      in media_player.entity_id and media_player.state != \"unavailable\" %}\n                      {%
      set entity = media_player.entity_id %}\n                      {% set media_title
      = state_attr( entity, 'media_title') %}\n                      {% set media_series_title
      = state_attr( entity, 'media_series_title') %}\n                      {% set
      media_series_episode = state_attr( entity, 'media_espisode') %}\n                      {%
      set media_series_season = state_attr( entity, 'media_season') %}                      \n
      \                       {% if state_attr( ns.final_entity, 'media_title') %}\n
      \                         {% if  state_attr( ns.cast_entity, 'media_title')
      in ( media_title | string )%}\n                          {% set ns.template_entity
      = entity %}\n                          {% endif %}                    \n                        {%
      elif state_attr( ns.final_entity, 'media_series_title') %}\n                          {%
      if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title
      | string )%}\n                          {% set ns.template_entity = entity %}\n
      \                         {% endif %}\n                        {% endif %}                      \n
      \                   {% endif %}                         \n                  {%
      endfor %}                   \n                  {% if ns.template_entity ==
      \"\" %}\n                      {% set ns.template_entity = ns.cast_entity %}\n
      \                 {% endif %}\n                  {% if ns.template_entity !=
      ns.cast_entity %}                  \n                    {{ state_attr(ns.template_entity,
      'media_library_title') != 'Visuals'}}\n                  {% endif %} "
  action:
  - variables:
      playing_speakers: '{{ [area_id(trigger.entity_id)]   | map(''area_entities'')
        | sum(start=[]) |    select(''search'', ''speakers'') | select(''is_state'',''playing'')
        | unique | list }}

        '
  - service: media_player.volume_mute
    metadata: {}
    data:
      is_volume_muted: false
    target:
      entity_id: '{{playing_speakers}}'
    alias: Unmute the speakers
  mode: restart
- id: '1714404505080'
  alias: Close covers in the room when chromecasts start movie
  description: ''
  trigger:
  - platform: state
    entity_id:
    - media_player.universal_office_chromecast
    - media_player.universal_livingroom_chromecast
    - media_player.universal_hotbox_top_chromecast
    - media_player.universal_hotbox_down_chromecast
    - media_player.universal_patio_chromecast
    to: playing
  condition:
  - alias: Check that the chromecast is not muted
    condition: template
    value_template: '{{trigger.to_state.attributes.is_volume_muted == false}}'
  - condition: template
    value_template: "                  {% set ns = namespace( cast_entity = trigger.entity_id,
      template_entity = \"\" ) %}\n                  {% set ns.final_entity = ns.cast_entity
      %}   {# Declare Variables#}                    \n                  {% for media_player
      in states.media_player %}                   \n                    {% if \"plex\"
      in media_player.entity_id and media_player.state != \"unavailable\" %}\n                      {%
      set entity = media_player.entity_id %}\n                      {% set media_title
      = state_attr( entity, 'media_title') %}\n                      {% set media_series_title
      = state_attr( entity, 'media_series_title') %}\n                      {% set
      media_series_episode = state_attr( entity, 'media_espisode') %}\n                      {%
      set media_series_season = state_attr( entity, 'media_season') %}                      \n
      \                       {% if state_attr( ns.final_entity, 'media_title') %}\n
      \                         {% if  state_attr( ns.cast_entity, 'media_title')
      in ( media_title | string )%}\n                          {% set ns.template_entity
      = entity %}\n                          {% endif %}                    \n                        {%
      elif state_attr( ns.final_entity, 'media_series_title') %}\n                          {%
      if  state_attr( ns.cast_entity, 'media_series_title') in ( media_series_title
      | string )%}\n                          {% set ns.template_entity = entity %}\n
      \                         {% endif %}\n                        {% endif %}                      \n
      \                   {% endif %}                         \n                  {%
      endfor %}                   \n                  {% if ns.template_entity ==
      \"\" %}\n                      {% set ns.template_entity = ns.cast_entity %}\n
      \                 {% endif %}\n                  {% if ns.template_entity !=
      ns.cast_entity %}                  \n                    {{ state_attr(ns.template_entity,
      'media_library_title') == 'Movies'}}\n                  {% endif %} "
  action:
  - variables:
      covers: '{{ [area_id(trigger.entity_id)]    | map(''area_entities'') | sum(start=[])
        |    select(''search'', ''^cover\.'')  | unique | list }}

        '
  - service: cover.close_cover
    metadata: {}
    data: {}
    target:
      entity_id: '{{ covers }}

        '
  - wait_for_trigger:
    - platform: template
      value_template: '{{ states(trigger.entity_id) == "off" }}'
    timeout:
      hours: 4
      minutes: 0
      seconds: 0
      milliseconds: 0
    continue_on_timeout: false
  - if:
    - condition: state
      entity_id: input_boolean.kink_party
      state: 'off'
    then:
    - service: cover.open_cover
      metadata: {}
      data: {}
      target:
        entity_id: '{{ covers }}

          '
  mode: restart
- id: '1714405984049'
  alias: Reload tablets when frigate changes state
  description: ''
  trigger:
  - platform: state
    entity_id:
    - sensor.frigate_status
    from:
    to:
    for:
      hours: 0
      minutes: 3
      seconds: 0
  condition: []
  action:
  - service: button.press
    metadata: {}
    data: {}
    target:
      entity_id:
      - button.office_tablet_load_start_url
      - button.hallway_tablet_load_start_url
  mode: single
- id: '1714497353040'
  alias: Turn off lights when the house is empty
  description: Turn off lights
  trigger:
  - platform: numeric_state
    entity_id:
    - zone.home
    for:
      hours: 0
      minutes: 5
      seconds: 0
    below: 0.9
  condition: []
  action:
  - service: light.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: light.group_all_inside_lights
  mode: single
- id: '1714666640750'
  alias: Turn off lights when a room is empty
  description: 'This one uses motion groups '
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.group_patio_motion_occupancy
    - binary_sensor.group_closet_motion_occupancy
    - binary_sensor.group_office_motion_occupancy
    - binary_sensor.group_server_motion_occupancy
    - binary_sensor.group_hallway_motion_occupancy
    - binary_sensor.group_kitchen_motion_occupancy
    - binary_sensor.group_bathroom_motion_occupancy
    - binary_sensor.group_entrance_motion_occupancy
    - binary_sensor.group_hotbox_top_motion_occupancy
    - binary_sensor.group_livingroom_motion_occupancy
    - binary_sensor.group_hotbox_down_motion_occupancy
    - binary_sensor.group_workstation_motion_occupancy
    - binary_sensor.group_salon_motion_occupancy
    for:
      hours: 0
      minutes: 6
      seconds: 0
    to: 'off'
  condition:
  - condition: template
    value_template: '{{ states(''sensor.maxi_location_v3'') not in [area_id(trigger.entity_id)]  }}'
  - condition: state
    entity_id: input_boolean.kink_party
    state: 'off'
  - condition: state
    entity_id: input_boolean.party_mode
    state: 'off'
  - condition: state
    entity_id: input_boolean.acid_time
    state: 'off'
  action:
  - variables:
      on_lights: '{{ [area_id(trigger.entity_id)]  | map(''area_entities'') | sum(start=[])
        | select(''match'', ''^light.'') | select(''is_state'',''on'') | unique |
        list }}

        '
  - service: light.turn_off
    metadata: {}
    data:
      transition: 60
    target:
      entity_id: '{{ on_lights }}

        '
  mode: parallel
  max: 10
- id: '1714668230697'
  alias: Turn off lights colors adaptation when an event is ongoing
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.kink_party
    - input_boolean.party_mode
    - input_boolean.acid_time
    to: 'on'
  condition: []
  action:
  - service: switch.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: switch.adaptive_lighting_adapt_color_adaptive_lighting
  mode: single
- id: '1714668294513'
  alias: Turn on color adaptation when events end
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.kink_party
    - input_boolean.party_mode
    - input_boolean.acid_time
    to: 'off'
  condition:
  - condition: state
    state: 'off'
    entity_id: input_boolean.acid_time
  - condition: state
    state: 'off'
    entity_id: input_boolean.party_mode
  - condition: state
    state: 'off'
    entity_id: input_boolean.kink_party
  action:
  - service: switch.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: switch.adaptive_lighting_adapt_color_adaptive_lighting
  mode: single
- id: '1714688757969'
  alias: Turn light on when someone is detected in the front
  description: ''
  trigger:
  - platform: numeric_state
    entity_id:
    - sensor.front_door_camera_person_count
    above: 0
  condition: []
  action:
  - choose:
    - conditions:
      - condition: state
        entity_id: light.front_door_light
        state: 'on'
        alias: If Front door light is already on
      sequence:
      - variables:
          light_rgb_color: '{{ state_attr(''light.front_door_light'',''rgb_color'')}}

            '
          light_brightness: '{{ state_attr(''light.front_door_light'',''brightness'')}}

            '
      - service: light.turn_on
        metadata: {}
        data:
          transition: 0
          color_temp: 263
          brightness: 255
        target:
          entity_id: light.front_door_light
        alias: 'Set the front door light to bright white '
      - alias: Wait until entrance empty (20 minutes timeout)
        wait_for_trigger:
        - platform: numeric_state
          entity_id:
          - sensor.front_door_camera_person_count
          for:
            hours: 0
            minutes: 3
            seconds: 0
          below: 1
        timeout:
          hours: 0
          minutes: 20
          seconds: 0
          milliseconds: 0
      - service: light.turn_on
        metadata: {}
        data:
          brightness: '{{ light_brightness }}

            '
          rgb_color: '{{ light_rgb_color }}

            '
        target:
          entity_id: light.front_door_light
    - conditions:
      - alias: If Front door light is off
        condition: state
        entity_id: light.front_door_light
        state: 'off'
      sequence:
      - service: light.turn_on
        metadata: {}
        data:
          transition: 0
          color_temp: 263
          brightness: 255
        target:
          entity_id: light.front_door_light
        alias: 'Set the front door light to bright white '
      - alias: Wait until entrance empty (20 minutes timeout)
        wait_for_trigger:
        - platform: numeric_state
          entity_id:
          - sensor.front_door_camera_person_count
          for:
            hours: 0
            minutes: 3
            seconds: 0
          below: 1
        timeout:
          hours: 0
          minutes: 20
          seconds: 0
          milliseconds: 0
      - service: light.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: light.front_door_light
      alias: If the front door light is off
  mode: restart
- id: '1715034222361'
  alias: Alert maxi that is phone is ringing
  description: This should act in the room he is if he is alone
  trigger:
  - platform: state
    entity_id:
    - sensor.phone_maxi_phone_state
    to: ringing
  condition: []
  action:
  - variables:
      in_room_speakers: "{% if [area_id(states('sensor.maxi_location_v3'))]   | map('area_entities')
        | sum(start=[]) |    select('search', 'speakers') | select('search','universal')
        | unique | list %} {{ [area_id(states('sensor.maxi_location_v3'))]   | map('area_entities')
        | sum(start=[]) |    select('search', 'speakers') | select('search','universal')
        | unique | list }} {% else %} {{ [area_id(states('sensor.maxi_location_v3'))]
        \  | map('area_entities') | sum(start=[]) |  select('search', 'speaker')  |
        unique | list }} {% endif %} \n"
      attributes: '{{ trigger }}

        '
  - service: tts.speak
    metadata: {}
    data:
      cache: false
      message: Maxi's phone is ringing
      media_player_entity_id: '{{in_room_speakers}}

        '
    target:
      entity_id: tts.piper
    enabled: true
  - wait_template: '{{ trigger.from_state.attributes != "mass" }}'
    continue_on_timeout: true
    timeout: '5'
  - service: media_player.media_pause
    metadata: {}
    data: {}
    target:
      entity_id: '{{in_room_speakers}}

        '
  mode: single
- id: '1715102391801'
  alias: Alert when there is noise on the terasse
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.ffmpeg_noise
    to: 'on'
    for:
      hours: 0
      minutes: 0
      seconds: 0
  condition:
  - condition: state
    entity_id: input_boolean.party_mode
    state: 'on'
  - condition: state
    entity_id: binary_sensor.group_patio_motion_occupancy
    state: 'on'
  action:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.galaxy_watch_4_on_body_sensor
        state: 'on'
      sequence:
      - service: notify.mobile_app_galaxy_watch4_2n0f
        metadata: {}
        data:
          message: Loud noises on the terasse
    - conditions:
      - condition: state
        entity_id: binary_sensor.galaxy_watch_4_on_body_sensor
        state: 'off'
      sequence:
      - service: notify.mobile_app_phone_maxi
        metadata: {}
        data:
          message: Loud noises on the terasse
  mode: single
- id: '1715103309573'
  alias: Control LivingRoomTablet charging
  description: ''
  trigger:
  - platform: state
    entity_id:
    - sensor.livingroom_tablet_battery
  condition: []
  action:
  - choose:
    - conditions:
      - condition: numeric_state
        entity_id: sensor.livingroom_tablet_battery
        above: 90
      sequence:
      - service: switch.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: switch.plug_livingroom_tablet
    - conditions:
      - condition: numeric_state
        entity_id: sensor.livingroom_tablet_battery
        below: 15
      sequence:
      - service: switch.turn_on
        metadata: {}
        data: {}
        target:
          entity_id: switch.plug_livingroom_tablet
  mode: single
- id: '1715664801848'
  alias: Auto close closet tablet screen when someone is sleeping
  description: ''
  trigger:
  - platform: state
    entity_id:
    - switch.samsung_galaxy_tab_e_8_0_screen
    to: 'on'
  condition:
  - condition: state
    entity_id: input_boolean.sleeper_in_closet
    state: 'on'
  action:
  - delay:
      hours: 0
      minutes: 0
      seconds: 20
      milliseconds: 0
  - service: switch.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: switch.samsung_galaxy_tab_e_8_0_screen
  - service: switch.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: switch.samsung_galaxy_tab_e_8_0_screen
  mode: single
- id: '1715696933725'
  alias: Tell maxi about the weather when he awakes
  description: ''
  trigger:
  - platform: state
    entity_id:
    - sensor.is_maxi_asleep
    from:
    to: awake
    for:
      hours: 0
      minutes: 5
      seconds: 0
  condition:
  - condition: state
    entity_id: person.maximiliano
    state: home
  action:
  - service: rest_command.local_ai_generate_image
    metadata: {}
    data:
      prompt: it is {{states('sensor.current_time')}}{% if states('sun.sun') =='below_horizon'
        %} at night{% else %} during the day{%endif%}, View of a residential street
        the Plateau Mont-Royal, {{ states('weather.purgatory') }} weather of {{ now().timestamp()
        | timestamp_custom('%B') }}, humidity   perception is {{ states('sensor.sensor_outside_temperature_humidity')
        }}, thermal perception is {{    states('sensor.sensor_outside_temperature_temperature')
        }},  Rennaissance painting
    response_variable: return
  - service: downloader.download_file
    metadata: {}
    data:
      overwrite: true
      filename: weather_image.jpg
      url: '{{return.content.data[0].url}}'
  - service: notify.mobile_app_phone_maxi
    metadata: {}
    data:
      title: Current Weather
      message: It is '{{ states('weather.purgatory') }}'
      data:
        image: /media/local/weather_image.jpg
  mode: single
- id: '1715717946486'
  alias: Doorbell Main automation
  description: Rings and alerts my phone
  trigger:
  - platform: state
    entity_id:
    - sensor.remote_doorbell_button_action
    to: single
  condition: []
  action:
  - target:
      entity_id: input_boolean.door_rang
    data: {}
    action: input_boolean.turn_on
  - metadata: {}
    data:
      overwrite: true
      url: http://192.168.0.9:5000/api/events/{{ states('sensor.latest_frigate_event_id')}}/clip.mp4?download=true
      filename: doorclip.mp4
    enabled: true
    action: downloader.download_file
  - metadata: {}
    data: {}
    target:
      entity_id: sensor.latest_frigate_event_id
    action: homeassistant.update_entity
  - metadata: {}
    data:
      message: Someone is at the door!
      color: blue
      image: /media/local/doorclip.mp4?{{ range(1, 53199) | random }}
    action: script.broadcast_alert_in_the_house
  - wait_for_trigger:
    - platform: event
      event_type: downloader_download_completed
    continue_on_timeout: true
    timeout:
      hours: 0
      minutes: 0
      seconds: 5
      milliseconds: 0
    enabled: true
  - metadata: {}
    data:
      message: Someone is at the door!
      title: Doorbell Alert
      data:
        image: https://hass.purgatoire.ca/api/frigate/notifications/{{states("sensor.latest_frigate_event_id")}}/snapshot.jpg
        actions:
        - action: unlock_door
          title: Unlock the Door?
        - action: REPLY
          title: Enter Text
    action: notify.mobile_app_phone_maxi
  - wait_for_trigger:
    - platform: event
      event_type: mobile_app_notification_action
      context: {}
      event_data:
        action: unlock_door
    continue_on_timeout: false
    timeout:
      hours: 0
      minutes: 10
      seconds: 0
      milliseconds: 0
  - metadata: {}
    data:
      message: Unlock the door?
      data:
        actions:
        - action: confirm_unlocking
          title: Really Unlock the Door?
        - action: REPLY
          title: Enter Text
      title: Doorbell Alert
    action: notify.mobile_app_phone_maxi
  - wait_for_trigger:
    - platform: event
      event_type: mobile_app_notification_action
      context: {}
      event_data:
        action: confirm_unlocking
    continue_on_timeout: false
    timeout:
      hours: 0
      minutes: 10
      seconds: 0
      milliseconds: 0
  - metadata: {}
    data: {}
    target:
      entity_id: lock.lock_front_door
    action: lock.unlock
  - metadata: {}
    data:
      message: Door unlocked!
      data:
        actions:
        - action: REPLY
          title: Enter Text
      title: Door Alert
    action: notify.mobile_app_phone_maxi
  mode: restart
- id: '1715719948033'
  alias: Reset doorbell stuff on unlock
  description: ''
  trigger:
  - platform: state
    entity_id:
    - lock.lock_front_door
    to: unlocked
  condition: []
  action:
  - service: input_boolean.turn_off
    metadata: {}
    data: {}
    target:
      entity_id:
      - input_boolean.door_rang
      - input_boolean.door_double_rang
      - input_boolean.waiting_someone
  - service: input_text.set_value
    metadata: {}
    data:
      value: Empty
    target:
      entity_id: input_text.front_door_phone_text
  mode: single
- id: '1715788063807'
  alias: Tell maxi when his watch is charged
  description: ''
  trigger:
  - platform: state
    entity_id:
    - sensor.galaxy_watch4_2n0f_battery_level
    to: '100'
  condition:
  - condition: state
    entity_id: sensor.galaxy_watch4_2n0f_battery_state
    state: charging
  action:
  - service: rest_command.local_ai_generate_image
    metadata: {}
    data:
      prompt: A close up of a fully charged and powered up smart watch
    response_variable: return
  - service: downloader.download_file
    metadata: {}
    data:
      overwrite: true
      filename: watch_image.jpg
      url: '{{return.content.data[0].url}}'
  - service: notify.mobile_app_phone_maxi
    metadata: {}
    data:
      title: Watch Alert
      message: Your watch is charged!
      data:
        image: /media/local/watch_image.jpg
  mode: single
- id: '1715791112355'
  alias: Doorbell Show received notification answer on phone
  description: ''
  trigger:
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: REPLY
      title: Doorbell Alert
  condition: []
  action:
  - service: input_text.set_value
    metadata: {}
    data:
      value: '{{trigger.event.data.reply_text}}'
    target:
      entity_id: input_text.front_door_phone_text
  mode: single
- id: '1716328766276'
  alias: Automatically turn off TVs
  description: After 20 minutes
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.group_office_motion_occupancy
    - binary_sensor.group_livingroom_motion_occupancy
    - binary_sensor.group_hotbox_top_motion_occupancy
    - binary_sensor.group_patio_motion_occupancy
    - binary_sensor.group_hotbox_down_motion_occupancy
    to: 'off'
    for:
      hours: 0
      minutes: 20
      seconds: 0
  condition: []
  action:
  - service: google_assistant_sdk.send_text_command
    metadata: {}
    data:
      command: 'Turn off     {{ [area_id(trigger.entity_id)]    | map(''area_entities'')
        | sum(start=[])  |    select(''search'', ''^media_player\.(?!.*?universal.*?).*chromecast'')
        |  map(''state_attr'', ''friendly_name'') | unique | list | first }}

        '
  mode: parallel
  max: 7
- id: '1716329212232'
  alias: Notify on potential package
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.front_door_camera_person_occupancy
    to: 'on'
    for:
      hours: 0
      minutes: 0
      seconds: 3
  condition:
  - condition: state
    entity_id: input_boolean.waiting_pakidge
    state: 'on'
  action:
  - action: script.ptz_to_package
    metadata: {}
    data: {}
  - delay:
      hours: 0
      minutes: 0
      seconds: 3
      milliseconds: 0
  - metadata: {}
    data:
      filename: www/pakidge_snapshot.png
    target:
      entity_id: camera.front_door_camera
    action: camera.snapshot
  - action: rest_command.local_ai_describe_image
    data:
      prompt: Answer with 'yes' or 'no', is there a package or a delivery man on this
        picture?
      url: http://192.168.0.15:8123/local/pakidge_snapshot.png
    response_variable: answer
  - if:
    - condition: template
      value_template: '{{ "yes" in answer.content.choices.0.message.content }}'
    then:
    - metadata: {}
      data:
        data:
          image: /local/pakidge_snapshot.png
        message: Package is being delivered
        title: Package Detected
      action: notify.mobile_app_phone_maxi
  mode: single
- id: '1716329707766'
  alias: Start music on ACid mode on
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.acid_time
    to: 'on'
  condition:
  - condition: not
    conditions:
    - condition: state
      entity_id: media_player.mass_home_group
      state: playing
  action:
  - metadata: {}
    data:
      media_id: Psychedelic Music
      media_type: playlist
      enqueue: replace_next
    action: mass.play_media
    target:
      entity_id: media_player.group_mass_home_airplay_speakers
  mode: single
- id: '1716329767682'
  alias: Close all blinds on acid mode
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.acid_time
    to: 'on'
  condition:
  - condition: state
    entity_id: sun.sun
    state: above_horizon
  action:
  - service: cover.close_cover
    metadata: {}
    data: {}
    target:
      entity_id: cover.group_all_blinds
  mode: single
- id: '1716329795738'
  alias: Close all blinds on kink party
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.kink_party
    to: 'on'
  condition: []
  action:
  - service: cover.close_cover
    metadata: {}
    data: {}
    target:
      entity_id: cover.group_all_blinds
  mode: single
- id: '1716330395041'
  alias: Change alll Lights to warm colors on Kink Party
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.kink_party
    to: 'on'
  condition: []
  action:
  - service: script.changes_all_on_lights_to_warm_colors
    metadata: {}
    data: {}
  mode: single
- id: '1716416273330'
  alias: Display room color  on TVs when mimiclights mode is triggered
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.mimic_lights_on_screens
    from: 'off'
    to: 'on'
  condition: []
  action:
  - service: cast.show_lovelace_view
    metadata: {}
    data:
      entity_id: media_player.office_chromecast
      dashboard_path: color-hubs
      view_path: office
  mode: single
- id: '1716559893302'
  alias: Set speakers volume on initial playback v2
  description: Control each home_group speaker  individually instead of a per room
    basis
  trigger:
  - platform: state
    entity_id:
    - media_player.universal_bathroom_speakers
    - media_player.universal_bedroom_speakers
    - media_player.universal_salon_speakers
    - media_player.universal_closet_speaker
    - media_player.universal_hallway_speakers
    - media_player.universal_kitchen_speakers
    - media_player.universal_office_speakers
    - media_player.universal_livingroom_speakers
    to: playing
    from: idle
  condition:
  - condition: template
    value_template: '{{ now() - trigger.from_state.last_changed > timedelta(seconds=10)
      }}'
    enabled: false
  action:
  - choose:
    - conditions:
      - alias: Is there no sleeper in the room?
        condition: template
        value_template: '{{ area_id(trigger.entity_id) | lower not in states(''sensor.active_sleeper_rooms'')
          | string | lower }}

          '
      sequence:
      - choose:
        - conditions:
          - condition: state
            entity_id: input_boolean.following_music
            state: 'off'
          sequence:
          - alias: Choose volume  depending on fosi state
            choose:
            - conditions:
              - condition: state
                entity_id: switch.group_fosi_receivers
                state: 'off'
              sequence:
              - choose:
                - conditions:
                  - alias: Not a wiim
                    condition: template
                    value_template: '{{ "wiim" not in trigger.entity_id}}'
                  sequence:
                  - metadata: {}
                    data:
                      volume_level: 0.65
                    target:
                      entity_id: '{{trigger.entity_id}}'
                    enabled: true
                    action: media_player.volume_set
                  alias: Not a wiim speaker
                - conditions:
                  - condition: template
                    value_template: '{{ "wiim" in trigger.entity_id}}'
                  sequence:
                  - metadata: {}
                    data:
                      volume_level: 0.4
                    target:
                      entity_id: '{{trigger.entity_id}}'
                    enabled: true
                    action: media_player.volume_set
                  alias: wiim speaker
                alias: Set volume depending on speaker type
            - conditions:
              - condition: state
                entity_id: switch.group_fosi_receivers
                state: 'on'
              sequence:
              - metadata: {}
                data:
                  volume_level: 0.35
                target:
                  entity_id: '{{trigger.entity_id}}'
                enabled: true
                action: media_player.volume_set
          alias: If following music is off
        - conditions:
          - condition: state
            entity_id: input_boolean.following_music
            state: 'on'
          sequence:
          - alias: Mute or unmute depending on occupancy
            choose:
            - conditions:
              - condition: template
                value_template: '{{ area_id(trigger.entity_id) | lower in states(''sensor.active_motion_rooms'')
                  | string | lower }}

                  '
                alias: Room occupied
              sequence:
              - alias: Choose volume  depending on fosi state
                choose:
                - conditions:
                  - condition: state
                    entity_id: switch.group_fosi_receivers
                    state: 'off'
                  sequence:
                  - choose:
                    - conditions:
                      - alias: Not a wiim
                        condition: template
                        value_template: '{{ "wiim" not in trigger.entity_id}}'
                      sequence:
                      - metadata: {}
                        data:
                          volume_level: 0.65
                        target:
                          entity_id: '{{trigger.entity_id}}'
                        enabled: true
                        action: media_player.volume_set
                      alias: Not a wiim speaker
                    - conditions:
                      - condition: template
                        value_template: '{{ "wiim" in trigger.entity_id}}'
                      sequence:
                      - metadata: {}
                        data:
                          volume_level: 0.4
                        target:
                          entity_id: '{{trigger.entity_id}}'
                        enabled: true
                        action: media_player.volume_set
                      alias: wiim speaker
                    alias: Set volume depending on speaker type
                - conditions:
                  - condition: state
                    entity_id: switch.group_fosi_receivers
                    state: 'on'
                  sequence:
                  - metadata: {}
                    data:
                      volume_level: 0.35
                    target:
                      entity_id: '{{trigger.entity_id}}'
                    enabled: true
                    action: media_player.volume_set
              - metadata: {}
                data:
                  is_volume_muted: false
                target:
                  entity_id: '{{trigger.entity_id}}'
                alias: Unmute speaker
                action: media_player.volume_mute
              alias: Set volume if the room is occupied
            - conditions:
              - alias: Is the speaker room occupied?
                condition: template
                value_template: '{{ area_id(trigger.entity_id) | lower not in states(''sensor.active_motion_rooms'')
                  | string | lower }}

                  '
              sequence:
              - data:
                  is_volume_muted: true
                target:
                  entity_id: '{{trigger.entity_id}}'
                action: media_player.volume_mute
              alias: Set mute if the room is unoccupied
          alias: If following music is on
      alias: No sleeper in the room
    - conditions:
      - condition: template
        value_template: '{{ area_id(trigger.entity_id) | lower in states(''sensor.active_sleeper_rooms'')
          | string | lower }}

          '
      sequence:
      - data:
          is_volume_muted: true
        target:
          entity_id: '{{trigger.entity_id}}'
        action: media_player.volume_mute
      alias: Sleeper present in the room
  trace:
    stored_traces: 30
  mode: parallel
  max: 25
- id: '1716566146304'
  alias: Assist play next song
  description: ''
  trigger:
  - platform: conversation
    command:
    - '[Play] [the] next song'
    - Skip [this/the] song
  condition: []
  action:
  - metadata: {}
    data: {}
    target:
      entity_id:
      - media_player.group_mass_home_airplay_speakers
    action: media_player.media_next_track
  mode: single
- id: '1716912930623'
  alias: Turn camera to doorway on doorbell action
  description: ''
  trigger:
  - platform: state
    entity_id:
    - sensor.remote_doorbell_button_action
    from:
    to:
  condition: []
  action:
  - service: script.ptz_to_doorway
    metadata: {}
    data: {}
  mode: single
- id: '1716933958613'
  alias: Automatically turn off the front security horn after 2 minutes and ask if
    it should restart
  description: ''
  trigger:
  - platform: state
    entity_id:
    - switch.plug_front_door_horn
    to: 'on'
    for:
      hours: 0
      minutes: 2
      seconds: 0
  condition: []
  action:
  - service: switch.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: switch.plug_front_door_horn
  - service: camera.snapshot
    metadata: {}
    data:
      filename: /media/horn_check.png
    target:
      entity_id: camera.front_door_camera
  - service: notify.mobile_app_phone_maxi
    metadata: {}
    data:
      message: Horn stopped
      data:
        image: /media/local/horn_check.png
        actions:
        - action: restart_horn
          title: Restart the horn?
      title: Security breach
  - wait_for_trigger:
    - platform: event
      event_type: mobile_app_notification_action
      context: {}
      event_data:
        action: restart_horn
    continue_on_timeout: false
    timeout:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
  - service: switch.turn_on
    target:
      entity_id:
      - switch.plug_front_door_horn
    data: {}
  mode: restart
- id: '1716934404427'
  alias: Alert when someone is in the front
  description: ''
  trigger:
  - platform: numeric_state
    entity_id:
    - sensor.front_door_camera_person_count
    above: 0
  condition:
  - condition: not
    conditions:
    - condition: state
      entity_id: alarm_control_panel.home_alarm
      state: disarmed
    enabled: false
  action:
  - alias: Take snapshot for LocalAI
    service: camera.snapshot
    metadata: {}
    data:
      filename: www/frontdoor_movement.png
    target:
      entity_id:
      - camera.front_door_camera
    enabled: true
  - service: camera.snapshot
    metadata: {}
    data:
      filename: /media/frontdoor_movement.png
    target:
      entity_id:
      - camera.front_door_camera
  - service: notify.mobile_app_phone_maxi
    metadata: {}
    data:
      message: Movement in the front!
      title: Someone is in the front!
      data:
        image: /media/local/frontdoor_movement.png
        actions:
        - action: blow_front_horn
          title: Blow the horn for 2 minutes?
        - action: REPLY
          title: Enter Text
  - service: rest_command.local_ai_describe_image
    metadata: {}
    data:
      url: http://192.168.0.15:8123/local/frontdoor_movement.png
      prompt: Describe this person only using adjectives, with no preamble, format
        it as bulletpoints
    response_variable: return
    enabled: false
  - service: notify.mobile_app_phone_maxi
    metadata: {}
    data:
      message: '{{return.content.choices.0.message.content}}'
      title: This is who is in the front
    enabled: false
  mode: restart
- id: '1716935540936'
  alias: Alert when the horn goes off and offer to turn it off
  description: ''
  trigger:
  - platform: state
    entity_id:
    - switch.plug_front_door_horn
    to: 'on'
    for:
      hours: 0
      minutes: 0
      seconds: 0
  condition: []
  action:
  - service: camera.snapshot
    metadata: {}
    data:
      filename: /media/horn_check.png
    target:
      entity_id: camera.front_door_camera
  - service: notify.mobile_app_phone_maxi
    metadata: {}
    data:
      message: Horn started
      data:
        image: /media/local/horn_check.png
        actions:
        - action: stop_horn
          title: Stop the horn?
      title: Security breach
  - wait_for_trigger:
    - platform: event
      event_type: mobile_app_notification_action
      context: {}
      event_data:
        action: stop_horn
    continue_on_timeout: false
    timeout:
      hours: 0
      minutes: 3
      seconds: 0
      milliseconds: 0
  - service: switch.turn_off
    target:
      entity_id: switch.plug_front_door_horn
    data: {}
  mode: restart
- id: '1717016815299'
  alias: Alert when someone is in the back
  description: ''
  trigger:
  - platform: numeric_state
    entity_id:
    - sensor.back_door_camera_person_count
    above: 0
  condition:
  - condition: not
    conditions:
    - condition: state
      entity_id: alarm_control_panel.home_alarm
      state: disarmed
    enabled: false
  action:
  - service: camera.snapshot
    metadata: {}
    data:
      filename: /media/backdoor_movement.png
    target:
      entity_id: camera.back_door_camera
  - service: notify.mobile_app_phone_maxi
    metadata: {}
    data:
      message: Someone is in the back!
      title: Someone is in the back!
      data:
        image: /media/local/backdoor_movement.png
        actions:
        - action: blow_horn_back
          title: Blow the horn for 2 minutes?
  - wait_for_trigger:
    - platform: event
      event_type: mobile_app_notification_action
      context: {}
      event_data:
        action: blow_horn_back
    continue_on_timeout: false
    timeout:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
  - service: switch.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: switch.plug_back_door_horn
  mode: restart
- id: '1717016954049'
  alias: Automatically turn off the back security horn after 2 minutes and ask if
    it should restart
  description: ''
  trigger:
  - platform: state
    entity_id:
    - switch.plug_back_door_horn
    to: 'on'
    for:
      hours: 0
      minutes: 2
      seconds: 0
  condition: []
  action:
  - service: switch.turn_off
    metadata: {}
    data: {}
    target:
      entity_id:
      - switch.plug_back_door_horn
  - service: camera.snapshot
    metadata: {}
    data:
      filename: /media/back_horn_check.png
    target:
      entity_id:
      - camera.back_door_camera
  - service: notify.mobile_app_phone_maxi
    metadata: {}
    data:
      message: Horn stopped
      data:
        image: /media/local/back_horn_check.png
        actions:
        - action: restart_back_horn
          title: Restart the horn?
      title: Security breach
  - wait_for_trigger:
    - platform: event
      event_type: mobile_app_notification_action
      context: {}
      event_data:
        action: restart_back_horn
    continue_on_timeout: false
    timeout:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
  - service: switch.turn_on
    data: {}
    target:
      entity_id: switch.plug_back_door_horn
  mode: restart
- id: '1717038269264'
  alias: Alert maxi is someone comes in while he is sleeping
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.sensor_patio_door_contact
    to: 'on'
  - platform: state
    entity_id:
    - binary_sensor.sensor_back_outside_door_contact
    to: 'on'
  - platform: state
    entity_id:
    - binary_sensor.sensor_front_door_contact
    to: 'on'
  - platform: state
    entity_id:
    - binary_sensor.sensor_front_outside_door_contact
    to: 'on'
  - platform: state
    entity_id:
    - binary_sensor.sensor_server_door_contact
    to: 'on'
  condition:
  - condition: state
    entity_id: alarm_control_panel.home_alarm
    state: armed_night
  - condition: state
    entity_id: binary_sensor.maxi_alone
    state: 'on'
  action:
  - metadata: {}
    data:
      stop_actions: true
    target:
      entity_id: automation.mute_and_unmute_speakers_in_unused_rooms
    action: automation.turn_off
  - metadata: {}
    data: {}
    target:
      entity_id: light.group_all_lights
    action: light.turn_off
  - metadata: {}
    data:
      message: Someone is inside!
      title: A door has been opened {{trigger.entity_id}}
      data:
        image: https://hass.purgatoire.ca/api/frigate/notifications/{{states("sensor.latest_frigate_event_id")}}/snapshot.jpg
        actions:
        - action: trigger_inside_alert
          title: Blare inside alert?
    action: notify.mobile_app_phone_maxi
  - metadata: {}
    data:
      rgb_color:
      - 157
      - 230
      - 156
      brightness_pct: 100
    target:
      entity_id: light.bedroom_chandelier_light
    action: light.turn_on
  - data:
      entity_id: ' {{ [states(''sensor.where_is_maxi_sleeping'') | capitalize ]  |
        map(''area_entities'') | sum(start=[]) | select(''match'', ''^media_player.universal.*speaker[s]'')
        | unique | list }}'
      message: Someone has entered, a door has been opened
    action: tts.google_translate_say
  - metadata: {}
    data:
      is_volume_muted: false
    target:
      entity_id: ' {{ [states(''sensor.where_is_maxi_sleeping'') | capitalize ]  |
        map(''area_entities'') | sum(start=[]) | select(''match'', ''^media_player.universal.*speaker[s]'')
        | unique | list }}'
    action: media_player.volume_mute
  - data:
      entity_id: ' {{ [states(''sensor.where_is_maxi_sleeping'') | capitalize ]  |
        map(''area_entities'') | sum(start=[]) | select(''match'', ''^media_player.universal.*speaker[s]'')
        | unique | list }}'
      message: Someone has entered, a door has been opened
    action: tts.google_translate_say
  - data:
      entity_id: media_player.bedroom_speaker
      message: Someone has entered, a door has been opened
    action: tts.google_translate_say
  - metadata: {}
    data:
      is_volume_muted: false
    target:
      entity_id: media_player.bedroom_speaker
    action: media_player.volume_mute
  - data:
      entity_id: media_player.bedroom_speaker
      message: Someone has entered, a door has been opened
    action: tts.google_translate_say
  mode: single
- id: '1717038729859'
  alias: Set front door screen text
  description: ''
  trigger:
  - platform: event
    event_type: mobile_app_notification_action
    event_data:
      action: REPLY
  condition: []
  action:
  - service: input_text.set_value
    metadata: {}
    data:
      value: '{{trigger.event.data.reply_text}}'
    target:
      entity_id: input_text.front_door_phone_text
  - delay:
      hours: 0
      minutes: 5
      seconds: 0
      milliseconds: 0
  - service: input_text.set_value
    metadata: {}
    data:
      value: Empty
    target:
      entity_id: input_text.front_door_phone_text
  mode: single
- id: '1717284487763'
  alias: Arm night alarm when everyone is sleeping
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.all_present_sleeping
    to: 'on'
    for:
      hours: 0
      minutes: 5
      seconds: 0
  condition: []
  action:
  - service: alarm_control_panel.alarm_arm_night
    metadata: {}
    data: {}
    target:
      entity_id: alarm_control_panel.home_alarm
  mode: single
- id: '1717284510591'
  alias: Disarm alarm night when someone awakes
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.all_present_sleeping
    to: 'off'
    for:
      hours: 0
      minutes: 0
      seconds: 0
  condition: []
  action:
  - service: alarm_control_panel.alarm_disarm
    target:
      entity_id: alarm_control_panel.home_alarm
    data: {}
  mode: single
- id: '1717284957489'
  alias: Turn on sleeper in bedroom boolean when sensor turns to on
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.sleeper_in_bedroom
    to: 'on'
    from: 'off'
  condition: []
  action:
  - service: input_boolean.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: input_boolean.sleeper_in_bedroom
  mode: single
- id: '1717285030468'
  alias: Turn off sleeper in bedroom when lights turns on
  description: ''
  trigger:
  - platform: state
    entity_id:
    - light.bedroom_chandelier_light
    to: 'on'
    for:
      hours: 0
      minutes: 0
      seconds: 0
  condition: []
  action:
  - service: input_boolean.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: input_boolean.sleeper_in_bedroom
  mode: single
- id: '1717285150530'
  alias: Start rain sounds where maxi is sleeping
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.maxi_sleeping
    to: 'on'
  condition:
  - condition: state
    entity_id: person.maximiliano
    state: home
  - condition: not
    conditions:
    - condition: state
      entity_id: sensor.where_is_maxi_sleeping
      state: closet
  action:
  - service: media_player.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: '{{ [states(''sensor.where_is_maxi_sleeping'') ]  | map(''area_entities'')
        | sum(start=[]) | select(''match'', ''^media_player.universal.*speaker[s]?$'')
        | select(''is_state'',''off'') | unique | list }}'
    enabled: true
  - service: media_player.play_media
    metadata: {}
    data:
      media_content_id: http://192.168.0.15:8123/local/thunderstorm.mp4
      media_content_type: music
      announce: true
    target:
      entity_id: "{{ [states('sensor.where_is_maxi_sleeping') ]  | map('area_entities')
        |\n sum(start=[]) | select('match', '^media_player.universal.*speaker[s]?$')
        |\n select('is_state','idle') | unique | list }}"
  - service: media_player.volume_mute
    metadata: {}
    data:
      is_volume_muted: false
    target:
      entity_id: '{{ [states(''sensor.where_is_maxi_sleeping'') ]  | map(''area_entities'')
        | sum(start=[]) | select(''match'', ''^media_player.universal.*speaker[s]?$'')
        | select(''is_state'',''playing'') | unique | list }}'
  mode: single
- id: '1717287475672'
  alias: Raise volume when the AC starts in a room
  description: ''
  trigger:
  - platform: state
    entity_id:
    - switch.zooz_office_ac
    - switch.zooz_hotbox_ac
    - switch.zooz_livingroom_ac
    - switch.zooz_bedroom_plug
    to: 'on'
    from: 'off'
  condition: []
  action:
  - service: media_player.volume_up
    metadata: {}
    data: {}
    target:
      entity_id: '{{ area_entities(area_id(trigger.entity_id))|select(''search'',
        ''media_player.universal'')|select(''is_state_attr'', ''is_volume_muted'',
        false)|select(''is_state'', ''playing'')| list }}'
  mode: single
- id: '1717290684944'
  alias: Turn down volume when AC goes off
  description: ''
  trigger:
  - platform: state
    entity_id:
    - switch.zooz_office_ac
    - switch.zooz_hotbox_ac
    - switch.zooz_livingroom_ac
    - switch.zooz_bedroom_plug
    to: 'off'
    from: 'on'
  condition: []
  action:
  - service: media_player.volume_down
    metadata: {}
    data: {}
    target:
      entity_id: '{{ area_entities(area_id(trigger.entity_id))|select(''search'',
        ''media_player.universal'')|select(''is_state_attr'', ''is_volume_muted'',
        false)|select(''is_state'', ''playing'')| list }}'
  mode: single
- id: '1717291435116'
  alias: Reload tablet page when motion is detected in the kitchen
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.group_kitchen_motion_occupancy
    to: 'off'
  condition: []
  action:
  - service: button.press
    metadata: {}
    data: {}
    target:
      entity_id: button.kitchen_tablet_load_start_url
  mode: single
- id: '1717354512446'
  alias: Alert when there is motion inside during arm away
  description: ''
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.group_office_motion_occupancy
    - binary_sensor.group_hallway_motion_occupancy
    - binary_sensor.group_kitchen_motion_occupancy
    - binary_sensor.group_livingroom_motion_occupancy
    - binary_sensor.group_chillingroom_motion_occupancy
    - binary_sensor.group_server_motion_occupancy
    - binary_sensor.group_bathroom_motion_occupancy
    - binary_sensor.group_bedroom_motion_occupancy
    - binary_sensor.group_entrance_motion_occupancy
    for:
      hours: 0
      minutes: 0
      seconds: 0
    from: 'off'
    to: 'on'
  condition:
  - condition: or
    conditions:
    - condition: state
      entity_id: alarm_control_panel.home_alarm
      state: armed_away
    - condition: state
      entity_id: alarm_control_panel.home_alarm
      state: triggered
  action:
  - service: automation.turn_off
    metadata: {}
    data:
      stop_actions: true
    target:
      entity_id: automation.mute_and_unmute_speakers_in_unused_rooms
  - service: light.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: light.group_all_lights
  - service: notify.mobile_app_phone_maxi
    metadata: {}
    data:
      title: Intruder Alert
      message: motion detected in the '{{ area_id(trigger.entity_id) }}'
      data:
        image: https://hass.purgatoire.ca/api/frigate/notifications/{{states("sensor.latest_frigate_event_id")}}/snapshot.jpg
        actions:
        - action: trigger_inside_alert
          title: Blare inside alert?
  - if:
    - condition: not
      conditions:
      - condition: state
        entity_id: alarm_control_panel.home_alarm
        state: triggered
    then:
    - service: alarm_control_panel.alarm_trigger
      metadata: {}
      data: {}
      target:
        entity_id: alarm_control_panel.home_alarm
  mode: single
- id: '1717355119853'
  alias: Turn on light automation once alarm is disarmed
  description: ''
  trigger:
  - platform: state
    entity_id:
    - alarm_control_panel.home_alarm
    from: triggered
    to: disarmed
  condition: []
  action:
  - service: automation.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: automation.mute_and_unmute_speakers_in_unused_rooms
  mode: single
- id: '1717355583664'
  alias: Trigger front horn through phone notification
  description: ''
  trigger:
  - platform: event
    event_type: mobile_app_notification_action
    context: {}
    event_data:
      action: blow_front_horn
  condition: []
  action:
  - service: switch.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: switch.plug_front_door_horn
  mode: single
- id: '1717356233481'
  alias: Stop speakers on disarm
  description: ''
  trigger:
  - platform: state
    entity_id:
    - alarm_control_panel.home_alarm
    from: triggered
    to: disarmed
  condition: []
  action:
  - service: media_player.media_stop
    metadata: {}
    data: {}
    target:
      entity_id: media_player.mass_home_group
  mode: single
- id: '1717358289455'
  alias: Trigger in-home defense script after the alarm is triggered for 6 continious
    minutes
  description: ''
  trigger:
  - platform: state
    entity_id:
    - alarm_control_panel.home_alarm
    to: triggered
    for:
      hours: 0
      minutes: 6
      seconds: 0
  condition: []
  action:
  - service: script.in_home_defense_script
    metadata: {}
    data: {}
  mode: single
- id: '1717358415139'
  alias: Trigger police announcement on triggered alarm
  description: ''
  trigger:
  - platform: state
    entity_id:
    - alarm_control_panel.home_alarm
    to: triggered
    for:
      hours: 0
      minutes: 0
      seconds: 0
  condition: []
  action:
  - service: notify.mobile_app_phone_maxi
    metadata: {}
    data:
      title: Intruder Alert
      message: The alarm has been triggered, engaging de-escalation
      data:
        image: https://hass.purgatoire.ca/api/frigate/notifications/{{states("sensor.latest_frigate_event_id")}}/snapshot.jpg
        actions:
        - action: trigger_inside_alert
          title: Blare inside alert?
  - service: automation.turn_off
    data:
      stop_actions: true
    target:
      entity_id: automation.mute_and_unmute_speakers_in_unused_rooms
  - service: light.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: light.group_all_inside_lights
  - service: switch.turn_on
    target:
      entity_id:
      - switch.group_fosi_receivers
    data: {}
  - service: automation.turn_off
    data:
      stop_actions: true
    target:
      entity_id: automation.set_speakers_volume_on_initial_playback_v2
  - service: media_player.turn_on
    metadata: {}
    data: {}
    target:
      entity_id:
      - media_player.universal_chillingroom_speakers
      - media_player.universal_hallway_speakers
      - media_player.universal_kitchen_speakers
      - media_player.universal_hotbox_down_speakers
      - media_player.universal_hotbox_top_speakers
      - media_player.universal_office_speakers
      - media_player.universal_livingroom_speakers
  - service: media_player.volume_mute
    metadata: {}
    data:
      is_volume_muted: false
    target:
      entity_id:
      - media_player.universal_chillingroom_speakers
      - media_player.universal_hallway_speakers
      - media_player.universal_kitchen_speakers
      - media_player.universal_hotbox_down_speakers
      - media_player.universal_hotbox_top_speakers
      - media_player.universal_office_speakers
      - media_player.universal_livingroom_speakers
  - service: media_player.volume_set
    metadata: {}
    data:
      volume_level: 1
    target:
      entity_id:
      - media_player.universal_chillingroom_speakers
      - media_player.universal_hallway_speakers
      - media_player.universal_kitchen_speakers
      - media_player.universal_hotbox_down_speakers
      - media_player.universal_hotbox_top_speakers
      - media_player.universal_office_speakers
      - media_player.universal_livingroom_speakers
      - media_player.universal
  - service: mass.play_announcement
    metadata: {}
    data:
      announce_volume: 100
      url: https://hass.purgatoire.ca/local/deescalation.mp3
    target:
      entity_id: media_player.group_mass_home_airplay_speakers
  - service: media_player.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: media_player.mass_livingroom_airplay_wiim_speaker
  - service: automation.turn_on
    data: {}
    target:
      entity_id: automation.set_speakers_volume_on_initial_playback_v2
  mode: single
- id: '1717359724027'
  alias: Trigger all home defense script through notification
  description: ''
  trigger:
  - platform: event
    event_type: mobile_app_notification_action
    context: {}
    event_data:
      action: trigger_all_alerts
  condition: []
  action:
  - service: script.in_home_defense_script
    data: {}
  mode: single
- id: '1717360188815'
  alias: Lock tablets on triggered alarm
  description: ''
  trigger:
  - platform: state
    entity_id:
    - alarm_control_panel.home_alarm
    to: triggered
  condition: []
  action:
  - service: switch.turn_on
    metadata: {}
    data: {}
    target:
      entity_id:
      - switch.office_tablet_maintenance_mode
      - switch.samsung_galaxy_tab_e_8_0_maintenance_mode
      - switch.hallway_tablet_maintenance_mode
      - switch.kitchen_tablet_maintenance_mode
      - switch.livingroom_tablet_maintenance_mode
  mode: single
- id: '1717360231281'
  alias: Unlock tablets on disarmed alarm
  description: ''
  trigger:
  - platform: state
    entity_id:
    - alarm_control_panel.home_alarm
    to: disarmed
    for:
      hours: 0
      minutes: 0
      seconds: 0
  condition: []
  action:
  - service: switch.turn_off
    target:
      entity_id:
      - switch.office_tablet_maintenance_mode
      - switch.samsung_galaxy_tab_e_8_0_maintenance_mode
      - switch.hallway_tablet_maintenance_mode
      - switch.kitchen_tablet_maintenance_mode
      - switch.livingroom_tablet_maintenance_mode
    data: {}
  mode: single
- id: '1717797397935'
  alias: Trigger In home defense script through phone notification
  description: ''
  trigger:
  - platform: event
    event_type: mobile_app_notification_action
    context: {}
    event_data:
      action: trigger_all_alerts
  condition: []
  action:
  - service: script.in_home_defense_script
    metadata: {}
    data: {}
  mode: single
- id: '1719366131642'
  alias: Open bedroom covers when the person awakes
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.sleeper_in_bedroom
    from: 'on'
    to: 'off'
    for:
      hours: 0
      minutes: 10
      seconds: 0
  condition:
  - condition: state
    entity_id: binary_sensor.sensor_bedroom_door_contact
    state: 'on'
    for:
      hours: 0
      minutes: 5
      seconds: 0
  action:
  - metadata: {}
    data: {}
    target:
      entity_id: cover.cover_bedroom_blinds
    action: cover.open_cover
  mode: single
- id: '1719366196396'
  alias: Close bedroom cover when sleeper turns on
  description: ''
  trigger:
  - platform: state
    entity_id:
    - input_boolean.sleeper_in_bedroom
    from:
    to: 'on'
    for:
      hours: 0
      minutes: 1
      seconds: 0
  condition: []
  action:
  - service: cover.close_cover
    target:
      entity_id:
      - cover.cover_bedroom_blinds
    data: {}
  mode: single
- id: '1719366363339'
  alias: Closer bedroom sleeper faster when maxi is in
  description: ''
  trigger:
  - platform: state
    entity_id:
    - sensor.where_is_maxi_sleeping
    from:
    to: bedroom
    for:
      hours: 0
      minutes: 0
      seconds: 3
  condition:
  - condition: state
    entity_id: input_boolean.sleeper_in_bedroom
    state: 'on'
  action:
  - service: cover.close_cover
    target:
      entity_id:
      - cover.cover_bedroom_blinds
    data: {}
  mode: single
- id: '1719617622275'
  alias: Display Chillingroom Display interface
  description: ''
  trigger:
  - platform: state
    entity_id:
    - media_player.salon_display
    from:
    to: 'off'
  condition: []
  action:
  - metadata: {}
    data: {}
    target:
      entity_id:
      - media_player.salon_display
    action: media_player.turn_off
  - metadata: {}
    data:
      dashboard_path: lovelace-hub
      view_path: salon-hub
      entity_id: media_player.salon_display
    action: cast.show_lovelace_view
  mode: single
- id: '1720489259503'
  alias: Assist Start Media on TV
  description: ''
  trigger:
  - platform: conversation
    command:
    - '[let''s] watch {query} [on the] [in the] {room} [TV]'
    - '[let''s] play {query} [on the] [in the] {room} TV'
  condition: []
  action:
  - service: rest_command.local_ai_describe_media
    metadata: {}
    data:
      prompt: '{{trigger.slots.query}}'
    response_variable: return
  - variables:
      media_type: "{% if \"show\" in return.content.choices.0.message.content or \"Show\"
        in return.content.choices.0.message.content %}\n tvshow\n{% else %}\n  movie\n{%
        endif %}\n"
      library_name: "{% if \"show\" in return.content.choices.0.message.content or
        \"Show\" in return.content.choices.0.message.content %}\n TV Shows\n{% else
        %}\n  Movies\n{% endif %}\n"
      media_content: '{{trigger.slots.query}}'
      target: '{{ [area_id(trigger.slots.room)]    | map(''area_entities'')  | sum(start=[])
        | select(''search'', (''media_player.*chromecast'')) | unique  | list }}

        '
  - service: media_player.play_media
    data:
      media_content_type: '{{media_type}}

        '
      media_content_id: 'plex://{ "library_name": "{{library_name}}", "title": "{{media_content}}","shuffle":
        1 }

        '
    target:
      entity_id: '{{target}}

        '
  mode: parallel
  max: 10
- id: '1721278758149'
  alias: 'Bedroom hue tap remote automation '
  description: ''
  trigger:
  - platform: device
    domain: mqtt
    device_id: 401156183b8cc392cc4838000cc56c3c
    type: action
    subtype: press_1
  condition: []
  action:
  - service: light.toggle
    metadata: {}
    data: {}
    target:
      area_id: bedroom
  mode: single
- id: '1722263369374'
  alias: assist Stop home group music
  description: ''
  trigger:
  - platform: conversation
    command:
    - stop [the] music
  condition: []
  action:
  - service: media_player.media_stop
    metadata: {}
    data: {}
    target:
      entity_id: media_player.group_mass_home_airplay_speakers
  mode: single
- id: '1722712931229'
  alias: Alert maxi when a work timer ends
  description: ''
  trigger:
  - platform: state
    entity_id:
    - timer.work_break
    from: active
    to: idle
    for:
      hours: 0
      minutes: 0
      seconds: 2
  condition: []
  action: []
  mode: single
- id: '1722878184182'
  alias: Assist Control covers
  description: Open or close covers
  trigger:
  - platform: conversation
    command:
    - (close|open) [the] {room} (cover|window|blind|covers|blinds|windows)
  condition: []
  action:
  - variables:
      covers: "{{ [area_id(trigger.slots.room | lower)]  | map('area_entities') |
        sum(start=[]) |\n  select('match', '^cover.') | unique | list }}\n"
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ ''close'' in trigger.sentence | lower }}'
      sequence:
      - service: cover.close_cover
        data: {}
        target:
          entity_id: '{{covers}}'
    - conditions:
      - condition: template
        value_template: '{{ ''open'' in trigger.sentence | lower }}'
      sequence:
      - service: cover.open_cover
        data: {}
        target:
          entity_id: '{{covers}}'
  mode: single
- id: '1722909291790'
  alias: Dial livingroom library control
  description: ''
  use_blueprint:
    path: EPMatt/ikea_e1744.yaml
    input:
      integration: Zigbee2MQTT
      controller_entity: sensor.remote_livingroom_library_dial_action
      action_rotate_left:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - choose:
        - conditions:
          - alias: Test if chromecast or speaker present
            condition: template
            value_template: "{% for media_player in media_players %}\n  {% if 'speaker'
              in media_player | string %}\n    true\n  {% elif 'chromecast' in media_players
              | string %}\n    true\n  {% else %}\n    false\n  {% endif %}\n{% endfor
              %}"
          sequence:
          - target:
              entity_id: '{{media_players}}'
            data_template:
              volume_level: '{{ state_attr((media_players | first),''volume_level'')
                - 0.03}}'
            action: media_player.volume_set
          alias: Speaker playing and unmuted
      helper_last_controller_event: input_text.dial_livingroom_library_helper
      rotate_left_loop: true
      rotate_right_loop: true
      action_rotate_right:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - choose:
        - conditions:
          - alias: Test if chromecast or speaker present
            condition: template
            value_template: "{% for media_player in media_players %}\n  {% if 'speaker'
              in media_player | string %}\n    true\n  {% elif 'chromecast' in media_players
              | string  %}\n    true\n  {% else %}\n    false\n  {% endif %}\n{% endfor
              %}"
          sequence:
          - target:
              entity_id: '{{media_players}}'
            data_template:
              volume_level: '{{ state_attr((media_players | first),''volume_level'')
                + 0.02}}'
            action: media_player.volume_set
          alias: Speaker playing and unmuted
      action_click_short:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.media_play_pause
      action_click_triple:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.turn_off
      rotate_left_max_loop_repeats: 10
      rotate_right_max_loop_repeats: 10
      helper_debounce_delay: 0
      action_click_double:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.media_next_track
- id: '1722919148822'
  alias: Dial salon automation
  description: ''
  use_blueprint:
    path: EPMatt/ikea_e1744.yaml
    input:
      integration: Zigbee2MQTT
      controller_entity: sensor.remote_salon_dial_action
      action_rotate_left:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - choose:
        - conditions:
          - alias: Test if chromecast or speaker present
            condition: template
            value_template: "{% for media_player in media_players %}\n  {% if 'speaker'
              in media_player | string %}\n    true\n  {% elif 'chromecast' in media_players
              %}\n    true\n  {% else %}\n    false\n  {% endif %}\n{% endfor %}"
          sequence:
          - target:
              entity_id: '{{media_players}}'
            data_template:
              volume_level: '{{ state_attr((media_players | first),''volume_level'')
                - 0.03}}'
            action: media_player.volume_set
          alias: Speaker playing and unmuted
      helper_last_controller_event: input_text.dial_salon_helper
      rotate_left_loop: true
      rotate_right_loop: true
      action_rotate_right:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - choose:
        - conditions:
          - alias: Test if chromecast or speaker present
            condition: template
            value_template: "{% for media_player in media_players %}\n  {% if 'speaker'
              in media_player | string %}\n    true\n  {% elif 'chromecast' in media_players
              %}\n    true\n  {% else %}\n    false\n  {% endif %}\n{% endfor %}"
          sequence:
          - target:
              entity_id: '{{media_players}}'
            data_template:
              volume_level: '{{ state_attr((media_players | first),''volume_level'')
                + 0.02}}'
            action: media_player.volume_set
          alias: Speaker playing and unmuted
      action_click_short:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.media_play_pause
      action_click_triple:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.turn_off
      rotate_left_max_loop_repeats: 60
      rotate_right_max_loop_repeats: 60
      helper_debounce_delay: 0
      action_click_double:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.media_next_track
- id: '1722920464413'
  alias: dial hallway automation
  description: ''
  use_blueprint:
    path: EPMatt/ikea_e1744.yaml
    input:
      integration: Zigbee2MQTT
      controller_entity: sensor.remote_hallway_dial_action
      action_rotate_left:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - choose:
        - conditions:
          - alias: Test if chromecast or speaker present
            condition: template
            value_template: "     {{ 'speakers' in media_players | string | lower
              \ or 'chromecast' in media_players |\n          string | lower }}"
          sequence:
          - target:
              entity_id: '{{media_players}}'
            data_template:
              volume_level: '{{ state_attr((media_players | first),''volume_level'')
                - 0.03}}'
            action: media_player.volume_set
          alias: Speaker playing and unmuted
      helper_last_controller_event: input_text.dial_hallway_helper
      rotate_left_loop: true
      rotate_right_loop: true
      action_rotate_right:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - choose:
        - conditions:
          - alias: Test if chromecast or speaker present
            condition: template
            value_template: "     {{ 'speakers' in media_players | string | lower
              \ or 'chromecast' in media_players |\n          string | lower }}"
          sequence:
          - target:
              entity_id: '{{media_players}}'
            data_template:
              volume_level: '{{ state_attr((media_players | first),''volume_level'')
                + 0.02}}'
            action: media_player.volume_set
          alias: Speaker playing and unmuted
      action_click_short:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.media_play_pause
      action_click_triple:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.turn_off
      rotate_left_max_loop_repeats: 60
      rotate_right_max_loop_repeats: 60
      helper_debounce_delay: 0
      action_click_double:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.media_next_track
- id: '1723154539730'
  alias: Dial office control automation
  description: ''
  use_blueprint:
    path: EPMatt/ikea_e1744.yaml
    input:
      integration: Zigbee2MQTT
      controller_entity: sensor.remote_office_dial_action_action
      action_rotate_left:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - choose:
        - conditions:
          - alias: Test if chromecast or speaker present
            condition: template
            value_template: "{% for media_player in media_players %}\n  {% if 'speaker'
              in media_player | string %}\n    true\n  {% elif 'chromecast' in media_players
              %}\n    true\n  {% else %}\n    false\n  {% endif %}\n{% endfor %}"
          sequence:
          - target:
              entity_id: '{{media_players}}'
            data_template:
              volume_level: '{{ state_attr((media_players | first),''volume_level'')
                - 0.03}}'
            action: media_player.volume_set
          alias: Speaker playing and unmuted
      helper_last_controller_event: input_text.dial_office_helper
      rotate_left_loop: true
      rotate_right_loop: true
      action_rotate_right:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - choose:
        - conditions:
          - alias: Test if chromecast or speaker present
            condition: template
            value_template: "{% for media_player in media_players %}\n  {% if 'speaker'
              in media_player | string %}\n    true\n  {% elif 'chromecast' in media_players
              %}\n    true\n  {% else %}\n    false\n  {% endif %}\n{% endfor %}"
          sequence:
          - target:
              entity_id: '{{media_players}}'
            data_template:
              volume_level: '{{ state_attr((media_players | first),''volume_level'')
                + 0.02}}'
            action: media_player.volume_set
          alias: Speaker playing and unmuted
      action_click_short:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.media_play_pause
      action_click_triple:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.turn_off
      rotate_left_max_loop_repeats: 60
      rotate_right_max_loop_repeats: 60
      helper_debounce_delay: 0
      action_click_double:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.media_next_track
- id: '1723157141694'
  alias: Dial library wall control automation
  description: ''
  use_blueprint:
    path: EPMatt/ikea_e1744.yaml
    input:
      integration: Zigbee2MQTT
      controller_entity: sensor.remote_livingroom_wall_dial_action
      action_rotate_left:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - choose:
        - conditions:
          - alias: Test if chromecast or speaker present
            condition: template
            value_template: "{% for media_player in media_players %}\n  {% if 'speaker'
              in media_player | string %}\n    true\n  {% elif 'chromecast' in media_players
              %}\n    true\n  {% else %}\n    false\n  {% endif %}\n{% endfor %}"
          sequence:
          - target:
              entity_id: '{{media_players}}'
            data_template:
              volume_level: '{{ state_attr((media_players | first),''volume_level'')
                - 0.03}}'
            action: media_player.volume_set
          alias: Speaker playing and unmuted
      helper_last_controller_event: input_text.dial_livingroom_helper
      rotate_left_loop: true
      rotate_right_loop: true
      action_rotate_right:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - choose:
        - conditions:
          - alias: Test if chromecast or speaker present
            condition: template
            value_template: "{% for media_player in media_players %}\n  {% if 'speaker'
              in media_player | string %}\n    true\n  {% elif 'chromecast' in media_players
              %}\n    true\n  {% else %}\n    false\n  {% endif %}\n{% endfor %}"
          sequence:
          - target:
              entity_id: '{{media_players}}'
            data_template:
              volume_level: '{{ state_attr((media_players | first),''volume_level'')
                + 0.02}}'
            action: media_player.volume_set
          alias: Speaker playing and unmuted
      action_click_short:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.media_play_pause
      action_click_triple:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.turn_off
      rotate_left_max_loop_repeats: 60
      rotate_right_max_loop_repeats: 60
      helper_debounce_delay: 0
      action_click_double:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.media_next_track
- id: '1723161942387'
  alias: dial kitchen control automation
  description: ''
  use_blueprint:
    path: EPMatt/ikea_e1744.yaml
    input:
      integration: Zigbee2MQTT
      controller_entity: sensor.remote_kitchen_dial_action
      action_rotate_left:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - choose:
        - conditions:
          - alias: Test if chromecast or speaker present
            condition: template
            value_template: "{% for media_player in media_players %}\n  {% if 'speaker'
              in media_player | string %}\n    true\n  {% elif 'chromecast' in media_players
              %}\n    true\n  {% else %}\n    false\n  {% endif %}\n{% endfor %}"
          sequence:
          - target:
              entity_id: '{{media_players}}'
            data_template:
              volume_level: '{{ state_attr((media_players | first),''volume_level'')
                - 0.03}}'
            action: media_player.volume_set
          alias: Speaker playing and unmuted
      helper_last_controller_event: input_text.dial_kitchen_helper
      rotate_left_loop: true
      rotate_right_loop: true
      action_rotate_right:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - choose:
        - conditions:
          - alias: Test if chromecast or speaker present
            condition: template
            value_template: "{% for media_player in media_players %}\n  {% if 'speaker'
              in media_player | string %}\n    true\n  {% elif 'chromecast' in media_players
              %}\n    true\n  {% else %}\n    false\n  {% endif %}\n{% endfor %}"
          sequence:
          - target:
              entity_id: '{{media_players}}'
            data_template:
              volume_level: '{{ state_attr((media_players | first),''volume_level'')
                + 0.02}}'
            action: media_player.volume_set
          alias: Speaker playing and unmuted
      action_click_short:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.media_play_pause
      action_click_triple:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.turn_off
      rotate_left_max_loop_repeats: 60
      rotate_right_max_loop_repeats: 60
      helper_debounce_delay: 0
      action_click_double:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.media_next_track
- id: '1723169196057'
  alias: dial office desk control automation
  description: ''
  use_blueprint:
    path: EPMatt/ikea_e1744.yaml
    input:
      integration: Zigbee2MQTT
      controller_entity: sensor.remote_office_desk_dial_action
      action_rotate_left:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - choose:
        - conditions:
          - alias: Test if chromecast or speaker present
            condition: template
            value_template: "{% for media_player in media_players %}\n  {% if 'speaker'
              in media_player | string %}\n    true\n  {% elif 'chromecast' in media_players
              %}\n    true\n  {% else %}\n    false\n  {% endif %}\n{% endfor %}"
          sequence:
          - target:
              entity_id: '{{media_players}}'
            data_template:
              volume_level: '{{ state_attr((media_players | first),''volume_level'')
                - 0.03}}'
            action: media_player.volume_set
          alias: Speaker playing and unmuted
      helper_last_controller_event: input_text.dial_office_desk_helper
      rotate_left_loop: true
      rotate_right_loop: true
      action_rotate_right:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - choose:
        - conditions:
          - alias: Test if chromecast or speaker present
            condition: template
            value_template: "{% for media_player in media_players %}\n  {% if 'speaker'
              in media_player | string %}\n    true\n  {% elif 'chromecast' in media_players
              %}\n    true\n  {% else %}\n    false\n  {% endif %}\n{% endfor %}"
          sequence:
          - target:
              entity_id: '{{media_players}}'
            data_template:
              volume_level: '{{ state_attr((media_players | first),''volume_level'')
                + 0.02}}'
            action: media_player.volume_set
          alias: Speaker playing and unmuted
      action_click_short:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.media_play_pause
      action_click_triple:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.turn_off
      rotate_left_max_loop_repeats: 60
      rotate_right_max_loop_repeats: 60
      helper_debounce_delay: 0
      action_click_double:
      - variables:
          media_players: '{{ [area_id(trigger.event.data.entity_id)]     | map(''area_entities'')   |
            sum(start=[]) |    select(''search'', ''universal'') |  expand   | selectattr(''attributes.is_volume_muted'',
            ''false'') |map(attribute=''entity_id'') | list}}

            '
        alias: Find unmuted media players
      - metadata: {}
        data: {}
        target:
          entity_id: '{{media_players}}'
        action: media_player.media_next_track
- id: '1723214966525'
  alias: Front door automation on unlock for main codes
  description: ''
  trigger:
  - platform: state
    entity_id:
    - lock.lock_front_door
    attribute: action_user
  condition:
  - alias: Was the door unlocked?
    condition: template
    value_template: '{{ trigger.to_state.attributes.action == ''unlock'' and trigger.to_state.attributes.action_source_name
      == ''keypad'' }}'
  action:
  - variables:
      user_opening: "{% if trigger.to_state.attributes.action_user | string == '1'
        %}\n  Maxi\n{% elif trigger.to_state.attributes.action_user | string == '2'
        %}\n  Myriam\n{% elif trigger.to_state.attributes.action_user | string ==
        '3' %}\n  Carla\n{% elif trigger.to_state.attributes.action_user | string
        == '4' %}\n  Fay\n{% elif trigger.to_state.attributes.action_user | string
        == '6' %}\n  Koopa\n{% else %}\n Unknown\n{% endif %}\n"
  - metadata: {}
    data:
      message: '{{ user_opening }} has arrived

        '
      color: cyan
    action: script.broadcast_alert_in_the_house
  - action: alarm_control_panel.alarm_disarm
    metadata: {}
    data: {}
    target:
      entity_id: alarm_control_panel.home_alarm
  mode: single
- id: '1723530969899'
  alias: 'Turn off Livingroom lights when bedroom Sleeper turns on '
  description: 'Check also that the Livingroom is empty '
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.sleeper_in_bedroom
    to: 'on'
    from: 'off'
  condition:
  - condition: state
    entity_id: binary_sensor.group_livingroom_motion_occupancy
    state: 'off'
  action:
  - action: light.turn_off
    metadata: {}
    data:
      transition: 20
    target:
      area_id: livingroom
      entity_id: light.group_livingroom_lights
  mode: single
- id: '1723823368949'
  alias: Automatic Volume on playback v3
  description: Control each home_group speaker  individually instead of a per room
    basis
  trigger:
  - platform: state
    entity_id:
    - media_player.universal_bathroom_speakers
    - media_player.universal_bedroom_speakers
    - media_player.universal_salon_speakers
    - media_player.universal_closet_speaker
    - media_player.universal_hallway_speakers
    - media_player.universal_kitchen_speakers
    - media_player.universal_office_speakers
    - media_player.universal_livingroom_speakers
    to: playing
    from: idle
  condition: []
  action:
  - choose:
    - conditions:
      - alias: Is there no sleeper in the room?
        condition: template
        value_template: '{{ area_id(trigger.entity_id) | lower not in states(''sensor.active_sleeper_rooms'')
          | string | lower }}

          '
      sequence:
      - choose:
        - conditions:
          - condition: state
            entity_id: input_boolean.following_music
            state: 'off'
          sequence: []
          alias: If following music is off
        - conditions:
          - condition: state
            entity_id: input_boolean.following_music
            state: 'on'
          sequence:
          - alias: Mute or unmute depending on occupancy
            choose:
            - conditions:
              - condition: template
                value_template: '{{ area_id(trigger.entity_id) | lower in states(''sensor.active_motion_rooms'')
                  | string | lower }}

                  '
                alias: Room occupied
              sequence:
              - choose:
                - conditions:
                  - condition: time
                    after: 09:00:00
                    before: '11:30:00'
                    weekday:
                    - fri
                    - thu
                    - wed
                    - tue
                    - mon
                    - sat
                    - sun
                  sequence:
                  - metadata: {}
                    data:
                      volume_level: 0.3
                    target:
                      entity_id: '{{trigger.entity_id}}'
                    enabled: true
                    action: media_player.volume_set
                  - metadata: {}
                    data:
                      is_volume_muted: false
                    target:
                      entity_id: '{{trigger.entity_id}}'
                    alias: Unmute speaker
                    action: media_player.volume_mute
                - conditions:
                  - condition: time
                    after: '11:30:00'
                    before: '21:30:00'
                    weekday:
                    - fri
                    - thu
                    - wed
                    - tue
                    - mon
                    - sun
                    - sat
                  sequence:
                  - metadata: {}
                    data:
                      volume_level: 0.35
                    target:
                      entity_id: '{{trigger.entity_id}}'
                    enabled: true
                    action: media_player.volume_set
                  - metadata: {}
                    data:
                      is_volume_muted: false
                    target:
                      entity_id: '{{trigger.entity_id}}'
                    alias: Unmute speaker
                    action: media_player.volume_mute
                - conditions:
                  - condition: time
                    after: '21:30:00'
                    before: '23:30:00'
                    weekday:
                    - fri
                    - thu
                    - wed
                    - tue
                    - mon
                    - sun
                    - sat
                  sequence:
                  - metadata: {}
                    data:
                      volume_level: 0.4
                    target:
                      entity_id: '{{trigger.entity_id}}'
                    enabled: true
                    action: media_player.volume_set
                  - metadata: {}
                    data:
                      is_volume_muted: false
                    target:
                      entity_id: '{{trigger.entity_id}}'
                    alias: Unmute speaker
                    action: media_player.volume_mute
                - conditions:
                  - condition: time
                    after: '23:30:00'
                    before: 01:00:00
                    weekday:
                    - fri
                    - thu
                    - wed
                    - tue
                    - mon
                    - sun
                    - sat
                  sequence:
                  - metadata: {}
                    data:
                      volume_level: 0.3
                    target:
                      entity_id: '{{trigger.entity_id}}'
                    enabled: true
                    action: media_player.volume_set
                  - metadata: {}
                    data:
                      is_volume_muted: false
                    target:
                      entity_id: '{{trigger.entity_id}}'
                    alias: Unmute speaker
                    action: media_player.volume_mute
                - conditions:
                  - condition: time
                    after: 01:00:00
                    before: 03:00:00
                    weekday:
                    - fri
                    - thu
                    - wed
                    - tue
                    - mon
                    - sun
                    - sat
                  sequence:
                  - metadata: {}
                    data:
                      volume_level: 0.25
                    target:
                      entity_id: '{{trigger.entity_id}}'
                    enabled: true
                    action: media_player.volume_set
                  - metadata: {}
                    data:
                      is_volume_muted: false
                    target:
                      entity_id: '{{trigger.entity_id}}'
                    alias: Unmute speaker
                    action: media_player.volume_mute
                - conditions:
                  - condition: time
                    after: 03:00:00
                    before: 09:00:00
                    weekday:
                    - fri
                    - thu
                    - wed
                    - tue
                    - mon
                    - sun
                    - sat
                  sequence:
                  - metadata: {}
                    data:
                      volume_level: 0.22
                    target:
                      entity_id: '{{trigger.entity_id}}'
                    enabled: true
                    action: media_player.volume_set
                  - metadata: {}
                    data:
                      is_volume_muted: false
                    target:
                      entity_id: '{{trigger.entity_id}}'
                    alias: Unmute speaker
                    action: media_player.volume_mute
                default:
                - metadata: {}
                  data:
                    volume_level: 0.35
                  target:
                    entity_id: '{{trigger.entity_id}}'
                  enabled: true
                  action: media_player.volume_set
                - metadata: {}
                  data:
                    is_volume_muted: false
                  target:
                    entity_id: '{{trigger.entity_id}}'
                  alias: Unmute speaker
                  action: media_player.volume_mute
              alias: Set volume if the room is occupied
            - conditions:
              - alias: Is the speaker room occupied?
                condition: template
                value_template: '{{ area_id(trigger.entity_id) | lower not in states(''sensor.active_motion_rooms'')
                  | string | lower }}

                  '
              sequence:
              - data:
                  is_volume_muted: true
                target:
                  entity_id: '{{trigger.entity_id}}'
                action: media_player.volume_mute
              alias: Set mute if the room is unoccupied
          alias: If following music is on
      alias: No sleeper in the room
    - conditions:
      - condition: template
        value_template: '{{ area_id(trigger.entity_id) | lower in states(''sensor.active_sleeper_rooms'')
          | string | lower }}

          '
      sequence:
      - data:
          is_volume_muted: true
        target:
          entity_id: '{{trigger.entity_id}}'
        action: media_player.volume_mute
      alias: Sleeper present in the room
  mode: parallel
  trace:
    stored_traces: 30
  max: 25
- id: '1724183807347'
  alias: Turn off sleeper in hotbox when koopa leaves
  description: ''
  trigger:
  - platform: state
    entity_id:
    - person.koopa
    to: not_home
    for:
      hours: 0
      minutes: 1
      seconds: 0
  condition: []
  action:
  - action: input_boolean.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: input_boolean.sleeper_in_hotbox
  mode: single
- id: '1727032753670'
  alias: Alert people in the back to go away
  description: Flash the red lights in the back while people are loitering
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.back_door_loitering_person_occupancy
    to: 'on'
    from: 'off'
    for:
      hours: 0
      minutes: 0
      seconds: 3
  condition: []
  action:
  - repeat:
      sequence:
      - sequence:
        - metadata: {}
          data:
            color_name: red
            brightness: 255
          target:
            entity_id: light.back_door_light
          action: light.turn_on
        - delay:
            hours: 0
            minutes: 0
            seconds: 0
            milliseconds: 701
        - metadata: {}
          data: {}
          target:
            entity_id: light.back_door_light
          action: light.turn_off
      until:
      - condition: state
        entity_id: binary_sensor.back_door_camera_person_occupancy
        state: 'off'
        for:
          hours: 0
          minutes: 0
          seconds: 10
  - wait_for_trigger:
    - platform: state
      entity_id:
      - binary_sensor.back_door_camera_person_occupancy
      to: 'off'
      for:
        hours: 0
        minutes: 0
        seconds: 30
    timeout:
      hours: 0
      minutes: 0
      seconds: 0
      milliseconds: 0
  - metadata: {}
    data:
      transition: 30
    target:
      entity_id: light.back_door_light
    action: light.turn_off
  mode: single
- id: '1727112478403'
  alias: Lower sound when assist in progress
  description: ''
  triggers:
  - entity_id:
    - assist_satellite.esp32_s3_box_3_office_assistant_assist_satellite
    - assist_satellite.esp32_s3_box_3_lv_assistant_assist_satellite
    - binary_sensor.esp32_s3_box_kitchen_assistant_assist_in_progress
    - assist_satellite.esp32_s3_box_3_lvw_assistant_assist_satellite
    - assist_satellite.esp32_s3_box_bedroom_assistant_assist_satellite
    - assist_satellite.esp32_s3_box_kitchen_assistant_assist_satellite
    - assist_satellite.esp32_s3_box_3_hallway_assistant_assist_satellite
    from:
    trigger: state
    to: listening
  conditions: []
  actions:
  - variables:
      playing_speakers: '{% set entity_id = [area_id(trigger.entity_id)]   | map(''area_entities'')
        | sum(start=[]) |    select(''search'', ''speakers'') | select(''is_state'',''playing'')
        | unique | list %} {{ [entity_id | first | string] + [state_attr(entity_id
        | first | string, ''volume_level'') | string] }}

        '
      playing_chromecast: '{% set entity_id = [area_id(trigger.entity_id)]   | map(''area_entities'')
        | sum(start=[]) |    select(''search'', ''chromecast'') | select(''is_state'',''playing'')
        | unique | list %} {{[entity_id | first | string] + [state_attr(entity_id
        | first | string, ''volume_level'') | string] }}

        '
  - parallel:
    - alias: chromecasts
      sequence:
      - action: media_player.volume_set
        metadata: {}
        data:
          volume_level: '{{ (playing_chromecasts.1 | float - (playing_chromecasts.1
            | float / 2))| string }}'
        target:
          entity_id: '{{playing_chromecasts.0}}'
        alias: Lower Music
      - wait_template: '{{ states(trigger.entity_id) == "idle" }}'
        continue_on_timeout: true
        timeout: '60'
      - action: media_player.volume_set
        metadata: {}
        data:
          volume_level: '{{playing_chromecasts.1}}'
        target:
          entity_id: '{{playing_chromecasts.0}}'
    - alias: Speakers
      sequence:
      - action: media_player.volume_set
        metadata: {}
        data:
          volume_level: '{{ (playing_speakers.1 | float - (playing_speakers.1 | float
            / 2))| string }}'
        target:
          entity_id: '{{playing_speakers.0}}'
        alias: Lower Music
      - wait_template: '{{ states(trigger.entity_id) == "idle" }}'
        continue_on_timeout: true
        timeout: '60'
      - action: media_player.volume_set
        metadata: {}
        data:
          volume_level: '{{playing_speakers.1}}'
        target:
          entity_id: '{{playing_speakers.0}}'
  mode: parallel
  max: 10
- id: '1727273501229'
  alias: Assist Play random music
  description: ''
  triggers:
  - command:
    - play random music
    trigger: conversation
  conditions: []
  actions:
  - data:
      media_type: playlist
      enqueue: replace
      media_id: 500 Random tracks
    action: mass.play_media
    target:
      entity_id: media_player.group_mass_home_airplay_speakers
  mode: single
- id: '1728086665319'
  alias: Manage bedroom AC through maxi occupancy
  description: ''
  triggers:
  - entity_id:
    - binary_sensor.user_home
    trigger: state
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: state
        entity_id: binary_sensor.user_home
        state: 'on'
      sequence:
      - metadata: {}
        data:
          preset_mode: none
        target:
          entity_id:
          - climate.hotbox_ac
          - climate.livingroom_ac
          - climate.office_ac
        action: climate.set_preset_mode
    - conditions:
      - condition: state
        entity_id: binary_sensor.user_home
        state: 'off'
      sequence:
      - metadata: {}
        data:
          preset_mode: away
        target:
          entity_id:
          - climate.hotbox_ac
          - climate.livingroom_ac
          - climate.office_ac
        action: climate.set_preset_mode
  mode: single
- id: '1728309825943'
  alias: Sleep actions when "sleeper in livingroom" is turned on
  description: ''
  triggers:
  - entity_id:
    - input_boolean.sleeper_in_livingroom
    to: 'on'
    from: 'off'
    trigger: state
  conditions: []
  actions:
  - action: media_player.volume_mute
    metadata: {}
    data:
      is_volume_muted: true
    target:
      entity_id:
      - media_player.universal_livingroom_speakers
      - media_player.universal_hallway_speakers
  - action: cover.close_cover
    metadata: {}
    data: {}
    target:
      entity_id: cover.cover_livingroom_blinds
  - action: media_player.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: media_player.lg_livingroom_tv
  - action: light.turn_off
    metadata: {}
    data:
      transition: 2
    target:
      area_id: livingroom
      entity_id: light.group_livingroom_lights
  mode: single
- id: '1728310438747'
  alias: Undo Sleep actions when "sleeper in livingroom" is turned off
  description: ''
  triggers:
  - entity_id:
    - input_boolean.sleeper_in_livingroom
    to: 'off'
    from: 'on'
    trigger: state
  conditions: []
  actions:
  - variables:
      off_lights_in_room: "{% set ns = namespace(f = [] ) %} {% for i in ( [area_id(trigger.entity_id)]
        \ | map('area_entities') | sum(start=[]) | select('match', '^light.') | select('is_state','off')
        \ |  unique | list )  %} {% if i not in  label_entities(\"High Intensity Light\")
        | string %}\n  {% set ns.f = ns.f + [i] %}\n{% endif %} {% endfor %} {{ ns.f
        }}\n"
  - action: light.turn_on
    data:
      transition: 120
      color_name: warm_white
    target:
      entity_id: '{{off_lights_in_room}}'
  - action: media_player.volume_mute
    metadata: {}
    data:
      is_volume_muted: false
    target:
      entity_id:
      - media_player.universal_livingroom_speakers
      - media_player.universal_hallway_speakers
  mode: single
- id: '1728311156670'
  alias: Dim Wall lights when livingroom TV is playing and Beige couch or matress
    is occupied
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - binary_sensor.sensor_livingroom_beige_couch_fp2_occupancy
    - binary_sensor.sensor_livingroom_matress_fp2_occupancy
    to: 'on'
  - trigger: state
    entity_id:
    - media_player.universal_livingroom_chromecast
    from:
    to: playing
  conditions:
  - condition: state
    entity_id: light.livingroom_wall_light
    state: 'on'
  - condition: not
    conditions:
    - condition: state
      entity_id: media_player.universal_livingroom_chromecast
      state: 'off'
  - condition: or
    conditions:
    - condition: state
      entity_id: binary_sensor.sensor_livingroom_beige_couch_fp2_occupancy
      state: 'on'
    - condition: state
      entity_id: binary_sensor.sensor_livingroom_matress_fp2_occupancy
      state: 'on'
  actions:
  - action: light.turn_on
    metadata: {}
    data:
      transition: 2
      brightness_pct: 1
    target:
      entity_id: light.livingroom_wall_light
  mode: single
- id: '1728311332778'
  alias: 'unDim Wall lights when livingroom TV is stopped '
  description: ''
  triggers:
  - trigger: state
    entity_id:
    - binary_sensor.sensor_livingroom_beige_couch_fp2_occupancy
    - binary_sensor.sensor_livingroom_matress_fp2_occupancy
    to: 'off'
  - trigger: state
    entity_id:
    - media_player.universal_livingroom_chromecast
    from:
    to: 'off'
  conditions:
  - condition: state
    entity_id: light.livingroom_wall_light
    state: 'on'
  - condition: or
    conditions:
    - condition: and
      conditions:
      - condition: state
        entity_id: binary_sensor.sensor_livingroom_beige_couch_fp2_occupancy
        state: 'off'
      - condition: state
        entity_id: binary_sensor.sensor_livingroom_matress_fp2_occupancy
        state: 'off'
    - condition: state
      entity_id: media_player.universal_livingroom_chromecast
      state: 'off'
  actions:
  - action: light.turn_on
    metadata: {}
    data:
      transition: 5
      brightness: '{{ state_attr("light.group_livingroom_lights", ''brightness'')
        / 2 }}

        '
    target:
      entity_id: light.livingroom_wall_light
  mode: single
- id: '1728390311720'
  alias: Turn Assist screens on when listening
  description: ''
  triggers:
  - entity_id:
    - assist_satellite.esp32_s3_box_3_office_assistant_assist_satellite
    - assist_satellite.esp32_s3_box_3_lv_assistant_assist_satellite
    - binary_sensor.esp32_s3_box_kitchen_assistant_assist_in_progress
    - assist_satellite.esp32_s3_box_3_lvw_assistant_assist_satellite
    - assist_satellite.esp32_s3_box_bedroom_assistant_assist_satellite
    - assist_satellite.esp32_s3_box_kitchen_assistant_assist_satellite
    - assist_satellite.esp32_s3_box_3_hallway_assistant_assist_satellite
    from:
    trigger: state
    to: listening
  conditions: []
  actions:
  - action: light.turn_on
    metadata: {}
    data: {}
    target:
      entity_id: '{{device_entities(device_id(trigger.entity_id)) | select("match",
        ".*light.*") | first }}'
  mode: single
- id: '1728390398785'
  alias: Turn off Assists screens when done listening
  description: ''
  triggers:
  - entity_id:
    - assist_satellite.esp32_s3_box_3_office_assistant_assist_satellite
    - assist_satellite.esp32_s3_box_3_lv_assistant_assist_satellite
    - binary_sensor.esp32_s3_box_kitchen_assistant_assist_in_progress
    - assist_satellite.esp32_s3_box_3_lvw_assistant_assist_satellite
    - assist_satellite.esp32_s3_box_bedroom_assistant_assist_satellite
    - assist_satellite.esp32_s3_box_kitchen_assistant_assist_satellite
    - assist_satellite.esp32_s3_box_3_hallway_assistant_assist_satellite
    from:
    trigger: state
    to: idle
  conditions:
  - condition: template
    value_template: '{{ area_id(trigger.entity_id) | replace(''_top'','''') | replace(''_down'','''')
      in states(''sensor.active_sleeper_rooms'') | string  }}'
  actions:
  - action: light.turn_off
    metadata: {}
    data: {}
    target:
      entity_id: '{{device_entities(device_id(trigger.entity_id)) | select("match",
        ".*light.*") | first }}'
  mode: single
