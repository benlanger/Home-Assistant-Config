[{"id":"3ad1e0957e6ec22e","type":"tab","label":"House-Wide","disabled":false,"info":"","env":[]},{"id":"ad8c570ec4ac394a","type":"tab","label":"Trigger-Based","disabled":false,"info":"","env":[]},{"id":"2d6a330c11854cb5","type":"tab","label":"Security_conditions","disabled":false,"info":""},{"id":"4e6f57edbb2d3314","type":"tab","label":"Carla","disabled":false,"info":""},{"id":"d5c4f13f05d3870d","type":"tab","label":"Fay","disabled":false,"info":"","env":[]},{"id":"1926984267e0fec1","type":"tab","label":"Back door","disabled":false,"info":""},{"id":"cc94640ec8e547cb","type":"tab","label":"Front Door","disabled":false,"info":"","env":[]},{"id":"881898b44ee6eb81","type":"tab","label":"Bathroom","disabled":false,"info":"","env":[]},{"id":"56c911ff62a860ba","type":"tab","label":"Bedroom","disabled":false,"info":"","env":[]},{"id":"adab22047f9bb868","type":"tab","label":"Office","disabled":false,"info":"","env":[]},{"id":"f8abdd9653af834e","type":"tab","label":"Chilling Room","disabled":false,"info":"","env":[]},{"id":"9c255342f7ba0458","type":"tab","label":"Closet","disabled":false,"info":"","env":[]},{"id":"5d4e860e6cd2bc1e","type":"tab","label":"Kitchen","disabled":false,"info":"","env":[]},{"id":"a17f73eee8c0a729","type":"tab","label":"Hotbox Down","disabled":false,"info":"","env":[]},{"id":"45ec21e855a2c144","type":"tab","label":"Hotbox Top","disabled":false,"info":"","env":[]},{"id":"933f5581a37dd52c","type":"tab","label":"Dimmer/Dial/Tap","disabled":true,"info":""},{"id":"904d418a12e6a4b0","type":"tab","label":"Face Reco 6.1","disabled":true,"info":""},{"id":"62914984f579d881","type":"tab","label":"Bathroom 2.0","disabled":true,"info":""},{"id":"2cc7bfce9974187b","type":"tab","label":"Bathroom Old","disabled":true,"info":""},{"id":"14484d2a357fa501","type":"tab","label":"Face Reco 7.0","disabled":true,"info":""},{"id":"90585768a7a619f8","type":"tab","label":"Face Reco 8.0","disabled":true,"info":"","env":[]},{"id":"dd89857c15f353c7","type":"tab","label":"Face Reco 9.0","disabled":true,"info":"","env":[]},{"id":"cd7a606d7931c143","type":"tab","label":"Face reco 10.0","disabled":true,"info":"","env":[]},{"id":"dc434684164184f3","type":"tab","label":"Facial Reco 6.0 Double-Stack","disabled":true,"info":""},{"id":"7a1172b433a6cf9c","type":"tab","label":"Living Room","disabled":false,"info":"","env":[]},{"id":"c6790bfa88a3b330","type":"tab","label":"PTZ Camera","disabled":false,"info":""},{"id":"92fbb69b279db47c","type":"tab","label":"Phone","disabled":false,"info":""},{"id":"effe1ca3bbc31144","type":"tab","label":"Tablets","disabled":false,"info":""},{"id":"5906a7fb2733fdfc","type":"tab","label":"Vacuum","disabled":false,"info":""},{"id":"f9b109c0bb255002","type":"tab","label":"hallway","disabled":false,"info":"","env":[]},{"id":"24ea4eb63a576675","type":"tab","label":"Server","disabled":false,"info":"","env":[]},{"id":"ab060e89aa02a122","type":"tab","label":"Patio","disabled":false,"info":"","env":[]},{"id":"450c81641a10c42d","type":"tab","label":"Face Reco","disabled":false,"info":"","env":[]},{"id":"03d6b46677a5b50f","type":"tab","label":"Neighbors","disabled":false,"info":"Here are set automations to facilicate cohabitation with the people living around","env":[]},{"id":"666f64b87ddc48a7","type":"tab","label":"test","disabled":false,"info":"","env":[]},{"id":"60d15080ad880ed5","type":"tab","label":"subflow testing","disabled":false,"info":"","env":[]},{"id":"a05fceb6d51a1c04","type":"tab","label":"Cube","disabled":false,"info":"","env":[]},{"id":"6509e4b9179d45ae","type":"tab","label":"Flow 1","disabled":false,"info":"","env":[]},{"id":"cd4b600533b9308c","type":"subflow","name":"Auto Lights 2.0","info":"","category":"","in":[{"x":100,"y":120,"wires":[{"id":"e200c956be50b58a"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99","status":{"x":700,"y":80,"wires":[{"id":"ba1bb1c238035d63","port":0}]}},{"id":"9e515b8aa75a9cdd","type":"subflow","name":"Auto lights off","info":"","category":"","in":[{"x":160,"y":180,"wires":[{"id":"5dbfe54c1c9e0349"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"61f53235c712b2c2","type":"subflow","name":"Dial Subflow","info":"","category":"","in":[{"x":40,"y":380,"wires":[{"id":"742b96a2b1b4120a"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"233ac7dcd801a802","type":"subflow","name":"Improved Alerts 1.0","info":"","category":"","in":[{"x":140,"y":900,"wires":[{"id":"2fad2062613570e7"},{"id":"2d00197d6062613a"},{"id":"366af0d006ca31e2"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"dfb97c6505f003d9","type":"subflow","name":"Light Alerts old","info":"","category":"","in":[{"x":200,"y":700,"wires":[{"id":"ac96ceaf6db5e36c"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"a4f0ac9a6eed6b71","type":"subflow","name":"TV Alert","info":"","category":"","in":[{"x":60,"y":220,"wires":[]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"eb3b6592c8406c0d","type":"subflow","name":"TV Anouncements","info":"","category":"","in":[{"x":260,"y":240,"wires":[{"id":"707a9031aaac3456"}]}],"out":[],"env":[],"meta":{},"color":"#DDAA99"},{"id":"824fe4cb22842d7f","type":"group","z":"9e515b8aa75a9cdd","name":"","style":{"label":true},"nodes":["5dbfe54c1c9e0349","57eb4ea18bc4f55b","2080c99162556dc0","21add955f677d2b7","ad814cbe9abc19f5","a87e55e132644e6c","342cb1090e8f530b","0cb211a18508e0ab","e8e8db56dab8adcc","6131a2c1c3af7050","27cd90e7ad99d55c","f0de34106b389b4a","c7f2980adaee37b4","9c396755fe1cb910","1189f4b6f680b126","cf8ff618865df435","d5e2a24c6ce71e38","57b7936054b0b5cc","db1017a7cb93fa99","cb125f4b50582619","e91a19e1d4d03076","deb1c3f277dffa05","bc2e357cd21ccadd","18d49bad3d314fbb","6da1158175acc54a","924efdd72ef016a6","6d38d52715aeb7ef","2ae78b52a82bf9e5","d3c382301395300b","62fcc1a1fce54141","d22cea5a615c3b79","ee596aba36f6626b","33b091aa899cef65","054470e44aa3f1ca","92bb7dc9357b96d3","4be0a0aa026d1431"],"x":194,"y":119},{"id":"f27b924821bee7c6","type":"group","z":"adab22047f9bb868","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["bf4db16910c7618b","dc0f74507fa165b1","56c93fec23942ed9","722aab7f36fe606a","b991422029043762","d38eb955df6f7d83"],"x":74,"y":599},{"id":"4400d23658e76bdf","type":"group","z":"7a1172b433a6cf9c","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["b32a90c6168f15d7","f6f59f0656592eed","cb5984111331e6ed","3b1c32816a1299f8","bd59751a77bcba60","3f4d478a4f7e7def"],"x":74,"y":459},{"id":"daa042542b94f545","type":"group","z":"450c81641a10c42d","style":{"stroke":"#999999","stroke-opacity":"1","fill":"none","fill-opacity":"1","label":true,"label-position":"nw","color":"#a4a4a4"},"nodes":["026da4d507207193","5d870c3cae125238","21e884512b585c28","a6411babbdf53e5b","36616d1ccd9b6c9e","57ac30854bd6c1c8","f94192aa45f7dba1","6423b2c425560d42","d0a4cc0dbf14f69d","f27991bfbd64b9b9","840c8452fea3e6e9"],"x":154,"y":299},{"id":"33b091aa899cef65","type":"junction","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","x":1460,"y":200,"wires":[["21add955f677d2b7"]]},{"id":"ee596aba36f6626b","type":"junction","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","x":1460,"y":220,"wires":[["d22cea5a615c3b79"]]},{"id":"d22cea5a615c3b79","type":"junction","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","x":1460,"y":300,"wires":[["d3c382301395300b"]]},{"id":"9442e076db99a2e1","type":"junction","z":"ad8c570ec4ac394a","x":2640,"y":1720,"wires":[["2c54900f0bdbbea5"]]},{"id":"630088e66f7238a1","type":"junction","z":"ad8c570ec4ac394a","x":740,"y":1740,"wires":[["74b80452ecae5b16"]]},{"id":"6ab4316b4ec28a96","type":"junction","z":"ad8c570ec4ac394a","x":1200,"y":1860,"wires":[["e216d39e85bfde74"]]},{"id":"de9f4c34e00835c7","type":"junction","z":"881898b44ee6eb81","x":400,"y":740,"wires":[["8a87371543b31002"]]},{"id":"12dd6306bdf52a97","type":"junction","z":"881898b44ee6eb81","x":400,"y":780,"wires":[["cf3320ead9bdaf99"]]},{"id":"6c7ad1714992bdd3","type":"junction","z":"881898b44ee6eb81","x":400,"y":460,"wires":[["e921ceff2ed05761"]]},{"id":"ed840b70957315b2","type":"junction","z":"881898b44ee6eb81","x":400,"y":500,"wires":[["68230369115ebbb3"]]},{"id":"8ecacc3680df8a66","type":"junction","z":"881898b44ee6eb81","x":300,"y":1200,"wires":[["c21d3f05ccdb3e9f"]]},{"id":"c21d3f05ccdb3e9f","type":"junction","z":"881898b44ee6eb81","x":400,"y":1200,"wires":[["c7d7869cf88446c1"]]},{"id":"471b6b35d2f07b2f","type":"junction","z":"881898b44ee6eb81","x":340,"y":1300,"wires":[["1e251d84255e0657"]]},{"id":"d26eadfb6228a626","type":"junction","z":"881898b44ee6eb81","x":780,"y":1100,"wires":[["1823da52dbb438b3"]]},{"id":"695dbd47c25a51cc","type":"junction","z":"881898b44ee6eb81","x":780,"y":1180,"wires":[["73508ebeaf49e873"]]},{"id":"73508ebeaf49e873","type":"junction","z":"881898b44ee6eb81","x":1560,"y":1180,"wires":[["40902a85fa0988ab"]]},{"id":"1823da52dbb438b3","type":"junction","z":"881898b44ee6eb81","x":1560,"y":1100,"wires":[["2676640708d0f3db"]]},{"id":"1e251d84255e0657","type":"junction","z":"881898b44ee6eb81","x":420,"y":1300,"wires":[["ade0768cb997a2b3"]]},{"id":"7fcd0180ea269945","type":"junction","z":"881898b44ee6eb81","x":880,"y":1280,"wires":[["3c2838394f50a39a"]]},{"id":"340260f5e20a06a1","type":"junction","z":"881898b44ee6eb81","x":880,"y":1320,"wires":[["cf3f9442d8a57374"]]},{"id":"6886824c46b97a7c","type":"junction","z":"881898b44ee6eb81","x":560,"y":1540,"wires":[[]]},{"id":"3502a2624820f68a","type":"junction","z":"881898b44ee6eb81","x":500,"y":1640,"wires":[[]]},{"id":"b6b49543ca03433b","type":"junction","z":"881898b44ee6eb81","x":440,"y":1560,"wires":[["9b337d8762637eaa"]]},{"id":"5391dd8b0174feca","type":"junction","z":"881898b44ee6eb81","x":440,"y":1600,"wires":[["0b8ee3f939557602"]]},{"id":"717a4409aab31cce","type":"junction","z":"881898b44ee6eb81","x":1120,"y":1500,"wires":[["4ce58926e7976eb0"]]},{"id":"eb2007c7b6292a41","type":"junction","z":"881898b44ee6eb81","x":1000,"y":1500,"wires":[["717a4409aab31cce"]]},{"id":"d055e1a0c8f70c67","type":"junction","z":"56c911ff62a860ba","x":600,"y":380,"wires":[["c51712ff9318111b"]]},{"id":"205160672f2e2904","type":"junction","z":"56c911ff62a860ba","x":520,"y":380,"wires":[["d055e1a0c8f70c67"]]},{"id":"35d3219322e2e806","type":"junction","z":"56c911ff62a860ba","x":460,"y":380,"wires":[["205160672f2e2904"]]},{"id":"073c437a9b98ae8b","type":"junction","z":"4e6f57edbb2d3314","x":660,"y":460,"wires":[["a9ed637a6f71bb73"]]},{"id":"bf81e69c2972b1f4","type":"junction","z":"f8abdd9653af834e","x":900,"y":240,"wires":[["adf3d5e1856c236a"]]},{"id":"9b28eff28ebee678","type":"junction","z":"f8abdd9653af834e","x":580,"y":240,"wires":[["4ff95a5111ec8084"]]},{"id":"71fabfca7b4822f8","type":"junction","z":"f8abdd9653af834e","x":900,"y":340,"wires":[["490b9a310e45b569"]]},{"id":"d94be274450d8367","type":"junction","z":"f8abdd9653af834e","x":640,"y":340,"wires":[["8abcf914f5cd4f9f"]]},{"id":"9ee2a54ef22ef8f7","type":"junction","z":"9c255342f7ba0458","x":3380,"y":880,"wires":[["afc51c8149a63a45"]]},{"id":"8ff719e071b839ef","type":"junction","z":"9c255342f7ba0458","x":4040,"y":860,"wires":[["29dc8fa9b86b33d0"]]},{"id":"afc51c8149a63a45","type":"junction","z":"9c255342f7ba0458","x":3780,"y":880,"wires":[["259aa990286922dd"]]},{"id":"a8d6b266991a537a","type":"junction","z":"9c255342f7ba0458","x":3240,"y":880,"wires":[["9ee2a54ef22ef8f7"]]},{"id":"9b5bc74d89ac6854","type":"junction","z":"dd89857c15f353c7","x":740,"y":1400,"wires":[["3c28784c1321d67d"]]},{"id":"177471418c06f764","type":"junction","z":"dd89857c15f353c7","x":1120,"y":1400,"wires":[["3c28784c1321d67d"]]},{"id":"9c935c7956118916","type":"junction","z":"dd89857c15f353c7","x":3540,"y":1560,"wires":[["cc9b4a03e1350d55"]]},{"id":"0cfa322e2f86ac01","type":"junction","z":"dd89857c15f353c7","x":3500,"y":1560,"wires":[["cc9b4a03e1350d55"]]},{"id":"8494a9adf85edace","type":"junction","z":"dd89857c15f353c7","x":3620,"y":1480,"wires":[["7cb1321035bbdb44"]]},{"id":"7cb1321035bbdb44","type":"junction","z":"dd89857c15f353c7","x":3720,"y":1480,"wires":[["001784db32fff1e2"]]},{"id":"e2c29f7712b2d101","type":"junction","z":"dd89857c15f353c7","x":1020,"y":1560,"wires":[["2aafb5ed5fb7221d","8b8ab6894608285c"]]},{"id":"d5035d7a4b8abde0","type":"junction","z":"cd7a606d7931c143","x":1320,"y":700,"wires":[["b1c8c154f909e20e"]]},{"id":"e8ce77d8da41bd8e","type":"junction","z":"cd7a606d7931c143","x":1320,"y":740,"wires":[["7ea8405b5138a79a"]]},{"id":"b1c8c154f909e20e","type":"junction","z":"cd7a606d7931c143","x":1420,"y":700,"wires":[["8a86d116cbd23a0c"]]},{"id":"7ea8405b5138a79a","type":"junction","z":"cd7a606d7931c143","x":1420,"y":740,"wires":[["7755d95655d67413"]]},{"id":"f1e47b926b68837c","type":"junction","z":"cd7a606d7931c143","x":2600,"y":720,"wires":[["6d399809f46da187"]]},{"id":"0f8df3cecc7769a3","type":"junction","z":"cd7a606d7931c143","x":2620,"y":760,"wires":[["de1538bda5a59999"]]},{"id":"6d399809f46da187","type":"junction","z":"cd7a606d7931c143","x":2700,"y":720,"wires":[["84662acf4451979c"]]},{"id":"de1538bda5a59999","type":"junction","z":"cd7a606d7931c143","x":2700,"y":760,"wires":[["fdc333b7d683f18c"]]},{"id":"a4c688e86f5f2b80","type":"junction","z":"cd7a606d7931c143","x":3260,"y":660,"wires":[["acdce7f00366b401","116f7fc3f104a266"]]},{"id":"79ea6e5eebeb3dc4","type":"junction","z":"cd7a606d7931c143","x":1840,"y":660,"wires":[["a338a4e199a28d06"]]},{"id":"a338a4e199a28d06","type":"junction","z":"cd7a606d7931c143","x":1940,"y":660,"wires":[["a4c688e86f5f2b80"]]},{"id":"1d8a1bf5c390d165","type":"junction","z":"cd7a606d7931c143","x":1840,"y":740,"wires":[["7755d95655d67413"]]},{"id":"94e15e45a5dd4895","type":"junction","z":"cd7a606d7931c143","x":3140,"y":700,"wires":[["c177ff1a1286070d"]]},{"id":"13611f4c75079d74","type":"junction","z":"cd7a606d7931c143","x":3140,"y":740,"wires":[["b85c085ce5640b8f"]]},{"id":"c177ff1a1286070d","type":"junction","z":"cd7a606d7931c143","x":3220,"y":700,"wires":[["a4c688e86f5f2b80"]]},{"id":"b85c085ce5640b8f","type":"junction","z":"cd7a606d7931c143","x":3240,"y":740,"wires":[["fdc333b7d683f18c"]]},{"id":"fdc333b7d683f18c","type":"junction","z":"cd7a606d7931c143","x":3280,"y":760,"wires":[["5eb7dc5f5129f6ab"]]},{"id":"aeb41a7bbfd5f871","type":"junction","z":"cd7a606d7931c143","x":3880,"y":680,"wires":[["8f42a1e376b2f151"]]},{"id":"f152504f7838b65f","type":"junction","z":"cd7a606d7931c143","x":3840,"y":680,"wires":[["8f42a1e376b2f151"]]},{"id":"eca51006f7ccf6da","type":"junction","z":"cd7a606d7931c143","x":3980,"y":620,"wires":[["622b280fd9e0e6f8"]]},{"id":"622b280fd9e0e6f8","type":"junction","z":"cd7a606d7931c143","x":4000,"y":640,"wires":[["9be2f214cabf3c56"]]},{"id":"d0547b86a59e926f","type":"junction","z":"cd7a606d7931c143","x":3400,"y":740,"wires":[["5eb7dc5f5129f6ab"]]},{"id":"5eb7dc5f5129f6ab","type":"junction","z":"cd7a606d7931c143","x":3440,"y":760,"wires":[["30eb2da0228e52db"]]},{"id":"625b7fb50bb7a849","type":"junction","z":"cd7a606d7931c143","x":3340,"y":740,"wires":[["d0547b86a59e926f"]]},{"id":"25b0a99477e639be","type":"junction","z":"cd7a606d7931c143","x":3580,"y":740,"wires":[["30eb2da0228e52db"]]},{"id":"30eb2da0228e52db","type":"junction","z":"cd7a606d7931c143","x":3620,"y":760,"wires":[["0cc845d13352c21f"]]},{"id":"78575bad96d21598","type":"junction","z":"cd7a606d7931c143","x":3520,"y":740,"wires":[["25b0a99477e639be"]]},{"id":"f8f4dd1f5ea9eeb9","type":"junction","z":"cd7a606d7931c143","x":3760,"y":740,"wires":[["0cc845d13352c21f"]]},{"id":"0cc845d13352c21f","type":"junction","z":"cd7a606d7931c143","x":3800,"y":760,"wires":[["759704f763b58501"]]},{"id":"f9d1114c3060999d","type":"junction","z":"cd7a606d7931c143","x":3700,"y":740,"wires":[["f8f4dd1f5ea9eeb9"]]},{"id":"e6e258ae376ae884","type":"junction","z":"cd7a606d7931c143","x":4120,"y":700,"wires":[["759704f763b58501"]]},{"id":"1b04206a65cea813","type":"junction","z":"cc94640ec8e547cb","x":260,"y":260,"wires":[["0ac23590a7b82122","ec38337bc4762c2a"]]},{"id":"6dae17c627907e37","type":"junction","z":"cc94640ec8e547cb","x":260,"y":180,"wires":[["ec38337bc4762c2a"]]},{"id":"b2b40cd2583e9dcd","type":"junction","z":"cc94640ec8e547cb","x":860,"y":520,"wires":[["64b624557a59f61e"]]},{"id":"bf61178d1208f913","type":"junction","z":"cc94640ec8e547cb","x":860,"y":440,"wires":[["0f9702216925a495"]]},{"id":"79b785d11bf94fd0","type":"junction","z":"cc94640ec8e547cb","x":1060,"y":1040,"wires":[["6877bf1fa1529499"]]},{"id":"e8ac38df38777916","type":"junction","z":"cc94640ec8e547cb","x":280,"y":1000,"wires":[["dd92294670fe6c0a"]]},{"id":"625bfabb4a23a8fd","type":"junction","z":"cc94640ec8e547cb","x":640,"y":1040,"wires":[["55bc58b8ee7f542d"]]},{"id":"1fc38a6d436e5401","type":"junction","z":"cc94640ec8e547cb","x":1460,"y":1540,"wires":[["73634a14fd698218","99920e046416a169","c54b8b86c8d99dd9","efc99d9bfb42c91a"]]},{"id":"551208ac4f349765","type":"junction","z":"cc94640ec8e547cb","x":1360,"y":1840,"wires":[["d25b8a56d9708a46","14f2faa78c4b0c8d"]]},{"id":"3a18d29d3e7456e5","type":"junction","z":"cc94640ec8e547cb","x":1360,"y":1920,"wires":[["d25b8a56d9708a46"]]},{"id":"7f9a1d858af4af65","type":"junction","z":"45ec21e855a2c144","x":620,"y":280,"wires":[["404ecaebc962233c"]]},{"id":"a282295f9531c449","type":"junction","z":"45ec21e855a2c144","x":1060,"y":260,"wires":[["5bc2cb0e759e793b"]]},{"id":"4eb099e1b392cd4c","type":"junction","z":"45ec21e855a2c144","x":1060,"y":300,"wires":[["6c1ecfe43363e7e9"]]},{"id":"98fc5a3560c564f6","type":"junction","z":"45ec21e855a2c144","x":800,"y":280,"wires":[["6796fb06bd462591"]]},{"id":"0b790b8288d7484a","type":"junction","z":"45ec21e855a2c144","x":820,"y":300,"wires":[["32b6d425f6afdbd3"]]},{"id":"f7c29043a9516378","type":"junction","z":"45ec21e855a2c144","x":300,"y":240,"wires":[["bd525f7ba4e7d782"]]},{"id":"c567a425829271f3","type":"junction","z":"3ad1e0957e6ec22e","x":220,"y":100,"wires":[["2f2e8679067c06af"]]},{"id":"6372d64da4e99c42","type":"junction","z":"3ad1e0957e6ec22e","x":220,"y":180,"wires":[["581fd4c7ce035d72"]]},{"id":"e2670ef9a6f08eeb","type":"junction","z":"3ad1e0957e6ec22e","x":3440,"y":560,"wires":[["5d19ca682dd18d58"]]},{"id":"1c819bd84e568a03","type":"junction","z":"3ad1e0957e6ec22e","x":3440,"y":640,"wires":[["be293fd5728c4e6e"]]},{"id":"6805035056bd8cee","type":"junction","z":"3ad1e0957e6ec22e","x":4040,"y":560,"wires":[["2e0553a4becdcb11"]]},{"id":"a8bbac8ba01b6fd2","type":"junction","z":"3ad1e0957e6ec22e","x":4040,"y":640,"wires":[["2e0553a4becdcb11"]]},{"id":"fc518af82d06d8bc","type":"junction","z":"3ad1e0957e6ec22e","x":200,"y":280,"wires":[["5e73e5e7fc269891"]]},{"id":"b1880ea06e93f832","type":"junction","z":"3ad1e0957e6ec22e","x":980,"y":1380,"wires":[["fc4eb7aaf1a49466"]]},{"id":"2792555ece4458cd","type":"junction","z":"3ad1e0957e6ec22e","x":1080,"y":1440,"wires":[["3996bd2645bd3ea2"]]},{"id":"46d3285b345e72df","type":"junction","z":"3ad1e0957e6ec22e","x":1400,"y":1380,"wires":[["a25d3f0c73d9050d"]]},{"id":"62cf47fb999346aa","type":"junction","z":"3ad1e0957e6ec22e","x":1260,"y":1340,"wires":[["ef1d3af5aec4c6ad"]]},{"id":"bb71b092d9c74860","type":"junction","z":"3ad1e0957e6ec22e","x":1260,"y":1380,"wires":[["46d3285b345e72df"]]},{"id":"ef1d3af5aec4c6ad","type":"junction","z":"3ad1e0957e6ec22e","x":1400,"y":1340,"wires":[["dfbcd81831907951"]]},{"id":"ac09ae6273c851a3","type":"junction","z":"3ad1e0957e6ec22e","x":1620,"y":1400,"wires":[["afec6aacb9655c5b"]]},{"id":"fc4eb7aaf1a49466","type":"junction","z":"3ad1e0957e6ec22e","x":1080,"y":1380,"wires":[["cad47fe6566c23a7"]]},{"id":"598cbca76ab38a02","type":"junction","z":"3ad1e0957e6ec22e","x":560,"y":1160,"wires":[["adc9dfdbe4ca7285"]]},{"id":"5b05cae4ba55b8ee","type":"junction","z":"3ad1e0957e6ec22e","x":300,"y":1160,"wires":[["598cbca76ab38a02"]]},{"id":"6c667b04c18e0b33","type":"junction","z":"5d4e860e6cd2bc1e","x":1300,"y":260,"wires":[["72a594d88c84876d"]]},{"id":"fba35d3bdbb3a641","type":"junction","z":"5d4e860e6cd2bc1e","x":2040,"y":2760,"wires":[["8628ef491109f67c"]]},{"id":"a4165723d67e441d","type":"junction","z":"5d4e860e6cd2bc1e","x":1920,"y":2900,"wires":[["a37355ef9606ec1f"]]},{"id":"f4694759a1bfdc7c","type":"junction","z":"5d4e860e6cd2bc1e","x":2600,"y":2900,"wires":[["1f85692114ea2aff"]]},{"id":"fa0a1f6cff67820b","type":"junction","z":"5d4e860e6cd2bc1e","x":1060,"y":960,"wires":[["fbb4d6c6639c5d27"]]},{"id":"de24400af7fb8682","type":"junction","z":"7a1172b433a6cf9c","x":400,"y":120,"wires":[["2dd272c9b019b4cb"]]},{"id":"b659f5b0b0949237","type":"junction","z":"7a1172b433a6cf9c","x":400,"y":200,"wires":[["70c42437dc758335"]]},{"id":"44ba3b44224c44ec","type":"junction","z":"5906a7fb2733fdfc","x":520,"y":420,"wires":[["45bc44fe94968ec0"]]},{"id":"45bc44fe94968ec0","type":"junction","z":"5906a7fb2733fdfc","x":640,"y":420,"wires":[["759b76f802152b90"]]},{"id":"79d77c2dfbee2cd2","type":"junction","z":"5906a7fb2733fdfc","x":520,"y":500,"wires":[["b652acd7f073d43a"]]},{"id":"78994aabdbe7d773","type":"junction","z":"5906a7fb2733fdfc","x":860,"y":920,"wires":[[]]},{"id":"7179431f4b20ca48","type":"junction","z":"5906a7fb2733fdfc","x":1580,"y":1040,"wires":[["ce8ad4ee11178ee3"]]},{"id":"8d7549550611cb06","type":"junction","z":"60d15080ad880ed5","x":1700,"y":920,"wires":[["8426df596c13d4de","be1856fa89c02c1c"]]},{"id":"71364916a3fa9188","type":"junction","z":"60d15080ad880ed5","x":1020,"y":3260,"wires":[["8227ededf045f556"]]},{"id":"2350a18ac22e98b4","type":"junction","z":"60d15080ad880ed5","x":1160,"y":3220,"wires":[["065cf842d3d46cc8"]]},{"id":"065cf842d3d46cc8","type":"junction","z":"60d15080ad880ed5","x":1320,"y":3240,"wires":[["1e73bfe953d85067"]]},{"id":"9435748e43e9af6b","type":"junction","z":"60d15080ad880ed5","x":1020,"y":3340,"wires":[["8ed80b13f732fd7b"]]},{"id":"a151f373fbc9b9d8","type":"junction","z":"60d15080ad880ed5","x":1000,"y":3300,"wires":[["98374cfc9c7927e4"]]},{"id":"4210fb87830effc6","type":"junction","z":"60d15080ad880ed5","x":1260,"y":3300,"wires":[["3ec3535295a275ae"]]},{"id":"fc24a4d83551bb84","type":"junction","z":"60d15080ad880ed5","x":1620,"y":3340,"wires":[["5469aa11819e92e8"]]},{"id":"8ed80b13f732fd7b","type":"junction","z":"60d15080ad880ed5","x":1260,"y":3340,"wires":[["482e4d154347c1b9"]]},{"id":"16caf9e7df604790","type":"junction","z":"60d15080ad880ed5","x":1520,"y":3340,"wires":[["fc24a4d83551bb84"]]},{"id":"9ab098a019fd22ce","type":"junction","z":"60d15080ad880ed5","x":1940,"y":3240,"wires":[["145d1c3ddc56b191"]]},{"id":"f9851727a48833cf","type":"junction","z":"5d4e860e6cd2bc1e","x":2060,"y":2500,"wires":[["77595709a7377169"]]},{"id":"a0431ea76e79e916","type":"junction","z":"5d4e860e6cd2bc1e","x":1940,"y":2640,"wires":[["b6868b0878f5233d"]]},{"id":"87c49b494e11b361","type":"junction","z":"5d4e860e6cd2bc1e","x":2620,"y":2640,"wires":[["7d23b37b2ab24572"]]},{"id":"f3f29a6cf62e7a70","type":"junction","z":"61f53235c712b2c2","x":1020,"y":480,"wires":[["0c1b60d4aa369d17"]]},{"id":"6bb3a63bfd0b412a","type":"junction","z":"61f53235c712b2c2","x":1160,"y":440,"wires":[["27c70ecb251d39fb"]]},{"id":"27c70ecb251d39fb","type":"junction","z":"61f53235c712b2c2","x":1320,"y":460,"wires":[["f89ba43362873342"]]},{"id":"647aae16977d9144","type":"junction","z":"61f53235c712b2c2","x":1000,"y":520,"wires":[["48add15e895426df"]]},{"id":"859d7a5dde62e6c6","type":"junction","z":"61f53235c712b2c2","x":1020,"y":560,"wires":[["3182d5ee1e39bf21"]]},{"id":"6de941e9d76f7ae3","type":"junction","z":"61f53235c712b2c2","x":1260,"y":520,"wires":[["4c8e690b1892a0a9"]]},{"id":"713a5335cf4987bb","type":"junction","z":"61f53235c712b2c2","x":1620,"y":560,"wires":[["bf9990f86fd9442a"]]},{"id":"3182d5ee1e39bf21","type":"junction","z":"61f53235c712b2c2","x":1260,"y":560,"wires":[["c26958cde5989374"]]},{"id":"8b54b3ae965ebbcd","type":"junction","z":"61f53235c712b2c2","x":1520,"y":560,"wires":[["713a5335cf4987bb"]]},{"id":"5f49b19ecc5e38ed","type":"junction","z":"61f53235c712b2c2","x":1940,"y":460,"wires":[["b216e70ab4eb7093"]]},{"id":"56d369d20406df30","type":"junction","z":"cd7a606d7931c143","x":1720,"y":3160,"wires":[["1e3bb9f8806d7431"]]},{"id":"e9d9c66b8213d739","type":"junction","z":"cd7a606d7931c143","x":1720,"y":3200,"wires":[["21b410282eca03ed"]]},{"id":"1e3bb9f8806d7431","type":"junction","z":"cd7a606d7931c143","x":1820,"y":3160,"wires":[["923786bcd627d0aa"]]},{"id":"21b410282eca03ed","type":"junction","z":"cd7a606d7931c143","x":1820,"y":3200,"wires":[["a3210f29da2f7d89"]]},{"id":"a6b3d72c6c7dcaa9","type":"junction","z":"cd7a606d7931c143","x":2220,"y":3100,"wires":[["a1af7a8ad1fdea77","379e425db7a8a166"]]},{"id":"11605bc3d4a5768c","type":"junction","z":"cd7a606d7931c143","x":2100,"y":3140,"wires":[["99b945bcd39a6a1f"]]},{"id":"a3210f29da2f7d89","type":"junction","z":"cd7a606d7931c143","x":2100,"y":3180,"wires":[["6f8512591cd914ad"]]},{"id":"99b945bcd39a6a1f","type":"junction","z":"cd7a606d7931c143","x":2180,"y":3140,"wires":[["a6b3d72c6c7dcaa9"]]},{"id":"6f8512591cd914ad","type":"junction","z":"cd7a606d7931c143","x":2200,"y":3180,"wires":[["04c88a4ffc92e643"]]},{"id":"04c88a4ffc92e643","type":"junction","z":"cd7a606d7931c143","x":2240,"y":3200,"wires":[["dfa3c38e278ecc95"]]},{"id":"fc3459aea7ead35e","type":"junction","z":"cd7a606d7931c143","x":2840,"y":3120,"wires":[["839c614fc03c226c"]]},{"id":"8b8cbeaffef4fdea","type":"junction","z":"cd7a606d7931c143","x":2800,"y":3120,"wires":[["839c614fc03c226c"]]},{"id":"19ba7309e15502d7","type":"junction","z":"cd7a606d7931c143","x":2940,"y":3060,"wires":[["187a0a6344189bac"]]},{"id":"187a0a6344189bac","type":"junction","z":"cd7a606d7931c143","x":2960,"y":3080,"wires":[["a58003ac74cf89ee"]]},{"id":"684740a4e3873dd8","type":"junction","z":"cd7a606d7931c143","x":2360,"y":3180,"wires":[["dfa3c38e278ecc95"]]},{"id":"dfa3c38e278ecc95","type":"junction","z":"cd7a606d7931c143","x":2400,"y":3200,"wires":[["c7838a406c9eb277"]]},{"id":"749f9097f018277c","type":"junction","z":"cd7a606d7931c143","x":2300,"y":3180,"wires":[["684740a4e3873dd8"]]},{"id":"a95e22cb2f83dcda","type":"junction","z":"cd7a606d7931c143","x":2540,"y":3180,"wires":[["c7838a406c9eb277"]]},{"id":"c7838a406c9eb277","type":"junction","z":"cd7a606d7931c143","x":2580,"y":3200,"wires":[["f019076abe11d954"]]},{"id":"c942ac776d6cd71f","type":"junction","z":"cd7a606d7931c143","x":2480,"y":3180,"wires":[["a95e22cb2f83dcda"]]},{"id":"413d4ec9a6df11df","type":"junction","z":"cd7a606d7931c143","x":2720,"y":3180,"wires":[["f019076abe11d954"]]},{"id":"f019076abe11d954","type":"junction","z":"cd7a606d7931c143","x":2760,"y":3200,"wires":[["929ec49d77f1d265"]]},{"id":"da73e5a65b916aaa","type":"junction","z":"cd7a606d7931c143","x":2660,"y":3180,"wires":[["413d4ec9a6df11df"]]},{"id":"d1d80e74b4721828","type":"junction","z":"cd7a606d7931c143","x":3080,"y":3140,"wires":[["929ec49d77f1d265"]]},{"id":"38b109a5d10ff26d","type":"junction","z":"450c81641a10c42d","x":2900,"y":1260,"wires":[["f422810e7e1914b6"]]},{"id":"96070bddb26b6c9e","type":"junction","z":"450c81641a10c42d","x":2800,"y":1260,"wires":[["38b109a5d10ff26d"]]},{"id":"91cd40af7f2cd956","type":"junction","z":"450c81641a10c42d","x":2600,"y":1380,"wires":[["6c1872d6510312f9"]]},{"id":"6c1872d6510312f9","type":"junction","z":"450c81641a10c42d","x":2700,"y":1380,"wires":[["1ffd8297d33ce07d"]]},{"id":"1ffd8297d33ce07d","type":"junction","z":"450c81641a10c42d","x":2940,"y":1380,"wires":[["589a3f8b2961adce"]]},{"id":"1e06a97fc5de2f98","type":"junction","z":"450c81641a10c42d","x":3640,"y":1260,"wires":[["19e1dce6a1046296"]]},{"id":"19e1dce6a1046296","type":"junction","z":"450c81641a10c42d","x":3800,"y":1260,"wires":[["cabc1736dc584d7d"]]},{"id":"5acb3e3de8c5b17b","type":"junction","z":"450c81641a10c42d","x":3060,"y":1340,"wires":[["9a3c4deebc1f79d4"]]},{"id":"589a3f8b2961adce","type":"junction","z":"450c81641a10c42d","x":3100,"y":1380,"wires":[["99a5842425262fe7"]]},{"id":"af19fdacd71359c6","type":"junction","z":"450c81641a10c42d","x":3000,"y":1340,"wires":[["5acb3e3de8c5b17b"]]},{"id":"f5587072212db77b","type":"junction","z":"450c81641a10c42d","x":3240,"y":1340,"wires":[["50c10993b072d895"]]},{"id":"99a5842425262fe7","type":"junction","z":"450c81641a10c42d","x":3280,"y":1380,"wires":[["0aee512896affe9e"]]},{"id":"9a3c4deebc1f79d4","type":"junction","z":"450c81641a10c42d","x":3180,"y":1340,"wires":[["f5587072212db77b"]]},{"id":"730f5f8e34438ea7","type":"junction","z":"450c81641a10c42d","x":3420,"y":1340,"wires":[["149f29c5ca6bc3f3"]]},{"id":"0aee512896affe9e","type":"junction","z":"450c81641a10c42d","x":3680,"y":1380,"wires":[["4996b5a3516c8bf9","c5a435a10e0237a1","526fbeafe6da4f45"]]},{"id":"50c10993b072d895","type":"junction","z":"450c81641a10c42d","x":3360,"y":1340,"wires":[["730f5f8e34438ea7"]]},{"id":"464cb39e0f997312","type":"junction","z":"450c81641a10c42d","x":3820,"y":1340,"wires":[["e1d56fd01058e96c"]]},{"id":"5466f80ede718c92","type":"junction","z":"1926984267e0fec1","x":1060,"y":540,"wires":[["5e653191a5bf60b4"]]},{"id":"e63d4ca03ad56441","type":"junction","z":"1926984267e0fec1","x":1060,"y":580,"wires":[["b85861972ad4be99"]]},{"id":"56f0d45c70c74b03","type":"junction","z":"92fbb69b279db47c","x":860,"y":560,"wires":[["bb4c9008f4dc6e1c"]]},{"id":"ddc13303bc0f7076","type":"junction","z":"92fbb69b279db47c","x":620,"y":560,"wires":[["cf2bbfabad520e42"]]},{"id":"3298aa23644cb569","type":"junction","z":"92fbb69b279db47c","x":560,"y":560,"wires":[["ddc13303bc0f7076"]]},{"id":"33c8f350509ef124","type":"junction","z":"2d6a330c11854cb5","x":380,"y":1140,"wires":[["7887400950c5a1d0"]]},{"id":"a961773857544603","type":"junction","z":"2d6a330c11854cb5","x":240,"y":1140,"wires":[["33c8f350509ef124"]]},{"id":"85636e9da9a16f70","type":"junction","z":"2d6a330c11854cb5","x":780,"y":1140,"wires":[["6addfad4cb86861c"]]},{"id":"05d5bd4ecc9e2857","type":"junction","z":"2d6a330c11854cb5","x":640,"y":1140,"wires":[["85636e9da9a16f70"]]},{"id":"03e05af9b7a9b8f7","type":"junction","z":"24ea4eb63a576675","x":360,"y":3440,"wires":[["bf1b0ef28750c1f7"]]},{"id":"149f29c5ca6bc3f3","type":"junction","z":"450c81641a10c42d","x":3740,"y":1340,"wires":[["464cb39e0f997312"]]},{"id":"b6b9cbbb3d9f7d31","type":"junction","z":"450c81641a10c42d","x":4300,"y":1420,"wires":[["128c9da2f61e9a86"]]},{"id":"a6ee972424e25404","type":"junction","z":"450c81641a10c42d","x":4100,"y":1460,"wires":[["789d2e65e771e941"]]},{"id":"21c8c9ef879dd219","type":"junction","z":"450c81641a10c42d","x":4320,"y":1280,"wires":[["78dc3c650c8dc2ca","99828ddfbdbdbcd6"]]},{"id":"cafb1e589f35c470","type":"junction","z":"450c81641a10c42d","x":2800,"y":1300,"wires":[["933ce75a01434f69"]]},{"id":"933ce75a01434f69","type":"junction","z":"450c81641a10c42d","x":2900,"y":1300,"wires":[["af19fdacd71359c6"]]},{"id":"d295dacce255c29b","type":"junction","z":"450c81641a10c42d","x":2360,"y":1080,"wires":[["c56fe8b20a7f90a1"]]},{"id":"f8c3bad32eedc603","type":"junction","z":"450c81641a10c42d","x":2360,"y":1120,"wires":[["76d8e20a37643152"]]},{"id":"c56fe8b20a7f90a1","type":"junction","z":"450c81641a10c42d","x":2500,"y":1080,"wires":[["f0885d09dd221150"]]},{"id":"76d8e20a37643152","type":"junction","z":"450c81641a10c42d","x":2500,"y":1120,"wires":[[]]},{"id":"32883d3e798a674f","type":"junction","z":"450c81641a10c42d","x":4600,"y":1380,"wires":[["18941321b47b01a9","7119a8895f38bb0e","a897342dd6b5692d"]]},{"id":"c6974bf09065ad1b","type":"junction","z":"f8abdd9653af834e","x":1140,"y":460,"wires":[["9b46083f08e3fac2"]]},{"id":"8efeba14eb8c4130","type":"junction","z":"f8abdd9653af834e","x":880,"y":460,"wires":[["d9b8226e94a54df0"]]},{"id":"248f5773e4a02c07","type":"junction","z":"f8abdd9653af834e","x":1140,"y":560,"wires":[["280f13288d33a037"]]},{"id":"9ba8dcc52f86b691","type":"junction","z":"f8abdd9653af834e","x":500,"y":560,"wires":[["ecbe801dcf8a6066"]]},{"id":"89dbec727f07e1e0","type":"junction","z":"ad8c570ec4ac394a","x":800,"y":1300,"wires":[["6804ad9c77614881"]]},{"id":"c78ba01e2c786587","type":"junction","z":"3ad1e0957e6ec22e","x":3120,"y":2180,"wires":[["6e0313cad534393b"]]},{"id":"b9118714b195156b","type":"junction","z":"3ad1e0957e6ec22e","x":2940,"y":740,"wires":[["6c6b54f0dfaad3fc"]]},{"id":"460c049976cb8d77","type":"junction","z":"3ad1e0957e6ec22e","x":2880,"y":620,"wires":[["b9118714b195156b"]]},{"id":"bb550eb68254b69e","type":"junction","z":"3ad1e0957e6ec22e","x":2880,"y":600,"wires":[["323614ff6d81d35d"]]},{"id":"7efa525fd92e36ca","type":"junction","z":"5d4e860e6cd2bc1e","x":2040,"y":3040,"wires":[["5b08cbc809046fcf"]]},{"id":"6b4160045b1a1940","type":"junction","z":"5d4e860e6cd2bc1e","x":1920,"y":3180,"wires":[["317e593ad51bb438"]]},{"id":"e21eb30284f75405","type":"junction","z":"5d4e860e6cd2bc1e","x":2600,"y":3180,"wires":[["60d3ce4549841dc1"]]},{"id":"88b1d87eacc8b8e0","type":"junction","z":"3ad1e0957e6ec22e","x":3120,"y":2140,"wires":[["e45b3c1d18695954"]]},{"id":"d285a6df06408469","type":"junction","z":"03d6b46677a5b50f","x":3760,"y":1940,"wires":[["467b85f84faa19e6"]]},{"id":"bedfef42e1daa9ec","type":"junction","z":"03d6b46677a5b50f","x":3460,"y":1940,"wires":[["91430ff8427678d6"]]},{"id":"3c0e2cc8cc0f18f3","type":"junction","z":"03d6b46677a5b50f","x":3420,"y":1900,"wires":[["7bfe41169c71a8b3","bedfef42e1daa9ec"]]},{"id":"1060a1d8b1f8f67c","type":"junction","z":"03d6b46677a5b50f","x":3300,"y":2100,"wires":[["9638ab6174792c98"]]},{"id":"7a367c039a7c208f","type":"junction","z":"03d6b46677a5b50f","x":3420,"y":2000,"wires":[["40ed793ac2b55db4"]]},{"id":"40ed793ac2b55db4","type":"junction","z":"03d6b46677a5b50f","x":3920,"y":2000,"wires":[["378dda93ed6d8753"]]},{"id":"2dfae27128e21d1e","type":"junction","z":"03d6b46677a5b50f","x":2940,"y":2100,"wires":[["1060a1d8b1f8f67c"]]},{"id":"8d60a95dfcc5fb5c","type":"junction","z":"03d6b46677a5b50f","x":2940,"y":1980,"wires":[["d222b3b27c3bab57"]]},{"id":"49b2ebacde4e2b78","type":"junction","z":"233ac7dcd801a802","x":1460,"y":800,"wires":[["68d023e456d1f241"]]},{"id":"5b1c993c8ee963e0","type":"junction","z":"666f64b87ddc48a7","x":1600,"y":460,"wires":[["0e557ba60c5d54f7"]]},{"id":"2cbbf348baa33c0b","type":"junction","z":"2d6a330c11854cb5","x":480,"y":140,"wires":[["530ddda284ce2b85"]]},{"id":"7ab5c227.a3ce8c","type":"server","name":"Home Assistant","version":5,"addon":true,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true,"heartbeat":false,"heartbeatInterval":"30","areaSelector":"friendlyName","deviceSelector":"friendlyName","entitySelector":"friendlyName","statusSeparator":"at: ","statusYear":"hidden","statusMonth":"short","statusDay":"numeric","statusHourCycle":"h23","statusTimeFormat":"h:m","enableGlobalContextStore":true},{"id":"21000c19b97da572","type":"mqtt-broker","name":"Mqtt Server","broker":"127.0.0.1","port":"1883","clientid":"","autoConnect":true,"usetls":false,"compatmode":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"e200c956be50b58a","type":"function","z":"cd4b600533b9308c","name":"Time","func":"var d = new Date();\nvar h = d.getHours();\nvar entity = msg.entity.entity_id\nvar sensor = msg.sensor\nvar sensorstate = msg.sensorstate\nif (h > 22){\n    var brightness = \"80\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness = \"70\";\n}\nelse if (h>2 && h<7){\n    var brightness = \"50\";\n}\nelse{\n    var brightness = \"100\";\n}\n\nvar newMsg = \n\n{ \n    \"payload\": {\n                data: {\n                         \"brightness_pct\": brightness,\n                         \"entity_id\": entity,\n                         \"color_name\": \"white\"\n                }\n               },\n               sensor: sensor,\n               sensorstate: sensorstate\n};\nreturn newMsg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":190,"y":120,"wires":[["8446e240fea72b05"]]},{"id":"8446e240fea72b05","type":"api-call-service","z":"cd4b600533b9308c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload.entity_id","propertyType":"msg","value":"sensor","valueType":"msg"}],"queue":"none","x":370,"y":120,"wires":[["ba1bb1c238035d63","8410cab5f0ef75fb"]]},{"id":"ba1bb1c238035d63","type":"ha-wait-until","z":"cd4b600533b9308c","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":1,"entityId":"","entityIdFilterType":"exact","property":"state","comparator":"is","value":"off","valueType":"str","timeout":"","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":false,"outputProperties":[],"x":600,"y":80,"wires":[["cbbfb444b8ddacab"]]},{"id":"cbbfb444b8ddacab","type":"trigger","z":"cd4b600533b9308c","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"5","extend":false,"overrideDelay":false,"units":"min","reset":"on","bytopic":"all","topic":"topic","outputs":1,"x":790,"y":120,"wires":[["51fe06785e465053"]]},{"id":"e82daf089875cb7f","type":"api-call-service","z":"cd4b600533b9308c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload.entity_id","propertyType":"msg","value":"sensor","valueType":"msg"}],"queue":"none","x":1890,"y":120,"wires":[[]]},{"id":"8410cab5f0ef75fb","type":"change","z":"cd4b600533b9308c","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"sensorstate","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":610,"y":140,"wires":[["cbbfb444b8ddacab"]]},{"id":"51fe06785e465053","type":"change","z":"cd4b600533b9308c","name":"delete brightness","rules":[{"t":"delete","p":"payload.data.brightness_pct","pt":"msg"},{"t":"delete","p":"payload.data.color_name","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1010,"y":120,"wires":[["d360eb355a7a9c3c"]]},{"id":"d360eb355a7a9c3c","type":"api-current-state","z":"cd4b600533b9308c","name":"Kink","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.kink_party","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"entity.entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1210,"y":120,"wires":[["7e7cd0983214d0ef"],[]]},{"id":"7e7cd0983214d0ef","type":"api-current-state","z":"cd4b600533b9308c","name":"Party","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.party_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"entity.entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1330,"y":120,"wires":[["435c8172eadcee36"],[]]},{"id":"089cb36f61ae5734","type":"comment","z":"cd4b600533b9308c","name":"Light turn on","info":"","x":370,"y":80,"wires":[]},{"id":"7330ec350dd8db98","type":"comment","z":"cd4b600533b9308c","name":"Brightness selector","info":"","x":170,"y":80,"wires":[]},{"id":"c0b199f4552e2bb0","type":"comment","z":"cd4b600533b9308c","name":"wait motionn off","info":"","x":600,"y":40,"wires":[]},{"id":"e55294af08fb27c0","type":"comment","z":"cd4b600533b9308c","name":"set reset","info":"","x":600,"y":180,"wires":[]},{"id":"31a0e62d277ec267","type":"comment","z":"cd4b600533b9308c","name":"wait 5 minutes","info":"","x":790,"y":160,"wires":[]},{"id":"da09a98c9f8f89bd","type":"comment","z":"cd4b600533b9308c","name":"delete brightness payload","info":"","x":990,"y":80,"wires":[]},{"id":"8b54536692505205","type":"comment","z":"cd4b600533b9308c","name":"Condfitions check","info":"","x":1260,"y":80,"wires":[]},{"id":"bcfdca0959ea0c5f","type":"comment","z":"cd4b600533b9308c","name":"Turn light off","info":"","x":1890,"y":80,"wires":[]},{"id":"435c8172eadcee36","type":"api-current-state","z":"cd4b600533b9308c","name":"psychs","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.acid_time","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"entity.entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1490,"y":120,"wires":[["e82daf089875cb7f"],[]]},{"id":"62fcc1a1fce54141","type":"comment","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Wait until all asleep","info":"","x":1590,"y":260,"wires":[]},{"id":"d3c382301395300b","type":"ha-wait-until","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":1,"entityId":"binary_sensor.all_present_sleeping","entityIdFilterType":"exact","property":"state","comparator":"is","value":"on","valueType":"str","timeout":0,"timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":1600,"y":300,"wires":[["db1017a7cb93fa99"]]},{"id":"2ae78b52a82bf9e5","type":"comment","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Turn the lights off","info":"","x":3020,"y":260,"wires":[]},{"id":"6d38d52715aeb7ef","type":"comment","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Set entity","info":"","x":2820,"y":260,"wires":[]},{"id":"924efdd72ef016a6","type":"comment","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Make sure the array is empty","info":"","x":2600,"y":260,"wires":[]},{"id":"6da1158175acc54a","type":"comment","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Get motion on entities in an array","info":"","x":2330,"y":260,"wires":[]},{"id":"18d49bad3d314fbb","type":"comment","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Prepare regex to check if another motion sensor is on in the room","info":"","x":1910,"y":260,"wires":[]},{"id":"bc2e357cd21ccadd","type":"api-call-service","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"{\"transition\": 30}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3030,"y":300,"wires":[[]]},{"id":"deb1c3f277dffa05","type":"change","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"rules","rules":[{"t":"move","p":"lights.entity_id","pt":"msg","to":"payload.data.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2810,"y":300,"wires":[["bc2e357cd21ccadd"]]},{"id":"e91a19e1d4d03076","type":"switch","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"","property":"payload.results","propertyType":"msg","rules":[{"t":"empty"}],"checkall":"true","repair":false,"outputs":1,"x":2590,"y":300,"wires":[["deb1c3f277dffa05"]]},{"id":"cb125f4b50582619","type":"ha-get-entities","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Get entities","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"array","output_empty_results":true,"output_location_type":"msg","output_location":"payload.results","output_results_count":1,"x":2310,"y":300,"wires":[["e91a19e1d4d03076"]]},{"id":"db1017a7cb93fa99","type":"function","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"prepare Regex to check other motion sensors","func":"var room = msg.room\nvar regex = \"binary_sensor\\.*\" + room + \".*_occupancy$\"; \nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': regex ,  'valueType': 're' },{ 'property': 'state' ,  'logic': 'is' , 'value': \"on\" ,  'valueType': 'str' }];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object},\n    \"entity\": msg.entity,\n    \"room\": room,\n    \"lights\": msg.lights\n\n}\nreturn msg;\n\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1850,"y":300,"wires":[["cb125f4b50582619"]]},{"id":"57b7936054b0b5cc","type":"comment","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Send down if events","info":"","x":1230,"y":240,"wires":[]},{"id":"d5e2a24c6ce71e38","type":"comment","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Up if no party","info":"","x":1370,"y":160,"wires":[]},{"id":"cf8ff618865df435","type":"comment","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Turn the lights off","info":"","x":2800,"y":160,"wires":[]},{"id":"1189f4b6f680b126","type":"comment","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Set entity","info":"","x":2600,"y":160,"wires":[]},{"id":"9c396755fe1cb910","type":"comment","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Make sure the array is empty","info":"","x":2380,"y":160,"wires":[]},{"id":"c7f2980adaee37b4","type":"comment","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Get motion on entities in an array","info":"","x":2110,"y":160,"wires":[]},{"id":"f0de34106b389b4a","type":"comment","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Prepare regex to check if another motion sensor is on in the room","info":"","x":1730,"y":160,"wires":[]},{"id":"27cd90e7ad99d55c","type":"comment","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Move payload to lights","info":"","x":960,"y":160,"wires":[]},{"id":"6131a2c1c3af7050","type":"comment","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Get on light entities","info":"","x":770,"y":160,"wires":[]},{"id":"e8e8db56dab8adcc","type":"comment","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Generate the regex for the get entity node","info":"","x":500,"y":160,"wires":[]},{"id":"0cb211a18508e0ab","type":"api-call-service","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"{\"transition\": 30}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2810,"y":200,"wires":[[]]},{"id":"342cb1090e8f530b","type":"change","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"rules","rules":[{"t":"move","p":"lights.entity_id","pt":"msg","to":"payload.data.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2590,"y":200,"wires":[["0cb211a18508e0ab"]]},{"id":"a87e55e132644e6c","type":"switch","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"","property":"payload.results","propertyType":"msg","rules":[{"t":"empty"}],"checkall":"true","repair":false,"outputs":1,"x":2370,"y":200,"wires":[["342cb1090e8f530b"]]},{"id":"ad814cbe9abc19f5","type":"ha-get-entities","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Get entities","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"array","output_empty_results":true,"output_location_type":"msg","output_location":"payload.results","output_results_count":1,"x":2090,"y":200,"wires":[["a87e55e132644e6c"]]},{"id":"21add955f677d2b7","type":"function","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"prepare Regex to check other motion sensors","func":"var room = msg.room\nvar regex = \"binary_sensor\\.*\" + room + \".*_occupancy$\"; \nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': regex ,  'valueType': 're' },{ 'property': 'state' ,  'logic': 'is' , 'value': \"on\" ,  'valueType': 'str' }];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object},\n    \"entity\": msg.entity,\n    \"room\": room,\n    \"lights\": msg.lights\n\n}\nreturn msg;\n\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1670,"y":200,"wires":[["ad814cbe9abc19f5"]]},{"id":"2080c99162556dc0","type":"change","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"rules","rules":[{"t":"move","p":"payload","pt":"msg","to":"lights","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":950,"y":200,"wires":[["4be0a0aa026d1431"]]},{"id":"57eb4ea18bc4f55b","type":"ha-get-entities","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Get entities","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload.results","output_results_count":1,"x":790,"y":200,"wires":[["2080c99162556dc0"]]},{"id":"5dbfe54c1c9e0349","type":"function","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Extract room from motion sensor entity an extract on lights to regex","func":"var motion_entity_id = msg.data.event.new_state.entity_id; // binary_sensor.sensor_bedroom_motion_occupancy\nvar motion_entity_id_split = motion_entity_id.split(\".\");// split on the dot to separate domain and entity\nvar motion_entity_id_wihtout_binary = motion_entity_id_split[1].replace(\"sensor_\", \"\").replace(\"_motion\", \"\").replace(\"_fp1\", \"\").replace(\"_presence\", \"\").replace(\"_occupancy\", \"\").replace(\"_entry\", \"\").replace(\"_exit\", \"\");// remove sensor_ and more substrings\nvar regex = \"^light\\\\.(?!.*?group.*?)(?!.*?lights.*?).*\" + motion_entity_id_wihtout_binary + \".*\"; \nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': regex ,  'valueType': 're' },{ 'property': 'state' ,  'logic': 'is' , 'value': \"on\" ,  'valueType': 'str' }];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object},\"room\": motion_entity_id_wihtout_binary\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":460,"y":200,"wires":[["57eb4ea18bc4f55b"]]},{"id":"054470e44aa3f1ca","type":"api-current-state","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Acid off?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.acid_time","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1220,"y":200,"wires":[["92bb7dc9357b96d3"],["d22cea5a615c3b79"]]},{"id":"92bb7dc9357b96d3","type":"api-current-state","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Party off?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.party_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1380,"y":200,"wires":[["33b091aa899cef65"],["ee596aba36f6626b"]]},{"id":"4be0a0aa026d1431","type":"api-current-state","z":"9e515b8aa75a9cdd","g":"824fe4cb22842d7f","name":"Kink Off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.kink_party","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1080,"y":200,"wires":[["054470e44aa3f1ca"],["d22cea5a615c3b79"]]},{"id":"07f7293b7c3a192f","type":"function","z":"61f53235c712b2c2","name":"Extract room from dial mqtt name and set regex to find chromecast playing","func":"var friendlyName = msg.payload.device.friendlyName; // Extract dial name\nvar room = friendlyName.replace(\"remote_\", \"\").replace(\"_dial\", \"\"); // Extract room from the name\n\n// This statement is used to allow for sub-locations in a room while controling the main room.\n// I.e: remote_livingroom_library_dial. \nif (!room.includes('hotbox')) { // Continue if the room does not containt \"hotbox\"\n    var roomtemp = room.split(\"_\"); // This is due to hotbox having two real variations of room\n    var roomfinal = roomtemp[0];\n} else {\n\n    var roomfinal = room;\n\n}\n\n\nvar action = msg.payload.action;\n\nconst rules_object = [{ 'property': 'entity_id', 'logic': 'is', 'value': \"media_player.\" + roomfinal + \"_chromecast\", 'valueType': 're' }, { 'property': 'state', 'logic': 'is', 'value': \"playing\", 'valueType': 'str' }];// arranges the array \n\nvar msg = {\n    \"payload\": { \"rules\": rules_object },\n    \"action\": action,\n    \"room\": roomfinal\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":460,"wires":[["65bbd1edeb04d721"]]},{"id":"742b96a2b1b4120a","type":"switch","z":"61f53235c712b2c2","name":"payload.action","property":"payload.action","propertyType":"msg","rules":[{"t":"neq","v":"","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":420,"y":380,"wires":[["07f7293b7c3a192f","4845c56f97d82d67"]]},{"id":"65bbd1edeb04d721","type":"ha-get-entities","z":"61f53235c712b2c2","name":"","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"array","output_empty_results":true,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":710,"y":460,"wires":[["7be1bf0ef08bc768"]]},{"id":"4845c56f97d82d67","type":"debug","z":"61f53235c712b2c2","name":"debug 235","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload.action","statusType":"msg","x":650,"y":380,"wires":[]},{"id":"7be1bf0ef08bc768","type":"switch","z":"61f53235c712b2c2","name":"Device present?","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"empty"}],"checkall":"true","repair":false,"outputs":2,"x":880,"y":460,"wires":[["4436a1073341508d"],["f3f29a6cf62e7a70"]]},{"id":"4436a1073341508d","type":"switch","z":"61f53235c712b2c2","name":"muted?","property":"payload[0].attributes.is_volume_muted","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":1060,"y":440,"wires":[["6bb3a63bfd0b412a"],["f3f29a6cf62e7a70"]]},{"id":"0c1b60d4aa369d17","type":"function","z":"61f53235c712b2c2","name":"Extract room from dial mqtt name and set regex to find speaker playing","func":"\nvar room = msg.room\nvar action = msg.action\n\nconst rules_object = [{ 'property': 'entity_id', 'logic': 'is', 'value': \"media_player.\" + room + \".*_speaker\", 'valueType': 're' }, { 'property': 'state', 'logic': 'is_not', 'value': \"off\", 'valueType': 'str' }, { 'property': 'state', 'logic': 'is_not', 'value': \"unavailable\", 'valueType': 'str' }];// arranges the array \n\nvar msg = {\n    \"payload\": { \"rules\": rules_object },\n    \"action\": action,\n    \"room\": room\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":520,"wires":[["87eea193a71c5e26"]]},{"id":"87eea193a71c5e26","type":"ha-get-entities","z":"61f53235c712b2c2","name":"","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"array","output_empty_results":true,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":710,"y":520,"wires":[["81327bcae584da8b"]]},{"id":"f89ba43362873342","type":"split","z":"61f53235c712b2c2","name":"Split entities","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1430,"y":460,"wires":[["3b6018d9b165a899"]]},{"id":"81327bcae584da8b","type":"switch","z":"61f53235c712b2c2","name":"Device present?","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"empty"}],"checkall":"true","repair":false,"outputs":2,"x":880,"y":520,"wires":[["647aae16977d9144"],["859d7a5dde62e6c6"]]},{"id":"4c8e690b1892a0a9","type":"switch","z":"61f53235c712b2c2","name":"muted?","property":"payload[0].attributes.is_volume_muted","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":1520,"y":520,"wires":[["f89ba43362873342"],["713a5335cf4987bb"]]},{"id":"3b6018d9b165a899","type":"change","z":"61f53235c712b2c2","name":"set entity data","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1620,"y":460,"wires":[["99fe0d18c6a94e7f"]]},{"id":"99fe0d18c6a94e7f","type":"switch","z":"61f53235c712b2c2","name":"Light mode off?","property":"lightmode","propertyType":"flow","rules":[{"t":"neq","v":"1","vt":"num"},{"t":"null"},{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":3,"x":1800,"y":460,"wires":[["5f49b19ecc5e38ed"],["5f49b19ecc5e38ed"],["bf9990f86fd9442a"]]},{"id":"48add15e895426df","type":"switch","z":"61f53235c712b2c2","name":"paused?","property":"payload[0].state","propertyType":"msg","rules":[{"t":"eq","v":"playing","vt":"str"},{"t":"eq","v":"paused","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":1160,"y":520,"wires":[["6de941e9d76f7ae3"],["3182d5ee1e39bf21"]]},{"id":"bf9990f86fd9442a","type":"trigger","z":"61f53235c712b2c2","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"100","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1840,"y":560,"wires":[["bba89b49b1584747"]]},{"id":"c26958cde5989374","type":"switch","z":"61f53235c712b2c2","name":"Play_Pause action?","property":"action","propertyType":"msg","rules":[{"t":"eq","v":"play_pause","vt":"str"},{"t":"nnull"}],"checkall":"false","repair":false,"outputs":2,"x":1380,"y":560,"wires":[["8b54b3ae965ebbcd"],["8b54b3ae965ebbcd"]]},{"id":"bba89b49b1584747","type":"switch","z":"61f53235c712b2c2","name":"color mode off?","property":"colormode","propertyType":"flow","rules":[{"t":"neq","v":"1","vt":"num"},{"t":"null"},{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":3,"x":2020,"y":560,"wires":[["eaa515f1a15f77d1"],["eaa515f1a15f77d1"],["f89f77dde0e8de24"]]},{"id":"b216e70ab4eb7093","type":"switch","z":"61f53235c712b2c2","name":"","property":"action","propertyType":"msg","rules":[{"t":"eq","v":"brightness_move_up","vt":"str"},{"t":"eq","v":"brightness_stop","vt":"str"},{"t":"eq","v":"brightness_move_down","vt":"str"},{"t":"eq","v":"toggle","vt":"str"},{"t":"eq","v":"brightness_step_up","vt":"str"},{"t":"eq","v":"brightness_step_down","vt":"str"}],"checkall":"false","repair":false,"outputs":6,"x":2050,"y":300,"wires":[["7961a79594181df5"],["d520206ef541b665"],["18b5e5de26d134b1"],["c24ce2ad54fddd69"],["737ff08ed31ad10c"],["4c2a33cb968eed9b"]]},{"id":"eaa515f1a15f77d1","type":"switch","z":"61f53235c712b2c2","name":"","property":"action","propertyType":"msg","rules":[{"t":"neq","v":"","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":2170,"y":560,"wires":[["bf5c6594da39a02f"]]},{"id":"f89f77dde0e8de24","type":"switch","z":"61f53235c712b2c2","name":"","property":"action","propertyType":"msg","rules":[{"t":"eq","v":"brightness_step_down","vt":"str"},{"t":"eq","v":"brightness_step_up","vt":"str"},{"t":"eq","v":"toggle","vt":"str"},{"t":"eq","v":"brightness_move_up","vt":"str"},{"t":"eq","v":"brightness_stop","vt":"str"},{"t":"eq","v":"brightness_move_down","vt":"str"}],"checkall":"false","repair":false,"outputs":6,"x":2050,"y":740,"wires":[["eaa515f1a15f77d1"],["eaa515f1a15f77d1"],["eaa515f1a15f77d1"],["a41c78c268ae68e1"],["ebca25714c2400bc"],["cb9204b51127ee96"]]},{"id":"7961a79594181df5","type":"trigger","z":"61f53235c712b2c2","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"-500","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"topic","topic":"topic","outputs":1,"x":2420,"y":200,"wires":[["7955829f8be44016","3f512f8746cc79b0"]]},{"id":"d520206ef541b665","type":"change","z":"61f53235c712b2c2","name":"set reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"1","tot":"str","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":2240,"y":240,"wires":[["7961a79594181df5","18b5e5de26d134b1","3f512f8746cc79b0"]]},{"id":"18b5e5de26d134b1","type":"trigger","z":"61f53235c712b2c2","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"-250","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"topic","topic":"topic","outputs":1,"x":2420,"y":300,"wires":[["dd5e1f4abd32582f","3f512f8746cc79b0"]]},{"id":"c24ce2ad54fddd69","type":"api-call-service","z":"61f53235c712b2c2","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_play_pause","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2700,"y":360,"wires":[[]]},{"id":"737ff08ed31ad10c","type":"api-call-service","z":"61f53235c712b2c2","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_seek","areaId":[],"deviceId":[],"entityId":[],"data":"{\"seek_position\":56000}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2630,"y":400,"wires":[[]]},{"id":"4c2a33cb968eed9b","type":"change","z":"61f53235c712b2c2","name":"set flow light mode = 1","rules":[{"t":"set","p":"lightmode","pt":"flow","to":"1","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":2620,"y":440,"wires":[["8edb6145ec24d347"]]},{"id":"bf5c6594da39a02f","type":"function","z":"61f53235c712b2c2","name":"Extract room from dial mqtt name and set regex to find light groups","func":"\nvar room = msg.room;\nvar action = msg.action\n\nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': \"light.group_\" + room + \"_lights\" ,  'valueType': 're' }];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object},\n     \"action\": action,\n     \"room\": room\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2480,"y":560,"wires":[["1f0cb00de30ad6c3"]]},{"id":"a41c78c268ae68e1","type":"trigger","z":"61f53235c712b2c2","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"-200","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2420,"y":720,"wires":[["4ae159f103f4ee74","a3ab247c31bdc0df"]]},{"id":"ebca25714c2400bc","type":"change","z":"61f53235c712b2c2","name":"set reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"1","tot":"str","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":2240,"y":760,"wires":[["a41c78c268ae68e1","cb9204b51127ee96","a3ab247c31bdc0df"]]},{"id":"cb9204b51127ee96","type":"trigger","z":"61f53235c712b2c2","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"-200","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2420,"y":840,"wires":[["d159dbcf500c7cb7","a3ab247c31bdc0df"]]},{"id":"7955829f8be44016","type":"api-call-service","z":"61f53235c712b2c2","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_up","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2650,"y":180,"wires":[[]]},{"id":"3f512f8746cc79b0","type":"counter","z":"61f53235c712b2c2","name":"","init":"0","step":"1","lower":"","upper":"90","mode":"increment","outputs":"1","x":2600,"y":240,"wires":[["24728236389a3cc9"]]},{"id":"24728236389a3cc9","type":"switch","z":"61f53235c712b2c2","name":">85","property":"count","propertyType":"msg","rules":[{"t":"gt","v":"85","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":2730,"y":240,"wires":[["d520206ef541b665"]]},{"id":"dd5e1f4abd32582f","type":"api-call-service","z":"61f53235c712b2c2","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_down","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2680,"y":300,"wires":[[]]},{"id":"8edb6145ec24d347","type":"trigger","z":"61f53235c712b2c2","name":"","op1":"","op2":"0","op1type":"nul","op2type":"str","duration":"10","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"topic","topic":"topic","outputs":1,"x":2830,"y":440,"wires":[["b0e46dca748c6ddc"]]},{"id":"1f0cb00de30ad6c3","type":"ha-get-entities","z":"61f53235c712b2c2","name":"","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"array","output_empty_results":true,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":2830,"y":560,"wires":[["fd42450aadf64eda"]]},{"id":"aa058107bdfceb22","type":"inject","z":"61f53235c712b2c2","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":2280,"y":620,"wires":[["a41c78c268ae68e1"]]},{"id":"4ae159f103f4ee74","type":"function","z":"61f53235c712b2c2","name":"Extract room from motion sensor entity an extract off lights to regex","func":"var room = msg.room;\n\n\nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': \"light.\" + room ,  'valueType': 're' }];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object}\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2800,"y":720,"wires":[["b25e8143fa4d8874"]]},{"id":"a3ab247c31bdc0df","type":"counter","z":"61f53235c712b2c2","name":"","init":"0","step":"1","lower":"","upper":"90","mode":"increment","outputs":"1","x":2600,"y":760,"wires":[["6708ee8d3eb910e7"]]},{"id":"6708ee8d3eb910e7","type":"switch","z":"61f53235c712b2c2","name":">85","property":"count","propertyType":"msg","rules":[{"t":"gt","v":"85","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":2730,"y":760,"wires":[["ebca25714c2400bc"]]},{"id":"d159dbcf500c7cb7","type":"function","z":"61f53235c712b2c2","name":"Extract room from motion sensor entity an extract off lights to regex","func":"var room = msg.room;\n\n\nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': \"light.\" + room ,  'valueType': 're' }];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object}\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2820,"y":820,"wires":[["d932d7b1da0b3a88"]]},{"id":"b0e46dca748c6ddc","type":"change","z":"61f53235c712b2c2","name":"set flow light mode = 0","rules":[{"t":"set","p":"lightmode","pt":"flow","to":"0","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":3040,"y":440,"wires":[[]]},{"id":"fd42450aadf64eda","type":"split","z":"61f53235c712b2c2","name":"Split entities","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":3010,"y":560,"wires":[["4d321cbea81bf743","bd30e32aaf14d76c"]]},{"id":"b25e8143fa4d8874","type":"ha-get-entities","z":"61f53235c712b2c2","name":"","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"","logic":"is","value":"","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":3170,"y":720,"wires":[["468750b6fd731ded"]]},{"id":"d932d7b1da0b3a88","type":"ha-get-entities","z":"61f53235c712b2c2","name":"","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"","logic":"is","value":"","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":3170,"y":820,"wires":[["c851296f54612985","e4431b323d4566e3"]]},{"id":"4d321cbea81bf743","type":"change","z":"61f53235c712b2c2","name":"set entity data","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":3200,"y":560,"wires":[["5e93c99868ac62e5","bc9de1d98ddfcebe"]]},{"id":"bd30e32aaf14d76c","type":"debug","z":"61f53235c712b2c2","name":"split entity","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3200,"y":620,"wires":[]},{"id":"c851296f54612985","type":"debug","z":"61f53235c712b2c2","name":"debug 236","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":3400,"y":860,"wires":[]},{"id":"5e93c99868ac62e5","type":"switch","z":"61f53235c712b2c2","name":"","property":"action","propertyType":"msg","rules":[{"t":"eq","v":"brightness_move_up","vt":"str"},{"t":"eq","v":"brightness_stop","vt":"str"},{"t":"eq","v":"brightness_move_down","vt":"str"},{"t":"eq","v":"toggle","vt":"str"},{"t":"eq","v":"brightness_step_up","vt":"str"},{"t":"eq","v":"brightness_step_down","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":3370,"y":560,"wires":[["ab2ae66947c9e0a9"],["0f507c526a007761"],["59638104d32b1dc4"],["3ad8701cca8d0c79","bc9de1d98ddfcebe"],["67ab8f7be97d8e0d"],["74c3d49ef9e95fb1"]]},{"id":"bc9de1d98ddfcebe","type":"debug","z":"61f53235c712b2c2","name":"debug 237","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":3370,"y":680,"wires":[]},{"id":"468750b6fd731ded","type":"function","z":"61f53235c712b2c2","name":"hue addist","func":"// Declare variation\nvar saturation = msg.payload.attributes.hs_color[1];\nvar hue = msg.payload.attributes.hs_color[0];\nvar entity_id = msg.payload.entity_id;\n\n// If saturation is over 10\nif (hue > 0 & hue < 340) {\n    var hueadded = hue + 36;\n} else if (saturation > 340) {// If saturation is pver 340\n\n    var hueadded = 1;\n}\nelse {\n    var hueadded = 1;\n}\n\n\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"hs_color\": [hueadded, saturation],\n            \"entity_id\": entity_id\n        }\n    }\n\n}\n\nreturn newMsg;\n\n\n","outputs":1,"noerr":3,"initialize":"","finalize":"","libs":[],"x":3790,"y":720,"wires":[["e8dc959562677d0a","45288af903bed0af"]]},{"id":"e4431b323d4566e3","type":"function","z":"61f53235c712b2c2","name":"hue addist","func":"// Declare variation\nvar saturation = msg.payload.attributes.hs_color[1];\nvar hue = msg.payload.attributes.hs_color[0];\nvar entity_id = msg.payload.entity_id;\n\n// If saturation is over 10\nif ( hue > 30 ) {\n    var hueadded = hue -36;\n} else if (saturation < 30) {// If saturation is pver 340\n\n    var hueadded = 360;\n}\nelse {\n    var hueadded = 360;\n}\n\n\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"hs_color\": [hueadded, saturation],\n            \"entity_id\": entity_id\n        }\n    }\n\n}\n\nreturn newMsg;\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3810,"y":820,"wires":[["45288af903bed0af","7e255b1f7744e9d3"]]},{"id":"ab2ae66947c9e0a9","type":"trigger","z":"61f53235c712b2c2","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"-700","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"topic","topic":"topic","outputs":1,"x":3760,"y":400,"wires":[["fc011ea0daee2197","7c6f78881e8754be"]]},{"id":"0f507c526a007761","type":"change","z":"61f53235c712b2c2","name":"set reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"1","tot":"str","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":3560,"y":440,"wires":[["ab2ae66947c9e0a9","59638104d32b1dc4","7c6f78881e8754be"]]},{"id":"59638104d32b1dc4","type":"trigger","z":"61f53235c712b2c2","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"-400","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"topic","topic":"topic","outputs":1,"x":3760,"y":480,"wires":[["977af5ec0eb2b765","7c6f78881e8754be"]]},{"id":"3ad8701cca8d0c79","type":"api-call-service","z":"61f53235c712b2c2","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"toggle","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3730,"y":540,"wires":[[]]},{"id":"67ab8f7be97d8e0d","type":"api-call-service","z":"61f53235c712b2c2","name":"Max white brightness","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"brightness_pct\": 100,\"color_name\": \"white\"}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3740,"y":580,"wires":[[]]},{"id":"74c3d49ef9e95fb1","type":"switch","z":"61f53235c712b2c2","name":"Color Saturation","property":"payload.attributes.hs_color[0]","propertyType":"msg","rules":[{"t":"null"},{"t":"lt","v":"20","vt":"str"},{"t":"gt","v":"20","vt":"str"}],"checkall":"false","repair":false,"outputs":3,"x":3540,"y":640,"wires":[["7857bf2fb4bf7239","0c893a47014584c3"],["7857bf2fb4bf7239","0c893a47014584c3"],["0c893a47014584c3"]]},{"id":"e8dc959562677d0a","type":"debug","z":"61f53235c712b2c2","name":"debug 238","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":4150,"y":720,"wires":[]},{"id":"45288af903bed0af","type":"api-call-service","z":"61f53235c712b2c2","name":"Hue light turn on","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{ \"transition\": 0.18 }","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4000,"y":760,"wires":[["7e255b1f7744e9d3"]]},{"id":"7e255b1f7744e9d3","type":"debug","z":"61f53235c712b2c2","name":"debug 239","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":4170,"y":820,"wires":[]},{"id":"fc011ea0daee2197","type":"function","z":"61f53235c712b2c2","name":"Extract room from motion sensor entity an extract off lights to regex","func":"var room = msg.room;\n\n\nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': \"light.\" + room ,  'valueType': 're' }];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object}\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3740,"y":340,"wires":[["2512d761e82f4e28","ab9c1c7bb2f218d0"]]},{"id":"7c6f78881e8754be","type":"counter","z":"61f53235c712b2c2","name":"","init":"0","step":"1","lower":"","upper":"90","mode":"increment","outputs":"1","x":3980,"y":440,"wires":[["2ac62bc0de2ab3ab"]]},{"id":"2ac62bc0de2ab3ab","type":"switch","z":"61f53235c712b2c2","name":">85","property":"count","propertyType":"msg","rules":[{"t":"gt","v":"85","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":4110,"y":440,"wires":[["0f507c526a007761"]]},{"id":"977af5ec0eb2b765","type":"api-call-service","z":"61f53235c712b2c2","name":"Dim light","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"brightness_step_pct\": -10}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4100,"y":480,"wires":[[]]},{"id":"7857bf2fb4bf7239","type":"function","z":"61f53235c712b2c2","name":"Generate Random saturated color","func":"var entity_id = msg.payload.entity_id;\n\n\nvar hue = Math.floor(Math.random() * 360); //generate a random number up to 360\n\nvar hs_color = hue + \",60\";\nvar hs_color_array = hs_color.split(\",\");\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"hs_color\": hs_color_array,\n            \"entity_id\": entity_id,\n            \"brightness_pct\": 100\n            \n}\n        }\n    }\n;\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3780,"y":620,"wires":[["22fa41fc09e6f983"]]},{"id":"0c893a47014584c3","type":"change","z":"61f53235c712b2c2","name":"set flow color mode = 1","rules":[{"t":"set","p":"colormode","pt":"flow","to":"1","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":3770,"y":660,"wires":[["3ff4f846f81bd2ed"]]},{"id":"2512d761e82f4e28","type":"debug","z":"61f53235c712b2c2","name":"debug 240","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":4130,"y":380,"wires":[]},{"id":"ab9c1c7bb2f218d0","type":"ha-get-entities","z":"61f53235c712b2c2","name":"","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"","logic":"is","value":"","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":4100,"y":340,"wires":[["a1a80d7b6860d899","500b6b719fd56a38"]]},{"id":"22fa41fc09e6f983","type":"api-call-service","z":"61f53235c712b2c2","name":"Select random color on light","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4080,"y":620,"wires":[[]]},{"id":"3ff4f846f81bd2ed","type":"trigger","z":"61f53235c712b2c2","name":"","op1":"","op2":"0","op1type":"nul","op2type":"str","duration":"20","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"topic","topic":"topic","outputs":1,"x":3990,"y":660,"wires":[["f4903c744e4d275f"]]},{"id":"a1a80d7b6860d899","type":"trigger","z":"61f53235c712b2c2","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"600","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"topic","topic":"payload.entity_id","outputs":1,"x":4320,"y":320,"wires":[["4605af7916ae49c9"]]},{"id":"500b6b719fd56a38","type":"debug","z":"61f53235c712b2c2","name":"debug 241","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":4320,"y":360,"wires":[]},{"id":"f4903c744e4d275f","type":"change","z":"61f53235c712b2c2","name":"set flow color mode = 0","rules":[{"t":"set","p":"colormode","pt":"flow","to":"0","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":4190,"y":660,"wires":[[]]},{"id":"4605af7916ae49c9","type":"switch","z":"61f53235c712b2c2","name":"Brightness?","property":"payload.attributes.brightness","propertyType":"msg","rules":[{"t":"null"},{"t":"lt","v":"250","vt":"str"},{"t":"gte","v":"250","vt":"str"}],"checkall":"false","repair":false,"outputs":3,"x":4510,"y":360,"wires":[["491869fea5c3b20d"],["491869fea5c3b20d"],["2c594fd1e6f5b171","43d53cc0a8cc05dd"]]},{"id":"491869fea5c3b20d","type":"change","z":"61f53235c712b2c2","name":"set entity","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":4680,"y":360,"wires":[["fec40b68f8d402aa"]]},{"id":"2c594fd1e6f5b171","type":"debug","z":"61f53235c712b2c2","name":"debug 242","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":4680,"y":400,"wires":[]},{"id":"43d53cc0a8cc05dd","type":"function","z":"61f53235c712b2c2","name":"White addist","func":"// Declare variation\nvar saturation = msg.payload.attributes.hs_color[1];\nvar colorfinal = msg.payload.attributes.hs_color[0];\nvar entity_id = msg.payload.entity_id;\n\n// If saturation is over 10\nif(saturation > 10){\nvar saturationlesser = saturation - 20;\n} else if(saturation < 20){// If saturation is under 10\nvar saturationlesser = 0;\nvar colorfinal = 0;\n}\n else {\nvar saturationlesser = saturation;}\n\n\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n            \"data\": {\n            \"hs_color\": [colorfinal, saturationlesser],\n            \"entity_id\": entity_id\n            }\n            }\n            \n   }\n\nreturn newMsg;\n\n\n","outputs":1,"noerr":2,"initialize":"","finalize":"","libs":[],"x":4690,"y":440,"wires":[["15af5b3f5b006434","8f1c1a404eaeb9c7"]]},{"id":"fec40b68f8d402aa","type":"api-call-service","z":"61f53235c712b2c2","name":"Brightnen light","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"brightness_step_pct\": 30}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4920,"y":360,"wires":[[]]},{"id":"15af5b3f5b006434","type":"debug","z":"61f53235c712b2c2","name":"debug 243","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4900,"y":400,"wires":[]},{"id":"8f1c1a404eaeb9c7","type":"api-call-service","z":"61f53235c712b2c2","name":"Add white","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4900,"y":440,"wires":[[]]},{"id":"c642d4b35542afe3","type":"comment","z":"61f53235c712b2c2","name":"v3","info":"","x":2210,"y":140,"wires":[]},{"id":"bfbfd266d4db3ff6","type":"trigger","z":"233ac7dcd801a802","name":"Lights fuse","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"10","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":470,"y":900,"wires":[["501ccf2f095f6e5e"]]},{"id":"d7fadd0a9fdb8db7","type":"switch","z":"233ac7dcd801a802","name":"","property":"message","propertyType":"msg","rules":[{"t":"nempty"}],"checkall":"true","repair":false,"outputs":1,"x":510,"y":1020,"wires":[["93abfd0faa549add"]]},{"id":"2d00197d6062613a","type":"trigger","z":"233ac7dcd801a802","name":"Broadcast fuse","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"10","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":340,"y":1020,"wires":[["d7fadd0a9fdb8db7"]]},{"id":"2fad2062613570e7","type":"trigger","z":"233ac7dcd801a802","name":"TV Fuse","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"10","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":320,"y":740,"wires":[["f62429ddd9325d05"]]},{"id":"366af0d006ca31e2","type":"switch","z":"233ac7dcd801a802","name":"","property":"color_value","propertyType":"msg","rules":[{"t":"nempty"}],"checkall":"true","repair":false,"outputs":1,"x":310,"y":900,"wires":[["bfbfd266d4db3ff6"]]},{"id":"661df899720949f1","type":"api-current-state","z":"233ac7dcd801a802","name":"Party","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.party_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":810,"y":740,"wires":[["e5f747d046dbfbf3"],[]]},{"id":"09496c934e88c4f4","type":"api-current-state","z":"233ac7dcd801a802","name":"Party","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.kink_party","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":630,"y":740,"wires":[["661df899720949f1"],[]]},{"id":"f62429ddd9325d05","type":"switch","z":"233ac7dcd801a802","name":"","property":"video","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":470,"y":740,"wires":[["09496c934e88c4f4"]]},{"id":"aae981aced5c3ffa","type":"function","z":"233ac7dcd801a802","name":" Set payload for play media ","func":"var msg = {\n    \"payload\":\n      {\"data\": {\n      \"message\":  msg.message\n}}\n\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1100,"y":1020,"wires":[["61a99395152c0e79"]]},{"id":"a8a6083a8c86c955","type":"ha-get-entities","z":"233ac7dcd801a802","name":"Get Lights","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1610,"y":900,"wires":[["034a2839d16f1399"]]},{"id":"034a2839d16f1399","type":"switch","z":"233ac7dcd801a802","name":"Check color support","property":"payload.attributes.supported_color_modes","propertyType":"msg","rules":[{"t":"cont","v":"xy","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1840,"y":900,"wires":[["7f4b36bf2feb4669"]]},{"id":"7f4b36bf2feb4669","type":"switch","z":"233ac7dcd801a802","name":"Check initial light state","property":"payload.state","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":2080,"y":900,"wires":[["b44c7449af1ef506"],["78c8f3f8edd7aa43"]]},{"id":"07ecb0bec4f1f33d","type":"comment","z":"233ac7dcd801a802","name":"Pull all notification  lights","info":"","x":1610,"y":860,"wires":[]},{"id":"beacf96bb661fbc2","type":"comment","z":"233ac7dcd801a802","name":"Check if they support color","info":"","x":1850,"y":860,"wires":[]},{"id":"e34bfbd72ae412d4","type":"api-call-service","z":"233ac7dcd801a802","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"brightness_pct\": \"100\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2520,"y":860,"wires":[["dc4a72805e937312"]]},{"id":"b44c7449af1ef506","type":"change","z":"233ac7dcd801a802","name":"Set desired Values","rules":[{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"color_value","tot":"msg","dc":true},{"t":"set","p":"payload.data.brightness_pct","pt":"msg","to":"dbrigthness","tot":"msg","dc":true},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2310,"y":860,"wires":[["e34bfbd72ae412d4"]]},{"id":"b71d1ddde35c7c33","type":"change","z":"233ac7dcd801a802","name":"Set Initial color","rules":[{"t":"delete","p":"payload.data.brightness_pct","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"payload.attributes.rgb_color","tot":"msg","dc":true},{"t":"set","p":"payload.data.brightness","pt":"msg","to":"payload.attributes.brightness","tot":"msg","dc":true},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":3000,"y":860,"wires":[["7068646d68382b1f"]]},{"id":"7068646d68382b1f","type":"api-call-service","z":"233ac7dcd801a802","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3220,"y":860,"wires":[[]]},{"id":"dc4a72805e937312","type":"delay","z":"233ac7dcd801a802","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":2780,"y":860,"wires":[["b71d1ddde35c7c33"]]},{"id":"b00729f34334e07c","type":"api-call-service","z":"233ac7dcd801a802","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2520,"y":940,"wires":[["70258176652e91f7"]]},{"id":"78c8f3f8edd7aa43","type":"change","z":"233ac7dcd801a802","name":"Set desired Values","rules":[{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"color_value","tot":"msg","dc":true},{"t":"set","p":"payload.data.brightness_pct","pt":"msg","to":"dbrigthness","tot":"msg","dc":true},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2310,"y":940,"wires":[["b00729f34334e07c"]]},{"id":"0cede15e04a1f947","type":"api-call-service","z":"233ac7dcd801a802","name":"Turn off lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3200,"y":940,"wires":[[]]},{"id":"70258176652e91f7","type":"delay","z":"233ac7dcd801a802","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":2780,"y":940,"wires":[["3808b692f02d438e"]]},{"id":"3808b692f02d438e","type":"change","z":"233ac7dcd801a802","name":"Set entity","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true},{"t":"delete","p":"payload.data.rgb_color","pt":"msg"},{"t":"delete","p":"payload.data.brightness_pct","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":3000,"y":940,"wires":[["0cede15e04a1f947"]]},{"id":"acc1eafbadde8fb3","type":"api-call-service","z":"233ac7dcd801a802","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"google_assistant_sdk","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1600,"y":1020,"wires":[[]]},{"id":"93abfd0faa549add","type":"api-current-state","z":"233ac7dcd801a802","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.kink_party","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":760,"y":1020,"wires":[["aae981aced5c3ffa"],["b582a2a18525713b"]]},{"id":"6274bd5a24a8990c","type":"api-call-service","z":"233ac7dcd801a802","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"google_assistant_sdk","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2040,"y":1100,"wires":[["6384cc5b8ba49170"]]},{"id":"2420d649f87fe268","type":"function","z":"233ac7dcd801a802","name":" Set payload for play media on entrace speaker","func":"var msg = {\n    \"payload\":\n      {\"data\": {\n      \"message\":  msg.message,\n      \"target\": \"entrance speaker\"\n}}\n\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1500,"y":1100,"wires":[["be421a891fdd6f15"]]},{"id":"be421a891fdd6f15","type":"trigger","z":"233ac7dcd801a802","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"2","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1780,"y":1100,"wires":[["6274bd5a24a8990c"]]},{"id":"ab3a878cd76788e7","type":"comment","z":"233ac7dcd801a802","name":"500ms delay as the assistant callback seems to bug everything down","info":"","x":1340,"y":1060,"wires":[]},{"id":"b582a2a18525713b","type":"api-call-service","z":"233ac7dcd801a802","name":"set volume 100%","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.hallway_speaker"],"data":"{\"volume_level\": 10}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1070,"y":1100,"wires":[["2420d649f87fe268"]]},{"id":"6384cc5b8ba49170","type":"api-call-service","z":"233ac7dcd801a802","name":"set volume 30%","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.hallway_speaker"],"data":"{\"volume_level\": 3}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2300,"y":1100,"wires":[[]]},{"id":"e5f747d046dbfbf3","type":"ha-get-entities","z":"233ac7dcd801a802","name":"Get ChromecastMedia players","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.(?!plex)(?!universal)(?!template).*_chromecast","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1070,"y":740,"wires":[["510ab83303b80ac8","1133080bd8862adf"]]},{"id":"cfbadb26ab3a49b8","type":"api-call-service","z":"233ac7dcd801a802","name":"Cast reolink image","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"payload","valueType":"msg"}],"queue":"none","x":2330,"y":800,"wires":[["ca5954515a7ec187"]]},{"id":"510ab83303b80ac8","type":"switch","z":"233ac7dcd801a802","name":"state?","property":"payload.state","propertyType":"msg","rules":[{"t":"eq","v":"playing","vt":"str"},{"t":"nnull"}],"checkall":"false","repair":false,"outputs":2,"x":1370,"y":740,"wires":[["4ea111f694db215b"],["49b2ebacde4e2b78"]]},{"id":"68d023e456d1f241","type":"function","z":"233ac7dcd801a802","name":"Javascript","func":"var video_content = msg.video_content;\nvar entity_id = msg.payload.entity_id;\n\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n     \"media_content_id\": video_content,\n      \"media_content_type\": \"image/jpeg\",\n     \"entity_id\": entity_id\n}\n }\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2120,"y":800,"wires":[["cfbadb26ab3a49b8"]]},{"id":"4ea111f694db215b","type":"function","z":"233ac7dcd801a802","name":"Javascript","func":"var video_content = msg.video_content;\nvar entity_id = msg.payload.entity_id;\n\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n     \"entity_id\": entity_id\n}\n }\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1520,"y":700,"wires":[["19b2fc1b90249558"]]},{"id":"19b2fc1b90249558","type":"api-call-service","z":"233ac7dcd801a802","name":"Pause playback","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_pause","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"result","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1740,"y":700,"wires":[[]]},{"id":"61a99395152c0e79","type":"trigger","z":"233ac7dcd801a802","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"2","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1320,"y":1020,"wires":[["acc1eafbadde8fb3"]]},{"id":"dc0155064b773c80","type":"api-call-service","z":"233ac7dcd801a802","name":"Remove alert","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"result","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":3210,"y":800,"wires":[[]]},{"id":"ca5954515a7ec187","type":"trigger","z":"233ac7dcd801a802","name":"this seems to erase the payload to stop broadcast","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"50","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"topic","topic":"payload.data.entity_id","outputs":1,"x":2650,"y":800,"wires":[["9b6bcf1f5fd36ab7"]]},{"id":"9b6bcf1f5fd36ab7","type":"change","z":"233ac7dcd801a802","name":"remove inutile data","rules":[{"t":"delete","p":"payload.data.media_content_id","pt":"msg"},{"t":"delete","p":"payload.data.media_content_type","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2990,"y":800,"wires":[["dc0155064b773c80"]]},{"id":"1133080bd8862adf","type":"debug","z":"233ac7dcd801a802","name":"alert","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1250,"y":660,"wires":[]},{"id":"501ccf2f095f6e5e","type":"api-current-state","z":"233ac7dcd801a802","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.group_notifications_light","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":730,"y":900,"wires":[["619a4cb4268fdce3"]]},{"id":"619a4cb4268fdce3","type":"change","z":"233ac7dcd801a802","name":"","rules":[{"t":"move","p":"data.attributes.entity_id","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1080,"y":900,"wires":[["2360bef1740d080b"]]},{"id":"2360bef1740d080b","type":"split","z":"233ac7dcd801a802","name":"Split entities","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1310,"y":900,"wires":[["662f49db343cd0e4"]]},{"id":"662f49db343cd0e4","type":"function","z":"233ac7dcd801a802","name":"Set rules","func":"var entity_id = msg.payload;\nvar color_value = msg.color_value;\n\nconst rules_object = [{ 'property': 'entity_id', 'logic': 'is', 'value': entity_id, 'valueType': 're' }];// arranges the array \n\nvar msg = {\n    \"payload\": { \"rules\": rules_object }, \"color_value\": color_value\n\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1460,"y":900,"wires":[["a8a6083a8c86c955"]]},{"id":"c510434f2402e986","type":"ha-get-entities","z":"233ac7dcd801a802","name":"Get ChromecastMedia players","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.(?!plex)(?!universal)(?!template).*_tv","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1630,"y":760,"wires":[["68d023e456d1f241"]]},{"id":"11f21ab76a3a546b","type":"debug","z":"dfb97c6505f003d9","name":"test ici 2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2540,"y":500,"wires":[]},{"id":"ac96ceaf6db5e36c","type":"delay","z":"dfb97c6505f003d9","name":"Lights","pauseType":"rate","timeout":"1","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":330,"y":700,"wires":[["07dc2e9ad30b5777","e6854572b01c4317","158b49848844d1b0","2a9ca44eddcc7884","a28f7b4e5938455a","79b5832995dc742f"]]},{"id":"07dc2e9ad30b5777","type":"api-current-state","z":"dfb97c6505f003d9","name":"light.patio","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.patio_notification_light","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"status","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_old","propertyType":"msg","value":"","valueType":"entity"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":500,"y":960,"wires":[["7f74db0678fe88b5"]],"outputLabels":["data.attributes"]},{"id":"e6854572b01c4317","type":"api-current-state","z":"dfb97c6505f003d9","name":"light.hotbox_lights","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.hotbox_lights","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"status","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_old","propertyType":"msg","value":"","valueType":"entity"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":530,"y":880,"wires":[["322fdae5fabd2958"]],"outputLabels":["data.attributes"]},{"id":"158b49848844d1b0","type":"api-current-state","z":"dfb97c6505f003d9","name":"light.kitchen_lights","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.group_kitchen_lights","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"status","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_old","propertyType":"msg","value":"","valueType":"entity"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":530,"y":800,"wires":[["e95dc67ec2ac1da0"]],"outputLabels":["data.attributes"]},{"id":"2a9ca44eddcc7884","type":"api-current-state","z":"dfb97c6505f003d9","name":"light.entrance_in","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.group_entrance_lights","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"status","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_old","propertyType":"msg","value":"","valueType":"entity"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":520,"y":720,"wires":[["1071993451a1b643"]],"outputLabels":["data.attributes"]},{"id":"7f74db0678fe88b5","type":"change","z":"dfb97c6505f003d9","name":"rules","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"color_value","tot":"msg"},{"t":"set","p":"payload.data.brightness_pct","pt":"msg","to":"dbrigthness","tot":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":710,"y":960,"wires":[["93cc7873913fe128"]]},{"id":"322fdae5fabd2958","type":"change","z":"dfb97c6505f003d9","name":"rules","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"color_value","tot":"msg"},{"t":"set","p":"payload.data.brightness_pct","pt":"msg","to":"dbrigthness","tot":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":710,"y":880,"wires":[["a4b755ee5b36c49c"]]},{"id":"e95dc67ec2ac1da0","type":"change","z":"dfb97c6505f003d9","name":"rules","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"color_value","tot":"msg"},{"t":"set","p":"payload.data.brightness_pct","pt":"msg","to":"dbrigthness","tot":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":710,"y":800,"wires":[["810f3685e8436eda"]]},{"id":"1071993451a1b643","type":"change","z":"dfb97c6505f003d9","name":"rules","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"color_value","tot":"msg"},{"t":"set","p":"payload.data.brightness_pct","pt":"msg","to":"dbrigthness","tot":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":710,"y":720,"wires":[["4907adb9b35b3037"]]},{"id":"93cc7873913fe128","type":"api-call-service","z":"dfb97c6505f003d9","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":920,"y":960,"wires":[["29e689216c49f3db"]]},{"id":"a4b755ee5b36c49c","type":"api-call-service","z":"dfb97c6505f003d9","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":920,"y":880,"wires":[["a2ba28437ceb0e1a"]]},{"id":"810f3685e8436eda","type":"api-call-service","z":"dfb97c6505f003d9","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":920,"y":800,"wires":[["7cdd1d739d989e9f"]]},{"id":"4907adb9b35b3037","type":"api-call-service","z":"dfb97c6505f003d9","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":920,"y":720,"wires":[["5be63b0010fbf37e"]]},{"id":"29e689216c49f3db","type":"delay","z":"dfb97c6505f003d9","name":"","pauseType":"random","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"1","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1080,"y":960,"wires":[["a7cb77d8af35aa95"]]},{"id":"a2ba28437ceb0e1a","type":"delay","z":"dfb97c6505f003d9","name":"","pauseType":"random","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"1","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1080,"y":880,"wires":[["46fd7f4081e96254"]]},{"id":"7cdd1d739d989e9f","type":"delay","z":"dfb97c6505f003d9","name":"","pauseType":"random","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"1","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1080,"y":800,"wires":[["325804bf9f3917a8"]]},{"id":"5be63b0010fbf37e","type":"delay","z":"dfb97c6505f003d9","name":"","pauseType":"random","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"1","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1080,"y":720,"wires":[["9062ea12d3fd7fb7"]]},{"id":"a7cb77d8af35aa95","type":"change","z":"dfb97c6505f003d9","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"entity_old.attributes.rgb_color","tot":"msg"},{"t":"set","p":"payload.data.brightness","pt":"msg","to":"entity_old.attributes.brightness","tot":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1240,"y":960,"wires":[["f13be4bf5a0730a7"]]},{"id":"46fd7f4081e96254","type":"change","z":"dfb97c6505f003d9","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"entity_old.attributes.rgb_color","tot":"msg"},{"t":"set","p":"payload.data.brightness","pt":"msg","to":"entity_old.attributes.brightness","tot":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1240,"y":880,"wires":[["61dfbc1428636755"]]},{"id":"325804bf9f3917a8","type":"change","z":"dfb97c6505f003d9","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"entity_old.attributes.rgb_color","tot":"msg"},{"t":"set","p":"payload.data.brightness","pt":"msg","to":"entity_old.attributes.brightness","tot":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1240,"y":800,"wires":[["e4bef3e05a0edb82"]]},{"id":"9062ea12d3fd7fb7","type":"change","z":"dfb97c6505f003d9","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"entity_old.attributes.rgb_color","tot":"msg"},{"t":"set","p":"payload.data.brightness","pt":"msg","to":"entity_old.attributes.brightness","tot":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1240,"y":720,"wires":[["b61ba7719812f140"]]},{"id":"f13be4bf5a0730a7","type":"template","z":"dfb97c6505f003d9","name":"Extract status","field":"payload.service","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"\"turn_{{status}}\"","output":"json","x":1440,"y":960,"wires":[["e4926f5a6a42c3cf"]]},{"id":"61dfbc1428636755","type":"template","z":"dfb97c6505f003d9","name":"Extract status","field":"payload.service","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"\"turn_{{status}}\"","output":"json","x":1440,"y":880,"wires":[["a981a3acda3bf7f2"]]},{"id":"e4bef3e05a0edb82","type":"template","z":"dfb97c6505f003d9","name":"Extract status","field":"payload.service","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"\"turn_{{status}}\"","output":"json","x":1440,"y":800,"wires":[["1242d3d4030389f5"]]},{"id":"b61ba7719812f140","type":"template","z":"dfb97c6505f003d9","name":"Extract status","field":"payload.service","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"\"turn_{{status}}\"","output":"json","x":1440,"y":720,"wires":[["82ccf490a0bd5dbf"]]},{"id":"e4926f5a6a42c3cf","type":"api-call-service","z":"dfb97c6505f003d9","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1640,"y":960,"wires":[["2e686d1b8ac123ef"]]},{"id":"a981a3acda3bf7f2","type":"api-call-service","z":"dfb97c6505f003d9","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1640,"y":880,"wires":[["3fa979185b00a86c"]]},{"id":"1242d3d4030389f5","type":"api-call-service","z":"dfb97c6505f003d9","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1640,"y":800,"wires":[["a6453d0cdf185a00"]]},{"id":"82ccf490a0bd5dbf","type":"api-call-service","z":"dfb97c6505f003d9","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1640,"y":720,"wires":[["3dd2b1f3ac581194"]]},{"id":"593a650c23e05eda","type":"switch","z":"dfb97c6505f003d9","name":"!=rain","property":"data.attributes.rgb_color","propertyType":"msg","rules":[{"t":"eq","v":"color_value","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":1750,"y":920,"wires":[["e4926f5a6a42c3cf"]]},{"id":"2e686d1b8ac123ef","type":"api-current-state","z":"dfb97c6505f003d9","name":"light.patio","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.patio_notification_light","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1820,"y":960,"wires":[["593a650c23e05eda"]]},{"id":"8b669eb0ffc4fdc0","type":"switch","z":"dfb97c6505f003d9","name":"!=rain","property":"data.attributes.rgb_color","propertyType":"msg","rules":[{"t":"eq","v":"color_value","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":1750,"y":840,"wires":[["a981a3acda3bf7f2"]]},{"id":"3fa979185b00a86c","type":"api-current-state","z":"dfb97c6505f003d9","name":"light.hotbox_lights","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.hotbox_lights","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1850,"y":880,"wires":[["8b669eb0ffc4fdc0"]]},{"id":"4756af2cf9966227","type":"switch","z":"dfb97c6505f003d9","name":"!=rain","property":"data.attributes.rgb_color","propertyType":"msg","rules":[{"t":"eq","v":"color_value","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":1750,"y":760,"wires":[["1242d3d4030389f5"]]},{"id":"a6453d0cdf185a00","type":"api-current-state","z":"dfb97c6505f003d9","name":"light.kitchen_lights","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.group_kitchen_lights","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1850,"y":800,"wires":[["4756af2cf9966227"]]},{"id":"09de7d2338bffacc","type":"switch","z":"dfb97c6505f003d9","name":"!=rain","property":"data.attributes.rgb_color","propertyType":"msg","rules":[{"t":"eq","v":"color_value","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":1750,"y":680,"wires":[["82ccf490a0bd5dbf"]]},{"id":"3dd2b1f3ac581194","type":"api-current-state","z":"dfb97c6505f003d9","name":"light.entrance_in","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.group_entrance_lights","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1840,"y":720,"wires":[["09de7d2338bffacc"]]},{"id":"a28f7b4e5938455a","type":"api-current-state","z":"dfb97c6505f003d9","name":"light.livingroom_lights","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.group_livingroom_lights","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"status","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_old","propertyType":"msg","value":"","valueType":"entity"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":540,"y":640,"wires":[["f6eab789cbd882e3"]],"outputLabels":["data.attributes"]},{"id":"33a55975615f8545","type":"api-call-service","z":"dfb97c6505f003d9","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1640,"y":640,"wires":[["cc4c3fcc17a0914e"]]},{"id":"d4085f68174c73d8","type":"change","z":"dfb97c6505f003d9","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"entity_old.attributes.rgb_color","tot":"msg"},{"t":"set","p":"payload.data.brightness","pt":"msg","to":"entity_old.attributes.brightness","tot":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1240,"y":640,"wires":[["7921d8c3beb64e57"]]},{"id":"7921d8c3beb64e57","type":"template","z":"dfb97c6505f003d9","name":"Extract status","field":"payload.service","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"\"turn_{{status}}\"","output":"json","x":1440,"y":640,"wires":[["33a55975615f8545"]]},{"id":"da340bab1bfeabb6","type":"delay","z":"dfb97c6505f003d9","name":"","pauseType":"random","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"1","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1080,"y":640,"wires":[["d4085f68174c73d8"]]},{"id":"f6eab789cbd882e3","type":"change","z":"dfb97c6505f003d9","name":"rules","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"color_value","tot":"msg"},{"t":"set","p":"payload.data.brightness_pct","pt":"msg","to":"dbrigthness","tot":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":710,"y":640,"wires":[["d0e9bcb81e15c2e3"]]},{"id":"d0e9bcb81e15c2e3","type":"api-call-service","z":"dfb97c6505f003d9","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":920,"y":640,"wires":[["da340bab1bfeabb6"]]},{"id":"cc4c3fcc17a0914e","type":"api-current-state","z":"dfb97c6505f003d9","name":"light.livingroom_lights","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.group_livingroom_lights","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1860,"y":640,"wires":[["cb4d9f0c4110702b"]]},{"id":"cb4d9f0c4110702b","type":"switch","z":"dfb97c6505f003d9","name":"!=rain","property":"data.attributes.rgb_color","propertyType":"msg","rules":[{"t":"eq","v":"color_value","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":1750,"y":600,"wires":[["33a55975615f8545"]]},{"id":"8c7456abb749808a","type":"api-current-state","z":"dfb97c6505f003d9","name":"light.bedroom_lights","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.bedroom_lights","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"status","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_old","propertyType":"msg","value":"","valueType":"entity"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":1060,"y":560,"wires":[["37bcb81b399086ae","151efa7534923119"]],"outputLabels":["data.attributes"]},{"id":"56de61e0d809ba77","type":"api-call-service","z":"dfb97c6505f003d9","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2160,"y":560,"wires":[["895d6a84e56f8bfe","11f21ab76a3a546b"]]},{"id":"7912b9b681500142","type":"change","z":"dfb97c6505f003d9","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"entity_old.attributes.rgb_color","tot":"msg"},{"t":"set","p":"payload.data.brightness","pt":"msg","to":"entity_old.attributes.brightness","tot":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1760,"y":560,"wires":[["864c932a3c4c250b"]]},{"id":"864c932a3c4c250b","type":"template","z":"dfb97c6505f003d9","name":"Extract status","field":"payload.service","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"\"turn_{{status}}\"","output":"json","x":1960,"y":560,"wires":[["56de61e0d809ba77"]]},{"id":"fbaa2e568aba0ee0","type":"delay","z":"dfb97c6505f003d9","name":"","pauseType":"random","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"1","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1600,"y":560,"wires":[["7912b9b681500142"]]},{"id":"37bcb81b399086ae","type":"change","z":"dfb97c6505f003d9","name":"rules","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"color_value","tot":"msg"},{"t":"set","p":"payload.data.brightness_pct","pt":"msg","to":"dbrigthness","tot":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1230,"y":560,"wires":[["92e1ed806843cd80"]]},{"id":"92e1ed806843cd80","type":"api-call-service","z":"dfb97c6505f003d9","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1400,"y":560,"wires":[["fbaa2e568aba0ee0"]]},{"id":"895d6a84e56f8bfe","type":"api-current-state","z":"dfb97c6505f003d9","name":"light.bedroom_lights","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.bedroom_lights","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":2380,"y":560,"wires":[["9e0951868dbe15d2","11f21ab76a3a546b"]]},{"id":"9e0951868dbe15d2","type":"switch","z":"dfb97c6505f003d9","name":"!=rain","property":"data.attributes.rgb_color","propertyType":"msg","rules":[{"t":"eq","v":"color_value","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":2270,"y":520,"wires":[["56de61e0d809ba77"]]},{"id":"6402fc45aa975a92","type":"api-current-state","z":"dfb97c6505f003d9","name":"light.thierry","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.thierry","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"status","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_old","propertyType":"msg","value":"","valueType":"entity"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":530,"y":160,"wires":[["2a504003bec81b1e"]],"outputLabels":["data.attributes"]},{"id":"2a504003bec81b1e","type":"change","z":"dfb97c6505f003d9","name":"rules","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"color_value","tot":"msg"},{"t":"set","p":"payload.data.brightness_pct","pt":"msg","to":"dbrigthness","tot":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":730,"y":160,"wires":[["54c3cd8409cbec5b"]]},{"id":"54c3cd8409cbec5b","type":"api-call-service","z":"dfb97c6505f003d9","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":940,"y":160,"wires":[["1e0f35ee233412c3"]]},{"id":"1e0f35ee233412c3","type":"delay","z":"dfb97c6505f003d9","name":"","pauseType":"random","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"2","randomLast":"3","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1100,"y":160,"wires":[["fd54554c87c115e3"]]},{"id":"fd54554c87c115e3","type":"change","z":"dfb97c6505f003d9","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"entity_old.attributes.rgb_color","tot":"msg"},{"t":"set","p":"payload.data.brightness","pt":"msg","to":"entity_old.attributes.brightness","tot":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1260,"y":160,"wires":[["83717d1cae286c12"]]},{"id":"83717d1cae286c12","type":"template","z":"dfb97c6505f003d9","name":"Extract status","field":"payload.service","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"\"turn_{{status}}\"","output":"json","x":1460,"y":160,"wires":[["2f76e4ae9f417e7b"]]},{"id":"2f76e4ae9f417e7b","type":"api-call-service","z":"dfb97c6505f003d9","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1660,"y":160,"wires":[["2ca583cbae66cdd5"]]},{"id":"6da73629a705f36c","type":"switch","z":"dfb97c6505f003d9","name":"!=rain","property":"data.attributes.rgb_color","propertyType":"msg","rules":[{"t":"eq","v":"color_value","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":1770,"y":120,"wires":[["2f76e4ae9f417e7b"]]},{"id":"2ca583cbae66cdd5","type":"api-current-state","z":"dfb97c6505f003d9","name":"light.thierry","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.thierry","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1850,"y":160,"wires":[["6da73629a705f36c"]]},{"id":"79b5832995dc742f","type":"api-current-state","z":"dfb97c6505f003d9","name":"sleeping","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.maxi_sleeping","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":520,"y":560,"wires":[["8c7456abb749808a"],["759db47b11b97885"]],"outputLabels":["data.attributes",""]},{"id":"151efa7534923119","type":"debug","z":"dfb97c6505f003d9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1090,"y":500,"wires":[]},{"id":"759db47b11b97885","type":"switch","z":"dfb97c6505f003d9","name":"!=green","property":"color_name","propertyType":"msg","rules":[{"t":"neq","v":"green","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":840,"y":580,"wires":[["8c7456abb749808a"]]},{"id":"224349d2603c916d","type":"api-call-service","z":"eb3b6592c8406c0d","name":"cast to display","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":["media_player.livingroom_chromecast"],"data":"{\"media_content_type\":\"image\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1360,"y":300,"wires":[["c0dd1bf693615888"]]},{"id":"c0dd1bf693615888","type":"trigger","z":"eb3b6592c8406c0d","name":"","op1":"","op2":"1","op1type":"nul","op2type":"num","duration":"20","extend":false,"units":"s","reset":"closed","bytopic":"all","outputs":1,"x":1550,"y":300,"wires":[["f9563b83d9917e68"]]},{"id":"f9563b83d9917e68","type":"api-call-service","z":"eb3b6592c8406c0d","name":"change source","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"select_source","areaId":[],"deviceId":[],"entityId":["media_player.living_room_lg"],"data":"{\"source\":\"HDMI 2\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1720,"y":300,"wires":[[]]},{"id":"e34932fd524f4fc2","type":"api-current-state","z":"eb3b6592c8406c0d","name":"Hotbox TV?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"idle","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"media_player.hotbox_top_chromecast","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":810,"y":500,"wires":[["f1bc8dbc651cc925"],["e2cbd9ca626a07c0"]]},{"id":"f1bc8dbc651cc925","type":"change","z":"eb3b6592c8406c0d","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":980,"y":500,"wires":[["e22a4d57d9df6967"]]},{"id":"e2cbd9ca626a07c0","type":"api-call-service","z":"eb3b6592c8406c0d","name":"cast to display","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":["media_player.hotbox_top_chromecast"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":980,"y":540,"wires":[["389277edde2f7713"]]},{"id":"e22a4d57d9df6967","type":"api-call-service","z":"eb3b6592c8406c0d","name":"hotbox tv","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"media_pause","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"media_player.hotbox_tv\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1140,"y":500,"wires":[[]]},{"id":"389277edde2f7713","type":"trigger","z":"eb3b6592c8406c0d","name":"","op1":"","op2":"1","op1type":"nul","op2type":"num","duration":"20","extend":false,"units":"s","reset":"closed","bytopic":"all","outputs":1,"x":1150,"y":540,"wires":[["e8ac07aa3bb01b82"]]},{"id":"e8ac07aa3bb01b82","type":"api-call-service","z":"eb3b6592c8406c0d","name":"stop cast","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":["media_player.hotbox_top_chromecast"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1300,"y":540,"wires":[[]]},{"id":"707a9031aaac3456","type":"delay","z":"eb3b6592c8406c0d","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":550,"y":240,"wires":[["e34932fd524f4fc2","8ea772f3a7865a10","16559f64d09f6a4c","98921ce2a949a88f"]]},{"id":"8ea772f3a7865a10","type":"api-current-state","z":"eb3b6592c8406c0d","name":"Living Room  TV?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"playing","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.living_room_chromecast","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"input","propertyType":"msg","value":"","valueType":"entityState"}],"for":0,"forType":"num","forUnits":"minutes","x":810,"y":280,"wires":[["abca03ae387e14c4"],["7b5e66492d54fed8"]]},{"id":"9ca31051c3c34499","type":"api-current-state","z":"eb3b6592c8406c0d","name":"Patio TV?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"idle","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"media_player.patio_chromecast","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":1180,"y":160,"wires":[["a0030c9551cb7906"],["1df70d22a7b1e659"]]},{"id":"a0030c9551cb7906","type":"change","z":"eb3b6592c8406c0d","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1360,"y":160,"wires":[["baa39e8c2f86ee28"]]},{"id":"1df70d22a7b1e659","type":"api-call-service","z":"eb3b6592c8406c0d","name":"cast to display","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":["media_player.patio_chromecast"],"data":"{\"media_content_type\":\"image\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1360,"y":200,"wires":[["2dafd6dbb68cb168"]]},{"id":"baa39e8c2f86ee28","type":"api-call-service","z":"eb3b6592c8406c0d","name":"pause patio TV","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"media_pause","areaId":[],"deviceId":[],"entityId":["media_player.patio_chromecast"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1540,"y":160,"wires":[[]]},{"id":"2dafd6dbb68cb168","type":"trigger","z":"eb3b6592c8406c0d","name":"","op1":"","op2":"1","op1type":"nul","op2type":"num","duration":"40","extend":false,"overrideDelay":false,"units":"s","reset":"closed","bytopic":"all","topic":"topic","outputs":1,"x":1530,"y":200,"wires":[["1a1dba7b1cca12a0"]]},{"id":"1a1dba7b1cca12a0","type":"api-call-service","z":"eb3b6592c8406c0d","name":"stop cast","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":["media_player.patio_chromecast"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1680,"y":200,"wires":[[]]},{"id":"16559f64d09f6a4c","type":"api-current-state","z":"eb3b6592c8406c0d","name":"Patio tv?","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"media_player.patio_chromecast","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"input","propertyType":"msg","value":"","valueType":"entityState"}],"for":0,"forType":"num","forUnits":"minutes","x":860,"y":160,"wires":[["9ca31051c3c34499"]]},{"id":"98921ce2a949a88f","type":"api-current-state","z":"eb3b6592c8406c0d","name":"Bedroom TV?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"idle","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"media_player.bedroom_chromecast","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":840,"y":620,"wires":[["7a2d4a5d5aa8e751"],["51cda7c866f682df"]]},{"id":"7a2d4a5d5aa8e751","type":"change","z":"eb3b6592c8406c0d","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1020,"y":620,"wires":[["97b924081c955582"]]},{"id":"51cda7c866f682df","type":"api-call-service","z":"eb3b6592c8406c0d","name":"cast to display","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":["media_player.bedroom_chromecast"],"data":"{\"media_content_type\":\"image\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1020,"y":660,"wires":[["013846de371efed4"]]},{"id":"97b924081c955582","type":"api-call-service","z":"eb3b6592c8406c0d","name":"pause patio TV","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"media_pause","areaId":[],"deviceId":[],"entityId":["media_player.bedroom_chromecast"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1200,"y":620,"wires":[[]]},{"id":"013846de371efed4","type":"trigger","z":"eb3b6592c8406c0d","name":"","op1":"","op2":"1","op1type":"nul","op2type":"num","duration":"20","extend":false,"units":"s","reset":"closed","bytopic":"all","outputs":1,"x":1190,"y":660,"wires":[["5454772741f9301f"]]},{"id":"5454772741f9301f","type":"api-call-service","z":"eb3b6592c8406c0d","name":"stop cast","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":["media_player.bedroom_chromecast"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1340,"y":660,"wires":[[]]},{"id":"abca03ae387e14c4","type":"change","z":"eb3b6592c8406c0d","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1020,"y":260,"wires":[["23dc244ef1c23367"]]},{"id":"23dc244ef1c23367","type":"api-call-service","z":"eb3b6592c8406c0d","name":"pause living room tv","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"media_pause","areaId":[],"deviceId":[],"entityId":["media_player.living_room_chromecast"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1220,"y":260,"wires":[[]]},{"id":"7b5e66492d54fed8","type":"api-current-state","z":"eb3b6592c8406c0d","name":"Living Room LG?","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.living_room_lg","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"input","propertyType":"msg","value":"","valueType":"entityState"}],"for":0,"forType":"num","forUnits":"minutes","x":1030,"y":300,"wires":[["f045c367f79fa779"]]},{"id":"f045c367f79fa779","type":"switch","z":"eb3b6592c8406c0d","name":"","property":"payload.attributes.source","propertyType":"msg","rules":[{"t":"eq","v":"HDMI 2","vt":"str"},{"t":"neq","v":"HDMI 2","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1190,"y":300,"wires":[["224349d2603c916d"],["65b5586a5a9a4c80"]]},{"id":"65b5586a5a9a4c80","type":"api-call-service","z":"eb3b6592c8406c0d","name":"cast to display","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":["media_player.living_room_chromecast"],"data":"{\"media_content_type\":\"image\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1360,"y":340,"wires":[["0dde2d864d9d91ed"]]},{"id":"0dde2d864d9d91ed","type":"trigger","z":"eb3b6592c8406c0d","name":"","op1":"","op2":"1","op1type":"nul","op2type":"num","duration":"20","extend":false,"units":"s","reset":"closed","bytopic":"all","outputs":1,"x":1550,"y":340,"wires":[["4dc106bc3b4f42b6"]]},{"id":"4dc106bc3b4f42b6","type":"api-call-service","z":"eb3b6592c8406c0d","name":"stop","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_stop","areaId":[],"deviceId":[],"entityId":["media_player.living_room_chromecast"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1690,"y":340,"wires":[[]]},{"id":"7b4efdf6248d3f12","type":"server-state-changed","z":"3ad1e0957e6ec22e","name":"Users home?","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.user_home","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":110,"y":140,"wires":[["c567a425829271f3"],["6372d64da4e99c42"]]},{"id":"581fd4c7ce035d72","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"Set ACs to away preset","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"climate","service":"set_preset_mode","areaId":[],"deviceId":[],"entityId":["climate.bedroom_ac","climate.hotbox_ac","climate.living_room_ac"],"data":"{\"preset_mode\":\"away\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":530,"y":180,"wires":[[]]},{"id":"2f2e8679067c06af","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"Set ACs to default preset","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"climate","service":"set_preset_mode","areaId":[],"deviceId":[],"entityId":["climate.bedroom_ac","climate.hotbox_ac","climate.living_room_ac"],"data":"{\"preset_mode\":\"none\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":530,"y":100,"wires":[[]]},{"id":"1d937417c8d9abd4","type":"comment","z":"3ad1e0957e6ec22e","name":"Users Present","info":"","x":310,"y":100,"wires":[]},{"id":"2d9503bf28e52235","type":"comment","z":"3ad1e0957e6ec22e","name":"Users Absent","info":"","x":310,"y":180,"wires":[]},{"id":"dc77e0dfbe02d815","type":"comment","z":"3ad1e0957e6ec22e","name":"Climate Control","info":"","x":120,"y":100,"wires":[]},{"id":"0875f44675896e1d","type":"server-state-changed","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.user_home","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"off","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":200,"y":400,"wires":[["2acfef875f2fd481"],["2acfef875f2fd481"]]},{"id":"8ec001eb82986115","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"Arm Alarm Away","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"alarm_control_panel","service":"alarm_arm_away","areaId":[],"deviceId":[],"entityId":["alarm_control_panel.home_alarm"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":800,"y":400,"wires":[[]]},{"id":"2acfef875f2fd481","type":"trigger","z":"3ad1e0957e6ec22e","name":"Trigger 10min","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"10","extend":false,"overrideDelay":false,"units":"min","reset":"on","bytopic":"all","topic":"topic","outputs":1,"x":500,"y":400,"wires":[["8ec001eb82986115"]]},{"id":"56cf47b1dc1aa315","type":"comment","z":"3ad1e0957e6ec22e","name":"Turning on the alarm system","info":"","x":160,"y":360,"wires":[]},{"id":"62547a2f44519122","type":"comment","z":"3ad1e0957e6ec22e","name":"Wait 10 minutes before arming","info":"","x":500,"y":360,"wires":[]},{"id":"6e924c7d8c6a9def","type":"comment","z":"3ad1e0957e6ec22e","name":"Cancel if Users are detected","info":"","x":500,"y":440,"wires":[]},{"id":"5d19ca682dd18d58","type":"function","z":"3ad1e0957e6ec22e","name":"Volume selector","func":"var d = new Date();\nvar h = d.getHours();\n\nif (h > 22){\n    var volume = \"0.40\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var volume = \"0.35\";\n}\nelse if (h > 2 && h<8){\n    var volume = \"0.25\";\n}\nelse if (h >= 8 && h<9){\n    var volume = \"0.35\";\n}\nelse{\n    var volume = \"0.40\";\n}\nmsg=\n{\n    \"payload\":{\n        \"data\": {\n        \"entity_id\": msg.entity_id,\n        \"volume_level\": volume\n    }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3700,"y":560,"wires":[["6805035056bd8cee"]]},{"id":"2e0553a4becdcb11","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"Set Volume","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":4170,"y":600,"wires":[[]]},{"id":"7d44a2f1a57349f4","type":"api-current-state","z":"3ad1e0957e6ec22e","name":"Party mode is on?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.party_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3310,"y":600,"wires":[["e2670ef9a6f08eeb"],["1c819bd84e568a03"]]},{"id":"be293fd5728c4e6e","type":"function","z":"3ad1e0957e6ec22e","name":"Volume selector","func":"var d = new Date();\nvar h = d.getHours();\n\nif (h > 22) {\n    var volume = \"0.45\";\n}\nelse if (h >= 0 && h <= 2) {\n    var volume = \"0.40\";\n}\nelse if (h > 2 && h < 8) {\n    var volume = \"0.30\";\n}\nelse if (h >= 8 && h < 9) {\n    var volume = \"0.35\";\n}\nelse {\n    var volume = \"0.45\";\n}\nmsg =\n{\n    \"payload\": {\n        \"data\": {\n            \"entity_id\": msg.entity_id,\n            \"volume_level\": volume\n        }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3700,"y":640,"wires":[["a8bbac8ba01b6fd2"]]},{"id":"7e1267bdebb2527b","type":"comment","z":"3ad1e0957e6ec22e","name":"Ajust speaker volume on playback","info":"","x":180,"y":580,"wires":[]},{"id":"03a149d630e77b4c","type":"comment","z":"3ad1e0957e6ec22e","name":"Ignore the bathroom speaker","info":"","x":660,"y":580,"wires":[]},{"id":"6d4cd6f1412c1764","type":"comment","z":"3ad1e0957e6ec22e","name":"Is there a party?","info":"","x":3320,"y":560,"wires":[]},{"id":"b2ce23e38d7103c9","type":"comment","z":"3ad1e0957e6ec22e","name":"No","info":"","x":3530,"y":560,"wires":[]},{"id":"fc5f8b361b9c6939","type":"comment","z":"3ad1e0957e6ec22e","name":"Yes","info":"","x":3530,"y":640,"wires":[]},{"id":"dc50f62af3da8b31","type":"comment","z":"3ad1e0957e6ec22e","name":"Softer volume at night","info":"","x":3900,"y":640,"wires":[]},{"id":"c6ba29f30891bd72","type":"comment","z":"3ad1e0957e6ec22e","name":"Higher volume at night","info":"","x":3900,"y":560,"wires":[]},{"id":"19c80bba7d0c9f80","type":"server-state-changed","z":"3ad1e0957e6ec22e","name":"Speaker turns to \"paused\"?","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"media_player.*[a-z]_speaker$","entityIdType":"regex","outputInitially":false,"stateType":"str","ifState":"paused","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":170,"y":1180,"wires":[["5b05cae4ba55b8ee"],["6a044c93caf39482"]]},{"id":"396372437be8b774","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"stop speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1290,"y":1180,"wires":[[]]},{"id":"adc9dfdbe4ca7285","type":"trigger","z":"3ad1e0957e6ec22e","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"10","extend":false,"overrideDelay":false,"units":"min","reset":"playing","bytopic":"topic","topic":"topic","outputs":1,"x":730,"y":1180,"wires":[["dc2f1a0b7c70824c"]]},{"id":"dc2f1a0b7c70824c","type":"function","z":"3ad1e0957e6ec22e","name":"Extract Entity ID","func":"msg=\n{\n    \"payload\":{\n        \"data\": {\n        \"entity_id\": msg.data.entity_id\n    }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1080,"y":1180,"wires":[["396372437be8b774"]]},{"id":"a6fcdbbbdc0c3ada","type":"comment","z":"3ad1e0957e6ec22e","name":"Stop speaker playback after 10 minutes of pause","info":"","x":240,"y":1140,"wires":[]},{"id":"d45a1ecac538e304","type":"comment","z":"3ad1e0957e6ec22e","name":"Wait 10 minutes before continuing","info":"","x":740,"y":1140,"wires":[]},{"id":"2f3dc984afa8ff41","type":"comment","z":"3ad1e0957e6ec22e","name":"Cancel if playback is detected","info":"","x":720,"y":1220,"wires":[]},{"id":"6314b4028ff2f67d","type":"comment","z":"3ad1e0957e6ec22e","name":"Set the Entity ID for the stop service","info":"","x":1080,"y":1220,"wires":[]},{"id":"5086283593d40356","type":"server-state-changed","z":"3ad1e0957e6ec22e","name":"ready to pick up","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sensor.seventeentrack_packages_ready_to_be_picked_up","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":1020,"wires":[["3cd8c77c316c5c93"]]},{"id":"3cd8c77c316c5c93","type":"switch","z":"3ad1e0957e6ec22e","name":"Packages > 0?","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":640,"y":1020,"wires":[["f98de588c39d7f10","cfb270cb9831f219"]]},{"id":"f98de588c39d7f10","type":"change","z":"3ad1e0957e6ec22e","name":"Set Alert","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"A package is out for delivery","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":860,"y":1020,"wires":[["9cb597036711d325"]]},{"id":"83017b417ed43ef0","type":"server-state-changed","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sensor.seventeentrack_packages_delivered","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":1480,"y":1020,"wires":[["63b187a23e477005"]]},{"id":"63b187a23e477005","type":"switch","z":"3ad1e0957e6ec22e","name":"Packages > 0?","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":1860,"y":1020,"wires":[["a7cc57ac03e9a424","cd15b6f1ce2e732a"]]},{"id":"a7cc57ac03e9a424","type":"change","z":"3ad1e0957e6ec22e","name":"Set alert","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"A package has been delivered","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2080,"y":1020,"wires":[["b4f174eee8ca2dab"]]},{"id":"588375d3bad43210","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2280,"y":980,"wires":[[]]},{"id":"cd15b6f1ce2e732a","type":"function","z":"3ad1e0957e6ec22e","name":"Javascript","func":"var newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"message\": \"A Package has been delivered\",\n            \"title\": \"Package Alert\"\n}\n        }\n    }\n;\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2080,"y":980,"wires":[["588375d3bad43210"]]},{"id":"1c766c3e3dada870","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1060,"y":980,"wires":[[]]},{"id":"cfb270cb9831f219","type":"function","z":"3ad1e0957e6ec22e","name":"Javascript","func":"var newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"message\": \"A Package is out for delivery\",\n            \"title\": \"Package Alert\"\n}\n        }\n    }\n;\nreturn newMsg;","outputs":1,"noerr":0,"x":860,"y":980,"wires":[["1c766c3e3dada870"]]},{"id":"755615d7f2e33edf","type":"comment","z":"3ad1e0957e6ec22e","name":"Notify and Broadcast an alert about delivered packages","info":"","x":1460,"y":980,"wires":[]},{"id":"4ca0d0580ac05047","type":"comment","z":"3ad1e0957e6ec22e","name":"Amount of delivered packages?","info":"","x":1850,"y":1060,"wires":[]},{"id":"ff97fa9fb8de9652","type":"comment","z":"3ad1e0957e6ec22e","name":"Set Alert Data","info":"","x":2070,"y":1060,"wires":[]},{"id":"6031403bd7dbc730","type":"comment","z":"3ad1e0957e6ec22e","name":"Notify and Broadcast an alert about out ofr delivery packages","info":"","x":260,"y":980,"wires":[]},{"id":"6754f428c6e81354","type":"comment","z":"3ad1e0957e6ec22e","name":"Set Alert Data","info":"","x":850,"y":1060,"wires":[]},{"id":"092dd69960de583a","type":"comment","z":"3ad1e0957e6ec22e","name":"Amount of delivered packages?","info":"","x":630,"y":1060,"wires":[]},{"id":"e0b5c8fe82883f4b","type":"comment","z":"3ad1e0957e6ec22e","name":"Set Notification Data","info":"","x":2090,"y":940,"wires":[]},{"id":"871a14c154ef1678","type":"comment","z":"3ad1e0957e6ec22e","name":"Set Notification Data","info":"","x":870,"y":940,"wires":[]},{"id":"af0044ecc62ca32e","type":"comment","z":"3ad1e0957e6ec22e","name":"Send notification","info":"","x":2280,"y":940,"wires":[]},{"id":"32b45bba10657c70","type":"comment","z":"3ad1e0957e6ec22e","name":"Send notification","info":"","x":1060,"y":940,"wires":[]},{"id":"a2fc67ccfef493b7","type":"server-state-changed","z":"3ad1e0957e6ec22e","name":"Users home?","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.user_home","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"off","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":110,"y":280,"wires":[["fc518af82d06d8bc"],[]]},{"id":"5e73e5e7fc269891","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"Turn off all lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.all_lights"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":300,"y":280,"wires":[[]]},{"id":"79fdce988cf0e215","type":"comment","z":"3ad1e0957e6ec22e","name":"Turn all lights off","info":"","x":300,"y":240,"wires":[]},{"id":"f237035cc1c80e4f","type":"comment","z":"3ad1e0957e6ec22e","name":"Auto lights off","info":"","x":110,"y":240,"wires":[]},{"id":"03eeba825e7db7c0","type":"server-state-changed","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"media_player\\.plex_[a-z_]*_chromecast","entityIdType":"regex","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":300,"y":1400,"wires":[["c6dc078aa2c91492"]]},{"id":"52b3870c20250d7e","type":"switch","z":"3ad1e0957e6ec22e","name":"Visuals?","property":"data.new_state.attributes.media_library_title","propertyType":"msg","rules":[{"t":"eq","v":"Visuals","vt":"str"},{"t":"neq","v":"Visuals","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":900,"y":1400,"wires":[["b1880ea06e93f832"],["2792555ece4458cd"]]},{"id":"cad47fe6566c23a7","type":"switch","z":"3ad1e0957e6ec22e","name":"playing?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"playing","vt":"str"},{"t":"neq","v":"playing","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1160,"y":1360,"wires":[["62cf47fb999346aa"],["bb71b092d9c74860"]]},{"id":"dfbcd81831907951","type":"function","z":"3ad1e0957e6ec22e","name":"Extract Player from Plex player","func":"var player = msg.data.new_state.entity_id;\nvar playersplit = player.replace(\"plex_\",\"\")\n\nmsg=\n{\n    \"payload\":{\n        \"data\": {\n        \"entity_id\": playersplit\n    }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1570,"y":1320,"wires":[["8f3820173d5a9601"]]},{"id":"afec6aacb9655c5b","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1790,"y":1400,"wires":[[]]},{"id":"37b0a3e74ec0ba37","type":"switch","z":"3ad1e0957e6ec22e","name":"playing?","property":"payload","propertyType":"msg","rules":[{"t":"regex","v":"(playing|paused)","vt":"str","case":true}],"checkall":"true","repair":false,"outputs":1,"x":1320,"y":1440,"wires":[["46d3285b345e72df"]]},{"id":"a25d3f0c73d9050d","type":"function","z":"3ad1e0957e6ec22e","name":"Time + Entity","func":"var d = new Date();\nvar h = d.getHours();\nvar player = msg.data.new_state.entity_id;\nvar playersplit = player.replace(\"plex_\",\"\")\n\nif (h > 22){\n    var volume = \"0.85\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var volume = \"0.50\";\n}\nelse if (h > 2 && h<8){\n    var volume = \"0.40\";\n}\nelse if (h >= 8 && h<9){\n    var volume = \"0.75\";\n}\nelse{\n    var volume = \"0.95\";\n}\nmsg=\n{\n    \"payload\":{\n        \"data\": {\n        \"entity_id\": playersplit,\n        \"volume_level\": volume\n    }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1510,"y":1400,"wires":[["ac09ae6273c851a3"]]},{"id":"3996bd2645bd3ea2","type":"switch","z":"3ad1e0957e6ec22e","name":"was off?","property":"data.old_state.state","propertyType":"msg","rules":[{"t":"eq","v":"unavailable","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1180,"y":1440,"wires":[["37b0a3e74ec0ba37"]]},{"id":"33dbc80daf4a4318","type":"comment","z":"3ad1e0957e6ec22e","name":"Detect all plex player ending with chromecast","info":"","x":270,"y":1360,"wires":[]},{"id":"a4490797618f2afb","type":"comment","z":"3ad1e0957e6ec22e","name":"These two JS extract the Chromecast name from the plex name","info":"","x":1490,"y":1360,"wires":[]},{"id":"038270b1b4b56fdb","type":"comment","z":"3ad1e0957e6ec22e","name":"Is it playing or else?","info":"","x":1170,"y":1320,"wires":[]},{"id":"4b8ac747afd9a695","type":"comment","z":"3ad1e0957e6ec22e","name":"Was the previous state off?","info":"","x":1190,"y":1480,"wires":[]},{"id":"5faef84dcf6b6b7b","type":"comment","z":"3ad1e0957e6ec22e","name":"Is the content from the Visuals library?","info":"","x":890,"y":1360,"wires":[]},{"id":"d12627b175e4cba5","type":"comment","z":"3ad1e0957e6ec22e","name":"Is it playing or pause?","info":"","x":1280,"y":1400,"wires":[]},{"id":"c6dc078aa2c91492","type":"switch","z":"3ad1e0957e6ec22e","name":"Chromecast  is not muted","property":"data.new_state.attributes.is_volume_muted","propertyType":"msg","rules":[{"t":"neq","v":"true","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":650,"y":1400,"wires":[["52b3870c20250d7e"]]},{"id":"6887f624ce6cbd9c","type":"comment","z":"3ad1e0957e6ec22e","name":"Chromecast is not muted?","info":"","x":650,"y":1440,"wires":[]},{"id":"dd6d7ede80c7da5b","type":"change","z":"3ad1e0957e6ec22e","name":"Set reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":500,"y":1200,"wires":[["adc9dfdbe4ca7285"]]},{"id":"6a044c93caf39482","type":"switch","z":"3ad1e0957e6ec22e","name":"Playing?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"playing","vt":"str"},{"t":"eq","v":"idle","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":360,"y":1200,"wires":[["dd6d7ede80c7da5b"],["dd6d7ede80c7da5b"]]},{"id":"80ca7e4e59dae561","type":"comment","z":"3ad1e0957e6ec22e","name":"Set reset to true if playing/idle","info":"","x":420,"y":1240,"wires":[]},{"id":"9cb597036711d325","type":"subflow:233ac7dcd801a802","z":"3ad1e0957e6ec22e","name":"","x":1070,"y":1020,"wires":[]},{"id":"b4f174eee8ca2dab","type":"subflow:233ac7dcd801a802","z":"3ad1e0957e6ec22e","name":"","x":2270,"y":1020,"wires":[]},{"id":"b5bf8a875890d348","type":"trigger-state","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"^binary_sensor\\.(?!.*?bedroom.*?)(?!.*?hotbox_down.*?)(?!.*?bathroom.*?).*_occupancy$","entityIdType":"regex","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"},{"targetType":"entity_id","targetValue":"input_boolean.party_mode","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"},{"targetType":"entity_id","targetValue":"input_boolean.acid_time","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"},{"targetType":"entity_id","targetValue":"input_boolean.kink_party","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":370,"y":2320,"wires":[["b8f6b67ac5adc19d"],[]]},{"id":"84c65edb9ad601cf","type":"comment","z":"3ad1e0957e6ec22e","name":"Detect no motion across ocupancy sensors","info":"","x":180,"y":2280,"wires":[]},{"id":"94186347dfaff946","type":"comment","z":"3ad1e0957e6ec22e","name":"(Ignores \"Nate\",\"Bedroom\" and \"Dungeon\" sensors)","info":"","x":530,"y":2280,"wires":[]},{"id":"13b3d4ea5b221ea4","type":"trigger-state","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":2,"inputs":0,"outputs":2,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"}],"enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityid":"^binary_sensor\\.(?!.*?bedroom.*?)(?!.*?hotbox_down.*?)(?!.*?bathroom.*?).*_occupancy$","entityidfiltertype":"regex","debugenabled":false,"customoutputs":[],"outputinitially":false,"state_type":"str","x":370,"y":2420,"wires":[["b8f6b67ac5adc19d"],[]]},{"id":"5901200f87196293","type":"comment","z":"3ad1e0957e6ec22e","name":"Detect motion across ocupancy sensors","info":"","x":170,"y":2380,"wires":[]},{"id":"afa6e5fd359976e7","type":"comment","z":"3ad1e0957e6ec22e","name":"(Ignores \"Nate\",\"Bedroom\" and \"Dungeon\" sensors)","info":"","x":530,"y":2380,"wires":[]},{"id":"b8f6b67ac5adc19d","type":"trigger","z":"3ad1e0957e6ec22e","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"7","extend":false,"overrideDelay":false,"units":"min","reset":"on","bytopic":"topic","topic":"topic","outputs":1,"x":930,"y":2320,"wires":[["f6bd0e7c3db3ad74"]]},{"id":"193ae7634d476f6c","type":"comment","z":"3ad1e0957e6ec22e","name":"7 minutes trigger before continuing","info":"","x":880,"y":2280,"wires":[]},{"id":"323614ff6d81d35d","type":"delay","z":"3ad1e0957e6ec22e","name":"","pauseType":"rate","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":".5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":3050,"y":600,"wires":[["7d44a2f1a57349f4"]]},{"id":"d6d2da265f8d3154","type":"trigger-state","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"^media_player\\.plex_.*_chromecast$","entityIdType":"regex","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"playing"},{"targetType":"this_entity","targetValue":"","propertyType":"property","propertyValue":"new_state.attributes.is_volume_muted","comparatorType":"is","comparatorValueDatatype":"bool","comparatorValue":"false"},{"targetType":"this_entity","targetValue":"","propertyType":"property","propertyValue":"new_state.attributes.media_library_title","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"Movies"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":210,"y":3120,"wires":[["95d9d94377012bd2"],[]]},{"id":"95d9d94377012bd2","type":"function","z":"3ad1e0957e6ec22e","name":"Extract room from plex player to change lights","func":"var player = msg.data.entity_id;\nvar playersplit = player.replace(\"media_player.plex_\",\"\").replace(\"_chromecast\", \"\")\nvar regex = \"^light\\\\.(?!.*?group.*?)(?!.*?notification.*?)(?!.*?lights.*?).*\" + playersplit + \".*\"; \nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': regex ,  'valueType': 're' },{ 'property': 'state' ,  'logic': 'is' , 'value': \"on\" ,  'valueType': 'str' }];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object},\n    \"room\": playersplit\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":3120,"wires":[["38ceb4f54d67f3af"]]},{"id":"919bb661879e6f4b","type":"function","z":"3ad1e0957e6ec22e","name":"Brightness selector","func":"msg=\n{\n    \"payload\":{\n        \"data\": {\n        \"entity_id\": msg.entity.entity_id,\n        \"brightness_pct\": 45,\n        \"color_name\":  \"purple\"\n    }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1890,"y":3120,"wires":[["74bb11214582b1cb"]]},{"id":"74bb11214582b1cb","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2190,"y":3120,"wires":[[]]},{"id":"a3b0595af2b1b9cb","type":"change","z":"3ad1e0957e6ec22e","name":"rules","rules":[{"t":"move","p":"payload","pt":"msg","to":"entity","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1550,"y":3120,"wires":[["919bb661879e6f4b"]]},{"id":"707b84bf5a382390","type":"comment","z":"3ad1e0957e6ec22e","name":"Generate the regex for the get entity node","info":"","x":680,"y":3080,"wires":[]},{"id":"2d570380e256ac08","type":"comment","z":"3ad1e0957e6ec22e","name":"Move payload to entity","info":"","x":1560,"y":3080,"wires":[]},{"id":"7d7cb0316c13ad57","type":"comment","z":"3ad1e0957e6ec22e","name":"Select color, brightness and set entity_id","info":"","x":1900,"y":3080,"wires":[]},{"id":"df5a869d83b8c12c","type":"comment","z":"3ad1e0957e6ec22e","name":"Turn the lights to purple 45%","info":"","x":2200,"y":3080,"wires":[]},{"id":"4856340ad3c325bc","type":"comment","z":"3ad1e0957e6ec22e","name":"Detect all movie playing plex player ending with chromecast","info":"","x":230,"y":3080,"wires":[]},{"id":"38ceb4f54d67f3af","type":"ha-get-entities","z":"3ad1e0957e6ec22e","name":"Get entities","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload.results","output_results_count":1,"x":1010,"y":3120,"wires":[["9607bbc9456c0ee6"]]},{"id":"9607bbc9456c0ee6","type":"switch","z":"3ad1e0957e6ec22e","name":"Individual lights?","property":"payload.attributes.entity_id","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","repair":false,"outputs":1,"x":1230,"y":3120,"wires":[["a3b0595af2b1b9cb"]]},{"id":"67a425b07536b5ce","type":"trigger-state","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"^media_player\\.plex_.*_chromecast$","entityIdType":"regex","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"unavailable"},{"targetType":"this_entity","targetValue":"","propertyType":"property","propertyValue":"old_state.attributes.media_library_title","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"Movies"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":210,"y":3420,"wires":[["5a165f257ae36251"],[]]},{"id":"5a165f257ae36251","type":"function","z":"3ad1e0957e6ec22e","name":"Extract room from plex player to change lights","func":"var player = msg.data.entity_id;\nvar playersplit = player.replace(\"media_player.plex_\",\"\").replace(\"_chromecast\", \"\")\nvar regex = \"^light\\\\.(?!.*?group.*?)(?!.*?notification.*?)(?!.*?lights.*?).*\" + playersplit + \".*\"; \nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': regex ,  'valueType': 're' },{ 'property': 'state' ,  'logic': 'is' , 'value': \"on\" ,  'valueType': 'str' }];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object}\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":3420,"wires":[["3968c7ad65e230c1"]]},{"id":"82a0398c29f50d7c","type":"function","z":"3ad1e0957e6ec22e","name":"Brightness selector","func":"msg=\n{\n    \"payload\":{\n        \"data\": {\n        \"entity_id\": msg.entity.entity_id,\n        \"brightness_pct\": 95,\n        \"color_name\":  \"white\",\n        \"transition\": 5\n    }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1870,"y":3420,"wires":[["799858f321dfba0e"]]},{"id":"799858f321dfba0e","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2170,"y":3420,"wires":[[]]},{"id":"c58046c1e9b52415","type":"change","z":"3ad1e0957e6ec22e","name":"rules","rules":[{"t":"move","p":"payload","pt":"msg","to":"entity","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1550,"y":3420,"wires":[["82a0398c29f50d7c"]]},{"id":"4b216e883ec2be7f","type":"comment","z":"3ad1e0957e6ec22e","name":"Generate the regex for the get entity node","info":"","x":680,"y":3380,"wires":[]},{"id":"cf1a3437b5c43de1","type":"comment","z":"3ad1e0957e6ec22e","name":"Move payload to entity","info":"","x":1540,"y":3380,"wires":[]},{"id":"c2cd3e4cc9e9d001","type":"comment","z":"3ad1e0957e6ec22e","name":"Select color, brightness and set entity_id","info":"","x":1880,"y":3380,"wires":[]},{"id":"c39914167a65397b","type":"comment","z":"3ad1e0957e6ec22e","name":"Turnthe lights to white","info":"","x":2180,"y":3380,"wires":[]},{"id":"29edd6febb7fcab5","type":"comment","z":"3ad1e0957e6ec22e","name":"Detect all movie stopping plex player ending with chromecast","info":"","x":240,"y":3380,"wires":[]},{"id":"3968c7ad65e230c1","type":"ha-get-entities","z":"3ad1e0957e6ec22e","name":"Get entities","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload.results","output_results_count":1,"x":1010,"y":3420,"wires":[["0a6879fb44a347ba"]]},{"id":"0a6879fb44a347ba","type":"switch","z":"3ad1e0957e6ec22e","name":"Individual lights?","property":"payload.attributes.entity_id","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","repair":false,"outputs":1,"x":1230,"y":3420,"wires":[["c58046c1e9b52415"]]},{"id":"308e19234d566940","type":"trigger-state","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"^media_player\\.plex_.*_chromecast$","entityIdType":"regex","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"paused"},{"targetType":"this_entity","targetValue":"","propertyType":"property","propertyValue":"new_state.attributes.is_volume_muted","comparatorType":"is","comparatorValueDatatype":"bool","comparatorValue":"false"},{"targetType":"this_entity","targetValue":"","propertyType":"property","propertyValue":"new_state.attributes.media_library_title","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"Movies"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":210,"y":3280,"wires":[["2cea68a62f282814"],[]]},{"id":"2cea68a62f282814","type":"function","z":"3ad1e0957e6ec22e","name":"Extract room from plex player to change lights","func":"var player = msg.data.entity_id;\nvar playersplit = player.replace(\"media_player.plex_\",\"\").replace(\"_chromecast\", \"\")\nvar regex = \"^light\\\\.(?!.*?group.*?)(?!.*?notification.*?)(?!.*?lights.*?).*\" + playersplit + \".*\"; \nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': regex ,  'valueType': 're' },{ 'property': 'state' ,  'logic': 'is' , 'value': \"on\" ,  'valueType': 'str' }];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object}\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":3280,"wires":[["e8b063abfb89d60d"]]},{"id":"bc443df7ca56b978","type":"function","z":"3ad1e0957e6ec22e","name":"Brightness selector","func":"msg=\n{\n    \"payload\":{\n        \"data\": {\n        \"entity_id\": msg.entity.entity_id,\n        \"brightness_pct\": 75,\n        \"color_name\":  \"purple\"\n    }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1890,"y":3280,"wires":[["1f0a2ff364ce58b4"]]},{"id":"1f0a2ff364ce58b4","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2190,"y":3280,"wires":[[]]},{"id":"1424c881c8f090f0","type":"change","z":"3ad1e0957e6ec22e","name":"rules","rules":[{"t":"move","p":"payload","pt":"msg","to":"entity","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1550,"y":3280,"wires":[["bc443df7ca56b978"]]},{"id":"19631caadd94dacd","type":"comment","z":"3ad1e0957e6ec22e","name":"Generate the regex for the get entity node","info":"","x":680,"y":3240,"wires":[]},{"id":"f8766b221eec8c2b","type":"comment","z":"3ad1e0957e6ec22e","name":"Move payload to entity","info":"","x":1560,"y":3240,"wires":[]},{"id":"1c32bcefaac7e754","type":"comment","z":"3ad1e0957e6ec22e","name":"Select color, brightness and set entity_id","info":"","x":1900,"y":3240,"wires":[]},{"id":"8892f41f2ad5d24b","type":"comment","z":"3ad1e0957e6ec22e","name":"Turnthe lights to purple 75%","info":"","x":2220,"y":3240,"wires":[]},{"id":"f4a21b49bbb499e2","type":"comment","z":"3ad1e0957e6ec22e","name":"Detect all movie paused plex player ending with chromecast","info":"","x":240,"y":3240,"wires":[]},{"id":"e8b063abfb89d60d","type":"ha-get-entities","z":"3ad1e0957e6ec22e","name":"Get entities","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload.results","output_results_count":1,"x":1010,"y":3280,"wires":[["d4c2e7a35ab15fdf"]]},{"id":"d4c2e7a35ab15fdf","type":"switch","z":"3ad1e0957e6ec22e","name":"Individual lights?","property":"payload.attributes.entity_id","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","repair":false,"outputs":1,"x":1230,"y":3280,"wires":[["1424c881c8f090f0"]]},{"id":"9f66ceec73d6773d","type":"comment","z":"3ad1e0957e6ec22e","name":"Weed out light groups","info":"","x":1240,"y":3080,"wires":[]},{"id":"a0bc08923079df2e","type":"comment","z":"3ad1e0957e6ec22e","name":"Get lights ","info":"","x":1000,"y":3080,"wires":[]},{"id":"94a04177b1e74e69","type":"trigger-state","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"^media_player\\.plex_.*_chromecast$","entityIdType":"regex","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"playing"},{"targetType":"this_entity","targetValue":"","propertyType":"property","propertyValue":"new_state.attributes.is_volume_muted","comparatorType":"is","comparatorValueDatatype":"bool","comparatorValue":"false"},{"targetType":"this_entity","targetValue":"","propertyType":"property","propertyValue":"new_state.attributes.media_library_title","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"Movies"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":210,"y":2980,"wires":[["86b50ac9317bb003","ac19ca3db853593f"],["ac19ca3db853593f"]]},{"id":"86b50ac9317bb003","type":"function","z":"3ad1e0957e6ec22e","name":"Extract room from plex player to close cover","func":"var player = msg.data.entity_id;\nvar playersplit = player.replace(\"media_player.plex_\",\"\").replace(\"_chromecast\", \"\")\nvar regex = \"cover.cover_\" + playersplit + \"_blinds\"; \nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': regex ,  'valueType': 're' },{\"property\": \"attributes.position\",\"logic\": \"gt\",\"value\": \"26\",\"valueType\": \"num\"}];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object},\n    \"topic\": msg.topic\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":670,"y":2980,"wires":[["089e6ab34e6eb2bd"]]},{"id":"8a78d302e5c23a03","type":"function","z":"3ad1e0957e6ec22e","name":"Entity Setter","func":"msg=\n{\n    \"payload\":{\n        \"data\": {\n        \"entity_id\": msg.entity.entity_id\n    },\n        \"topic\": msg.topic\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1550,"y":2980,"wires":[["20e9bfc56ed01272"]]},{"id":"20e9bfc56ed01272","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"set_cover_position","areaId":[],"deviceId":[],"entityId":[],"data":"{\"position\": 30}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1930,"y":2980,"wires":[[]]},{"id":"c6d6e957e0b707ab","type":"change","z":"3ad1e0957e6ec22e","name":"rules","rules":[{"t":"move","p":"payload","pt":"msg","to":"entity","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1310,"y":2980,"wires":[["8a78d302e5c23a03"]]},{"id":"b46cb226baf76263","type":"comment","z":"3ad1e0957e6ec22e","name":"Move payload to entity","info":"","x":1300,"y":2940,"wires":[]},{"id":"296d25f7b785f0ce","type":"comment","z":"3ad1e0957e6ec22e","name":"Set entity","info":"","x":1560,"y":2940,"wires":[]},{"id":"83a28914f1809033","type":"comment","z":"3ad1e0957e6ec22e","name":"Close the cover","info":"","x":1920,"y":2940,"wires":[]},{"id":"6e79f01c175a3362","type":"comment","z":"3ad1e0957e6ec22e","name":"Detect all movie playing plex player ending with chromecast","info":"","x":230,"y":2940,"wires":[]},{"id":"089e6ab34e6eb2bd","type":"ha-get-entities","z":"3ad1e0957e6ec22e","name":"Get entities","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload.results","output_results_count":1,"x":990,"y":2980,"wires":[["c6d6e957e0b707ab"]]},{"id":"709cc00006f7c753","type":"comment","z":"3ad1e0957e6ec22e","name":"Detect all covers in the room over 26%","info":"","x":1010,"y":2940,"wires":[]},{"id":"2222952d1735574d","type":"comment","z":"3ad1e0957e6ec22e","name":"Generate the regex for the get entity node","info":"","x":680,"y":2940,"wires":[]},{"id":"75998c0375899879","type":"comment","z":"3ad1e0957e6ec22e","name":"Weed out light groups","info":"","x":1240,"y":3240,"wires":[]},{"id":"8e4a3049a2aeba1a","type":"comment","z":"3ad1e0957e6ec22e","name":"Weed out light groups","info":"","x":1240,"y":3380,"wires":[]},{"id":"9fb5d3ddd5a53ed7","type":"comment","z":"3ad1e0957e6ec22e","name":"Get lights ","info":"","x":1000,"y":3240,"wires":[]},{"id":"1bde4567bbb03062","type":"comment","z":"3ad1e0957e6ec22e","name":"Get lights ","info":"","x":1000,"y":3380,"wires":[]},{"id":"b6ef341c55c7f02f","type":"trigger-state","z":"3ad1e0957e6ec22e","name":"Playing chromecasts","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"^media_player\\..*_chromecast$","entityIdType":"regex","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"playing"},{"targetType":"this_entity","targetValue":"","propertyType":"property","propertyValue":"new_state.attributes.volume_level","comparatorType":">","comparatorValueDatatype":"num","comparatorValue":"0.1"},{"targetType":"this_entity","targetValue":"","propertyType":"previous_state","propertyValue":"old_state.state","comparatorType":"is_not","comparatorValueDatatype":"str","comparatorValue":"playing"},{"targetType":"this_entity","targetValue":"","propertyType":"property","propertyValue":"new_state.attributes.is_volume_muted","comparatorType":"is","comparatorValueDatatype":"bool","comparatorValue":"false"},{"targetType":"this_entity","targetValue":"","propertyType":"property","propertyValue":"new_state.attributes.app_name","comparatorType":"is_not","comparatorValueDatatype":"str","comparatorValue":"Home Assistant Lovelace"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":110,"y":2700,"wires":[["956180a631884471"],[]]},{"id":"956180a631884471","type":"function","z":"3ad1e0957e6ec22e","name":"Extract room from media player entity an extract off speakers to regex","func":"var motion_entity_id = msg.data.event.new_state.entity_id; // binary_sensor.sensor_bedroom_motion_occupancy\nvar motion_entity_id_split = motion_entity_id.split(\".\");// split on the dot to separate domain and entity\nvar motion_entity_id_wihtout_binary = motion_entity_id_split[1].replace(\"media_player_\", \"\").replace(\"_chromecast\", \"\");// remove sensor_ and more substrings\nvar regex = \"^media_player\\.(?!.*?speakers.*?).*\" + motion_entity_id_wihtout_binary + \".*_speaker\"; \nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': regex ,  'valueType': 're' },{ 'property': 'state' ,  'logic': 'is_not' , 'value': \"on\" ,  'valueType': 'str' }];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object},\"room\": motion_entity_id_wihtout_binary\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":2700,"wires":[["b5cd4c900adad971"]]},{"id":"b5cd4c900adad971","type":"ha-get-entities","z":"3ad1e0957e6ec22e","name":"Get entities","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload.results","output_results_count":1,"x":1130,"y":2700,"wires":[["9aca0aafb17f20b2"]]},{"id":"bf142546177ce08a","type":"comment","z":"3ad1e0957e6ec22e","name":"Generate the regex for the get entity node","info":"","x":740,"y":2660,"wires":[]},{"id":"18c4256ce9e5dd3d","type":"comment","z":"3ad1e0957e6ec22e","name":"Get speakers entities","info":"","x":1140,"y":2660,"wires":[]},{"id":"7c989a7b3bc80a07","type":"comment","z":"3ad1e0957e6ec22e","name":"Detect all playing player ending with chromecast","info":"","x":200,"y":2660,"wires":[]},{"id":"14ab28a31cb6f947","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"Mute speakers","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\": \"true\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1640,"y":2700,"wires":[[]]},{"id":"9aca0aafb17f20b2","type":"change","z":"3ad1e0957e6ec22e","name":"rules","rules":[{"t":"move","p":"payload.entity_id","pt":"msg","to":"payload.data.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1390,"y":2700,"wires":[["14ab28a31cb6f947"]]},{"id":"592f8f0c4a7e4be6","type":"comment","z":"3ad1e0957e6ec22e","name":"Move payload to payload.data","info":"","x":1400,"y":2660,"wires":[]},{"id":"1a2c2723d370a5c3","type":"comment","z":"3ad1e0957e6ec22e","name":"Mute speakers","info":"","x":1640,"y":2660,"wires":[]},{"id":"cf6e81f1162dfe6d","type":"trigger-state","z":"3ad1e0957e6ec22e","name":"Playing chromecasts","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"^media_player\\..*_chromecast$","entityIdType":"regex","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"re","comparatorValue":"(paused|off)"},{"targetType":"this_entity","targetValue":"","propertyType":"property","propertyValue":"new_state.attributes.volume_level","comparatorType":">","comparatorValueDatatype":"num","comparatorValue":"0.1"},{"targetType":"this_entity","targetValue":"","propertyType":"previous_state","propertyValue":"old_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"playing"},{"targetType":"this_entity","targetValue":"","propertyType":"property","propertyValue":"new_state.attributes.app_name","comparatorType":"is_not","comparatorValueDatatype":"str","comparatorValue":"Home Assistant Lovelace"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":110,"y":2820,"wires":[["0148a0d7b5b1af6b"],[]]},{"id":"0148a0d7b5b1af6b","type":"function","z":"3ad1e0957e6ec22e","name":"Extract room from media player entity an extract off speakers to regex","func":"var motion_entity_id = msg.data.event.new_state.entity_id; // binary_sensor.sensor_bedroom_motion_occupancy\nvar motion_entity_id_split = motion_entity_id.split(\".\");// split on the dot to separate domain and entity\nvar motion_entity_id_wihtout_binary = motion_entity_id_split[1].replace(\"media_player_\", \"\").replace(\"_chromecast\", \"\");// remove sensor_ and more substrings\nvar regex = \"^media_player\\.(?!.*?speakers.*?).*\" + motion_entity_id_wihtout_binary + \".*_speaker\"; \nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': regex ,  'valueType': 're' },{ 'property': 'state' ,  'logic': 'is_not' , 'value': \"on\" ,  'valueType': 'str' }];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object},\"room\": motion_entity_id_wihtout_binary\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":710,"y":2820,"wires":[["0feb81ecfb724761"]]},{"id":"0feb81ecfb724761","type":"ha-get-entities","z":"3ad1e0957e6ec22e","name":"Get entities","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload.results","output_results_count":1,"x":1130,"y":2820,"wires":[["df8645a894391e8b"]]},{"id":"0598a0acb4cfb13a","type":"comment","z":"3ad1e0957e6ec22e","name":"Generate the regex for the get entity node","info":"","x":740,"y":2780,"wires":[]},{"id":"e8ebe00ff14b8839","type":"comment","z":"3ad1e0957e6ec22e","name":"Get speakers entities","info":"","x":1140,"y":2780,"wires":[]},{"id":"2c2cbe2dfa5b5284","type":"comment","z":"3ad1e0957e6ec22e","name":"Detect all paused player ending with chromecast","info":"","x":200,"y":2780,"wires":[]},{"id":"945d874e4f0e81c5","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"Unmute speakers","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\": \"false\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1650,"y":2820,"wires":[[]]},{"id":"df8645a894391e8b","type":"change","z":"3ad1e0957e6ec22e","name":"rules","rules":[{"t":"move","p":"payload.entity_id","pt":"msg","to":"payload.data.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1390,"y":2820,"wires":[["945d874e4f0e81c5"]]},{"id":"5cf4d8712339894d","type":"comment","z":"3ad1e0957e6ec22e","name":"Move payload to payload.data","info":"","x":1400,"y":2780,"wires":[]},{"id":"ec52ad15c2364196","type":"comment","z":"3ad1e0957e6ec22e","name":"unMute speakers","info":"","x":1640,"y":2780,"wires":[]},{"id":"ac19ca3db853593f","type":"debug","z":"3ad1e0957e6ec22e","name":"debug 21","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":440,"y":3040,"wires":[]},{"id":"25dfe89de5062e26","type":"trigger-state","z":"3ad1e0957e6ec22e","name":"All sleeping turns on","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.all_present_sleeping","entityIdType":"regex","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":130,"y":3540,"wires":[["1d99a0ebad5ba436"],[]]},{"id":"22fca18a122a02d5","type":"comment","z":"3ad1e0957e6ec22e","name":"Close blinds on all sleep","info":"","x":150,"y":3500,"wires":[]},{"id":"1d99a0ebad5ba436","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"Close all covers","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"set_cover_position","areaId":[],"deviceId":[],"entityId":["cover.cover_livingroom_blinds","cover.cover_office_blinds"],"data":"{\"position\":0}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":380,"y":3540,"wires":[[]]},{"id":"baa40cf3b02103d9","type":"comment","z":"3ad1e0957e6ec22e","name":"Close all covers","info":"","x":380,"y":3500,"wires":[]},{"id":"40f408ee23514114","type":"comment","z":"3ad1e0957e6ec22e","name":"Is the house empty?","info":"","x":110,"y":2540,"wires":[]},{"id":"0a28286f804cb5f5","type":"trigger-state","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.user_home","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"},{"targetType":"entity_id","targetValue":"input_boolean.kink_party","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"},{"targetType":"entity_id","targetValue":"input_boolean.party_mode","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"},{"targetType":"entity_id","targetValue":"input_boolean.acid_time","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":170,"y":2580,"wires":[["79390bc2d69f0c01"],[]]},{"id":"79390bc2d69f0c01","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["all"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":510,"y":2580,"wires":[[]]},{"id":"9252fe66ebb5980e","type":"comment","z":"3ad1e0957e6ec22e","name":"Turn off t he lights","info":"","x":510,"y":2540,"wires":[]},{"id":"8f3820173d5a9601","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\": true}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1870,"y":1320,"wires":[[]]},{"id":"9ebdae039088d22b","type":"server-state-changed","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.user_home","entityIdType":"regex","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":200,"y":520,"wires":[["4be0016c8eafecbb"],[]]},{"id":"4be0016c8eafecbb","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"alarm_control_panel","service":"alarm_disarm","areaId":[],"deviceId":[],"entityId":["alarm_control_panel.home_alarm"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":560,"y":520,"wires":[[]]},{"id":"f6bd0e7c3db3ad74","type":"subflow:9e515b8aa75a9cdd","z":"3ad1e0957e6ec22e","name":"","x":1110,"y":2320,"wires":[]},{"id":"6728c9fcb85f2925","type":"comment","z":"3ad1e0957e6ec22e","name":"Speaker is not muted?","info":"","x":900,"y":580,"wires":[]},{"id":"1a1b9e0c796c591e","type":"function","z":"3ad1e0957e6ec22e","name":"Extract room from media player name","func":"var media_entity_id = msg.data.entity_id; // binary_sensor.sensor_bedroom_motion_occupancy\nvar media_entity_id_split = media_entity_id.split(\".\");// split on the dot to separate domain and entity\nvar room = media_entity_id_split[1].split(\"_\");// remove sensor_ and more substrings\n\nvar msg = {\n    \"room\": room[0],\n    \"entity_id\": media_entity_id\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1170,"y":620,"wires":[["302e53ea88470e83","2e01db33c01a6c79"]]},{"id":"f49208e778f0be8b","type":"comment","z":"3ad1e0957e6ec22e","name":"Extract room","info":"","x":1170,"y":580,"wires":[]},{"id":"8e4304a0b3903d05","type":"delay","z":"3ad1e0957e6ec22e","name":"","pauseType":"rate","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"0.7","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":3510,"y":740,"wires":[["76b983255b2d893e"]]},{"id":"76b983255b2d893e","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"Mute speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\": \"true\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":3700,"y":740,"wires":[[]]},{"id":"4ea268995019b87f","type":"comment","z":"3ad1e0957e6ec22e","name":"Mute speakers if someone is sleeping","info":"","x":3630,"y":700,"wires":[]},{"id":"6c6b54f0dfaad3fc","type":"change","z":"3ad1e0957e6ec22e","name":"Set entity_id","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"move","p":"entity_id","pt":"msg","to":"payload.data.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":3310,"y":740,"wires":[["8e4304a0b3903d05"]]},{"id":"d25cf718657e59c8","type":"trigger-state","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"media_player\\.(?!.*?group.*?).*[a-z]_speaker$","entityIdType":"regex","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"re","comparatorValue":"(buffering|idle)"},{"targetType":"this_entity","targetValue":"","propertyType":"property","propertyValue":"old_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"},{"targetType":"this_entity","targetValue":"","propertyType":"property","propertyValue":"new_state.attributes.is_volume_muted","comparatorType":"is_not","comparatorValueDatatype":"str","comparatorValue":"true"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":250,"y":640,"wires":[["abc2966ea146bf03"],[]]},{"id":"f59af640c5f71144","type":"switch","z":"3ad1e0957e6ec22e","name":"Speaker is not muted","property":"data.event.new_state.attributes.is_volume_muted","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":900,"y":620,"wires":[["1a1b9e0c796c591e"]]},{"id":"abc2966ea146bf03","type":"switch","z":"3ad1e0957e6ec22e","name":"Speaker is not bathroom","property":"topic","propertyType":"msg","rules":[{"t":"neq","v":"media_player.bathroom_speaker","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":650,"y":620,"wires":[["f59af640c5f71144"]]},{"id":"e604d926fde07e38","type":"function","z":"3ad1e0957e6ec22e","name":"Extract artist adn set musicbrainz query","func":"var artist = msg.data.new_state.attributes.media_artist; // light group\n\nvar url = \"https://musicbrainz.org/ws/2/artist/?query=name:\" + artist;\n\n\nvar msg = {\n     \"url\": url\n\n}\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1320,"y":3920,"wires":[["d88f7beff67b4551"]]},{"id":"d88f7beff67b4551","type":"http request","z":"3ad1e0957e6ec22e","name":"","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1590,"y":3920,"wires":[["4b6c964f98d73f8d"]]},{"id":"4b6c964f98d73f8d","type":"xml","z":"3ad1e0957e6ec22e","name":"","property":"payload","attr":"","chr":"","x":1790,"y":3920,"wires":[["2a8f874a6bdfd9b6"]]},{"id":"845613f72bbe792e","type":"debug","z":"3ad1e0957e6ec22e","name":"debug 265","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"","statusType":"msg","x":2490,"y":3920,"wires":[]},{"id":"2a8f874a6bdfd9b6","type":"function","z":"3ad1e0957e6ec22e","name":"Extract Artist for API call to Lidarr","func":"var id = msg.payload.metadata[\"artist-list\"][0].artist[0].$.id;\nvar url = \"http://192.168.0.20:8686/api/v1/artist\";\nvar name = msg.payload.metadata[\"artist-list\"][0].artist[0].name[0];\n\nvar msg = {\n     \"url\": url,\n     \"payload\": {\n          \"ArtistName\": name,\n          \"Path\": \"/media/Music/\" + name,\n          \"rootFolderPath\": \"/media/Music\",\n          \"ForeignArtistId\": id,\n          \"QualityProfileId\": \"1\",\n          \"MetadataProfileId\": \"1\",\n          \"Monitored\": true\n     }\n\n};\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2040,"y":3920,"wires":[["36b122293cbe8418"]]},{"id":"36b122293cbe8418","type":"http request","z":"3ad1e0957e6ec22e","name":"","method":"POST","ret":"txt","paytoqs":"body","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"bearer","senderr":false,"headers":[],"x":2290,"y":3920,"wires":[["845613f72bbe792e"]]},{"id":"143feff05fb098e3","type":"comment","z":"3ad1e0957e6ec22e","name":"Check chromecasts  for playback","info":"","x":230,"y":3880,"wires":[]},{"id":"0a7c9f5ac79972d6","type":"comment","z":"3ad1e0957e6ec22e","name":"Extract Artist for musicbrainz Querry to get the ID","info":"","x":1300,"y":3880,"wires":[]},{"id":"5d631f37277fe401","type":"comment","z":"3ad1e0957e6ec22e","name":"Get musicbrainz ","info":"","x":1580,"y":3880,"wires":[]},{"id":"78b9d7fc62622795","type":"comment","z":"3ad1e0957e6ec22e","name":"Convert to XML","info":"","x":1800,"y":3880,"wires":[]},{"id":"0d3a722db40fae10","type":"comment","z":"3ad1e0957e6ec22e","name":"Extract data for Lidarr callback","info":"","x":2060,"y":3880,"wires":[]},{"id":"4c802fbc4b4c611a","type":"comment","z":"3ad1e0957e6ec22e","name":"Add to Lidarr","info":"","x":2290,"y":3880,"wires":[]},{"id":"463aa6e97cab31f0","type":"delay","z":"3ad1e0957e6ec22e","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"10","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":1040,"y":3920,"wires":[["e604d926fde07e38"]]},{"id":"89cb984b89259a41","type":"switch","z":"3ad1e0957e6ec22e","name":"Music?","property":"data.new_state.attributes.media_content_type","propertyType":"msg","rules":[{"t":"eq","v":"music","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":620,"y":3920,"wires":[["07de97ce5b3ea831"]]},{"id":"9d8388666e6b17c3","type":"comment","z":"3ad1e0957e6ec22e","name":"Confirm music is playing","info":"","x":590,"y":3880,"wires":[]},{"id":"75a06e7064285b73","type":"server-state-changed","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"media_player\\.(?!.*?plex.*?)[a-z_]*_chromecast","entityIdType":"regex","outputInitially":false,"stateType":"str","ifState":"playing","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":270,"y":3920,"wires":[["89cb984b89259a41"],[]]},{"id":"c0843573bc3e1929","type":"server-state-changed","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.party_mode","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":200,"y":4140,"wires":[["8c6136816c372915"],[]]},{"id":"8c6136816c372915","type":"trigger","z":"3ad1e0957e6ec22e","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"15","extend":false,"overrideDelay":false,"units":"min","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":530,"y":4140,"wires":[["02f7295b44608fe0"]]},{"id":"02f7295b44608fe0","type":"ha-get-entities","z":"3ad1e0957e6ec22e","name":"Get ChromecastMedia players","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.(?!plex).*_chromecast","valueType":"re"},{"property":"state","logic":"is","value":"off","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":850,"y":4140,"wires":[["7b0bd74d9726336c"]]},{"id":"7b0bd74d9726336c","type":"delay","z":"3ad1e0957e6ec22e","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"8","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1100,"y":4140,"wires":[["1274d6c20ffd5f60"]]},{"id":"1274d6c20ffd5f60","type":"change","z":"3ad1e0957e6ec22e","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1350,"y":4140,"wires":[["36f9f8deb6267ebb"]]},{"id":"36f9f8deb6267ebb","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"play visuals","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":[],"data":"{\"media_content_id\":\"plex://{ \\\"playlist_name\\\": \\\"All visuals\\\", \\\"shuffle\\\": 1 }\",\"media_content_type\":\"playlist\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1590,"y":4140,"wires":[["002b81243c26acf0"]]},{"id":"002b81243c26acf0","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"Set volume to 0.1","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"volume_level\":\"0.1\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1790,"y":4140,"wires":[["81a6bbceafeac20c"]]},{"id":"81a6bbceafeac20c","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"Mute Volume","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\": \"true\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1990,"y":4140,"wires":[[]]},{"id":"2f1afe0e5a874c4c","type":"comment","z":"3ad1e0957e6ec22e","name":"Play soft visuals when party mode is triggered","info":"","x":210,"y":4100,"wires":[]},{"id":"96b1cb45b06ea375","type":"comment","z":"3ad1e0957e6ec22e","name":"15 minutes cooldown","info":"","x":520,"y":4100,"wires":[]},{"id":"5ef1e991bb7d875a","type":"comment","z":"3ad1e0957e6ec22e","name":"Pull all inactive Chromecasts entities","info":"","x":840,"y":4100,"wires":[]},{"id":"ab53133d21bcf288","type":"comment","z":"3ad1e0957e6ec22e","name":"rate limit at 1 per 8s","info":"","x":1090,"y":4100,"wires":[]},{"id":"f6ec08d3069cc757","type":"comment","z":"3ad1e0957e6ec22e","name":"Extract the entity id","info":"","x":1350,"y":4100,"wires":[]},{"id":"a9f03579f152484b","type":"comment","z":"3ad1e0957e6ec22e","name":"Start the visuals playlist","info":"","x":1580,"y":4100,"wires":[]},{"id":"baac9591853a5457","type":"comment","z":"3ad1e0957e6ec22e","name":"Set volume to 0.1","info":"","x":1800,"y":4100,"wires":[]},{"id":"7ff5b1c7a5f56df7","type":"comment","z":"3ad1e0957e6ec22e","name":"Mute the Tv","info":"","x":1990,"y":4100,"wires":[]},{"id":"917277eef2953310","type":"trigger","z":"3ad1e0957e6ec22e","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"15","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":550,"y":4260,"wires":[["89d0d1d918564386"]]},{"id":"22ffd9edca8397c0","type":"comment","z":"3ad1e0957e6ec22e","name":"15 seconds cooldown","info":"","x":540,"y":4220,"wires":[]},{"id":"89d0d1d918564386","type":"ha-get-entities","z":"3ad1e0957e6ec22e","name":"Get  Light groups","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"light\\.(?!.*?all.*?)(?!.*?door.*?).*?_lights$","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":770,"y":4260,"wires":[["eadbb9bbbd90b04e"]]},{"id":"3feed2b2c6fdac36","type":"comment","z":"3ad1e0957e6ec22e","name":"Pull all light groups","info":"","x":770,"y":4220,"wires":[]},{"id":"73896dfa4fb8d996","type":"server-state-changed","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.party_mode","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":200,"y":4260,"wires":[["917277eef2953310"],[]]},{"id":"73ceade6131f58c4","type":"comment","z":"3ad1e0957e6ec22e","name":"Change light groups to random colors on party mode","info":"","x":230,"y":4220,"wires":[]},{"id":"eadbb9bbbd90b04e","type":"switch","z":"3ad1e0957e6ec22e","name":"","property":"payload.attributes.supported_color_modes","propertyType":"msg","rules":[{"t":"regex","v":"(xy|hs)","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":990,"y":4260,"wires":[["295a50d373ea7d0b"]]},{"id":"9cf9611c81347b2e","type":"comment","z":"3ad1e0957e6ec22e","name":"Check for color support","info":"","x":980,"y":4220,"wires":[]},{"id":"295a50d373ea7d0b","type":"function","z":"3ad1e0957e6ec22e","name":"Generate Random saturated color","func":"var entity_id = msg.payload.entity_id;\n\n\nvar hue = Math.floor(Math.random() * 360); //generate a random number up to 360\n\nvar hs_color = hue + \",60\";\nvar hs_color_array = hs_color.split(\",\");\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"hs_color\": hs_color_array,\n            \"entity_id\": entity_id,\n            \"brightness_pct\": 100\n            \n}\n        }\n    }\n;\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1260,"y":4260,"wires":[["c0e0e1dede43580b"]]},{"id":"c0e0e1dede43580b","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1550,"y":4260,"wires":[[]]},{"id":"920b0688b303f501","type":"comment","z":"3ad1e0957e6ec22e","name":"Generated random HS 60% saturated color","info":"","x":1260,"y":4220,"wires":[]},{"id":"e0608cb33087d9bd","type":"comment","z":"3ad1e0957e6ec22e","name":"Call light_on service","info":"","x":1550,"y":4220,"wires":[]},{"id":"1ed233c0367b3522","type":"random","z":"3ad1e0957e6ec22e","name":"","low":"1","high":"11","inte":"true","property":"number","x":1300,"y":4360,"wires":[["50f03fb059f6ea65"]]},{"id":"50f03fb059f6ea65","type":"function","z":"3ad1e0957e6ec22e","name":"Playlist Selector","func":"var number = msg.number;\nvar entity_id = msg.payload.entity_id\nif (number == 1) {\n  var playlist = \"Automatic Atmospheric Playlist\";\n} else if (number == 2) {\n  var playlist = \"Automatic Happy Playlist\";\n} else if (number == 3) {\n  var playlist = \"Automatic Indie-Pop Playlist\";\n} else if (number == 4) {\n  var playlist = \"Automatic Pop-Rock Playlist\";\n} else if (number == 5) {\n  var playlist = \"Automatic Psychedelic Playlist\";\n} else if (number == 6) {\n  var playlist = \"Indie-pop Music\";\n} else if (number == 7) {\n  var playlist = \"Rock Music\";\n} else if (number == 8) {\n  var playlist = \"Latin Music\";\n} else if (number == 9) {\n  var playlist = \"Psychedelic Music\";\n} else if (number == 10) {\n  var playlist = \"Ambient Music\";\n} else if (number == 11) {\n  var playlist = \"Recently Added\";\n} else {\n    \n}\n\n\nvar newMsg = {\n    \"payload\": { \n        \"data\": {\n              \"media_content_id\": 'plex://{ \"playlist_name\":'+ ' \"' + playlist + '\", \"shuffle\": 1 }',\n              \"media_content_type\": \"playlist\",\n              \"entity_id\": entity_id\n            \n        }\n}\n};\nreturn newMsg;\n\n\n// a switch can be used instead of a unch of else ifs","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1580,"y":4360,"wires":[["d751ec94f35faa0d"]]},{"id":"d751ec94f35faa0d","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"play music","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1850,"y":4360,"wires":[[]]},{"id":"a76efc4ab5b56f29","type":"ha-get-entities","z":"3ad1e0957e6ec22e","name":"Get Google cast groups","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.group_.*_speakers","valueType":"re"},{"property":"state","logic":"is_not","value":"playing","valueType":"str"},{"property":"entity_id","logic":"is_not","value":"(media_player.group_maxi_speakers|group_kitchen_speakers|media_player.group_hotbox_upper_speakers|media_player.group_hotbox_lower_speakers|media_player.group_home_speakers)","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":790,"y":4360,"wires":[["3ba0c3863600c878"]]},{"id":"3ba0c3863600c878","type":"delay","z":"3ad1e0957e6ec22e","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"3","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1020,"y":4360,"wires":[["1ed233c0367b3522"]]},{"id":"8d85249887f86d9d","type":"server-state-changed","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.party_mode","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":200,"y":4360,"wires":[["3a47a2d796c18ff9"],[]]},{"id":"1aa7f611d51f17cf","type":"comment","z":"3ad1e0957e6ec22e","name":"Start music in each room when party mode is on","info":"","x":220,"y":4320,"wires":[]},{"id":"9633b560f8bfa29c","type":"comment","z":"3ad1e0957e6ec22e","name":"rate limit at 1 per 8s","info":"","x":1010,"y":4320,"wires":[]},{"id":"c363de697b9a97da","type":"comment","z":"3ad1e0957e6ec22e","name":"Pull all speaker groups","info":"","x":800,"y":4320,"wires":[]},{"id":"1bdf3bf4fbbe7434","type":"comment","z":"3ad1e0957e6ec22e","name":"Generated number between 1 and 11","info":"","x":1290,"y":4320,"wires":[]},{"id":"d75eb19853b4aa27","type":"comment","z":"3ad1e0957e6ec22e","name":"Select playlist with number","info":"","x":1570,"y":4320,"wires":[]},{"id":"7ded67246d82136e","type":"comment","z":"3ad1e0957e6ec22e","name":"Send media_play service","info":"","x":1830,"y":4320,"wires":[]},{"id":"3a47a2d796c18ff9","type":"api-current-state","z":"3ad1e0957e6ec22e","name":"Home group","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"playing","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"media_player.group_home_speakers","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":530,"y":4360,"wires":[["a76efc4ab5b56f29"],[]]},{"id":"471935cb5043caf9","type":"comment","z":"3ad1e0957e6ec22e","name":"Make sure the home group is off","info":"","x":550,"y":4320,"wires":[]},{"id":"e6e9ba414e1292f1","type":"poll-state","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":3,"exposeAsEntityConfig":"","updateInterval":"10","updateIntervalType":"num","updateIntervalUnits":"minutes","outputInitially":true,"outputOnChanged":true,"entityId":"sensor.amount_friends_home","stateType":"str","ifState":"4","ifStateType":"num","ifStateOperator":"gt","outputs":2,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":190,"y":4020,"wires":[["190afdf8590d2e25"],[]]},{"id":"adb29a384078faab","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"turn on party mode","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.party_mode"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":890,"y":4020,"wires":[[]]},{"id":"e59fabcafe09cc38","type":"comment","z":"3ad1e0957e6ec22e","name":"Turn on Party mode when 5 guests are over","info":"","x":210,"y":3980,"wires":[]},{"id":"190afdf8590d2e25","type":"api-current-state","z":"3ad1e0957e6ec22e","name":"Kink party is off?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.kink_party","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":460,"y":4020,"wires":[["218df787e822d7ca"],[]]},{"id":"218df787e822d7ca","type":"api-current-state","z":"3ad1e0957e6ec22e","name":"Acid time is off?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.acid_time","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":680,"y":4020,"wires":[["adb29a384078faab"],[]]},{"id":"60bcceff9f85e8bc","type":"comment","z":"3ad1e0957e6ec22e","name":"Turn on party mode","info":"","x":890,"y":3980,"wires":[]},{"id":"bae3917b891c9b90","type":"comment","z":"3ad1e0957e6ec22e","name":"(bug mitigation)","info":"The Google chromecasts don't always give the right volume, this forces an update","x":1800,"y":4180,"wires":[]},{"id":"66a00aba4f8999a7","type":"server-state-changed","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"sensor.bootminutes","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"4.0","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":180,"y":4460,"wires":[["915fdb19f046fa28"],[]]},{"id":"3efea23ef50d70dd","type":"comment","z":"3ad1e0957e6ec22e","name":"Reload pages when HASS rebooted 4 minutes ago","info":"","x":230,"y":4420,"wires":[]},{"id":"915fdb19f046fa28","type":"ha-get-entities","z":"3ad1e0957e6ec22e","name":"Get  Load URL button entities","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"button\\..*load_start_url","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":520,"y":4460,"wires":[["321d315faac88325"]]},{"id":"a4d75435c042d811","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"press button","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"button","service":"press","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1210,"y":4460,"wires":[[]]},{"id":"321d315faac88325","type":"change","z":"3ad1e0957e6ec22e","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":870,"y":4460,"wires":[["a4d75435c042d811"]]},{"id":"89009c92b47d616f","type":"comment","z":"3ad1e0957e6ec22e","name":"Extract the entity id","info":"","x":850,"y":4420,"wires":[]},{"id":"be4e2b5b378e7400","type":"comment","z":"3ad1e0957e6ec22e","name":"Get FKB reload butons","info":"","x":540,"y":4420,"wires":[]},{"id":"7032e96b7c4940a6","type":"comment","z":"3ad1e0957e6ec22e","name":"Press Button","info":"","x":1190,"y":4420,"wires":[]},{"id":"54cf7f2e9ffc09a8","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"Waiting Uber On","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.waiting_uber"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":540,"y":4600,"wires":[[]]},{"id":"94dbd7834e687658","type":"server-state-changed","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"sensor.purgatoire1134_uber","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"On","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":210,"y":4600,"wires":[["54cf7f2e9ffc09a8"],[]]},{"id":"0dacbde8531bb41c","type":"comment","z":"3ad1e0957e6ec22e","name":"Turn on \"Waiting uber\" when uber order is detected","info":"","x":230,"y":4560,"wires":[]},{"id":"07de97ce5b3ea831","type":"switch","z":"3ad1e0957e6ec22e","name":"Not plex","property":"data.new_state.attributes.app_name","propertyType":"msg","rules":[{"t":"neq","v":"Plex","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":840,"y":3920,"wires":[["463aa6e97cab31f0"]]},{"id":"b0c6e7f2212e8901","type":"comment","z":"3ad1e0957e6ec22e","name":"Confirm music is not from plex","info":"","x":840,"y":3880,"wires":[]},{"id":"30a97bc7c2b6cbb0","type":"debug","z":"3ad1e0957e6ec22e","name":"debug 283","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload","statusType":"auto","x":610,"y":4660,"wires":[]},{"id":"75cf2565e7110740","type":"trigger-state","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"^binary_sensor\\.(?!.*?bedroom.*?)(?!.*?closet.*?)sensor_.*_occupancy$","entityIdType":"regex","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"},{"targetType":"this_entity","targetValue":"","propertyType":"previous_state","propertyValue":"old_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":310,"y":2160,"wires":[["ff0f60a09e8cd06c","f7d8b78bf7c2858a"],[]]},{"id":"ff0f60a09e8cd06c","type":"function","z":"3ad1e0957e6ec22e","name":"Extract room from motion sensor entity an extract off lights to regex","func":"var motion_entity_id = msg.data.event.new_state.entity_id; // binary_sensor.sensor_bedroom_motion_occupancy\nvar motion_entity_id_split = motion_entity_id.split(\".\");// split on the dot to separate domain and entity\nvar motion_entity_id_wihtout_binary = motion_entity_id_split[1].replace(\"sensor_\", \"\").replace(\"_motion\", \"\").replace(\"_fp1\", \"\").replace(\"fp2_\", \"\").replace(\"_presence\", \"\").replace(\"_occupancy\", \"\").replace(\"_entry\", \"\").replace(\"_exit\", \"\").replace(\"_couch\", \"\");// remove sensor_ and more substrings\nvar regex = \"^light\\\\.(?!.*?group.*?)(?!.*?notification.*?)(?!.*?lights.*?).*\" + motion_entity_id_wihtout_binary + \".*\"; \nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': regex ,  'valueType': 're' },{ 'property': 'state' ,  'logic': 'is_not' , 'value': \"on\" ,  'valueType': 'str' }];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object},\"room\": motion_entity_id_wihtout_binary\n\n}\nreturn msg;\n\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":960,"y":2160,"wires":[["5a3dbf03d377b43a","5a81833454441841"]]},{"id":"5a3dbf03d377b43a","type":"ha-get-entities","z":"3ad1e0957e6ec22e","name":"Get entities","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload.results","output_results_count":1,"x":1330,"y":2160,"wires":[["d2ae1f1089a02614","d9a971625dab2d8b"]]},{"id":"8419c0f01e0cf559","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3530,"y":2180,"wires":[[]]},{"id":"d2ae1f1089a02614","type":"change","z":"3ad1e0957e6ec22e","name":"rules","rules":[{"t":"move","p":"payload","pt":"msg","to":"entity","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1570,"y":2160,"wires":[["a3d8e274aee82b8a"]]},{"id":"f34e20c2334ccf4c","type":"comment","z":"3ad1e0957e6ec22e","name":"Detect motion across ocupancy sensors","info":"","x":170,"y":2120,"wires":[]},{"id":"29c20247a612b7c8","type":"comment","z":"3ad1e0957e6ec22e","name":"(Ignores \"Closet\", \"Bedroom\" sensors)","info":"","x":490,"y":2120,"wires":[]},{"id":"95a4c5dd36cd88b2","type":"comment","z":"3ad1e0957e6ec22e","name":"Generate the regex for get entity node","info":"","x":1050,"y":2120,"wires":[]},{"id":"a32f9f37badef6fe","type":"comment","z":"3ad1e0957e6ec22e","name":"Get off light entities","info":"","x":1330,"y":2120,"wires":[]},{"id":"7b91e7430afd08ea","type":"comment","z":"3ad1e0957e6ec22e","name":"Move payload to entity","info":"","x":1560,"y":2120,"wires":[]},{"id":"b9f088c7a0898053","type":"comment","z":"3ad1e0957e6ec22e","name":"Select color, brightness and set entity_id","info":"","x":3360,"y":2220,"wires":[]},{"id":"5c924378f03832ef","type":"comment","z":"3ad1e0957e6ec22e","name":"Turn the lights on","info":"","x":3520,"y":2140,"wires":[]},{"id":"6e0313cad534393b","type":"function","z":"3ad1e0957e6ec22e","name":"Brightness selector","func":"var d = new Date();\nvar h = d.getHours();\n\nif (h > 22){\n    var brightness_percentage = \"45\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness_percentage = \"40\";\n}\nelse if (h > 2 && h<8){\n    var brightness_percentage = \"25\";\n}\nelse if (h >= 8 && h<9){\n    var brightness_percentage = \"35\";\n}\nelse{\n    var brightness_percentage = \"50\";\n}\nmsg=\n{\n    \"payload\":{\n        \"data\": {\n        \"entity_id\": msg.payload.entity.entity_id,\n        \"brightness_pct\": brightness_percentage,\n        \"color_name\":  \"white\"\n    }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3290,"y":2180,"wires":[["8419c0f01e0cf559"]]},{"id":"5fee30b61a27e6e5","type":"api-current-state","z":"3ad1e0957e6ec22e","name":"Acid time","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.acid_time","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3020,"y":2160,"wires":[["88b1d87eacc8b8e0"],["c78ba01e2c786587"]]},{"id":"e0dea2b09c9b5232","type":"debug","z":"3ad1e0957e6ec22e","name":"debug 294","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2190,"y":2200,"wires":[]},{"id":"f7d8b78bf7c2858a","type":"debug","z":"3ad1e0957e6ec22e","name":"debug 295","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":790,"y":2120,"wires":[]},{"id":"5a81833454441841","type":"debug","z":"3ad1e0957e6ec22e","name":"debug 296","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1330,"y":2200,"wires":[]},{"id":"a3d8e274aee82b8a","type":"api-current-state","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"sensor.active_sleeper_rooms","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"room_sleepers","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1870,"y":2160,"wires":[["e0dea2b09c9b5232","51dbd35861e70217"]]},{"id":"d9a971625dab2d8b","type":"debug","z":"3ad1e0957e6ec22e","name":"debug 297","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1590,"y":2200,"wires":[]},{"id":"777b0400e36fa32b","type":"inject","z":"3ad1e0957e6ec22e","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"data","v":"{\"event_type\":\"state_changed\",\"entity_id\":\"binary_sensor.sensor_hallway_motion_occupancy\",\"event\":{\"entity_id\":\"binary_sensor.sensor_hallway_motion_occupancy\",\"old_state\":{\"entity_id\":\"binary_sensor.sensor_hallway_motion_occupancy\",\"state\":\"off\",\"attributes\":{\"battery\":100,\"device\":{\"applicationVersion\":11,\"dateCode\":\"20160524\",\"friendlyName\":\"sensor_hallway_motion\",\"hardwareVersion\":2,\"ieeeAddr\":\"0x00158d0002275fd4\",\"manufacturerID\":4151,\"manufacturerName\":\"LUMI\",\"model\":\"RTCGQ01LM\",\"networkAddress\":36327,\"powerSource\":\"Battery\",\"softwareBuildID\":\"3000-0001\",\"stackVersion\":2,\"type\":\"EndDevice\",\"zclVersion\":1},\"linkquality\":29,\"occupancy\":false,\"power_outage_count\":23115,\"voltage\":3035,\"device_class\":\"motion\",\"friendly_name\":\"Hallway Motion_occupancy\"},\"last_changed\":\"2023-08-02T15:45:12.640577+00:00\",\"last_updated\":\"2023-08-02T15:45:12.640577+00:00\",\"context\":{\"id\":\"01H6VESCE0WYF8ZX13SQC5N487\",\"parent_id\":null,\"user_id\":null},\"original_state\":\"off\"},\"new_state\":{\"entity_id\":\"binary_sensor.sensor_hallway_motion_occupancy\",\"state\":\"on\",\"attributes\":{\"battery\":100,\"device\":{\"applicationVersion\":11,\"dateCode\":\"20160524\",\"friendlyName\":\"sensor_hallway_motion\",\"hardwareVersion\":2,\"ieeeAddr\":\"0x00158d0002275fd4\",\"manufacturerID\":4151,\"manufacturerName\":\"LUMI\",\"model\":\"RTCGQ01LM\",\"networkAddress\":36327,\"powerSource\":\"Battery\",\"softwareBuildID\":\"3000-0001\",\"stackVersion\":2,\"type\":\"EndDevice\",\"zclVersion\":1},\"linkquality\":29,\"occupancy\":false,\"power_outage_count\":23115,\"voltage\":3035,\"device_class\":\"motion\",\"friendly_name\":\"Hallway Motion_occupancy\"},\"last_changed\":\"2023-08-02T15:50:28.404423+00:00\",\"last_updated\":\"2023-08-02T15:50:28.404423+00:00\",\"context\":{\"id\":\"01H6VF30SMTSYD1N217CFJ7GQT\",\"parent_id\":null,\"user_id\":\"7f1de31122574f6fa2215e519d6083ea\"},\"original_state\":\"on\",\"timeSinceChangedMs\":5}},\"origin\":\"LOCAL\",\"time_fired\":\"2023-08-02T15:50:28.404423+00:00\",\"context\":{\"id\":\"01H6VF30SMTSYD1N217CFJ7GQT\",\"parent_id\":null,\"user_id\":\"7f1de31122574f6fa2215e519d6083ea\"}}","vt":"json"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"binary_sensor.sensor_hallway_motion_occupancy","payload":"on","payloadType":"str","x":1330,"y":2080,"wires":[["d2ae1f1089a02614"]]},{"id":"d0599e2fa55de2b9","type":"switch","z":"3ad1e0957e6ec22e","name":"Is \"active_sleeper_present\" 0?","property":"payload.active_sleeper_present","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"}],"checkall":"false","repair":false,"outputs":1,"x":2650,"y":2160,"wires":[["5fee30b61a27e6e5"]]},{"id":"5dfa51babbba06ed","type":"comment","z":"3ad1e0957e6ec22e","name":"Check that \"active_sleeper_present\" is off","info":" - ","x":2660,"y":2120,"wires":[]},{"id":"e596935b261be053","type":"inject","z":"3ad1e0957e6ec22e","name":"office motion","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"data","v":"{\"event_type\":\"state_changed\",\"entity_id\":\"binary_sensor.sensor_office_motion_occupancy\",\"event\":{\"entity_id\":\"binary_sensor.sensor_office_motion_occupancy\",\"old_state\":{\"entity_id\":\"binary_sensor.sensor_office_motion_occupancy\",\"state\":\"off\",\"attributes\":{\"battery\":100,\"device\":{\"applicationVersion\":11,\"friendlyName\":\"sensor_office_motion\",\"ieeeAddr\":\"0x00158d0002281294\",\"manufacturerID\":4151,\"manufacturerName\":\"LUMI\",\"model\":\"RTCGQ01LM\",\"networkAddress\":28396,\"powerSource\":\"Battery\",\"type\":\"EndDevice\"},\"linkquality\":87,\"occupancy\":false,\"power_outage_count\":77,\"voltage\":3075,\"device_class\":\"motion\",\"friendly_name\":\"Hotbox Down Motion_occupancy\"},\"last_changed\":\"2023-08-03T13:07:10.739670+00:00\",\"last_updated\":\"2023-08-03T13:07:10.739670+00:00\",\"context\":{\"id\":\"01H6XR4QRKMSW2KB245H9T6KFT\",\"parent_id\":null,\"user_id\":null},\"original_state\":\"off\"},\"new_state\":{\"entity_id\":\"binary_sensor.sensor_office_motion_occupancy\",\"state\":\"on\",\"attributes\":{\"battery\":100,\"device\":{\"applicationVersion\":11,\"friendlyName\":\"sensor_office_motion\",\"ieeeAddr\":\"0x00158d0002281294\",\"manufacturerID\":4151,\"manufacturerName\":\"LUMI\",\"model\":\"RTCGQ01LM\",\"networkAddress\":28396,\"powerSource\":\"Battery\",\"type\":\"EndDevice\"},\"linkquality\":87,\"occupancy\":false,\"power_outage_count\":77,\"voltage\":3075,\"device_class\":\"motion\",\"friendly_name\":\"Hotbox Down Motion_occupancy\"},\"last_changed\":\"2023-08-03T13:28:46.214518+00:00\",\"last_updated\":\"2023-08-03T13:28:46.214518+00:00\",\"context\":{\"id\":\"01H6XSC8W6W0RJ9N7G6RVXA89K\",\"parent_id\":null,\"user_id\":\"7f1de31122574f6fa2215e519d6083ea\"},\"original_state\":\"on\",\"timeSinceChangedMs\":4}},\"origin\":\"LOCAL\",\"time_fired\":\"2023-08-03T13:28:46.214518+00:00\",\"context\":{\"id\":\"01H6XSC8W6W0RJ9N7G6RVXA89K\",\"parent_id\":null,\"user_id\":\"7f1de31122574f6fa2215e519d6083ea\"}}","vt":"json"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"binary_sensor.sensor_office_motion_occupancy","payload":"on","payloadType":"str","x":530,"y":2200,"wires":[["ff0f60a09e8cd06c"]]},{"id":"51dbd35861e70217","type":"function","z":"3ad1e0957e6ec22e","name":"Check if any sleeper is in the triggered room","func":"\n\nvar room = msg.room.replace('_down', '').replace('_exit', '').replace('_top', '');\nvar room_sleepers = msg.room_sleepers;\nvar active = 0;\n\nvar active = compareArrayToString(room_sleepers, room);\n\n\nvar msg = {\n    \"payload\": {\n    \"room\": room,\n    \"room_sleepers\": room_sleepers,\n    \"entity\": msg.entity,\n    \"active_sleeper_present\": active,\n     \"data\": msg.data\n    },\n    \"entity_id\": msg.entity.entity_id\n\n}\nreturn msg;\n\n\nfunction compareArrayToString(array, string) {\n    var array_string = String(array)\n\n\n    if (array_string.includes(string)) {\n        // return 1 if found\n        return 1;\n    }\n\n\n    // return off if none found\n    return 0;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2290,"y":2160,"wires":[["d0599e2fa55de2b9","9c11a0a5f77492b5"]]},{"id":"9c11a0a5f77492b5","type":"debug","z":"3ad1e0957e6ec22e","name":"debug 300","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2590,"y":2200,"wires":[]},{"id":"ab99a49d19ea27a0","type":"comment","z":"3ad1e0957e6ec22e","name":"Check if a trip is ongoing","info":" - ","x":3010,"y":2120,"wires":[]},{"id":"9ea910667bcc454e","type":"debug","z":"3ad1e0957e6ec22e","name":"debug 301","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2210,"y":660,"wires":[]},{"id":"2e01db33c01a6c79","type":"api-current-state","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"sensor.active_sleeper_rooms","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"room_sleepers","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1890,"y":620,"wires":[["9ea910667bcc454e","f6ac31de9e7d3aa8"]]},{"id":"8fa4d671ac062646","type":"switch","z":"3ad1e0957e6ec22e","name":"Is \"active_sleeper_present\" 0?","property":"payload.active_sleeper_present","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"num"}],"checkall":"false","repair":false,"outputs":2,"x":2670,"y":600,"wires":[["bb550eb68254b69e"],["460c049976cb8d77"]]},{"id":"f6ac31de9e7d3aa8","type":"function","z":"3ad1e0957e6ec22e","name":"Check if any sleeper is in the triggered room","func":"\n\nvar room = msg.room;\nvar room_sleepers = msg.room_sleepers;\nvar active = 0;\n\nvar active = compareArrayToString(room_sleepers, room);\n\n\nvar msg = {\n    \"payload\": {\n    \"room\": room,\n    \"room_sleepers\": room_sleepers,\n    \"entity\": msg.entity,\n    \"active_sleeper_present\": active,\n     \"data\": msg.data\n    },\n    \"entity_id\": msg.entity_id\n\n}\nreturn msg;\n\n\nfunction compareArrayToString(array, string) {\n    var array_string = String(array)\n\n\n    if (array_string.includes(string)) {\n        // return 1 if found\n        return 1;\n    }\n\n\n    // return off if none found\n    return 0;\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2310,"y":620,"wires":[["8fa4d671ac062646","b9c19c7ffc68a966"]]},{"id":"b9c19c7ffc68a966","type":"debug","z":"3ad1e0957e6ec22e","name":"debug 302","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2610,"y":660,"wires":[]},{"id":"302e53ea88470e83","type":"debug","z":"3ad1e0957e6ec22e","name":"debug 304","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1430,"y":660,"wires":[]},{"id":"3ce9f8d6877b7722","type":"ha-get-entities","z":"3ad1e0957e6ec22e","name":"Get entities","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"array","output_empty_results":true,"output_location_type":"msg","output_location":"payload.results","output_results_count":1,"x":1870,"y":820,"wires":[["dddb35c43dc90bfd"]]},{"id":"dddb35c43dc90bfd","type":"switch","z":"3ad1e0957e6ec22e","name":"","property":"payload.results","propertyType":"msg","rules":[{"t":"empty"},{"t":"nempty"}],"checkall":"false","repair":false,"outputs":2,"x":2070,"y":820,"wires":[[],[]]},{"id":"9484d3c039ac9e6b","type":"comment","z":"3ad1e0957e6ec22e","name":"Get sleeper entities in an array","info":"","x":1850,"y":780,"wires":[]},{"id":"c1d461b9f98e71bf","type":"comment","z":"3ad1e0957e6ec22e","name":"Make sure the array is empty","info":"","x":2120,"y":780,"wires":[]},{"id":"961ad875493d53be","type":"inject","z":"3ad1e0957e6ec22e","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"data","v":"{\"entity_id\":\"media_player.livingroom_center_speaker\",\"old_state\":{\"entity_id\":\"media_player.livingroom_center_speaker\",\"state\":\"off\",\"attributes\":{\"device_class\":\"speaker\",\"friendly_name\":\"Living Room Center\",\"supported_features\":152461},\"last_changed\":\"2023-01-12T14:20:58.917426+00:00\",\"last_updated\":\"2023-01-12T14:20:58.917426+00:00\",\"context\":{\"id\":\"01GPK5NZ55A2SFRB8EDV9BDWWJ\",\"parent_id\":null,\"user_id\":null},\"original_state\":\"off\"},\"new_state\":{\"entity_id\":\"media_player.livingroom_center_speaker\",\"state\":\"idle\",\"attributes\":{\"volume_level\":0.44999998807907104,\"is_volume_muted\":false,\"media_position_updated_at\":\"2023-01-12T14:20:58.917088+00:00\",\"app_id\":\"705D30C6\",\"app_name\":\"Default Media Receiver\",\"entity_picture_local\":null,\"device_class\":\"speaker\",\"friendly_name\":\"Living Room Center\",\"supported_features\":152461},\"last_changed\":\"2023-01-12T14:21:00.824073+00:00\",\"last_updated\":\"2023-01-12T14:21:00.824073+00:00\",\"context\":{\"id\":\"01GPK5P10R6FH3EZW0K11BCQ2H\",\"parent_id\":null,\"user_id\":null},\"original_state\":\"idle\",\"timeSinceChangedMs\":2}}","vt":"json"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"media_player.livingroom_center_speaker","payload":"idle","payloadType":"str","x":1790,"y":900,"wires":[[]]},{"id":"3d997d6518e61503","type":"debug","z":"3ad1e0957e6ec22e","name":"debug 303","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1870,"y":860,"wires":[]},{"id":"e45b3c1d18695954","type":"function","z":"3ad1e0957e6ec22e","name":"Entity Setter","func":"msg=\n{\n    \"payload\":{\n        \"data\": {\n        \"entity_id\": msg.payload.entity.entity_id\n    }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3270,"y":2140,"wires":[["8419c0f01e0cf559"]]},{"id":"5388180a1b1a9d95","type":"comment","z":"3ad1e0957e6ec22e","name":"Set the entity_id","info":"","x":3280,"y":2100,"wires":[]},{"id":"6c6ca0383e4133f3","type":"trigger-state","z":"3ad1e0957e6ec22e","name":"All sleeping turns on","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.all_present_sleeping","entityIdType":"regex","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":130,"y":3660,"wires":[["f31d2d5e4e06e41e"],[]]},{"id":"b65e05c12f88c66d","type":"comment","z":"3ad1e0957e6ec22e","name":"Turn on Adaptative Lighting sleep mode upon all sleeping on","info":"","x":260,"y":3620,"wires":[]},{"id":"f31d2d5e4e06e41e","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"Turn on sleeping lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_on","areaId":[],"deviceId":[],"entityId":["switch.adaptive_lighting_sleep_mode_adaptive_lighting"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":760,"y":3660,"wires":[[]]},{"id":"9243e588984b6629","type":"comment","z":"3ad1e0957e6ec22e","name":"Turn on sleeping lights","info":"","x":760,"y":3620,"wires":[]},{"id":"5c72bb7db72e7f59","type":"trigger-state","z":"3ad1e0957e6ec22e","name":"All sleeping turns off","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.all_present_sleeping","entityIdType":"regex","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":130,"y":3760,"wires":[["7925a7da81a4759b"],[]]},{"id":"a9e78ac75aac0e32","type":"comment","z":"3ad1e0957e6ec22e","name":"Turn off Adaptative Lighting sleep mode upon all sleeping off","info":"","x":260,"y":3720,"wires":[]},{"id":"7925a7da81a4759b","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"Turn off sleeping lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_off","areaId":[],"deviceId":[],"entityId":["switch.adaptive_lighting_sleep_mode_adaptive_lighting"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":760,"y":3760,"wires":[[]]},{"id":"e52c117f5dec85ef","type":"comment","z":"3ad1e0957e6ec22e","name":"Turn off sleeping lights","info":"","x":760,"y":3720,"wires":[]},{"id":"bf0be158aac22d2a","type":"comment","z":"3ad1e0957e6ec22e","name":"Turning off the alarm system","info":"","x":160,"y":480,"wires":[]},{"id":"9e3fd01b7a8a5fab","type":"trigger-state","z":"3ad1e0957e6ec22e","name":"","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"^media_player\\.(group_)?mass_.*_speakers?","entityIdType":"regex","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"playing"},{"targetType":"this_entity","targetValue":"","propertyType":"previous_state","propertyValue":"old_state.state","comparatorType":"is_not","comparatorValueDatatype":"str","comparatorValue":"playing"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":250,"y":4740,"wires":[["97b207bf1411acf0","30a97bc7c2b6cbb0"],[]]},{"id":"97b207bf1411acf0","type":"function","z":"3ad1e0957e6ec22e","name":"Set entity for shuffle enabling","func":"\nvar msg = {\n    \"payload\":{\n        \"domain\": \"media_player\",\n        \"service\": \"shuffle_set\",\n        \"target\":{\n            \"entity_id\": msg.data.event.entity_id\n        },\n        \"data\":{\n            \"shuffle\": \"true\"\n        }\n\n}\n}\nreturn msg;\n\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":660,"y":4740,"wires":[["f5c9f354b2c3699f"]]},{"id":"a3bc2c07789a9b94","type":"comment","z":"3ad1e0957e6ec22e","name":"Generate the regex for the get entity node","info":"","x":700,"y":4700,"wires":[]},{"id":"cd4e99584bb764c0","type":"comment","z":"3ad1e0957e6ec22e","name":"Detect all MASS players starting playback","info":"","x":200,"y":4700,"wires":[]},{"id":"f5c9f354b2c3699f","type":"api-call-service","z":"3ad1e0957e6ec22e","name":"Call shuffle service","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"","service":"","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1010,"y":4740,"wires":[[]]},{"id":"6068ed8a2d16572e","type":"trigger","z":"ad8c570ec4ac394a","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"15","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":610,"y":1120,"wires":[["5f1ff2606221f3da"]]},{"id":"5f1ff2606221f3da","type":"ha-get-entities","z":"ad8c570ec4ac394a","name":"Get ChromecastMedia players","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.(?!plex).*_chromecast","valueType":"re"},{"property":"state","logic":"is","value":"off","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":930,"y":1120,"wires":[["11b8508e77092b82"]]},{"id":"11b8508e77092b82","type":"delay","z":"ad8c570ec4ac394a","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"8","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1180,"y":1120,"wires":[["7b39877584962e4a"]]},{"id":"7b39877584962e4a","type":"change","z":"ad8c570ec4ac394a","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1430,"y":1120,"wires":[["a5c306f57feb5805"]]},{"id":"a5c306f57feb5805","type":"api-call-service","z":"ad8c570ec4ac394a","name":"play visuals","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":[],"data":"{\"media_content_id\":\"plex://{ \\\"playlist_name\\\": \\\"All visuals\\\", \\\"shuffle\\\": 1 }\",\"media_content_type\":\"playlist\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1670,"y":1120,"wires":[["12fb54a46d00a846"]]},{"id":"12fb54a46d00a846","type":"api-call-service","z":"ad8c570ec4ac394a","name":"Set volume to 0.1","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"volume_level\":\"0.1\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1870,"y":1120,"wires":[["398f48e21a51b004"]]},{"id":"398f48e21a51b004","type":"api-call-service","z":"ad8c570ec4ac394a","name":"Mute Volume","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\": \"true\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2070,"y":1120,"wires":[[]]},{"id":"3586d6b055cb9233","type":"comment","z":"ad8c570ec4ac394a","name":"15 seconds cooldown","info":"","x":600,"y":1080,"wires":[]},{"id":"fb7caec077a03aff","type":"comment","z":"ad8c570ec4ac394a","name":"Pull all inactive Chromecasts entities","info":"","x":920,"y":1080,"wires":[]},{"id":"ad9b491d1b77c5fa","type":"comment","z":"ad8c570ec4ac394a","name":"rate limit at 1 per 8s","info":"","x":1170,"y":1080,"wires":[]},{"id":"44479e23cca77b31","type":"comment","z":"ad8c570ec4ac394a","name":"Extract the entity id","info":"","x":1430,"y":1080,"wires":[]},{"id":"96aaa4ef19a0bee5","type":"comment","z":"ad8c570ec4ac394a","name":"Start the visuals playlist","info":"","x":1660,"y":1080,"wires":[]},{"id":"fa094f1bbbe3a0c1","type":"comment","z":"ad8c570ec4ac394a","name":"Set volume to 0.1","info":"","x":1880,"y":1080,"wires":[]},{"id":"34ce572432324952","type":"comment","z":"ad8c570ec4ac394a","name":"Mute the Tv","info":"","x":2070,"y":1080,"wires":[]},{"id":"a86e575a7e0d41c5","type":"server-state-changed","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.acid_time","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":260,"y":1120,"wires":[["6068ed8a2d16572e"],[]]},{"id":"6a1551121912b3c7","type":"comment","z":"ad8c570ec4ac394a","name":"Play trippy visuals when acid mode is triggered","info":"","x":280,"y":1080,"wires":[]},{"id":"4daa01cac8181277","type":"server-state-changed","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.kink_party","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":260,"y":1640,"wires":[["a4034e3426b2b90d"],[]]},{"id":"837d97adee6c9078","type":"trigger","z":"ad8c570ec4ac394a","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"15","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":590,"y":1020,"wires":[["739f28daa568c871"]]},{"id":"6c3c41c2885cb18e","type":"comment","z":"ad8c570ec4ac394a","name":"15 seconds cooldown","info":"","x":580,"y":980,"wires":[]},{"id":"739f28daa568c871","type":"ha-get-entities","z":"ad8c570ec4ac394a","name":"Get  Light entities","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"light\\.(?!.*?group.*?)(?!.*?k95_rgb_2_led.*?)(?!.*?door.*?).*?_(?!.*?lights.*?).*","valueType":"re"},{"property":"state","logic":"is","value":"on","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":830,"y":1020,"wires":[["ae64cb72a1c38399"]]},{"id":"cc2adca2c4baf2d5","type":"comment","z":"ad8c570ec4ac394a","name":"Try to Pull all lit single lights","info":"","x":820,"y":980,"wires":[]},{"id":"5e9bf472a7d3c895","type":"server-state-changed","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.acid_time","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":260,"y":1020,"wires":[["837d97adee6c9078"],[]]},{"id":"760cb0b08e7989ae","type":"comment","z":"ad8c570ec4ac394a","name":"Change light to random colors on acid mode","info":"","x":270,"y":980,"wires":[]},{"id":"ae64cb72a1c38399","type":"switch","z":"ad8c570ec4ac394a","name":"","property":"payload.attributes.supported_color_modes","propertyType":"msg","rules":[{"t":"regex","v":"(xy|hs)","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":1070,"y":1020,"wires":[["2f13453376465f8b"]]},{"id":"7941ec1c14bdf74c","type":"comment","z":"ad8c570ec4ac394a","name":"Check for color support","info":"","x":1060,"y":980,"wires":[]},{"id":"4785df9fde6fcd4d","type":"function","z":"ad8c570ec4ac394a","name":"Generate Random saturated color","func":"var entity_id = msg.payload.entity_id;\n\n\nvar hue = Math.floor(Math.random() * 360); //generate a random number up to 360\n\nvar hs_color = hue + \",100\";\nvar hs_color_array = hs_color.split(\",\");\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"hs_color\": hs_color_array,\n            \"entity_id\": entity_id,\n            \"brightness_pct\": 100\n            \n}\n        }\n    }\n;\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1600,"y":1020,"wires":[["f42aed7de4812f9d"]]},{"id":"f42aed7de4812f9d","type":"api-call-service","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1890,"y":1020,"wires":[[]]},{"id":"5112ea4aa4f5c26d","type":"comment","z":"ad8c570ec4ac394a","name":"Generated random HS 100% saturated color","info":"","x":1610,"y":980,"wires":[]},{"id":"a74bc1ffd3fdd8f9","type":"comment","z":"ad8c570ec4ac394a","name":"Call light_on service","info":"","x":1890,"y":980,"wires":[]},{"id":"0070875ba8af1c52","type":"switch","z":"ad8c570ec4ac394a","name":"","property":"payload.attributes.supported_color_modes","propertyType":"msg","rules":[{"t":"regex","v":"(xy|hs)","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":1070,"y":1640,"wires":[["84d8286bfbe1661d"]]},{"id":"1fafb1100f03e73c","type":"comment","z":"ad8c570ec4ac394a","name":"Check for color support","info":"","x":1060,"y":1600,"wires":[]},{"id":"84d8286bfbe1661d","type":"function","z":"ad8c570ec4ac394a","name":"Generate semi-random saturated color","func":"var entity_id = msg.payload.entity_id;\nvar hue = 'test';\n\nvar hue_under_20 = Math.floor(Math.random() * 20); //generate a random number up to 20\nvar hue_over_260 = Math.floor(Math.random() * 100) + 260; //generate a random number up to 360\nvar random_selector = Math.floor(Math.random() * 2); //generate a random number up to 2 ( 0 index)\n\nswitch(random_selector) {\n  case 0:\n    var hue = hue_under_20;\n    break;\n  case 1:\n    var hue = hue_over_260;\n    // code block\n    break;\n  case 2:\n    var hue = hue_over_260;\n    // code block\n  default:\n}\n\nvar hs_color = hue + \",100\";\nvar hs_color_array = hs_color.split(\",\");\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"hs_color\": hs_color_array,\n            \"entity_id\": entity_id,\n            \"brightness_pct\": 100\n            \n}\n        }\n    }\n;\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1410,"y":1640,"wires":[["ce569981d15e01f9"]]},{"id":"ce569981d15e01f9","type":"api-call-service","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1750,"y":1640,"wires":[[]]},{"id":"8c788bb16d44c998","type":"comment","z":"ad8c570ec4ac394a","name":"Generated HS 100% saturated color between orange and purple","info":"","x":1410,"y":1600,"wires":[]},{"id":"82b870106ace9712","type":"comment","z":"ad8c570ec4ac394a","name":"Call light_on service","info":"","x":1750,"y":1600,"wires":[]},{"id":"a4034e3426b2b90d","type":"trigger","z":"ad8c570ec4ac394a","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"15","extend":false,"overrideDelay":false,"units":"min","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":590,"y":1640,"wires":[["57f236eb64968c51"]]},{"id":"57f236eb64968c51","type":"ha-get-entities","z":"ad8c570ec4ac394a","name":"Get  Light groups","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"light\\.(?!.*?all.*?)(?!.*?door.*?).*?_lights$","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":850,"y":1640,"wires":[["0070875ba8af1c52"]]},{"id":"266772944b486c06","type":"comment","z":"ad8c570ec4ac394a","name":"Pull all light groups","info":"","x":850,"y":1600,"wires":[]},{"id":"d904d25bb9c212a0","type":"comment","z":"ad8c570ec4ac394a","name":"also sets the entity_id","info":"","x":1420,"y":1680,"wires":[]},{"id":"9e0d2a87c4862562","type":"comment","z":"ad8c570ec4ac394a","name":"15 minutes cooldown","info":"","x":580,"y":1600,"wires":[]},{"id":"d610007ced8096fb","type":"comment","z":"ad8c570ec4ac394a","name":"Change light to warmn colors on kink mode","info":"","x":260,"y":1600,"wires":[]},{"id":"9f398a5cb9a82e8d","type":"server-state-changed","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.acid_time","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":260,"y":1300,"wires":[["f48fe17557cf66de"],[]]},{"id":"9881a9f9ac028d1e","type":"comment","z":"ad8c570ec4ac394a","name":"Start music across the place when acid mode is on","info":"","x":290,"y":1260,"wires":[]},{"id":"f48fe17557cf66de","type":"api-current-state","z":"ad8c570ec4ac394a","name":"Home group","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"playing","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"media_player.group_home_speakers","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":650,"y":1300,"wires":[["89dbec727f07e1e0"],[]]},{"id":"dcbcfadfd0a359ad","type":"api-call-service","z":"ad8c570ec4ac394a","name":"play music","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":["media_player.ytube_music_player"],"data":"{\"media_content_id\":\"RDCLAK5uy_mJl9Qy6PpXvT-JbR4DJbGxG6UqOiWqWSg\",\"media_content_type\":\"playlist\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1610,"y":1260,"wires":[[]]},{"id":"12c5ab640f39ceb6","type":"comment","z":"ad8c570ec4ac394a","name":"Make sure Home Group is not playing","info":"","x":650,"y":1260,"wires":[]},{"id":"dfa27ea023fafd5b","type":"comment","z":"ad8c570ec4ac394a","name":"Send media_play command","info":"","x":1620,"y":1220,"wires":[]},{"id":"10b869bd689ae010","type":"inject","z":"ad8c570ec4ac394a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1900,"y":2860,"wires":[["f7a24cb6dbf4c660"]]},{"id":"f7a24cb6dbf4c660","type":"ha-get-entities","z":"ad8c570ec4ac394a","name":"Get active hotbox Media players","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.(?!.*?group.*?)(?!.*?top.*?)(?!.*?plex.*?).*hotbox.*","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":2110,"y":2860,"wires":[["07b3821af4b52692"]]},{"id":"07b3821af4b52692","type":"debug","z":"ad8c570ec4ac394a","name":"debug 5","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":2400,"y":2860,"wires":[]},{"id":"fc6bf96773f2d1a4","type":"inject","z":"ad8c570ec4ac394a","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":580,"y":3200,"wires":[["45e38d814857d3fd"]]},{"id":"2f13453376465f8b","type":"switch","z":"ad8c570ec4ac394a","name":"Exclude groups","property":"payload.attributes.entity_id","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","repair":false,"outputs":1,"x":1300,"y":1020,"wires":[["4785df9fde6fcd4d"]]},{"id":"c681bfada6313045","type":"comment","z":"ad8c570ec4ac394a","name":"Exclude groups","info":"","x":1260,"y":980,"wires":[]},{"id":"67d42729c9dfa729","type":"server-state-changed","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.acid_time","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":260,"y":1460,"wires":[["43c972f7629d8a1f"],[]]},{"id":"73d18616b2404059","type":"server-state-changed","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.kink_party","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":260,"y":1540,"wires":[["43c972f7629d8a1f"],[]]},{"id":"bbb1b673486b2a72","type":"comment","z":"ad8c570ec4ac394a","name":"Close blinds automatically","info":"","x":210,"y":1500,"wires":[]},{"id":"43c972f7629d8a1f","type":"ha-get-entities","z":"ad8c570ec4ac394a","name":"Get  Covers","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"^cover.*","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":550,"y":1500,"wires":[["e9a2f694ad617051"]]},{"id":"934327820cd3b9db","type":"api-call-service","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"set_cover_position","areaId":[],"deviceId":[],"entityId":[],"data":"{\"position\": 0 }","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1270,"y":1500,"wires":[[]]},{"id":"e9a2f694ad617051","type":"change","z":"ad8c570ec4ac394a","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":850,"y":1500,"wires":[["934327820cd3b9db"]]},{"id":"3de0e38b3391fa0f","type":"comment","z":"ad8c570ec4ac394a","name":"Extract the entity id","info":"","x":850,"y":1460,"wires":[]},{"id":"e216d39e85bfde74","type":"trigger","z":"ad8c570ec4ac394a","name":"trigger","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"-27","extend":false,"overrideDelay":true,"units":"s","reset":"off","bytopic":"all","topic":"topic","outputs":1,"x":1290,"y":1800,"wires":[["c35f86c38b307e2a"]]},{"id":"60c802a803ab7630","type":"comment","z":"ad8c570ec4ac394a","name":"resend every minute","info":"","x":590,"y":1540,"wires":[]},{"id":"c35f86c38b307e2a","type":"ha-get-entities","z":"ad8c570ec4ac394a","name":"Get  on Light entities","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"light\\.(?!.*?group.*?)(?!.*?workstation.*?)(?!.*?door.*?).*?_(?!.*?lights.*?).*","valueType":"re"},{"property":"state","logic":"is","value":"on","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1520,"y":1800,"wires":[["d96013fcab1de88f"]]},{"id":"b8918acbc043e03b","type":"comment","z":"ad8c570ec4ac394a","name":"Try to Pull all single lights","info":"","x":1510,"y":1760,"wires":[]},{"id":"c3523ad88b296bc0","type":"server-state-changed","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.trippy_lights_effect","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":320,"y":1860,"wires":[["4427e8d39681e34b"],["6ab4316b4ec28a96"]]},{"id":"b9b72ca9a47fe8bb","type":"comment","z":"ad8c570ec4ac394a","name":"Output the transition speed","info":"","x":250,"y":1700,"wires":[]},{"id":"d96013fcab1de88f","type":"switch","z":"ad8c570ec4ac394a","name":"","property":"payload.attributes.supported_color_modes","propertyType":"msg","rules":[{"t":"regex","v":"(xy|hs)","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":1750,"y":1800,"wires":[["f373e604f393df36"]]},{"id":"ce2a7725a9b135eb","type":"comment","z":"ad8c570ec4ac394a","name":"Check for color support","info":"","x":1740,"y":1760,"wires":[]},{"id":"2c54900f0bdbbea5","type":"function","z":"ad8c570ec4ac394a","name":"Generate Random saturated color","func":"var entity_id = msg.payload.entity_id;\n\n\nvar hue = Math.floor(Math.random() * 360); //generate a random number up to 360\n\nvar hs_color = hue + \",100\";\nvar hs_color_array = hs_color.split(\",\");\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"hs_color\": hs_color_array,\n            \"entity_id\": entity_id,\n            \"transition\": 30\n            \n}\n        }\n    }\n;\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2940,"y":1720,"wires":[["36aeeb784b9b67d3"]]},{"id":"9742776084a6cf49","type":"api-call-service","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3710,"y":1720,"wires":[[]]},{"id":"c4aa529c3bfe0b04","type":"comment","z":"ad8c570ec4ac394a","name":"Generated random HS 100% saturated color","info":"Generates fully saturdated zolors without any white","x":2950,"y":1680,"wires":[]},{"id":"572c1dd0e1c64066","type":"comment","z":"ad8c570ec4ac394a","name":"Call light_on service","info":"","x":3710,"y":1680,"wires":[]},{"id":"f373e604f393df36","type":"switch","z":"ad8c570ec4ac394a","name":"Exclude groups","property":"payload.attributes.entity_id","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","repair":false,"outputs":1,"x":1960,"y":1800,"wires":[["301622d4f5b9283a"]]},{"id":"ffedbf625aa02554","type":"comment","z":"ad8c570ec4ac394a","name":"Exclude groups","info":"","x":1960,"y":1760,"wires":[]},{"id":"301622d4f5b9283a","type":"switch","z":"ad8c570ec4ac394a","name":"Exclude white lights","property":"payload.attributes.hs_color[1]","propertyType":"msg","rules":[{"t":"gt","v":"45","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":2270,"y":1800,"wires":[["266c35d39976b527"]]},{"id":"14e5b5fc211769db","type":"comment","z":"ad8c570ec4ac394a","name":"Exclude white lights","info":"","x":2270,"y":1760,"wires":[]},{"id":"0ab6f9152439d8af","type":"ha-get-entities","z":"ad8c570ec4ac394a","name":"Get on Light entities","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"light\\.(?!.*?all.*?)(?!.*?group.*?)(?!.*?door.*?)(?!.*?nate.*?).*?_(?!.*?lights.*?).*","valueType":"re"},{"property":"state","logic":"is","value":"on","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":600,"y":2040,"wires":[["81946780c56f602e"]]},{"id":"b6bdfe2b7847f2b7","type":"comment","z":"ad8c570ec4ac394a","name":"Try to Pull all single lights","info":"","x":590,"y":2000,"wires":[]},{"id":"81946780c56f602e","type":"switch","z":"ad8c570ec4ac394a","name":"","property":"payload.attributes.supported_color_modes","propertyType":"msg","rules":[{"t":"regex","v":"(xy|hs)","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":830,"y":2040,"wires":[["39e0f12350ee7f1a"]]},{"id":"18201a36b62935e2","type":"comment","z":"ad8c570ec4ac394a","name":"Check for color support","info":"","x":820,"y":2000,"wires":[]},{"id":"37b4f8618d88a9f6","type":"api-call-service","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"color_name\": \"white\",\"transition\": 25}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1950,"y":2040,"wires":[[]]},{"id":"569a244b153689a5","type":"comment","z":"ad8c570ec4ac394a","name":"Call light_on service with 25s transition to white","info":"","x":1960,"y":2000,"wires":[]},{"id":"39e0f12350ee7f1a","type":"switch","z":"ad8c570ec4ac394a","name":"Exclude groups","property":"payload.attributes.entity_id","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","repair":false,"outputs":1,"x":1040,"y":2040,"wires":[["29b0e978a2e3726e"]]},{"id":"070d31bd4f074398","type":"comment","z":"ad8c570ec4ac394a","name":"Exclude groups","info":"","x":1040,"y":2000,"wires":[]},{"id":"29b0e978a2e3726e","type":"switch","z":"ad8c570ec4ac394a","name":"Exclude white lights","property":"payload.attributes.hs_color[1]","propertyType":"msg","rules":[{"t":"gt","v":"45","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1350,"y":2040,"wires":[["ba8f1f9ba7caa887"]]},{"id":"d3bbe811fd5706fe","type":"comment","z":"ad8c570ec4ac394a","name":"Exclude white lights","info":"","x":1350,"y":2000,"wires":[]},{"id":"71b5ac1ee70cb6db","type":"server-state-changed","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.trippy_lights_effect","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"off","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":280,"y":2040,"wires":[["0ab6f9152439d8af"],[]]},{"id":"f53e3ff032543575","type":"comment","z":"ad8c570ec4ac394a","name":"Returns lights to normality when trippy lights is off","info":"","x":280,"y":2000,"wires":[]},{"id":"ba8f1f9ba7caa887","type":"change","z":"ad8c570ec4ac394a","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1610,"y":2040,"wires":[["37b4f8618d88a9f6"]]},{"id":"b63722f5e8efecb9","type":"comment","z":"ad8c570ec4ac394a","name":"Extract the entity id","info":"","x":1610,"y":2000,"wires":[]},{"id":"266c35d39976b527","type":"api-current-state","z":"ad8c570ec4ac394a","name":"Acid mode on?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.acid_time","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2480,"y":1800,"wires":[["9442e076db99a2e1"],["6376942863a60cd1"]]},{"id":"6376942863a60cd1","type":"api-current-state","z":"ad8c570ec4ac394a","name":"Party Mode off?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.party_mode","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2680,"y":1820,"wires":[["2c54900f0bdbbea5"],["6df8b0ea967974ba"]]},{"id":"6df8b0ea967974ba","type":"function","z":"ad8c570ec4ac394a","name":"Generate Random whiteish color","func":"var entity_id = msg.payload.entity_id;\n\n\nvar hue = Math.floor(Math.random() * 360); //generate a random number up to 360\n\nvar hs_color = hue + \",60\";\nvar hs_color_array = hs_color.split(\",\");\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"hs_color\": hs_color_array,\n            \"entity_id\": entity_id,\n            \"transition\": 30\n            \n}\n        }\n    }\n;\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2940,"y":1820,"wires":[["b1f69e31bd7b64d3"]]},{"id":"7c96df0988a1f2e8","type":"api-call-service","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3710,"y":1820,"wires":[[]]},{"id":"2384cfdc8c9ff685","type":"comment","z":"ad8c570ec4ac394a","name":"Generated random HS 60% saturated color","info":"","x":2960,"y":1780,"wires":[]},{"id":"ffdac1079452e050","type":"comment","z":"ad8c570ec4ac394a","name":"Call light_on service","info":"","x":3710,"y":1780,"wires":[]},{"id":"8b33b34cd591cd12","type":"comment","z":"ad8c570ec4ac394a","name":"Is someone high?","info":"","x":2490,"y":1760,"wires":[]},{"id":"95a2f4f003b52cc2","type":"comment","z":"ad8c570ec4ac394a","name":"Is it party time?","info":"","x":2680,"y":1780,"wires":[]},{"id":"36aeeb784b9b67d3","type":"api-current-state","z":"ad8c570ec4ac394a","name":"TRansition?","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_number.trippy_lights_effect_speed","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"payload.data.transition","propertyType":"msg","value":"","valueType":"entityState"}],"for":0,"forType":"num","forUnits":"minutes","x":3210,"y":1720,"wires":[["8638760da61933b1"]]},{"id":"4427e8d39681e34b","type":"api-current-state","z":"ad8c570ec4ac394a","name":"TRansition?","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_number.trippy_lights_effect_speed","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"delay","propertyType":"msg","value":"","valueType":"entityState"}],"for":0,"forType":"num","forUnits":"minutes","x":570,"y":1820,"wires":[["630088e66f7238a1"]]},{"id":"b1f69e31bd7b64d3","type":"api-current-state","z":"ad8c570ec4ac394a","name":"TRansition?","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_number.trippy_lights_effect_speed","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"payload.data.transition","propertyType":"msg","value":"","valueType":"entityState"}],"for":0,"forType":"num","forUnits":"minutes","x":3210,"y":1820,"wires":[["986ec2990f7b1d2b"]]},{"id":"3ec9d48db7a29234","type":"server-state-changed","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_number.trippy_lights_effect_speed","entityIdType":"exact","outputInitially":false,"stateType":"num","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"delay","propertyType":"msg","value":"","valueType":"entityState"}],"x":350,"y":1740,"wires":[["630088e66f7238a1"]]},{"id":"0a7a7514d579949c","type":"function","z":"ad8c570ec4ac394a","name":"Convert MS to S","func":"var seconds = msg.delay * 1000;\n\nvar msg = {\n    \"delay\": seconds\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1100,"y":1800,"wires":[["e216d39e85bfde74"]]},{"id":"74b80452ecae5b16","type":"api-current-state","z":"ad8c570ec4ac394a","name":"Effect on?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.trippy_lights_effect","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":900,"y":1820,"wires":[["0a7a7514d579949c"],[]]},{"id":"b46bfc99d6f67018","type":"comment","z":"ad8c570ec4ac394a","name":"Output the transition speed","info":"","x":570,"y":1780,"wires":[]},{"id":"0e54e9dc17ebe8de","type":"comment","z":"ad8c570ec4ac394a","name":"Is the effect on?","info":"","x":900,"y":1780,"wires":[]},{"id":"37bd44f22fee717e","type":"comment","z":"ad8c570ec4ac394a","name":"Trigger on \"trippy lights effect\" toggle","info":"","x":280,"y":1820,"wires":[]},{"id":"42ddbc4a3d56b5b2","type":"comment","z":"ad8c570ec4ac394a","name":"Output the transition speed","info":"","x":3230,"y":1680,"wires":[]},{"id":"816cb8557c929c95","type":"comment","z":"ad8c570ec4ac394a","name":"Output the transition speed","info":"","x":3230,"y":1780,"wires":[]},{"id":"8638760da61933b1","type":"api-current-state","z":"ad8c570ec4ac394a","name":"Saturation?","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_number.trippy_lights_color_saturation","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"payload.data.hs_color[1]","propertyType":"msg","value":"","valueType":"entityState"}],"for":0,"forType":"num","forUnits":"minutes","x":3450,"y":1720,"wires":[["9742776084a6cf49"]]},{"id":"986ec2990f7b1d2b","type":"api-current-state","z":"ad8c570ec4ac394a","name":"Saturation","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_number.trippy_lights_color_saturation","state_type":"str","blockInputOverrides":true,"outputProperties":[{"property":"payload.data.hs_color[1]","propertyType":"msg","value":"","valueType":"entityState"}],"for":0,"forType":"num","forUnits":"minutes","x":3450,"y":1820,"wires":[["7c96df0988a1f2e8"]]},{"id":"c00687f46b6065e4","type":"comment","z":"ad8c570ec4ac394a","name":"Output the color saturation","info":"","x":3470,"y":1680,"wires":[]},{"id":"2fc677cffaf3712f","type":"comment","z":"ad8c570ec4ac394a","name":"Output the color saturation","info":"","x":3470,"y":1780,"wires":[]},{"id":"df7959a17666432e","type":"server-state-changed","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.show_lyrics","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":200,"y":3380,"wires":[["51ea5ee7a5dee235"],["3d2173d5d941fa22"]]},{"id":"45e38d814857d3fd","type":"ha-get-entities","z":"ad8c570ec4ac394a","name":"Get ChromecastMedia players","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.(?!plex).*_chromecast","valueType":"re"},{"property":"state","logic":"is","value":"off","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1190,"y":3380,"wires":[["f5f31a7289f1792a"]]},{"id":"f5f31a7289f1792a","type":"delay","z":"ad8c570ec4ac394a","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"2","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1440,"y":3380,"wires":[["55efad02a56cbde1"]]},{"id":"55efad02a56cbde1","type":"change","z":"ad8c570ec4ac394a","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1690,"y":3380,"wires":[["47c2c09a0f9b8bd0"]]},{"id":"47c2c09a0f9b8bd0","type":"api-call-service","z":"ad8c570ec4ac394a","name":"Cast lyrics","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cast","service":"show_lovelace_view","areaId":[],"deviceId":[],"entityId":[],"data":"{\"dashboard_path\":\"lovelace-hub\",\"view_path\":\"karaoke\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1930,"y":3380,"wires":[["780929606df5a4fc"]]},{"id":"7c556ee0a47317f3","type":"comment","z":"ad8c570ec4ac394a","name":"Display lyrics on TVs when showlyrics mode is triggered","info":"","x":240,"y":3340,"wires":[]},{"id":"b274fab4affe458f","type":"comment","z":"ad8c570ec4ac394a","name":"Pull all inactive Chromecasts entities","info":"","x":1180,"y":3340,"wires":[]},{"id":"1c20b23ec241978b","type":"comment","z":"ad8c570ec4ac394a","name":"rate limit at 1 per 8s","info":"","x":1430,"y":3340,"wires":[]},{"id":"d6d5849a860e48f8","type":"comment","z":"ad8c570ec4ac394a","name":"Extract the entity id","info":"","x":1690,"y":3340,"wires":[]},{"id":"c895a095762bdb40","type":"comment","z":"ad8c570ec4ac394a","name":"Start the visuals playlist","info":"","x":1920,"y":3340,"wires":[]},{"id":"51ea5ee7a5dee235","type":"api-current-state","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"media_player.group_home_speakers","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":670,"y":3380,"wires":[["45e38d814857d3fd"],[]]},{"id":"3d2173d5d941fa22","type":"ha-get-entities","z":"ad8c570ec4ac394a","name":"Get ChromecastMedia players","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.(?!plex).*_chromecast","valueType":"re"},{"property":"attributes.media_title","logic":"is","value":"lovelace-hub: Karaoke","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":610,"y":3520,"wires":[["978e4a94ca1b50a1"]]},{"id":"978e4a94ca1b50a1","type":"change","z":"ad8c570ec4ac394a","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1110,"y":3520,"wires":[["1e4987d26149bf33"]]},{"id":"1e4987d26149bf33","type":"api-call-service","z":"ad8c570ec4ac394a","name":"Stop cast","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1340,"y":3520,"wires":[[]]},{"id":"345108ed53660124","type":"comment","z":"ad8c570ec4ac394a","name":"Make sure Home group is playing","info":"","x":670,"y":3340,"wires":[]},{"id":"1c893d951d205976","type":"comment","z":"ad8c570ec4ac394a","name":"Extract the entity id","info":"","x":1090,"y":3480,"wires":[]},{"id":"8a1a8a7cadb580c7","type":"comment","z":"ad8c570ec4ac394a","name":"Stop the cast","info":"","x":1330,"y":3480,"wires":[]},{"id":"780929606df5a4fc","type":"api-call-service","z":"ad8c570ec4ac394a","name":"mute player","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\":\"true\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2190,"y":3380,"wires":[[]]},{"id":"5595b6a9f9d700dc","type":"comment","z":"ad8c570ec4ac394a","name":"Mute player","info":"","x":2170,"y":3340,"wires":[]},{"id":"07cd581f9b3b5828","type":"comment","z":"ad8c570ec4ac394a","name":"Pull all lyrics casting Chromecasts entities","info":"","x":620,"y":3480,"wires":[]},{"id":"6ffdc8b6e02bfc69","type":"trigger-state","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"sensor.front_door_camera_person_count","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is_not","comparatorValueDatatype":"num","comparatorValue":"0"},{"targetType":"entity_id","targetValue":"input_boolean.waiting_pakidge","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":300,"y":2780,"wires":[["7db0dc91253bee08"],[]]},{"id":"a3905471250639d1","type":"api-call-service","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_fold4","areaId":[],"deviceId":[],"entityId":[],"data":"{\"message\":\"Someone is nearing the door\",\"title\":\"Pakidge Attempt?\",\"data\":{\"image\":\"https://hass.purgatoire.ca/local/pakidge.jpg\"}}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1080,"y":2780,"wires":[[]]},{"id":"7db0dc91253bee08","type":"api-call-service","z":"ad8c570ec4ac394a","name":"Save pakidge.jpg","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.front_door_go2rtc"],"data":"{\"filename\":\"/config/www/pakidge.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":670,"y":2780,"wires":[["a3905471250639d1"]]},{"id":"3c0539b0f3b00da5","type":"trigger","z":"ad8c570ec4ac394a","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":580,"y":740,"wires":[["73d7d43d57b2e30f"]]},{"id":"c37b606f5c9c2ae7","type":"comment","z":"ad8c570ec4ac394a","name":"15 seconds cooldown","info":"","x":580,"y":700,"wires":[]},{"id":"73d7d43d57b2e30f","type":"ha-get-entities","z":"ad8c570ec4ac394a","name":"Get  Light entities","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"light\\.(?!.*?group.*?)(?!.*?k95_rgb_2_led.*?)(?!.*?door.*?).*?_(?!.*?lights.*?).*","valueType":"re"},{"property":"state","logic":"is","value":"on","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":830,"y":740,"wires":[["345651af8bf55493"]]},{"id":"bc07ec44273636ee","type":"comment","z":"ad8c570ec4ac394a","name":"Try to Pull all lit single lights","info":"","x":820,"y":700,"wires":[]},{"id":"f0105def6dddb0f9","type":"server-state-changed","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.random_colors","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":270,"y":740,"wires":[["3c0539b0f3b00da5"],[]]},{"id":"698c1c86b99cb219","type":"comment","z":"ad8c570ec4ac394a","name":"Change light to random colors on press","info":"","x":250,"y":700,"wires":[]},{"id":"345651af8bf55493","type":"switch","z":"ad8c570ec4ac394a","name":"","property":"payload.attributes.supported_color_modes","propertyType":"msg","rules":[{"t":"regex","v":"(xy|hs)","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":1070,"y":740,"wires":[["2566d728b2774429"]]},{"id":"97e7d322435425a6","type":"comment","z":"ad8c570ec4ac394a","name":"Check for color support","info":"","x":1060,"y":700,"wires":[]},{"id":"670a7e87eea13cda","type":"function","z":"ad8c570ec4ac394a","name":"Generate Random saturated color","func":"var entity_id = msg.payload.entity_id;\n\n\nvar hue = Math.floor(Math.random() * 360); //generate a random number up to 360\n\nvar hs_color = hue + \",100\";\nvar hs_color_array = hs_color.split(\",\");\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"hs_color\": hs_color_array,\n            \"entity_id\": entity_id,\n            \"brightness_pct\": 100\n            \n}\n        }\n    }\n;\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1600,"y":740,"wires":[["3346af2c31e1d041"]]},{"id":"3346af2c31e1d041","type":"api-call-service","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1890,"y":740,"wires":[["219fcd606607f1a5"]]},{"id":"20a6bc2656df7cd3","type":"comment","z":"ad8c570ec4ac394a","name":"Generated random HS 100% saturated color","info":"","x":1610,"y":700,"wires":[]},{"id":"4a9b7c8566e06d0e","type":"comment","z":"ad8c570ec4ac394a","name":"Call light_on service","info":"","x":1890,"y":700,"wires":[]},{"id":"2566d728b2774429","type":"switch","z":"ad8c570ec4ac394a","name":"Exclude groups","property":"payload.attributes.entity_id","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","repair":false,"outputs":1,"x":1300,"y":740,"wires":[["670a7e87eea13cda"]]},{"id":"3beee483420df235","type":"comment","z":"ad8c570ec4ac394a","name":"Exclude groups","info":"","x":1260,"y":700,"wires":[]},{"id":"204355a813037618","type":"api-call-service","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.random_colors"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2300,"y":740,"wires":[[]]},{"id":"7fc55e4a8583516a","type":"comment","z":"ad8c570ec4ac394a","name":"Turn off boolean input","info":"","x":2280,"y":700,"wires":[]},{"id":"219fcd606607f1a5","type":"trigger","z":"ad8c570ec4ac394a","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2080,"y":740,"wires":[["204355a813037618"]]},{"id":"3da9382f8b5fb7a1","type":"trigger","z":"ad8c570ec4ac394a","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":580,"y":860,"wires":[["5d0ddef411b27f47"]]},{"id":"262788e499c293fa","type":"comment","z":"ad8c570ec4ac394a","name":"15 seconds cooldown","info":"","x":580,"y":820,"wires":[]},{"id":"5d0ddef411b27f47","type":"ha-get-entities","z":"ad8c570ec4ac394a","name":"Get  Light entities","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"light\\.(?!.*?group.*?)(?!.*?k95_rgb_2_led.*?)(?!.*?door.*?).*?_(?!.*?lights.*?).*","valueType":"re"},{"property":"state","logic":"is","value":"on","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":830,"y":860,"wires":[["97c76ddf1df579b3"]]},{"id":"66c314369e60a72d","type":"comment","z":"ad8c570ec4ac394a","name":"Try to Pull all lit single lights","info":"","x":820,"y":820,"wires":[]},{"id":"7983f47f3129f7f4","type":"server-state-changed","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.random_pastel_colors","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":290,"y":860,"wires":[["3da9382f8b5fb7a1"],[]]},{"id":"4eec48e8082a1681","type":"comment","z":"ad8c570ec4ac394a","name":"Change light to random pastel colors on press","info":"","x":270,"y":820,"wires":[]},{"id":"97c76ddf1df579b3","type":"switch","z":"ad8c570ec4ac394a","name":"","property":"payload.attributes.supported_color_modes","propertyType":"msg","rules":[{"t":"regex","v":"(xy|hs)","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":1070,"y":860,"wires":[["289f7ecb38c37668"]]},{"id":"adaef3244b408911","type":"comment","z":"ad8c570ec4ac394a","name":"Check for color support","info":"","x":1060,"y":820,"wires":[]},{"id":"2a75e80c9ffc8381","type":"function","z":"ad8c570ec4ac394a","name":"Generate Random pastel color","func":"var entity_id = msg.payload.entity_id;\n\n\nvar hue = Math.floor(Math.random() * 360); //generate a random number up to 360\n\nvar hs_color = hue + \",45\";\nvar hs_color_array = hs_color.split(\",\");\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"hs_color\": hs_color_array,\n            \"entity_id\": entity_id,\n            \"brightness_pct\": 100\n            \n}\n        }\n    }\n;\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1590,"y":860,"wires":[["450fecf41250af0e"]]},{"id":"450fecf41250af0e","type":"api-call-service","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1890,"y":860,"wires":[["ddd33f2c5c20b48f"]]},{"id":"ee3668c3dd83cca1","type":"comment","z":"ad8c570ec4ac394a","name":"Generated random HS 55% saturated color","info":"","x":1600,"y":820,"wires":[]},{"id":"14c65687277f04db","type":"comment","z":"ad8c570ec4ac394a","name":"Call light_on service","info":"","x":1890,"y":820,"wires":[]},{"id":"289f7ecb38c37668","type":"switch","z":"ad8c570ec4ac394a","name":"Exclude groups","property":"payload.attributes.entity_id","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","repair":false,"outputs":1,"x":1300,"y":860,"wires":[["2a75e80c9ffc8381"]]},{"id":"04cb1fa9cdb294b1","type":"comment","z":"ad8c570ec4ac394a","name":"Exclude groups","info":"","x":1260,"y":820,"wires":[]},{"id":"2fedca693f45ba39","type":"api-call-service","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.random_pastel_colors"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2300,"y":860,"wires":[[]]},{"id":"d0b078b7d3db8067","type":"comment","z":"ad8c570ec4ac394a","name":"Turn off boolean input","info":"","x":2280,"y":820,"wires":[]},{"id":"ddd33f2c5c20b48f","type":"trigger","z":"ad8c570ec4ac394a","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2080,"y":860,"wires":[["2fedca693f45ba39"]]},{"id":"29d792dddbf23293","type":"trigger","z":"ad8c570ec4ac394a","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":580,"y":540,"wires":[["f74f4229dd1ff813"]]},{"id":"981b8d49db044650","type":"comment","z":"ad8c570ec4ac394a","name":"15 seconds cooldown","info":"","x":580,"y":500,"wires":[]},{"id":"f74f4229dd1ff813","type":"ha-get-entities","z":"ad8c570ec4ac394a","name":"Get  Light entities","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"light\\.(?!.*?group.*?)(?!.*?k95_rgb_2_led.*?)(?!.*?door.*?).*?_(?!.*?lights.*?).*","valueType":"re"},{"property":"state","logic":"is","value":"on","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":830,"y":540,"wires":[["8b52838755e2eff7"]]},{"id":"b391718b61e5d75b","type":"comment","z":"ad8c570ec4ac394a","name":"Try to Pull all lit single lights","info":"","x":820,"y":500,"wires":[]},{"id":"51e95d967df464aa","type":"server-state-changed","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_button.generate_warm_colors","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":290,"y":540,"wires":[["29d792dddbf23293"]]},{"id":"220c74292b512bb5","type":"comment","z":"ad8c570ec4ac394a","name":"Change light to warm saturated colors on press","info":"","x":280,"y":500,"wires":[]},{"id":"8b52838755e2eff7","type":"switch","z":"ad8c570ec4ac394a","name":"","property":"payload.attributes.supported_color_modes","propertyType":"msg","rules":[{"t":"regex","v":"(xy|hs)","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":1070,"y":540,"wires":[["85cd0f79967163cb"]]},{"id":"bf981747e6c1918a","type":"comment","z":"ad8c570ec4ac394a","name":"Check for color support","info":"","x":1060,"y":500,"wires":[]},{"id":"0612fa506e02a3d5","type":"function","z":"ad8c570ec4ac394a","name":"Generate warm saturated color ( to edit)","func":"var entity_id = msg.payload.entity_id;\n\nvar r = Math.round(Math.random() * 4)\nvar hue1 = (Math.round(Math.random() * 100) + 250); //generate a random number up to 150\nvar hue2 = Math.round(Math.random() * 40); //generate a random number up to 150\n//var huef = hue + 250;\nvar saturation = (Math.round(Math.random() * 20) + 80 )\nswitch(r) {\n  case 1:\n    var hue = hue1\n    break;\n  case 2:\n    var hue = hue1\n    break;\n  case 3:\n    var hue = hue1\n    break;\n  case 4:\n    var hue = hue2\n    break;\n}\n\nvar hs_color = hue + \",\" + saturation;\n\n\n\n\nvar hs_color_array = hs_color.split(\",\");\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"hs_color\": hs_color_array,\n            \"entity_id\": entity_id,\n            \"brightness_pct\": 100,\n            \n            \n}\n        }\n    }\n;\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1580,"y":540,"wires":[["751677464ccc03dd"]]},{"id":"751677464ccc03dd","type":"api-call-service","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1890,"y":540,"wires":[["10aa3a14e006ce9e"]]},{"id":"8bda6b787a1395f6","type":"comment","z":"ad8c570ec4ac394a","name":"Generated random HS 100% saturated color","info":"","x":1590,"y":500,"wires":[]},{"id":"99ad64fcaaeda74d","type":"comment","z":"ad8c570ec4ac394a","name":"Call light_on service","info":"","x":1890,"y":500,"wires":[]},{"id":"85cd0f79967163cb","type":"switch","z":"ad8c570ec4ac394a","name":"Exclude groups","property":"payload.attributes.entity_id","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","repair":false,"outputs":1,"x":1300,"y":540,"wires":[["0612fa506e02a3d5"]]},{"id":"1fcd6d42544866f3","type":"comment","z":"ad8c570ec4ac394a","name":"Exclude groups","info":"","x":1260,"y":500,"wires":[]},{"id":"10aa3a14e006ce9e","type":"trigger","z":"ad8c570ec4ac394a","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2080,"y":540,"wires":[["9fec3d7fae47d13f"]]},{"id":"9fec3d7fae47d13f","type":"api-call-service","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.random_colors"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2300,"y":540,"wires":[[]]},{"id":"53876ef0816021a4","type":"comment","z":"ad8c570ec4ac394a","name":"Turn off boolean input","info":"","x":2280,"y":500,"wires":[]},{"id":"b753b69a69ca3b78","type":"trigger","z":"ad8c570ec4ac394a","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":620,"y":640,"wires":[["0ed3a88c554f5fa5"]]},{"id":"b9d979f327628d68","type":"comment","z":"ad8c570ec4ac394a","name":"15 seconds cooldown","info":"","x":580,"y":600,"wires":[]},{"id":"0ed3a88c554f5fa5","type":"ha-get-entities","z":"ad8c570ec4ac394a","name":"Get  Light entities","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"light\\.(?!.*?group.*?)(?!.*?k95_rgb_2_led.*?)(?!.*?door.*?).*?_(?!.*?lights.*?).*","valueType":"re"},{"property":"state","logic":"is","value":"on","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":830,"y":640,"wires":[["39f1dad06948485b"]]},{"id":"5d9fd93a5a9ba944","type":"comment","z":"ad8c570ec4ac394a","name":"Try to Pull all lit single lights","info":"","x":820,"y":600,"wires":[]},{"id":"5a1b1f514bf0e0c6","type":"server-state-changed","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_button.generate_light_warm_colors","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":310,"y":640,"wires":[["b753b69a69ca3b78"]]},{"id":"74a39ee43a487dc8","type":"comment","z":"ad8c570ec4ac394a","name":"Change light to warm pale colors on press","info":"","x":260,"y":600,"wires":[]},{"id":"39f1dad06948485b","type":"switch","z":"ad8c570ec4ac394a","name":"","property":"payload.attributes.supported_color_modes","propertyType":"msg","rules":[{"t":"regex","v":"(xy|hs)","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":1070,"y":640,"wires":[["2b24bf370ac1466a"]]},{"id":"fdb1f5ee72473536","type":"comment","z":"ad8c570ec4ac394a","name":"Check for color support","info":"","x":1060,"y":600,"wires":[]},{"id":"8c7ece9de0998cea","type":"function","z":"ad8c570ec4ac394a","name":"Generate warm pale  color ( to edit)","func":"var entity_id = msg.payload.entity_id;\n\nvar r = Math.round(Math.random() * 4)\nvar hue1 = (Math.round(Math.random() * 60) + 300); //generate a random number up to 300->360\nvar hue2 = Math.round(Math.random() * 30); //generate a random number up to 30\n//var huef = hue + 250;\nvar saturation = (Math.round(Math.random() * 20) + 40 ); // generate random saturation from 80 to 100\nswitch(r) {\n  case 1:\n    var hue = hue1\n    break;\n  case 2:\n    var hue = hue1\n    break;\n  case 3:\n    var hue = hue1\n    break;\n  case 4:\n    var hue = hue2\n    break;\n}\n\nvar hs_color = hue + \",\" + saturation;\n\n\n\n\nvar hs_color_array = hs_color.split(\",\");\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"hs_color\": hs_color_array,\n            \"entity_id\": entity_id,\n            \"brightness_pct\": 100,\n            \n            \n}\n        }\n    }\n;\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1560,"y":640,"wires":[["8409535fc3549229"]]},{"id":"8409535fc3549229","type":"api-call-service","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1890,"y":640,"wires":[["c19304865aab8aa4"]]},{"id":"26a522ed4fa01f58","type":"comment","z":"ad8c570ec4ac394a","name":"Generated random HS 100% saturated color","info":"","x":1590,"y":600,"wires":[]},{"id":"0664378320eb1efa","type":"comment","z":"ad8c570ec4ac394a","name":"Call light_on service","info":"","x":1890,"y":600,"wires":[]},{"id":"2b24bf370ac1466a","type":"switch","z":"ad8c570ec4ac394a","name":"Exclude groups","property":"payload.attributes.entity_id","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","repair":false,"outputs":1,"x":1300,"y":640,"wires":[["8c7ece9de0998cea"]]},{"id":"4d2276ac66bc5288","type":"comment","z":"ad8c570ec4ac394a","name":"Exclude groups","info":"","x":1260,"y":600,"wires":[]},{"id":"c19304865aab8aa4","type":"trigger","z":"ad8c570ec4ac394a","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2080,"y":640,"wires":[["f7c96e6c05323061"]]},{"id":"f7c96e6c05323061","type":"api-call-service","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.random_colors"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2300,"y":640,"wires":[[]]},{"id":"5f9f4c4ecb82917d","type":"comment","z":"ad8c570ec4ac394a","name":"Turn off boolean input","info":"","x":2280,"y":600,"wires":[]},{"id":"6d654bed6ce79d26","type":"trigger","z":"ad8c570ec4ac394a","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"15","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":590,"y":440,"wires":[["3e380e11087941f4"]]},{"id":"6cb9d7d32622f240","type":"comment","z":"ad8c570ec4ac394a","name":"15 seconds cooldown","info":"","x":580,"y":400,"wires":[]},{"id":"3e380e11087941f4","type":"ha-get-entities","z":"ad8c570ec4ac394a","name":"Get  kitchen group entities","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"light\\.(?!.*?all.*?)(.*?group.*?).*?_(.*?lights.*?).*","valueType":"re"},{"property":"state","logic":"is","value":"on","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":850,"y":440,"wires":[["d4e8bf3b495fca62"]]},{"id":"cf9c016bea0146d9","type":"comment","z":"ad8c570ec4ac394a","name":"Try to Pull all lit single groups","info":"","x":820,"y":400,"wires":[]},{"id":"f2d5facb5df5fc89","type":"server-state-changed","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_button.generate_fake_white","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":290,"y":440,"wires":[["6d654bed6ce79d26"]]},{"id":"79761279678b7417","type":"comment","z":"ad8c570ec4ac394a","name":"Change light to fake white on press ","info":"","x":240,"y":400,"wires":[]},{"id":"d4e8bf3b495fca62","type":"switch","z":"ad8c570ec4ac394a","name":"","property":"payload.attributes.supported_color_modes","propertyType":"msg","rules":[{"t":"regex","v":"(xy|hs)","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":1070,"y":440,"wires":[["beb66e34d1b616b3"]]},{"id":"d1186d554482977f","type":"comment","z":"ad8c570ec4ac394a","name":"Check for color support","info":"","x":1060,"y":400,"wires":[]},{"id":"0aa5225356e7f714","type":"api-call-service","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2130,"y":440,"wires":[[]]},{"id":"efa1b136670eb59b","type":"comment","z":"ad8c570ec4ac394a","name":"Generated random colors that equate to white","info":"","x":1350,"y":400,"wires":[]},{"id":"1f88c189b04c6768","type":"comment","z":"ad8c570ec4ac394a","name":"Call light_on service","info":"","x":2130,"y":400,"wires":[]},{"id":"beb66e34d1b616b3","type":"function","z":"ad8c570ec4ac394a","name":"Generate fake white","func":"\nlet entity_ids = msg.payload.attributes.entity_id;\n\nlet complementaryColors = generateRandomComplementaryColors( entity_ids);\n\n\nfunction generateRandomComplementaryColors(entity_ids) {\n    let complementaryColors = [];\n    let numColors = entity_ids.length;\n    let h = Math.floor(Math.random() * 360);\n    let s = 100;\n    for (let i = 0; i < numColors; i++) {\n        h = (h + (360 / numColors)) % 360;\n        complementaryColors.push({ entity_id: entity_ids[i].toString(), hs_color: [h, s] });\n    }\n    return complementaryColors;\n}\n\n\nvar newMsg = {\"payload\":    complementaryColors \n\n           };\n\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1320,"y":440,"wires":[["2b49c035fb659639"]]},{"id":"2b49c035fb659639","type":"split","z":"ad8c570ec4ac394a","name":"Split entities","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1630,"y":440,"wires":[["b3cad8ff2777804e"]]},{"id":"b3cad8ff2777804e","type":"change","z":"ad8c570ec4ac394a","name":"","rules":[{"t":"move","p":"payload","pt":"msg","to":"payload.data","tot":"msg"},{"t":"set","p":"payload.data.brightness_pct","pt":"msg","to":"100","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1880,"y":440,"wires":[["0aa5225356e7f714"]]},{"id":"fbadb1bd0f9239ec","type":"server-state-changed","z":"ad8c570ec4ac394a","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_button.start_visuals","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":260,"y":320,"wires":[["a65eecc2fef4ba0f"]]},{"id":"a65eecc2fef4ba0f","type":"ha-get-entities","z":"ad8c570ec4ac394a","name":"Get ChromecastMedia players","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.(?!plex).*_chromecast","valueType":"re"},{"property":"state","logic":"is","value":"off","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":910,"y":320,"wires":[["51199158d46e0295"]]},{"id":"51199158d46e0295","type":"delay","z":"ad8c570ec4ac394a","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"8","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1160,"y":320,"wires":[["e4b6a6bec5325209"]]},{"id":"e4b6a6bec5325209","type":"change","z":"ad8c570ec4ac394a","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1410,"y":320,"wires":[["8c34625370f45845"]]},{"id":"8c34625370f45845","type":"api-call-service","z":"ad8c570ec4ac394a","name":"play visuals","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":[],"data":"{\"media_content_id\":\"plex://{ \\\"playlist_name\\\": \\\"All visuals\\\", \\\"shuffle\\\": 1 }\",\"media_content_type\":\"playlist\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1650,"y":320,"wires":[["86ad8b5c3e743d63"]]},{"id":"86ad8b5c3e743d63","type":"api-call-service","z":"ad8c570ec4ac394a","name":"Set volume to 0.1","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"volume_level\":\"0.1\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1850,"y":320,"wires":[["91308b18084aacd9"]]},{"id":"91308b18084aacd9","type":"api-call-service","z":"ad8c570ec4ac394a","name":"Mute Volume","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\": \"true\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2050,"y":320,"wires":[[]]},{"id":"254db86d684064da","type":"comment","z":"ad8c570ec4ac394a","name":"Pull all inactive Chromecasts entities","info":"","x":900,"y":280,"wires":[]},{"id":"7d6422b1fb5ebb0d","type":"comment","z":"ad8c570ec4ac394a","name":"rate limit at 1 per 8s","info":"","x":1150,"y":280,"wires":[]},{"id":"5b61c24bbe77e52e","type":"comment","z":"ad8c570ec4ac394a","name":"Extract the entity id","info":"","x":1410,"y":280,"wires":[]},{"id":"3ce230a54b5b7743","type":"comment","z":"ad8c570ec4ac394a","name":"Start the visuals playlist","info":"","x":1640,"y":280,"wires":[]},{"id":"9842fbad593db2a8","type":"comment","z":"ad8c570ec4ac394a","name":"Set volume to 0.1","info":"","x":1860,"y":280,"wires":[]},{"id":"30507b6e938bc357","type":"comment","z":"ad8c570ec4ac394a","name":"Mute the Tv","info":"","x":2050,"y":280,"wires":[]},{"id":"6cfc80889293c008","type":"comment","z":"ad8c570ec4ac394a","name":"(bug mitigation)","info":"The Google chromecasts don't always give the right volume, this forces an update","x":1860,"y":360,"wires":[]},{"id":"1bdbda330ff37a46","type":"comment","z":"ad8c570ec4ac394a","name":"Play soft visuals when \"Start visual\" is pressed","info":"","x":270,"y":280,"wires":[]},{"id":"6804ad9c77614881","type":"api-current-state","z":"ad8c570ec4ac394a","name":"OIffice Speakers is not playing","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"playing","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"media_player.group_office_speakers","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":970,"y":1260,"wires":[["dcbcfadfd0a359ad"],[]]},{"id":"8528af6bf8653422","type":"comment","z":"ad8c570ec4ac394a","name":"Notify on potential pakidge","info":"","x":210,"y":2740,"wires":[]},{"id":"93adc38d854d7460","type":"api-current-state","z":"2d6a330c11854cb5","name":"alarm on?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"armed_home","halt_if_type":"str","halt_if_compare":"is","entity_id":"alarm_control_panel.home_alarm","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":320,"y":220,"wires":[["0744ebcd11948a63","9f8902397ea94b94","8b01fa8c4005b52e"],[]]},{"id":"7a1ec2fba26a47d0","type":"server-state-changed","z":"2d6a330c11854cb5","name":"Maxi's Door","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.sensor_bedroom_door_contact","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":130,"y":220,"wires":[["93adc38d854d7460"],[]]},{"id":"29b35589c2243599","type":"server-state-changed","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.aerating_appartment","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":310,"y":520,"wires":[["c915141251579780"],["c915141251579780"]]},{"id":"c915141251579780","type":"trigger","z":"2d6a330c11854cb5","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"4","extend":false,"units":"hr","reset":"off","bytopic":"all","outputs":1,"x":590,"y":520,"wires":[["62828b024111a509"]]},{"id":"62828b024111a509","type":"api-call-service","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.aerating_appartment"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":840,"y":520,"wires":[[]]},{"id":"64760f998ab03189","type":"server-state-changed","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.sleeper_in_hotbox","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":300,"y":580,"wires":[["37ecdb11bfa11ae2"],["37ecdb11bfa11ae2"]]},{"id":"37ecdb11bfa11ae2","type":"trigger","z":"2d6a330c11854cb5","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"12","extend":false,"units":"hr","reset":"off","bytopic":"all","outputs":1,"x":590,"y":580,"wires":[["9093da61f51fa457"]]},{"id":"9093da61f51fa457","type":"api-call-service","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.sleeper_in_hotbox"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":840,"y":580,"wires":[[]]},{"id":"a1f6ae705980aa72","type":"server-state-changed","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.party_mode","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":280,"y":400,"wires":[["f3a62a39186f0880"],["f3a62a39186f0880"]]},{"id":"f3a62a39186f0880","type":"trigger","z":"2d6a330c11854cb5","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"16","extend":false,"units":"hr","reset":"off","bytopic":"all","outputs":1,"x":590,"y":400,"wires":[["1858e80fd72d7331"]]},{"id":"1858e80fd72d7331","type":"api-call-service","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.party_mode"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":840,"y":400,"wires":[[]]},{"id":"dc677e1625f9f7d7","type":"server-state-changed","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.sleeper_in_livingroom","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":310,"y":620,"wires":[["f43b056a40b85b61"],["f43b056a40b85b61"]]},{"id":"f43b056a40b85b61","type":"trigger","z":"2d6a330c11854cb5","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"16","extend":false,"overrideDelay":false,"units":"hr","reset":"off","bytopic":"all","topic":"topic","outputs":1,"x":590,"y":620,"wires":[["9028e01c481ed0bf"]]},{"id":"9028e01c481ed0bf","type":"api-call-service","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.sleeper_in_livingroom"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":840,"y":620,"wires":[[]]},{"id":"ae8214fef4794096","type":"server-state-changed","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.waiting_uber","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":290,"y":340,"wires":[["802487c0a965ce8f"],["802487c0a965ce8f"]]},{"id":"802487c0a965ce8f","type":"trigger","z":"2d6a330c11854cb5","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"2","extend":false,"units":"hr","reset":"off","bytopic":"all","outputs":1,"x":590,"y":340,"wires":[["10bf613b28d2b771"]]},{"id":"10bf613b28d2b771","type":"api-call-service","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.waiting_uber"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":840,"y":340,"wires":[[]]},{"id":"97a724886d64a97c","type":"server-state-changed","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.waiting_someone","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":300,"y":780,"wires":[["6665d2f0a62b2458"],["6665d2f0a62b2458"]]},{"id":"6665d2f0a62b2458","type":"trigger","z":"2d6a330c11854cb5","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"3","extend":false,"overrideDelay":false,"units":"hr","reset":"off","bytopic":"all","topic":"topic","outputs":1,"x":590,"y":780,"wires":[["1169bfdff2196c25"]]},{"id":"1169bfdff2196c25","type":"api-call-service","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.waiting_someone"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":840,"y":780,"wires":[[]]},{"id":"0a8395570fa2f6bc","type":"server-state-changed","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.sleeper_in_patio","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":300,"y":660,"wires":[["b7f43b455d51f470"],["b7f43b455d51f470"]]},{"id":"b7f43b455d51f470","type":"trigger","z":"2d6a330c11854cb5","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"50","extend":false,"overrideDelay":false,"units":"min","reset":"off","bytopic":"all","topic":"topic","outputs":1,"x":590,"y":660,"wires":[["b96e4355a27da356"]]},{"id":"728f7e9fda6c598e","type":"api-call-service","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.sleeper_in_patio"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1020,"y":660,"wires":[[]]},{"id":"c83d633b59202aef","type":"api-call-service","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.acid_time"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":640,"y":880,"wires":[[]]},{"id":"e99ef5d6c51baecd","type":"server-state-changed","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.all_present_sleeping","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"re","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":310,"y":880,"wires":[["c83d633b59202aef"],[]]},{"id":"b96e4355a27da356","type":"ha-wait-until","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"binary_sensor.patio_occupancy","entityIdFilterType":"exact","property":"state","comparator":"is","value":"off","valueType":"str","timeout":"1","timeoutType":"num","timeoutUnits":"hours","checkCurrentState":false,"blockInputOverrides":false,"outputProperties":[],"x":760,"y":660,"wires":[["728f7e9fda6c598e"],["728f7e9fda6c598e"]]},{"id":"0744ebcd11948a63","type":"api-call-service","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_fold4","areaId":[],"deviceId":[],"entityId":[],"data":"{\"message\":\"Door opened in bedroom\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"1","valueType":"str"}],"queue":"none","x":610,"y":220,"wires":[[]]},{"id":"3cfde7e64ee9472b","type":"comment","z":"2d6a330c11854cb5","name":"Reset various boolean inputs","info":"","x":220,"y":300,"wires":[]},{"id":"3614f57fe3a73ffc","type":"server-state-changed","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.acid_time","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":280,"y":460,"wires":[["4d2f8fe29204d867"],["4d2f8fe29204d867"]]},{"id":"4d2f8fe29204d867","type":"trigger","z":"2d6a330c11854cb5","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"10","extend":false,"units":"hr","reset":"off","bytopic":"all","outputs":1,"x":590,"y":460,"wires":[["fe7b9b7f3fb54ca2"]]},{"id":"fe7b9b7f3fb54ca2","type":"api-call-service","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.acid_time"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":840,"y":460,"wires":[[]]},{"id":"5bdb352ebcc5dfd9","type":"comment","z":"2d6a330c11854cb5","name":"Reset acid time when all are asleep","info":"","x":260,"y":840,"wires":[]},{"id":"44a28c9f20801736","type":"server-state-changed","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.sleeper_in_closet","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":300,"y":740,"wires":[["5ee99d07ddd1fb99"],["5ee99d07ddd1fb99"]]},{"id":"5ee99d07ddd1fb99","type":"trigger","z":"2d6a330c11854cb5","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"10","extend":false,"overrideDelay":false,"units":"hr","reset":"off","bytopic":"all","topic":"topic","outputs":1,"x":590,"y":740,"wires":[["88c08c6d4e88bcfd"]]},{"id":"88c08c6d4e88bcfd","type":"api-call-service","z":"2d6a330c11854cb5","name":"Turn off Sleeper in closet bool","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.tasmota_3c71bf3f262f_light_light_1","input_boolean.sleeper_in_closet"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":870,"y":740,"wires":[[]]},{"id":"7887400950c5a1d0","type":"api-current-state","z":"2d6a330c11854cb5","name":"alarm armed away?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"armed_away","halt_if_type":"str","halt_if_compare":"is","entity_id":"alarm_control_panel.home_alarm","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":510,"y":1140,"wires":[["05d5bd4ecc9e2857"],[]]},{"id":"2f93af378627614b","type":"change","z":"2d6a330c11854cb5","name":"Security","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"Get the fuck out, Police has been Contacted. The cameras have you recorded.","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2000,"y":1140,"wires":[["7b443a11eac5d674"]]},{"id":"05c1667f1ef411f4","type":"server-state-changed","z":"2d6a330c11854cb5","name":"Motion?","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor(?!.*?patio.*?)\\.sensor([a-z\"_\"])*_occupancy","entityIdType":"regex","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":110,"y":1140,"wires":[["a961773857544603"],[]]},{"id":"6addfad4cb86861c","type":"api-call-service","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.all_lights"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":910,"y":1140,"wires":[["d20ba9e1b9c16dd1"]]},{"id":"7b443a11eac5d674","type":"subflow:233ac7dcd801a802","z":"2d6a330c11854cb5","name":"","x":2210,"y":1140,"wires":[]},{"id":"f3938432837f636c","type":"comment","z":"2d6a330c11854cb5","name":"Motion anywhere?","info":"","x":150,"y":1100,"wires":[]},{"id":"4b105826c9ebf059","type":"comment","z":"2d6a330c11854cb5","name":"Yes","info":"","x":310,"y":1140,"wires":[]},{"id":"93b38087b8d257c1","type":"comment","z":"2d6a330c11854cb5","name":"Armed away alarm?","info":"","x":510,"y":1100,"wires":[]},{"id":"2bef291046fd87dd","type":"comment","z":"2d6a330c11854cb5","name":"Yes","info":"","x":710,"y":1140,"wires":[]},{"id":"cda242ce953cafac","type":"comment","z":"2d6a330c11854cb5","name":"Turn all lights off","info":"","x":900,"y":1100,"wires":[]},{"id":"6b20a0033bc6e398","type":"comment","z":"2d6a330c11854cb5","name":"5 seconds cooldown","info":"","x":1110,"y":1100,"wires":[]},{"id":"d01cd1697f1abcb2","type":"comment","z":"2d6a330c11854cb5","name":"Notify my phone","info":"","x":1600,"y":1100,"wires":[]},{"id":"39efb630488b2420","type":"comment","z":"2d6a330c11854cb5","name":"Set Announcement","info":"","x":2010,"y":1100,"wires":[]},{"id":"ea26ca7c541379df","type":"comment","z":"2d6a330c11854cb5","name":"Send Announcement","info":"","x":2210,"y":1100,"wires":[]},{"id":"d20ba9e1b9c16dd1","type":"delay","z":"2d6a330c11854cb5","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1110,"y":1140,"wires":[["04941cad61ffcb04","8b8d767df13a203c"]]},{"id":"04941cad61ffcb04","type":"debug","z":"2d6a330c11854cb5","name":"debug 267","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1280,"y":1020,"wires":[]},{"id":"8b8d767df13a203c","type":"function","z":"2d6a330c11854cb5","name":"Javascript","func":"var sensor = msg.topic;\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"title\": \"Security Alert\",\n\t\t\t\"message\": sensor + \" has been triggered\"\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1300,"y":1140,"wires":[["d5537d1f28982511","72cdc44676316907"]]},{"id":"d5537d1f28982511","type":"api-call-service","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_galaxy_s10","areaId":[],"deviceId":[],"entityId":[],"data":"{ \"message\": \"INTRUDER ALERT\", \"data\": {} }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1590,"y":1180,"wires":[[]]},{"id":"72cdc44676316907","type":"api-call-service","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_fold4","areaId":[],"deviceId":[],"entityId":[],"data":"{\"message\":\"Bedroom door open\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1590,"y":1140,"wires":[["2f93af378627614b"]]},{"id":"dceb17637d91000c","type":"api-current-state","z":"2d6a330c11854cb5","name":"alarm on?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"armed_home","halt_if_type":"str","halt_if_compare":"is","entity_id":"alarm_control_panel.home_alarm","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":320,"y":60,"wires":[["d08722583f7a4513","8b01fa8c4005b52e","20f0047cd0a4084d"],[]]},{"id":"1fcd695d2954542b","type":"server-state-changed","z":"2d6a330c11854cb5","name":"BEdroom Motion","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.sensor_bedroom_motion_occupancy","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":140,"y":60,"wires":[["dceb17637d91000c"],[]]},{"id":"d08722583f7a4513","type":"api-call-service","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_fold4","areaId":[],"deviceId":[],"entityId":[],"data":"{\"message\":\"Motion in bedroom\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"1","valueType":"str"}],"queue":"none","x":610,"y":60,"wires":[[]]},{"id":"6e6dc825f8e1ba10","type":"comment","z":"2d6a330c11854cb5","name":"Alert me if someone enters my room while alarm is set to armed Home","info":"","x":310,"y":20,"wires":[]},{"id":"9f8902397ea94b94","type":"api-call-service","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_galaxy_watch_4","areaId":[],"deviceId":[],"entityId":[],"data":"{\"message\":\"Door opened in bedroom\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"1","valueType":"str"}],"queue":"none","x":620,"y":260,"wires":[[]]},{"id":"20f0047cd0a4084d","type":"api-call-service","z":"2d6a330c11854cb5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_galaxy_watch_4","areaId":[],"deviceId":[],"entityId":[],"data":"{\"message\":\"Motion in bedroom\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"1","valueType":"str"}],"queue":"none","x":620,"y":100,"wires":[[]]},{"id":"c1e21a3da32930a2","type":"api-call-service","z":"2d6a330c11854cb5","name":"Warning in bedroom","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"tts","service":"google_translate_say","areaId":[],"deviceId":[],"entityId":["media_player.bedroom_speaker"],"data":"{\"message\":\"ATTENTION, PRIVATE! PLEASE GET OUT! AND CLOSE THE DOOR!\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"1","valueType":"str"}],"queue":"none","x":980,"y":140,"wires":[["d6c0d82321f1ee27"]]},{"id":"cb8ad3442d47e25b","type":"api-call-service","z":"2d6a330c11854cb5","name":"Raise volume","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bedroom_speaker"],"data":"{\"volume_level\": 1}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"1","valueType":"str"}],"queue":"none","x":780,"y":140,"wires":[["c1e21a3da32930a2"]]},{"id":"d6c0d82321f1ee27","type":"api-call-service","z":"2d6a330c11854cb5","name":"Raise volume","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bedroom_speaker"],"data":"{\"volume_level\": 1}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"1","valueType":"str"}],"queue":"none","x":1180,"y":140,"wires":[[]]},{"id":"8b01fa8c4005b52e","type":"trigger","z":"2d6a330c11854cb5","name":"","op1":"1","op2":"0","op1type":"str","op2type":"str","duration":"-2","extend":false,"overrideDelay":false,"units":"s","reset":"off","bytopic":"all","topic":"topic","outputs":1,"x":420,"y":140,"wires":[["530ddda284ce2b85"]]},{"id":"530ddda284ce2b85","type":"delay","z":"2d6a330c11854cb5","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"8","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":600,"y":140,"wires":[["cb8ad3442d47e25b"]]},{"id":"ea58124478d9fcbd","type":"trigger-state","z":"2d6a330c11854cb5","name":"No one in","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.sensor_bedroom_motion_occupancy","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"},{"targetType":"entity_id","targetValue":"binary_sensor.sensor_bedroom_door_contact","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"x":120,"y":120,"wires":[["8b01fa8c4005b52e"],[]]},{"id":"fabfeb5b80809338","type":"trigger-state","z":"2d6a330c11854cb5","name":"No one in","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.sensor_bedroom_door_contact","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"},{"targetType":"entity_id","targetValue":"binary_sensor.sensor_bedroom_motion_occupancy","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"x":120,"y":160,"wires":[["8b01fa8c4005b52e"],[]]},{"id":"651f3882df060fbe","type":"bigtimer","z":"4e6f57edbb2d3314","outtopic":"","outpayload1":"1","outpayload2":"","name":"Big Timer","comment":"","lat":0,"lon":0,"starttime":"525","endtime":"540","starttime2":"555","endtime2":"570","startoff":0,"endoff":0,"startoff2":0,"endoff2":0,"offs":0,"outtext1":"","outtext2":"","timeout":1440,"sun":true,"mon":true,"tue":true,"wed":true,"thu":true,"fri":true,"sat":true,"jan":true,"feb":true,"mar":true,"apr":true,"may":true,"jun":true,"jul":true,"aug":true,"sep":true,"oct":true,"nov":true,"dec":true,"day1":0,"month1":0,"day2":0,"month2":0,"day3":0,"month3":0,"day4":0,"month4":0,"day5":0,"month5":0,"day6":0,"month6":0,"day7":0,"month7":0,"day8":0,"month8":0,"day9":0,"month9":0,"day10":0,"month10":0,"day11":0,"month11":0,"day12":0,"month12":0,"d1":0,"w1":0,"d2":0,"w2":0,"d3":0,"w3":0,"d4":0,"w4":0,"d5":0,"w5":0,"d6":0,"w6":0,"xday1":0,"xmonth1":0,"xday2":0,"xmonth2":0,"xday3":0,"xmonth3":0,"xday4":0,"xmonth4":0,"xday5":0,"xmonth5":0,"xday6":0,"xmonth6":0,"xday7":"","xmonth7":"","xday8":"","xmonth8":"","xday9":"","xmonth9":"","xday10":"","xmonth10":"","xday11":"","xmonth11":"","xday12":"","xmonth12":"","xd1":0,"xw1":0,"xd2":0,"xw2":0,"xd3":0,"xw3":0,"xd4":0,"xw4":0,"xd5":0,"xw5":0,"xd6":0,"xw6":0,"suspend":false,"random":false,"randon1":false,"randoff1":false,"randon2":false,"randoff2":false,"repeat":true,"atstart":true,"odd":false,"even":false,"x":580,"y":460,"wires":[["073c437a9b98ae8b"],[],[]]},{"id":"aeb4d53210de9530","type":"api-current-state","z":"4e6f57edbb2d3314","name":"carla home","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is","entity_id":"person.carla","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":1070,"y":460,"wires":[["2c3d398365cd483b"],[]]},{"id":"2c3d398365cd483b","type":"change","z":"4e6f57edbb2d3314","name":"Move car","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"Carla, go move your car now!","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1340,"y":460,"wires":[["045dde7288443b6d"]]},{"id":"a9ed637a6f71bb73","type":"trigger","z":"4e6f57edbb2d3314","name":"trigger","op1":"1","op2":"","op1type":"str","op2type":"nul","duration":"13","extend":false,"overrideDelay":false,"units":"min","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":830,"y":460,"wires":[["aeb4d53210de9530"]]},{"id":"74acaaabe09823c1","type":"comment","z":"4e6f57edbb2d3314","name":"Triggers at 8:45 and 9:15","info":"","x":590,"y":420,"wires":[]},{"id":"5cb7d8fb27628a7a","type":"comment","z":"4e6f57edbb2d3314","name":"Send \"1\" and wait 13 minutes","info":"","x":840,"y":420,"wires":[]},{"id":"d67190033e428c09","type":"comment","z":"4e6f57edbb2d3314","name":"Is carla even home?","info":"","x":1070,"y":420,"wires":[]},{"id":"656626621424aeb7","type":"comment","z":"4e6f57edbb2d3314","name":"Set announcement message","info":"","x":1340,"y":420,"wires":[]},{"id":"045dde7288443b6d","type":"subflow:233ac7dcd801a802","z":"4e6f57edbb2d3314","name":"","x":1610,"y":460,"wires":[]},{"id":"e38871881dfdeae1","type":"comment","z":"4e6f57edbb2d3314","name":"Send to announcement subflow","info":"","x":1610,"y":420,"wires":[]},{"id":"aa1185695b51b293","type":"server-state-changed","z":"d5c4f13f05d3870d","name":"PHone notifications","server":"7ab5c227.a3ce8c","version":4,"outputs":1,"for":"0","forType":"num","forUnits":"milliseconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.phone_fold_3_last_notification","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":false,"x":350,"y":560,"wires":[["0b41b7a38ef1c142"]]},{"id":"327005af6b599f5d","type":"switch","z":"d5c4f13f05d3870d","name":"Message Regex  PEnding Task","property":"payload","propertyType":"msg","rules":[{"t":"regex","v":"(^Pending Task)","vt":"str","case":true},{"t":"cont","v":"pending task","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":770,"y":560,"wires":[["0e8b4919daa1bbdf"],[]]},{"id":"0e8b4919daa1bbdf","type":"switch","z":"d5c4f13f05d3870d","name":"Who?","property":"data.new_state.attributes[\"android.title\"]","propertyType":"msg","rules":[{"t":"regex","v":"(Fay|Compound)","vt":"str","case":true}],"checkall":"true","repair":false,"outputs":1,"x":990,"y":560,"wires":[["7b70b8c07ca62418"]]},{"id":"7b70b8c07ca62418","type":"api-current-state","z":"d5c4f13f05d3870d","name":"NExt fay event date","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"calendar.faydates","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"faydates","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1250,"y":560,"wires":[["9f052aeee2f3e47c"]]},{"id":"9f052aeee2f3e47c","type":"function","z":"d5c4f13f05d3870d","name":"","func":"var name = msg.data.new_state.attributes[\"android.title\"];\nvar task = msg.payload.split(\":\");\nvar date = msg.faydates.attributes.start_time.split(\" \");\n\nif (task[1]){\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n    \"start_date\": date[0],\n    \"end_date\": date[0],\n    \"summary\": task[1],\n    \"calendar_id\": \"4o2d6bnk3m9aruj7kr7ouv8gk0@group.calendar.google.com\"\n  },\n  \"date\": msg.faydates.attributes.start_time\n}\n};\n} else {\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n    \"start_date\": date[0],\n    \"end_date\": date[0],\n    \"summary\": task[0],\n    \"calendar_id\": \"4o2d6bnk3m9aruj7kr7ouv8gk0@group.calendar.google.com\"\n  },\n  \"date\": msg.faydates.attributes.start_time\n}\n};\n}\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1660,"y":560,"wires":[["843a3731c2365883"]]},{"id":"843a3731c2365883","type":"api-call-service","z":"d5c4f13f05d3870d","name":"Add event to calendar","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"google","service":"add_event","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2020,"y":560,"wires":[[]]},{"id":"0b41b7a38ef1c142","type":"switch","z":"d5c4f13f05d3870d","name":"facebook?","property":"data.new_state.attributes.package","propertyType":"msg","rules":[{"t":"eq","v":"com.facebook.orca","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":550,"y":560,"wires":[["327005af6b599f5d"]]},{"id":"a1e6e29e73ba0104","type":"comment","z":"d5c4f13f05d3870d","name":"Receive all Phone Notifications","info":"","x":310,"y":520,"wires":[]},{"id":"80c6ee398f8b9be0","type":"comment","z":"d5c4f13f05d3870d","name":"Confirm it's facebook","info":"","x":550,"y":520,"wires":[]},{"id":"a315d7463f103794","type":"comment","z":"d5c4f13f05d3870d","name":"Look for \"Pending Task\"","info":"","x":760,"y":520,"wires":[]},{"id":"67143abe3825e177","type":"comment","z":"d5c4f13f05d3870d","name":"Confirm Fay","info":"","x":990,"y":520,"wires":[]},{"id":"6e53f375d85cd666","type":"comment","z":"d5c4f13f05d3870d","name":"Check next Calendar event with \"Fay\" in it","info":"","x":1240,"y":520,"wires":[]},{"id":"5ad1b6f4237f7d89","type":"comment","z":"d5c4f13f05d3870d","name":"JS Magic to set the new event as the same date as found event","info":"","x":1650,"y":520,"wires":[]},{"id":"747eca8083207079","type":"comment","z":"d5c4f13f05d3870d","name":"Call Event Creation service","info":"","x":2010,"y":520,"wires":[]},{"id":"76811e0b6cae931d","type":"comment","z":"d5c4f13f05d3870d","name":"## ADD CALENDAR EVENT UPON FAY'S TEXT ##","info":"","x":370,"y":480,"wires":[]},{"id":"e9f6f4497b61dc69","type":"server-state-changed","z":"1926984267e0fec1","name":"BAck Door","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"lock.back_door","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"(unlocked|locked)","ifStateType":"re","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":460,"y":420,"wires":[["8d1093308d6433e7"],["8d1093308d6433e7"]]},{"id":"cad0065abe810e75","type":"api-call-service","z":"1926984267e0fec1","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"lock","service":"lock","areaId":[],"deviceId":[],"entityId":["lock.back_door"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1180,"y":420,"wires":[[]]},{"id":"5e653191a5bf60b4","type":"change","z":"1926984267e0fec1","name":"Set Data for mass alert","rules":[{"t":"set","p":"color_value","pt":"msg","to":"[0,255,0]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"},{"t":"set","p":"message","pt":"msg","to":"Someone Has Entered","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1380,"y":540,"wires":[["211db03c05f264bb"]]},{"id":"3c74b545f5aa3550","type":"link out","z":"1926984267e0fec1","name":"Light and Speakers","mode":"link","links":["45904ca6429d867d"],"x":1715,"y":560,"wires":[]},{"id":"2990b9e9192f7a80","type":"api-current-state","z":"1926984267e0fec1","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_kitchen_motion_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":810,"y":560,"wires":[["5466f80ede718c92"],["e63d4ca03ad56441"]]},{"id":"b85861972ad4be99","type":"change","z":"1926984267e0fec1","name":"Set Data for mass alert","rules":[{"t":"set","p":"color_value","pt":"msg","to":"[0,255,255]","tot":"str"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1380,"y":580,"wires":[["211db03c05f264bb"]]},{"id":"8d1093308d6433e7","type":"trigger","z":"1926984267e0fec1","name":"","op1":"","op2":"1","op1type":"nul","op2type":"num","duration":"2","extend":false,"overrideDelay":false,"units":"min","reset":"locked","bytopic":"all","topic":"topic","outputs":1,"x":630,"y":420,"wires":[["4804d93f7030bac3"]]},{"id":"211db03c05f264bb","type":"subflow:233ac7dcd801a802","z":"1926984267e0fec1","name":"","x":1650,"y":560,"wires":[]},{"id":"1d3476464ff3d90d","type":"comment","z":"1926984267e0fec1","name":"Auto Locks the door","info":"","x":490,"y":380,"wires":[]},{"id":"4804d93f7030bac3","type":"ha-wait-until","z":"1926984267e0fec1","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"binary_sensor.sensor_back_outside_door_contact","entityIdFilterType":"exact","property":"state","comparator":"is","value":"off","valueType":"str","timeout":"2","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":840,"y":420,"wires":[["cad0065abe810e75"],["cad0065abe810e75"]]},{"id":"608a474d04e5cc72","type":"comment","z":"1926984267e0fec1","name":"Detect when back door gets closed","info":"","x":840,"y":380,"wires":[]},{"id":"ef89c80a28516d21","type":"comment","z":"1926984267e0fec1","name":"Lock the door","info":"","x":1170,"y":380,"wires":[]},{"id":"1eec638a7d8af565","type":"server-state-changed","z":"1926984267e0fec1","name":"BAck Door","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"lock.back_door","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"(unlocked)","ifStateType":"re","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":460,"y":560,"wires":[["2990b9e9192f7a80"],[]]},{"id":"8fbf163cada0b2d8","type":"comment","z":"1926984267e0fec1","name":"Auto Locks the door","info":"","x":470,"y":520,"wires":[]},{"id":"fd4dfa6331407ae9","type":"comment","z":"1926984267e0fec1","name":"Is there people in the kitchen?","info":"","x":820,"y":520,"wires":[]},{"id":"58de234eb4d99d1a","type":"comment","z":"1926984267e0fec1","name":"No","info":"","x":1110,"y":540,"wires":[]},{"id":"78abd0126eaeb797","type":"comment","z":"1926984267e0fec1","name":"Yes","info":"","x":1110,"y":580,"wires":[]},{"id":"8c19068e6898a4bc","type":"comment","z":"1926984267e0fec1","name":"Set \"Someone is coming in\" payload","info":"","x":1400,"y":500,"wires":[]},{"id":"df5bb9ac7ac82f1f","type":"comment","z":"1926984267e0fec1","name":"Set \"Someone is going out\" payload","info":"","x":1380,"y":620,"wires":[]},{"id":"e6e81999e0dbffc6","type":"api-call-service","z":"1926984267e0fec1","name":"Back door 100 white","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.back_door_light"],"data":"{\"color_name\":\"white\",\"brightness_pct\":\"100\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1360,"y":780,"wires":[[]]},{"id":"3693c538eafb6dec","type":"server-state-changed","z":"1926984267e0fec1","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"sensor.back_door_camera_person_count","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"(0|1|2)","ifStateType":"re","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":610,"y":740,"wires":[["77ff410b30c82d70"],[]]},{"id":"db8a264370e69bd1","type":"api-call-service","z":"1926984267e0fec1","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.back_door_light"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1070,"y":780,"wires":[[]]},{"id":"2f0b53d8218e08cb","type":"api-call-service","z":"1926984267e0fec1","name":"Back door 65white","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.back_door_light"],"data":"{\"color_name\":\"white\",\"brightness_pct\":\"65\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1370,"y":740,"wires":[[]]},{"id":"c7688e6ad81af324","type":"api-current-state","z":"1926984267e0fec1","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"unlocked","halt_if_type":"str","halt_if_compare":"is","entity_id":"lock.back_door","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":1110,"y":740,"wires":[["2f0b53d8218e08cb"],["e6e81999e0dbffc6"]]},{"id":"77ff410b30c82d70","type":"switch","z":"1926984267e0fec1","name":"","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"cont","v":"0","vt":"str"},{"t":"cont","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":890,"y":740,"wires":[["c7688e6ad81af324"],["db8a264370e69bd1"],["c7688e6ad81af324"]]},{"id":"a010f0d06ca3253c","type":"comment","z":"1926984267e0fec1","name":"Turn back door lights on when someone is detected","info":"","x":590,"y":700,"wires":[]},{"id":"4c92d172159985a9","type":"api-call-service","z":"cc94640ec8e547cb","name":"Door light on (100%)","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.front_door_light"],"data":"{\"color_name\":\"white\",\"brightness_pct\":\"100\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":940,"y":180,"wires":[[]]},{"id":"c38c98058767e278","type":"poll-state","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":3,"exposeAsEntityConfig":"","updateInterval":"2","updateIntervalType":"num","updateIntervalUnits":"hours","outputInitially":false,"outputOnChanged":true,"entityId":"sun.sun","stateType":"str","ifState":"below_horizon","ifStateType":"str","ifStateOperator":"is","outputs":2,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":130,"y":220,"wires":[["6dae17c627907e37"],["1b04206a65cea813"]]},{"id":"c573b0de84a33ed4","type":"api-call-service","z":"cc94640ec8e547cb","name":"Door light off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.front_door_light"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":710,"y":260,"wires":[[]]},{"id":"ec38337bc4762c2a","type":"trigger","z":"cc94640ec8e547cb","name":"","op1":"","op2":"0","op1type":"pay","op2type":"str","duration":"-2","extend":false,"overrideDelay":false,"units":"hr","reset":"above_horizon","bytopic":"all","topic":"topic","outputs":1,"x":550,"y":180,"wires":[["4c92d172159985a9"]]},{"id":"0ac23590a7b82122","type":"trigger","z":"cc94640ec8e547cb","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"1","extend":false,"overrideDelay":false,"units":"hr","reset":"above_horizon","bytopic":"all","topic":"topic","outputs":1,"x":530,"y":260,"wires":[["c573b0de84a33ed4"]]},{"id":"5ad85c724fafa24c","type":"comment","z":"cc94640ec8e547cb","name":"Automation to turns on and off the front door light","info":"","x":180,"y":140,"wires":[]},{"id":"18d4ce4ab3396e68","type":"comment","z":"cc94640ec8e547cb","name":"Resend command every 2 hours until sun is Up","info":"","x":560,"y":140,"wires":[]},{"id":"108c06c5cf959146","type":"comment","z":"cc94640ec8e547cb","name":"Wait one hour","info":"","x":530,"y":300,"wires":[]},{"id":"9ebe76810287385f","type":"comment","z":"cc94640ec8e547cb","name":"Maximum brightness White Light","info":"","x":930,"y":140,"wires":[]},{"id":"64b624557a59f61e","type":"api-call-service","z":"cc94640ec8e547cb","name":"Front door 100% white","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.front_door_light"],"data":"{\"color_name\":\"white\",\"brightness_pct\":\"100\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1100,"y":520,"wires":[["202b7bbecbc5e1f4"]]},{"id":"87414222f452de4b","type":"server-state-changed","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"sensor.front_door_camera_person_count","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"(0)","ifStateType":"re","ifStateOperator":"is_not","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":210,"y":480,"wires":[["e6c8ccf88b4d5f28"],[]]},{"id":"0f9702216925a495","type":"api-call-service","z":"cc94640ec8e547cb","name":"Front door 65% white","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.front_door_light"],"data":"{\"color_name\":\"white\",\"brightness_pct\":\"65\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1100,"y":440,"wires":[["3cbebc894a46829c"]]},{"id":"6be3e38f22ceb49d","type":"api-current-state","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.front_door_light","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":700,"y":480,"wires":[["bf61178d1208f913"],["b2b40cd2583e9dcd"]]},{"id":"e6c8ccf88b4d5f28","type":"switch","z":"cc94640ec8e547cb","name":"!=0","property":"payload","propertyType":"msg","rules":[{"t":"neq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":490,"y":480,"wires":[["6be3e38f22ceb49d"]]},{"id":"c2bcaaa56e71fe39","type":"api-call-service","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.front_door_light"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1710,"y":440,"wires":[[]]},{"id":"3cbebc894a46829c","type":"ha-wait-until","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"sensor.front_door_camera_person_count","entityIdFilterType":"exact","property":"state","comparator":"is","value":"0","valueType":"str","timeout":"15","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":false,"blockInputOverrides":false,"outputProperties":[],"x":1320,"y":440,"wires":[["d2b6266995cb604e"],["d2b6266995cb604e"]]},{"id":"d2b6266995cb604e","type":"change","z":"cc94640ec8e547cb","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1520,"y":440,"wires":[["c2bcaaa56e71fe39"]]},{"id":"c92671e67851e1a5","type":"comment","z":"cc94640ec8e547cb","name":"Lights on when someone is detected in the front","info":"","x":180,"y":440,"wires":[]},{"id":"6c8720b8279e955d","type":"comment","z":"cc94640ec8e547cb","name":"Person is not 0","info":"","x":480,"y":440,"wires":[]},{"id":"8706f5c37c3505c9","type":"comment","z":"cc94640ec8e547cb","name":"Is the light already on?","info":"","x":700,"y":440,"wires":[]},{"id":"0c19972a2eeb20b8","type":"comment","z":"cc94640ec8e547cb","name":"Yes","info":"","x":930,"y":520,"wires":[]},{"id":"85e319c981aa9d18","type":"comment","z":"cc94640ec8e547cb","name":"No","info":"","x":930,"y":440,"wires":[]},{"id":"112abc97d210c7b4","type":"api-call-service","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.front_door_light"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1730,"y":520,"wires":[[]]},{"id":"202b7bbecbc5e1f4","type":"ha-wait-until","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"sensor.front_door_camera_person_count","entityIdFilterType":"exact","property":"state","comparator":"is","value":"0","valueType":"str","timeout":"2","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":false,"blockInputOverrides":false,"outputProperties":[],"x":1320,"y":520,"wires":[["17dd9d749a024ff0"],["17dd9d749a024ff0"]]},{"id":"17dd9d749a024ff0","type":"change","z":"cc94640ec8e547cb","name":"","rules":[{"t":"set","p":"payload.data.brightness","pt":"msg","to":"entity.attributes.brightness","tot":"msg","dc":true},{"t":"delete","p":"payload.data.brightness_pct","pt":"msg"},{"t":"delete","p":"payload.data.color_name","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1520,"y":520,"wires":[["112abc97d210c7b4"]]},{"id":"f5dda07dd9794855","type":"comment","z":"cc94640ec8e547cb","name":"Apply color and brightness","info":"","x":1090,"y":480,"wires":[]},{"id":"44a08d552acbc93f","type":"comment","z":"cc94640ec8e547cb","name":"Wait until person = 0","info":"","x":1330,"y":480,"wires":[]},{"id":"068c88e9751c285a","type":"comment","z":"cc94640ec8e547cb","name":"Turn the light off","info":"","x":1700,"y":400,"wires":[]},{"id":"b1ef6342e8069d84","type":"comment","z":"cc94640ec8e547cb","name":"Return the light to its initial brightness","info":"","x":1810,"y":560,"wires":[]},{"id":"ca142425f61b0c2a","type":"comment","z":"cc94640ec8e547cb","name":"Extract initial brightness","info":"","x":1520,"y":560,"wires":[]},{"id":"e1a0bd430e45a45b","type":"comment","z":"cc94640ec8e547cb","name":"Reset payload","info":"","x":1510,"y":400,"wires":[]},{"id":"b26e10b7fb19d977","type":"api-call-service","z":"cc94640ec8e547cb","name":"Lock Door","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"lock","service":"lock","areaId":[],"deviceId":[],"entityId":["lock.lock_front_door"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":730,"y":740,"wires":[[]]},{"id":"a7d1ef5acf5d9982","type":"trigger-state","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.sensor_front_outside_door_contact","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":270,"y":740,"wires":[["b26e10b7fb19d977"],[]]},{"id":"99fb4a0bebf4b554","type":"comment","z":"cc94640ec8e547cb","name":"Detect when front door gets closed","info":"","x":180,"y":700,"wires":[]},{"id":"a758a0c37b2d8097","type":"comment","z":"cc94640ec8e547cb","name":"Lock the door","info":"","x":730,"y":700,"wires":[]},{"id":"9be350595dc69bd8","type":"api-call-service","z":"cc94640ec8e547cb","name":"Lock Door","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"lock","service":"lock","areaId":[],"deviceId":[],"entityId":["lock.lock_front_door"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":830,"y":880,"wires":[[]]},{"id":"a58c332479ab66c1","type":"trigger-state","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"lock.lock_front_door","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"unlocked"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":170,"y":880,"wires":[["9c3940704c57c37b"],[]]},{"id":"30a460e80cbb9298","type":"comment","z":"cc94640ec8e547cb","name":"Detect when door is unlocked","info":"","x":160,"y":840,"wires":[]},{"id":"b836f784462b57b8","type":"comment","z":"cc94640ec8e547cb","name":"Lock the door","info":"","x":830,"y":840,"wires":[]},{"id":"9c3940704c57c37b","type":"trigger","z":"cc94640ec8e547cb","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"10","extend":false,"overrideDelay":false,"units":"min","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":510,"y":880,"wires":[["9be350595dc69bd8"]]},{"id":"6e7de3c713429510","type":"comment","z":"cc94640ec8e547cb","name":"wait 10 minutes","info":"","x":500,"y":840,"wires":[]},{"id":"6877bf1fa1529499","type":"change","z":"cc94640ec8e547cb","name":"Alert","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"Front Door Open","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1190,"y":1040,"wires":[["e3e25ac88e5ab623"]]},{"id":"55bc58b8ee7f542d","type":"trigger","z":"cc94640ec8e547cb","name":"","op1":"","op2":"1","op1type":"num","op2type":"str","duration":"-5","extend":false,"overrideDelay":false,"units":"min","reset":"off","bytopic":"all","topic":"topic","outputs":1,"x":750,"y":1040,"wires":[["a54db271c14c6fdb"]]},{"id":"6fa95abdf2c98257","type":"server-state-changed","z":"cc94640ec8e547cb","name":"Front door Sensor","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.sensor_front_door_contact","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"re","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":130,"y":1000,"wires":[["e8ac38df38777916"],["9efe535f624f00ef"]]},{"id":"a54db271c14c6fdb","type":"api-current-state","z":"cc94640ec8e547cb","name":"Aerating?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.aerating_appartment","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":980,"y":1040,"wires":[["79b785d11bf94fd0"],[]]},{"id":"e3e25ac88e5ab623","type":"subflow:233ac7dcd801a802","z":"cc94640ec8e547cb","name":"","x":1450,"y":1040,"wires":[]},{"id":"dd92294670fe6c0a","type":"trigger","z":"cc94640ec8e547cb","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"2","extend":false,"overrideDelay":false,"units":"min","reset":"off","bytopic":"all","topic":"topic","outputs":1,"x":510,"y":1000,"wires":[["625bfabb4a23a8fd"]]},{"id":"9efe535f624f00ef","type":"switch","z":"cc94640ec8e547cb","name":"off?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":330,"y":1040,"wires":[["55bc58b8ee7f542d","dd92294670fe6c0a"]]},{"id":"f7bdf157661f1407","type":"comment","z":"cc94640ec8e547cb","name":"Detect when door is left open","info":"","x":160,"y":960,"wires":[]},{"id":"17144aff81abba69","type":"comment","z":"cc94640ec8e547cb","name":"Wait 2 minutes before continuing","info":"","x":510,"y":960,"wires":[]},{"id":"6cbc9fa3c30d1542","type":"comment","z":"cc94640ec8e547cb","name":"Wait 5 minutes before repeating","info":"","x":750,"y":1000,"wires":[]},{"id":"668ef1c1a7215138","type":"comment","z":"cc94640ec8e547cb","name":"Reset on door close","info":"","x":750,"y":1080,"wires":[]},{"id":"f33b94f5fba64359","type":"comment","z":"cc94640ec8e547cb","name":"Reset on door close","info":"","x":510,"y":1040,"wires":[]},{"id":"6a76f6c52daab14b","type":"comment","z":"cc94640ec8e547cb","name":"Are we \"Aereating\"?","info":"Continue if not","x":990,"y":1000,"wires":[]},{"id":"024341880cacc948","type":"comment","z":"cc94640ec8e547cb","name":"Set Alert message","info":"","x":1190,"y":1000,"wires":[]},{"id":"700b478a5e26a806","type":"comment","z":"cc94640ec8e547cb","name":"Use the Alert subflow to alert us","info":"","x":1450,"y":1000,"wires":[]},{"id":"20d6128a02c5cd8a","type":"comment","z":"cc94640ec8e547cb","name":"Monitor Lock through MQTT","info":"This is meant to pull more data from the unlock event, such as unlock_pin","x":180,"y":1500,"wires":[]},{"id":"3055a77582b04f89","type":"comment","z":"cc94640ec8e547cb","name":"####MANAGE CONDITIONAL PINS####","info":"Those are pins that send unlock data without actually unlocking the door","x":220,"y":1460,"wires":[]},{"id":"9abc6bf90bea613e","type":"switch","z":"cc94640ec8e547cb","name":"action: unlock_failure_invalid_schedule","property":"payload.action","propertyType":"msg","rules":[{"t":"eq","v":"unlock_failure_invalid_schedule","vt":"str"}],"checkall":"false","repair":false,"outputs":1,"x":510,"y":1540,"wires":[["0f6f3939fc31b412"]]},{"id":"1b59826fbe1d34e5","type":"switch","z":"cc94640ec8e547cb","name":"WHO","property":"payload.action_user","propertyType":"msg","rules":[{"t":"eq","v":"3","vt":"num"}],"checkall":"false","repair":false,"outputs":1,"x":1090,"y":1540,"wires":[["f5f19fea537c849a"]]},{"id":"f5f19fea537c849a","type":"change","z":"cc94640ec8e547cb","name":"Fay","rules":[{"t":"set","p":"message","pt":"msg","to":"Fay has arrived","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"Fay","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1330,"y":1540,"wires":[["1fc38a6d436e5401"]]},{"id":"0f6f3939fc31b412","type":"api-current-state","z":"cc94640ec8e547cb","name":"Maxi home?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"home","halt_if_type":"str","halt_if_compare":"is","entity_id":"person.maximiliano","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":830,"y":1540,"wires":[["1b59826fbe1d34e5"],[]]},{"id":"995c67a6597ab468","type":"subflow:233ac7dcd801a802","z":"cc94640ec8e547cb","name":"","x":2230,"y":1600,"wires":[]},{"id":"73634a14fd698218","type":"function","z":"cc94640ec8e547cb","name":"Name Payload","func":"var name = msg.payload;\n\nvar newMsg = {\n       \"payload\":{\n        \"data\": {\n            \"value\": name\n        }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1600,"y":1540,"wires":[["dc9c1a9c0274250e"]]},{"id":"dc9c1a9c0274250e","type":"api-call-service","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"1","valueType":"str"}],"queue":"none","x":1930,"y":1540,"wires":[["4058f004bd6e6039"]]},{"id":"eb3e489f030d78b0","type":"mqtt in","z":"cc94640ec8e547cb","name":"","topic":"zigbee2mqtt/lock_front_door","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":180,"y":1540,"wires":[["9abc6bf90bea613e"]]},{"id":"17022c97071074b8","type":"api-call-service","z":"cc94640ec8e547cb","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2600,"y":1540,"wires":[["2ae2baa69569d00f"]]},{"id":"2ae2baa69569d00f","type":"ha-wait-until","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"locked","valueType":"str","timeout":"50","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":2820,"y":1540,"wires":[["72e7725486573888"],["72e7725486573888"]]},{"id":"72e7725486573888","type":"api-call-service","z":"cc94640ec8e547cb","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized","input_boolean.waiting_someone"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3120,"y":1540,"wires":[["23ac817267ade3a3"]]},{"id":"23ac817267ade3a3","type":"api-call-service","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":" {             \"value\": \"UNKNOWN\"         }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3400,"y":1540,"wires":[[]]},{"id":"4058f004bd6e6039","type":"ha-wait-until","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"unlocked","valueType":"str","timeout":"2","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":2380,"y":1540,"wires":[["17022c97071074b8"],[]]},{"id":"fe0864bae7936f4e","type":"comment","z":"cc94640ec8e547cb","name":"Only allow conditional pins through","info":"","x":520,"y":1500,"wires":[]},{"id":"57ad524e9c954451","type":"comment","z":"cc94640ec8e547cb","name":"Only continue if I am Home","info":"","x":830,"y":1500,"wires":[]},{"id":"328f6701250769c2","type":"comment","z":"cc94640ec8e547cb","name":"Whose pin was used?","info":"","x":1100,"y":1500,"wires":[]},{"id":"b971484a535ab59f","type":"comment","z":"cc94640ec8e547cb","name":"Set Name according to Pin used","info":"","x":1330,"y":1500,"wires":[]},{"id":"fcb2c0489efe169c","type":"comment","z":"cc94640ec8e547cb","name":"Set payload name for next node","info":"","x":1610,"y":1500,"wires":[]},{"id":"57011ec24b69f2c3","type":"comment","z":"cc94640ec8e547cb","name":"Announce the arrival of the person","info":"","x":2220,"y":1640,"wires":[]},{"id":"99920e046416a169","type":"change","z":"cc94640ec8e547cb","name":"Set Data for someone coming in","rules":[{"t":"set","p":"color_value","pt":"msg","to":"[0,255,0]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1690,"y":1600,"wires":[["995c67a6597ab468"]]},{"id":"33a88495879f0377","type":"comment","z":"cc94640ec8e547cb","name":"set lights color and brightness for announcement","info":"","x":1700,"y":1640,"wires":[]},{"id":"8f4fca2ef1a9e206","type":"comment","z":"cc94640ec8e547cb","name":"Set name on front-door to welcome guest","info":"","x":1920,"y":1500,"wires":[]},{"id":"f716e0d7c16976fe","type":"comment","z":"cc94640ec8e547cb","name":"Unlock the door","info":"","x":1600,"y":1380,"wires":[]},{"id":"16fc986103dee7ef","type":"comment","z":"cc94640ec8e547cb","name":"Wait till door unlocks","info":"","x":2370,"y":1500,"wires":[]},{"id":"d12d72b22641204c","type":"comment","z":"cc94640ec8e547cb","name":"Turn \"Face Recognized\" on","info":"","x":2600,"y":1500,"wires":[]},{"id":"fabd5c118b5399ff","type":"comment","z":"cc94640ec8e547cb","name":"Turn \"Face Recognized\" off","info":"","x":3110,"y":1500,"wires":[]},{"id":"73c845ec5370a709","type":"comment","z":"cc94640ec8e547cb","name":"Clear \"recognized_face\" variable","info":" - ","x":3410,"y":1500,"wires":[]},{"id":"9e330a9008eb81c9","type":"comment","z":"cc94640ec8e547cb","name":"Wait till door locks","info":"","x":2830,"y":1500,"wires":[]},{"id":"659bb3222f8c2da5","type":"api-call-service","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_galaxy_s10","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"1","valueType":"str"}],"queue":"none","x":1890,"y":1460,"wires":[["5a0aef6354bb55ee"]]},{"id":"5a0aef6354bb55ee","type":"delay","z":"cc94640ec8e547cb","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":2200,"y":1460,"wires":[["1ad4c021933eaecb"]]},{"id":"1ad4c021933eaecb","type":"api-call-service","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.group_entrance_lights"],"data":"{ \"color_name\": \"white\" }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2350,"y":1460,"wires":[[]]},{"id":"c8a52b5adfdd5182","type":"comment","z":"cc94640ec8e547cb","name":"notify my phone of the arrival","info":"","x":1880,"y":1380,"wires":[]},{"id":"8e73d1549d9e9178","type":"comment","z":"cc94640ec8e547cb","name":"Wait one second then turn on entrance lights","info":"They tend to get closed by the initial announcement of arrival. This insure they are on!","x":2270,"y":1420,"wires":[]},{"id":"fb02f9f19c37b0de","type":"comment","z":"cc94640ec8e547cb","name":"Monitor Lock through MQTT","info":"This is meant to pull more data from the unlock event, such as unlock_pin","x":180,"y":1800,"wires":[]},{"id":"37fa0aeab0c77b62","type":"comment","z":"cc94640ec8e547cb","name":"####MANAGE ADMIN PINS####","info":"Those are pins that work at all time","x":190,"y":1760,"wires":[]},{"id":"955f309c16ad33b2","type":"mqtt in","z":"cc94640ec8e547cb","name":"","topic":"zigbee2mqtt/lock_front_door","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":180,"y":1840,"wires":[["eb942024db9bab52","72cb7821723c1afc"]]},{"id":"0b0bc380e8b94d7f","type":"comment","z":"cc94640ec8e547cb","name":"Only allow keypad unlocks","info":"","x":490,"y":1800,"wires":[]},{"id":"eb942024db9bab52","type":"switch","z":"cc94640ec8e547cb","name":"Check for Source_name ","property":"payload.action_source_name","propertyType":"msg","rules":[{"t":"eq","v":"keypad","vt":"str"}],"checkall":"false","repair":false,"outputs":1,"x":490,"y":1840,"wires":[["6c809f93398b1f08"]]},{"id":"6c809f93398b1f08","type":"switch","z":"cc94640ec8e547cb","name":"Action  is \"unlock\"?","property":"payload.action","propertyType":"msg","rules":[{"t":"eq","v":"unlock","vt":"str"}],"checkall":"false","repair":false,"outputs":1,"x":730,"y":1840,"wires":[["c4d53bf136036aed"]]},{"id":"898203885ebd4841","type":"comment","z":"cc94640ec8e547cb","name":"Confirm action take on the look","info":"","x":750,"y":1800,"wires":[]},{"id":"e475250f2ad1f0ce","type":"change","z":"cc94640ec8e547cb","name":"Myriam","rules":[{"t":"set","p":"payload","pt":"msg","to":"Myriam","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1220,"y":1880,"wires":[["551208ac4f349765"]]},{"id":"35e25198f87993cd","type":"change","z":"cc94640ec8e547cb","name":"Maxi","rules":[{"t":"set","p":"payload","pt":"msg","to":"Maxi","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1210,"y":1840,"wires":[["551208ac4f349765"]]},{"id":"914c3b096bd61312","type":"change","z":"cc94640ec8e547cb","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"payload.data.title","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,255,0]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1880,"y":1840,"wires":[["e34fd4ad8f7274c4"]]},{"id":"c4d53bf136036aed","type":"switch","z":"cc94640ec8e547cb","name":"WHO","property":"payload.action_user","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"eq","v":"13","vt":"str"},{"t":"eq","v":"14","vt":"str"},{"t":"eq","v":"6","vt":"str"},{"t":"null"},{"t":"nnull"}],"checkall":"false","repair":false,"outputs":7,"x":990,"y":1860,"wires":[["35e25198f87993cd"],["e475250f2ad1f0ce"],[],[],[],[],[]]},{"id":"b62931fec68c6932","type":"delay","z":"cc94640ec8e547cb","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":2220,"y":1900,"wires":[["abfdc4da4813a3ae"]]},{"id":"abfdc4da4813a3ae","type":"api-call-service","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.group_entrance_lights"],"data":"{ \"color_name\": \"white\" }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2370,"y":1900,"wires":[[]]},{"id":"e34fd4ad8f7274c4","type":"subflow:233ac7dcd801a802","z":"cc94640ec8e547cb","name":"","x":2250,"y":1840,"wires":[]},{"id":"abe4adfa631aec08","type":"comment","z":"cc94640ec8e547cb","name":"Whose pin was used?","info":"","x":1000,"y":1800,"wires":[]},{"id":"5023f6862a9587a8","type":"comment","z":"cc94640ec8e547cb","name":"Set Name according to Pin used","info":"","x":1250,"y":1800,"wires":[]},{"id":"b448399f5e588231","type":"change","z":"cc94640ec8e547cb","name":"unregistered","rules":[{"t":"set","p":"payload","pt":"msg","to":"Someone Unregistered ","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1230,"y":2080,"wires":[["3a18d29d3e7456e5"]]},{"id":"504024337906fed8","type":"change","z":"cc94640ec8e547cb","name":"Unpined","rules":[{"t":"set","p":"payload","pt":"msg","to":"Someone without a pin ","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1220,"y":2040,"wires":[["3a18d29d3e7456e5"]]},{"id":"d25b8a56d9708a46","type":"function","z":"cc94640ec8e547cb","name":"Javascript","func":"var recoface = [];\nvar d = new Date();\nvar m = d.getMilliseconds();\nvar url = \"https://purgatoire.ca/local/unlocked.jpg?\" + m;\nvar facestring = msg.payload;\n\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n   \"message\": \"Door Unlocked\",\n   \"title\": facestring + \" has arrived.\",\n   \"data\": {\n    \"image\": url\n   }\n  }\n }\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1540,"y":1840,"wires":[["914c3b096bd61312","abd9a704ef8311dc","8a0a19652fbc616e"]]},{"id":"24d353cbdf14472e","type":"comment","z":"cc94640ec8e547cb","name":"Set payload for message and display","info":"","x":1540,"y":1800,"wires":[]},{"id":"9456fead63fd8d20","type":"comment","z":"cc94640ec8e547cb","name":"set lights color and brightness for announcement","info":"","x":1880,"y":1800,"wires":[]},{"id":"e05deaa22833e66c","type":"comment","z":"cc94640ec8e547cb","name":"Announce the arrival of the person","info":"","x":2260,"y":1800,"wires":[]},{"id":"14f2faa78c4b0c8d","type":"api-call-service","z":"cc94640ec8e547cb","name":"Disable Alarm","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"alarm_control_panel","service":"alarm_disarm","areaId":[],"deviceId":[],"entityId":["alarm_control_panel.home_alarm"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1500,"y":1760,"wires":[[]]},{"id":"e440369da69d4ca2","type":"comment","z":"cc94640ec8e547cb","name":"Disable alarm when registered users are welcomed","info":"","x":1510,"y":1720,"wires":[]},{"id":"c338fee56fb202ba","type":"comment","z":"cc94640ec8e547cb","name":"notify my phone of the arrival","info":"","x":1900,"y":1980,"wires":[]},{"id":"47609a1a9b553764","type":"comment","z":"cc94640ec8e547cb","name":"Wait one second then turn on entrance lights","info":"They tend to get closed by the initial announcement of arrival. This insure they are on!","x":2290,"y":1960,"wires":[]},{"id":"683a93fd5de7680a","type":"comment","z":"cc94640ec8e547cb","name":"Monitor Lock through MQTT","info":"This is meant to pull more data from the unlock event, such as unlock_pin","x":200,"y":2320,"wires":[]},{"id":"c4b61c6b2da957b3","type":"comment","z":"cc94640ec8e547cb","name":"####NOTIFY WHEN SOMEONE LEAVES####","info":"","x":260,"y":2280,"wires":[]},{"id":"be068ec6e2cccc2e","type":"mqtt in","z":"cc94640ec8e547cb","name":"","topic":"zigbee2mqtt/lock_front_door","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":200,"y":2360,"wires":[["9ae983f66652f0e4"]]},{"id":"53f9bbc264becc23","type":"comment","z":"cc94640ec8e547cb","name":"Only allow manual unlocks","info":"This should only be inside unlocks as I never use the key","x":630,"y":2320,"wires":[]},{"id":"9ae983f66652f0e4","type":"switch","z":"cc94640ec8e547cb","name":"Action = Manual Unlock","property":"payload.action","propertyType":"msg","rules":[{"t":"eq","v":"manual_unlock","vt":"str"}],"checkall":"false","repair":false,"outputs":1,"x":630,"y":2360,"wires":[["5a8be93d88c3d417"]]},{"id":"5a8be93d88c3d417","type":"change","z":"cc94640ec8e547cb","name":"Set Data for someone going out ","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,255,0]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":950,"y":2360,"wires":[["b6811d11bf51e1bb"]]},{"id":"b6811d11bf51e1bb","type":"subflow:233ac7dcd801a802","z":"cc94640ec8e547cb","name":"","x":1350,"y":2360,"wires":[]},{"id":"86e0acba45187870","type":"comment","z":"cc94640ec8e547cb","name":"set lights color and brightness for announcement","info":"","x":960,"y":2320,"wires":[]},{"id":"27c9f8850cb8e075","type":"comment","z":"cc94640ec8e547cb","name":"Announce the exiting of a person","info":"","x":1350,"y":2320,"wires":[]},{"id":"c54b8b86c8d99dd9","type":"function","z":"cc94640ec8e547cb","name":"Javascript","func":"var recoface = [];\nvar d = new Date();\nvar m = d.getMilliseconds();\nvar url = \"https://purgatoire.ca/local/unlocked.jpg?\" + m;\nvar facestring = msg.payload;\n\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n   \"message\": \"Door Unlocked\",\n   \"title\": facestring + \" has arrived.\",\n   \"data\": {\n    \"image\": url\n   }\n  }\n }\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1600,"y":1460,"wires":[["659bb3222f8c2da5","c78e8d47a7458400"]]},{"id":"efc99d9bfb42c91a","type":"api-call-service","z":"cc94640ec8e547cb","name":"unLock Door","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"lock","service":"unlock","areaId":[],"deviceId":[],"entityId":["lock.lock_front_door"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1610,"y":1420,"wires":[[]]},{"id":"72cb7821723c1afc","type":"debug","z":"cc94640ec8e547cb","name":"debug 216","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":450,"y":1720,"wires":[]},{"id":"e6fafc5028a6bbfd","type":"change","z":"cc94640ec8e547cb","name":"Jordan","rules":[{"t":"set","p":"payload","pt":"msg","to":"Jordan","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1210,"y":1960,"wires":[["551208ac4f349765"]]},{"id":"aa44fe8732565c38","type":"change","z":"cc94640ec8e547cb","name":"Carla","rules":[{"t":"set","p":"message","pt":"msg","to":"Carla has arrived","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"Carla","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1210,"y":1920,"wires":[["551208ac4f349765"]]},{"id":"abd9a704ef8311dc","type":"api-call-service","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_galaxy_s10","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"1","valueType":"str"}],"queue":"none","x":1910,"y":1940,"wires":[[]]},{"id":"8a0a19652fbc616e","type":"api-call-service","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_fold4","areaId":[],"deviceId":[],"entityId":[],"data":"{\"message\":\"Bedroom door open\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1910,"y":1900,"wires":[["b62931fec68c6932"]]},{"id":"c78e8d47a7458400","type":"api-call-service","z":"cc94640ec8e547cb","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_fold4","areaId":[],"deviceId":[],"entityId":[],"data":"{\"message\":\"Bedroom door open\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1890,"y":1420,"wires":[[]]},{"id":"6eb10b45aabe6794","type":"change","z":"cc94640ec8e547cb","name":"Fay","rules":[{"t":"set","p":"message","pt":"msg","to":"Fay has arrived","tot":"str"},{"t":"set","p":"payload","pt":"msg","to":"Fay","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1210,"y":2000,"wires":[["551208ac4f349765"]]},{"id":"e66e110e65248f33","type":"trigger-state","z":"881898b44ee6eb81","name":"Bathroom empty","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.sensor_bathroom_motion_occupancy","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"},{"targetType":"entity_id","targetValue":"binary_sensor.sensor_bathroom_door_contact","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"},{"targetType":"entity_id","targetValue":"binary_sensor.shower_in_use","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":140,"y":760,"wires":[["de9f4c34e00835c7"],["12dd6306bdf52a97"]]},{"id":"f00baa6a10259753","type":"api-call-service","z":"881898b44ee6eb81","name":"Bathroom Light Off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.group_bathroom_lights"],"data":"{\"transition\": 10}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1030,"y":760,"wires":[[]]},{"id":"4df7dfe163f24063","type":"api-call-service","z":"881898b44ee6eb81","name":"Stop cast","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1440,"y":480,"wires":[[]]},{"id":"133f0e3df82044b9","type":"trigger-state","z":"881898b44ee6eb81","name":"Bathroom Motion","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.sensor_bathroom_motion_occupancy","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"},{"targetType":"entity_id","targetValue":"media_player.bathroom_speaker","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":140,"y":260,"wires":[["2b67f9d16cec1c09"],[]]},{"id":"2792eb2e57bd9533","type":"api-call-service","z":"881898b44ee6eb81","name":"Speaker 30% volume","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"{\"volume_level\": 0.3}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":980,"y":320,"wires":[[]]},{"id":"13d82a2362d4ab1a","type":"api-current-state","z":"881898b44ee6eb81","name":"Door state","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_bathroom_door_contact","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":770,"y":260,"wires":[["faa507096bd4db40"],["2792eb2e57bd9533"]]},{"id":"2b67f9d16cec1c09","type":"api-call-service","z":"881898b44ee6eb81","name":"Plex shuffle","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"{\"media_content_id\":\"plex://{ \\\"library_name\\\": \\\"Muzak\\\", \\\"shuffle\\\": 1, \\\"allow_multiple\\\": 1 }\",\"media_content_type\":\"music\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":490,"y":260,"wires":[["13d82a2362d4ab1a"]]},{"id":"faa507096bd4db40","type":"api-call-service","z":"881898b44ee6eb81","name":"Speaker 10% volume","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"{\"volume_level\": 0.1}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":980,"y":200,"wires":[[]]},{"id":"f25da7166587499b","type":"trigger","z":"881898b44ee6eb81","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"5","extend":false,"overrideDelay":false,"units":"min","reset":"0","bytopic":"all","topic":"topic","outputs":1,"x":770,"y":760,"wires":[["f00baa6a10259753"]]},{"id":"b90340783739c82f","type":"api-current-state","z":"881898b44ee6eb81","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"playing","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"media_player.group_home_speakers","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1150,"y":480,"wires":[["4df7dfe163f24063"],[]]},{"id":"8a87371543b31002","type":"change","z":"881898b44ee6eb81","name":"1","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":530,"y":740,"wires":[["f25da7166587499b"]]},{"id":"cf3320ead9bdaf99","type":"change","z":"881898b44ee6eb81","name":"0","rules":[{"t":"set","p":"payload","pt":"msg","to":"0","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":530,"y":780,"wires":[["f25da7166587499b"]]},{"id":"9ef1ba67723e18e1","type":"trigger-state","z":"881898b44ee6eb81","name":"Bathroom empty","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.sensor_bathroom_motion_occupancy","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"},{"targetType":"entity_id","targetValue":"binary_sensor.sensor_bathroom_door_contact","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"},{"targetType":"entity_id","targetValue":"binary_sensor.shower_in_use","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"},{"targetType":"entity_id","targetValue":"media_player.group_home_speakers","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":140,"y":480,"wires":[["6c7ad1714992bdd3"],["ed840b70957315b2"]]},{"id":"e00a291148e13b68","type":"trigger","z":"881898b44ee6eb81","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"2","extend":false,"overrideDelay":false,"units":"min","reset":"0","bytopic":"all","topic":"topic","outputs":1,"x":850,"y":480,"wires":[["b90340783739c82f"]]},{"id":"e921ceff2ed05761","type":"change","z":"881898b44ee6eb81","name":"1","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":460,"wires":[["e00a291148e13b68"]]},{"id":"68230369115ebbb3","type":"change","z":"881898b44ee6eb81","name":"0","rules":[{"t":"set","p":"payload","pt":"msg","to":"0","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":550,"y":500,"wires":[["e00a291148e13b68"]]},{"id":"be846337e1b080d5","type":"comment","z":"881898b44ee6eb81","name":"Check if bathroom is empty using multiple conditions","info":"","x":250,"y":720,"wires":[]},{"id":"11e99b692d36dd6f","type":"comment","z":"881898b44ee6eb81","name":"Set payload to 1","info":"","x":540,"y":700,"wires":[]},{"id":"486e4e44fc47ef9b","type":"comment","z":"881898b44ee6eb81","name":"Set payload to 0","info":"","x":540,"y":820,"wires":[]},{"id":"2faeb6d246f87e69","type":"comment","z":"881898b44ee6eb81","name":"wait 5 minutes","info":"","x":770,"y":720,"wires":[]},{"id":"4ed1b3f13e1f7666","type":"comment","z":"881898b44ee6eb81","name":"(resets on payload = 0)","info":"","x":780,"y":800,"wires":[]},{"id":"63ed7065e90c3759","type":"comment","z":"881898b44ee6eb81","name":"Turn the lights off","info":"","x":1020,"y":720,"wires":[]},{"id":"5b9f41bf5bb52993","type":"comment","z":"881898b44ee6eb81","name":"Motion in bathroom and speaker off","info":"","x":200,"y":220,"wires":[]},{"id":"b690d3c56536fcd0","type":"comment","z":"881898b44ee6eb81","name":"Shuffle plex Muzak Library","info":"","x":490,"y":220,"wires":[]},{"id":"c0c076ef598dc692","type":"comment","z":"881898b44ee6eb81","name":"Check door state","info":"This will determine wich volume to set","x":760,"y":220,"wires":[]},{"id":"ae8d2eaf6737b656","type":"comment","z":"881898b44ee6eb81","name":"Set volume to 10% if door open","info":"This will determine wich volume to set","x":970,"y":160,"wires":[]},{"id":"d630bbf362b918ed","type":"comment","z":"881898b44ee6eb81","name":"Set volume to 30% if door closed","info":"This will determine wich volume to set","x":970,"y":360,"wires":[]},{"id":"d43d39fed9776b80","type":"comment","z":"881898b44ee6eb81","name":"wait 2 minutes","info":"","x":850,"y":440,"wires":[]},{"id":"2a7b69dbbb324c60","type":"comment","z":"881898b44ee6eb81","name":"(resets on payload = 0)","info":"","x":860,"y":520,"wires":[]},{"id":"9b0a35b03915e31d","type":"comment","z":"881898b44ee6eb81","name":"Confirm that home group is  not playing","info":"","x":1150,"y":440,"wires":[]},{"id":"806564fbd87d694f","type":"comment","z":"881898b44ee6eb81","name":"Stop the Bathroom speaker","info":"","x":1430,"y":440,"wires":[]},{"id":"d919924c879f0ff6","type":"comment","z":"881898b44ee6eb81","name":"Set payload to 1","info":"","x":560,"y":420,"wires":[]},{"id":"942b5609d3df03a0","type":"comment","z":"881898b44ee6eb81","name":"Set payload to 0","info":"","x":560,"y":540,"wires":[]},{"id":"8c5ecae5186f35af","type":"comment","z":"881898b44ee6eb81","name":"Check if bathroom is empty using multiple conditions","info":"","x":250,"y":440,"wires":[]},{"id":"3c2838394f50a39a","type":"api-call-service","z":"881898b44ee6eb81","name":"Bathroom Speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"{\"volume_level\":\"0.0\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1070,"y":1280,"wires":[[]]},{"id":"4330840189d888ec","type":"api-call-service","z":"881898b44ee6eb81","name":"Bathroom Speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1910,"y":1140,"wires":[[]]},{"id":"cecc49282031c619","type":"server-state-changed","z":"881898b44ee6eb81","name":"Door Closes?","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.sensor_bathroom_door_contact","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"off","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":130,"y":1220,"wires":[["8ecacc3680df8a66"],["471b6b35d2f07b2f"]]},{"id":"c7d7869cf88446c1","type":"api-current-state","z":"881898b44ee6eb81","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"switch.bathroom_fan","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":600,"y":1140,"wires":[["d26eadfb6228a626"],["695dbd47c25a51cc"]]},{"id":"ade0768cb997a2b3","type":"api-current-state","z":"881898b44ee6eb81","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"playing","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.livingroom_chromecast","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":650,"y":1300,"wires":[["7fcd0180ea269945"],["340260f5e20a06a1"]]},{"id":"965baad3e9a7ca9b","type":"api-call-service","z":"881898b44ee6eb81","name":"Bathroom Speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"{\"volume_level\":\"0.1\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1710,"y":1340,"wires":[[]]},{"id":"cf3f9442d8a57374","type":"api-current-state","z":"881898b44ee6eb81","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"playing","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.group_home_speakers","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1290,"y":1320,"wires":[["73508ebeaf49e873"],["965baad3e9a7ca9b"]]},{"id":"40902a85fa0988ab","type":"function","z":"881898b44ee6eb81","name":"Volume Selector","func":"var d = new Date();\nvar h = d.getHours();\n\n\nif (h > 22){\n    var brightness = \"0.25\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness = \"0.20\";\n}\nelse if (h>2 && h<8){\n    var brightness = \"0.15\";\n}\nelse{\n    var brightness = \"0.30\";\n}\n\n\n\n\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n            \"data\": {\n            \"volume_level\": brightness\n            }\n            }\n            \n   }\n\nreturn newMsg;\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1680,"y":1180,"wires":[["4330840189d888ec"]]},{"id":"2676640708d0f3db","type":"function","z":"881898b44ee6eb81","name":"Volume Selector","func":"var d = new Date();\nvar h = d.getHours();\n\n\nif (h > 22){\n    var brightness = \"0.4\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness = \"0.35\";\n}\nelse if (h>2 && h<7){\n    var brightness = \"0.3\";\n}\nelse{\n    var brightness = \"0.4\";\n}\n\n\n\n\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n            \"data\": {\n            \"volume_level\": brightness\n            }\n            }\n            \n   }\n\nreturn newMsg;\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1680,"y":1100,"wires":[["4330840189d888ec"]]},{"id":"34a00fb595015780","type":"comment","z":"881898b44ee6eb81","name":"Is the nearby TV playing ?","info":"","x":650,"y":1260,"wires":[]},{"id":"141562d5a8ac39c9","type":"comment","z":"881898b44ee6eb81","name":"Door Closed?","info":"","x":130,"y":1180,"wires":[]},{"id":"0e570e07fd90d8a7","type":"comment","z":"881898b44ee6eb81","name":"Yes","info":"","x":370,"y":1180,"wires":[]},{"id":"f95a1288136cfdb1","type":"comment","z":"881898b44ee6eb81","name":"No","info":"","x":370,"y":1280,"wires":[]},{"id":"d9531c85373b51e8","type":"comment","z":"881898b44ee6eb81","name":"Is the bathroom fan on?","info":"","x":600,"y":1100,"wires":[]},{"id":"aba3ce96d79d9717","type":"comment","z":"881898b44ee6eb81","name":"Yes","info":"","x":830,"y":1120,"wires":[]},{"id":"2362a16cf52e522c","type":"comment","z":"881898b44ee6eb81","name":"No","info":"","x":830,"y":1160,"wires":[]},{"id":"2e212d74dcc00a3e","type":"comment","z":"881898b44ee6eb81","name":"Set volume depending on time","info":"","x":1660,"y":1140,"wires":[]},{"id":"2ac64f2e64f9c56e","type":"comment","z":"881898b44ee6eb81","name":"Call set_volume service","info":"","x":1920,"y":1100,"wires":[]},{"id":"a7b97a0090d21f1d","type":"comment","z":"881898b44ee6eb81","name":"Set Volume to 0%","info":"","x":1070,"y":1240,"wires":[]},{"id":"e121ef702275cf9c","type":"comment","z":"881898b44ee6eb81","name":"Is Home Group playing?","info":"","x":1290,"y":1280,"wires":[]},{"id":"d03d9553579bdd5c","type":"comment","z":"881898b44ee6eb81","name":"Set speaker volume to 10%","info":"","x":1720,"y":1300,"wires":[]},{"id":"36c17d265566d694","type":"comment","z":"881898b44ee6eb81","name":"Yes","info":"","x":1510,"y":1240,"wires":[]},{"id":"27d73f462b3c06e7","type":"comment","z":"881898b44ee6eb81","name":"No","info":"","x":1530,"y":1340,"wires":[]},{"id":"41bc22242e8b6353","type":"comment","z":"881898b44ee6eb81","name":"Yes","info":"","x":910,"y":1280,"wires":[]},{"id":"aa83552c8e86c590","type":"comment","z":"881898b44ee6eb81","name":"No","info":"","x":910,"y":1320,"wires":[]},{"id":"e2d076fca2183a33","type":"server-state-changed","z":"881898b44ee6eb81","name":"Shower Music speaker Playing?","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"media_player.bathroom_music_speaker","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"off","ifStateType":"str","ifStateOperator":"is_not","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":190,"y":1580,"wires":[["b6b49543ca03433b"],["5391dd8b0174feca"]]},{"id":"9b337d8762637eaa","type":"api-call-service","z":"881898b44ee6eb81","name":"Mute bathroom speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"{\"is_volume_muted\":\"1\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":690,"y":1560,"wires":[["dbd6485bf75b90c2"]]},{"id":"0b8ee3f939557602","type":"api-call-service","z":"881898b44ee6eb81","name":"unMute bathroom speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"{\"is_volume_muted\":\"0\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":690,"y":1600,"wires":[[]]},{"id":"ed5811c87bcd2804","type":"api-call-service","z":"881898b44ee6eb81","name":"Stop bathroom speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_music_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1530,"y":1560,"wires":[[]]},{"id":"4ce58926e7976eb0","type":"change","z":"881898b44ee6eb81","name":"Set value to 1","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1270,"y":1560,"wires":[["ed5811c87bcd2804"]]},{"id":"dbd6485bf75b90c2","type":"trigger","z":"881898b44ee6eb81","name":"40m","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"40","extend":false,"overrideDelay":false,"units":"min","reset":"on","bytopic":"all","topic":"topic","outputs":1,"x":1050,"y":1560,"wires":[["4ce58926e7976eb0"]]},{"id":"7ed30b7a5aeffa79","type":"server-state-changed","z":"881898b44ee6eb81","name":"door_open","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.sensor_bathroom_door_contact","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":880,"y":1520,"wires":[["dbd6485bf75b90c2","eb2007c7b6292a41"],[]]},{"id":"a78bc5e9643a7e13","type":"comment","z":"881898b44ee6eb81","name":"Is the shower speaker playing?","info":"","x":190,"y":1540,"wires":[]},{"id":"e7dedef2dd79771b","type":"comment","z":"881898b44ee6eb81","name":"Yes","info":"","x":510,"y":1560,"wires":[]},{"id":"46547f4052ae769d","type":"comment","z":"881898b44ee6eb81","name":"No","info":"","x":510,"y":1600,"wires":[]},{"id":"ff7531b46d7d9fa1","type":"comment","z":"881898b44ee6eb81","name":"Mute the bathroom speaker","info":"","x":680,"y":1520,"wires":[]},{"id":"d58ec3650bf91ab4","type":"comment","z":"881898b44ee6eb81","name":"Unmute the bathroom speaker","info":"","x":680,"y":1640,"wires":[]},{"id":"c8c832241b285a32","type":"comment","z":"881898b44ee6eb81","name":"Doors turns \"on\" (Opened)","info":"","x":890,"y":1480,"wires":[]},{"id":"76e8d92ef97c7ab4","type":"comment","z":"881898b44ee6eb81","name":"reset on \"on\"","info":"","x":1050,"y":1600,"wires":[]},{"id":"e6888a73c8e897af","type":"comment","z":"881898b44ee6eb81","name":"wait 40 minutes","info":"","x":1060,"y":1520,"wires":[]},{"id":"acd37fe93cc74038","type":"comment","z":"881898b44ee6eb81","name":"Reset the payload to 1","info":"","x":1260,"y":1520,"wires":[]},{"id":"bee9cc9f62cdb66e","type":"comment","z":"881898b44ee6eb81","name":"Stop Bathroom Speaker","info":"","x":1520,"y":1520,"wires":[]},{"id":"16350980bdaeb03d","type":"server-state-changed","z":"881898b44ee6eb81","name":"Get bathroom humidity","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sensor.sensor_bathroom_temperature_humidity","entityIdType":"exact","outputInitially":true,"stateType":"str","ifState":"","ifStateType":"num","ifStateOperator":"gt","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"current_humidity","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":160,"y":1920,"wires":[["6a1ed2ffc9ac17c7"]]},{"id":"7d0f5838de6d82b3","type":"api-call-service","z":"881898b44ee6eb81","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_on","areaId":[],"deviceId":[],"entityId":["switch.bathroom_fan"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1220,"y":1880,"wires":[[]]},{"id":"e035b4b481bedb26","type":"api-call-service","z":"881898b44ee6eb81","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_off","areaId":[],"deviceId":[],"entityId":["switch.bathroom_fan"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1220,"y":1940,"wires":[[]]},{"id":"983cafc3d10300b1","type":"comment","z":"881898b44ee6eb81","name":"Pull bathroom humidity","info":"","x":160,"y":1880,"wires":[]},{"id":"f893d5d64f4338ba","type":"comment","z":"881898b44ee6eb81","name":"Actuate on decided outcome","info":"","x":980,"y":1880,"wires":[]},{"id":"f241683f39e10522","type":"comment","z":"881898b44ee6eb81","name":"Turn on the bathroom fan","info":"","x":1220,"y":1840,"wires":[]},{"id":"6834fab31c07eae3","type":"comment","z":"881898b44ee6eb81","name":"Turn off the bathroom fan","info":"","x":1250,"y":1980,"wires":[]},{"id":"f186e9ea925af2ec","type":"trigger","z":"881898b44ee6eb81","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"20","extend":false,"overrideDelay":false,"units":"min","reset":"on","bytopic":"all","topic":"topic","outputs":1,"x":470,"y":2200,"wires":[["d9fca36cb2a4092d"]]},{"id":"d9fca36cb2a4092d","type":"api-current-state","z":"881898b44ee6eb81","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_bathroom_door_contact","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":800,"y":2200,"wires":[["be9128ea6c1c91d2"],[]]},{"id":"b596e9a2015af841","type":"api-call-service","z":"881898b44ee6eb81","name":"Bathroom Speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_up","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1670,"y":2200,"wires":[["b2412d064f56fa8f"]]},{"id":"b2412d064f56fa8f","type":"api-call-service","z":"881898b44ee6eb81","name":"Bathroom Speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_up","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1870,"y":2200,"wires":[[]]},{"id":"6ef59f8cc4579f7d","type":"server-state-changed","z":"881898b44ee6eb81","name":"Bathroom fan on","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"switch.bathroom_fan","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":140,"y":2200,"wires":[["f186e9ea925af2ec"],[]]},{"id":"ee6a97d031ef2629","type":"comment","z":"881898b44ee6eb81","name":"Is the BAthroom FAN on?","info":"","x":170,"y":2160,"wires":[]},{"id":"b28d79f724a4f365","type":"comment","z":"881898b44ee6eb81","name":"Only act every 20 minutes","info":"","x":470,"y":2160,"wires":[]},{"id":"1cbb6e7c1f59768f","type":"comment","z":"881898b44ee6eb81","name":"Is the door closed?","info":"","x":790,"y":2160,"wires":[]},{"id":"ec84c53be5f75a87","type":"comment","z":"881898b44ee6eb81","name":"Raise the volume twice","info":"","x":1760,"y":2160,"wires":[]},{"id":"be9128ea6c1c91d2","type":"api-current-state","z":"881898b44ee6eb81","name":"Make sure secondary shower speaker is off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.bathroom_music_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1270,"y":2200,"wires":[["b596e9a2015af841"],[]]},{"id":"9015d3ed9860c863","type":"comment","z":"881898b44ee6eb81","name":"Make sure secondary shower speaker is off","info":"","x":1340,"y":2160,"wires":[]},{"id":"6a1ed2ffc9ac17c7","type":"api-current-state","z":"881898b44ee6eb81","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"sensor.house_median_humidity","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"house_humidity","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":460,"y":1920,"wires":[["89ed08e358bc7512"]]},{"id":"89ed08e358bc7512","type":"function","z":"881898b44ee6eb81","name":"function 2","func":"var current_humidity = msg.current_humidity;\nvar house_humidity = msg.house_humidity;\nvar house_plus_20_temp = house_humidity;\nvar house_plus_20 = parseInt(house_plus_20_temp) + 20;\nvar house_plus_5_temp = house_humidity;\nvar house_plus_5 = parseInt(house_plus_5_temp) + 5;\n\n\nvar command = \"\";\n\nif (current_humidity > house_plus_20  ){\n    var command = \"on\";\n} else if (current_humidity < house_plus_5)\n    var command = \"off\";\n\nvar newMsg = {\n    \"payload\": {\n        \"command\": command,\n        \"house_plus_5\": house_plus_5,\n        \"house_plus_20\": house_plus_20\n    }\n\n}\n\nreturn newMsg;\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":760,"y":1920,"wires":[["ef290e1185171945"]]},{"id":"0fee623451db75ab","type":"comment","z":"881898b44ee6eb81","name":"Pull house median humidity","info":"","x":460,"y":1880,"wires":[]},{"id":"4d4b72714716512d","type":"comment","z":"881898b44ee6eb81","name":"compare the two","info":"","x":760,"y":1880,"wires":[]},{"id":"ef290e1185171945","type":"switch","z":"881898b44ee6eb81","name":"On or off?","property":"payload.command","propertyType":"msg","rules":[{"t":"cont","v":"on","vt":"str"},{"t":"cont","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":980,"y":1920,"wires":[["7d0f5838de6d82b3"],["e035b4b481bedb26"]]},{"id":"9bd077f7ed29fb10","type":"mqtt in","z":"56c911ff62a860ba","name":"","topic":"zigbee2mqtt/remote_bedroom_dial","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":200,"y":600,"wires":[["acd5834be9900ca4"]]},{"id":"acd5834be9900ca4","type":"subflow:61f53235c712b2c2","z":"56c911ff62a860ba","name":"","x":450,"y":600,"wires":[]},{"id":"7ef4002fdd1c5702","type":"server-state-changed","z":"56c911ff62a860ba","name":"Is someone sleeping in the bedroom?","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":220,"y":380,"wires":[["35d3219322e2e806"],[]]},{"id":"c51712ff9318111b","type":"api-call-service","z":"56c911ff62a860ba","name":"Turn on binary Input","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.sleeper_in_bedroom"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":740,"y":380,"wires":[[]]},{"id":"2a4c58f625a1a208","type":"comment","z":"56c911ff62a860ba","name":"Is \"sleeper in bedroom\" on?","info":"","x":200,"y":340,"wires":[]},{"id":"dc62e7735c9d188d","type":"comment","z":"56c911ff62a860ba","name":"yes","info":"","x":490,"y":380,"wires":[]},{"id":"2ae08dae9269f961","type":"comment","z":"56c911ff62a860ba","name":"Turn on sleeper_in_bedroom binary input","info":"","x":760,"y":340,"wires":[]},{"id":"08c46579e9aef10f","type":"api-call-service","z":"56c911ff62a860ba","name":"Turn off binary Input","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_boolean","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.sleeper_in_bedroom"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":740,"y":480,"wires":[[]]},{"id":"92b127ebba647c77","type":"comment","z":"56c911ff62a860ba","name":"Turn off sleeper_in_bedroom binary input","info":"","x":760,"y":440,"wires":[]},{"id":"3712dfdb3e0f1346","type":"server-state-changed","z":"56c911ff62a860ba","name":"Is the main light in the bedroom on?","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"light.group_bedroom_lights","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":200,"y":480,"wires":[["08c46579e9aef10f"],[]]},{"id":"700c8120a03529b4","type":"comment","z":"56c911ff62a860ba","name":"### MANAGE SLEEPER IN BEDROOM ###","info":"","x":230,"y":300,"wires":[]},{"id":"af6a5e1a4caa150b","type":"comment","z":"56c911ff62a860ba","name":"Are the lights on?","info":"","x":160,"y":440,"wires":[]},{"id":"4479ce75aaa66605","type":"server-state-changed","z":"56c911ff62a860ba","name":"Maxi sleeping","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.sleeper_in_bedroom","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":120,"y":820,"wires":[["4541a9f6695d27d9"],[]]},{"id":"c7ba304c1075a40c","type":"change","z":"56c911ff62a860ba","name":"set url","rules":[{"t":"set","p":"url","pt":"msg","to":"http://192.168.0.15:8123/local/thunderstorm.mp4","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":870,"y":820,"wires":[["566175fcf2828da5"]]},{"id":"ba42cf8822718c61","type":"api-call-service","z":"56c911ff62a860ba","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1310,"y":820,"wires":[["fd2911d7142ac815"]]},{"id":"566175fcf2828da5","type":"change","z":"56c911ff62a860ba","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"media_player.bedroom_speaker","tot":"str"},{"t":"set","p":"payload.data.media_content_id","pt":"msg","to":"url","tot":"msg"},{"t":"set","p":"payload.data.media_content_type","pt":"msg","to":"music","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1080,"y":820,"wires":[["ba42cf8822718c61"]]},{"id":"dbb80d8bab24f4aa","type":"api-call-service","z":"56c911ff62a860ba","name":"volume to 100%","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bedroom_speaker"],"data":"{\"volume_level\":\"0.4\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1840,"y":820,"wires":[[]]},{"id":"fd2911d7142ac815","type":"change","z":"56c911ff62a860ba","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1620,"y":820,"wires":[["dbb80d8bab24f4aa"]]},{"id":"4541a9f6695d27d9","type":"api-current-state","z":"56c911ff62a860ba","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"playing","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"media_player.bedroom_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":460,"y":820,"wires":[["c7ba304c1075a40c"],[]]},{"id":"9c2e185ac65da3a4","type":"comment","z":"56c911ff62a860ba","name":"Turn on thunderstorm sounds upon maxi sleeping","info":"","x":240,"y":780,"wires":[]},{"id":"c43875db375f2289","type":"mqtt in","z":"56c911ff62a860ba","name":"","topic":"zigbee2mqtt/remote_phillips_tap","qos":"0","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":190,"y":1000,"wires":[["df58e70a3d7e859f"]]},{"id":"df58e70a3d7e859f","type":"delay","z":"56c911ff62a860ba","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"0.5","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":430,"y":1000,"wires":[["79368c95e157be94"]]},{"id":"79368c95e157be94","type":"switch","z":"56c911ff62a860ba","name":"Command","property":"payload.action","propertyType":"msg","rules":[{"t":"eq","v":"press_1","vt":"str"},{"t":"eq","v":"press_2","vt":"str"},{"t":"eq","v":"press_3","vt":"str"},{"t":"eq","v":"press_4","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":630,"y":1000,"wires":[["8455bb48b0d2bc80"],["b538ef93c6d6a5dd"],[],["44b9700d20f8918b"]]},{"id":"8455bb48b0d2bc80","type":"api-call-service","z":"56c911ff62a860ba","name":"Toggle Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"toggle","areaId":[],"deviceId":[],"entityId":["light.group_bedroom_lights"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":790,"y":960,"wires":[[]]},{"id":"44b9700d20f8918b","type":"api-call-service","z":"56c911ff62a860ba","name":"Brigthen lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.group_bedroom_lights"],"data":"{\"brightness_step\":25}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":800,"y":1040,"wires":[[]]},{"id":"b538ef93c6d6a5dd","type":"api-call-service","z":"56c911ff62a860ba","name":"Dim lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.group_bedroom_lights"],"data":"{\"brightness_step\":-35}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":780,"y":1000,"wires":[[]]},{"id":"4c6fbec4725b8424","type":"server-state-changed","z":"adab22047f9bb868","name":"Blind Button","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"sensor.remote_office_blind_button_action","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"(open|close)","ifStateType":"re","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":170,"y":500,"wires":[["41e61ba57570116b"],[]]},{"id":"41e61ba57570116b","type":"switch","z":"adab22047f9bb868","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"open","vt":"str"},{"t":"eq","v":"close","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":350,"y":500,"wires":[["b0b758c58d0b03c8"],["d82e914953b96f55"]]},{"id":"b0b758c58d0b03c8","type":"api-call-service","z":"adab22047f9bb868","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"open_cover","areaId":[],"deviceId":[],"entityId":["cover.cover_office_blinds"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":570,"y":480,"wires":[[]]},{"id":"d82e914953b96f55","type":"api-call-service","z":"adab22047f9bb868","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"close_cover","areaId":[],"deviceId":[],"entityId":["cover.cover_office_blinds"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":570,"y":520,"wires":[[]]},{"id":"307238d62657a26c","type":"mqtt in","z":"adab22047f9bb868","name":"","topic":"zigbee2mqtt/remote_office_dial","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":230,"y":140,"wires":[["945bf5ac05c5d4c1"]]},{"id":"945bf5ac05c5d4c1","type":"subflow:61f53235c712b2c2","z":"adab22047f9bb868","name":"","x":490,"y":140,"wires":[]},{"id":"bf4db16910c7618b","type":"trigger-state","z":"adab22047f9bb868","g":"f27b924821bee7c6","name":"Cover Closed and AC on","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"switch.zooz_office_ac","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"entity_id","targetValue":"cover.cover_office_blinds","propertyType":"property","propertyValue":"attributes.current_position","comparatorType":"<","comparatorValueDatatype":"num","comparatorValue":"26"},{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":230,"y":720,"wires":[["dc0f74507fa165b1"],[]]},{"id":"dc0f74507fa165b1","type":"api-call-service","z":"adab22047f9bb868","g":"f27b924821bee7c6","name":"Blinds at 26% ","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"set_cover_position","areaId":[],"deviceId":[],"entityId":["cover.cover_office_blinds"],"data":"{\"position\": \"26\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":540,"y":720,"wires":[[]]},{"id":"90d211d6a743e930","type":"api-call-service","z":"adab22047f9bb868","name":"CLose blinds","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"set_cover_position","areaId":[],"deviceId":[],"entityId":["cover.cover_office_blinds"],"data":"{\"position\": \"0\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":530,"y":860,"wires":[[]]},{"id":"56c93fec23942ed9","type":"api-call-service","z":"adab22047f9bb868","g":"f27b924821bee7c6","name":"Blinds at 26% ","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"set_cover_position","areaId":[],"deviceId":[],"entityId":["cover.cover_office_blinds"],"data":"{\"position\": \"26\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":540,"y":640,"wires":[[]]},{"id":"8f1b1ff4d20a8d6d","type":"trigger-state","z":"adab22047f9bb868","name":"Cover Closed and AC Off","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"switch.zooz_office_ac","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"entity_id","targetValue":"cover.cover_office_blinds","propertyType":"property","propertyValue":"attributes.current_position","comparatorType":"<","comparatorValueDatatype":"num","comparatorValue":"27"},{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":210,"y":860,"wires":[["90d211d6a743e930"],[]]},{"id":"722aab7f36fe606a","type":"trigger-state","z":"adab22047f9bb868","g":"f27b924821bee7c6","name":"Closed Cover and AC on","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"cover.cover_office_blinds","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"property","propertyValue":"new_state.attributes.current_position","comparatorType":"<","comparatorValueDatatype":"num","comparatorValue":"26"},{"targetType":"entity_id","targetValue":"switch.zooz_office_ac","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":230,"y":640,"wires":[["56c93fec23942ed9"],[]]},{"id":"b991422029043762","type":"comment","z":"adab22047f9bb868","g":"f27b924821bee7c6","name":"If cover is under 26% and AC is on","info":"","x":240,"y":680,"wires":[]},{"id":"d38eb955df6f7d83","type":"comment","z":"adab22047f9bb868","g":"f27b924821bee7c6","name":"Set cover to 26% open","info":"","x":540,"y":680,"wires":[]},{"id":"981662dd196ab250","type":"comment","z":"adab22047f9bb868","name":"If cover is under 26% and AC is off","info":"","x":220,"y":820,"wires":[]},{"id":"5108e856fc604908","type":"comment","z":"adab22047f9bb868","name":"Close blinds","info":"","x":510,"y":820,"wires":[]},{"id":"cacda7a9a81473d7","type":"server-state-changed","z":"adab22047f9bb868","name":"office speaker","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"media_player.office_speaker","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"playing","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"seconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":170,"y":300,"wires":[["6305951b9f436579"],[]]},{"id":"5cdf0ad8625565cf","type":"function","z":"adab22047f9bb868","name":"Extract artist and set musicbrainz query","func":"var artist = msg.data.new_state.attributes.media_artist; // light group\n\nvar url = \"https://musicbrainz.org/ws/2/artist/?query=name:\" + artist;\n\n\nvar msg = {\n     \"url\": url\n\n}\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":700,"y":300,"wires":[["9736e74e51f5418f"]]},{"id":"9736e74e51f5418f","type":"http request","z":"adab22047f9bb868","name":"","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":990,"y":300,"wires":[["e8a8887e387464a5"]]},{"id":"e8a8887e387464a5","type":"xml","z":"adab22047f9bb868","name":"","property":"payload","attr":"","chr":"","x":1190,"y":300,"wires":[["37604b826333d5fd"]]},{"id":"37604b826333d5fd","type":"function","z":"adab22047f9bb868","name":"Extract Artist for API call to Lidarr","func":"var id = msg.payload.metadata[\"artist-list\"][0].artist[0].$.id;\nvar url = \"http://192.168.0.20:8686/api/v1/artist\";\nvar name = msg.payload.metadata[\"artist-list\"][0].artist[0].name[0];\n\nvar msg = {\n     \"url\": url,\n     \"payload\": {\n          \"ArtistName\": name,\n          \"Path\": \"/media/Music/\" + name,\n          \"rootFolderPath\": \"/media/Music\",\n          \"ForeignArtistId\": id,\n          \"QualityProfileId\": \"1\",\n          \"MetadataProfileId\": \"1\",\n          \"Monitored\": true\n     }\n\n};\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1440,"y":300,"wires":[["4538b6ad3f79553c"]]},{"id":"4538b6ad3f79553c","type":"http request","z":"adab22047f9bb868","name":"","method":"POST","ret":"txt","paytoqs":"body","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"bearer","senderr":false,"headers":[],"x":1690,"y":300,"wires":[[]]},{"id":"7f0d446eb6ffe153","type":"comment","z":"adab22047f9bb868","name":"Check Office Speaker for playback","info":"","x":180,"y":260,"wires":[]},{"id":"2980e3c451118b65","type":"comment","z":"adab22047f9bb868","name":"Extract Artist for musicbrainz Querry to get the ID","info":"","x":740,"y":260,"wires":[]},{"id":"0420076dc7a48b5a","type":"comment","z":"adab22047f9bb868","name":"Get musicbrainz ","info":"","x":1000,"y":260,"wires":[]},{"id":"234fee3f8cb73e95","type":"comment","z":"adab22047f9bb868","name":"Convert to XML","info":"","x":1200,"y":260,"wires":[]},{"id":"9f523d93671ce062","type":"comment","z":"adab22047f9bb868","name":"Extract data for Lidarr callback","info":"","x":1440,"y":260,"wires":[]},{"id":"e7e89501f6a98860","type":"comment","z":"adab22047f9bb868","name":"Add to Lidarr","info":"","x":1690,"y":260,"wires":[]},{"id":"590f6e877edea304","type":"server-state-changed","z":"adab22047f9bb868","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"switch.zooz_office_ac","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"(on)","ifStateType":"re","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":250,"y":1160,"wires":[["f497510b82dd7301"],["420c70dfa3d8d0ec"]]},{"id":"ba2eb5bc9188d9ad","type":"api-call-service","z":"adab22047f9bb868","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_down","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1190,"y":1180,"wires":[[]]},{"id":"2d83a7425a360b6f","type":"api-call-service","z":"adab22047f9bb868","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_up","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1190,"y":1120,"wires":[[]]},{"id":"83089d56e084c667","type":"comment","z":"adab22047f9bb868","name":"AC turns on","info":"","x":170,"y":1120,"wires":[]},{"id":"70bd27facdf67f36","type":"comment","z":"adab22047f9bb868","name":"Turn volume up","info":"","x":1180,"y":1080,"wires":[]},{"id":"f497510b82dd7301","type":"ha-get-entities","z":"adab22047f9bb868","name":"","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.office(?!plex).*","valueType":"re"},{"property":"state","logic":"is","value":"playing","valueType":"str"},{"property":"attributes.is_volume_muted","logic":"is","value":"false","valueType":"bool"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":510,"y":1120,"wires":[["7e6b3ecd6a4aacaf"]]},{"id":"420c70dfa3d8d0ec","type":"ha-get-entities","z":"adab22047f9bb868","name":"","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.office(?!plex).*_speaker","valueType":"re"},{"property":"state","logic":"is","value":"playing","valueType":"str"},{"property":"attributes.is_volume_muted","logic":"is","value":"false","valueType":"bool"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":510,"y":1180,"wires":[["9912e9487152918c"]]},{"id":"7e6b3ecd6a4aacaf","type":"change","z":"adab22047f9bb868","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":1120,"wires":[["2d83a7425a360b6f"]]},{"id":"9912e9487152918c","type":"change","z":"adab22047f9bb868","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":1180,"wires":[["ba2eb5bc9188d9ad"]]},{"id":"50a0ed02b34007b2","type":"comment","z":"adab22047f9bb868","name":"Extract the entity id","info":"","x":830,"y":1080,"wires":[]},{"id":"9fb5e92b2b1915a0","type":"comment","z":"adab22047f9bb868","name":"Get playing unmuted media players","info":"","x":500,"y":1080,"wires":[]},{"id":"afdd8e9875209fc6","type":"server-state-changed","z":"adab22047f9bb868","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":1,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.office_lights_color","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"re","halt_if_compare":"is","output_only_on_state_change":true,"x":240,"y":1580,"wires":[["7610812befe02abc","9b484bbe01d9afcf","e11e3807d7c9711e"]]},{"id":"7610812befe02abc","type":"function","z":"adab22047f9bb868","name":"Extract RGB from entity and divive each value by 255 (color)","func":"var rgb_value = msg.payload.replace(\"\\(\",\"\").replace(\"\\)\",\"\");\nconst color_array = rgb_value.split(\", \");\nvar RV = (color_array[0]  / 255);\nvar GV = (color_array[1]  / 255);\nvar BV = (color_array[2]  / 255);\n\nvar RVT = RV.toString().substring(0, 3);\nvar GVT = GV.toString().substring(0, 3);\nvar BVT = BV.toString().substring(0, 3);\n\nvar msg = {\n    \"payload\": {\n        \"data\": {\n            \"topic\": \"homeassistant/button/PC_Maxi_Desktop/Maxi_pc_customcommand/action\",\n            \"payload\": \"%wpe% -control applyProperties -properties RAW~\\(\\{\\\"color\\\":\\\"\" + RVT + \" \" + GVT + \" \" + BVT + \"\\\"\\}\\)~END\"\n        }\n    }\n\n}\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":680,"y":1580,"wires":[["efdec8750d852c6f"]]},{"id":"efdec8750d852c6f","type":"api-call-service","z":"adab22047f9bb868","name":"Send MQTT Command","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"mqtt","service":"publish","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1130,"y":1580,"wires":[[]]},{"id":"9b484bbe01d9afcf","type":"function","z":"adab22047f9bb868","name":"Extract RGB from entity and divive each value by 255 (Backgroundcolor)","func":"var rgb_value = msg.payload.replace(\"\\(\",\"\").replace(\"\\)\",\"\");\nconst color_array = rgb_value.split(\", \");\nvar RV = (color_array[0]  / 255);\nvar GV = (color_array[1]  / 255);\nvar BV = (color_array[2]  / 255);\n\nvar RVT = RV.toString().substring(0, 3);\nvar GVT = GV.toString().substring(0, 3);\nvar BVT = BV.toString().substring(0, 3);\n\nvar msg = {\n    \"payload\": {\n        \"data\": {\n            \"topic\": \"homeassistant/button/PC_Maxi_Desktop/Maxi_pc_customcommand/action\",\n            \"payload\": \"%wpe% -control applyProperties -properties RAW~\\(\\{\\\"backgroundcolor\\\":\\\"\" + RVT + \" \" + GVT + \" \" + BVT + \"\\\"\\}\\)~END\"\n        }\n    }\n\n}\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":720,"y":1540,"wires":[["5f05be4b095671d5"]]},{"id":"5f05be4b095671d5","type":"api-call-service","z":"adab22047f9bb868","name":"Send MQTT Command","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"mqtt","service":"publish","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1130,"y":1540,"wires":[["c894ba32dd15aa7c"]]},{"id":"e11e3807d7c9711e","type":"function","z":"adab22047f9bb868","name":"Extract RGB from entity and divive each value by 255 (clouds)","func":"var rgb_value = msg.payload.replace(\"\\(\",\"\").replace(\"\\)\",\"\");\nconst color_array = rgb_value.split(\", \");\nvar RV = (color_array[0]  / 255);\nvar GV = (color_array[1]  / 255);\nvar BV = (color_array[2]  / 255);\n\nvar RVT = RV.toString().substring(0, 3);\nvar GVT = GV.toString().substring(0, 3);\nvar BVT = BV.toString().substring(0, 3);\n\nvar msg = {\n    \"payload\": {\n        \"data\": {\n            \"topic\": \"homeassistant/button/PC_Maxi_Desktop/Maxi_pc_customcommand/action\",\n            \"payload\": \"%wpe% -control applyProperties -properties RAW~\\(\\{\\\"clouds\\\":\\\"\" + RVT + \" \" + GVT + \" \" + BVT + \"\\\"\\}\\)~END\"\n        }\n    }\n\n}\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":690,"y":1620,"wires":[["33fb7eb23860d614"]]},{"id":"33fb7eb23860d614","type":"api-call-service","z":"adab22047f9bb868","name":"Send MQTT Command","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"mqtt","service":"publish","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1130,"y":1620,"wires":[[]]},{"id":"092076324bb163c4","type":"comment","z":"adab22047f9bb868","name":"Blind control","info":"","x":170,"y":460,"wires":[]},{"id":"c894ba32dd15aa7c","type":"debug","z":"adab22047f9bb868","name":"debug 266","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1250,"y":1380,"wires":[]},{"id":"6489528ebe54bdd8","type":"comment","z":"adab22047f9bb868","name":"Set Wallpaper engine colors to match the lights","info":"","x":240,"y":1500,"wires":[]},{"id":"6305951b9f436579","type":"switch","z":"adab22047f9bb868","name":"Not plex","property":"data.new_state.attributes.app_name","propertyType":"msg","rules":[{"t":"neq","v":"Plex","vt":"str"}],"checkall":"false","repair":false,"outputs":1,"x":440,"y":300,"wires":[["5cdf0ad8625565cf"]]},{"id":"49f9229639ad2a95","type":"comment","z":"adab22047f9bb868","name":"Confirm music is not from plex","info":"","x":440,"y":260,"wires":[]},{"id":"a1389c5da89d1a3f","type":"mqtt in","z":"f8abdd9653af834e","name":"","topic":"zigbee2mqtt/remote_chillingroom_dial","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":250,"y":120,"wires":[["7424c9541dd2882a"]]},{"id":"7424c9541dd2882a","type":"subflow:61f53235c712b2c2","z":"f8abdd9653af834e","name":"","x":550,"y":120,"wires":[]},{"id":"adf3d5e1856c236a","type":"api-call-service","z":"f8abdd9653af834e","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1150,"y":240,"wires":[[]]},{"id":"09d4d190f43c37b5","type":"comment","z":"f8abdd9653af834e","name":"Select color, brightness and set entity_id","info":"","x":780,"y":200,"wires":[]},{"id":"1ef15165eb3f949b","type":"comment","z":"f8abdd9653af834e","name":"Turn the lights on","info":"","x":1140,"y":200,"wires":[]},{"id":"4ff95a5111ec8084","type":"function","z":"f8abdd9653af834e","name":"effect selector new","func":"var d = new Date();\nvar h = d.getHours();\nvar effects_list = msg.data.new_state.attributes.effect_list\nvar effect = \"test\"\n\nvar r = Math.floor(Math.random() * effects_list.length );\nvar effect = effects_list[r];\n\n\n\n\n\n\n\nif (h > 22){\n    var brightness_percentage = \"45\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness_percentage = \"35\";\n}\nelse if (h > 2 && h<8){\n    var brightness_percentage = \"20\";\n}\nelse if (h >= 8 && h<9){\n    var brightness_percentage = \"30\";\n}\nelse{\n    var brightness_percentage = \"100\";\n}\nmsg=\n{\n    \"payload\":{\n        \"data\": {\n        \"entity_id\": msg.data.entity_id,\n        \"brightness_pct\": brightness_percentage,\n        \"effect\":  effect\n    }\n    }\n}\nreturn msg;","outputs":1,"noerr":1,"initialize":"","finalize":"","libs":[],"x":770,"y":240,"wires":[["bf81e69c2972b1f4"]]},{"id":"96edde8d3ac4b121","type":"server-state-changed","z":"f8abdd9653af834e","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"light.chillingroom_christmas_tree_light","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":300,"y":240,"wires":[["9b28eff28ebee678"],[]]},{"id":"490b9a310e45b569","type":"api-call-service","z":"f8abdd9653af834e","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1150,"y":340,"wires":[[]]},{"id":"2cb09ae75c3df873","type":"comment","z":"f8abdd9653af834e","name":"Select color, brightness and set entity_id","info":"","x":780,"y":300,"wires":[]},{"id":"9bcdac6cb2f99ce0","type":"comment","z":"f8abdd9653af834e","name":"Turn the lights on","info":"","x":1140,"y":300,"wires":[]},{"id":"8abcf914f5cd4f9f","type":"function","z":"f8abdd9653af834e","name":"effect selector new","func":"var d = new Date();\nvar h = d.getHours();\nvar effects_list = msg.data.new_state.attributes.effect_list\nvar effect = \"test\"\n\nvar r = Math.floor(Math.random() * effects_list.length );\nvar effect = effects_list[r];\n\n\n\n\n\n\n\nif (h > 22){\n    var brightness_percentage = \"45\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness_percentage = \"35\";\n}\nelse if (h > 2 && h<8){\n    var brightness_percentage = \"20\";\n}\nelse if (h >= 8 && h<9){\n    var brightness_percentage = \"30\";\n}\nelse{\n    var brightness_percentage = \"100\";\n}\nmsg=\n{\n    \"payload\":{\n        \"data\": {\n        \"entity_id\": msg.data.entity_id,\n        \"brightness_pct\": brightness_percentage,\n        \"effect\":  effect\n    }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":770,"y":340,"wires":[["71fabfca7b4822f8"]]},{"id":"2cece51dd3ae642a","type":"server-state-changed","z":"f8abdd9653af834e","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"light.chillingroom_colo_light","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":270,"y":340,"wires":[["d94be274450d8367"],[]]},{"id":"9a6e88f702799584","type":"comment","z":"f8abdd9653af834e","name":"Set a random effect on the tree","info":"","x":230,"y":200,"wires":[]},{"id":"168ff1bde66c6b7a","type":"comment","z":"f8abdd9653af834e","name":"Set a random effect on the cololight","info":"","x":240,"y":300,"wires":[]},{"id":"9b46083f08e3fac2","type":"api-call-service","z":"f8abdd9653af834e","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1290,"y":460,"wires":[[]]},{"id":"f8cd4c0f72c699f1","type":"comment","z":"f8abdd9653af834e","name":"Select color, brightness and set entity_id","info":"","x":1020,"y":420,"wires":[]},{"id":"2097e88b4a3f0e3d","type":"comment","z":"f8abdd9653af834e","name":"Turn the lights on","info":"","x":1280,"y":420,"wires":[]},{"id":"d9b8226e94a54df0","type":"function","z":"f8abdd9653af834e","name":"effect selector new","func":"var d = new Date();\nvar h = d.getHours();\nvar effects_list = msg.data.attributes.effect_list\nvar effect = \"test\"\n\nvar r = Math.floor(Math.random() * effects_list.length );\nvar effect = effects_list[r];\n\n\n\n\n\n\n\nif (h > 22){\n    var brightness_percentage = \"45\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness_percentage = \"35\";\n}\nelse if (h > 2 && h<8){\n    var brightness_percentage = \"20\";\n}\nelse if (h >= 8 && h<9){\n    var brightness_percentage = \"30\";\n}\nelse{\n    var brightness_percentage = \"100\";\n}\nmsg=\n{\n    \"payload\":{\n        \"data\": {\n        \"entity_id\": msg.data.entity_id,\n        \"brightness_pct\": brightness_percentage,\n        \"effect\":  effect\n    }\n    }\n}\nreturn msg;","outputs":1,"noerr":1,"initialize":"","finalize":"","libs":[],"x":1010,"y":460,"wires":[["c6974bf09065ad1b"]]},{"id":"4dec68fca9c0e7fc","type":"comment","z":"f8abdd9653af834e","name":"Set a random effect on the portal","info":"","x":250,"y":420,"wires":[]},{"id":"280f13288d33a037","type":"api-call-service","z":"f8abdd9653af834e","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"select","service":"select_option","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1290,"y":560,"wires":[[]]},{"id":"4f294213ae8f6b0e","type":"comment","z":"f8abdd9653af834e","name":"Select effect and entity","info":"","x":1020,"y":520,"wires":[]},{"id":"8cdf0ed35a484380","type":"comment","z":"f8abdd9653af834e","name":"Select the option","info":"","x":1280,"y":520,"wires":[]},{"id":"f12e9a8ae227ef62","type":"function","z":"f8abdd9653af834e","name":"effect selector new","func":"var d = new Date();\nvar h = d.getHours();\nvar effects_list = msg.data.attributes.options\nvar effect = \"test\"\n\nvar r = Math.floor(Math.random() * effects_list.length );\nvar effect = effects_list[r];\n\nmsg=\n{\n    \"payload\":{\n        \"data\": {\n        \"entity_id\": msg.data.entity_id,\n        \"option\":  effect\n    }\n    }\n}\nreturn msg;","outputs":1,"timeout":"","noerr":1,"initialize":"","finalize":"","libs":[],"x":1030,"y":560,"wires":[["248f5773e4a02c07"]]},{"id":"56ec137d4ad5d14a","type":"comment","z":"f8abdd9653af834e","name":"Set a random color scheme on the portal","info":"","x":280,"y":520,"wires":[]},{"id":"ecbe801dcf8a6066","type":"api-current-state","z":"f8abdd9653af834e","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"select.office_portal_color_palette","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":700,"y":560,"wires":[["f12e9a8ae227ef62"]]},{"id":"494b64b4e4b2c984","type":"comment","z":"f8abdd9653af834e","name":"Pull Color palette list","info":"","x":710,"y":520,"wires":[]},{"id":"7d246753e457bccc","type":"server-state-changed","z":"f8abdd9653af834e","name":"Moiton in portal?","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.sensor_office_portal_motion_occupancy","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":200,"y":460,"wires":[["1591f4d60cf4df73"],[]]},{"id":"3e743ae6793d2b1c","type":"server-state-changed","z":"f8abdd9653af834e","name":"Moiton in portal?","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.sensor_office_portal_motion_occupancy","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":200,"y":560,"wires":[["9ba8dcc52f86b691"],[]]},{"id":"1591f4d60cf4df73","type":"api-current-state","z":"f8abdd9653af834e","name":"Light state ","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.office_portal_leds","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":690,"y":460,"wires":[["8efeba14eb8c4130"]]},{"id":"2f93a297b1dd9325","type":"comment","z":"f8abdd9653af834e","name":"Pull effect list","info":"","x":690,"y":420,"wires":[]},{"id":"3a9e1453adabcfd6","type":"server-state-changed","z":"9c255342f7ba0458","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.sleeper_in_closet","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":280,"y":240,"wires":[["e0187031691c94c7"],["88760d0fa7d9789a"]]},{"id":"e0187031691c94c7","type":"api-call-service","z":"9c255342f7ba0458","name":"Mute hallway speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":["media_player.hallway_speaker"],"data":"{\"is_volume_muted\": \"true\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":580,"y":220,"wires":[[]]},{"id":"88760d0fa7d9789a","type":"api-call-service","z":"9c255342f7ba0458","name":"Unmute hallway  speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":["media_player.hallway_speaker"],"data":"{\"is_volume_muted\": \"false\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":590,"y":280,"wires":[[]]},{"id":"a507dfb38dc7120e","type":"comment","z":"9c255342f7ba0458","name":"Mute hallway speaker if someone is sleeping","info":"","x":270,"y":200,"wires":[]},{"id":"7be54e15c925e089","type":"comment","z":"9c255342f7ba0458","name":"Mute the hallway speaker","info":"","x":590,"y":180,"wires":[]},{"id":"66bd1c68a56e3f5a","type":"comment","z":"9c255342f7ba0458","name":"Unmute the hallway speaker","info":"","x":600,"y":320,"wires":[]},{"id":"75f9fd7ea23b3ab5","type":"server-state-changed","z":"9c255342f7ba0458","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sensor.closet_lights_brightness","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":280,"y":500,"wires":[["a0998379eaec659d"]]},{"id":"0e7f0da92345edcc","type":"api-call-service","z":"9c255342f7ba0458","name":"change brightness","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"number","service":"set_value","areaId":[],"deviceId":[],"entityId":["number.samsung_galaxy_tab_e_8_0_screen_brightness"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"sentdata","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1090,"y":500,"wires":[[]]},{"id":"aaf9a4b2759a713b","type":"comment","z":"9c255342f7ba0458","name":"Set tablet brightness at the same level as the lights","info":"","x":290,"y":460,"wires":[]},{"id":"2a03197f55179d0b","type":"comment","z":"9c255342f7ba0458","name":"set brightness as payload","info":"","x":650,"y":460,"wires":[]},{"id":"c8ec157336e2b0f4","type":"comment","z":"9c255342f7ba0458","name":"Apply brightness","info":"","x":1060,"y":460,"wires":[]},{"id":"6dc3b93157f4eee7","type":"trigger-state","z":"9c255342f7ba0458","name":"","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.sensor_closet_motion_occupancy","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"},{"targetType":"this_entity","targetValue":"","propertyType":"previous_state","propertyValue":"old_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":300,"y":860,"wires":[["1a50a5bcb3806d32"],[]]},{"id":"1a50a5bcb3806d32","type":"function","z":"9c255342f7ba0458","name":"Extract room from motion sensor entity an extract off lights to regex","func":"var motion_entity_id = msg.data.event.new_state.entity_id; // binary_sensor.sensor_bedroom_motion_occupancy\nvar motion_entity_id_split = motion_entity_id.split(\".\");// split on the dot to separate domain and entity\nvar motion_entity_id_wihtout_binary = motion_entity_id_split[1].replace(\"sensor_\", \"\").replace(\"_motion\", \"\").replace(\"_fp1\", \"\").replace(\"_presence\", \"\").replace(\"_occupancy\", \"\").replace(\"_entry\", \"\").replace(\"_exit\", \"\");// remove sensor_ and more substrings\nvar regex = \"^light\\\\.(?!.*?group.*?)(?!.*?notification.*?)(?!.*?lights.*?).*\" + motion_entity_id_wihtout_binary + \".*\"; \nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': regex ,  'valueType': 're' },{ 'property': 'state' ,  'logic': 'is_not' , 'value': \"on\" ,  'valueType': 'str' }];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object},\"room\": motion_entity_id_wihtout_binary\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1020,"y":860,"wires":[["939672c601e325f3"]]},{"id":"939672c601e325f3","type":"ha-get-entities","z":"9c255342f7ba0458","name":"Get entities","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload.results","output_results_count":1,"x":1390,"y":860,"wires":[["81d70bbdf9741db6"]]},{"id":"aaa91d0350ae7f32","type":"function","z":"9c255342f7ba0458","name":"Brightness selector","func":"var d = new Date();\nvar h = d.getHours();\n\n\n\n\nif (h > 22){\n    var brightness_percentage = \"85\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness_percentage = \"75\";\n}\nelse if (h > 2 && h<8){\n    var brightness_percentage = \"50\";\n}\nelse if (h >= 8 && h<9){\n    var brightness_percentage = \"60\";\n}\nelse{\n    var brightness_percentage = \"100\";\n}\nmsg=\n{\n    \"payload\":{\n        \"data\": {\n        \"entity_id\": msg.payload.entity_id,\n        \"brightness_pct\": brightness_percentage,\n        \"color_name\":  \"white\"\n    }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3910,"y":840,"wires":[["8ff719e071b839ef"]]},{"id":"29dc8fa9b86b33d0","type":"api-call-service","z":"9c255342f7ba0458","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4350,"y":860,"wires":[[]]},{"id":"fcac50d12c96b39b","type":"function","z":"9c255342f7ba0458","name":"Extract room from sleeper sensor entity","func":"var room = msg.room\nvar regex = \"sleeper_in_\" + room; \nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': regex ,  'valueType': 're' },{ 'property': 'state' ,  'logic': 'is' , 'value': \"on\" ,  'valueType': 'str' }];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object},\n    \"entity\": msg.entity\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1960,"y":860,"wires":[["971b96c9a8f67a3b"]]},{"id":"971b96c9a8f67a3b","type":"ha-get-entities","z":"9c255342f7ba0458","name":"Get entities","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"array","output_empty_results":true,"output_location_type":"msg","output_location":"payload.results","output_results_count":1,"x":2270,"y":860,"wires":[["dbd59e8b7b45edda"]]},{"id":"9de1925e2f2f9122","type":"change","z":"9c255342f7ba0458","name":"rules","rules":[{"t":"move","p":"entity","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2830,"y":860,"wires":[["756c3fd176449cfe","8faf8c0ae225dd52"]]},{"id":"81d70bbdf9741db6","type":"change","z":"9c255342f7ba0458","name":"rules","rules":[{"t":"move","p":"payload","pt":"msg","to":"entity","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1630,"y":860,"wires":[["fcac50d12c96b39b"]]},{"id":"dbd59e8b7b45edda","type":"switch","z":"9c255342f7ba0458","name":"","property":"payload.results","propertyType":"msg","rules":[{"t":"empty"}],"checkall":"true","repair":false,"outputs":1,"x":2590,"y":860,"wires":[["9de1925e2f2f9122"]]},{"id":"d2a71d4908f3ce56","type":"comment","z":"9c255342f7ba0458","name":"Detect motion across ocupancy sensors","info":"","x":230,"y":820,"wires":[]},{"id":"456d75bd167eea94","type":"comment","z":"9c255342f7ba0458","name":"Generate the regex for the get entity node","info":"","x":1020,"y":820,"wires":[]},{"id":"d85b18b6bfa5c379","type":"comment","z":"9c255342f7ba0458","name":"Get off light entities","info":"","x":1390,"y":820,"wires":[]},{"id":"340dbe17962dfb2c","type":"comment","z":"9c255342f7ba0458","name":"Move payload to entity","info":"","x":1620,"y":820,"wires":[]},{"id":"670a19861b265e4d","type":"comment","z":"9c255342f7ba0458","name":"Prepare regex to check if someone is sleeping in the room","info":"","x":1970,"y":820,"wires":[]},{"id":"3d97f491cf18f552","type":"comment","z":"9c255342f7ba0458","name":"Get sleeper entities in an array","info":"","x":2310,"y":820,"wires":[]},{"id":"dfee70f77fd32876","type":"comment","z":"9c255342f7ba0458","name":"Make sure the array is empty","info":"","x":2580,"y":820,"wires":[]},{"id":"247d63ee88333762","type":"comment","z":"9c255342f7ba0458","name":"Move entity to payload","info":"","x":2820,"y":820,"wires":[]},{"id":"c798949c4a3296da","type":"comment","z":"9c255342f7ba0458","name":"Select color, brightness and set entity_id","info":"","x":3920,"y":800,"wires":[]},{"id":"cccad8a3bdd93628","type":"comment","z":"9c255342f7ba0458","name":"Turn the lights on","info":"","x":4340,"y":820,"wires":[]},{"id":"40be8c7613a4b78c","type":"api-current-state","z":"9c255342f7ba0458","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.all_present_sleeping","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3590,"y":840,"wires":[["aaa91d0350ae7f32","2397a6d2a295233b"],["b893a8e9bc32fc6f"]]},{"id":"259aa990286922dd","type":"function","z":"9c255342f7ba0458","name":"Effect selector","func":"var d = new Date();\nvar h = d.getHours();\nvar effects_list = msg.payload.attributes.effect_list\n\nvar r = Math.floor(Math.random() * effects_list.length );\nvar effect = effects_list[r];\n\n\n\n\n\n\nif (h > 22){\n    var brightness_percentage = \"45\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness_percentage = \"35\";\n}\nelse if (h > 2 && h<8){\n    var brightness_percentage = \"20\";\n}\nelse if (h >= 8 && h<9){\n    var brightness_percentage = \"30\";\n}\nelse{\n    var brightness_percentage = \"100\";\n}\nmsg=\n{\n    \"payload\":{\n        \"data\": {\n        \"entity_id\": msg.payload.entity_id,\n        \"brightness_pct\": brightness_percentage,\n        \"effect\":  effect\n    }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3900,"y":920,"wires":[["8ff719e071b839ef"]]},{"id":"06b35f203544cf83","type":"comment","z":"9c255342f7ba0458","name":"Check if all are sleeping","info":"","x":3540,"y":800,"wires":[]},{"id":"756c3fd176449cfe","type":"api-current-state","z":"9c255342f7ba0458","name":"Acid time","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.acid_time","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3140,"y":860,"wires":[["812e001d0a31927c"],["a8d6b266991a537a"]]},{"id":"2397a6d2a295233b","type":"debug","z":"9c255342f7ba0458","name":"debug 136","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3890,"y":660,"wires":[]},{"id":"8faf8c0ae225dd52","type":"debug","z":"9c255342f7ba0458","name":"debug 137","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3050,"y":780,"wires":[]},{"id":"812e001d0a31927c","type":"api-current-state","z":"9c255342f7ba0458","name":"Party time","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.acid_time","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3300,"y":840,"wires":[["40be8c7613a4b78c"],["9ee2a54ef22ef8f7"]]},{"id":"b893a8e9bc32fc6f","type":"function","z":"9c255342f7ba0458","name":"Brightness selector","func":"var d = new Date();\nvar h = d.getHours();\n\n\n\n\nif (h > 22){\n    var brightness_percentage = \"45\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness_percentage = \"35\";\n}\nelse if (h > 2 && h<8){\n    var brightness_percentage = \"20\";\n}\nelse if (h >= 8 && h<9){\n    var brightness_percentage = \"30\";\n}\nelse{\n    var brightness_percentage = \"100\";\n}\nmsg=\n{\n    \"payload\":{\n        \"data\": {\n        \"entity_id\": msg.payload.entity_id,\n        \"brightness_pct\": brightness_percentage,\n        \"color_name\":  \"white\"\n    }\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3910,"y":880,"wires":[[]]},{"id":"6de4d10c953dab87","type":"function","z":"9c255342f7ba0458","name":"JS","func":"var old_color = msg.data.old_state.attributes.rgb_color;\nvar new_color = msg.data.new_state.attributes.rgb_color;\nvar old_brightness = msg.data.old_state.attributes.brightness;\nvar new_brightness = msg.data.new_state.attributes.brightness;\n\nif (old_color[0] != new_color[0] && old_color[1] != new_color[1] && old_color[2] != new_color[2] && old_brightness < new_brightness){\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"brightness\": old_brightness\n        }\n    }\n};\n} else if ((old_color[0]+old_color[1]+old_color[2]) != (new_color[0] + new_color[1] + new_color[2]) && old_brightness < new_brightness){\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"brightness\": old_brightness\n        }\n    }\n};\n} else {\nvar newMsg = {\n    \"payload\": {\n        \"bugged\": { }\n    }\n};\n}\n\nreturn newMsg;\n\n\n//Current bug:\n// If a similar color is used, it does not work\n//\n//","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":970,"y":720,"wires":[[]]},{"id":"1d34d1ac275573a6","type":"comment","z":"9c255342f7ba0458","name":"JS Magic to detect a color change and extract previous brightness","info":"","x":970,"y":680,"wires":[]},{"id":"a0998379eaec659d","type":"change","z":"9c255342f7ba0458","name":"","rules":[{"t":"move","p":"payload","pt":"msg","to":"payload.data.value","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":650,"y":500,"wires":[["e465fd565a8ea9d6"]]},{"id":"e465fd565a8ea9d6","type":"trigger","z":"9c255342f7ba0458","name":"","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"100","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":880,"y":500,"wires":[["0e7f0da92345edcc"]]},{"id":"82d84d5b9d5e02b6","type":"server-state-changed","z":"9c255342f7ba0458","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.sleeper_in_closet","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"2","forType":"num","forUnits":"seconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":320,"y":1480,"wires":[["49011b47e3a9b594"],["298147f466bd6bf5"]]},{"id":"49011b47e3a9b594","type":"api-call-service","z":"9c255342f7ba0458","name":"Turn off tablet screen","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_off","areaId":[],"deviceId":[],"entityId":["switch.samsung_galaxy_tab_e_8_0_screen"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":620,"y":1460,"wires":[[]]},{"id":"298147f466bd6bf5","type":"api-call-service","z":"9c255342f7ba0458","name":"Turn on tablet screen","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_on","areaId":[],"deviceId":[],"entityId":["switch.samsung_galaxy_tab_e_8_0_screen"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":620,"y":1520,"wires":[[]]},{"id":"a0592a995a4a1c4c","type":"comment","z":"9c255342f7ba0458","name":"Detect \"Sleeper in closet\" on","info":"","x":260,"y":1440,"wires":[]},{"id":"73c3a95b7522cc4b","type":"comment","z":"9c255342f7ba0458","name":"Turn off tablet screen","info":"","x":630,"y":1420,"wires":[]},{"id":"6316d959b5e1b2f4","type":"comment","z":"9c255342f7ba0458","name":"Turn on tablet screen","info":"","x":620,"y":1560,"wires":[]},{"id":"f67a8d01e32f362c","type":"server-state-changed","z":"9c255342f7ba0458","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.sleeper_in_closet","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"seconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":300,"y":1160,"wires":[["7b391a1b74b5d0fc"],["161e75e61d205626"]]},{"id":"7b391a1b74b5d0fc","type":"api-call-service","z":"9c255342f7ba0458","name":"Turn off lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.group_closet_lights"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":580,"y":1140,"wires":[["bda32b6dd10c01da"]]},{"id":"c79bafaa6f2ae550","type":"comment","z":"9c255342f7ba0458","name":"Detect \"Sleeper in closet\" on","info":"","x":240,"y":1120,"wires":[]},{"id":"161e75e61d205626","type":"api-call-service","z":"9c255342f7ba0458","name":"Turn on lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.group_closet_lights"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":580,"y":1200,"wires":[[]]},{"id":"a8cf218cd87d6cf7","type":"api-call-service","z":"9c255342f7ba0458","name":"Toggle Sleeper in closet bool","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"toggle","areaId":[],"deviceId":[],"entityId":["input_boolean.sleeper_in_closet"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":740,"y":1820,"wires":[[]]},{"id":"4fe2e6ec4a529d16","type":"comment","z":"9c255342f7ba0458","name":"Toggle the \"sleeper in hotbox\" boolean","info":"","x":750,"y":1780,"wires":[]},{"id":"1b05f8f6240505de","type":"comment","z":"9c255342f7ba0458","name":"Single press on closet dial","info":"","x":230,"y":1780,"wires":[]},{"id":"ef04b9b1117ebd75","type":"switch","z":"9c255342f7ba0458","name":"","property":"payload.action","propertyType":"msg","rules":[{"t":"eq","v":"toggle","vt":"str"}],"checkall":"false","repair":false,"outputs":1,"x":470,"y":1820,"wires":[["a8cf218cd87d6cf7"]]},{"id":"e812ea09b1f216c2","type":"mqtt in","z":"9c255342f7ba0458","name":"","topic":"zigbee2mqtt/remote_closet_dial","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":250,"y":1820,"wires":[["ef04b9b1117ebd75"]]},{"id":"e4934924eebbae47","type":"api-call-service","z":"9c255342f7ba0458","name":"Dim light","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.group_closet_lights"],"data":"{\"brightness_step_pct\": -10}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1180,"y":2080,"wires":[[]]},{"id":"d18e82ed61468a87","type":"trigger","z":"9c255342f7ba0458","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"-400","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"topic","topic":"topic","outputs":1,"x":900,"y":2000,"wires":[["7c19cec58b265628"]]},{"id":"f9a6809308f5dc89","type":"change","z":"9c255342f7ba0458","name":"set reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"1","tot":"str","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":680,"y":2040,"wires":[["d18e82ed61468a87","0336f2b6caaf7532"]]},{"id":"0336f2b6caaf7532","type":"trigger","z":"9c255342f7ba0458","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"-400","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"topic","topic":"topic","outputs":1,"x":900,"y":2080,"wires":[["e4934924eebbae47"]]},{"id":"bae1322512dcc98f","type":"mqtt in","z":"9c255342f7ba0458","name":"","topic":"zigbee2mqtt/remote_closet_dial","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":250,"y":2040,"wires":[["697f0e411c3c1ec4"]]},{"id":"697f0e411c3c1ec4","type":"switch","z":"9c255342f7ba0458","name":"","property":"payload.action","propertyType":"msg","rules":[{"t":"eq","v":"brightness_move_up","vt":"str"},{"t":"eq","v":"brightness_stop","vt":"str"},{"t":"eq","v":"brightness_move_down","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":510,"y":2040,"wires":[["d18e82ed61468a87"],["f9a6809308f5dc89"],["0336f2b6caaf7532"]]},{"id":"7c19cec58b265628","type":"api-call-service","z":"9c255342f7ba0458","name":"Raise light","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.group_closet_lights"],"data":"{\"brightness_step_pct\": 10}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1190,"y":2000,"wires":[[]]},{"id":"ad4b0e21c924a872","type":"comment","z":"9c255342f7ba0458","name":"Rotations on closet dial","info":"","x":260,"y":2000,"wires":[]},{"id":"7254cab5dbeee34c","type":"comment","z":"9c255342f7ba0458","name":"Rotations on closet dial","info":"","x":520,"y":1980,"wires":[]},{"id":"b914053697a3b5d1","type":"comment","z":"9c255342f7ba0458","name":"Only let \"Toggle\" through","info":"","x":470,"y":1780,"wires":[]},{"id":"8789f9e140f9de03","type":"comment","z":"9c255342f7ba0458","name":"### HANDLE CLOSET SLEEPER BOOL ###","info":"","x":310,"y":1740,"wires":[]},{"id":"e4a9038ee615f81f","type":"comment","z":"9c255342f7ba0458","name":"Raise the lights","info":"","x":1200,"y":1960,"wires":[]},{"id":"e54d197e34980b53","type":"comment","z":"9c255342f7ba0458","name":"Dim the lights","info":"","x":1190,"y":2120,"wires":[]},{"id":"0184b428f65e8376","type":"comment","z":"9c255342f7ba0458","name":"Repeat until rotate_stop is present","info":"","x":920,"y":2040,"wires":[]},{"id":"bda32b6dd10c01da","type":"api-call-service","z":"9c255342f7ba0458","name":"Turn off lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.closet_string_1","light.closet_string_2"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":780,"y":1140,"wires":[[]]},{"id":"c2878a9bae6e1f8e","type":"server-state-changed","z":"5d4e860e6cd2bc1e","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"sensor.sensor_stove_temperature_humidity","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"75","ifStateType":"num","ifStateOperator":"gt","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":240,"y":200,"wires":[["693dc3a435eb60fe"],[]]},{"id":"92f70a09c5c89b9a","type":"api-current-state","z":"5d4e860e6cd2bc1e","name":"Is the kitchen occupied?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_kitchen_motion_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1130,"y":200,"wires":[["72a594d88c84876d"],[]]},{"id":"72a594d88c84876d","type":"trigger","z":"5d4e860e6cd2bc1e","name":"","op1":"1","op2":"1","op1type":"num","op2type":"str","duration":"-4","extend":false,"overrideDelay":false,"units":"min","reset":"on","bytopic":"all","topic":"topic","outputs":1,"x":1510,"y":200,"wires":[["49537f41c5b2b367"]]},{"id":"92c99f0b98c7f597","type":"server-state-changed","z":"5d4e860e6cd2bc1e","name":"Motion in kitchen","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.sensor_kitchen_motion_occupancy","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":1160,"y":260,"wires":[["6c667b04c18e0b33"],[]]},{"id":"49537f41c5b2b367","type":"change","z":"5d4e860e6cd2bc1e","name":"Set Message and color","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"The Water is Boiling","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1780,"y":200,"wires":[["d7d0ad481cee7d90"]]},{"id":"693dc3a435eb60fe","type":"change","z":"5d4e860e6cd2bc1e","name":"On","rules":[{"t":"set","p":"payload","pt":"msg","to":"on","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":670,"y":200,"wires":[["1bb2647d50b338de"]]},{"id":"1bb2647d50b338de","type":"trigger","z":"5d4e860e6cd2bc1e","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"20","extend":false,"overrideDelay":false,"units":"min","reset":"0","bytopic":"all","topic":"topic","outputs":1,"x":890,"y":200,"wires":[["92f70a09c5c89b9a"]]},{"id":"d7d0ad481cee7d90","type":"subflow:233ac7dcd801a802","z":"5d4e860e6cd2bc1e","name":"","x":2020,"y":200,"wires":[]},{"id":"18816de5322a0ad2","type":"comment","z":"5d4e860e6cd2bc1e","name":"Is the humidity over 75% ?","info":"","x":230,"y":160,"wires":[]},{"id":"87d1696962c7913a","type":"comment","z":"5d4e860e6cd2bc1e","name":"Alert house-wide when the pasta water is boiling","info":"","x":200,"y":120,"wires":[]},{"id":"970ea7422c84dd0a","type":"comment","z":"5d4e860e6cd2bc1e","name":"yes","info":"","x":530,"y":200,"wires":[]},{"id":"e0ddeb04c9a2725a","type":"comment","z":"5d4e860e6cd2bc1e","name":"Set Payload to \"On\"","info":"","x":670,"y":160,"wires":[]},{"id":"cfa5c1d77626f30c","type":"comment","z":"5d4e860e6cd2bc1e","name":"20 minutes anti-spam","info":"","x":900,"y":160,"wires":[]},{"id":"65a2fc28ec608be4","type":"comment","z":"5d4e860e6cd2bc1e","name":"No","info":"","x":1310,"y":200,"wires":[]},{"id":"2869586af4e1f9a6","type":"comment","z":"5d4e860e6cd2bc1e","name":"Is the kitchen occupied?","info":"","x":1120,"y":160,"wires":[]},{"id":"ec3acf776197f090","type":"comment","z":"5d4e860e6cd2bc1e","name":"Resend the alert every 5 minutes","info":"","x":1510,"y":160,"wires":[]},{"id":"5b0404e1dfab2f6b","type":"comment","z":"5d4e860e6cd2bc1e","name":"Stop when the kitchen has motion","info":"","x":1510,"y":240,"wires":[]},{"id":"ca7b129922fab83c","type":"comment","z":"5d4e860e6cd2bc1e","name":"Set alert Message","info":"","x":1790,"y":160,"wires":[]},{"id":"0185f27e6267c862","type":"comment","z":"5d4e860e6cd2bc1e","name":"Broadcast Alert","info":"","x":2000,"y":160,"wires":[]},{"id":"fb2e5e49c0598f0f","type":"api-current-state","z":"5d4e860e6cd2bc1e","name":"Is the kitchen occupied?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_kitchen_motion_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1770,"y":2800,"wires":[["8628ef491109f67c"],["a4165723d67e441d"]]},{"id":"8628ef491109f67c","type":"trigger","z":"5d4e860e6cd2bc1e","name":"","op1":"1","op2":"1","op1type":"num","op2type":"str","duration":"-5","extend":false,"overrideDelay":false,"units":"min","reset":"on","bytopic":"all","topic":"topic","outputs":1,"x":2230,"y":2800,"wires":[["4a6452f20f6df5de"]]},{"id":"be8daa080b81890a","type":"server-state-changed","z":"5d4e860e6cd2bc1e","name":"Motion in kitchen","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.sensor_kitchen_motion_occupancy","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":1940,"y":2760,"wires":[["fba35d3bdbb3a641"],[]]},{"id":"4a6452f20f6df5de","type":"change","z":"5d4e860e6cd2bc1e","name":"Set Message and color","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"Microwave Finished","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2500,"y":2800,"wires":[["1f85692114ea2aff"]]},{"id":"68d15eb5cc5a2ef8","type":"change","z":"5d4e860e6cd2bc1e","name":"On","rules":[{"t":"set","p":"payload","pt":"msg","to":"on","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1370,"y":2800,"wires":[["8d02ea742866f780"]]},{"id":"1f85692114ea2aff","type":"subflow:233ac7dcd801a802","z":"5d4e860e6cd2bc1e","name":"","x":2730,"y":2840,"wires":[]},{"id":"a6bc04588b3bf5b0","type":"comment","z":"5d4e860e6cd2bc1e","name":"Power usage over 100W?","info":"","x":790,"y":2760,"wires":[]},{"id":"8a53e3def40eb30f","type":"comment","z":"5d4e860e6cd2bc1e","name":"Alert house-wide when the microwave has finished","info":"","x":770,"y":2700,"wires":[]},{"id":"774c4a840ea52320","type":"comment","z":"5d4e860e6cd2bc1e","name":"Set Payload to \"On\"","info":"","x":1370,"y":2760,"wires":[]},{"id":"0ac8f4593c4fb39b","type":"comment","z":"5d4e860e6cd2bc1e","name":"No","info":"","x":2030,"y":2800,"wires":[]},{"id":"4bc8a677824561c9","type":"comment","z":"5d4e860e6cd2bc1e","name":"Is the kitchen occupied?","info":"","x":1780,"y":2880,"wires":[]},{"id":"ac27af1f4f15f03a","type":"comment","z":"5d4e860e6cd2bc1e","name":"Resend the alert every 5 minutes","info":"","x":2230,"y":2720,"wires":[]},{"id":"c0d41de7d389c9e0","type":"comment","z":"5d4e860e6cd2bc1e","name":"Stop when the kitchen has motion","info":"","x":2230,"y":2760,"wires":[]},{"id":"e2b1eea66fa2f8cc","type":"comment","z":"5d4e860e6cd2bc1e","name":"Set alert Message","info":"","x":2510,"y":2760,"wires":[]},{"id":"bd2ab23da4d5b7d7","type":"comment","z":"5d4e860e6cd2bc1e","name":"Broadcast Alert","info":"","x":2720,"y":2800,"wires":[]},{"id":"1bf56e1e4e3c69eb","type":"server-state-changed","z":"5d4e860e6cd2bc1e","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.power_switch_electric_consumption_w_4","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"100","halt_if_type":"num","halt_if_compare":"gt","output_only_on_state_change":true,"x":810,"y":2800,"wires":[["ac71b831c151155b"],[]]},{"id":"ac71b831c151155b","type":"ha-wait-until","z":"5d4e860e6cd2bc1e","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":1,"entityId":"sensor.power_switch_electric_consumption_w_4","entityIdFilterType":"exact","property":"state","comparator":"lt","value":"28","valueType":"num","timeout":"0","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":1160,"y":2800,"wires":[["68d15eb5cc5a2ef8"]]},{"id":"37aaf6e4941c4eb8","type":"comment","z":"5d4e860e6cd2bc1e","name":"Wait until Power goes under 28W","info":"","x":1130,"y":2760,"wires":[]},{"id":"a37355ef9606ec1f","type":"change","z":"5d4e860e6cd2bc1e","name":"Set Message and color","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"Microwave Finished","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2240,"y":2900,"wires":[["f4694759a1bfdc7c"]]},{"id":"07982c2baf15ce0e","type":"comment","z":"5d4e860e6cd2bc1e","name":"Yes","info":"","x":2030,"y":2900,"wires":[]},{"id":"4d4b4d8073447a05","type":"comment","z":"5d4e860e6cd2bc1e","name":"Set alert Message","info":"","x":2230,"y":2860,"wires":[]},{"id":"59966572675a679d","type":"trigger","z":"5d4e860e6cd2bc1e","name":"","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"2","extend":false,"overrideDelay":false,"units":"min","reset":"off","bytopic":"all","topic":"topic","outputs":1,"x":570,"y":460,"wires":[["3c33ddb343c03adf"]]},{"id":"3b1c05e1f3e66d81","type":"change","z":"5d4e860e6cd2bc1e","name":"Set Message and color","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"Fridge door open","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1060,"y":460,"wires":[["a125d87ae63ed166"]]},{"id":"3c33ddb343c03adf","type":"trigger","z":"5d4e860e6cd2bc1e","name":"","op1":"","op2":"1","op1type":"num","op2type":"str","duration":"-5","extend":false,"overrideDelay":false,"units":"min","reset":"off","bytopic":"all","topic":"topic","outputs":1,"x":830,"y":460,"wires":[["3b1c05e1f3e66d81"]]},{"id":"ff4e95e03c3d9cb7","type":"server-state-changed","z":"5d4e860e6cd2bc1e","name":"Door Fridge Open","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.sensor_fridge_door_contact","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"(on|off)","ifStateType":"re","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":110,"y":460,"wires":[["59966572675a679d","621e6f171475a47b"],[]]},{"id":"621e6f171475a47b","type":"switch","z":"5d4e860e6cd2bc1e","name":"Off?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":570,"y":420,"wires":[["3c33ddb343c03adf"]]},{"id":"a125d87ae63ed166","type":"subflow:233ac7dcd801a802","z":"5d4e860e6cd2bc1e","name":"","x":1270,"y":460,"wires":[]},{"id":"46cf96af3acdcfa4","type":"comment","z":"5d4e860e6cd2bc1e","name":"Is the door fridge open?","info":"","x":120,"y":420,"wires":[]},{"id":"1edc30f93a3b97a0","type":"comment","z":"5d4e860e6cd2bc1e","name":"Set alert Message","info":"","x":1050,"y":420,"wires":[]},{"id":"8a350d14821742b1","type":"comment","z":"5d4e860e6cd2bc1e","name":"Broadcast Alert","info":"","x":1260,"y":420,"wires":[]},{"id":"d53f733953c8bd2c","type":"comment","z":"5d4e860e6cd2bc1e","name":"Resend the alert every 5 minutes","info":"","x":830,"y":380,"wires":[]},{"id":"c57bb80177cd0d73","type":"comment","z":"5d4e860e6cd2bc1e","name":"Stop when the door is closed","info":"","x":820,"y":420,"wires":[]},{"id":"593cf1b8ba43aee4","type":"comment","z":"5d4e860e6cd2bc1e","name":"Wait 2 minutes","info":"","x":560,"y":500,"wires":[]},{"id":"a850af78c5e7caf7","type":"comment","z":"5d4e860e6cd2bc1e","name":"Only let \"Off\" through","info":"","x":580,"y":380,"wires":[]},{"id":"1f47893dddc7b288","type":"comment","z":"5d4e860e6cd2bc1e","name":"Alert house-wide when the fridge door is open for 2 minutes","info":"","x":230,"y":380,"wires":[]},{"id":"36692173862c7642","type":"trigger","z":"5d4e860e6cd2bc1e","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"2","extend":false,"overrideDelay":false,"units":"min","reset":"off","bytopic":"all","topic":"topic","outputs":1,"x":570,"y":620,"wires":[["09e7cca47eae8649"]]},{"id":"09e7cca47eae8649","type":"trigger","z":"5d4e860e6cd2bc1e","name":"","op1":"","op2":"1","op1type":"num","op2type":"str","duration":"-5","extend":false,"overrideDelay":false,"units":"min","reset":"off","bytopic":"all","topic":"topic","outputs":1,"x":830,"y":620,"wires":[["dc09bd93d48b0d66"]]},{"id":"e85fda07ac5fc5de","type":"switch","z":"5d4e860e6cd2bc1e","name":"Off?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":570,"y":580,"wires":[["09e7cca47eae8649"]]},{"id":"da6ed73d93e429b1","type":"subflow:233ac7dcd801a802","z":"5d4e860e6cd2bc1e","name":"","x":1270,"y":620,"wires":[]},{"id":"7add5c1496d7adc1","type":"comment","z":"5d4e860e6cd2bc1e","name":"Water Damage In The Kitchen?","info":"","x":150,"y":580,"wires":[]},{"id":"772930d0d3164297","type":"comment","z":"5d4e860e6cd2bc1e","name":"Set alert Message","info":"","x":1050,"y":580,"wires":[]},{"id":"87ef7d08e6be66f8","type":"comment","z":"5d4e860e6cd2bc1e","name":"Broadcast Alert","info":"","x":1260,"y":580,"wires":[]},{"id":"d5499bd4cba9cbe1","type":"comment","z":"5d4e860e6cd2bc1e","name":"Resend the alert every 5 minutes","info":"","x":830,"y":540,"wires":[]},{"id":"2f279374a67994b2","type":"comment","z":"5d4e860e6cd2bc1e","name":"Stop when the water is cleaned","info":"","x":830,"y":580,"wires":[]},{"id":"f22081f22920457b","type":"comment","z":"5d4e860e6cd2bc1e","name":"Wait 2 minutes","info":"","x":560,"y":660,"wires":[]},{"id":"d5b16ea540e7b8f2","type":"comment","z":"5d4e860e6cd2bc1e","name":"Only let \"Off\" through","info":"","x":580,"y":540,"wires":[]},{"id":"2f28b254f40de6ed","type":"comment","z":"5d4e860e6cd2bc1e","name":"Alert house-wide when there is water on the kitchen floor","info":"","x":230,"y":540,"wires":[]},{"id":"dc09bd93d48b0d66","type":"change","z":"5d4e860e6cd2bc1e","name":"Set Message and color","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"Water Damage Detected In The Kitchen","tot":"str"},{"t":"set","p":"color_value","pt":"msg","to":"[0,255,255]","tot":"json"},{"t":"set","p":"dbrightness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1060,"y":620,"wires":[["da6ed73d93e429b1"]]},{"id":"d7e21d1d7930e137","type":"server-state-changed","z":"5d4e860e6cd2bc1e","name":"Water Damage Detected In The Kitchen","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.sensor_kitchen_water_detector_water_leak","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"(on|off)","ifStateType":"re","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":170,"y":620,"wires":[["36692173862c7642","e85fda07ac5fc5de"],[]]},{"id":"725525ea5d669d22","type":"inject","z":"5d4e860e6cd2bc1e","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1160,"y":100,"wires":[[]]},{"id":"e67efe0407b56eec","type":"mqtt in","z":"5d4e860e6cd2bc1e","name":"","topic":"zigbee2mqtt/remote_kitchen_dial","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":170,"y":40,"wires":[["153588ecdd69813f"]]},{"id":"153588ecdd69813f","type":"subflow:61f53235c712b2c2","z":"5d4e860e6cd2bc1e","name":"","x":470,"y":40,"wires":[]},{"id":"8d02ea742866f780","type":"api-current-state","z":"5d4e860e6cd2bc1e","name":"Is someone cooking?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.cooking_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1540,"y":2800,"wires":[["fb2e5e49c0598f0f"],[]]},{"id":"8e4c8719d6744c67","type":"server-state-changed","z":"5d4e860e6cd2bc1e","name":"Cooking timer finished","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"timer.cooking","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"idle","ifStateType":"re","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":140,"y":900,"wires":[["62e02b8826a47e94"],[]]},{"id":"f0f4275625ad2ea7","type":"comment","z":"5d4e860e6cd2bc1e","name":"Cooking timer finished","info":"","x":140,"y":860,"wires":[]},{"id":"399ad88c520b1e7f","type":"api-current-state","z":"5d4e860e6cd2bc1e","name":"Is the kitchen occupied?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_kitchen_motion_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":890,"y":900,"wires":[["fbb4d6c6639c5d27"],[]]},{"id":"fbb4d6c6639c5d27","type":"trigger","z":"5d4e860e6cd2bc1e","name":"","op1":"1","op2":"1","op1type":"num","op2type":"str","duration":"-4","extend":false,"overrideDelay":false,"units":"min","reset":"on","bytopic":"all","topic":"topic","outputs":1,"x":1270,"y":900,"wires":[["24e59035b979247c"]]},{"id":"7ab25e59f52fc929","type":"server-state-changed","z":"5d4e860e6cd2bc1e","name":"Motion in kitchen","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.sensor_kitchen_motion_occupancy","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":920,"y":960,"wires":[["fa0a1f6cff67820b"],[]]},{"id":"24e59035b979247c","type":"change","z":"5d4e860e6cd2bc1e","name":"Set Message and color","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"Cooking timer finished","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1540,"y":900,"wires":[["e468e2255b3ee238"]]},{"id":"62e02b8826a47e94","type":"change","z":"5d4e860e6cd2bc1e","name":"On","rules":[{"t":"set","p":"payload","pt":"msg","to":"on","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":430,"y":900,"wires":[["2e24e13c3957021c"]]},{"id":"2e24e13c3957021c","type":"trigger","z":"5d4e860e6cd2bc1e","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"20","extend":false,"overrideDelay":false,"units":"min","reset":"0","bytopic":"all","topic":"topic","outputs":1,"x":650,"y":900,"wires":[["399ad88c520b1e7f"]]},{"id":"e468e2255b3ee238","type":"subflow:233ac7dcd801a802","z":"5d4e860e6cd2bc1e","name":"","x":1780,"y":900,"wires":[]},{"id":"e84bd6663a5f33a6","type":"comment","z":"5d4e860e6cd2bc1e","name":"Set Payload to \"On\"","info":"","x":430,"y":860,"wires":[]},{"id":"1c5b7f6c34612d45","type":"comment","z":"5d4e860e6cd2bc1e","name":"20 minutes anti-spam","info":"","x":660,"y":860,"wires":[]},{"id":"e01a21ef40d5ae6f","type":"comment","z":"5d4e860e6cd2bc1e","name":"No","info":"","x":1070,"y":900,"wires":[]},{"id":"d906f5174a58170f","type":"comment","z":"5d4e860e6cd2bc1e","name":"Is the kitchen occupied?","info":"","x":880,"y":860,"wires":[]},{"id":"a81e9fba6de24218","type":"comment","z":"5d4e860e6cd2bc1e","name":"Resend the alert every 5 minutes","info":"","x":1270,"y":860,"wires":[]},{"id":"c13a97861666a6fa","type":"comment","z":"5d4e860e6cd2bc1e","name":"Stop when the kitchen has motion","info":"","x":1270,"y":940,"wires":[]},{"id":"65fa0c7b2a311757","type":"comment","z":"5d4e860e6cd2bc1e","name":"Set alert Message","info":"","x":1550,"y":860,"wires":[]},{"id":"80644ef53c411512","type":"comment","z":"5d4e860e6cd2bc1e","name":"Broadcast Alert","info":"","x":1760,"y":860,"wires":[]},{"id":"bbc507634f452175","type":"server-state-changed","z":"5d4e860e6cd2bc1e","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sensor.kitchen_speaker_alarms","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":220,"y":1100,"wires":[["a8ba84c244dc06f1"]]},{"id":"a8ba84c244dc06f1","type":"function","z":"5d4e860e6cd2bc1e","name":"Convert mini alarm to time delta","func":"var time = msg.payload;  // extract time\n\nvar timestamp = Date.parse(time); // set time string to timestamp\nvar now = Date.now(); // get now timestamp\n\nvar finaltemp =  (timestamp - now) / 1000 ;  // get float timestamp\nvar final = Math.round(finaltemp); // remove decimal \n\nconst result = new Date(final * 1000).toISOString().slice(11, 19);\n// ^ convert timestmap to H:M:S: format\n\n\n\nvar newMsg = {\n    \"payload\":{\n        \"data\": {\n        \"duration\": result\n    }\n    \n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":1040,"wires":[["1c8a549876ad74f6"]]},{"id":"1c8a549876ad74f6","type":"api-call-service","z":"5d4e860e6cd2bc1e","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"timer","service":"start","areaId":[],"deviceId":[],"entityId":["timer.cooking"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1200,"y":1040,"wires":[[]]},{"id":"0150388e293cb0c7","type":"server-state-changed","z":"5d4e860e6cd2bc1e","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sensor.kitchen_speaker_timers","entityIdType":"exact","outputInitially":true,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":220,"y":1040,"wires":[["a8ba84c244dc06f1"]]},{"id":"807232d10b942931","type":"comment","z":"5d4e860e6cd2bc1e","name":"Kitchen timer/alarm detected","info":"","x":160,"y":1000,"wires":[]},{"id":"ef2e6c5efc1380dd","type":"comment","z":"5d4e860e6cd2bc1e","name":"JS MAgic to convert alarm to epoch","info":"","x":600,"y":1000,"wires":[]},{"id":"5a8d407e73424412","type":"comment","z":"5d4e860e6cd2bc1e","name":"Set timer","info":"","x":1200,"y":1000,"wires":[]},{"id":"771393b019b74c98","type":"api-current-state","z":"5d4e860e6cd2bc1e","name":"Is the kitchen occupied?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_kitchen_motion_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1790,"y":2540,"wires":[["77595709a7377169"],["a0431ea76e79e916"]]},{"id":"77595709a7377169","type":"trigger","z":"5d4e860e6cd2bc1e","name":"","op1":"1","op2":"1","op1type":"num","op2type":"str","duration":"-45","extend":false,"overrideDelay":false,"units":"min","reset":"on","bytopic":"all","topic":"topic","outputs":1,"x":2250,"y":2540,"wires":[["7d02a25d51c64e91"]]},{"id":"576978d1cc638f43","type":"server-state-changed","z":"5d4e860e6cd2bc1e","name":"Motion in kitchen","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.sensor_kitchen_motion_occupancy","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":1960,"y":2500,"wires":[["f9851727a48833cf"],[]]},{"id":"7d02a25d51c64e91","type":"change","z":"5d4e860e6cd2bc1e","name":"Set Message and color","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"Dryer Finished","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2520,"y":2540,"wires":[["7d23b37b2ab24572"]]},{"id":"ba272f2f9a71975a","type":"change","z":"5d4e860e6cd2bc1e","name":"On","rules":[{"t":"set","p":"payload","pt":"msg","to":"on","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":2540,"wires":[["81cbd5e381092417"]]},{"id":"7d23b37b2ab24572","type":"subflow:233ac7dcd801a802","z":"5d4e860e6cd2bc1e","name":"","x":2750,"y":2580,"wires":[]},{"id":"9d8a047c4c9b2cf1","type":"comment","z":"5d4e860e6cd2bc1e","name":"Dryer finishes","info":"","x":770,"y":2500,"wires":[]},{"id":"0673791e5dbec075","type":"comment","z":"5d4e860e6cd2bc1e","name":"Alert house-wide when the dryer has finished","info":"","x":770,"y":2440,"wires":[]},{"id":"2bbce3b3f6128dde","type":"comment","z":"5d4e860e6cd2bc1e","name":"Set Payload to \"On\"","info":"","x":1090,"y":2500,"wires":[]},{"id":"70c30bfb9e0ed31c","type":"comment","z":"5d4e860e6cd2bc1e","name":"No","info":"","x":2050,"y":2540,"wires":[]},{"id":"5aedb3ac0b84808d","type":"comment","z":"5d4e860e6cd2bc1e","name":"Is the kitchen occupied?","info":"","x":1800,"y":2620,"wires":[]},{"id":"32e97cf323376f3a","type":"comment","z":"5d4e860e6cd2bc1e","name":"Resend the alert every 15 minutes","info":"","x":2260,"y":2460,"wires":[]},{"id":"f941ee731129d8a1","type":"comment","z":"5d4e860e6cd2bc1e","name":"Stop when the kitchen has motion","info":"","x":2250,"y":2500,"wires":[]},{"id":"0fd460fc36360be5","type":"comment","z":"5d4e860e6cd2bc1e","name":"Set alert Message","info":"","x":2530,"y":2500,"wires":[]},{"id":"4d9b1fc9aefa82e0","type":"comment","z":"5d4e860e6cd2bc1e","name":"Broadcast Alert","info":"","x":2740,"y":2540,"wires":[]},{"id":"f84812d05a6494c5","type":"server-state-changed","z":"5d4e860e6cd2bc1e","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.dryer_dry_completed","entityidfiltertype":"substring","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":790,"y":2540,"wires":[["ba272f2f9a71975a"],[]]},{"id":"b6868b0878f5233d","type":"change","z":"5d4e860e6cd2bc1e","name":"Set Message and color","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"Dryer Finished","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2260,"y":2640,"wires":[["87c49b494e11b361"]]},{"id":"a47122f8286a5f6d","type":"comment","z":"5d4e860e6cd2bc1e","name":"Yes","info":"","x":2050,"y":2640,"wires":[]},{"id":"59e8eb36f0a3ba0e","type":"comment","z":"5d4e860e6cd2bc1e","name":"Set alert Message","info":"","x":2250,"y":2600,"wires":[]},{"id":"81cbd5e381092417","type":"api-current-state","z":"5d4e860e6cd2bc1e","name":"Is maxi sleeping?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"sensor.is_maxi_asleep","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1530,"y":2540,"wires":[["771393b019b74c98"],[]]},{"id":"4e5b0d3e7bf254dd","type":"comment","z":"5d4e860e6cd2bc1e","name":"Maxi sleeping is off.","info":"","x":1530,"y":2500,"wires":[]},{"id":"79ce3e3edf647cd5","type":"api-current-state","z":"5d4e860e6cd2bc1e","name":"Is the kitchen occupied?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_kitchen_motion_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1770,"y":3080,"wires":[["5b08cbc809046fcf"],["6b4160045b1a1940"]]},{"id":"5b08cbc809046fcf","type":"trigger","z":"5d4e860e6cd2bc1e","name":"","op1":"1","op2":"1","op1type":"num","op2type":"str","duration":"-5","extend":false,"overrideDelay":false,"units":"min","reset":"on","bytopic":"all","topic":"topic","outputs":1,"x":2230,"y":3080,"wires":[["7c730712d3aa96b7"]]},{"id":"fdd37eb16a0d1c54","type":"server-state-changed","z":"5d4e860e6cd2bc1e","name":"Motion in kitchen","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.sensor_kitchen_motion_occupancy","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":1940,"y":3040,"wires":[["7efa525fd92e36ca"],[]]},{"id":"7c730712d3aa96b7","type":"change","z":"5d4e860e6cd2bc1e","name":"Set Message and color","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"Washer Finished","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2500,"y":3080,"wires":[["60d3ce4549841dc1"]]},{"id":"dbf19824e414e1b0","type":"change","z":"5d4e860e6cd2bc1e","name":"On","rules":[{"t":"set","p":"payload","pt":"msg","to":"on","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1370,"y":3080,"wires":[["56a6f360a9085a68"]]},{"id":"60d3ce4549841dc1","type":"subflow:233ac7dcd801a802","z":"5d4e860e6cd2bc1e","name":"","x":2730,"y":3120,"wires":[]},{"id":"92ce9333a8a28392","type":"comment","z":"5d4e860e6cd2bc1e","name":"Power usage over 100W?","info":"","x":790,"y":3040,"wires":[]},{"id":"b47c85e37b844561","type":"comment","z":"5d4e860e6cd2bc1e","name":"Alert house-wide when the washer has finished","info":"","x":760,"y":2980,"wires":[]},{"id":"d6ae62928b4c2fea","type":"comment","z":"5d4e860e6cd2bc1e","name":"Set Payload to \"On\"","info":"","x":1370,"y":3040,"wires":[]},{"id":"261d71bfce9c54ad","type":"comment","z":"5d4e860e6cd2bc1e","name":"No","info":"","x":2030,"y":3080,"wires":[]},{"id":"d37dba3faa30486e","type":"comment","z":"5d4e860e6cd2bc1e","name":"Is the kitchen occupied?","info":"","x":1780,"y":3160,"wires":[]},{"id":"b8fc8e43bee08408","type":"comment","z":"5d4e860e6cd2bc1e","name":"Resend the alert every 5 minutes","info":"","x":2230,"y":3000,"wires":[]},{"id":"e8bf654982d40a75","type":"comment","z":"5d4e860e6cd2bc1e","name":"Stop when the kitchen has motion","info":"","x":2230,"y":3040,"wires":[]},{"id":"f6e46c79eb1eda89","type":"comment","z":"5d4e860e6cd2bc1e","name":"Set alert Message","info":"","x":2510,"y":3040,"wires":[]},{"id":"0b65f004e7b48608","type":"comment","z":"5d4e860e6cd2bc1e","name":"Broadcast Alert","info":"","x":2720,"y":3080,"wires":[]},{"id":"f29c5ed13292b0b8","type":"server-state-changed","z":"5d4e860e6cd2bc1e","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.zooz_washer_plug_electric_consumption_w","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"100","halt_if_type":"num","halt_if_compare":"gt","output_only_on_state_change":true,"x":820,"y":3080,"wires":[["02a200e253cae8d8"],[]]},{"id":"02a200e253cae8d8","type":"ha-wait-until","z":"5d4e860e6cd2bc1e","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":1,"entityId":"sensor.zooz_washer_plug_electric_consumption_w","entityIdFilterType":"exact","property":"state","comparator":"lt","value":"1","valueType":"num","timeout":"0","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":1160,"y":3080,"wires":[["dbf19824e414e1b0"]]},{"id":"a40d09f645ebb7b4","type":"comment","z":"5d4e860e6cd2bc1e","name":"Wait until Power goes under 1W","info":"","x":1130,"y":3040,"wires":[]},{"id":"317e593ad51bb438","type":"change","z":"5d4e860e6cd2bc1e","name":"Set Message and color","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"Washer Finished","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2240,"y":3180,"wires":[["e21eb30284f75405"]]},{"id":"eedf5f6bfc6f7c0d","type":"comment","z":"5d4e860e6cd2bc1e","name":"Yes","info":"","x":2030,"y":3180,"wires":[]},{"id":"b1f5c82413fc405f","type":"comment","z":"5d4e860e6cd2bc1e","name":"Set alert Message","info":"","x":2230,"y":3140,"wires":[]},{"id":"56a6f360a9085a68","type":"api-current-state","z":"5d4e860e6cd2bc1e","name":"Is someone cooking?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.cooking_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1540,"y":3080,"wires":[["79ce3e3edf647cd5"],[]]},{"id":"abb386f6d2a64a7c","type":"server-state-changed","z":"5d4e860e6cd2bc1e","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.sensor_kitchen_water_detector_water_leak","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":840,"y":3260,"wires":[["3f756a70cf463a31"],["e4fc5c2215631e57"]]},{"id":"bd82edd18befc3a7","type":"comment","z":"5d4e860e6cd2bc1e","name":"Stop the washer when a water damage is detected","info":"","x":770,"y":3220,"wires":[]},{"id":"3f756a70cf463a31","type":"api-call-service","z":"5d4e860e6cd2bc1e","name":"Turn off washer","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_off","areaId":[],"deviceId":[],"entityId":["switch.zooz_washer_plug"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1280,"y":3220,"wires":[[]]},{"id":"e4fc5c2215631e57","type":"api-call-service","z":"5d4e860e6cd2bc1e","name":"Turn on washer","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_on","areaId":[],"deviceId":[],"entityId":["switch.zooz_washer_plug"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1280,"y":3280,"wires":[[]]},{"id":"3543d62432228b37","type":"server-state-changed","z":"5d4e860e6cd2bc1e","name":"Smoke Detected In The Kitchen","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.sensor_kitchen_smoke_detector_smoke","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"(on|off)","ifStateType":"re","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":170,"y":780,"wires":[["87d0d89a3deb7f42","10ea0f3d7be29c93"],[]]},{"id":"87d0d89a3deb7f42","type":"trigger","z":"5d4e860e6cd2bc1e","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"2","extend":false,"overrideDelay":false,"units":"min","reset":"off","bytopic":"all","topic":"topic","outputs":1,"x":590,"y":780,"wires":[["132362dfb904fb31"]]},{"id":"132362dfb904fb31","type":"trigger","z":"5d4e860e6cd2bc1e","name":"","op1":"","op2":"1","op1type":"num","op2type":"str","duration":"-5","extend":false,"overrideDelay":false,"units":"min","reset":"off","bytopic":"all","topic":"topic","outputs":1,"x":850,"y":780,"wires":[["649683e401337030"]]},{"id":"10ea0f3d7be29c93","type":"switch","z":"5d4e860e6cd2bc1e","name":"Off?","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":590,"y":740,"wires":[["132362dfb904fb31"]]},{"id":"02ae2d65d51f225f","type":"subflow:233ac7dcd801a802","z":"5d4e860e6cd2bc1e","name":"","x":1290,"y":780,"wires":[]},{"id":"d6c6642cdef1d7a5","type":"comment","z":"5d4e860e6cd2bc1e","name":"Smoke In The Kitchen?","info":"","x":140,"y":740,"wires":[]},{"id":"b5af6f563412254e","type":"comment","z":"5d4e860e6cd2bc1e","name":"Set alert Message","info":"","x":1070,"y":740,"wires":[]},{"id":"23158d9729c5f552","type":"comment","z":"5d4e860e6cd2bc1e","name":"Broadcast Alert","info":"","x":1280,"y":740,"wires":[]},{"id":"a7f3adb6ba0938ef","type":"comment","z":"5d4e860e6cd2bc1e","name":"Resend the alert every 5 minutes","info":"","x":850,"y":700,"wires":[]},{"id":"012a4952691f5e5c","type":"comment","z":"5d4e860e6cd2bc1e","name":"Stop when the water is cleaned","info":"","x":850,"y":740,"wires":[]},{"id":"bc12d762c41f0502","type":"comment","z":"5d4e860e6cd2bc1e","name":"Wait 2 minutes","info":"","x":580,"y":820,"wires":[]},{"id":"75bced075f06260e","type":"comment","z":"5d4e860e6cd2bc1e","name":"Only let \"Off\" through","info":"","x":600,"y":700,"wires":[]},{"id":"6101640ee2333563","type":"comment","z":"5d4e860e6cd2bc1e","name":"Alert house-wide when there is smoke in the kitchen","info":"","x":230,"y":700,"wires":[]},{"id":"649683e401337030","type":"change","z":"5d4e860e6cd2bc1e","name":"Set Message and color","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"Smoke Detected In The Kitchen","tot":"str"},{"t":"set","p":"color_value","pt":"msg","to":"[255,255,255]","tot":"json"},{"t":"set","p":"dbrightness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1080,"y":780,"wires":[["02ae2d65d51f225f"]]},{"id":"1bbe98d3c44251b1","type":"server-state-changed","z":"a17f73eee8c0a729","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.sleeper_in_hotbox","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":1240,"y":1000,"wires":[["14ebb333aa8a918b"],["59cb3f8a14aeb306"]]},{"id":"d884f13121a2a86b","type":"api-call-service","z":"a17f73eee8c0a729","name":"Toggle Sleeper in Hotbox bool","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"toggle","areaId":[],"deviceId":[],"entityId":["input_boolean.sleeper_in_hotbox"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":630,"y":960,"wires":[[]]},{"id":"35988e1bac6627e9","type":"server-state-changed","z":"a17f73eee8c0a729","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"sensor.remote_hotbox_sleeper_button_action","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"off","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":280,"y":960,"wires":[["d884f13121a2a86b"],[]]},{"id":"7be5556007b48f42","type":"comment","z":"a17f73eee8c0a729","name":"Toggle the \"sleeper in hotbox\" boolean","info":"","x":630,"y":920,"wires":[]},{"id":"14ebb333aa8a918b","type":"ha-get-entities","z":"a17f73eee8c0a729","name":"Get individual Hotbox lights","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"light\\.(?!.*?group.*?)(?!.*?lights.*?).*hotbox.*","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1600,"y":980,"wires":[["0589a32b791104e0"]]},{"id":"af0dd82fa94b457f","type":"api-call-service","z":"a17f73eee8c0a729","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2170,"y":980,"wires":[[]]},{"id":"59cb3f8a14aeb306","type":"ha-get-entities","z":"a17f73eee8c0a729","name":"Get individual Hotbox down lights","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"light\\.(?!.*?group.*?)(?!.*?lights.*?).*hotbox_down.*","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1620,"y":1020,"wires":[["9fdb22ec471ede35"]]},{"id":"d89f42e5f95976ed","type":"api-call-service","z":"a17f73eee8c0a729","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"transition\":\"40\",\"color_name\": \"white\"}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2170,"y":1020,"wires":[[]]},{"id":"49cb2f44d12b6ce0","type":"comment","z":"a17f73eee8c0a729","name":"Trigger on Sleeper boolean change","info":"","x":1240,"y":960,"wires":[]},{"id":"d73faf6663c874a9","type":"comment","z":"a17f73eee8c0a729","name":"Get hotbox light entities","info":"","x":1600,"y":940,"wires":[]},{"id":"93cf89b029fc719d","type":"comment","z":"a17f73eee8c0a729","name":"Call light_off service","info":"","x":2170,"y":940,"wires":[]},{"id":"310a83320c8378c0","type":"comment","z":"a17f73eee8c0a729","name":"Toggle the hotbox lights and TVs when someone sleeps","info":"","x":1260,"y":920,"wires":[]},{"id":"1b3b271561ede431","type":"comment","z":"a17f73eee8c0a729","name":"Double press on the hotbox sleep button","info":"","x":220,"y":920,"wires":[]},{"id":"0589a32b791104e0","type":"change","z":"a17f73eee8c0a729","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1890,"y":980,"wires":[["af0dd82fa94b457f"]]},{"id":"9fdb22ec471ede35","type":"change","z":"a17f73eee8c0a729","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1910,"y":1020,"wires":[["d89f42e5f95976ed"]]},{"id":"c901c749ae865ef9","type":"server-state-changed","z":"a17f73eee8c0a729","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.sleeper_in_hotbox","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":1240,"y":1160,"wires":[["b8172514ff706b09"],[]]},{"id":"2ca7f17478daa076","type":"comment","z":"a17f73eee8c0a729","name":"Trigger on Sleeper boolean change","info":"","x":1220,"y":1120,"wires":[]},{"id":"b8172514ff706b09","type":"ha-get-entities","z":"a17f73eee8c0a729","name":"Get hotbox Media players","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.(?!.*?group.*?)(?!.*?display.*?)(?!.*?roku.*?).*hotbox.*","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1610,"y":1160,"wires":[["d54ea00bdee7d499"]]},{"id":"d4e5ac0df1fa3864","type":"comment","z":"a17f73eee8c0a729","name":"Pull hotbox down media players","info":"","x":1610,"y":1120,"wires":[]},{"id":"d54ea00bdee7d499","type":"change","z":"a17f73eee8c0a729","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1870,"y":1160,"wires":[["8fd47233580b3fea"]]},{"id":"bf60e0bd3afc2fdd","type":"comment","z":"a17f73eee8c0a729","name":"Is the input \"Xbox One\"? ","info":"","x":1900,"y":1600,"wires":[]},{"id":"98c1cccc2bb53bb6","type":"comment","z":"a17f73eee8c0a729","name":"Stop playback","info":"","x":2810,"y":1120,"wires":[]},{"id":"8ccacac9494ee667","type":"api-call-service","z":"a17f73eee8c0a729","name":"stop player","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2810,"y":1160,"wires":[[]]},{"id":"237186ed03f52741","type":"api-call-service","z":"a17f73eee8c0a729","name":"mute player","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\":\"true\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2330,"y":1160,"wires":[["e32356b61fc49f34"]]},{"id":"e32356b61fc49f34","type":"api-current-state","z":"a17f73eee8c0a729","name":"Home_Group off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.group_home_speakers","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2580,"y":1160,"wires":[["8ccacac9494ee667"],[]]},{"id":"ac95e3abcfc1a10d","type":"comment","z":"a17f73eee8c0a729","name":"MAke sure home_group is not playing","info":"","x":2590,"y":1120,"wires":[]},{"id":"94913e1ac1efa8cf","type":"mqtt in","z":"a17f73eee8c0a729","name":"","topic":"zigbee2mqtt/remote_hotbox_down_dial","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":210,"y":60,"wires":[["968f93b8a0e17a8f"]]},{"id":"968f93b8a0e17a8f","type":"subflow:61f53235c712b2c2","z":"a17f73eee8c0a729","name":"","x":490,"y":60,"wires":[]},{"id":"66ee8459781b4746","type":"server-state-changed","z":"a17f73eee8c0a729","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.sleeper_in_hotbox","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"1","forType":"num","forUnits":"seconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":1220,"y":1360,"wires":[["03d1818d6e4d03fc"],["9b1f99cb3bbd0946"]]},{"id":"98c2c027ee5eeee9","type":"comment","z":"a17f73eee8c0a729","name":"Trigger on Sleeper boolean change","info":"","x":1220,"y":1320,"wires":[]},{"id":"03d1818d6e4d03fc","type":"api-call-service","z":"a17f73eee8c0a729","name":"Power off Hotbox Down TV","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"google_assistant_sdk","service":"send_text_command","areaId":[],"deviceId":[],"entityId":[],"data":"{\"command\":\"power off hotbox down TV\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1660,"y":1300,"wires":[[]]},{"id":"0f6b1d8651c9b547","type":"comment","z":"a17f73eee8c0a729","name":"Power off Hotbox Down TV through google SDK","info":"","x":1720,"y":1260,"wires":[]},{"id":"6193aa301369ecc1","type":"api-call-service","z":"a17f73eee8c0a729","name":"Power on Hotbox Down TV","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"google_assistant_sdk","service":"send_text_command","areaId":[],"deviceId":[],"entityId":[],"data":"{\"command\":\"power on hotbox down TV\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1740,"y":1400,"wires":[[]]},{"id":"8362e90798f6e786","type":"comment","z":"a17f73eee8c0a729","name":"Unmuute hotbox speaker once the guests exit it","info":"","x":1220,"y":1820,"wires":[]},{"id":"9608d3769a306c88","type":"server-state-changed","z":"a17f73eee8c0a729","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.sleeper_in_hotbox","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":1220,"y":1640,"wires":[["4b8f43c629bec0cd"],[]]},{"id":"91e7cecc7dbecd99","type":"comment","z":"a17f73eee8c0a729","name":"Trigger on Sleeper boolean change","info":"","x":1220,"y":1600,"wires":[]},{"id":"c9c9112b9f219ebc","type":"api-call-service","z":"a17f73eee8c0a729","name":"Shut down xbox","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"remote","service":"turn_off","areaId":[],"deviceId":[],"entityId":["remote.xboxone_remote"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2300,"y":1640,"wires":[[]]},{"id":"0f9df898ed43c2c9","type":"comment","z":"a17f73eee8c0a729","name":"Shut down Xbox","info":"","x":2300,"y":1600,"wires":[]},{"id":"4b8f43c629bec0cd","type":"api-current-state","z":"a17f73eee8c0a729","name":"Current TV input","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.hotbox_top_roku","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1600,"y":1640,"wires":[["444b4e57e28955dd","286351f16f292d7f"]]},{"id":"444b4e57e28955dd","type":"debug","z":"a17f73eee8c0a729","name":"debug 125","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1770,"y":1680,"wires":[]},{"id":"286351f16f292d7f","type":"switch","z":"a17f73eee8c0a729","name":"Is tv on xbox","property":"data.attributes.app_name","propertyType":"msg","rules":[{"t":"neq","v":"Xbox One","vt":"str"},{"t":"eq","v":"Xbox One","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1890,"y":1640,"wires":[["c9c9112b9f219ebc"],["2aa00909aea38c63"]]},{"id":"52696ddce1e7401f","type":"comment","z":"a17f73eee8c0a729","name":"Power on Hotbox Down TV through google SDK","info":"","x":1720,"y":1360,"wires":[]},{"id":"2aa00909aea38c63","type":"ha-wait-until","z":"a17f73eee8c0a729","name":"Wait till top tv turns off","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"remote.hotbox_top_roku","entityIdFilterType":"exact","property":"state","comparator":"is","value":"off","valueType":"str","timeout":"2","timeoutType":"num","timeoutUnits":"hours","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":2100,"y":1660,"wires":[["c9c9112b9f219ebc"],[]]},{"id":"9b1f99cb3bbd0946","type":"delay","z":"a17f73eee8c0a729","name":"","pauseType":"delay","timeout":"25","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1540,"y":1400,"wires":[["6193aa301369ecc1"]]},{"id":"c2e209c279bb7993","type":"comment","z":"a17f73eee8c0a729","name":"Extract the current TV state entity","info":"","x":1590,"y":1600,"wires":[]},{"id":"69101c2f18536d2e","type":"server-state-changed","z":"a17f73eee8c0a729","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"media_player.hotbox_down_display","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"playing","ifStateType":"str","ifStateOperator":"is_not","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":250,"y":300,"wires":[["fd9d5a1c595d2032"],[]]},{"id":"eb33f904396cbd66","type":"trigger","z":"a17f73eee8c0a729","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"seT","bytopic":"all","topic":"topic","outputs":1,"x":1660,"y":300,"wires":[["d6ad282bdce810d5"]]},{"id":"d6ad282bdce810d5","type":"api-call-service","z":"a17f73eee8c0a729","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cast","service":"show_lovelace_view","areaId":[],"deviceId":[],"entityId":["media_player.hotbox_down_display"],"data":"{\"dashboard_path\":\"lovelace-hub\",\"view_path\":\"hotbox-down-hub\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1850,"y":300,"wires":[[]]},{"id":"fd9d5a1c595d2032","type":"api-current-state","z":"a17f73eee8c0a729","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.sleeper_in_hotbox","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":680,"y":300,"wires":[["ba93755bea8e2617"],[]]},{"id":"7cba555a995aec1e","type":"server-state-changed","z":"a17f73eee8c0a729","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.sleeper_in_hotbox","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"","forType":"num","forUnits":"seconds","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":1220,"y":2220,"wires":[["78e4941095a5010b"],["9d612ca0ad4ca8a8"]]},{"id":"b9b878fa9596feaf","type":"comment","z":"a17f73eee8c0a729","name":"Trigger on Sleeper boolean change","info":"","x":1180,"y":2180,"wires":[]},{"id":"dcf660f8b8948b2b","type":"comment","z":"a17f73eee8c0a729","name":"Power off Google Hub","info":"","x":1660,"y":2120,"wires":[]},{"id":"61b2575cefa66b52","type":"comment","z":"a17f73eee8c0a729","name":"Power on Google hub ","info":"","x":1660,"y":2240,"wires":[]},{"id":"9d612ca0ad4ca8a8","type":"api-call-service","z":"a17f73eee8c0a729","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cast","service":"show_lovelace_view","areaId":[],"deviceId":[],"entityId":["media_player.hotbox_down_display"],"data":"{\"dashboard_path\":\"lovelace-hub\",\"view_path\":\"hotbox-down-hub\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1690,"y":2280,"wires":[["e47acf030a60c248"]]},{"id":"78e4941095a5010b","type":"api-call-service","z":"a17f73eee8c0a729","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":["media_player.hotbox_down_display"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1680,"y":2160,"wires":[["47ee274040a3dce7"]]},{"id":"47ee274040a3dce7","type":"api-call-service","z":"a17f73eee8c0a729","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_on","areaId":[],"deviceId":[],"entityId":["switch.kitchen_display_do_not_disturb"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1950,"y":2160,"wires":[[]]},{"id":"e47acf030a60c248","type":"api-call-service","z":"a17f73eee8c0a729","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_off","areaId":[],"deviceId":[],"entityId":["switch.kitchen_display_do_not_disturb"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1930,"y":2280,"wires":[[]]},{"id":"96827ac3e2373cd3","type":"comment","z":"a17f73eee8c0a729","name":"Mute player","info":"","x":2330,"y":1120,"wires":[]},{"id":"bd64a9a678c025a6","type":"comment","z":"a17f73eee8c0a729","name":"Mute player's volume","info":"","x":2160,"y":1220,"wires":[]},{"id":"9d2a8668e847d42d","type":"comment","z":"a17f73eee8c0a729","name":"Stop playback","info":"","x":2810,"y":1220,"wires":[]},{"id":"3cdc3e401e3b5a9b","type":"api-call-service","z":"a17f73eee8c0a729","name":"stop player","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2810,"y":1260,"wires":[[]]},{"id":"eeb943f2106ae203","type":"api-call-service","z":"a17f73eee8c0a729","name":"mute player","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\":\"true\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2350,"y":1260,"wires":[["1460ee0b7d569c83"]]},{"id":"1460ee0b7d569c83","type":"api-current-state","z":"a17f73eee8c0a729","name":"Home_Group off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.group_home_speakers","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2580,"y":1260,"wires":[["3cdc3e401e3b5a9b"],[]]},{"id":"ab5b0b4f8b2c7eb9","type":"comment","z":"a17f73eee8c0a729","name":"MAke sure home_group is not playing","info":"","x":2590,"y":1220,"wires":[]},{"id":"30c669689114040c","type":"api-call-service","z":"a17f73eee8c0a729","name":"turn on","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2160,"y":1260,"wires":[["eeb943f2106ae203"]]},{"id":"9c272b23c1b648f5","type":"comment","z":"a17f73eee8c0a729","name":"Mute player","info":"","x":2350,"y":1300,"wires":[]},{"id":"8fd47233580b3fea","type":"switch","z":"a17f73eee8c0a729","name":"!=off?","property":"payload.state","propertyType":"msg","rules":[{"t":"neq","v":"off","vt":"str"},{"t":"nnull"}],"checkall":"false","repair":false,"outputs":2,"x":2150,"y":1160,"wires":[["237186ed03f52741"],["30c669689114040c"]]},{"id":"a5be34c3d07501b5","type":"comment","z":"a17f73eee8c0a729","name":"Is player active?","info":"","x":2120,"y":1120,"wires":[]},{"id":"43f16058dcb2a562","type":"server-state-changed","z":"a17f73eee8c0a729","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.sleeper_in_hotbox","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"off","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":1220,"y":1860,"wires":[["66ae81181e0a1e2e"],["6cc075bb83426ace"]]},{"id":"aaea214957665c6a","type":"ha-get-entities","z":"a17f73eee8c0a729","name":"Get all hotbox Media players","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.(?!.*?group.*?).*hotbox.*","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1920,"y":1860,"wires":[["5ed5523a6d5b2301"]]},{"id":"5ed5523a6d5b2301","type":"change","z":"a17f73eee8c0a729","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":2190,"y":1860,"wires":[["f672ca534b50d663"]]},{"id":"f672ca534b50d663","type":"api-call-service","z":"a17f73eee8c0a729","name":"unmute player","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\":\"false\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2420,"y":1860,"wires":[[]]},{"id":"66ae81181e0a1e2e","type":"ha-wait-until","z":"a17f73eee8c0a729","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"binary_sensor.sensor_hotbox_exit_motion_occupancy","entityIdFilterType":"exact","property":"state","comparator":"is","value":"on","valueType":"str","timeout":"15","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":false,"blockInputOverrides":true,"outputProperties":[],"x":1660,"y":1860,"wires":[["aaea214957665c6a"],["aaea214957665c6a"]]},{"id":"6cc075bb83426ace","type":"change","z":"a17f73eee8c0a729","name":"","rules":[{"t":"set","p":"reset","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1520,"y":1920,"wires":[["66ae81181e0a1e2e"]]},{"id":"accd20fd1f421698","type":"api-call-service","z":"a17f73eee8c0a729","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":["media_player.hotbox_down_display"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1420,"y":300,"wires":[["eb33f904396cbd66"]]},{"id":"ba93755bea8e2617","type":"trigger","z":"a17f73eee8c0a729","name":"","op1":"","op2":"0","op1type":"pay","op2type":"str","duration":"-15","extend":false,"overrideDelay":false,"units":"min","reset":"seT","bytopic":"all","topic":"topic","outputs":1,"x":1110,"y":300,"wires":[["accd20fd1f421698"]]},{"id":"886a87b7d460ed86","type":"comment","z":"a17f73eee8c0a729","name":"Turn on \"Do not disturb\"","info":"","x":1960,"y":2120,"wires":[]},{"id":"f15703ee7b5b598e","type":"comment","z":"a17f73eee8c0a729","name":"Turn Off \"Do not disturb\"","info":"","x":1950,"y":2240,"wires":[]},{"id":"331eeab8b7110a87","type":"comment","z":"a17f73eee8c0a729","name":"Restore Google hub Lovelace Interface","info":"","x":210,"y":220,"wires":[]},{"id":"04a41308bb2e6831","type":"comment","z":"a17f73eee8c0a729","name":"trigger when Hub is not \"playing\"","info":"","x":190,"y":260,"wires":[]},{"id":"e09a90dcd9845404","type":"comment","z":"a17f73eee8c0a729","name":"Is someone sleeping?","info":"","x":680,"y":260,"wires":[]},{"id":"3cdccf94446016c1","type":"comment","z":"a17f73eee8c0a729","name":"This insures that the lovelace interface is always present","info":"","x":1100,"y":260,"wires":[]},{"id":"bc2e57894656d851","type":"comment","z":"a17f73eee8c0a729","name":"Turn off the current interface","info":"","x":1440,"y":260,"wires":[]},{"id":"1d9e137e6ef61319","type":"comment","z":"a17f73eee8c0a729","name":"Wait one second","info":"","x":1660,"y":260,"wires":[]},{"id":"cad296b311dad21a","type":"comment","z":"a17f73eee8c0a729","name":"Cast the interface","info":"","x":1840,"y":260,"wires":[]},{"id":"617f7e0733134fb5","type":"comment","z":"a17f73eee8c0a729","name":"Mute and turn off hotbox down media players","info":"``","x":1210,"y":1080,"wires":[]},{"id":"fdb79e830809f5a1","type":"comment","z":"a17f73eee8c0a729","name":"Toggle the Hotbox Down Television","info":"``","x":1180,"y":1280,"wires":[]},{"id":"a444bae72e6aaeea","type":"comment","z":"a17f73eee8c0a729","name":"Shut down Xbox","info":"``","x":1120,"y":1560,"wires":[]},{"id":"ae2ebb82ed92f4e4","type":"inject","z":"a17f73eee8c0a729","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1660,"y":360,"wires":[["d6ad282bdce810d5"]]},{"id":"1837c440400ea4d3","type":"inject","z":"a17f73eee8c0a729","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1220,"y":340,"wires":[["accd20fd1f421698"]]},{"id":"5c34340a6b57d5cc","type":"mqtt in","z":"45ec21e855a2c144","name":"","topic":"zigbee2mqtt/remote_hotbox_top_dial","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":240,"y":100,"wires":[["7e46f5ac55d59601"]]},{"id":"50957135e3ab67f7","type":"server-state-changed","z":"45ec21e855a2c144","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.sleeper_in_hotbox","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":260,"y":800,"wires":[["d69f1bece257855c"],[]]},{"id":"aab499590f5db012","type":"ha-get-entities","z":"45ec21e855a2c144","name":"Get active hotbox top Media players","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.(?!.*?group.*?)(?!.*?down.*?).*hotbox.*","valueType":"re"},{"property":"state","logic":"is","value":"playing","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":880,"y":740,"wires":[["6c8cfb64761ae819"]]},{"id":"6c8cfb64761ae819","type":"change","z":"45ec21e855a2c144","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1590,"y":740,"wires":[["6825f929f1cd797c"]]},{"id":"f9759cd1a4672059","type":"comment","z":"45ec21e855a2c144","name":"Extract the entity id","info":"","x":1590,"y":700,"wires":[]},{"id":"10b7e8785085c443","type":"comment","z":"45ec21e855a2c144","name":"Set 20% volume","info":"","x":1840,"y":760,"wires":[]},{"id":"af87da9ee5ee6de9","type":"comment","z":"45ec21e855a2c144","name":"Extract the entity id","info":"","x":1210,"y":920,"wires":[]},{"id":"6825f929f1cd797c","type":"api-call-service","z":"45ec21e855a2c144","name":"Volume 20%","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":[],"data":"{\"volume_level\": \"0.2\"}","dataType":"json","mergeContext":"","mustacheAltTags":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"payload.entity_id","valueType":"msg"}],"queue":"none","x":1830,"y":800,"wires":[["03f0e80e82abaa7a"]]},{"id":"52d1054ff0d8a495","type":"api-call-service","z":"45ec21e855a2c144","name":"mute player","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\":\"true\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3090,"y":800,"wires":[["cc92a79f8ac80835"]]},{"id":"03f0e80e82abaa7a","type":"ha-wait-until","z":"45ec21e855a2c144","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"{{ payload}}","entityIdFilterType":"exact","property":"state","comparator":"is","value":"off","valueType":"str","timeout":"90","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":2040,"y":800,"wires":[["dbdd72f70d06fcf5","033fd366944c5670"],["dbdd72f70d06fcf5","033fd366944c5670"]]},{"id":"a78a366897c6c3a4","type":"comment","z":"45ec21e855a2c144","name":"Move entity_id to data","info":"","x":2260,"y":760,"wires":[]},{"id":"c6ac14de03348bd6","type":"comment","z":"45ec21e855a2c144","name":"Wait till media ends","info":"","x":2050,"y":760,"wires":[]},{"id":"dbdd72f70d06fcf5","type":"change","z":"45ec21e855a2c144","name":"","rules":[{"t":"move","p":"payload","pt":"msg","to":"payload.data.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2250,"y":800,"wires":[["c03301b003ce3a9c"]]},{"id":"c03301b003ce3a9c","type":"api-call-service","z":"45ec21e855a2c144","name":"turn on for mute","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2600,"y":800,"wires":[["525ea20afe938830"]]},{"id":"d266250440de4bea","type":"api-call-service","z":"45ec21e855a2c144","name":"turn off post mute","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3710,"y":800,"wires":[[]]},{"id":"cc92a79f8ac80835","type":"delay","z":"45ec21e855a2c144","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":3280,"y":800,"wires":[["22ecd73be25b1f1c"]]},{"id":"525ea20afe938830","type":"delay","z":"45ec21e855a2c144","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":2900,"y":800,"wires":[["52d1054ff0d8a495"]]},{"id":"1f7bb88f84d15b15","type":"comment","z":"45ec21e855a2c144","name":"Pull hotbox top media players that are playing","info":"","x":910,"y":700,"wires":[]},{"id":"2c9fe7dcab8d2ad6","type":"comment","z":"45ec21e855a2c144","name":"Turn on the media_player so we can set it's volume","info":"","x":2570,"y":760,"wires":[]},{"id":"d50154c5ff7abc86","type":"comment","z":"45ec21e855a2c144","name":"Mute player","info":"","x":3090,"y":760,"wires":[]},{"id":"574b860ccac28c53","type":"comment","z":"45ec21e855a2c144","name":"Turn player back off","info":"","x":3710,"y":760,"wires":[]},{"id":"d69f1bece257855c","type":"api-current-state","z":"45ec21e855a2c144","name":"Hotbox top occupancy","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_hotbox_top_motion_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":620,"y":800,"wires":[["aab499590f5db012","58315d58d7ea44dd"],["31257fc2008bfb16","d8c423e20df2d58d"]]},{"id":"31257fc2008bfb16","type":"ha-get-entities","z":"45ec21e855a2c144","name":"Get active hotbox top Media players","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.(?!.*?group.*?)(?!.*?plex.*?)(?!.*?down.*?).*hotbox.*","valueType":"re"},{"property":"state","logic":"is","value":"playing","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":880,"y":880,"wires":[["a2632d156a2d8c74"]]},{"id":"a2632d156a2d8c74","type":"change","z":"45ec21e855a2c144","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1190,"y":880,"wires":[["462a40c733a907f2"]]},{"id":"462a40c733a907f2","type":"api-call-service","z":"45ec21e855a2c144","name":"mute player","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\":\"true\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1430,"y":880,"wires":[["13d226cd1bb6cef9"]]},{"id":"17bfa413e8373695","type":"api-call-service","z":"45ec21e855a2c144","name":"turn off post mute","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2130,"y":880,"wires":[[]]},{"id":"13d226cd1bb6cef9","type":"delay","z":"45ec21e855a2c144","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1620,"y":880,"wires":[["c2ce2a97e3a41055"]]},{"id":"879f0fef37a4db6e","type":"comment","z":"45ec21e855a2c144","name":"Mute player","info":"","x":1430,"y":920,"wires":[]},{"id":"89b1fc0dd9aef127","type":"comment","z":"45ec21e855a2c144","name":"Turn player back off","info":"","x":2130,"y":920,"wires":[]},{"id":"15109df6877c80df","type":"comment","z":"45ec21e855a2c144","name":"Pull hotbox top media players that are playing","info":"","x":870,"y":920,"wires":[]},{"id":"e4e3cf888494e014","type":"comment","z":"45ec21e855a2c144","name":"Change hotbox top media volumes upon sleep","info":"","x":250,"y":760,"wires":[]},{"id":"22ecd73be25b1f1c","type":"api-current-state","z":"45ec21e855a2c144","name":"Home_Group off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.group_home_speakers","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3480,"y":800,"wires":[["d266250440de4bea"],[]]},{"id":"c2ce2a97e3a41055","type":"api-current-state","z":"45ec21e855a2c144","name":"Home_Group off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.group_home_speakers","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":1840,"y":880,"wires":[["17bfa413e8373695"],[]]},{"id":"afd9babff9388871","type":"comment","z":"45ec21e855a2c144","name":"MAke sure home_group is not playing","info":"","x":3490,"y":760,"wires":[]},{"id":"32a93bf221600c51","type":"comment","z":"45ec21e855a2c144","name":"MAke sure home_group is not playing","info":"","x":1850,"y":920,"wires":[]},{"id":"d8c423e20df2d58d","type":"api-call-service","z":"45ec21e855a2c144","name":"turn off hotbox top roku","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"remote","service":"turn_off","areaId":[],"deviceId":[],"entityId":["remote.hotbox_top_roku"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":850,"y":840,"wires":[["f6b5f9d9b4860a5e"]]},{"id":"033fd366944c5670","type":"api-call-service","z":"45ec21e855a2c144","name":"turn off hotbox top roku","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"remote","service":"turn_off","areaId":[],"deviceId":[],"entityId":["remote.hotbox_top_roku"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2270,"y":840,"wires":[[]]},{"id":"7e46f5ac55d59601","type":"subflow:61f53235c712b2c2","z":"45ec21e855a2c144","name":"","x":510,"y":100,"wires":[]},{"id":"9b624ca440220d43","type":"api-call-service","z":"45ec21e855a2c144","name":"Turn on Xbox","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"remote","service":"turn_on","areaId":[],"deviceId":[],"entityId":["remote.xboxone_remote"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":540,"y":460,"wires":[[]]},{"id":"8d12baa1b69f5dcb","type":"api-call-service","z":"45ec21e855a2c144","name":"Turn on Top Roku on Chromecast","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"select_source","areaId":[],"deviceId":[],"entityId":["media_player.hotbox_top_roku"],"data":"{\"source\": \"Chromecast\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":840,"y":580,"wires":[[]]},{"id":"21932aa4a41aa598","type":"api-call-service","z":"45ec21e855a2c144","name":"turn off hotbox top roku","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"remote","service":"turn_off","areaId":[],"deviceId":[],"entityId":["remote.hotbox_top_roku"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1290,"y":800,"wires":[[]]},{"id":"9afc64173e76277d","type":"ha-wait-until","z":"45ec21e855a2c144","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"binary_sensor.sensor_hotbox_top_motion_occupancy","entityIdFilterType":"exact","property":"state","comparator":"is","value":"off","valueType":"str","timeout":"4","timeoutType":"num","timeoutUnits":"hours","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":1040,"y":800,"wires":[["21932aa4a41aa598"],[]]},{"id":"830a27868cd981ed","type":"trigger-state","z":"45ec21e855a2c144","name":"","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"sensor.hotbox_top_roku_active_app","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"Xbox One"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":260,"y":460,"wires":[["9b624ca440220d43"],[]]},{"id":"120355545cc415e1","type":"trigger-state","z":"45ec21e855a2c144","name":"","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.sensor_hotbox_top_motion_occupancy","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"entity_id","targetValue":"remote.hotbox_top_roku","propertyType":"property","propertyValue":"state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"},{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":320,"y":580,"wires":[["8d12baa1b69f5dcb"],[]]},{"id":"d79e75e150c9a68e","type":"comment","z":"45ec21e855a2c144","name":"Open chromecast upon entering Hotbox top","info":"","x":250,"y":540,"wires":[]},{"id":"58315d58d7ea44dd","type":"delay","z":"45ec21e855a2c144","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":860,"y":800,"wires":[["9afc64173e76277d"]]},{"id":"f6b5f9d9b4860a5e","type":"api-call-service","z":"45ec21e855a2c144","name":"turn off hotbox top roku","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"remote","service":"turn_off","areaId":[],"deviceId":[],"entityId":["remote.hotbox_top_roku"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1090,"y":840,"wires":[["61255fa28173321a"]]},{"id":"61255fa28173321a","type":"api-call-service","z":"45ec21e855a2c144","name":"turn off hotbox top roku","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"remote","service":"turn_off","areaId":[],"deviceId":[],"entityId":["remote.hotbox_top_roku"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1330,"y":840,"wires":[[]]},{"id":"ee8a2a70a5291def","type":"comment","z":"45ec21e855a2c144","name":"Turn on Xbox when the TV is set to Xbox input","info":"","x":250,"y":420,"wires":[]},{"id":"6f68e6a53a9846c7","type":"comment","z":"45ec21e855a2c144","name":"Turn on xbox ","info":"","x":540,"y":420,"wires":[]},{"id":"44b5bc4faefb1e14","type":"server-state-changed","z":"45ec21e855a2c144","name":"Roku Changes","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sensor.hotbox_top_roku_active_app","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":180,"y":280,"wires":[["7f9a1d858af4af65"]]},{"id":"404ecaebc962233c","type":"switch","z":"45ec21e855a2c144","name":"","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"Plex","vt":"str"},{"t":"cont","v":"Netflix","vt":"str"},{"t":"cont","v":"Xbox","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":730,"y":280,"wires":[["98fc5a3560c564f6"],["98fc5a3560c564f6"],["0b790b8288d7484a"]]},{"id":"6796fb06bd462591","type":"api-current-state","z":"45ec21e855a2c144","name":"Light is already on?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.hotbox_ceiling_light","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":930,"y":260,"wires":[["a282295f9531c449"],[]]},{"id":"5bc2cb0e759e793b","type":"api-call-service","z":"45ec21e855a2c144","name":"Lower lights to 35%","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.group_hotbox_top_lights"],"data":"{\"brightness_pct\":\"35\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1230,"y":260,"wires":[[]]},{"id":"0f3eed9ec082c47c","type":"server-state-changed","z":"45ec21e855a2c144","name":"Hotbox TV Changes","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"media_player.hotbox_top_chromecast","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"idle","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":190,"y":240,"wires":[["f7c29043a9516378"],[]]},{"id":"32b6d425f6afdbd3","type":"api-current-state","z":"45ec21e855a2c144","name":"Light is already on?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.hotbox_ceiling_light","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":930,"y":300,"wires":[["a282295f9531c449","4eb099e1b392cd4c"],[]]},{"id":"04e20d78621b2d90","type":"comment","z":"45ec21e855a2c144","name":"Monitor when tv enters \"idle\"","info":"","x":200,"y":200,"wires":[]},{"id":"6c1ecfe43363e7e9","type":"api-call-service","z":"45ec21e855a2c144","name":"Turn lights green","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.group_hotbox_top_lights"],"data":"{\"color_name\":\"green\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1230,"y":300,"wires":[[]]},{"id":"bd525f7ba4e7d782","type":"change","z":"45ec21e855a2c144","name":"Move app_name to payload","rules":[{"t":"set","p":"payload","pt":"msg","to":"data.new_state.attributes.app_name","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":460,"y":240,"wires":[["7f9a1d858af4af65"]]},{"id":"72bb611b22615a98","type":"comment","z":"45ec21e855a2c144","name":"Put the app_name in the payload var","info":"","x":480,"y":200,"wires":[]},{"id":"2398f48fbd8114ce","type":"comment","z":"45ec21e855a2c144","name":"Switch upon payload","info":"","x":710,"y":220,"wires":[]},{"id":"6d583177dbf493c6","type":"comment","z":"45ec21e855a2c144","name":"Monitor Roku's app name","info":"","x":190,"y":320,"wires":[]},{"id":"5bb829af387ea405","type":"comment","z":"45ec21e855a2c144","name":"Check that light is already on","info":"","x":960,"y":220,"wires":[]},{"id":"9a5b5892d56c4a8b","type":"comment","z":"45ec21e855a2c144","name":"Modify Lights ","info":"","x":1230,"y":220,"wires":[]},{"id":"24a93733bd6aca6b","type":"server-state-changed","z":"45ec21e855a2c144","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"media_player.hotbox_top_display","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"playing","ifStateType":"str","ifStateOperator":"is_not","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":240,"y":1220,"wires":[["f3f613c151fa918b"],[]]},{"id":"724aee6482d0ca0a","type":"trigger","z":"45ec21e855a2c144","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"seT","bytopic":"all","topic":"topic","outputs":1,"x":1660,"y":1220,"wires":[["5eb59df9a855ae0b"]]},{"id":"f3f613c151fa918b","type":"api-current-state","z":"45ec21e855a2c144","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.sleeper_in_hotbox","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":680,"y":1220,"wires":[["99fbc0b472b5c323"],[]]},{"id":"a04f9ed88dc4871c","type":"api-call-service","z":"45ec21e855a2c144","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":["media_player.hotbox_top_display"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1420,"y":1220,"wires":[["724aee6482d0ca0a"]]},{"id":"99fbc0b472b5c323","type":"trigger","z":"45ec21e855a2c144","name":"","op1":"","op2":"0","op1type":"pay","op2type":"str","duration":"-15","extend":false,"overrideDelay":false,"units":"min","reset":"seT","bytopic":"all","topic":"topic","outputs":1,"x":1110,"y":1220,"wires":[["a04f9ed88dc4871c"]]},{"id":"29b06695baa0a6fa","type":"comment","z":"45ec21e855a2c144","name":"Restore Google hub Lovelace Interface","info":"","x":210,"y":1140,"wires":[]},{"id":"1559fe0f6b34959f","type":"comment","z":"45ec21e855a2c144","name":"trigger when Hub is not \"playing\"","info":"","x":190,"y":1180,"wires":[]},{"id":"cc3b50dafbcab264","type":"comment","z":"45ec21e855a2c144","name":"Is someone sleeping?","info":"","x":680,"y":1180,"wires":[]},{"id":"dc2ae5881c8318cc","type":"comment","z":"45ec21e855a2c144","name":"This insures that the lovelace interface is always present","info":"","x":1100,"y":1180,"wires":[]},{"id":"de9d8253769f5438","type":"comment","z":"45ec21e855a2c144","name":"Turn off the current interface","info":"","x":1440,"y":1180,"wires":[]},{"id":"1f0cdf1c3c3f847f","type":"comment","z":"45ec21e855a2c144","name":"Wait one second","info":"","x":1660,"y":1180,"wires":[]},{"id":"42e99656e3b98a9a","type":"comment","z":"45ec21e855a2c144","name":"Cast the interface","info":"","x":1840,"y":1180,"wires":[]},{"id":"5eb59df9a855ae0b","type":"api-call-service","z":"45ec21e855a2c144","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cast","service":"show_lovelace_view","areaId":[],"deviceId":[],"entityId":["media_player.hotbox_top_display"],"data":"{\"dashboard_path\":\"lovelace-hub\",\"view_path\":\"hotbox_top_hub\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1870,"y":1220,"wires":[[]]},{"id":"7eda3eb589b2ea8e","type":"delay","z":"933f5581a37dd52c","name":"Delay","pauseType":"delay","timeout":"1","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":1270,"y":600,"wires":[["faf7be1af95146ae"]]},{"id":"faf7be1af95146ae","type":"change","z":"933f5581a37dd52c","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"foo","tot":"str"},{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1450,"y":600,"wires":[["8a301cae264d3533"]]},{"id":"7ccd40e93a276211","type":"api-current-state","z":"933f5581a37dd52c","name":"b7","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"sensor.b7bracelet1","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"location","propertyType":"msg","value":"","valueType":"entityState"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":1030,"y":540,"wires":[["8a301cae264d3533","401ca565b25fb13d"]]},{"id":"e251c8e0979fa2ac","type":"switch","z":"933f5581a37dd52c","name":"count presses","property":"count","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"eq","v":"3","vt":"num"},{"t":"eq","v":"4","vt":"num"},{"t":"eq","v":"5","vt":"num"}],"checkall":"true","repair":false,"outputs":5,"x":1630,"y":640,"wires":[["a9dbc1eaf7a99840"],["4d3fcc087692f8f7"],["061eeb741dd75d76"],["28818cdcb9aea2a2"],["053cfa396de504ff"]],"info":"Just expand the flow.count to how ever many\npresses you want/need."},{"id":"8a301cae264d3533","type":"counter","z":"933f5581a37dd52c","name":"","init":"0","step":"1","lower":"","upper":"","mode":"increment","outputs":"1","x":1450,"y":540,"wires":[["dab811d3aa55cbbb"]]},{"id":"f0093527c390e7d5","type":"inject","z":"933f5581a37dd52c","name":"Reset","repeat":"","crontab":"","once":true,"onceDelay":"0.5","topic":"","payload":"","payloadType":"date","x":1270,"y":560,"wires":[["faf7be1af95146ae"]]},{"id":"d46e3e1f0c3f672b","type":"change","z":"933f5581a37dd52c","name":"command","rules":[{"t":"set","p":"command","pt":"msg","to":"up","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":890,"y":460,"wires":[["7ccd40e93a276211"]]},{"id":"5c6651bd9d231831","type":"change","z":"933f5581a37dd52c","name":"command","rules":[{"t":"set","p":"command","pt":"msg","to":"down","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":890,"y":500,"wires":[["7ccd40e93a276211"]]},{"id":"97a3057cac8a6407","type":"change","z":"933f5581a37dd52c","name":"command","rules":[{"t":"set","p":"command","pt":"msg","to":"off","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":790,"y":540,"wires":[["7ccd40e93a276211"]]},{"id":"df7bc71760bdb52a","type":"change","z":"933f5581a37dd52c","name":"command","rules":[{"t":"set","p":"command","pt":"msg","to":"on","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":790,"y":580,"wires":[["7ccd40e93a276211"]]},{"id":"a9dbc1eaf7a99840","type":"change","z":"933f5581a37dd52c","name":"Single Press","rules":[{"t":"set","p":"pressamount","pt":"msg","to":"1","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1840,"y":580,"wires":[["61324482911d6fe5"]]},{"id":"4d3fcc087692f8f7","type":"change","z":"933f5581a37dd52c","name":"Double Press","rules":[{"t":"set","p":"pressamount","pt":"msg","to":"2","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1850,"y":620,"wires":[["61324482911d6fe5"]]},{"id":"061eeb741dd75d76","type":"change","z":"933f5581a37dd52c","name":"Triple Press","rules":[{"t":"set","p":"pressamount","pt":"msg","to":"3","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1840,"y":660,"wires":[["61324482911d6fe5"]]},{"id":"28818cdcb9aea2a2","type":"change","z":"933f5581a37dd52c","name":"Four Press","rules":[{"t":"set","p":"pressamount","pt":"msg","to":"4","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1840,"y":700,"wires":[["61324482911d6fe5"]]},{"id":"dab811d3aa55cbbb","type":"change","z":"933f5581a37dd52c","name":"Flow set","rules":[{"t":"set","p":"count","pt":"flow","to":"count","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1610,"y":540,"wires":[["951e41f7fe8a8d19"]]},{"id":"ca31fb2d54aeeabd","type":"switch","z":"933f5581a37dd52c","name":"Ste?","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"up","vt":"str"},{"t":"cont","v":"down","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":760,"y":500,"wires":[["d46e3e1f0c3f672b"],["5c6651bd9d231831"]]},{"id":"604c2e5b40e35943","type":"switch","z":"933f5581a37dd52c","name":"Command?","property":"payload","propertyType":"msg","rules":[{"t":"regex","v":"(up_press$|down_press$)","vt":"str","case":true},{"t":"eq","v":"off_press","vt":"str"},{"t":"eq","v":"on_press","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":610,"y":520,"wires":[["ca31fb2d54aeeabd"],["97a3057cac8a6407"],["df7bc71760bdb52a"]]},{"id":"61324482911d6fe5","type":"delay","z":"933f5581a37dd52c","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":2020,"y":660,"wires":[["74dfe04a388c11fe","b2e71a0dd8285867","21d342f5e6f65e21"]]},{"id":"951e41f7fe8a8d19","type":"debug","z":"933f5581a37dd52c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"count","targetType":"msg","statusVal":"","statusType":"auto","x":1840,"y":540,"wires":[]},{"id":"74dfe04a388c11fe","type":"switch","z":"933f5581a37dd52c","name":"Where?","property":"location","propertyType":"msg","rules":[{"t":"cont","v":"bedroom","vt":"str"},{"t":"cont","v":"not_home","vt":"str"},{"t":"cont","v":"hotbox","vt":"str"},{"t":"cont","v":"livingroom","vt":"str"},{"t":"cont","v":"kitchen","vt":"str"},{"t":"cont","v":"patio","vt":"str"},{"t":"cont","v":"bathroom","vt":"str"}],"checkall":"false","repair":false,"outputs":7,"x":2170,"y":660,"wires":[["b707b1f3fac181dd","a2582ee0170c26ce"],["b707b1f3fac181dd","a2582ee0170c26ce"],["1647a17ed447b30c"],["c2dba062682cb223","e995b61ee5af4baa"],["e4404a46e419386e"],["4401ad2a0d09eb11"],["ad72f1db01fb1844"]]},{"id":"7af7d3b7a473b57a","type":"debug","z":"933f5581a37dd52c","name":"first","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":610,"y":400,"wires":[]},{"id":"f2eeb853583688c7","type":"api-current-state","z":"933f5581a37dd52c","name":"MAxi speakers","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.group_maxi_speakers","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1920,"y":340,"wires":[["1ff72288c10be7af"],["f5a4259b583436d3"]]},{"id":"b707b1f3fac181dd","type":"switch","z":"933f5581a37dd52c","name":"Actions","property":"command","propertyType":"msg","rules":[{"t":"cont","v":"on","vt":"str"},{"t":"cont","v":"off","vt":"str"}],"checkall":"false","repair":true,"outputs":2,"x":2360,"y":180,"wires":[["73f8126b172d8d24"],["b96918d98aa8f0a6"]]},{"id":"5b84962a20066e47","type":"api-current-state","z":"933f5581a37dd52c","name":"HotboxStop","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.hotbox_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2210,"y":480,"wires":[["d6f487fa60b6b303"],["b358f4d5d4f57d8d"]]},{"id":"8dedf648b9898060","type":"api-current-state","z":"933f5581a37dd52c","name":"LVSpeakerW","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.living_room_window_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2230,"y":1040,"wires":[["24a77a57aa08f003"],["4b0a76d25e54223a"]]},{"id":"e4404a46e419386e","type":"api-current-state","z":"933f5581a37dd52c","name":"KitchenSpeaker","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.kitchen_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2240,"y":1140,"wires":[["414d8b86396a73d2"],["7bfb04403e75cd9c"]]},{"id":"4401ad2a0d09eb11","type":"api-current-state","z":"933f5581a37dd52c","name":"ServerS","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.server_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2220,"y":1240,"wires":[["df7ff12e363fec3e"],["705c9de52ee23f35"]]},{"id":"ad72f1db01fb1844","type":"api-current-state","z":"933f5581a37dd52c","name":"BAthroomS","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.bathroom_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2210,"y":1340,"wires":[["1082ee557bc692f7"],["9faa0d691663ceed"]]},{"id":"1ff72288c10be7af","type":"change","z":"933f5581a37dd52c","name":"maxi speakers","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.group_maxi_speakers\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":1920,"y":300,"wires":[["151f1963fecf0607"]]},{"id":"e16abcee378dd6d5","type":"api-current-state","z":"933f5581a37dd52c","name":"Dungeo?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.dungeon_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2240,"y":340,"wires":[["62c914e60d903899"],["adcfce4ade885675"]]},{"id":"73f8126b172d8d24","type":"switch","z":"933f5581a37dd52c","name":"presses","property":"pressamount","propertyType":"msg","rules":[{"t":"eq","v":"3","vt":"num"},{"t":"eq","v":"4","vt":"num"}],"checkall":"false","repair":true,"outputs":2,"x":2500,"y":160,"wires":[["62e8476ce51168b9"],["a38b3a45d7a24b40"]]},{"id":"b96918d98aa8f0a6","type":"switch","z":"933f5581a37dd52c","name":"presses","property":"pressamount","propertyType":"msg","rules":[{"t":"eq","v":"3","vt":"num"},{"t":"eq","v":"4","vt":"num"}],"checkall":"false","repair":true,"outputs":2,"x":2520,"y":200,"wires":[["a7769c85728b7eae"],["09917881fce29b61"]]},{"id":"d6f487fa60b6b303","type":"change","z":"933f5581a37dd52c","name":"HotboxSTop","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.hotbox_speaker\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2210,"y":440,"wires":[["052b675a64ed69b9"]]},{"id":"b358f4d5d4f57d8d","type":"api-current-state","z":"933f5581a37dd52c","name":"HotboxSdown","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.hotbox_down_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2380,"y":480,"wires":[["b315582540cef332"],["8bc0c8a92c54372e"]]},{"id":"24a77a57aa08f003","type":"change","z":"933f5581a37dd52c","name":"set entity","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.living_room_window_speaker\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2240,"y":1000,"wires":[["914fc6977ecda928"]]},{"id":"4b0a76d25e54223a","type":"api-current-state","z":"933f5581a37dd52c","name":"LVSpeakerTV","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.living_room_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2420,"y":1040,"wires":[["313761cbd8e8cc83"],["b683d3c5dc18c9e8"]]},{"id":"414d8b86396a73d2","type":"change","z":"933f5581a37dd52c","name":"set entity","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.kitchen_speaker\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2240,"y":1100,"wires":[["84e3d11a74d7b3f0"]]},{"id":"7bfb04403e75cd9c","type":"delay","z":"933f5581a37dd52c","name":"Lights","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":3100,"y":1140,"wires":[["724ea66aa6af5a85"]]},{"id":"df7ff12e363fec3e","type":"change","z":"933f5581a37dd52c","name":"set entity","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.server_speaker\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2240,"y":1200,"wires":[["58596053ccf4745a"]]},{"id":"705c9de52ee23f35","type":"api-current-state","z":"933f5581a37dd52c","name":"PatioTV","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.patio_chromecast","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2400,"y":1240,"wires":[["28387c6a2f2b3d0a"],["20ed761cdc12302b"]]},{"id":"1082ee557bc692f7","type":"change","z":"933f5581a37dd52c","name":"set entity","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.bathroom_speaker\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2220,"y":1300,"wires":[["8b57db222e735ddc"]]},{"id":"9faa0d691663ceed","type":"delay","z":"933f5581a37dd52c","name":"Lights","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":3090,"y":1340,"wires":[["724ea66aa6af5a85"]]},{"id":"151f1963fecf0607","type":"delay","z":"933f5581a37dd52c","name":"Action","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":2990,"y":300,"wires":[["df04f2923a255b17","dccde5863cfee895"]]},{"id":"62c914e60d903899","type":"change","z":"933f5581a37dd52c","name":"Dungeon","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.dungeon_speaker\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2240,"y":300,"wires":[["151f1963fecf0607"]]},{"id":"62e8476ce51168b9","type":"api-call-service","z":"933f5581a37dd52c","name":"Blind up","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"open_cover","areaId":[],"deviceId":[],"entityId":["cover.cover_bedroom_blinds"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2680,"y":100,"wires":[[]]},{"id":"ac394a05ef3653b0","type":"api-call-service","z":"933f5581a37dd52c","name":"screens on","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_on","areaId":[],"deviceId":[],"entityId":["switch.plug_bedroom_screens"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2970,"y":120,"wires":[[]]},{"id":"a7769c85728b7eae","type":"api-call-service","z":"933f5581a37dd52c","name":"Blind down","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"close_cover","areaId":[],"deviceId":[],"entityId":["cover.cover_bedroom_blinds"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2690,"y":180,"wires":[[]]},{"id":"60e8aefe4c72a2f8","type":"api-call-service","z":"933f5581a37dd52c","name":"Screens off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_off","areaId":[],"deviceId":[],"entityId":["switch.plug_bedroom_screens"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2890,"y":200,"wires":[[]]},{"id":"052b675a64ed69b9","type":"delay","z":"933f5581a37dd52c","name":"Action","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":3010,"y":440,"wires":[["a1fe8fca019a4242"]]},{"id":"b315582540cef332","type":"change","z":"933f5581a37dd52c","name":"HotboxSDown","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.hotbox_down_speaker\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2380,"y":440,"wires":[["052b675a64ed69b9"]]},{"id":"8bc0c8a92c54372e","type":"api-current-state","z":"933f5581a37dd52c","name":"HotboxTVT","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.hotbox_top_chromecast","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2550,"y":480,"wires":[["85bfd74a4b4cd3fd"],["76bf04d0a1ad960a"]]},{"id":"914fc6977ecda928","type":"delay","z":"933f5581a37dd52c","name":"Action","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":2790,"y":1000,"wires":[["68bfea40cb637c9b"]]},{"id":"313761cbd8e8cc83","type":"change","z":"933f5581a37dd52c","name":"set entity","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.living_room_speaker\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2420,"y":1000,"wires":[["914fc6977ecda928"]]},{"id":"b683d3c5dc18c9e8","type":"api-current-state","z":"933f5581a37dd52c","name":"LVTV","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.livingroom_chromecast","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2630,"y":1040,"wires":[["bdc231c126a0de02"],["edd8b7f18891ec17"]]},{"id":"84e3d11a74d7b3f0","type":"delay","z":"933f5581a37dd52c","name":"Action","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":2790,"y":1100,"wires":[["21e7c649df1f7f5b"]]},{"id":"cdbd2791507b6364","type":"switch","z":"933f5581a37dd52c","name":"Where?","property":"location","propertyType":"msg","rules":[{"t":"cont","v":"bedroom","vt":"str"},{"t":"cont","v":"not_home","vt":"str"},{"t":"cont","v":"hotbox","vt":"str"},{"t":"cont","v":"livingroom","vt":"str"},{"t":"cont","v":"kitchen","vt":"str"},{"t":"cont","v":"patio","vt":"str"},{"t":"cont","v":"Bathroom","vt":"str"}],"checkall":"false","repair":false,"outputs":7,"x":4080,"y":200,"wires":[["12238a713745a7d3"],["12238a713745a7d3"],["13f3f50c3d5ddd56"],["bbbcb77500e0c5cc"],["ad9dc8f13fc57340"],["d1dc4030bca8869d"],[]]},{"id":"58596053ccf4745a","type":"delay","z":"933f5581a37dd52c","name":"Action","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":2790,"y":1200,"wires":[["e7fd9fbdfdbfe732"]]},{"id":"28387c6a2f2b3d0a","type":"change","z":"933f5581a37dd52c","name":"set entity","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.patio_chromecast\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2420,"y":1200,"wires":[["58596053ccf4745a"]]},{"id":"20ed761cdc12302b","type":"delay","z":"933f5581a37dd52c","name":"Lights","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":3090,"y":1240,"wires":[["724ea66aa6af5a85"]]},{"id":"8b57db222e735ddc","type":"delay","z":"933f5581a37dd52c","name":"Action","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":2750,"y":1300,"wires":[["f4d96017c0b01350"]]},{"id":"9eefd3eaa566fef7","type":"switch","z":"933f5581a37dd52c","name":"Actions","property":"command","propertyType":"msg","rules":[{"t":"cont","v":"on","vt":"str"},{"t":"cont","v":"up","vt":"str"},{"t":"cont","v":"down","vt":"str"},{"t":"cont","v":"off","vt":"str"}],"checkall":"false","repair":true,"outputs":4,"x":3720,"y":340,"wires":[["7fbbd5b4666692af"],["74fe08d15056f7f9"],["8b64f3e84f712078"],["83daf28d1c4ca1b1"]]},{"id":"83578c147b05105f","type":"delay","z":"933f5581a37dd52c","name":"Lights","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":3250,"y":340,"wires":[["724ea66aa6af5a85"]]},{"id":"85bfd74a4b4cd3fd","type":"change","z":"933f5581a37dd52c","name":"HotboxTVT","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.hotbox_top_chromecast\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2550,"y":440,"wires":[["052b675a64ed69b9"]]},{"id":"8066eac7c4aa7d00","type":"change","z":"933f5581a37dd52c","name":"HotboxTVD","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.hotbox_down_chromecast\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2730,"y":440,"wires":[["052b675a64ed69b9"]]},{"id":"76bf04d0a1ad960a","type":"api-current-state","z":"933f5581a37dd52c","name":"HotboxTVD","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.hotbox_down_chromecast","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2710,"y":480,"wires":[["8066eac7c4aa7d00"],["781a8af1762ae28d"]]},{"id":"bdc231c126a0de02","type":"change","z":"933f5581a37dd52c","name":"set entity","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.livingroom_chromecast\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2640,"y":1000,"wires":[["914fc6977ecda928"]]},{"id":"edd8b7f18891ec17","type":"delay","z":"933f5581a37dd52c","name":"Lights","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":3100,"y":1040,"wires":[["724ea66aa6af5a85"]]},{"id":"30bcd364e3198e99","type":"delay","z":"933f5581a37dd52c","name":"Lights","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":3270,"y":480,"wires":[["724ea66aa6af5a85"]]},{"id":"12238a713745a7d3","type":"change","z":"933f5581a37dd52c","name":"Bedroom","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"light.bedroom_lights\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4260,"y":40,"wires":[["be1a1db6c15f316b"]]},{"id":"13f3f50c3d5ddd56","type":"change","z":"933f5581a37dd52c","name":"HotBox","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":[\"light.hotbox_lights\"]}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4260,"y":80,"wires":[["be1a1db6c15f316b","10e097f0fcce8cf3"]]},{"id":"bbbcb77500e0c5cc","type":"change","z":"933f5581a37dd52c","name":"LivingRo","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":[\"light.group_livingroom_lights\"]}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4260,"y":120,"wires":[["be1a1db6c15f316b"]]},{"id":"ad9dc8f13fc57340","type":"change","z":"933f5581a37dd52c","name":"Kitchen","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":[\"light.group_kitchen_lights\"]}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4260,"y":160,"wires":[["be1a1db6c15f316b"]]},{"id":"d1dc4030bca8869d","type":"change","z":"933f5581a37dd52c","name":"Patio","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"light.patio_lights\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4250,"y":200,"wires":[["be1a1db6c15f316b"]]},{"id":"7fbbd5b4666692af","type":"switch","z":"933f5581a37dd52c","name":"Actions","property":"pressamount","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"}],"checkall":"false","repair":true,"outputs":2,"x":3860,"y":200,"wires":[["f12a1e726663a65e"],["cdbd2791507b6364"]]},{"id":"74fe08d15056f7f9","type":"switch","z":"933f5581a37dd52c","name":"Actions","property":"pressamount","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"eq","v":"3","vt":"num"}],"checkall":"false","repair":true,"outputs":3,"x":3880,"y":320,"wires":[["b03644fb7ed5a0a7"],["cdbd2791507b6364"],["25a1023d6f9bbbb5"]]},{"id":"8b64f3e84f712078","type":"switch","z":"933f5581a37dd52c","name":"Actions","property":"pressamount","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"eq","v":"3","vt":"num"}],"checkall":"false","repair":true,"outputs":3,"x":3880,"y":380,"wires":[["d5a19c27e1b9b0ac","16f62f47e8cdb911"],["cdbd2791507b6364"],["c0edfd57e02ce14a"]]},{"id":"83daf28d1c4ca1b1","type":"switch","z":"933f5581a37dd52c","name":"Actions","property":"pressamount","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"eq","v":"5","vt":"str"}],"checkall":"false","repair":true,"outputs":3,"x":3880,"y":440,"wires":[["f6253b46f0db9687"],["cdbd2791507b6364"],["f76e0cc8cd2d017d"]]},{"id":"be1a1db6c15f316b","type":"switch","z":"933f5581a37dd52c","name":"","property":"command","propertyType":"msg","rules":[{"t":"cont","v":"on","vt":"str"},{"t":"cont","v":"up","vt":"str"},{"t":"cont","v":"down","vt":"str"},{"t":"cont","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":4470,"y":100,"wires":[["6450468126476966"],["d2471aaf5e8e7bcf"],["39c38bee6add2d84"],["ffde540b34cb55f0"]]},{"id":"10e097f0fcce8cf3","type":"debug","z":"933f5581a37dd52c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":4450,"y":180,"wires":[]},{"id":"f12a1e726663a65e","type":"api-call-service","z":"933f5581a37dd52c","name":"Play","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_play","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":3890,"y":100,"wires":[[]]},{"id":"4a87be609378f3f5","type":"api-call-service","z":"933f5581a37dd52c","name":"V. Up S","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_up","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":4540,"y":300,"wires":[[]]},{"id":"25a1023d6f9bbbb5","type":"api-call-service","z":"933f5581a37dd52c","name":"Skip","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_seek","areaId":[],"deviceId":[],"entityId":[],"data":"{\"seek_position\": \"100000\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":4080,"y":340,"wires":[[]]},{"id":"c0edfd57e02ce14a","type":"api-call-service","z":"933f5581a37dd52c","name":"Return Start","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_seek","areaId":[],"deviceId":[],"entityId":[],"data":"{\"seek_position\": \"0\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":4080,"y":420,"wires":[[]]},{"id":"f6253b46f0db9687","type":"api-call-service","z":"933f5581a37dd52c","name":"Pause","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_pause","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":4060,"y":460,"wires":[[]]},{"id":"6450468126476966","type":"api-call-service","z":"933f5581a37dd52c","name":"Lights on","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4660,"y":60,"wires":[[]]},{"id":"d2471aaf5e8e7bcf","type":"api-call-service","z":"933f5581a37dd52c","name":"Brigthen lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"brightness_step\":25}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4680,"y":100,"wires":[[]]},{"id":"39c38bee6add2d84","type":"api-call-service","z":"933f5581a37dd52c","name":"Dim lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"brightness_step\":-35}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4660,"y":140,"wires":[[]]},{"id":"ffde540b34cb55f0","type":"api-call-service","z":"933f5581a37dd52c","name":"Lights off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4660,"y":180,"wires":[[]]},{"id":"d4288f4d376996e0","type":"debug","z":"933f5581a37dd52c","name":"zero","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":390,"y":340,"wires":[]},{"id":"79b43bcb79bd80b6","type":"server-events","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":2,"eventType":"zha_event","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":170,"y":500,"wires":[["d4288f4d376996e0","df2e609cac6f2bc9"]]},{"id":"863b256ec1a3f635","type":"switch","z":"933f5581a37dd52c","name":"Device?","property":"payload.event.device_ieee","propertyType":"msg","rules":[{"t":"eq","v":"00:17:88:01:08:0b:50:a4","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":400,"y":480,"wires":[["604c2e5b40e35943","7af7d3b7a473b57a"]]},{"id":"724ea66aa6af5a85","type":"delay","z":"933f5581a37dd52c","name":"nothing playing","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":3400,"y":1100,"wires":[["402193bafafa31fa"]]},{"id":"1d56e1f478c25091","type":"switch","z":"933f5581a37dd52c","name":"","property":"command","propertyType":"msg","rules":[{"t":"cont","v":"on","vt":"str"},{"t":"cont","v":"up","vt":"str"},{"t":"cont","v":"down","vt":"str"},{"t":"cont","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":4490,"y":740,"wires":[["415b586c0a11b3c1"],["683de9d925eaa22c"],["5a870105b0009857"],["30cad5816ffb7638"]]},{"id":"402193bafafa31fa","type":"switch","z":"933f5581a37dd52c","name":"presses","property":"pressamount","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"eq","v":"3","vt":"num"}],"checkall":"false","repair":true,"outputs":3,"x":3580,"y":1100,"wires":[["fc31706c9e3efd4c"],["9f531ac1a1ac0866"],["e1bf20ae3d6a0604"]]},{"id":"415b586c0a11b3c1","type":"api-call-service","z":"933f5581a37dd52c","name":"Lights on","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4700,"y":700,"wires":[[]]},{"id":"683de9d925eaa22c","type":"api-call-service","z":"933f5581a37dd52c","name":"Brigthen lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"brightness_step\":25}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4740,"y":740,"wires":[[]]},{"id":"5a870105b0009857","type":"api-call-service","z":"933f5581a37dd52c","name":"Dim lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"brightness_step\":-35}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4720,"y":780,"wires":[[]]},{"id":"30cad5816ffb7638","type":"api-call-service","z":"933f5581a37dd52c","name":"Lights off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4720,"y":820,"wires":[[]]},{"id":"fc31706c9e3efd4c","type":"switch","z":"933f5581a37dd52c","name":"Where?","property":"location","propertyType":"msg","rules":[{"t":"cont","v":"bedroom","vt":"str"},{"t":"cont","v":"not_home","vt":"str"},{"t":"cont","v":"hotbox","vt":"str"},{"t":"cont","v":"livingroom","vt":"str"},{"t":"cont","v":"kitchen","vt":"str"},{"t":"cont","v":"patio","vt":"str"},{"t":"cont","v":"Bathroom","vt":"str"}],"checkall":"false","repair":false,"outputs":7,"x":3680,"y":800,"wires":[["82dd3a5580b0d082"],["82dd3a5580b0d082"],["a5b6699bfe0f922d"],["df3b0055085e994b"],["5c976a10d19c074b"],["93cc876515c41852"],[]]},{"id":"82dd3a5580b0d082","type":"change","z":"933f5581a37dd52c","name":"Bedroom","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"light.bedroom_lights\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4160,"y":680,"wires":[["1d56e1f478c25091"]]},{"id":"73e6cc8e0ab5755e","type":"change","z":"933f5581a37dd52c","name":"HotBox","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":[\"light.hotbox_lights\"]}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4160,"y":720,"wires":[["1d56e1f478c25091"]]},{"id":"df3b0055085e994b","type":"change","z":"933f5581a37dd52c","name":"LivingRo","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":[\"light.group_livingroom_lights\"]}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4160,"y":840,"wires":[["1d56e1f478c25091"]]},{"id":"5c976a10d19c074b","type":"change","z":"933f5581a37dd52c","name":"Kitchen","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":[\"light.group_kitchen_lights\"]}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4160,"y":880,"wires":[["1d56e1f478c25091"]]},{"id":"129d0e159fd5f13d","type":"switch","z":"933f5581a37dd52c","name":"","property":"command","propertyType":"msg","rules":[{"t":"cont","v":"on","vt":"str"},{"t":"cont","v":"up","vt":"str"},{"t":"cont","v":"down","vt":"str"},{"t":"cont","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":3940,"y":1400,"wires":[["fd98a3ac705891b0"],["b6dfe6d848d06f88"],["42e075e61f0fb471"],["7f41aa7dbb329c58"]]},{"id":"e22054d6381f3c14","type":"api-call-service","z":"933f5581a37dd52c","name":"White llights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"rgb_color\":[255,255,254]}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4870,"y":1300,"wires":[[]]},{"id":"9f531ac1a1ac0866","type":"switch","z":"933f5581a37dd52c","name":"Where?","property":"location","propertyType":"msg","rules":[{"t":"cont","v":"bedroom","vt":"str"},{"t":"cont","v":"not_home","vt":"str"},{"t":"cont","v":"hotbox","vt":"str"},{"t":"cont","v":"livingroom","vt":"str"},{"t":"cont","v":"kitchen","vt":"str"},{"t":"cont","v":"patio","vt":"str"},{"t":"cont","v":"Bathroom","vt":"str"}],"checkall":"false","repair":false,"outputs":7,"x":3280,"y":1400,"wires":[["c35016dd0311dc27"],["c35016dd0311dc27"],["ec6d0bf5830c893d"],["6bfde0472099a9a5"],["546f54ecbb7541b9"],["19c1b2c9a8cea9a6"],[]]},{"id":"c35016dd0311dc27","type":"change","z":"933f5581a37dd52c","name":"Bedroom","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"light.bedroom_lights\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":3660,"y":1200,"wires":[["129d0e159fd5f13d"]]},{"id":"6bfde0472099a9a5","type":"change","z":"933f5581a37dd52c","name":"LivingRo","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"light.group_livingroom_lights\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":3720,"y":1620,"wires":[["129d0e159fd5f13d"]]},{"id":"546f54ecbb7541b9","type":"change","z":"933f5581a37dd52c","name":"Kitchen","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"light.group_kitchen_lights\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":3720,"y":1660,"wires":[["129d0e159fd5f13d"]]},{"id":"19c1b2c9a8cea9a6","type":"change","z":"933f5581a37dd52c","name":"Patio","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"light.patio_lights\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":3710,"y":1740,"wires":[["129d0e159fd5f13d"]]},{"id":"e0572274be13a226","type":"api-call-service","z":"933f5581a37dd52c","name":"Blue Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"color_name\":\"blue\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4880,"y":1380,"wires":[[]]},{"id":"e92151f1639963d9","type":"api-call-service","z":"933f5581a37dd52c","name":"Red lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"color_name\":\"red\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4890,"y":1420,"wires":[[]]},{"id":"3e7e886b757c00c5","type":"switch","z":"933f5581a37dd52c","name":"command","property":"command","propertyType":"msg","rules":[{"t":"cont","v":"up","vt":"str"},{"t":"cont","v":"down","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":4320,"y":1020,"wires":[["95e9b76895eb3bd0"],["073222aa71e6b594"]]},{"id":"95e9b76895eb3bd0","type":"api-call-service","z":"933f5581a37dd52c","name":"max brightness","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"brightness_pct\":100}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4520,"y":980,"wires":[[]]},{"id":"073222aa71e6b594","type":"api-call-service","z":"933f5581a37dd52c","name":"min brightness","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"brightness_pct\":15}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4520,"y":1020,"wires":[[]]},{"id":"1db201ee47af75e9","type":"debug","z":"933f5581a37dd52c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":4330,"y":1280,"wires":[]},{"id":"218d310468233972","type":"debug","z":"933f5581a37dd52c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2670,"y":60,"wires":[]},{"id":"e1bf20ae3d6a0604","type":"switch","z":"933f5581a37dd52c","name":"Where?","property":"location","propertyType":"msg","rules":[{"t":"cont","v":"bedroom","vt":"str"},{"t":"cont","v":"not_home","vt":"str"},{"t":"cont","v":"hotbox","vt":"str"},{"t":"cont","v":"livingroom","vt":"str"},{"t":"cont","v":"kitchen","vt":"str"},{"t":"cont","v":"patio","vt":"str"},{"t":"cont","v":"Bathroom","vt":"str"}],"checkall":"false","repair":false,"outputs":7,"x":3740,"y":1100,"wires":[["d9d68a6d04a397b5"],["d9d68a6d04a397b5"],["10717e5f8acdf484"],["11b4afcad2643e2e"],["1482fb6bd7ca4dd1"],["d1ce8de1add5048b"],[]]},{"id":"d9d68a6d04a397b5","type":"change","z":"933f5581a37dd52c","name":"Bedroom","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"light.bedroom_lights\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":3960,"y":940,"wires":[["3e7e886b757c00c5"]]},{"id":"9387ad217245a486","type":"debug","z":"933f5581a37dd52c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":4470,"y":1180,"wires":[]},{"id":"5fa1a67bc9eb83bc","type":"api-current-state","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"color","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":4310,"y":1340,"wires":[["27cf8b28a2d8f366","9387ad217245a486"]]},{"id":"fd98a3ac705891b0","type":"change","z":"933f5581a37dd52c","name":"set id to curent state","rules":[{"t":"set","p":"payload.entity_id","pt":"msg","to":"payload.data.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":4110,"y":1340,"wires":[["5fa1a67bc9eb83bc","1db201ee47af75e9"]]},{"id":"5b1f1212c8df2317","type":"switch","z":"933f5581a37dd52c","name":"","property":"color","propertyType":"msg","rules":[{"t":"neq","v":"white","vt":"str"},{"t":"eq","v":"white","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":4680,"y":1340,"wires":[["e22054d6381f3c14"],["9557fc2fce9cd7c9"]]},{"id":"27cf8b28a2d8f366","type":"function","z":"933f5581a37dd52c","name":"color","func":"var color1 = msg.color.attributes.rgb_color[0];\nvar color2 = msg.color.attributes.rgb_color[1];\nvar color3 = msg.color.attributes.rgb_color[2];\n\nif (color1 == 255 && color2 > 253 && color3 > 253){\n    var newColor = \"white\";\n} else {\n    var newColor = \"other\";\n}\n\nvar newMsg = {\n    \"color\": newColor,\n    \"payload\": {\n        \"data\": {\n            \"entity_id\": msg.payload.entity_id\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"x":4460,"y":1340,"wires":[["5b1f1212c8df2317"]]},{"id":"9557fc2fce9cd7c9","type":"api-call-service","z":"933f5581a37dd52c","name":"Purple lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"color_name\":\"purple\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4880,"y":1340,"wires":[[]]},{"id":"5e8f30045c48db75","type":"function","z":"933f5581a37dd52c","name":"color","func":"var color1 = msg.color.attributes.rgb_color[0];\nvar color2 = msg.color.attributes.rgb_color[1];\nvar color3 = msg.color.attributes.rgb_color[2];\n\nif (color1 == 0 && color2 == 0 && color3 == 255){\n    var newColor = \"blue\";\n} else {\n    var newColor = \"other\";\n}\n\nvar newMsg = {\n    \"color\": newColor,\n    \"payload\": {\n        \"data\": {\n            \"entity_id\": msg.payload.entity_id\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"x":4480,"y":1380,"wires":[["202884616f111b24"]]},{"id":"2c2abdddfbc0711a","type":"api-current-state","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"color","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":4330,"y":1380,"wires":[["5e8f30045c48db75"]]},{"id":"b6dfe6d848d06f88","type":"change","z":"933f5581a37dd52c","name":"set id to curent state","rules":[{"t":"set","p":"payload.entity_id","pt":"msg","to":"payload.data.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":4130,"y":1380,"wires":[["2c2abdddfbc0711a"]]},{"id":"202884616f111b24","type":"switch","z":"933f5581a37dd52c","name":"","property":"color","propertyType":"msg","rules":[{"t":"neq","v":"blue","vt":"str"},{"t":"eq","v":"blue","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":4680,"y":1380,"wires":[["e0572274be13a226"],["e92151f1639963d9"]]},{"id":"292d7f6f3caa6434","type":"function","z":"933f5581a37dd52c","name":"color","func":"var color1 = msg.color.attributes.rgb_color[0];\nvar color2 = msg.color.attributes.rgb_color[1];\nvar color3 = msg.color.attributes.rgb_color[2];\n\nif (color1 == 0 && color2 == 255 && color3 == 0){\n    var newColor = \"green\";\n} else {\n    var newColor = \"other\";\n}\n\nvar newMsg = {\n    \"color\": newColor,\n    \"payload\": {\n        \"data\": {\n            \"entity_id\": msg.payload.entity_id\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"x":4480,"y":1420,"wires":[["f8a10790959005a7"]]},{"id":"9c5d35dc9afb6e05","type":"api-current-state","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"color","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":4330,"y":1420,"wires":[["292d7f6f3caa6434"]]},{"id":"42e075e61f0fb471","type":"change","z":"933f5581a37dd52c","name":"set id to curent state","rules":[{"t":"set","p":"payload.entity_id","pt":"msg","to":"payload.data.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":4130,"y":1420,"wires":[["9c5d35dc9afb6e05"]]},{"id":"f8a10790959005a7","type":"switch","z":"933f5581a37dd52c","name":"","property":"color","propertyType":"msg","rules":[{"t":"neq","v":"green","vt":"str"},{"t":"eq","v":"green","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":4680,"y":1420,"wires":[["ec3c972c6d927aac"],["e2848bde55d1f9f1"]]},{"id":"ec3c972c6d927aac","type":"api-call-service","z":"933f5581a37dd52c","name":"GReen Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"color_name\":\"green\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4890,"y":1460,"wires":[[]]},{"id":"e2848bde55d1f9f1","type":"api-call-service","z":"933f5581a37dd52c","name":"Orange Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"color_name\":\"orange\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4890,"y":1500,"wires":[[]]},{"id":"e8e46105b41b3a9a","type":"function","z":"933f5581a37dd52c","name":"color","func":"var color1 = msg.color.attributes.rgb_color[0];\nvar color2 = msg.color.attributes.rgb_color[1];\nvar color3 = msg.color.attributes.rgb_color[2];\n\nif (color1 == 255 && color2 == 254 && color3 == 0){\n    var newColor = \"yellow\";\n} else {\n    var newColor = \"other\";\n}\n\nvar newMsg = {\n    \"color\": newColor,\n    \"payload\": {\n        \"data\": {\n            \"entity_id\": msg.payload.entity_id\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"x":4460,"y":1460,"wires":[["e02feedc6dd55006"]]},{"id":"7d58407886870164","type":"api-current-state","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"color","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":4310,"y":1460,"wires":[["e8e46105b41b3a9a"]]},{"id":"7f41aa7dbb329c58","type":"change","z":"933f5581a37dd52c","name":"set id to curent state","rules":[{"t":"set","p":"payload.entity_id","pt":"msg","to":"payload.data.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":4110,"y":1460,"wires":[["7d58407886870164"]]},{"id":"e02feedc6dd55006","type":"switch","z":"933f5581a37dd52c","name":"","property":"color","propertyType":"msg","rules":[{"t":"neq","v":"yellow","vt":"str"},{"t":"eq","v":"yellow","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":4660,"y":1460,"wires":[["1a60ab6e73ef32be"],["1a27ecc6dd71e9dc"]]},{"id":"1a60ab6e73ef32be","type":"api-call-service","z":"933f5581a37dd52c","name":"Yellow Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"color_name\":\"yellow\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4880,"y":1540,"wires":[[]]},{"id":"1a27ecc6dd71e9dc","type":"api-call-service","z":"933f5581a37dd52c","name":"Cyan Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"color_name\":\"cyan\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4880,"y":1580,"wires":[[]]},{"id":"c2dba062682cb223","type":"switch","z":"933f5581a37dd52c","name":"Actions","property":"command","propertyType":"msg","rules":[{"t":"cont","v":"on","vt":"str"},{"t":"cont","v":"off","vt":"str"}],"checkall":"false","repair":true,"outputs":2,"x":2140,"y":1480,"wires":[["ffd0725108893f9d"],["617c026b75c3778f"]]},{"id":"ffd0725108893f9d","type":"switch","z":"933f5581a37dd52c","name":"presses","property":"pressamount","propertyType":"msg","rules":[{"t":"eq","v":"3","vt":"num"}],"checkall":"false","repair":true,"outputs":1,"x":2290,"y":1460,"wires":[["0398039eb15e1c07"]]},{"id":"617c026b75c3778f","type":"switch","z":"933f5581a37dd52c","name":"presses","property":"pressamount","propertyType":"msg","rules":[{"t":"eq","v":"3","vt":"num"}],"checkall":"false","repair":true,"outputs":1,"x":2290,"y":1500,"wires":[["087bf42020cb8863"]]},{"id":"0398039eb15e1c07","type":"api-call-service","z":"933f5581a37dd52c","name":"Blind up","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"open_cover","areaId":[],"deviceId":[],"entityId":["cover.cover_livingroom_blinds"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2440,"y":1420,"wires":[[]]},{"id":"087bf42020cb8863","type":"api-call-service","z":"933f5581a37dd52c","name":"Blind down","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"close_cover","areaId":[],"deviceId":[],"entityId":["cover.cover_livingroom_blinds"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2450,"y":1520,"wires":[[]]},{"id":"1647a17ed447b30c","type":"api-current-state","z":"933f5581a37dd52c","name":"Hotbox All","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.hotbox_all_motion","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2200,"y":560,"wires":[["5b84962a20066e47"],["51a76b6602405a82","ffb68f3707abf0e3","581ebb5cf099c918"]]},{"id":"51a76b6602405a82","type":"api-current-state","z":"933f5581a37dd52c","name":"Hotbox down","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_hotbox_down_motion_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2370,"y":560,"wires":[["b0b9d04943f68623"],[]]},{"id":"ffb68f3707abf0e3","type":"api-current-state","z":"933f5581a37dd52c","name":"Hotbox top","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"re","halt_if_compare":"is","entity_id":"binary_sensor.sensor_hotbox_top_motion_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2370,"y":640,"wires":[["b7903b29297cb7c3"],[]]},{"id":"b7903b29297cb7c3","type":"api-current-state","z":"933f5581a37dd52c","name":"HotboxSTop","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.hotbox_top_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2650,"y":640,"wires":[["5506f7a94bc38fbd"],["423a3a80c7d51c6a"]]},{"id":"5506f7a94bc38fbd","type":"change","z":"933f5581a37dd52c","name":"HotboxSTop","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.hotbox_top_speaker\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2670,"y":600,"wires":[["052b675a64ed69b9"]]},{"id":"423a3a80c7d51c6a","type":"api-current-state","z":"933f5581a37dd52c","name":"HotboxTVT","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.hotbox_top_chromecast","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2850,"y":640,"wires":[["78103ca545a622d3"],["cdb28576d5def68c"]]},{"id":"78103ca545a622d3","type":"change","z":"933f5581a37dd52c","name":"HotboxTVT","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.hotbox_top_chromecast\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2850,"y":600,"wires":[["052b675a64ed69b9"]]},{"id":"b0b9d04943f68623","type":"api-current-state","z":"933f5581a37dd52c","name":"HotboxSdown","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.hotbox_down_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2660,"y":560,"wires":[["dc4299a23c2a4e46"],["f36672bd390783a9"]]},{"id":"dc4299a23c2a4e46","type":"change","z":"933f5581a37dd52c","name":"HotboxSDown","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.hotbox_down_speaker\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2680,"y":520,"wires":[["052b675a64ed69b9"]]},{"id":"a25bffbc4855260a","type":"change","z":"933f5581a37dd52c","name":"HotboxTVD","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.hotbox_tv_down\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2890,"y":520,"wires":[["052b675a64ed69b9"]]},{"id":"f36672bd390783a9","type":"api-current-state","z":"933f5581a37dd52c","name":"HotboxTVD","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.hotbox_tv_down","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2890,"y":560,"wires":[["a25bffbc4855260a"],["30bcd364e3198e99"]]},{"id":"a5b6699bfe0f922d","type":"api-current-state","z":"933f5581a37dd52c","name":"Hotbox All","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.hotbox_all_motion","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3950,"y":680,"wires":[["73e6cc8e0ab5755e"],["c0c772c74f2b852d","34d136b561342338","7fb674527598e2a0"]]},{"id":"c0c772c74f2b852d","type":"api-current-state","z":"933f5581a37dd52c","name":"Hotbox down","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_hotbox_down_motion_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3950,"y":720,"wires":[["e488e7ddc9e91922"],[]]},{"id":"34d136b561342338","type":"api-current-state","z":"933f5581a37dd52c","name":"Hotbox top","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_hotbox_top_motion_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3950,"y":760,"wires":[["d794132106f5c5bd"],[]]},{"id":"e488e7ddc9e91922","type":"change","z":"933f5581a37dd52c","name":"HotBox Down","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":[\"light.hotbox_bottom\"]}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4160,"y":760,"wires":[["1d56e1f478c25091"]]},{"id":"d794132106f5c5bd","type":"change","z":"933f5581a37dd52c","name":"HotBox Wall","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":[\"light.hotbox_wall\"]}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4150,"y":800,"wires":[["1d56e1f478c25091"]]},{"id":"8551d9f779976121","type":"change","z":"933f5581a37dd52c","name":"HotBox","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"light.hotbox_lights\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4120,"y":980,"wires":[["3e7e886b757c00c5"]]},{"id":"10717e5f8acdf484","type":"api-current-state","z":"933f5581a37dd52c","name":"Hotbox All","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.hotbox_all_motion","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3970,"y":980,"wires":[["8551d9f779976121"],["cd1f42701c73dde3","ef6262914d8cee8c","5ed346859afeb599"]]},{"id":"cd1f42701c73dde3","type":"api-current-state","z":"933f5581a37dd52c","name":"Hotbox down","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_hotbox_down_motion_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3970,"y":1020,"wires":[["d299b602948e71f1"],[]]},{"id":"ef6262914d8cee8c","type":"api-current-state","z":"933f5581a37dd52c","name":"Hotbox top","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_hotbox_top_motion_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3970,"y":1060,"wires":[["aed37ccc5c27d0b7"],[]]},{"id":"d299b602948e71f1","type":"change","z":"933f5581a37dd52c","name":"HotBox bottom","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":[\"light.hotbox_bottom\"]}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4140,"y":1020,"wires":[["3e7e886b757c00c5"]]},{"id":"aed37ccc5c27d0b7","type":"change","z":"933f5581a37dd52c","name":"HotBox Wall","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":[\"light.hotbox_wall\"]}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4130,"y":1060,"wires":[["3e7e886b757c00c5"]]},{"id":"6598aad34bf0df46","type":"change","z":"933f5581a37dd52c","name":"HotBox","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"light.hotbox_lights\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":3740,"y":1360,"wires":[["129d0e159fd5f13d"]]},{"id":"ec6d0bf5830c893d","type":"api-current-state","z":"933f5581a37dd52c","name":"Hotbox All","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.hotbox_all_motion","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3550,"y":1300,"wires":[["6598aad34bf0df46"],["68663f890f19c125","058be30ba6012a36","eecb21cc68d3ae23"]]},{"id":"68663f890f19c125","type":"api-current-state","z":"933f5581a37dd52c","name":"Hotbox down","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_hotbox_down_motion_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3540,"y":1360,"wires":[["466f36fddb898c5e"],[]]},{"id":"058be30ba6012a36","type":"api-current-state","z":"933f5581a37dd52c","name":"Hotbox top","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_hotbox_top_motion_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3550,"y":1420,"wires":[["40226fc4fbaf4bd0"],[]]},{"id":"466f36fddb898c5e","type":"change","z":"933f5581a37dd52c","name":"HotBox Down","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"light.hotbox_bottom\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":3760,"y":1400,"wires":[["129d0e159fd5f13d"]]},{"id":"40226fc4fbaf4bd0","type":"change","z":"933f5581a37dd52c","name":"HotBox Wall","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"light.hotbox_top\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":3750,"y":1440,"wires":[["129d0e159fd5f13d"]]},{"id":"7fb674527598e2a0","type":"api-current-state","z":"933f5581a37dd52c","name":"Hotbox All","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.hotbox_all_motion_off","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3920,"y":800,"wires":[["73e6cc8e0ab5755e"],[]]},{"id":"eecb21cc68d3ae23","type":"api-current-state","z":"933f5581a37dd52c","name":"Hotbox All","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.hotbox_all_motion_off","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3550,"y":1480,"wires":[["6598aad34bf0df46"],[]]},{"id":"5ed346859afeb599","type":"api-current-state","z":"933f5581a37dd52c","name":"Hotbox All","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.hotbox_all_motion_off","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3960,"y":1100,"wires":[["8551d9f779976121"],[]]},{"id":"581ebb5cf099c918","type":"api-current-state","z":"933f5581a37dd52c","name":"Hotbox All off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.hotbox_all_motion_off","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2370,"y":520,"wires":[["5b84962a20066e47"],[]]},{"id":"cd3cd4babc86066d","type":"change","z":"933f5581a37dd52c","name":"Roku","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.hotbox_top_roku\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2890,"y":440,"wires":[["052b675a64ed69b9"]]},{"id":"781a8af1762ae28d","type":"api-current-state","z":"933f5581a37dd52c","name":"Roku","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.hotbox_top_roku","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2890,"y":480,"wires":[["cd3cd4babc86066d"],["30bcd364e3198e99"]]},{"id":"39bdfcf9df08f913","type":"change","z":"933f5581a37dd52c","name":"Roku","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.hotbox_top_roku\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":3030,"y":600,"wires":[["052b675a64ed69b9"]]},{"id":"cdb28576d5def68c","type":"api-current-state","z":"933f5581a37dd52c","name":"Roku","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.hotbox_top_roku","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3030,"y":640,"wires":[["39bdfcf9df08f913"],["30bcd364e3198e99"]]},{"id":"4b04cb83c1b6a69a","type":"switch","z":"933f5581a37dd52c","name":"Actions","property":"command","propertyType":"msg","rules":[{"t":"cont","v":"on","vt":"str"},{"t":"cont","v":"off","vt":"str"}],"checkall":"false","repair":true,"outputs":2,"x":2440,"y":760,"wires":[["e872af90a11a4737"],["8313de7ac69b1eba"]]},{"id":"e872af90a11a4737","type":"switch","z":"933f5581a37dd52c","name":"presses","property":"pressamount","propertyType":"msg","rules":[{"t":"eq","v":"3","vt":"num"}],"checkall":"false","repair":true,"outputs":1,"x":2480,"y":880,"wires":[["624d74888ce1ee60"]]},{"id":"8313de7ac69b1eba","type":"switch","z":"933f5581a37dd52c","name":"presses","property":"pressamount","propertyType":"msg","rules":[{"t":"eq","v":"3","vt":"num"}],"checkall":"false","repair":true,"outputs":1,"x":2480,"y":920,"wires":[["0cedc729528b0cef"]]},{"id":"624d74888ce1ee60","type":"api-call-service","z":"933f5581a37dd52c","name":"Blind up","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"open_cover","areaId":[],"deviceId":[],"entityId":["cover.cover_bedroom_blinds"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2660,"y":820,"wires":[[]]},{"id":"0cedc729528b0cef","type":"api-call-service","z":"933f5581a37dd52c","name":"Blind down","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"close_cover","areaId":[],"deviceId":[],"entityId":["cover.cover_bedroom_blinds"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2670,"y":900,"wires":[[]]},{"id":"053cfa396de504ff","type":"change","z":"933f5581a37dd52c","name":"Five Press","rules":[{"t":"set","p":"pressamount","pt":"msg","to":"5","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1850,"y":740,"wires":[["61324482911d6fe5"]]},{"id":"f5a4259b583436d3","type":"api-current-state","z":"933f5581a37dd52c","name":"Bedroom","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.bedroom_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2100,"y":340,"wires":[["81a9490e44a9bfac"],["e16abcee378dd6d5"]]},{"id":"81a9490e44a9bfac","type":"change","z":"933f5581a37dd52c","name":"Bedroom","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.bedroom_speaker\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2100,"y":300,"wires":[["52b3fb4303059f0b","151f1963fecf0607"]]},{"id":"f76e0cc8cd2d017d","type":"api-call-service","z":"933f5581a37dd52c","name":"Stop all","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":4080,"y":500,"wires":[[]]},{"id":"1133dc8664a47a46","type":"change","z":"933f5581a37dd52c","name":"LivingRo","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":[\"light.livingroom_lights\"]}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2300,"y":4840,"wires":[["4fc88edc54a36fc8"]]},{"id":"72c1bb665309b3cb","type":"change","z":"933f5581a37dd52c","name":"HotBox","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":[\"light.hotbox_lights\"]}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2300,"y":4800,"wires":[["4fc88edc54a36fc8"]]},{"id":"ee9de7d8bd5208fa","type":"change","z":"933f5581a37dd52c","name":"Kitchen","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":[\"light.kitchen_lights\"]}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2300,"y":4880,"wires":[["4fc88edc54a36fc8"]]},{"id":"8fd7b3db2f45b8ea","type":"change","z":"933f5581a37dd52c","name":"closet","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.closet_speaker\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2290,"y":4920,"wires":[["4fc88edc54a36fc8"]]},{"id":"96ca10b1ca3f29e6","type":"change","z":"933f5581a37dd52c","name":"Bathroom","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"light.bathroom2\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2300,"y":4960,"wires":[["4fc88edc54a36fc8"]]},{"id":"69684ef70a7f7a9f","type":"api-current-state","z":"933f5581a37dd52c","name":"Fitbit","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"sensor.galaxywatch","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":1870,"y":4760,"wires":[[]]},{"id":"77eae8e725382dc6","type":"switch","z":"933f5581a37dd52c","name":"Where?","property":"data.state","propertyType":"msg","rules":[{"t":"cont","v":"Bedroom","vt":"str"},{"t":"cont","v":"Thierry","vt":"str"},{"t":"cont","v":"not_home","vt":"str"},{"t":"cont","v":"Hotbox","vt":"str"},{"t":"cont","v":"Chilling","vt":"str"},{"t":"cont","v":"Kitchen","vt":"str"},{"t":"cont","v":"Closet","vt":"str"},{"t":"cont","v":"Bathroom","vt":"str"}],"checkall":"false","repair":false,"outputs":8,"x":2120,"y":4760,"wires":[["eb29b1e737676b49"],["eb29b1e737676b49"],["eb29b1e737676b49"],["72c1bb665309b3cb"],["1133dc8664a47a46"],["ee9de7d8bd5208fa"],["8fd7b3db2f45b8ea"],["96ca10b1ca3f29e6"]]},{"id":"4fc88edc54a36fc8","type":"switch","z":"933f5581a37dd52c","name":"FAce","property":"face","propertyType":"msg","rules":[{"t":"cont","v":"1","vt":"str"},{"t":"cont","v":"2","vt":"str"},{"t":"cont","v":"3","vt":"str"},{"t":"cont","v":"4","vt":"str"},{"t":"cont","v":"5","vt":"str"},{"t":"cont","v":"6","vt":"str"}],"checkall":"false","repair":true,"outputs":6,"x":2590,"y":4740,"wires":[["1169b420975f1408"],["39b5b39fa69d3276"],["2f14b2fa8554a2b4"],["5ddf0121ccf8212d"],["ea63eadbe0be3af7"],["91b5510d79b97997"]]},{"id":"1169b420975f1408","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{ \"color_name\": \"white\" }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2970,"y":4720,"wires":[[]]},{"id":"39b5b39fa69d3276","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{ \"color_name\": \"green\" }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2970,"y":4760,"wires":[[]]},{"id":"2f14b2fa8554a2b4","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{ \"color_name\": \"blue\" }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2970,"y":4800,"wires":[[]]},{"id":"5ddf0121ccf8212d","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{ \"color_name\": \"purple\" }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2970,"y":4840,"wires":[[]]},{"id":"ea63eadbe0be3af7","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{ \"color_name\": \"orange\" }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2970,"y":4880,"wires":[[]]},{"id":"91b5510d79b97997","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{ \"color_name\": \"red\" }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2970,"y":4920,"wires":[[]]},{"id":"d4a03aecb1ab34ab","type":"change","z":"933f5581a37dd52c","name":"Face","rules":[{"t":"move","p":"payload.event.args.activated_face","pt":"msg","to":"face","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1730,"y":4760,"wires":[["69684ef70a7f7a9f"]]},{"id":"1a9ca0c6f0997847","type":"server-events","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":2,"eventType":"zha_event","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":1290,"y":4760,"wires":[["312c4df4513b4415"]]},{"id":"b8f4ecdac48219a7","type":"switch","z":"933f5581a37dd52c","name":"","property":"action","propertyType":"msg","rules":[{"t":"cont","v":"knock","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1590,"y":4760,"wires":[["d4a03aecb1ab34ab"]]},{"id":"312c4df4513b4415","type":"change","z":"933f5581a37dd52c","name":"Face","rules":[{"t":"move","p":"payload.event.command","pt":"msg","to":"action","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1470,"y":4760,"wires":[["b8f4ecdac48219a7"]]},{"id":"eb29b1e737676b49","type":"change","z":"933f5581a37dd52c","name":"Bedroom","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":[\"light.bedroom_lights\"]}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2300,"y":4740,"wires":[["4fc88edc54a36fc8"]]},{"id":"2aefc1df2c48cdb7","type":"delay","z":"933f5581a37dd52c","name":"Delay","pauseType":"delay","timeout":"1","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":1330,"y":3560,"wires":[["5cc0a0d3cda0b25f"]]},{"id":"8dfd22529cfa94a8","type":"trigger","z":"933f5581a37dd52c","name":"","op1":"","op2":"0","op1type":"nul","op2type":"str","duration":"800","extend":true,"units":"ms","reset":"","bytopic":"all","outputs":1,"x":1360,"y":3600,"wires":[["2aefc1df2c48cdb7","27c1d3402ba49810"]]},{"id":"5cc0a0d3cda0b25f","type":"change","z":"933f5581a37dd52c","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"foo","tot":"str"},{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1450,"y":3560,"wires":[["503fbd2688bac18d"]]},{"id":"6b2917f5844873db","type":"api-current-state","z":"933f5581a37dd52c","name":"Watch","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"sensor.galaxywatch","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"location","propertyType":"msg","value":"","valueType":"entityState"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":1190,"y":3500,"wires":[["8dfd22529cfa94a8","503fbd2688bac18d"]]},{"id":"27c1d3402ba49810","type":"switch","z":"933f5581a37dd52c","name":"count presses","property":"count","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"eq","v":"3","vt":"num"},{"t":"eq","v":"4","vt":"num"},{"t":"eq","v":"5","vt":"num"}],"checkall":"true","repair":false,"outputs":5,"x":1600,"y":3600,"wires":[["22d82bef9e825fe8"],["646be7329d496eba"],["b3b2b674ebbae71d"],["36a0aba78e9b37a8"],["adb66298764c6e84"]],"info":"Just expand the flow.count to how ever many\npresses you want/need."},{"id":"503fbd2688bac18d","type":"counter","z":"933f5581a37dd52c","name":"","init":"0","step":"1","lower":"","upper":"","mode":"increment","outputs":"1","x":1460,"y":3500,"wires":[["f13bcaaa665e4314"]]},{"id":"69df04f525caf170","type":"inject","z":"933f5581a37dd52c","name":"Reset","repeat":"","crontab":"","once":true,"onceDelay":"0.5","topic":"","payload":"","payloadType":"date","x":1330,"y":3460,"wires":[["5cc0a0d3cda0b25f"]]},{"id":"da1f598936d9e6cf","type":"change","z":"933f5581a37dd52c","name":"command","rules":[{"t":"set","p":"command","pt":"msg","to":"up","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1050,"y":3420,"wires":[["6b2917f5844873db"]]},{"id":"622da2e32be614fa","type":"change","z":"933f5581a37dd52c","name":"command","rules":[{"t":"set","p":"command","pt":"msg","to":"down","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1050,"y":3460,"wires":[["6b2917f5844873db"]]},{"id":"b57e915aa7772afc","type":"change","z":"933f5581a37dd52c","name":"command","rules":[{"t":"set","p":"command","pt":"msg","to":"off","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":950,"y":3500,"wires":[["6b2917f5844873db"]]},{"id":"96ef0aa933cdebc6","type":"change","z":"933f5581a37dd52c","name":"command","rules":[{"t":"set","p":"command","pt":"msg","to":"on","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":950,"y":3540,"wires":[["6b2917f5844873db"]]},{"id":"22d82bef9e825fe8","type":"change","z":"933f5581a37dd52c","name":"Single Press","rules":[{"t":"set","p":"pressamount","pt":"msg","to":"1","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1790,"y":3540,"wires":[["1ff779a565368865"]]},{"id":"646be7329d496eba","type":"change","z":"933f5581a37dd52c","name":"Double Press","rules":[{"t":"set","p":"pressamount","pt":"msg","to":"2","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1800,"y":3580,"wires":[["1ff779a565368865"]]},{"id":"b3b2b674ebbae71d","type":"change","z":"933f5581a37dd52c","name":"Triple Press","rules":[{"t":"set","p":"pressamount","pt":"msg","to":"3","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1790,"y":3620,"wires":[["1ff779a565368865"]]},{"id":"36a0aba78e9b37a8","type":"change","z":"933f5581a37dd52c","name":"Four Press","rules":[{"t":"set","p":"pressamount","pt":"msg","to":"4","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1790,"y":3660,"wires":[["1ff779a565368865"]]},{"id":"f13bcaaa665e4314","type":"change","z":"933f5581a37dd52c","name":"Flow set","rules":[{"t":"set","p":"count","pt":"flow","to":"count","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1600,"y":3500,"wires":[["17a545a209baf4f1"]]},{"id":"3968a9f7dd594e6e","type":"switch","z":"933f5581a37dd52c","name":"Ste?","property":"payload.event.args[0]","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"eq","v":"1","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":920,"y":3460,"wires":[["da1f598936d9e6cf"],["622da2e32be614fa"]]},{"id":"b98fe94a2627260e","type":"switch","z":"933f5581a37dd52c","name":"Command?","property":"payload.event.command","propertyType":"msg","rules":[{"t":"eq","v":"step","vt":"str"},{"t":"eq","v":"off_with_effect","vt":"str"},{"t":"eq","v":"on","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":770,"y":3480,"wires":[["3968a9f7dd594e6e"],["b57e915aa7772afc"],["96ef0aa933cdebc6"]]},{"id":"1ff779a565368865","type":"delay","z":"933f5581a37dd52c","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":1970,"y":3620,"wires":[[]]},{"id":"17a545a209baf4f1","type":"debug","z":"933f5581a37dd52c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"count","targetType":"msg","x":1790,"y":3500,"wires":[]},{"id":"0b53d52d13305844","type":"debug","z":"933f5581a37dd52c","name":"first","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":750,"y":3440,"wires":[]},{"id":"d71eeae0a1466a37","type":"debug","z":"933f5581a37dd52c","name":"zero","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":610,"y":3440,"wires":[]},{"id":"b826da6237edeb15","type":"server-events","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":2,"eventType":"zha_event","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":450,"y":3480,"wires":[["d71eeae0a1466a37","7e36a36b6f5330b3"]]},{"id":"7e36a36b6f5330b3","type":"switch","z":"933f5581a37dd52c","name":"Device?","property":"payload.event.device_ieee","propertyType":"msg","rules":[{"t":"eq","v":"00:17:88:01:08:0b:50:a4","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":620,"y":3480,"wires":[["b98fe94a2627260e","0b53d52d13305844"]]},{"id":"adb66298764c6e84","type":"change","z":"933f5581a37dd52c","name":"Five Press","rules":[{"t":"set","p":"pressamount","pt":"msg","to":"5","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1800,"y":3700,"wires":[["1ff779a565368865"]]},{"id":"2487f0c9129a879c","type":"api-current-state","z":"933f5581a37dd52c","name":"Plex","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.plex_media_player_desktop","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2470,"y":320,"wires":[["b9c29cf9eab7ae68"],["adcfce4ade885675"]]},{"id":"e7d4f105bb2e64f3","type":"api-current-state","z":"933f5581a37dd52c","name":"Roku","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.bedroom_roku","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2870,"y":340,"wires":[["9d3f95d97949fcad"],["83578c147b05105f"]]},{"id":"9d3f95d97949fcad","type":"change","z":"933f5581a37dd52c","name":"Roku","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.bedroom_roku\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2850,"y":300,"wires":[["151f1963fecf0607"]]},{"id":"384e8b92d0de16c5","type":"delay","z":"933f5581a37dd52c","name":"Stuff Playing","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":3430,"y":340,"wires":[["ee797e7b355bf40e","6f0583e9c09bf522"]]},{"id":"ee797e7b355bf40e","type":"change","z":"933f5581a37dd52c","name":"volume","rules":[{"t":"move","p":"data.entity.attributes.volume_level","pt":"msg","to":"volume","tot":"msg"},{"t":"delete","p":"data","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":3580,"y":340,"wires":[["9eefd3eaa566fef7"]]},{"id":"b9c29cf9eab7ae68","type":"change","z":"933f5581a37dd52c","name":"PLex","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.plex_media_player_desktop\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2470,"y":260,"wires":[["151f1963fecf0607"]]},{"id":"b03644fb7ed5a0a7","type":"switch","z":"933f5581a37dd52c","name":"Volume 1/>1","property":"volume","propertyType":"msg","rules":[{"t":"gt","v":".89","vt":"num"},{"t":"lt","v":".9","vt":"num"}],"checkall":"false","repair":true,"outputs":2,"x":4070,"y":300,"wires":[["0a1137bfb4f341a4"],["4a87be609378f3f5"]]},{"id":"0a1137bfb4f341a4","type":"switch","z":"933f5581a37dd52c","name":"Tv","property":"payload.data.entity_id","propertyType":"msg","rules":[{"t":"cont","v":"media_player.plex_pc","vt":"str"},{"t":"cont","v":"media_player.bedroom_chromecast","vt":"str"},{"t":"cont","v":"media_player.hotbox_tv","vt":"str"},{"t":"cont","v":"media_player.living_room_tv","vt":"str"},{"t":"nnull"}],"checkall":"false","repair":true,"outputs":5,"x":4210,"y":260,"wires":[["b9143e5b1397992b"],["b9143e5b1397992b"],["f99bfdefea729d0b"],["0814d7e1e73eea88"],["4a87be609378f3f5"]]},{"id":"b9143e5b1397992b","type":"change","z":"933f5581a37dd52c","name":"Roku","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.bedroom_tv\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4410,"y":220,"wires":[["4a87be609378f3f5"]]},{"id":"f99bfdefea729d0b","type":"change","z":"933f5581a37dd52c","name":"Roku","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.roku\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4390,"y":260,"wires":[["4a87be609378f3f5"]]},{"id":"0814d7e1e73eea88","type":"change","z":"933f5581a37dd52c","name":"Roku","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.living_room_lg_2\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4370,"y":300,"wires":[["4a87be609378f3f5"]]},{"id":"1967c3a6edfac1a5","type":"api-call-service","z":"933f5581a37dd52c","name":"V. down S","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_down","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":4760,"y":500,"wires":[["58f42177fbba5da6"]]},{"id":"d5a19c27e1b9b0ac","type":"switch","z":"933f5581a37dd52c","name":"Volume 0/<0","property":"volume","propertyType":"msg","rules":[{"t":"lt","v":"0.5","vt":"num"},{"t":"gte","v":"0.5","vt":"num"}],"checkall":"false","repair":true,"outputs":2,"x":4230,"y":380,"wires":[["43ded35c0dd311d0"],["1967c3a6edfac1a5"]]},{"id":"43ded35c0dd311d0","type":"switch","z":"933f5581a37dd52c","name":"Tv","property":"payload.data.entity_id","propertyType":"msg","rules":[{"t":"cont","v":"media_player.plex_pc","vt":"str"},{"t":"cont","v":"media_player.bedroom_chromecast","vt":"str"},{"t":"cont","v":"media_player.hotbox_tv","vt":"str"},{"t":"cont","v":"media_player.living_room_tv","vt":"str"},{"t":"nnull"}],"checkall":"false","repair":true,"outputs":5,"x":4370,"y":380,"wires":[["321d6b96f5f4c690"],["321d6b96f5f4c690"],["7a5ca9a2eb9f048d"],["28516e3d82e738ce"],["1967c3a6edfac1a5"]]},{"id":"321d6b96f5f4c690","type":"change","z":"933f5581a37dd52c","name":"Roku bedroom","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.bedroom_tv\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4560,"y":340,"wires":[["1967c3a6edfac1a5"]]},{"id":"7a5ca9a2eb9f048d","type":"change","z":"933f5581a37dd52c","name":"Roku Hotbox","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.roku\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4550,"y":380,"wires":[["1967c3a6edfac1a5"]]},{"id":"28516e3d82e738ce","type":"change","z":"933f5581a37dd52c","name":"Living room LG","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.living_room_lg\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4560,"y":420,"wires":[["1967c3a6edfac1a5"]]},{"id":"b2e71a0dd8285867","type":"switch","z":"933f5581a37dd52c","name":"Actions","property":"command","propertyType":"msg","rules":[{"t":"cont","v":"on","vt":"str"}],"checkall":"false","repair":true,"outputs":1,"x":1680,"y":840,"wires":[["e56fbd6fb90d7a6b"]]},{"id":"e56fbd6fb90d7a6b","type":"switch","z":"933f5581a37dd52c","name":"presses","property":"pressamount","propertyType":"msg","rules":[{"t":"eq","v":"5","vt":"num"}],"checkall":"false","repair":true,"outputs":1,"x":1840,"y":840,"wires":[["6fbc6fb0d2fce8e3"]]},{"id":"6fbc6fb0d2fce8e3","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"timer","service":"start","areaId":[],"deviceId":[],"entityId":["timer.five_click_delay"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2020,"y":840,"wires":[[]]},{"id":"0bde626db96121fd","type":"api-current-state","z":"933f5581a37dd52c","name":"option2","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"active","halt_if_type":"str","halt_if_compare":"is","entity_id":"timer.five_click_delay","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1940,"y":920,"wires":[[],[]]},{"id":"51db7308f80909d0","type":"inject","z":"933f5581a37dd52c","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1780,"y":900,"wires":[["0bde626db96121fd","6fbc6fb0d2fce8e3"]]},{"id":"68bfea40cb637c9b","type":"api-current-state","z":"933f5581a37dd52c","name":"option2","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"idle","halt_if_type":"str","halt_if_compare":"is","entity_id":"timer.five_click_delay","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2920,"y":1000,"wires":[["e1a754c7dbd81296"],["edd8b7f18891ec17"]]},{"id":"e1a754c7dbd81296","type":"delay","z":"933f5581a37dd52c","name":"Action","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":3090,"y":1000,"wires":[["384e8b92d0de16c5"]]},{"id":"df04f2923a255b17","type":"api-current-state","z":"933f5581a37dd52c","name":"option2","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"idle","halt_if_type":"str","halt_if_compare":"is","entity_id":"timer.five_click_delay","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3120,"y":300,"wires":[["6b1d895c5f9f10ac"],["83578c147b05105f"]]},{"id":"a1fe8fca019a4242","type":"api-current-state","z":"933f5581a37dd52c","name":"option2","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"idle","halt_if_type":"str","halt_if_compare":"is","entity_id":"timer.five_click_delay","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3140,"y":440,"wires":[["8c9ffa99c3a8f497"],["30bcd364e3198e99"]]},{"id":"21e7c649df1f7f5b","type":"api-current-state","z":"933f5581a37dd52c","name":"option2","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"idle","halt_if_type":"str","halt_if_compare":"is","entity_id":"timer.five_click_delay","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2940,"y":1100,"wires":[["5343f2709a089f77"],["7bfb04403e75cd9c"]]},{"id":"e7fd9fbdfdbfe732","type":"api-current-state","z":"933f5581a37dd52c","name":"option2","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"idle","halt_if_type":"str","halt_if_compare":"is","entity_id":"timer.five_click_delay","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2940,"y":1200,"wires":[["290472fdb98cf797"],["20ed761cdc12302b"]]},{"id":"f4d96017c0b01350","type":"api-current-state","z":"933f5581a37dd52c","name":"option2","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"idle","halt_if_type":"str","halt_if_compare":"is","entity_id":"timer.five_click_delay","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2920,"y":1300,"wires":[["58dcd0bc6f58f65a"],["9faa0d691663ceed"]]},{"id":"290472fdb98cf797","type":"delay","z":"933f5581a37dd52c","name":"Action","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":3090,"y":1200,"wires":[["384e8b92d0de16c5"]]},{"id":"58dcd0bc6f58f65a","type":"delay","z":"933f5581a37dd52c","name":"Action","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":3070,"y":1300,"wires":[["384e8b92d0de16c5"]]},{"id":"5343f2709a089f77","type":"delay","z":"933f5581a37dd52c","name":"Action","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":3090,"y":1100,"wires":[["384e8b92d0de16c5"]]},{"id":"8c9ffa99c3a8f497","type":"delay","z":"933f5581a37dd52c","name":"Action","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":3270,"y":440,"wires":[["384e8b92d0de16c5"]]},{"id":"6b1d895c5f9f10ac","type":"delay","z":"933f5581a37dd52c","name":"Action","pauseType":"delay","timeout":"0","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":3250,"y":300,"wires":[["384e8b92d0de16c5"]]},{"id":"21d342f5e6f65e21","type":"debug","z":"933f5581a37dd52c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2050,"y":780,"wires":[]},{"id":"adcfce4ade885675","type":"api-current-state","z":"933f5581a37dd52c","name":"Chromecast","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.bedroom_chromecast","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2690,"y":340,"wires":[["b1ccfc98fc48d36c"],["e7d4f105bb2e64f3"]]},{"id":"b1ccfc98fc48d36c","type":"change","z":"933f5581a37dd52c","name":"Chromecast","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.bedroom_chromecast\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2710,"y":300,"wires":[["151f1963fecf0607"]]},{"id":"09917881fce29b61","type":"api-current-state","z":"933f5581a37dd52c","name":"Screens","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"re","halt_if_compare":"is","entity_id":"switch.plug_bedroom_screens","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2680,"y":220,"wires":[["60e8aefe4c72a2f8"],["0db580fe5864f3e3"]]},{"id":"0db580fe5864f3e3","type":"api-call-service","z":"933f5581a37dd52c","name":"TV Off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":["media_player.bedroom_tv"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2870,"y":240,"wires":[[]]},{"id":"f236283a32820d91","type":"api-call-service","z":"933f5581a37dd52c","name":"TV On","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_on","areaId":[],"deviceId":[],"entityId":["media_player.bedroom_tv"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2930,"y":160,"wires":[[]]},{"id":"a38b3a45d7a24b40","type":"api-current-state","z":"933f5581a37dd52c","name":"Screens","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"re","halt_if_compare":"is","entity_id":"switch.plug_bedroom_screens","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2700,"y":140,"wires":[["ac394a05ef3653b0"],["f236283a32820d91"]]},{"id":"df2e609cac6f2bc9","type":"debug","z":"933f5581a37dd52c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":360,"y":640,"wires":[]},{"id":"58f42177fbba5da6","type":"debug","z":"933f5581a37dd52c","name":"hoy hgere","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":4420,"y":600,"wires":[]},{"id":"16f62f47e8cdb911","type":"debug","z":"933f5581a37dd52c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4280,"y":460,"wires":[]},{"id":"52b3fb4303059f0b","type":"debug","z":"933f5581a37dd52c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2220,"y":180,"wires":[]},{"id":"6f0583e9c09bf522","type":"debug","z":"933f5581a37dd52c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":3620,"y":240,"wires":[]},{"id":"dccde5863cfee895","type":"debug","z":"933f5581a37dd52c","name":"data","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3110,"y":180,"wires":[]},{"id":"d1ce8de1add5048b","type":"change","z":"933f5581a37dd52c","name":"Patio","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"light.patio_lights\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":3930,"y":1220,"wires":[["3e7e886b757c00c5"]]},{"id":"93cc876515c41852","type":"change","z":"933f5581a37dd52c","name":"Patio","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"light.patio_lights\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":4150,"y":920,"wires":[["1d56e1f478c25091"]]},{"id":"11b4afcad2643e2e","type":"change","z":"933f5581a37dd52c","name":"LivingRo","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"light.group_livingroom_lights\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":3980,"y":1140,"wires":[["3e7e886b757c00c5"]]},{"id":"1482fb6bd7ca4dd1","type":"change","z":"933f5581a37dd52c","name":"Kitchen","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"light.group_kitchen_lights\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":3980,"y":1180,"wires":[["3e7e886b757c00c5"]]},{"id":"2d8d6d2796fc6b02","type":"debug","z":"933f5581a37dd52c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":470,"y":300,"wires":[]},{"id":"78d65470dc05638f","type":"server-state-changed","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":1,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.remote_maxi_dimmer_action","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":190,"y":300,"wires":[["2d8d6d2796fc6b02"]]},{"id":"2cc83b9a6fe9febb","type":"mqtt in","z":"933f5581a37dd52c","name":"","topic":"zigbee2mqtt/remote_ikea_dial","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":120,"y":960,"wires":[[]]},{"id":"32505711f87bda11","type":"debug","z":"933f5581a37dd52c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":410,"y":880,"wires":[]},{"id":"776a8ebef16f1aac","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.bedroom_lights"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1250,"y":980,"wires":[["9937b3ec1d262f11"]]},{"id":"eb5d617dc72fac44","type":"change","z":"933f5581a37dd52c","name":"command","rules":[{"t":"move","p":"payload.brightness","pt":"msg","to":"payload.data.brightness","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":700,"y":960,"wires":[["d06aef76217953ea","6ac35973d7c049ea"]]},{"id":"6ac35973d7c049ea","type":"debug","z":"933f5581a37dd52c","name":"1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":859,"y":891,"wires":[]},{"id":"9937b3ec1d262f11","type":"debug","z":"933f5581a37dd52c","name":"2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1610,"y":1000,"wires":[]},{"id":"401ca565b25fb13d","type":"trigger","z":"933f5581a37dd52c","name":"","op1":"","op2":"0","op1type":"nul","op2type":"str","duration":"800","extend":true,"units":"ms","reset":"","bytopic":"all","outputs":1,"x":1300,"y":640,"wires":[["7eda3eb589b2ea8e","e251c8e0979fa2ac"]]},{"id":"94719e344c54c7a4","type":"switch","z":"933f5581a37dd52c","name":"Device?","property":"payload.action","propertyType":"msg","rules":[{"t":"neq","v":"toggle","vt":"str"},{"t":"eq","v":"toggle","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":520,"y":960,"wires":[["eb5d617dc72fac44"],["f91d0b008ef484ab"]]},{"id":"084b6cf2b359fa1f","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.bedroom_lights"],"data":"{\"brightness_pct\":\"100\"}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1090,"y":1040,"wires":[[]]},{"id":"72f1bd2daa8cf337","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.bedroom_lights"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1390,"y":920,"wires":[[]]},{"id":"d06aef76217953ea","type":"switch","z":"933f5581a37dd52c","name":"Device?","property":"payload.data.brightness","propertyType":"msg","rules":[{"t":"lt","v":"5","vt":"num"},{"t":"gte","v":"5","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":900,"y":960,"wires":[["08ba7ba6adf1f56a"],["776a8ebef16f1aac"]]},{"id":"08ba7ba6adf1f56a","type":"change","z":"933f5581a37dd52c","name":"command","rules":[{"t":"delete","p":"payload.data","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1060,"y":920,"wires":[["bf520346f7897afc"]]},{"id":"22697bf95c76c11d","type":"trigger","z":"933f5581a37dd52c","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"150","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":360,"y":960,"wires":[["94719e344c54c7a4"]]},{"id":"f91d0b008ef484ab","type":"trigger","z":"933f5581a37dd52c","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":540,"y":1000,"wires":[["601c267cee92a767"]]},{"id":"bf520346f7897afc","type":"trigger","z":"933f5581a37dd52c","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1220,"y":920,"wires":[["72f1bd2daa8cf337"]]},{"id":"601c267cee92a767","type":"api-current-state","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.bedroom_lights","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":700,"y":1060,"wires":[["084b6cf2b359fa1f"],["15951f24d6c2f9aa"]]},{"id":"15951f24d6c2f9aa","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.bedroom_lights"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1090,"y":1140,"wires":[[]]},{"id":"410609d9902f1294","type":"debug","z":"933f5581a37dd52c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":800,"wires":[]},{"id":"80581914c059e70b","type":"switch","z":"933f5581a37dd52c","name":"Device?","property":"payload.action","propertyType":"msg","rules":[{"t":"eq","v":"brightness_move_up","vt":"str"},{"t":"eq","v":"play_pause","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":389,"y":824,"wires":[["410609d9902f1294"],[]]},{"id":"a2582ee0170c26ce","type":"api-current-state","z":"933f5581a37dd52c","name":"Home Group","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.group_home_speakers","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1690,"y":340,"wires":[["7470b08118e4aea7"],["f2eeb853583688c7"]]},{"id":"7470b08118e4aea7","type":"change","z":"933f5581a37dd52c","name":"maxi speakers","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.group_maxi_speakers\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":1700,"y":300,"wires":[["151f1963fecf0607"]]},{"id":"e995b61ee5af4baa","type":"api-current-state","z":"933f5581a37dd52c","name":"LVSpeakers","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(playing|paused)","halt_if_type":"re","halt_if_compare":"is","entity_id":"media_player.group_living_room_speakers","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"data.entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2050,"y":1040,"wires":[["70341d6483dd7f3c"],["8dedf648b9898060"]]},{"id":"70341d6483dd7f3c","type":"change","z":"933f5581a37dd52c","name":"set entity","rules":[{"t":"set","p":"payload","pt":"msg","to":"{\"data\":{\"entity_id\":\"media_player.group_living_room_speakers\"}}","tot":"json"}],"action":"","property":"","from":"","to":"","reg":false,"x":2060,"y":1000,"wires":[["914fc6977ecda928"]]},{"id":"7a2bddfeffbf719d","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.bedroom_lights"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1630,"y":1240,"wires":[[]]},{"id":"0d4ce40e39cf5c72","type":"trigger","z":"933f5581a37dd52c","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1460,"y":1240,"wires":[["7a2bddfeffbf719d"]]},{"id":"f2f9311781176673","type":"change","z":"933f5581a37dd52c","name":"command","rules":[{"t":"delete","p":"payload.data","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1300,"y":1240,"wires":[["0d4ce40e39cf5c72"]]},{"id":"2f0210cdb84f9d63","type":"switch","z":"933f5581a37dd52c","name":"Device?","property":"payload.data.brightness","propertyType":"msg","rules":[{"t":"lt","v":"5","vt":"num"},{"t":"gte","v":"5","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1160,"y":1280,"wires":[["f2f9311781176673"],["18d6990371b0aae8"]]},{"id":"18d6990371b0aae8","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.bedroom_lights"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1490,"y":1300,"wires":[["1ec24ed38a64b403"]]},{"id":"48d6ca2327e1e096","type":"switch","z":"933f5581a37dd52c","name":"Device?","property":"payload.action","propertyType":"msg","rules":[{"t":"neq","v":"toggle","vt":"str"},{"t":"eq","v":"toggle","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":540,"y":1440,"wires":[["51cca52bb24630df"],["97f15f208e99080a"]]},{"id":"abe7e185c2c01538","type":"debug","z":"933f5581a37dd52c","name":"1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":930,"y":1300,"wires":[]},{"id":"1ec24ed38a64b403","type":"debug","z":"933f5581a37dd52c","name":"2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1850,"y":1320,"wires":[]},{"id":"e5b567c17d3cb0a2","type":"trigger","z":"933f5581a37dd52c","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":390,"y":1440,"wires":[["48d6ca2327e1e096"]]},{"id":"97f15f208e99080a","type":"trigger","z":"933f5581a37dd52c","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":620,"y":1480,"wires":[["32d8543abfecb3fe"]]},{"id":"e3852397348a4c3b","type":"mqtt in","z":"933f5581a37dd52c","name":"","topic":"zigbee2mqtt/remote_ikea_dial","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":120,"y":1440,"wires":[["943beb7c250b8384"]]},{"id":"32d8543abfecb3fe","type":"api-current-state","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.bedroom_lights","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":780,"y":1540,"wires":[["32fb2a3700a3ad59"],["35027b882431c5ca"]]},{"id":"1e99da6c8d1b5a84","type":"switch","z":"933f5581a37dd52c","name":"Device?","property":"payload.action","propertyType":"msg","rules":[{"t":"eq","v":"brightness_move_up","vt":"str"},{"t":"eq","v":"play_pause","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":389,"y":1304,"wires":[["df538d97941e5ebd"],[]]},{"id":"943beb7c250b8384","type":"debug","z":"933f5581a37dd52c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":410,"y":1340,"wires":[]},{"id":"32fb2a3700a3ad59","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.bedroom_lights"],"data":"{\"brightness_pct\":\"100\"}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1170,"y":1520,"wires":[[]]},{"id":"35027b882431c5ca","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.bedroom_lights"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1170,"y":1620,"wires":[[]]},{"id":"df538d97941e5ebd","type":"debug","z":"933f5581a37dd52c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":1280,"wires":[]},{"id":"ecabddfeb52b6782","type":"switch","z":"933f5581a37dd52c","name":"Command","property":"payload.action","propertyType":"msg","rules":[{"t":"eq","v":"brightness_move_up","vt":"str"},{"t":"eq","v":"brightness_move_down","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":870,"y":1420,"wires":[["e73a733b54de4469"],["59c8bb49365781b6"]]},{"id":"e73a733b54de4469","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.bedroom_lamp2_light"],"data":"{\"brightness_step_pct\":\"10\"}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1050,"y":1400,"wires":[[]]},{"id":"59c8bb49365781b6","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.bedroom_lamp2_light"],"data":"{\"brightness_step_pct\":\"-10\"}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1050,"y":1460,"wires":[[]]},{"id":"51cca52bb24630df","type":"trigger","z":"933f5581a37dd52c","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"500","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":700,"y":1360,"wires":[["ecabddfeb52b6782"]]},{"id":"20deda8f8b480aab","type":"server-state-changed","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":1,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.remote_phillips_tap_action","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":190,"y":2000,"wires":[["66e3f47ae7d12679","d5efbe75e4696a7e"]]},{"id":"66e3f47ae7d12679","type":"debug","z":"933f5581a37dd52c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":470,"y":1940,"wires":[]},{"id":"d5efbe75e4696a7e","type":"switch","z":"933f5581a37dd52c","name":"Command","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"press_1","vt":"str"},{"t":"eq","v":"press_2","vt":"str"},{"t":"eq","v":"press_3","vt":"str"},{"t":"eq","v":"press_4","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":510,"y":2000,"wires":[["c27b67d192564802"],["d3ce1563bea9ac19"],["bfe946629f5a60e0"],["7c8ea243bfaae384"]]},{"id":"c27b67d192564802","type":"api-call-service","z":"933f5581a37dd52c","name":"Lights on","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"toggle","areaId":[],"deviceId":[],"entityId":["light.bedroom_lights"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":860,"y":1900,"wires":[[]]},{"id":"7c8ea243bfaae384","type":"api-call-service","z":"933f5581a37dd52c","name":"Brigthen lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.bedroom_lights"],"data":"{\"brightness_step\":25}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":700,"y":2240,"wires":[[]]},{"id":"d3ce1563bea9ac19","type":"api-call-service","z":"933f5581a37dd52c","name":"Dim lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.bedroom_lights"],"data":"{\"brightness_step\":-35}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":740,"y":2000,"wires":[[]]},{"id":"fea5ddbb4ca0032b","type":"api-call-service","z":"933f5581a37dd52c","name":"Lightson ","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.bedroom_lights"],"data":"{\"brightness\":\"255\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1960,"y":2120,"wires":[[]]},{"id":"0345066f71f33d3c","type":"delay","z":"933f5581a37dd52c","name":"Delay","pauseType":"delay","timeout":"1","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":950,"y":2140,"wires":[["fcfbb9c93021b76f"]]},{"id":"fcfbb9c93021b76f","type":"change","z":"933f5581a37dd52c","name":"Reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"foo","tot":"str"},{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1130,"y":2140,"wires":[["51f21057e0bd4fe6"]]},{"id":"aebf1618b9fd68b9","type":"switch","z":"933f5581a37dd52c","name":"count presses","property":"count","propertyType":"flow","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"2","vt":"num"},{"t":"eq","v":"3","vt":"num"},{"t":"eq","v":"4","vt":"num"},{"t":"eq","v":"5","vt":"num"}],"checkall":"true","repair":false,"outputs":5,"x":1310,"y":2180,"wires":[["f4250fd878904db2"],["e1c92a245a8e616e"],["8b0c601185dff764"],["f91c8dc3cb72e916"],["b6ae8aea6851c5d6"]],"info":"Just expand the flow.count to how ever many\npresses you want/need."},{"id":"51f21057e0bd4fe6","type":"counter","z":"933f5581a37dd52c","name":"","init":"0","step":"1","lower":"","upper":"","mode":"increment","outputs":"1","x":1130,"y":2080,"wires":[["a1bb33762f63e248"]]},{"id":"e18c0877e733d58b","type":"inject","z":"933f5581a37dd52c","name":"Reset","repeat":"","crontab":"","once":true,"onceDelay":"0.5","topic":"","payload":"","payloadType":"date","x":950,"y":2100,"wires":[["fcfbb9c93021b76f"]]},{"id":"f4250fd878904db2","type":"change","z":"933f5581a37dd52c","name":"Single Press","rules":[{"t":"set","p":"pressamount","pt":"msg","to":"1","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1520,"y":2120,"wires":[["910922d2499bde3a"]]},{"id":"e1c92a245a8e616e","type":"change","z":"933f5581a37dd52c","name":"Double Press","rules":[{"t":"set","p":"pressamount","pt":"msg","to":"2","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1530,"y":2160,"wires":[[]]},{"id":"8b0c601185dff764","type":"change","z":"933f5581a37dd52c","name":"Triple Press","rules":[{"t":"set","p":"pressamount","pt":"msg","to":"3","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1520,"y":2200,"wires":[["1552707e460c5a04"]]},{"id":"f91c8dc3cb72e916","type":"change","z":"933f5581a37dd52c","name":"Four Press","rules":[{"t":"set","p":"pressamount","pt":"msg","to":"4","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1520,"y":2240,"wires":[["1552707e460c5a04"]]},{"id":"a1bb33762f63e248","type":"change","z":"933f5581a37dd52c","name":"Flow set","rules":[{"t":"set","p":"count","pt":"flow","to":"count","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1290,"y":2080,"wires":[["e962304395f19186"]]},{"id":"910922d2499bde3a","type":"delay","z":"933f5581a37dd52c","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"outputs":1,"x":1750,"y":2120,"wires":[["fea5ddbb4ca0032b"]]},{"id":"e962304395f19186","type":"debug","z":"933f5581a37dd52c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"count","targetType":"msg","statusVal":"","statusType":"auto","x":1520,"y":2080,"wires":[]},{"id":"b6ae8aea6851c5d6","type":"change","z":"933f5581a37dd52c","name":"Five Press","rules":[{"t":"set","p":"pressamount","pt":"msg","to":"5","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":1530,"y":2280,"wires":[["1552707e460c5a04"]]},{"id":"6cd22433ae5c4410","type":"trigger","z":"933f5581a37dd52c","name":"","op1":"","op2":"0","op1type":"nul","op2type":"str","duration":"999","extend":true,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":980,"y":2180,"wires":[["0345066f71f33d3c","aebf1618b9fd68b9"]]},{"id":"bfe946629f5a60e0","type":"trigger","z":"933f5581a37dd52c","name":"","op1":"","op2":"0","op1type":"nul","op2type":"str","duration":"1","extend":true,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":730,"y":2080,"wires":[["51f21057e0bd4fe6","6cd22433ae5c4410"]]},{"id":"c00d23ed8e7c4765","type":"api-call-service","z":"933f5581a37dd52c","name":"Lightson ","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.bedroom_lights"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2120,"y":2200,"wires":[["59f876eeba0c3824","617264b0da7792b3"]]},{"id":"1552707e460c5a04","type":"api-call-service","z":"933f5581a37dd52c","name":"Screens off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_off","areaId":[],"deviceId":[],"entityId":["switch.plug_bedroom_screens"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1790,"y":2200,"wires":[["3c17dce00dad3336"]]},{"id":"56dbb4172e68e11f","type":"api-call-service","z":"933f5581a37dd52c","name":"tv off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":["media_player.bedroom_roku"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2450,"y":2200,"wires":[[]]},{"id":"bc77330857b23826","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3250,"y":2140,"wires":[["82f3037dbdf4c18f"]]},{"id":"2e60ba2d2281d6db","type":"change","z":"933f5581a37dd52c","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"media_player.dungeon_speaker","tot":"str"},{"t":"set","p":"payload.data.media_content_id","pt":"msg","to":"url","tot":"msg"},{"t":"set","p":"payload.data.media_content_type","pt":"msg","to":"music","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":3000,"y":2140,"wires":[["bc77330857b23826"]]},{"id":"e6df7833b65ceed2","type":"api-call-service","z":"933f5581a37dd52c","name":"volume to 100%","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.dungeon_speaker"],"data":"{\"volume_level\":\"0.5\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3760,"y":2140,"wires":[[]]},{"id":"82f3037dbdf4c18f","type":"change","z":"933f5581a37dd52c","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":3540,"y":2140,"wires":[["e6df7833b65ceed2"]]},{"id":"c716ac613f65753d","type":"api-call-service","z":"933f5581a37dd52c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3250,"y":2220,"wires":[["6d965b3a11b2a290"]]},{"id":"6b5651fa187822fd","type":"change","z":"933f5581a37dd52c","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"media_player.bedroom_ceiling_speaker","tot":"str"},{"t":"set","p":"payload.data.media_content_id","pt":"msg","to":"url","tot":"msg"},{"t":"set","p":"payload.data.media_content_type","pt":"msg","to":"music","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2980,"y":2200,"wires":[["c716ac613f65753d"]]},{"id":"3a25d94217d2201a","type":"api-call-service","z":"933f5581a37dd52c","name":"volume to 100%","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bedroom_ceiling_speaker"],"data":"{\"volume_level\":\"0.4\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3760,"y":2180,"wires":[[]]},{"id":"6d965b3a11b2a290","type":"change","z":"933f5581a37dd52c","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":3540,"y":2180,"wires":[["3a25d94217d2201a"]]},{"id":"fd2aa1f7d864b5f3","type":"trigger","z":"933f5581a37dd52c","name":"","op1":"","op2":"","op1type":"str","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"min","reset":"open","bytopic":"all","topic":"topic","outputs":1,"x":2370,"y":2140,"wires":[["2e60ba2d2281d6db","6b5651fa187822fd"]]},{"id":"3c17dce00dad3336","type":"api-call-service","z":"933f5581a37dd52c","name":"tv off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":["media_player.bedroom_tv"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1950,"y":2200,"wires":[["c00d23ed8e7c4765"]]},{"id":"59f876eeba0c3824","type":"delay","z":"933f5581a37dd52c","name":"","pauseType":"delay","timeout":"10","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":2280,"y":2200,"wires":[["56dbb4172e68e11f"]]},{"id":"617264b0da7792b3","type":"change","z":"933f5581a37dd52c","name":"set url","rules":[{"t":"set","p":"url","pt":"msg","to":"http://192.168.0.15:8123/local/thunderstorm.mp4","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2250,"y":2160,"wires":[["fd2aa1f7d864b5f3"]]},{"id":"f7538e3f710d210e","type":"switch","z":"904d418a12e6a4b0","name":"click","property":"payload.event.command","propertyType":"msg","rules":[{"t":"regex","v":"click","vt":"str","case":true}],"checkall":"true","repair":false,"outputs":1,"x":190,"y":800,"wires":[["626d390b494bc86d","1cf2d343db1c089e","b07092e47615b45f"]]},{"id":"1fe47840b92e7438","type":"server-events","z":"904d418a12e6a4b0","name":"Ringer","server":"7ab5c227.a3ce8c","version":2,"eventType":"zha_event","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":50,"y":800,"wires":[["f7538e3f710d210e"]]},{"id":"23685ea64ad822fc","type":"trigger","z":"904d418a12e6a4b0","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"45","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":850,"y":780,"wires":[["150cd5e00c84aade","acdb4cbe807a4670","f3c7ce0f95a036c8"]]},{"id":"150cd5e00c84aade","type":"trigger","z":"904d418a12e6a4b0","name":"Snapshots","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1030,"y":780,"wires":[["90f8b95437a6b15f","1e8f53f8970447d0"]]},{"id":"11239223a67ab481","type":"inject","z":"904d418a12e6a4b0","name":"scan","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payloadType":"date","x":1310,"y":740,"wires":[["1e8f53f8970447d0","90f8b95437a6b15f"]]},{"id":"0f1732762ac40879","type":"switch","z":"904d418a12e6a4b0","name":"Recod Faces 1/0","property":"payload.recognized","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":2230,"y":740,"wires":[["e458126bd5641b2e"],["7013d7b5775bf756"]]},{"id":"725592b772d2f831","type":"api-current-state","z":"904d418a12e6a4b0","name":"party on?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.party_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2660,"y":720,"wires":[["1ab167e6d548ddec"],["bfa891ca7c805714"]]},{"id":"de700ffb416bffb9","type":"change","z":"904d418a12e6a4b0","name":"reset","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":3630,"y":280,"wires":[["f0ab80a27fc67e71"]]},{"id":"d3a54796c0c96850","type":"function","z":"904d418a12e6a4b0","name":"Name Payload","func":"var name = msg.payload.name;\n\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"value\": name\n        }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3700,"y":440,"wires":[["df56ee8f0c6bb231"]]},{"id":"bfa891ca7c805714","type":"api-current-state","z":"904d418a12e6a4b0","name":"Waiting Friend?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.waiting_someone","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2700,"y":760,"wires":[["1ab167e6d548ddec"],["67d7a5e70c4f1173"]]},{"id":"df56ee8f0c6bb231","type":"api-call-service","z":"904d418a12e6a4b0","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3930,"y":440,"wires":[[]]},{"id":"700116e39062929e","type":"api-call-service","z":"904d418a12e6a4b0","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4160,"y":320,"wires":[["aad8dfcf35a5f778"]]},{"id":"7caca54b79a292ef","type":"ha-wait-until","z":"904d418a12e6a4b0","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"binary_sensor.door_front_outside","entityIdFilterType":"exact","property":"state","comparator":"is","value":"on","valueType":"str","timeout":"30","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":4540,"y":300,"wires":[["e0c4c89638370ea1"],["e0c4c89638370ea1"]]},{"id":"e0c4c89638370ea1","type":"api-call-service","z":"904d418a12e6a4b0","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.waiting_someone"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4420,"y":380,"wires":[["4826327855dea551"]]},{"id":"4826327855dea551","type":"api-call-service","z":"904d418a12e6a4b0","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4520,"y":420,"wires":[["9df4fb50cafcd327"]]},{"id":"9df4fb50cafcd327","type":"function","z":"904d418a12e6a4b0","name":"Name Payload","func":"var newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"value\": \"UNKNOWN\"\n        }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4660,"y":360,"wires":[["20814234fdc77097"]]},{"id":"20814234fdc77097","type":"api-call-service","z":"904d418a12e6a4b0","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4870,"y":360,"wires":[[]]},{"id":"ba44446730be7bf1","type":"debug","z":"904d418a12e6a4b0","name":"Compare","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2140,"y":580,"wires":[]},{"id":"088cb81fd7b1e783","type":"debug","z":"904d418a12e6a4b0","name":"unlock","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4070,"y":380,"wires":[]},{"id":"67d7a5e70c4f1173","type":"trigger","z":"904d418a12e6a4b0","name":"Not waiting","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2790,"y":820,"wires":[["7546d4fa774773c7","e139f44c71b58e6e"]]},{"id":"3629533536809995","type":"change","z":"904d418a12e6a4b0","name":"reset","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2190,"y":1440,"wires":[["7e47c931d199b580","b265d8c4006cbefb","2a283d05b6b10ba0","0361e9a0a13608d3"]]},{"id":"7e47c931d199b580","type":"function","z":"904d418a12e6a4b0","name":"Javascript","func":"var recoface = [];\nvar facestring = \"\"\nvar d = new Date();\nvar m = d.getMilliseconds();\nvar url = \"https://hass.purgatoire.ca/local/ring.jpg?\" + m;\nvar facestring = msg.payload;\n\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n  \"message\": \"Someone is at the door but system crashed\",\n  \"data\": {\n    \"image\": url,\n    \"actions\": [\n      {\n        \"action\": \"unlock_door\",\n        \"title\": \"Unlock The Door\"\n      }\n                \n    ]\n  }\n}\n }\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2440,"y":1400,"wires":[["d4a93a044d2c8587"]]},{"id":"d4a93a044d2c8587","type":"api-call-service","z":"904d418a12e6a4b0","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2620,"y":1400,"wires":[[]]},{"id":"8737b486a882091c","type":"trigger","z":"904d418a12e6a4b0","name":"Crash","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2070,"y":1420,"wires":[["3629533536809995"]]},{"id":"b265d8c4006cbefb","type":"change","z":"904d418a12e6a4b0","name":"Set Data for mass alert","rules":[{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"},{"t":"set","p":"message","pt":"msg","to":"Someone is at the door","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2480,"y":1480,"wires":[["9ad961f55f0e53d5"]]},{"id":"9ad961f55f0e53d5","type":"link out","z":"904d418a12e6a4b0","name":"Light and Speakers","links":["45904ca6429d867d","ad88dbd2.4726b8","3405e943.fd3ee6","9cf42cf7ef60f645"],"x":2615,"y":1480,"wires":[]},{"id":"4ccc71fe76626676","type":"catch","z":"904d418a12e6a4b0","name":"","scope":["06ef254284bf7af3","1e8f53f8970447d0"],"uncaught":false,"x":1930,"y":1380,"wires":[["8737b486a882091c"]]},{"id":"f77a07bb408cd716","type":"function","z":"904d418a12e6a4b0","name":"Javascript","func":"var d = new Date();\nvar m = d.getMilliseconds();\nvar url = msg.image;\n\nvar url = url.replace(\"https:\\/\\/hass.purgatoire.ca\\/local\", \"\\/config\\/www\");\n\nvar newMsg = {\n \"name\": msg.payload.name,\n \"url\": \"http://192.168.0.14:3000/api/train/retrain/\" + msg.payload.name.toLowerCase(),\n \"data\":{\n    \"data\":{\n\t\"file_path\": url,\n\t\"name\": msg.payload.name.toLowerCase(),\n\t\"url\": \"http://192.168.0.14:3000/api/train/retrain/\" + msg.payload.name.toLowerCase()\n}}\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1720,"y":220,"wires":[["243b96d7cdc5d440","50d9fa7e7c3800e4"]]},{"id":"694f1010c55e9e17","type":"server-events","z":"904d418a12e6a4b0","name":"","server":"7ab5c227.a3ce8c","version":2,"eventType":"mobile_app_notification_action","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":950,"y":200,"wires":[["901b9e8cae5d66bb","6a2c4537d58a5c2f"]]},{"id":"243b96d7cdc5d440","type":"debug","z":"904d418a12e6a4b0","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1990,"y":140,"wires":[]},{"id":"14c699202031c457","type":"function","z":"904d418a12e6a4b0","name":"Javascript","func":"var d = new Date();\nvar m = d.getMilliseconds();\nvar url = msg.data.data.file_path;\n\n\nvar snapshot = url.replace(\"\\/config\\/www\",\"https:\\/\\/hass.purgatoire.ca\\/local\");\n\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n  \"message\": \"Faces learning for\" + \" \" + msg.name,\n  \"data\": {\n    \"image\": snapshot\n  }\n}\n }\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2200,"y":220,"wires":[["9eb3d3bcb3053048","08a258ae4d9f51b9"]]},{"id":"9eb3d3bcb3053048","type":"api-call-service","z":"904d418a12e6a4b0","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2420,"y":220,"wires":[["08a258ae4d9f51b9"]]},{"id":"671d15b4bb2861ae","type":"api-call-service","z":"904d418a12e6a4b0","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.front_door"],"data":"{\"filename\":\"/config/www/reolink.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":920,"y":380,"wires":[[]]},{"id":"19e94e7c65b85b28","type":"ha-wait-until","z":"904d418a12e6a4b0","name":"wait until facecam detect someone","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"sensor.double_take_facecam","entityIdFilterType":"exact","property":"state","comparator":"gt","value":"0","valueType":"num","timeout":"30","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":520,"y":660,"wires":[[],[]]},{"id":"ce3728c13dfb8720","type":"trigger","z":"904d418a12e6a4b0","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"10","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":750,"y":440,"wires":[["19e94e7c65b85b28","671d15b4bb2861ae"]]},{"id":"0df5acd3c1fad200","type":"server-state-changed","z":"904d418a12e6a4b0","name":"frigate reolink over 0","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.front_persons","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"0","halt_if_type":"num","halt_if_compare":"gt","output_only_on_state_change":true,"x":210,"y":120,"wires":[[],[]]},{"id":"585381fe547bc719","type":"change","z":"904d418a12e6a4b0","name":"","rules":[{"t":"set","p":"reset","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":560,"y":500,"wires":[["ce3728c13dfb8720"]]},{"id":"e5af5b96f50720e9","type":"trigger","z":"904d418a12e6a4b0","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"units":"min","reset":"","bytopic":"all","outputs":1,"x":390,"y":500,"wires":[["585381fe547bc719"]]},{"id":"626d390b494bc86d","type":"debug","z":"904d418a12e6a4b0","name":"click","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":130,"y":640,"wires":[]},{"id":"e843854a6c48ebdb","type":"inject","z":"904d418a12e6a4b0","name":"scan","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payloadType":"date","x":3730,"y":540,"wires":[["dcab6140df1dc36d"]]},{"id":"acdb4cbe807a4670","type":"api-call-service","z":"904d418a12e6a4b0","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.door_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1120,"y":940,"wires":[["45bc0fa8d57f6768"]]},{"id":"f3c7ce0f95a036c8","type":"switch","z":"904d418a12e6a4b0","name":"double","property":"payload.event.args.click_type","propertyType":"msg","rules":[{"t":"cont","v":"double","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":950,"y":1000,"wires":[["f0e2a9aab2d39af9"]]},{"id":"45bc0fa8d57f6768","type":"trigger","z":"904d418a12e6a4b0","name":"","op1":"","op2":"1","op1type":"nul","op2type":"num","duration":"1","extend":false,"units":"min","reset":"","bytopic":"all","outputs":1,"x":1430,"y":940,"wires":[["94f6e81203f67cbb"]]},{"id":"f0e2a9aab2d39af9","type":"api-current-state","z":"904d418a12e6a4b0","name":"rang?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.door_rang","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1090,"y":1000,"wires":[["7952b48f4d8032d1"],[]]},{"id":"94f6e81203f67cbb","type":"api-call-service","z":"904d418a12e6a4b0","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.door_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1640,"y":940,"wires":[[]]},{"id":"7952b48f4d8032d1","type":"api-call-service","z":"904d418a12e6a4b0","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.door_double_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1260,"y":1000,"wires":[["f9569e59c0a776c6"]]},{"id":"f9569e59c0a776c6","type":"trigger","z":"904d418a12e6a4b0","name":"","op1":"","op2":"1","op1type":"nul","op2type":"num","duration":"1","extend":false,"units":"min","reset":"","bytopic":"all","outputs":1,"x":1430,"y":1000,"wires":[["81492eb48aaa8da6"]]},{"id":"81492eb48aaa8da6","type":"api-call-service","z":"904d418a12e6a4b0","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.door_double_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1640,"y":1000,"wires":[[]]},{"id":"f99077e2dc36f112","type":"function","z":"904d418a12e6a4b0","name":"Javascript","func":"var d = new Date();\nvar h = d.getHours();\nvar m = d.getMinutes();\nvar s = d.getSeconds();\nvar camera = msg.payload.camera;\nvar confidence = 0;\n\nif (typeof msg.payload.confidence !==\"undefined\"){\nvar confidence = msg.payload.confidence;\n}\n\nvar who = \"Unknown\";\nif (typeof msg.payload.name !==\"undefined\"){\nvar who = msg.payload.name;\n}\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n        \"name\": who,\n        \"data\": {\n            \"filename\":\"/config/www/portraits/\" + who + \"/\" + who + \"-\" + camera + \"-\" + h + m + s + \"-\" + confidence + \".jpg\",\n            \"entity_id\": camera\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3580,"y":600,"wires":[["7db5fd2d3aa6db7e"]]},{"id":"7db5fd2d3aa6db7e","type":"api-call-service","z":"904d418a12e6a4b0","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":3760,"y":600,"wires":[["cdd5d0321269882c","76218d6fce436e81"]]},{"id":"cdd5d0321269882c","type":"debug","z":"904d418a12e6a4b0","name":"result of snapchot","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4010,"y":480,"wires":[]},{"id":"eb675614f65329ab","type":"api-call-service","z":"904d418a12e6a4b0","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4120,"y":600,"wires":[[]]},{"id":"76218d6fce436e81","type":"function","z":"904d418a12e6a4b0","name":"Javascript","func":"var d = new Date();\nvar name = msg.payload.name;\nvar m = d.getMilliseconds();\nvar snapshot = msg.payload.data.filename;\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\" + m;\n\nvar snapshot = snapshot.replace(\"\\/config\\/www\",\"https:\\/\\/hass.purgatoire.ca\\/local\");\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": \"Welcoming \" + name,\n\t\t\t\"data\": {\n\t\t\t\t\"image\": snapshot,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3940,"y":600,"wires":[["eb675614f65329ab","f476ea5d167c3030","92a5921275fef525"]]},{"id":"f476ea5d167c3030","type":"change","z":"904d418a12e6a4b0","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"payload.data.title","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":4120,"y":640,"wires":[["dec00629dd8d0b6f"]]},{"id":"dd50fb000b813d29","type":"debug","z":"904d418a12e6a4b0","name":"actionable","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1490,"y":200,"wires":[]},{"id":"92a5921275fef525","type":"debug","z":"904d418a12e6a4b0","name":"result before notif","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4268.571533203125,"y":545.7142944335938,"wires":[]},{"id":"b2d3879e774d743e","type":"debug","z":"904d418a12e6a4b0","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2235.71435546875,"y":132.85714721679688,"wires":[]},{"id":"dec00629dd8d0b6f","type":"link out","z":"904d418a12e6a4b0","name":"Light and Speakers","links":["45904ca6429d867d","ad88dbd2.4726b8","3405e943.fd3ee6","9cf42cf7ef60f645"],"x":4255,"y":640,"wires":[]},{"id":"08a258ae4d9f51b9","type":"debug","z":"904d418a12e6a4b0","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2390,"y":100,"wires":[]},{"id":"82b2857a071236b8","type":"inject","z":"904d418a12e6a4b0","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payloadType":"date","x":740,"y":380,"wires":[["671d15b4bb2861ae"]]},{"id":"2a283d05b6b10ba0","type":"debug","z":"904d418a12e6a4b0","name":"result before notif","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2430,"y":1340,"wires":[]},{"id":"e458126bd5641b2e","type":"switch","z":"904d418a12e6a4b0","name":"","property":"payload.name","propertyType":"msg","rules":[{"t":"nempty"}],"checkall":"false","repair":false,"outputs":1,"x":2390,"y":720,"wires":[["93d0afd406ac15b9"]]},{"id":"1e8f53f8970447d0","type":"http request","z":"904d418a12e6a4b0","name":"POST request to catch","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://192.168.0.14:3000/api/recognize?url=http://192.168.0.15:8123/local/reolink.jpg&camera=camera.front_door","tls":"","persist":false,"proxy":"","authType":"","x":1280,"y":700,"wires":[["d3f48ad47a6eca11"]]},{"id":"d3f48ad47a6eca11","type":"json","z":"904d418a12e6a4b0","name":"toJson","property":"payload","action":"","pretty":true,"x":1490,"y":700,"wires":[["7219126187207dfa","e66b54c926156cea"]]},{"id":"c0780ce38288680f","type":"http request","z":"904d418a12e6a4b0","name":"POST request","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://192.168.0.14:3000/api/recognize?url=http://192.168.0.15:8123/local/ring.jpg&camera=camera.facecam","tls":"","persist":false,"proxy":"","authType":"","senderr":false,"headers":[],"x":1360,"y":800,"wires":[["2ddab611dce859bf"]]},{"id":"90f8b95437a6b15f","type":"api-call-service","z":"904d418a12e6a4b0","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.facecam"],"data":"{\"filename\":\"/config/www/ring.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1180,"y":800,"wires":[["c0780ce38288680f"]]},{"id":"3a4d0b43583f798d","type":"join","z":"904d418a12e6a4b0","name":"","mode":"custom","build":"array","property":"payload.matches","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"5","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"num","reduceFixup":"","x":1790,"y":740,"wires":[["06ef254284bf7af3","1bb02d2cdc9d745c"]]},{"id":"2ddab611dce859bf","type":"json","z":"904d418a12e6a4b0","name":"toJson","property":"payload","action":"","pretty":true,"x":1510,"y":800,"wires":[["d3a5b3d7566830b1","67688ca323561b6b"]]},{"id":"06ef254284bf7af3","type":"function","z":"904d418a12e6a4b0","name":"Face Extractor compare 5.1","func":"// SETTINGS\nvar required_conf = 80;\n// SETTINGS\n\n\nvar recoface = new Object();\nvar recofacesortable = [];\nvar name = \"\";\nvar camera = \"\";\nvar conf = \"\";\nvar reconame = \"\";\nvar confidence = \"\";\nvar reco = \"\";\nvar recognized_confidently = 0;\n//declarations\n\n    for (i = 0; i < msg.payload.matches.length; i++){\n         for (y = 0; y < Object.keys(msg.payload.matches[i]).length; y++){\n                var name = msg.payload.matches[i][y][0];\n \t\t\t\tvar conf = msg.payload.matches[i][y][1];\n \t\t\t\tvar camera = msg.payload.matches[i][y][2];\n \t\t\t// \tif (conf > 0){\n \t\t\t\t    recofacesortable.push([name, conf, camera]);\n \t\t\t// \t}\n \t\t\t\t\n        }\n    }\n    \n    \n     \trecofacesortable.sort(function(a, b) {\n \t\treturn a[1] - b[1];\n \t}).reverse();\n \t\n    for (i = 0; i < recofacesortable.length; i++){\n        var reconame = recofacesortable[0][0];\n        var confidence = recofacesortable[0][1]\n        var camera = recofacesortable[0][2]\n        \n        \n    }\n\n\n\nif (confidence > required_conf) \n\tvar recognized = 1;\n}\n\n if (camera == \"camera.front_door\"){\n     var camera = \"camera.reolink_static\";\n } else if (camera == \"camera.facecam\"){\n     var camera = \"camera.facecam_static\"\n }\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"name\": reconame,\n\t\t\"confidence\": confidence,\n\t//\t\"matched_faces\": total_matched_faces,\n\t//\t\"total_faces\": total_faces,\n\t\t\"recognized\": recognized,\n \t\t\"camera\": camera \n\t}\n};\n\nreturn newMsg;\n\n\n//  var test = {\n//  \t\"payload\": {\n// \t\t\"name\": reconame,\n// \t\t\"confidence\": confidence,\n// \t\t\"matched_faces\": total_matched_faces,\n// \t\t\"total_faces\": total_faces,\n// \t\t\"recognized\": recognized,\n// \t\t\"camera\": camera ,\n// \t\t\"recofacesortable\": recofacesortable\n//  \t}\n//  };\n//  return test;","outputs":1,"noerr":23,"initialize":"","finalize":"","libs":[],"x":2000,"y":740,"wires":[["0f1732762ac40879","ba44446730be7bf1","0ac672adeec6d647"]]},{"id":"e66b54c926156cea","type":"debug","z":"904d418a12e6a4b0","name":"post1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1630,"y":620,"wires":[]},{"id":"67688ca323561b6b","type":"debug","z":"904d418a12e6a4b0","name":"post2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1750,"y":840,"wires":[]},{"id":"1bb02d2cdc9d745c","type":"debug","z":"904d418a12e6a4b0","name":"tojson","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1810,"y":660,"wires":[]},{"id":"5f8de432d168d923","type":"inject","z":"904d418a12e6a4b0","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":2060,"y":960,"wires":[["150cd5e00c84aade"]]},{"id":"7219126187207dfa","type":"function","z":"904d418a12e6a4b0","name":"cam set","func":"// SETTINGS\nvar required_conf = 75;\n// SETTINGS\n\n\nvar recoface = new Object();\nvar recofacesortable = [];\nvar name = \"\";\nvar camera = \"camera.front_door\";\nvar conf = \"\";\nvar reconame = \"\";\nvar confidence = \"\";\nvar reco = \"\";\n//declarations\n\n    for (i = 0; i < msg.payload.matches.length; i++){\n\n                var name = msg.payload.matches[i].name;\n \t\t\t\tvar conf = msg.payload.matches[i].confidence;\n \t\t\t// \tif (conf > 0){\n \t\t\t\t    recofacesortable.push([name, conf, camera]);\n \t\t\t// \t}\n \t\t\t\t\n        \n    }\n\nif (typeof msg.payload.unknown!==\"undefined\"){\n    recofacesortable.push([\"Unknown\", \"0\", camera]);\n}\n    \n    \n//      \trecofacesortable.sort(function(a, b) {\n//  \t\treturn a[1] - b[1];\n//  \t}).reverse();\n \t\n//     for (i = 0; i < recofacesortable.length; i++){\n//         var reconame = recofacesortable[0][0];\n//         var confidence = recofacesortable[0][1]\n//         var camera = recofacesortable[0][2]\n        \n        \n//     }\n\n\n\n// if (confidence > required_conf) {\n// \tvar recognized = 1;\n// } else {\n// \tvar recognized = 0;\n// }\n\n// if (camera == \"face_counter_reolink\"){\n//     var camera = \"camera.reolink_static\";\n// } else if (camera == \"face_counter_facecam\"){\n//     var camera = \"camera.facecam_static\"\n// }\n\n// var newMsg = {\n// \t\"payload\": {\n// \t\t\"name\": reconame,\n// \t\t\"confidence\": confidence,\n// \t\t\"recognized\": recognized,\n//  \t\t\"camera\": camera \n// \t}\n// };\n\n//return newMsg;\n\n\n  var test = {\n   \t\"payload\":  {\n\t\t\"matches\": recofacesortable,\n// //  \t\t\"confidence\": confidence,\n// //  \t\t\"recognized\": recognized,\n// //  \t\t\"camera\": camera ,\n// //  \t\t\"recofacesortable\": recofacesortable\n   \t}\n  };\n  return test;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1640,"y":720,"wires":[["3a4d0b43583f798d","e66b54c926156cea"]]},{"id":"d3a5b3d7566830b1","type":"function","z":"904d418a12e6a4b0","name":"cam set","func":"// SETTINGS\nvar required_conf = 75;\n// SETTINGS\n\n\nvar recoface = new Object();\nvar recofacesortable = [];\nvar name = \"\";\nvar camera = \"camera.facecam\";\nvar conf = \"\";\nvar reconame = \"\";\nvar confidence = \"\";\nvar reco = \"\";\n//declarations\n\n    for (i = 0; i < msg.payload.matches.length; i++){\n\n                var name = msg.payload.matches[i].name;\n \t\t\t\tvar conf = msg.payload.matches[i].confidence;\n \t\t\t// \tif (conf > 0){\n \t\t\t\t    recofacesortable.push([name, conf, camera]);\n \t\t\t// \t}\n \t\t\t\t\n        \n    }\n\nif (typeof msg.payload.unknown!==\"undefined\"){\n    recofacesortable.push([\"Unknown\", \"0\", camera]);\n}\n    \n    \n//      \trecofacesortable.sort(function(a, b) {\n//  \t\treturn a[1] - b[1];\n//  \t}).reverse();\n \t\n//     for (i = 0; i < recofacesortable.length; i++){\n//         var reconame = recofacesortable[0][0];\n//         var confidence = recofacesortable[0][1]\n//         var camera = recofacesortable[0][2]\n        \n        \n//     }\n\n\n\n// if (confidence > required_conf) {\n// \tvar recognized = 1;\n// } else {\n// \tvar recognized = 0;\n// }\n\n// if (camera == \"face_counter_reolink\"){\n//     var camera = \"camera.reolink_static\";\n// } else if (camera == \"face_counter_facecam\"){\n//     var camera = \"camera.facecam_static\"\n// }\n\n// var newMsg = {\n// \t\"payload\": {\n// \t\t\"name\": reconame,\n// \t\t\"confidence\": confidence,\n// \t\t\"recognized\": recognized,\n//  \t\t\"camera\": camera \n// \t}\n// };\n\n//return newMsg;\n\n\n  var test = {\n   \t\"payload\":  {\n\t\t\"matches\": recofacesortable,\n// //  \t\t\"confidence\": confidence,\n// //  \t\t\"recognized\": recognized,\n// //  \t\t\"camera\": camera ,\n// //  \t\t\"recofacesortable\": recofacesortable\n   \t}\n  };\n  return test;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1640,"y":760,"wires":[["3a4d0b43583f798d","67688ca323561b6b"]]},{"id":"901b9e8cae5d66bb","type":"debug","z":"904d418a12e6a4b0","name":"actionable","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1450,"y":80,"wires":[]},{"id":"50d9fa7e7c3800e4","type":"http request","z":"904d418a12e6a4b0","name":"POST request","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1940,"y":220,"wires":[["b2d3879e774d743e","14c699202031c457"]]},{"id":"ec6cea7645c91b6a","type":"function","z":"904d418a12e6a4b0","name":"Javascript","func":"var d = new Date();\nvar h = d.getHours();\nvar m = d.getMinutes();\nvar s = d.getSeconds();\n\nvar confidence = 0;\nif (typeof msg.payload.confidence !==\"undefined\"){\nvar confidence = msg.payload.confidence;\n}\n\n\nvar who = msg.payload.event.reply_text.toLowerCase().replace(\" \",\"\");\nvar replacestring = \"https://hass.purgatoire.ca/local/portraits/\" + who.toLowerCase();\nvar replacestring1 = msg.payload.event.image.replace(replacestring);\nvar replacestring2 = replacestring1.split(\"-\");\nvar camera = replacestring2[1];\n\n\n\n\nvar newMsg = {\n    \"image\": msg.payload.event.image,\n    \"payload\": {\n        \"name\": who,\n        \"data\": {\n            \"filename\":\"/config/double-take/\" + who +  \"/\" + camera + \"_\" + h + m + s + \"_\" + confidence + \".jpg\",\n            \"entity_id\": camera,\n            // \"1\": replacestring,\n            // \"2\": replacestring1,\n            // \"3\": replacestring2\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1300,"y":320,"wires":[["dd50fb000b813d29","30b540a24623fdf9"]]},{"id":"2c7e04d7b8d79fe4","type":"api-call-service","z":"904d418a12e6a4b0","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1680,"y":320,"wires":[["31ebe03fa4f5502a","f77a07bb408cd716"]]},{"id":"31ebe03fa4f5502a","type":"debug","z":"904d418a12e6a4b0","name":"result of snapchot","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2050,"y":340,"wires":[]},{"id":"7546d4fa774773c7","type":"function","z":"904d418a12e6a4b0","name":"Javascript","func":"var d = new Date();\nvar h = d.getHours();\nvar m = d.getMinutes();\nvar s = d.getSeconds();\nvar camera = msg.payload.camera;\nvar confidence = 0;\n\nif (typeof msg.payload.confidence !==\"undefined\"){\nvar confidence = msg.payload.confidence;\n}\n\nvar who = \"Unknown\";\nif (typeof msg.payload.name !==\"undefined\"){\nvar who = msg.payload.name;\n}\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n        \"name\": who,\n        \"data\": {\n            \"filename\":\"/config/www/portraits/\" + who + \"/\" + who + \"-\" + camera + \"-\" + h + m + s + \"-\" + confidence + \".jpg\",\n            \"entity_id\": camera\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2960,"y":840,"wires":[["fbe327880877a39a"]]},{"id":"fbe327880877a39a","type":"api-call-service","z":"904d418a12e6a4b0","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":3140,"y":840,"wires":[["c95634890ca84687"]]},{"id":"293471c2ce12198b","type":"api-call-service","z":"904d418a12e6a4b0","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3500,"y":840,"wires":[[]]},{"id":"c95634890ca84687","type":"function","z":"904d418a12e6a4b0","name":"Javascript","func":"var d = new Date();\nvar name = msg.payload.name;\nvar m = d.getMilliseconds();\nvar snapshot = msg.payload.data.filename;\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\" + m;\n\nvar snapshot = snapshot.replace(\"\\/config\\/www\",\"https:\\/\\/hass.purgatoire.ca\\/local\");\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"image\": snapshot,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3320,"y":840,"wires":[["293471c2ce12198b","857a70342f2d7124"]]},{"id":"857a70342f2d7124","type":"change","z":"904d418a12e6a4b0","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"payload.data.title","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":3120,"y":780,"wires":[["ce20e38b68c63777"]]},{"id":"7a0fcae802a46c08","type":"trigger","z":"904d418a12e6a4b0","name":"Face Not reco","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2620,"y":1120,"wires":[["aa5a286de68e5ce7","88fe95a4556c899d","2be68eeca4b12515"]]},{"id":"aa5a286de68e5ce7","type":"debug","z":"904d418a12e6a4b0","name":"face not reco","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2610,"y":1280,"wires":[]},{"id":"88fe95a4556c899d","type":"function","z":"904d418a12e6a4b0","name":"Javascript","func":"var d = new Date();\nvar h = d.getHours();\nvar m = d.getMinutes();\nvar s = d.getSeconds();\nvar camera = msg.payload.camera;\nvar confidence = 0;\n\nif (typeof msg.payload.confidence !==\"undefined\"){\nvar confidence = msg.payload.confidence;\n}\n\nvar who = \"Unknown\";\nif (typeof msg.payload.name !==\"undefined\"){\nvar who = msg.payload.name;\n}\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n        \"name\": who,\n        \"data\": {\n            \"filename\":\"/config/www/portraits/\" + who + \"/\" + who + \"-\" + camera + \"-\" + h + m + s + \"-\" + confidence + \".jpg\",\n            \"entity_id\": camera\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2800,"y":1120,"wires":[["5eda1fd916d75fc5"]]},{"id":"5eda1fd916d75fc5","type":"api-call-service","z":"904d418a12e6a4b0","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2980,"y":1120,"wires":[["e6f12c198a7ff8ce"]]},{"id":"407481c5ec78fe37","type":"api-call-service","z":"904d418a12e6a4b0","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3340,"y":1120,"wires":[[]]},{"id":"e6f12c198a7ff8ce","type":"function","z":"904d418a12e6a4b0","name":"Javascript","func":"var d = new Date();\nvar name = msg.payload.name;\nvar m = d.getMilliseconds();\nvar snapshot = msg.payload.data.filename;\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\" + m;\n\nvar snapshot = snapshot.replace(\"\\/config\\/www\",\"https:\\/\\/hass.purgatoire.ca\\/local\");\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": \"Someone is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"image\": snapshot,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3140,"y":1120,"wires":[["407481c5ec78fe37","04136d4e58b72b49"]]},{"id":"04136d4e58b72b49","type":"change","z":"904d418a12e6a4b0","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"payload.data.title","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":3340,"y":1160,"wires":[["f66eb3a9e4a19b70"]]},{"id":"f66eb3a9e4a19b70","type":"link out","z":"904d418a12e6a4b0","name":"Light and Speakers","links":["45904ca6429d867d","ad88dbd2.4726b8","3405e943.fd3ee6","9cf42cf7ef60f645"],"x":3475,"y":1160,"wires":[]},{"id":"93d0afd406ac15b9","type":"api-current-state","z":"904d418a12e6a4b0","name":"uber","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.waiting_uber","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2510,"y":720,"wires":[["725592b772d2f831"],["e4c7a28d349931be"]]},{"id":"7013d7b5775bf756","type":"switch","z":"904d418a12e6a4b0","name":"","property":"payload.name","propertyType":"msg","rules":[{"t":"nempty"},{"t":"eq","v":"","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":2190,"y":920,"wires":[["dd33921d39d3ec9c"],["264198226c051236"]]},{"id":"30b540a24623fdf9","type":"switch","z":"904d418a12e6a4b0","name":"Recod Faces 1/0","property":"payload.data.entity_id","propertyType":"msg","rules":[{"t":"eq","v":"camera.facecam_static","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1510,"y":320,"wires":[["2c7e04d7b8d79fe4"]]},{"id":"dcab6140df1dc36d","type":"api-call-service","z":"904d418a12e6a4b0","name":"unLock Door","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"lock","service":"unlock","areaId":[],"deviceId":[],"entityId":["lock.front_door"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3910,"y":380,"wires":[["088cb81fd7b1e783","18efd9deec536b5b"]]},{"id":"18efd9deec536b5b","type":"api-current-state","z":"904d418a12e6a4b0","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"unlocked","halt_if_type":"str","halt_if_compare":"is","entity_id":"lock.front_door","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3900,"y":320,"wires":[["700116e39062929e"],["dcab6140df1dc36d"]]},{"id":"bf68ef8d39f309d7","type":"delay","z":"904d418a12e6a4b0","name":"Waiting someone","pauseType":"delay","timeout":"1","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":3290,"y":600,"wires":[["de700ffb416bffb9","d3a54796c0c96850","f99077e2dc36f112","dcab6140df1dc36d"]]},{"id":"1ab167e6d548ddec","type":"api-current-state","z":"904d418a12e6a4b0","name":"Front House Motion","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.motion_front","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":3010,"y":720,"wires":[["bf68ef8d39f309d7"],["67d7a5e70c4f1173"]]},{"id":"c971d4a0445aef2c","type":"change","z":"904d418a12e6a4b0","name":"reset","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1890,"y":1160,"wires":[["a883a03c81fd4859","a537f90568a2331e","d7ccb3af1a82f471"]]},{"id":"a883a03c81fd4859","type":"function","z":"904d418a12e6a4b0","name":"Javascript","func":"var recoface = [];\nvar facestring = \"\"\nvar d = new Date();\nvar m = d.getMilliseconds();\nvar url = \"https://hass.purgatoire.ca/local/ring.jpg?\" + m;\nvar facestring = msg.payload;\n\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n  \"message\": \"Someone is at the door\",\n  \"data\": {\n    \"image\": url,\n    \"actions\": [\n      {\n        \"action\": \"unlock_door\",\n        \"title\": \"Unlock The Door\"\n      }\n                \n    ]\n  }\n}\n }\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2060,"y":1140,"wires":[["482b132529f27f0f"]]},{"id":"482b132529f27f0f","type":"api-call-service","z":"904d418a12e6a4b0","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2240,"y":1140,"wires":[[]]},{"id":"f1df89f7f6273d40","type":"trigger","z":"904d418a12e6a4b0","name":"No Face","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1740,"y":1160,"wires":[["c971d4a0445aef2c"]]},{"id":"a537f90568a2331e","type":"change","z":"904d418a12e6a4b0","name":"Set Data for mass alert","rules":[{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"},{"t":"set","p":"message","pt":"msg","to":"Someone is at the door","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2100,"y":1220,"wires":[["26bb1943455ffac1"]]},{"id":"26bb1943455ffac1","type":"link out","z":"904d418a12e6a4b0","name":"Light and Speakers","links":["45904ca6429d867d","ad88dbd2.4726b8","3405e943.fd3ee6","9cf42cf7ef60f645"],"x":2235,"y":1220,"wires":[]},{"id":"6a2c4537d58a5c2f","type":"switch","z":"904d418a12e6a4b0","name":"","property":"payload.event.action_1_title","propertyType":"msg","rules":[{"t":"eq","v":"Who is this?","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1190,"y":260,"wires":[["ec6cea7645c91b6a","dd50fb000b813d29"]]},{"id":"ce20e38b68c63777","type":"link out","z":"904d418a12e6a4b0","name":"Light and Speakers","links":["45904ca6429d867d","ad88dbd2.4726b8","3405e943.fd3ee6","9cf42cf7ef60f645"],"x":3295,"y":780,"wires":[]},{"id":"e4c7a28d349931be","type":"trigger","z":"904d418a12e6a4b0","name":"Uber","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2550,"y":960,"wires":[["923994cc630458f6","d7ee96320385c85a"]]},{"id":"923994cc630458f6","type":"function","z":"904d418a12e6a4b0","name":"Javascript","func":"var d = new Date();\nvar h = d.getHours();\nvar m = d.getMinutes();\nvar s = d.getSeconds();\nvar camera = \"camera.front_door\";\nvar confidence = 0;\n\nif (typeof msg.payload.confidence !==\"undefined\"){\nvar confidence = msg.payload.confidence;\n}\n\nvar who = \"Unknown\";\nif (typeof msg.payload.name !==\"undefined\"){\nvar who = msg.payload.name;\n}\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n        \"name\": who,\n        \"data\": {\n            \"filename\":\"/config/www/portraits/\" + who + \"/\" + who + \"-\" + camera + \"-\" + h + m + s + \"-\" + confidence + \".jpg\",\n            \"entity_id\": camera\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2740,"y":980,"wires":[["60da29b51fca273a","42cc2f7f3b9febbd"]]},{"id":"60da29b51fca273a","type":"api-call-service","z":"904d418a12e6a4b0","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2960,"y":980,"wires":[["8140863346e33c80","2e41453782c86465"]]},{"id":"7656e9b692e9fc03","type":"api-call-service","z":"904d418a12e6a4b0","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3380,"y":980,"wires":[[]]},{"id":"8140863346e33c80","type":"function","z":"904d418a12e6a4b0","name":"Javascript","func":"var d = new Date();\nvar name = \"Someone\";\nvar m = d.getMilliseconds();\nvar snapshot = msg.payload.data.filename;\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\" + m;\n\nvar snapshot = snapshot.replace(\"\\/config\\/www\",\"https:\\/\\/hass.purgatoire.ca\\/local\");\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"image\": snapshot,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3140,"y":980,"wires":[["7656e9b692e9fc03","9993335ff3898bdb"]]},{"id":"9993335ff3898bdb","type":"change","z":"904d418a12e6a4b0","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"payload.data.title","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":3320,"y":940,"wires":[["902a23bee759d216"]]},{"id":"902a23bee759d216","type":"link out","z":"904d418a12e6a4b0","name":"Light and Speakers","links":["45904ca6429d867d","ad88dbd2.4726b8","3405e943.fd3ee6","9cf42cf7ef60f645"],"x":3455,"y":940,"wires":[]},{"id":"d7ee96320385c85a","type":"api-call-service","z":"904d418a12e6a4b0","name":"to package","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"script","service":"ptz_to_package","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2710,"y":940,"wires":[["c83706e06ce524aa","f7d1fdeab2abc3b3"]]},{"id":"d7ccb3af1a82f471","type":"link out","z":"904d418a12e6a4b0","name":"Announcement input","links":["6c95d201f6c9daf3"],"x":2035,"y":1180,"wires":[]},{"id":"2be68eeca4b12515","type":"link out","z":"904d418a12e6a4b0","name":"Announcement input","links":["6c95d201f6c9daf3"],"x":2775,"y":1080,"wires":[]},{"id":"c83706e06ce524aa","type":"link out","z":"904d418a12e6a4b0","name":"Announcement input","links":["6c95d201f6c9daf3"],"x":3015,"y":940,"wires":[]},{"id":"e139f44c71b58e6e","type":"link out","z":"904d418a12e6a4b0","name":"Announcement input","links":["6c95d201f6c9daf3"],"x":2915,"y":800,"wires":[]},{"id":"0361e9a0a13608d3","type":"link out","z":"904d418a12e6a4b0","name":"Announcement input","links":["6c95d201f6c9daf3"],"x":2415,"y":1440,"wires":[]},{"id":"f0ab80a27fc67e71","type":"link out","z":"904d418a12e6a4b0","name":"Announcement input","links":["6c95d201f6c9daf3"],"x":3735,"y":260,"wires":[]},{"id":"efbcac8ae861406a","type":"inject","z":"904d418a12e6a4b0","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":510,"y":740,"wires":[["23685ea64ad822fc"]]},{"id":"264198226c051236","type":"api-current-state","z":"904d418a12e6a4b0","name":"uber","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.waiting_uber","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2270,"y":1020,"wires":[["e4c7a28d349931be"],["f1df89f7f6273d40"]]},{"id":"dd33921d39d3ec9c","type":"api-current-state","z":"904d418a12e6a4b0","name":"uber","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.waiting_uber","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2350,"y":920,"wires":[["e4c7a28d349931be"],["7a0fcae802a46c08"]]},{"id":"2e41453782c86465","type":"debug","z":"904d418a12e6a4b0","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3150,"y":1020,"wires":[]},{"id":"42cc2f7f3b9febbd","type":"debug","z":"904d418a12e6a4b0","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2850,"y":1020,"wires":[]},{"id":"fdfb55f783cdc525","type":"api-call-service","z":"904d418a12e6a4b0","name":"to regular position","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"script","service":"ptz_to_doorway","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":3090,"y":900,"wires":[[]]},{"id":"f7d1fdeab2abc3b3","type":"ha-wait-until","z":"904d418a12e6a4b0","name":"lock opens","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"unlocked","valueType":"str","timeout":"120","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":false,"blockInputOverrides":true,"outputProperties":[],"x":2870,"y":900,"wires":[["fdfb55f783cdc525"],["fdfb55f783cdc525"]]},{"id":"0ac672adeec6d647","type":"api-call-service","z":"904d418a12e6a4b0","name":"to door","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"script","service":"ptz_to_doorway","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2180,"y":700,"wires":[[]]},{"id":"c084c153d3ab6ee7","type":"mqtt in","z":"904d418a12e6a4b0","name":"","topic":"frigate/faceshot_zone/person","qos":"0","datatype":"auto","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":120,"y":440,"wires":[["9ddcaabefcce8a21","ca098420ae1420ee"]]},{"id":"9ddcaabefcce8a21","type":"debug","z":"904d418a12e6a4b0","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":270,"y":340,"wires":[]},{"id":"ca098420ae1420ee","type":"switch","z":"904d418a12e6a4b0","name":"click","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":390,"y":440,"wires":[["ce3728c13dfb8720"],["e5af5b96f50720e9"]]},{"id":"06a45ec0ea3134e4","type":"server-state-changed","z":"904d418a12e6a4b0","name":"double-take facecam over 0","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.double_take_facecam","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"0","halt_if_type":"num","halt_if_compare":"gt","output_only_on_state_change":true,"x":260,"y":200,"wires":[[],[]]},{"id":"1cf2d343db1c089e","type":"ha-wait-until","z":"904d418a12e6a4b0","name":"wait until Doubletake detect someone","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"sensor.double_take_facecam","entityIdFilterType":"exact","property":"state","comparator":"gt","value":"0","valueType":"num","timeout":"2","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[{"property":"doubletake","propertyType":"msg","value":"","valueType":"entity"}],"x":490,"y":800,"wires":[["23685ea64ad822fc","fd9e004bebcc4da9"],["23685ea64ad822fc","fd9e004bebcc4da9"]]},{"id":"b07092e47615b45f","type":"trigger","z":"904d418a12e6a4b0","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"45","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":430,"y":960,"wires":[["acdb4cbe807a4670","f3c7ce0f95a036c8"]]},{"id":"f0580e72171443ad","type":"inject","z":"904d418a12e6a4b0","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":3910,"y":680,"wires":[[]]},{"id":"aad8dfcf35a5f778","type":"trigger","z":"904d418a12e6a4b0","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"25","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":4350,"y":320,"wires":[["7caca54b79a292ef"]]},{"id":"f965de714ebd94de","type":"inject","z":"904d418a12e6a4b0","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":4180,"y":500,"wires":[["700116e39062929e"]]},{"id":"fd9e004bebcc4da9","type":"debug","z":"904d418a12e6a4b0","name":"Doubletake output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1000,"y":660,"wires":[]},{"id":"7a28dcc41462f8d0","type":"trigger","z":"62914984f579d881","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"10","extend":false,"overrideDelay":false,"units":"min","reset":"motion","bytopic":"all","topic":"topic","outputs":1,"x":770,"y":160,"wires":[["31bebf3958fcf0e0"]]},{"id":"fc016d7d841dc253","type":"comment","z":"62914984f579d881","name":"This prevent the Light from going off as long as the humidity is over 40%(Shower)","info":"","x":380,"y":360,"wires":[]},{"id":"5f50084e74c02bc3","type":"change","z":"62914984f579d881","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"A","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1220,"y":400,"wires":[["dd93311cd91a73d1"]]},{"id":"a2ce03d101a308e9","type":"api-current-state","z":"62914984f579d881","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.bathrooms","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":550,"y":400,"wires":[[],["64c3ec1015818ca1","17d3bbda6788aad5"]]},{"id":"91a8dc11fdd22505","type":"trigger","z":"62914984f579d881","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"10","extend":false,"units":"s","reset":"on","bytopic":"all","outputs":1,"x":890,"y":400,"wires":[["b9f683ce8421d3e1"]]},{"id":"dd93311cd91a73d1","type":"api-call-service","z":"62914984f579d881","name":"Bathroom Light Off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.bathrooms"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1410,"y":400,"wires":[[]]},{"id":"ad83e9172b3261e5","type":"random","z":"62914984f579d881","name":"","low":"1","high":"37","inte":"true","property":"number","x":1120,"y":300,"wires":[["16f65f5fa0edd049"]]},{"id":"64c3ec1015818ca1","type":"change","z":"62914984f579d881","name":"on","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":750,"y":400,"wires":[["91a8dc11fdd22505"]]},{"id":"1056df852f1797e7","type":"api-call-service","z":"62914984f579d881","name":"cast Off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_stop","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1940,"y":120,"wires":[[]]},{"id":"b9f683ce8421d3e1","type":"api-current-state","z":"62914984f579d881","name":"Motion state","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.motion_bathroom","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":1050,"y":400,"wires":[[],["5f50084e74c02bc3"]]},{"id":"b342c608e970b24c","type":"api-call-service","z":"62914984f579d881","name":"Bathroom Light Off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.bathrooms"],"data":"{\"transition\": \"60\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload1","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1310,"y":180,"wires":[[]]},{"id":"31bebf3958fcf0e0","type":"api-current-state","z":"62914984f579d881","name":"Humidity","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.shower_in_use","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":760,"y":220,"wires":[["7a28dcc41462f8d0"],["b342c608e970b24c","f5861041d494f37e"]]},{"id":"e95d11698cb134f6","type":"api-call-service","z":"62914984f579d881","name":"Bathroom Light on","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.bathrooms"],"data":"{\"color_temp\":\"255\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1190,"y":340,"wires":[["0b6a796c40e84fa2"]]},{"id":"d46e459824e86588","type":"change","z":"62914984f579d881","name":"motion","rules":[{"t":"set","p":"payload","pt":"msg","to":"motion","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":470,"y":300,"wires":[["c6df82b35cd45d70","738649c7c49ba0be","7a28dcc41462f8d0"]]},{"id":"42e2e246c6d7057e","type":"change","z":"62914984f579d881","name":"no_motion","rules":[{"t":"set","p":"payload","pt":"msg","to":"no_motion","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":450,"y":180,"wires":[["7a28dcc41462f8d0"]]},{"id":"c6df82b35cd45d70","type":"api-current-state","z":"62914984f579d881","name":"Speaker state","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"playing","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.bathroom_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":940,"y":300,"wires":[[],["ad83e9172b3261e5"]]},{"id":"738649c7c49ba0be","type":"api-current-state","z":"62914984f579d881","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"light.bathrooms","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":790,"y":340,"wires":[["2db415b636da4c52"],[]]},{"id":"005ba27c7bfbbe3a","type":"api-current-state","z":"62914984f579d881","name":"Door state","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.door_bathroom","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":1570,"y":300,"wires":[["0d0b01759e483177"],["622de50bd63e6252"]]},{"id":"2db415b636da4c52","type":"function","z":"62914984f579d881","name":"Time","func":"var d = new Date();\nvar h = d.getHours();\n\nif (h > 22){\n    var brightness = \"80\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness = \"75\";\n}\nelse if (h>2 && h<7){\n    var brightness = \"50\";\n}\nelse{\n    var brightness = \"100\";\n}\n\nvar newMsg = \n\n{ \n    \"payload\": {\n                data: {\n                         \"brightness_pct\": brightness                      }\n               } \n};\nreturn newMsg;\n\n","outputs":1,"noerr":0,"x":1030,"y":340,"wires":[["e95d11698cb134f6"]]},{"id":"cda6b5abac0d7b3c","type":"ha-wait-until","z":"62914984f579d881","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"binary_sensor.door_bathroom","entityIdFilterType":"exact","property":"state","comparator":"is","value":"off","valueType":"str","timeout":"30","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":2280,"y":260,"wires":[["457aa2e66b9e0cb6"],[]]},{"id":"457aa2e66b9e0cb6","type":"api-call-service","z":"62914984f579d881","name":"Bathroom Speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"{\"volume_level\":\"0.4\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2450,"y":260,"wires":[[]]},{"id":"17d3bbda6788aad5","type":"function","z":"62914984f579d881","name":"Time","func":"var d = new Date();\nvar h = d.getHours();\n\nif (h > 22){\n    var brightness = \"80\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness = \"75\";\n}\nelse if (h>2 && h<7){\n    var brightness = \"50\";\n}\nelse{\n    var brightness = \"100\";\n}\n\nvar newMsg = \n\n{ \n    \"payload\": {\n                data: {\n                         \"brightness_pct\": brightness                      }\n               } \n};\nreturn newMsg;\n\n","outputs":1,"noerr":0,"x":750,"y":440,"wires":[["c7ef108fa33f0253"]]},{"id":"c7ef108fa33f0253","type":"api-call-service","z":"62914984f579d881","name":"Bathroom Light on","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.bathrooms"],"data":"{\"color_temp\":\"255\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":910,"y":440,"wires":[[]]},{"id":"8c62be6a200a3ae2","type":"cast-to-client","z":"62914984f579d881","name":"","url":"","contentType":"audio","message":"","language":"en","ip":"192.168.40.26","port":"","volume":"10","x":2110,"y":260,"wires":[["cda6b5abac0d7b3c"]]},{"id":"ce1932e8d523fa22","type":"cast-to-client","z":"62914984f579d881","name":"","url":"","contentType":"audio","message":"","language":"en","ip":"192.168.40.26","port":"","volume":"40","x":2110,"y":300,"wires":[[]]},{"id":"16f65f5fa0edd049","type":"random","z":"62914984f579d881","name":"","low":"1","high":"37","inte":"true","property":"number1","x":1280,"y":300,"wires":[["3a47aa1af562161c"]]},{"id":"3a47aa1af562161c","type":"random","z":"62914984f579d881","name":"","low":"1","high":"37","inte":"true","property":"number2","x":1420,"y":300,"wires":[["005ba27c7bfbbe3a"]]},{"id":"0d0b01759e483177","type":"function","z":"62914984f579d881","name":"Music Selector","func":"var number = msg.number;\nvar number1 = msg.number1;\nvar number2 = msg.number2;\nvar newMsg = {\n    \"payload\": {\n            \"urlList\": [\"http://192.168.0.15:8123/local/muzak/muzak\" + number + \".mp3\",\n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number1 + \".mp3\", \n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number2 + \".mp3\"]\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"x":1860,"y":260,"wires":[["8c62be6a200a3ae2"]]},{"id":"a4cdefc2674d8b0d","type":"server-state-changed","z":"62914984f579d881","name":"Bathroom Motion","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.motion_bathroom","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":180,"y":260,"wires":[[],[]]},{"id":"30c4c03d146af7ba","type":"server-state-changed","z":"62914984f579d881","name":"Kitchen Entrance","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.motion_kitchen_entrance","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":260,"y":400,"wires":[[],[]]},{"id":"7ed52a7170b8a213","type":"api-call-service","z":"62914984f579d881","name":"Bathroom Light on","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.bathrooms"],"data":"{\"color_temp\":\"255\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1670,"y":340,"wires":[["ceb9c26d369631c5"]]},{"id":"0b6a796c40e84fa2","type":"trigger","z":"62914984f579d881","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"4","extend":false,"overrideDelay":false,"units":"s","reset":"motion","bytopic":"all","topic":"topic","outputs":1,"x":1360,"y":340,"wires":[["e65f89e364490324"]]},{"id":"e65f89e364490324","type":"function","z":"62914984f579d881","name":"Time","func":"var d = new Date();\nvar h = d.getHours();\n\nif (h > 22){\n    var brightness = \"80\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness = \"75\";\n}\nelse if (h>2 && h<7){\n    var brightness = \"50\";\n}\nelse{\n    var brightness = \"100\";\n}\n\nvar newMsg = \n\n{ \n    \"payload\": {\n                data: {\n                         \"brightness_pct\": brightness                      }\n               } \n};\nreturn newMsg;\n\n","outputs":1,"noerr":0,"x":1490,"y":340,"wires":[["7ed52a7170b8a213"]]},{"id":"24135e7fd269aea2","type":"server-state-changed","z":"62914984f579d881","name":"LV Entrance","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.motion_livingroom_entry","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":250,"y":440,"wires":[[],[]]},{"id":"ac9f7a787f36a843","type":"server-state-changed","z":"62914984f579d881","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.motion_bathroom_occupancy","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"(on|off)","halt_if_type":"re","halt_if_compare":"is","output_only_on_state_change":true,"x":420,"y":1320,"wires":[[],[]]},{"id":"c1130de3bab69922","type":"trigger","z":"62914984f579d881","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"3","extend":false,"units":"min","reset":"on","bytopic":"all","outputs":1,"x":910,"y":1320,"wires":[["6de65ecb56f2c8fb"]]},{"id":"d8675594a9b0b0c4","type":"switch","z":"62914984f579d881","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":750,"y":1320,"wires":[["24ef072cbe343aaf","c1130de3bab69922"],["c1130de3bab69922"]]},{"id":"24ef072cbe343aaf","type":"api-call-service","z":"62914984f579d881","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.bathrooms"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1330,"y":1240,"wires":[[]]},{"id":"6de65ecb56f2c8fb","type":"api-call-service","z":"62914984f579d881","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.bathrooms"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1390,"y":1320,"wires":[[]]},{"id":"8357a15d22ab6e4f","type":"inject","z":"62914984f579d881","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":180,"y":340,"wires":[["d46e459824e86588"]]},{"id":"0106224d5177a94d","type":"cast-to-client","z":"62914984f579d881","name":"","url":"","contentType":"audio","message":"","language":"en","ip":"192.168.40.26","port":"","volume":"10","x":1910,"y":680,"wires":[[]]},{"id":"edb50470abfa6de1","type":"function","z":"62914984f579d881","name":"Music Selector","func":"var number = msg.number;\nvar number1 = msg.number1;\nvar number2 = msg.number2;\nvar newMsg = {\n    \"payload\": {\n            \"urlList\": [\"http://192.168.0.15:8123/local/muzak/muzak\" + number + \".mp3\",\n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number1 + \".mp3\", \n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number2 + \".mp3\"]\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"x":1720,"y":680,"wires":[["0106224d5177a94d"]]},{"id":"d8094eafcc6de7a5","type":"random","z":"62914984f579d881","name":"","low":"1","high":"24","inte":"true","property":"number","x":1360,"y":600,"wires":[["6b913194f6f015c8"]]},{"id":"6b913194f6f015c8","type":"random","z":"62914984f579d881","name":"","low":"1","high":"25","inte":"true","property":"number1","x":1520,"y":600,"wires":[["25afc1e0b6179878"]]},{"id":"25afc1e0b6179878","type":"random","z":"62914984f579d881","name":"","low":"1","high":"25","inte":"true","property":"number2","x":1660,"y":600,"wires":[["edb50470abfa6de1"]]},{"id":"f4a41e9483461728","type":"inject","z":"62914984f579d881","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"str","x":1470,"y":740,"wires":[["d8094eafcc6de7a5"]]},{"id":"6637c3bb52f120c9","type":"api-call-service","z":"62914984f579d881","name":"Bathroom Speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_up","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"{\"volume_level\":\"0.7\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1050,"y":680,"wires":[[]]},{"id":"f5861041d494f37e","type":"api-current-state","z":"62914984f579d881","name":"Speaker state","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.bathroom_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1460,"y":120,"wires":[["735f509d94b7b468","b7f55b5b852817d7"]]},{"id":"dbdfaa6896bcae66","type":"inject","z":"62914984f579d881","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":920,"y":60,"wires":[["f5861041d494f37e"]]},{"id":"735f509d94b7b468","type":"debug","z":"62914984f579d881","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1490,"y":60,"wires":[]},{"id":"b7f55b5b852817d7","type":"switch","z":"62914984f579d881","name":"","property":"entity.attributes.app_name","propertyType":"msg","rules":[{"t":"neq","v":"YouTube Music","vt":"str"},{"t":"nnull"}],"checkall":"false","repair":true,"outputs":2,"x":1650,"y":120,"wires":[["1056df852f1797e7"],["6d3644c9de866147"]]},{"id":"367c6690fe1384fa","type":"function","z":"62914984f579d881","name":"Music/Selector Selector","func":"var d = new Date();\nvar h = d.getHours();\nvar number = msg.number;\nvar number1 = msg.number1;\nvar number2 = msg.number2;\n\n\nif (h > 22){\n    var brightness = \"30\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness = \"20\";\n}\nelse if (h>2 && h<7){\n    var brightness = \"10\";\n}\nelse{\n    var brightness = \"40\";\n}\n\n\n\n\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n            \"urlList\": [\"http://192.168.0.15:8123/local/muzak/muzak\" + number + \".mp3\",\n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number1 + \".mp3\", \n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number2 + \".mp3\"],\n            \"volume\": brightness\n            }\n            \n   }\n\nreturn newMsg;\n\n\n","outputs":1,"noerr":0,"x":2170,"y":600,"wires":[["07556d8fb3b72051","6aa56fbbf0d53594"]]},{"id":"07556d8fb3b72051","type":"cast-to-client","z":"62914984f579d881","name":"","url":"","contentType":"audio","message":"","language":"en","ip":"192.168.40.26","port":"","volume":"10","x":2410,"y":600,"wires":[[]]},{"id":"3fde5cf9716d799a","type":"random","z":"62914984f579d881","name":"","low":"1","high":"24","inte":"true","property":"number","x":1880,"y":500,"wires":[["3796a1ccda9b9cc1"]]},{"id":"3796a1ccda9b9cc1","type":"random","z":"62914984f579d881","name":"","low":"1","high":"25","inte":"true","property":"number1","x":2040,"y":500,"wires":[["7f024601e6f9e27e"]]},{"id":"7f024601e6f9e27e","type":"random","z":"62914984f579d881","name":"","low":"1","high":"25","inte":"true","property":"number2","x":2180,"y":500,"wires":[["367c6690fe1384fa"]]},{"id":"cee5335ff58e67eb","type":"inject","z":"62914984f579d881","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1680,"y":500,"wires":[["3fde5cf9716d799a"]]},{"id":"6aa56fbbf0d53594","type":"debug","z":"62914984f579d881","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2360,"y":520,"wires":[]},{"id":"67df1142d788cf83","type":"function","z":"62914984f579d881","name":"Music Selector","func":"var number = msg.number;\nvar number1 = msg.number1;\nvar number2 = msg.number2;\nvar newMsg = {\n    \"payload\": {\n            \"urlList\": [\"http://192.168.0.15:8123/local/muzak/muzak\" + number + \".mp3\",\n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number1 + \".mp3\", \n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number2 + \".mp3\"]\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"x":1860,"y":400,"wires":[[]]},{"id":"622de50bd63e6252","type":"function","z":"62914984f579d881","name":"Music/Selector Selector","func":"var d = new Date();\nvar h = d.getHours();\nvar number = msg.number;\nvar number1 = msg.number1;\nvar number2 = msg.number2;\n\n\nif (h > 22){\n    var brightness = \"30\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness = \"20\";\n}\nelse if (h>2 && h<7){\n    var brightness = \"10\";\n}\nelse{\n    var brightness = \"40\";\n}\n\n\n\n\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n            \"urlList\": [\"http://192.168.0.15:8123/local/muzak/muzak\" + number + \".mp3\",\n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number1 + \".mp3\", \n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number2 + \".mp3\"],\n            \"volume\": brightness\n            }\n            \n   }\n\nreturn newMsg;\n\n\n","outputs":1,"noerr":0,"x":1890,"y":300,"wires":[["ce1932e8d523fa22"]]},{"id":"28b3047be7d84633","type":"function","z":"62914984f579d881","name":"Volume Selector","func":"var d = new Date();\nvar h = d.getHours();\n\n\nif (h > 22){\n    var brightness = \"0.3\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness = \"0.2\";\n}\nelse if (h>2 && h<7){\n    var brightness = \"0.1\";\n}\nelse{\n    var brightness = \"0.4\";\n}\n\n\n\n\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n            \"data\": {\n            \"volume_level\": brightness\n            }\n            }\n            \n   }\n\nreturn newMsg;\n\n\n","outputs":1,"noerr":0,"x":920,"y":1180,"wires":[["584d53eae6c02f02","5e847e2c822d9d97"]]},{"id":"ca593d28ce376205","type":"inject","z":"62914984f579d881","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":720,"y":1180,"wires":[["28b3047be7d84633"]]},{"id":"584d53eae6c02f02","type":"api-call-service","z":"62914984f579d881","name":"Bathroom Speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1130,"y":1160,"wires":[[]]},{"id":"5e847e2c822d9d97","type":"debug","z":"62914984f579d881","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1120,"y":1200,"wires":[]},{"id":"f0b1f2ee9bc2b208","type":"api-call-service","z":"62914984f579d881","name":"cast Off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_stop","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1960,"y":160,"wires":[[]]},{"id":"6d3644c9de866147","type":"trigger","z":"62914984f579d881","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"5","extend":false,"units":"min","reset":"motion","bytopic":"all","outputs":1,"x":1770,"y":160,"wires":[["f0b1f2ee9bc2b208"]]},{"id":"d840afe02cc6e920","type":"server-state-changed","z":"62914984f579d881","name":"Bathroom door","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.door_bathroom","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":180,"y":300,"wires":[[],[]]},{"id":"ceb9c26d369631c5","type":"ha-wait-until","z":"62914984f579d881","name":"wait door open","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"binary_sensor.door_bathroom","entityIdFilterType":"exact","property":"state","comparator":"is","value":"on","valueType":"str","timeout":"30","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":false,"blockInputOverrides":true,"outputProperties":[],"x":1920,"y":340,"wires":[["87df9e89784ae13d"],[]]},{"id":"1c93657999d006e5","type":"api-call-service","z":"62914984f579d881","name":"Bathroom Light Off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.bathrooms"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload1","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2930,"y":340,"wires":[["e6d4433069732c20"]]},{"id":"87df9e89784ae13d","type":"trigger","z":"62914984f579d881","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"67","extend":false,"overrideDelay":false,"units":"s","reset":"motion","bytopic":"all","topic":"topic","outputs":1,"x":2130,"y":440,"wires":[["df7f530cd34b0563"]]},{"id":"df7f530cd34b0563","type":"ha-wait-until","z":"62914984f579d881","name":"wait door open","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"binary_sensor.door_bathroom","entityIdFilterType":"exact","property":"state","comparator":"is","value":"on","valueType":"str","timeout":"30","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":2180,"y":380,"wires":[["655e470274dffae3"],["87df9e89784ae13d"]]},{"id":"cee25095cb24a6ac","type":"api-call-service","z":"62914984f579d881","name":"cast Off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_stop","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":3940,"y":340,"wires":[[]]},{"id":"784d065a47ce5ba3","type":"api-current-state","z":"62914984f579d881","name":"Speaker state","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.bathroom_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":3520,"y":340,"wires":[["24e203f33a3e46c4"]]},{"id":"24e203f33a3e46c4","type":"switch","z":"62914984f579d881","name":"","property":"entity.attributes.app_name","propertyType":"msg","rules":[{"t":"neq","v":"YouTube Music","vt":"str"},{"t":"nnull"}],"checkall":"false","repair":true,"outputs":2,"x":3690,"y":340,"wires":[["cee25095cb24a6ac"],["8c688c81ddfeca9a"]]},{"id":"5cd97bed1ec8569f","type":"api-call-service","z":"62914984f579d881","name":"cast Off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_stop","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":3960,"y":380,"wires":[[]]},{"id":"8c688c81ddfeca9a","type":"trigger","z":"62914984f579d881","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"5","extend":false,"units":"min","reset":"motion","bytopic":"all","outputs":1,"x":3810,"y":380,"wires":[["5cd97bed1ec8569f"]]},{"id":"e6d4433069732c20","type":"api-current-state","z":"62914984f579d881","name":"Speaker state","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.home_group","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3220,"y":340,"wires":[["784d065a47ce5ba3"],[]]},{"id":"18757545b19255e0","type":"inject","z":"62914984f579d881","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1110,"y":120,"wires":[["b342c608e970b24c"]]},{"id":"655e470274dffae3","type":"api-current-state","z":"62914984f579d881","name":"Motion?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.motion_bathroom","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2300,"y":320,"wires":[["1c93657999d006e5"],["df7f530cd34b0563"]]},{"id":"72bfd397cd702c8e","type":"trigger","z":"2cc7bfce9974187b","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"3","extend":false,"units":"min","reset":"motion","bytopic":"all","outputs":1,"x":810,"y":160,"wires":[["84e18e21e9dd9ff4"]]},{"id":"a08f57b1171dda68","type":"comment","z":"2cc7bfce9974187b","name":"This prevent the Light from going off as long as the humidity is over 40%(Shower)","info":"","x":480,"y":280,"wires":[]},{"id":"ac3673555eeffef9","type":"change","z":"2cc7bfce9974187b","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"A","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1320,"y":400,"wires":[["9879e858bca8da07"]]},{"id":"77e5d0056da4a761","type":"api-current-state","z":"2cc7bfce9974187b","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.bathrooms","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":650,"y":400,"wires":[[],["fadf63c0ba97e35a","c486434c68967ba8"]]},{"id":"8d27e7aef34d8dab","type":"trigger","z":"2cc7bfce9974187b","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"10","extend":false,"units":"s","reset":"on","bytopic":"all","outputs":1,"x":990,"y":400,"wires":[["0b9fb1d9b33f9466"]]},{"id":"9879e858bca8da07","type":"api-call-service","z":"2cc7bfce9974187b","name":"Bathroom Light Off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.bathrooms"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1510,"y":400,"wires":[[]]},{"id":"798f2bb5acabecfe","type":"random","z":"2cc7bfce9974187b","name":"","low":"1","high":"36","inte":"true","property":"number","x":1220,"y":220,"wires":[["24cab57cb10e5c89"]]},{"id":"fadf63c0ba97e35a","type":"change","z":"2cc7bfce9974187b","name":"on","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":850,"y":400,"wires":[["8d27e7aef34d8dab"]]},{"id":"22c7389336042dde","type":"api-call-service","z":"2cc7bfce9974187b","name":"cast Off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_stop","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2020,"y":100,"wires":[[]]},{"id":"0b9fb1d9b33f9466","type":"api-current-state","z":"2cc7bfce9974187b","name":"Motion state","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.motion_bathroom","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":1150,"y":400,"wires":[[],["ac3673555eeffef9"]]},{"id":"0725e0584ea76f47","type":"api-call-service","z":"2cc7bfce9974187b","name":"Bathroom Light Off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.bathrooms"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload1","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1630,"y":140,"wires":[[]]},{"id":"84e18e21e9dd9ff4","type":"api-current-state","z":"2cc7bfce9974187b","name":"Humidity","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"sensor.humidity_bathroom","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":960,"y":120,"wires":[["706ed5be7a91d3e0"]]},{"id":"f4d7e893a7e154e0","type":"api-call-service","z":"2cc7bfce9974187b","name":"Bathroom Light on","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.bathrooms"],"data":"{\"color_temp\":\"255\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1290,"y":260,"wires":[["feba2e5b4509af16"]]},{"id":"706ed5be7a91d3e0","type":"switch","z":"2cc7bfce9974187b","name":"","property":"payload","propertyType":"msg","rules":[{"t":"lt","v":"65","vt":"str"},{"t":"gt","v":"65","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1110,"y":140,"wires":[["929d2e17b7d7b5ae","0725e0584ea76f47"],["72bfd397cd702c8e"]]},{"id":"c3a67edf4a8fa7e6","type":"trigger","z":"2cc7bfce9974187b","name":"","op1":"1","op2":"","op1type":"str","op2type":"str","duration":"-30","extend":true,"units":"s","reset":"no_motion","bytopic":"all","outputs":1,"x":810,"y":220,"wires":[["647c57e703d4c7af","f13cfb67bbf400d5"]]},{"id":"e748d3e4a6d8acc7","type":"change","z":"2cc7bfce9974187b","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"motion","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":600,"y":220,"wires":[["72bfd397cd702c8e","c3a67edf4a8fa7e6"]]},{"id":"de4d3a6119fb72fd","type":"change","z":"2cc7bfce9974187b","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"no_motion","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":600,"y":140,"wires":[["72bfd397cd702c8e","c3a67edf4a8fa7e6"]]},{"id":"0949695b2744d2bf","type":"switch","z":"2cc7bfce9974187b","name":"","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"off","vt":"str"},{"t":"cont","v":"on","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":490,"y":880,"wires":[["bb3d35298bb0f780"],["302111b2c104b0c5"]]},{"id":"1e3486819572b13d","type":"api-call-service","z":"2cc7bfce9974187b","name":"Bathroom Speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"{\"volume_level\":\"0.0\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1070,"y":900,"wires":[[]]},{"id":"f2e31ce0ff5a5b1c","type":"api-call-service","z":"2cc7bfce9974187b","name":"Bathroom Speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1210,"y":820,"wires":[[]]},{"id":"647c57e703d4c7af","type":"api-current-state","z":"2cc7bfce9974187b","name":"Speaker state","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"playing","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.bathroom_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1040,"y":220,"wires":[[],["798f2bb5acabecfe"]]},{"id":"7e85042e228f6e2d","type":"server-state-changed","z":"2cc7bfce9974187b","name":"Door change?","server":"7ab5c227.a3ce8c","version":4,"outputs":1,"for":"0","forType":"num","forUnits":"minutes","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.door_bathroom","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":330,"y":880,"wires":[["0949695b2744d2bf"]]},{"id":"f13cfb67bbf400d5","type":"api-current-state","z":"2cc7bfce9974187b","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.bathrooms","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":930,"y":260,"wires":[[],["0ea02b5030d1e7c1"]]},{"id":"4c6da4d01d3f88ca","type":"server-state-changed","z":"2cc7bfce9974187b","name":"Humidity over 65","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.humidity_bathroom","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"65","halt_if_type":"num","halt_if_compare":"gt","output_only_on_state_change":true,"x":260,"y":540,"wires":[["909f646954961822"],["0390741daffca5b2"]]},{"id":"909f646954961822","type":"api-call-service","z":"2cc7bfce9974187b","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_on","areaId":[],"deviceId":[],"entityId":["switch.bathroom_fan"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":670,"y":500,"wires":[["a62f85af1cd5362b"]]},{"id":"0390741daffca5b2","type":"api-call-service","z":"2cc7bfce9974187b","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_off","areaId":[],"deviceId":[],"entityId":["switch.bathroom_fan"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":670,"y":560,"wires":[[]]},{"id":"7dddb776442f3bf6","type":"api-current-state","z":"2cc7bfce9974187b","name":"Door state","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.door_bathroom","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"door","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1670,"y":220,"wires":[["a6f2af2b1910de58"]]},{"id":"a6f2af2b1910de58","type":"switch","z":"2cc7bfce9974187b","name":"","property":"door","propertyType":"msg","rules":[{"t":"cont","v":"on","vt":"str"},{"t":"cont","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1810,"y":220,"wires":[["8a6dfab444a65854"],["27438a98bf41c717"]]},{"id":"0ea02b5030d1e7c1","type":"function","z":"2cc7bfce9974187b","name":"Time","func":"var d = new Date();\nvar h = d.getHours();\n\nif (h > 22){\n    var brightness = \"80\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness = \"75\";\n}\nelse if (h>2 && h<7){\n    var brightness = \"50\";\n}\nelse{\n    var brightness = \"100\";\n}\n\nvar newMsg = \n\n{ \n    \"payload\": {\n                data: {\n                         \"brightness_pct\": brightness                      }\n               } \n};\nreturn newMsg;\n\n","outputs":1,"noerr":0,"x":1130,"y":260,"wires":[["f4d7e893a7e154e0"]]},{"id":"3ce1bd2af33f10ed","type":"ha-wait-until","z":"2cc7bfce9974187b","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"binary_sensor.door_bathroom","entityIdFilterType":"exact","property":"state","comparator":"is","value":"off","valueType":"str","timeout":"30","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":2400,"y":220,"wires":[["9d53207076965daa"],[]]},{"id":"9d53207076965daa","type":"api-call-service","z":"2cc7bfce9974187b","name":"Bathroom Speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"{\"volume_level\":\"0.4\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2550,"y":220,"wires":[[]]},{"id":"c486434c68967ba8","type":"function","z":"2cc7bfce9974187b","name":"Time","func":"var d = new Date();\nvar h = d.getHours();\n\nif (h > 22){\n    var brightness = \"80\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness = \"75\";\n}\nelse if (h>2 && h<7){\n    var brightness = \"50\";\n}\nelse{\n    var brightness = \"100\";\n}\n\nvar newMsg = \n\n{ \n    \"payload\": {\n                data: {\n                         \"brightness_pct\": brightness                      }\n               } \n};\nreturn newMsg;\n\n","outputs":1,"noerr":0,"x":850,"y":440,"wires":[["040c052c317ea502"]]},{"id":"040c052c317ea502","type":"api-call-service","z":"2cc7bfce9974187b","name":"Bathroom Light on","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.bathrooms"],"data":"{\"color_temp\":\"255\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1010,"y":440,"wires":[[]]},{"id":"e03992e5db39fc03","type":"cast-to-client","z":"2cc7bfce9974187b","name":"","url":"","contentType":"audio","message":"","language":"en","ip":"192.168.40.26","port":"","volume":"10","x":2210,"y":220,"wires":[["3ce1bd2af33f10ed"]]},{"id":"f415c5780d5c46a2","type":"cast-to-client","z":"2cc7bfce9974187b","name":"","url":"","contentType":"audio","message":"","language":"en","ip":"192.168.40.26","port":"","volume":"40","x":2210,"y":260,"wires":[[]]},{"id":"bb3d35298bb0f780","type":"api-current-state","z":"2cc7bfce9974187b","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"switch.bathroom_fan","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":740,"y":820,"wires":[["f47f068525e5c9ee"],["8dde3ccdeea9f81e"]]},{"id":"90d3f381bf7b6b5a","type":"api-call-service","z":"2cc7bfce9974187b","name":"Bathroom Speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1210,"y":720,"wires":[[]]},{"id":"24cab57cb10e5c89","type":"random","z":"2cc7bfce9974187b","name":"","low":"1","high":"36","inte":"true","property":"number1","x":1380,"y":220,"wires":[["da6220a10da3b0db"]]},{"id":"da6220a10da3b0db","type":"random","z":"2cc7bfce9974187b","name":"","low":"1","high":"36","inte":"true","property":"number2","x":1520,"y":220,"wires":[["7dddb776442f3bf6"]]},{"id":"8a6dfab444a65854","type":"function","z":"2cc7bfce9974187b","name":"Music Selector","func":"var number = msg.number;\nvar number1 = msg.number1;\nvar number2 = msg.number2;\nvar newMsg = {\n    \"payload\": {\n            \"urlList\": [\"http://192.168.0.15:8123/local/muzak/muzak\" + number + \".mp3\",\n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number1 + \".mp3\", \n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number2 + \".mp3\"]\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"x":1960,"y":220,"wires":[["e03992e5db39fc03"]]},{"id":"a62f85af1cd5362b","type":"api-current-state","z":"2cc7bfce9974187b","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.door_bathroom","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":950,"y":500,"wires":[[],[]]},{"id":"d43ad0c97eb40662","type":"server-state-changed","z":"2cc7bfce9974187b","name":"Humidity over 65","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.humidity_bathroom","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"65","halt_if_type":"num","halt_if_compare":"gt","output_only_on_state_change":true,"x":280,"y":660,"wires":[["c68bfe6d7b1dce87"],[]]},{"id":"c68bfe6d7b1dce87","type":"trigger","z":"2cc7bfce9974187b","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"20","extend":false,"units":"min","reset":"on","bytopic":"all","outputs":1,"x":510,"y":640,"wires":[["89bc79868ccab1c9"]]},{"id":"89bc79868ccab1c9","type":"api-current-state","z":"2cc7bfce9974187b","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.door_bathroom","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":790,"y":640,"wires":[[],["4496a13e8fecdf98"]]},{"id":"017caa3fded6319a","type":"server-state-changed","z":"2cc7bfce9974187b","name":"Bathroom Motion","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.motion_bathroom","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":280,"y":200,"wires":[["de4d3a6119fb72fd"],["e748d3e4a6d8acc7"]]},{"id":"34542c1839078cfc","type":"server-state-changed","z":"2cc7bfce9974187b","name":"Kitchen Entrance","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.motion_kitchen_entrance","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":360,"y":400,"wires":[["77e5d0056da4a761"],[]]},{"id":"302111b2c104b0c5","type":"api-current-state","z":"2cc7bfce9974187b","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"media_player.living_room_tv","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":750,"y":900,"wires":[["1e3486819572b13d"],["33e279e38362db46"]]},{"id":"991e3c063bacac2c","type":"api-call-service","z":"2cc7bfce9974187b","name":"Bathroom Speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"{\"volume_level\":\"0.1\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1310,"y":960,"wires":[[]]},{"id":"b8ba99a2c157e81a","type":"api-call-service","z":"2cc7bfce9974187b","name":"Bathroom Light on","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.bathrooms"],"data":"{\"color_temp\":\"255\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1770,"y":260,"wires":[[]]},{"id":"feba2e5b4509af16","type":"trigger","z":"2cc7bfce9974187b","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"4","extend":false,"units":"s","reset":"motion","bytopic":"all","outputs":1,"x":1460,"y":260,"wires":[["a42972d9aaa1fc4c"]]},{"id":"a42972d9aaa1fc4c","type":"function","z":"2cc7bfce9974187b","name":"Time","func":"var d = new Date();\nvar h = d.getHours();\n\nif (h > 22){\n    var brightness = \"80\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness = \"75\";\n}\nelse if (h>2 && h<7){\n    var brightness = \"50\";\n}\nelse{\n    var brightness = \"100\";\n}\n\nvar newMsg = \n\n{ \n    \"payload\": {\n                data: {\n                         \"brightness_pct\": brightness                      }\n               } \n};\nreturn newMsg;\n\n","outputs":1,"noerr":0,"x":1590,"y":260,"wires":[["b8ba99a2c157e81a"]]},{"id":"7bcc74c430267c7b","type":"server-state-changed","z":"2cc7bfce9974187b","name":"LV Entrance","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.motion_livingroom_entry","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":350,"y":440,"wires":[["77e5d0056da4a761"],[]]},{"id":"33e279e38362db46","type":"api-current-state","z":"2cc7bfce9974187b","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"playing","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.party_group","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1000,"y":960,"wires":[["af14d9a12d4a59bc"],["991e3c063bacac2c"]]},{"id":"106c085522e3711c","type":"inject","z":"2cc7bfce9974187b","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":500,"y":980,"wires":[["302111b2c104b0c5"]]},{"id":"69d559c61533a359","type":"api-call-service","z":"2cc7bfce9974187b","name":"Bathroom Speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1510,"y":920,"wires":[[]]},{"id":"f3699917c5030c49","type":"server-state-changed","z":"2cc7bfce9974187b","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.motion_bathroom_occupancy","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"(on|off)","halt_if_type":"re","halt_if_compare":"is","output_only_on_state_change":true,"x":520,"y":1240,"wires":[["73eb582d270883a0"],[]]},{"id":"dbf2ec4f77027946","type":"trigger","z":"2cc7bfce9974187b","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"3","extend":false,"units":"min","reset":"on","bytopic":"all","outputs":1,"x":1010,"y":1240,"wires":[["652772e71a16d7b5"]]},{"id":"73eb582d270883a0","type":"switch","z":"2cc7bfce9974187b","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":850,"y":1240,"wires":[["4d380fd2d7b3ab61","dbf2ec4f77027946"],["dbf2ec4f77027946"]]},{"id":"4d380fd2d7b3ab61","type":"api-call-service","z":"2cc7bfce9974187b","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.bathrooms"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1190,"y":1180,"wires":[[]]},{"id":"652772e71a16d7b5","type":"api-call-service","z":"2cc7bfce9974187b","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.bathrooms"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1230,"y":1240,"wires":[[]]},{"id":"8681b7e5b00b09a7","type":"inject","z":"2cc7bfce9974187b","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":260,"y":260,"wires":[["e748d3e4a6d8acc7"]]},{"id":"38f077a757506538","type":"inject","z":"2cc7bfce9974187b","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":240,"y":100,"wires":[["de4d3a6119fb72fd"]]},{"id":"a70b30bcf42f719b","type":"cast-to-client","z":"2cc7bfce9974187b","name":"","url":"","contentType":"audio","message":"","language":"en","ip":"192.168.40.26","port":"","volume":"10","x":2010,"y":600,"wires":[[]]},{"id":"2f3cadb8a25ae06e","type":"function","z":"2cc7bfce9974187b","name":"Music Selector","func":"var number = msg.number;\nvar number1 = msg.number1;\nvar number2 = msg.number2;\nvar newMsg = {\n    \"payload\": {\n            \"urlList\": [\"http://192.168.0.15:8123/local/muzak/muzak\" + number + \".mp3\",\n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number1 + \".mp3\", \n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number2 + \".mp3\"]\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"x":1820,"y":600,"wires":[["a70b30bcf42f719b"]]},{"id":"b4fd6126ba52bc5a","type":"random","z":"2cc7bfce9974187b","name":"","low":"1","high":"24","inte":"true","property":"number","x":1460,"y":520,"wires":[["125a838d269315da"]]},{"id":"125a838d269315da","type":"random","z":"2cc7bfce9974187b","name":"","low":"1","high":"25","inte":"true","property":"number1","x":1620,"y":520,"wires":[["f8c91f51c2505f6e"]]},{"id":"f8c91f51c2505f6e","type":"random","z":"2cc7bfce9974187b","name":"","low":"1","high":"25","inte":"true","property":"number2","x":1760,"y":520,"wires":[["2f3cadb8a25ae06e"]]},{"id":"d3bd72c59869e55f","type":"inject","z":"2cc7bfce9974187b","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"str","x":1570,"y":660,"wires":[["b4fd6126ba52bc5a"]]},{"id":"4496a13e8fecdf98","type":"api-call-service","z":"2cc7bfce9974187b","name":"Bathroom Speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_up","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1090,"y":640,"wires":[["86fa788a366e9443"]]},{"id":"9faf5885ac1f4b09","type":"inject","z":"2cc7bfce9974187b","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":820,"y":740,"wires":[[]]},{"id":"86fa788a366e9443","type":"api-call-service","z":"2cc7bfce9974187b","name":"Bathroom Speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_up","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1290,"y":640,"wires":[[]]},{"id":"4dc927806423e211","type":"api-call-service","z":"2cc7bfce9974187b","name":"Bathroom Speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_up","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"{\"volume_level\":\"0.7\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1150,"y":600,"wires":[[]]},{"id":"929d2e17b7d7b5ae","type":"api-current-state","z":"2cc7bfce9974187b","name":"Speaker state","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.bathroom_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1500,"y":100,"wires":[["3d9ba4db5de4d062","3c4d2f55695bd15b"]]},{"id":"6f9b638ff2bf736b","type":"inject","z":"2cc7bfce9974187b","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1000,"y":40,"wires":[["929d2e17b7d7b5ae"]]},{"id":"3d9ba4db5de4d062","type":"debug","z":"2cc7bfce9974187b","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1660,"y":60,"wires":[]},{"id":"3c4d2f55695bd15b","type":"switch","z":"2cc7bfce9974187b","name":"","property":"entity.attributes.app_name","propertyType":"msg","rules":[{"t":"neq","v":"YouTube Music","vt":"str"},{"t":"nnull"}],"checkall":"false","repair":true,"outputs":2,"x":1670,"y":100,"wires":[["22c7389336042dde"],["779a26c8815a8b98"]]},{"id":"44538583e2aefeeb","type":"function","z":"2cc7bfce9974187b","name":"Music/Selector Selector","func":"var d = new Date();\nvar h = d.getHours();\nvar number = msg.number;\nvar number1 = msg.number1;\nvar number2 = msg.number2;\n\n\nif (h > 22){\n    var brightness = \"30\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness = \"20\";\n}\nelse if (h>2 && h<7){\n    var brightness = \"10\";\n}\nelse{\n    var brightness = \"40\";\n}\n\n\n\n\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n            \"urlList\": [\"http://192.168.0.15:8123/local/muzak/muzak\" + number + \".mp3\",\n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number1 + \".mp3\", \n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number2 + \".mp3\"],\n            \"volume\": brightness\n            }\n            \n   }\n\nreturn newMsg;\n\n\n","outputs":1,"noerr":0,"x":2270,"y":520,"wires":[["4f03e8191637daa8","964eb61456296b66"]]},{"id":"4f03e8191637daa8","type":"cast-to-client","z":"2cc7bfce9974187b","name":"","url":"","contentType":"audio","message":"","language":"en","ip":"192.168.40.26","port":"","volume":"10","x":2510,"y":520,"wires":[[]]},{"id":"3fe9ada2261aacf2","type":"random","z":"2cc7bfce9974187b","name":"","low":"1","high":"24","inte":"true","property":"number","x":1980,"y":420,"wires":[["88263d677b7cd8e3"]]},{"id":"88263d677b7cd8e3","type":"random","z":"2cc7bfce9974187b","name":"","low":"1","high":"25","inte":"true","property":"number1","x":2140,"y":420,"wires":[["1571cdbcb7410dd5"]]},{"id":"1571cdbcb7410dd5","type":"random","z":"2cc7bfce9974187b","name":"","low":"1","high":"25","inte":"true","property":"number2","x":2280,"y":420,"wires":[["44538583e2aefeeb"]]},{"id":"9d98bd31319ef852","type":"inject","z":"2cc7bfce9974187b","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1780,"y":420,"wires":[["3fe9ada2261aacf2"]]},{"id":"964eb61456296b66","type":"debug","z":"2cc7bfce9974187b","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":2460,"y":440,"wires":[]},{"id":"16101b9482ba94f1","type":"function","z":"2cc7bfce9974187b","name":"Music Selector","func":"var number = msg.number;\nvar number1 = msg.number1;\nvar number2 = msg.number2;\nvar newMsg = {\n    \"payload\": {\n            \"urlList\": [\"http://192.168.0.15:8123/local/muzak/muzak\" + number + \".mp3\",\n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number1 + \".mp3\", \n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number2 + \".mp3\"]\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"x":1960,"y":320,"wires":[[]]},{"id":"27438a98bf41c717","type":"function","z":"2cc7bfce9974187b","name":"Music/Selector Selector","func":"var d = new Date();\nvar h = d.getHours();\nvar number = msg.number;\nvar number1 = msg.number1;\nvar number2 = msg.number2;\n\n\nif (h > 22){\n    var brightness = \"30\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness = \"20\";\n}\nelse if (h>2 && h<7){\n    var brightness = \"10\";\n}\nelse{\n    var brightness = \"40\";\n}\n\n\n\n\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n            \"urlList\": [\"http://192.168.0.15:8123/local/muzak/muzak\" + number + \".mp3\",\n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number1 + \".mp3\", \n            \"http://192.168.0.15:8123/local/muzak/muzak\" + number2 + \".mp3\"],\n            \"volume\": brightness\n            }\n            \n   }\n\nreturn newMsg;\n\n\n","outputs":1,"noerr":0,"x":1990,"y":260,"wires":[["f415c5780d5c46a2"]]},{"id":"18337752adde25a7","type":"function","z":"2cc7bfce9974187b","name":"Volume Selector","func":"var d = new Date();\nvar h = d.getHours();\n\n\nif (h > 22){\n    var brightness = \"0.3\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness = \"0.2\";\n}\nelse if (h>2 && h<7){\n    var brightness = \"0.1\";\n}\nelse{\n    var brightness = \"0.4\";\n}\n\n\n\n\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n            \"data\": {\n            \"volume_level\": brightness\n            }\n            }\n            \n   }\n\nreturn newMsg;\n\n\n","outputs":1,"noerr":0,"x":1020,"y":1100,"wires":[["bb9aaf7ba88daf40","5b0399a8082b4ded"]]},{"id":"92e85c8e307db927","type":"inject","z":"2cc7bfce9974187b","name":"","repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":820,"y":1100,"wires":[["18337752adde25a7"]]},{"id":"bb9aaf7ba88daf40","type":"api-call-service","z":"2cc7bfce9974187b","name":"Bathroom Speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1230,"y":1080,"wires":[[]]},{"id":"5b0399a8082b4ded","type":"debug","z":"2cc7bfce9974187b","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1180,"y":1140,"wires":[]},{"id":"8dde3ccdeea9f81e","type":"function","z":"2cc7bfce9974187b","name":"Volume Selector","func":"var d = new Date();\nvar h = d.getHours();\n\n\nif (h > 22){\n    var brightness = \"0.35\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness = \"0.25\";\n}\nelse if (h>2 && h<8){\n    var brightness = \"0.15\";\n}\nelse{\n    var brightness = \"0.4\";\n}\n\n\n\n\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n            \"data\": {\n            \"volume_level\": brightness\n            }\n            }\n            \n   }\n\nreturn newMsg;\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1000,"y":820,"wires":[["f2e31ce0ff5a5b1c"]]},{"id":"f47f068525e5c9ee","type":"function","z":"2cc7bfce9974187b","name":"Volume Selector","func":"var d = new Date();\nvar h = d.getHours();\n\n\nif (h > 22){\n    var brightness = \"0.4\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness = \"0.35\";\n}\nelse if (h>2 && h<7){\n    var brightness = \"0.3\";\n}\nelse{\n    var brightness = \"0.4\";\n}\n\n\n\n\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n            \"data\": {\n            \"volume_level\": brightness\n            }\n            }\n            \n   }\n\nreturn newMsg;\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1000,"y":760,"wires":[["90d3f381bf7b6b5a"]]},{"id":"0b6d18d1e8b70efd","type":"api-call-service","z":"2cc7bfce9974187b","name":"cast Off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_stop","areaId":[],"deviceId":[],"entityId":["media_player.bathroom_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2040,"y":140,"wires":[[]]},{"id":"779a26c8815a8b98","type":"trigger","z":"2cc7bfce9974187b","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"5","extend":false,"units":"min","reset":"motion","bytopic":"all","outputs":1,"x":1850,"y":140,"wires":[["0b6d18d1e8b70efd"]]},{"id":"57b7182be5211537","type":"server-state-changed","z":"2cc7bfce9974187b","name":"Bathroom door","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.door_bathroom","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":260,"y":160,"wires":[["de4d3a6119fb72fd"],["e748d3e4a6d8acc7"]]},{"id":"af14d9a12d4a59bc","type":"function","z":"2cc7bfce9974187b","name":"Volume Selector","func":"var d = new Date();\nvar h = d.getHours();\n\n\nif (h > 22){\n    var brightness = \"0.35\";\n}\nelse if (h >= 0 && h <= 2 ){\n    var brightness = \"0.25\";\n}\nelse if (h>2 && h<8){\n    var brightness = \"0.15\";\n}\nelse{\n    var brightness = \"0.4\";\n}\n\n\n\n\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n            \"data\": {\n            \"volume_level\": brightness\n            }\n            }\n            \n   }\n\nreturn newMsg;\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1280,"y":920,"wires":[["69d559c61533a359"]]},{"id":"e42173d3ee832046","type":"server-events","z":"14484d2a357fa501","name":"Ringer","server":"7ab5c227.a3ce8c","version":2,"eventType":"zha_event","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":170,"y":520,"wires":[[]]},{"id":"af8b05e8de50da59","type":"http request","z":"14484d2a357fa501","name":"[POST] Recognize Double-Take","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://192.168.0.14:3000/api/recognize?url=http://192.168.0.15:8123/local/ring.jpg&camera=camera.facecam","tls":"","persist":false,"proxy":"","authType":"","x":1310,"y":680,"wires":[["076cb4627269321c","f546f47e34358c73"]]},{"id":"96b3d130e3563de0","type":"api-call-service","z":"14484d2a357fa501","name":"Save Facecam Ring.jpg","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.facecam"],"data":"{\"filename\":\"/config/www/ring.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1030,"y":680,"wires":[["af8b05e8de50da59"]]},{"id":"0bc207fe43223f88","type":"debug","z":"14484d2a357fa501","name":"Face","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1610,"y":720,"wires":[]},{"id":"34cdf332c6ebfd19","type":"inject","z":"14484d2a357fa501","name":"click","props":[{"p":"payload.event.command","v":"click","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":630,"y":720,"wires":[["57590a930154b3b5"]]},{"id":"9891b32c5fd5257a","type":"inject","z":"14484d2a357fa501","name":"click","props":[{"p":"payload.event.command","v":"click","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":1550,"y":460,"wires":[["af8b05e8de50da59"]]},{"id":"076cb4627269321c","type":"json","z":"14484d2a357fa501","name":"toJson","property":"payload","action":"","pretty":true,"x":1510,"y":680,"wires":[["f5b71d7a68b6bf15","0bc207fe43223f88"]]},{"id":"5db6ae5b9dd8cdf8","type":"inject","z":"14484d2a357fa501","name":"scan","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payloadType":"date","x":1250,"y":900,"wires":[["dd31bc940ba436cd"]]},{"id":"8e6e4a3476037a0a","type":"api-current-state","z":"14484d2a357fa501","name":"Double take Wyzecam over 0","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"num","halt_if_compare":"gt","entity_id":"sensor.double_take_wyzecam","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"entity","propertyType":"msg","value":"","valueType":"entity"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1040,"y":560,"wires":[[]]},{"id":"8fbdc854c3139373","type":"debug","z":"14484d2a357fa501","name":"Front","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1610,"y":580,"wires":[]},{"id":"5b10e27560a87f12","type":"api-call-service","z":"14484d2a357fa501","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.door_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1120,"y":780,"wires":[["dd31bc940ba436cd"]]},{"id":"85dd28056bc51434","type":"switch","z":"14484d2a357fa501","name":"double","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"single","vt":"str"},{"t":"cont","v":"double","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":770,"y":880,"wires":[[],["fc8fbf5aa1970461"]]},{"id":"fc8fbf5aa1970461","type":"api-current-state","z":"14484d2a357fa501","name":"rang?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.door_rang","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1190,"y":840,"wires":[["e6e3ef3912aff7f6"],[]]},{"id":"e6e3ef3912aff7f6","type":"api-call-service","z":"14484d2a357fa501","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.door_double_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1340,"y":840,"wires":[["f1f790880aa9080d"]]},{"id":"f1f790880aa9080d","type":"trigger","z":"14484d2a357fa501","name":"","op1":"","op2":"1","op1type":"nul","op2type":"num","duration":"1","extend":false,"units":"min","reset":"","bytopic":"all","outputs":1,"x":1510,"y":840,"wires":[["9c240a82d84da6d9"]]},{"id":"9c240a82d84da6d9","type":"api-call-service","z":"14484d2a357fa501","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.door_double_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1680,"y":840,"wires":[[]]},{"id":"8e3afe4418dd544b","type":"trigger","z":"14484d2a357fa501","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"45","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":750,"y":780,"wires":[["5b10e27560a87f12"]]},{"id":"4e24196273b44e21","type":"debug","z":"14484d2a357fa501","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1030,"y":1260,"wires":[]},{"id":"b438aff1211d4c4d","type":"server-state-changed","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":1,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.double_take_reolink","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":710,"y":1280,"wires":[["4e24196273b44e21"]]},{"id":"c5041027b8e134e0","type":"function","z":"14484d2a357fa501","name":"cam set","func":"// SETTINGS\nvar required_conf = 75;\n// SETTINGS\n\n\nvar matches = msg.entity.attributes.matches;\n\nvar recoface = new Object();\nvar recofacesortable = [];\nvar name = \"\";\nvar camera = \"camera.front_door\";\nvar conf = \"\";\nvar reconame = \"\";\nvar confidence = \"\";\nvar matched_faces_count = 0;\nvar reco = \"\";\n//declarations\nif ( matches.length > 0){\n\n\n    for (i = 0; i < matches.length; i++){\n\n                var name = matches[i].name;\n \t\t\t\tvar conf = matches[i].confidence;\n \t\t\t\trecofacesortable.push([name, conf, camera]);\n \t\t\t\tvar matched_faces_count = (matched_faces_count + 1);\n        \n    }\n} else {\n    \n}\n\nif (typeof msg.payload.unknown!==\"undefined\"){\n    recofacesortable.push([\"Unknown\", \"0\", camera]);\n}\n\n\n\n  var test = {\n   \t\"payload\":  {\n\t\t\"matches\": recofacesortable,\n\t\t\"matched_faces_count\":  matched_faces_count\n   \t}\n  };\n  return test;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1640,"y":620,"wires":[["8fbdc854c3139373","18d023cf8cc0e4e3"]]},{"id":"d4cb39c44d10600f","type":"function","z":"14484d2a357fa501","name":"cam set","func":"// SETTINGS\nvar required_conf = 75;\n// SETTINGS\n\n\nvar recoface = new Object();\nvar recofacesortable = [];\nvar name = \"\";\nvar camera = \"camera.facecam\";\nvar conf = \"\";\nvar reconame = \"\";\nvar confidence = \"\";\nvar reco = \"\";\n//declarations\n\n    for (i = 0; i < msg.payload.matches.length; i++){\n\n                var name = msg.payload.matches[i].name;\n \t\t\t\tvar conf = msg.payload.matches[i].confidence;\n \t\t\t// \tif (conf > 0){\n \t\t\t\t    recofacesortable.push([name, conf, camera]);\n \t\t\t// \t}\n \t\t\t\t\n        \n    }\n\nif (typeof msg.payload.unknown!==\"undefined\"){\n    recofacesortable.push([\"Unknown\", \"0\", camera]);\n}\n    \n    \n//      \trecofacesortable.sort(function(a, b) {\n//  \t\treturn a[1] - b[1];\n//  \t}).reverse();\n \t\n//     for (i = 0; i < recofacesortable.length; i++){\n//         var reconame = recofacesortable[0][0];\n//         var confidence = recofacesortable[0][1]\n//         var camera = recofacesortable[0][2]\n        \n        \n//     }\n\n\n\n// if (confidence > required_conf) {\n// \tvar recognized = 1;\n// } else {\n// \tvar recognized = 0;\n// }\n\n// if (camera == \"face_counter_reolink\"){\n//     var camera = \"camera.reolink_static\";\n// } else if (camera == \"face_counter_facecam\"){\n//     var camera = \"camera.facecam_static\"\n// }\n\n// var newMsg = {\n// \t\"payload\": {\n// \t\t\"name\": reconame,\n// \t\t\"confidence\": confidence,\n// \t\t\"recognized\": recognized,\n//  \t\t\"camera\": camera \n// \t}\n// };\n\n//return newMsg;\n\n\n  var test = {\n   \t\"payload\":  {\n\t\t\"matches\": recofacesortable,\n// //  \t\t\"confidence\": confidence,\n// //  \t\t\"recognized\": recognized,\n// //  \t\t\"camera\": camera ,\n// //  \t\t\"recofacesortable\": recofacesortable\n   \t}\n  };\n  return test;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1320,"y":940,"wires":[[]]},{"id":"c10fbfb4d42df98e","type":"inject","z":"14484d2a357fa501","name":"click","props":[{"p":"payload.event.command","v":"click","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":810,"y":520,"wires":[["0861877d35bfe16e"]]},{"id":"18d023cf8cc0e4e3","type":"join","z":"14484d2a357fa501","name":"","mode":"custom","build":"array","property":"payload.matches","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"6","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"num","reduceFixup":"","x":1770,"y":660,"wires":[["81b44903ee46c869"]]},{"id":"81b44903ee46c869","type":"function","z":"14484d2a357fa501","name":"Face Extractor compare 7.0","func":"// SETTINGS\nvar required_conf = 80;\n// SETTINGS\n\n\nvar recoface = new Object();\nvar recofacesortable = [];\nvar name = \"\";\nvar camera = \"\";\nvar conf = \"\";\nvar reconame = \"\";\nvar recognized = 69;\nvar confidence = \"\";\nvar reco = \"\";\nvar recognized_confidently = 0;\n//declarations\n\n    for (i = 0; i < msg.payload.matches.length; i++){\n         for (y = 0; y < Object.keys(msg.payload.matches[i]).length; y++){\n                var name = msg.payload.matches[i][y][0];\n \t\t\t\tvar conf = msg.payload.matches[i][y][1];\n \t\t\t\tvar camera = msg.payload.matches[i][y][2];\n \t\t\t// \tif (conf > 0){\n \t\t\t\t    recofacesortable.push([name, conf, camera]);\n \t\t\t// \t}\n \t\t\t\t\n        }\n    }\n    \n    \n     \trecofacesortable.sort(function(a, b) {\n \t\treturn a[1] - b[1];\n \t}).reverse();\n \t\n    for (i = 0; i < recofacesortable.length; i++){\n        var reconame = recofacesortable[0][0];\n        var confidence = recofacesortable[0][1]\n        var camera = recofacesortable[0][2]\n        \n        \n    }\n\n\n\nif (confidence > required_conf) {\n\tvar recognized_confidently = 1;\n}\n\nif (confidence != \"\") {\n\tvar recognized = 1;\n} else if (confidence == \"\") {\n    var recognized = 0;\n} else { \n var recognized = \"bugging\";\n    \n}\n\n if (camera == \"camera.front_door\"){\n     var camera = \"camera.reolink_static\";\n } else if (camera == \"camera.facecam\"){\n     var camera = \"camera.facecam_static\"\n }\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"name\": reconame,\n\t\t\"confidence\": confidence,\n\t//\t\"matched_faces\": total_matched_faces,\n\t//\t\"total_faces\": total_faces,\n\t\t\"recognized_confidently\": recognized_confidently,\n\t\t\"recognized\": recognized,\n \t\t\"camera\": camera \n\t}\n};\n\nreturn newMsg;\n\n\n//  var test = {\n//  \t\"payload\": {\n// \t\t\"name\": reconame,\n// \t\t\"confidence\": confidence,\n// \t\t\"matched_faces\": total_matched_faces,\n// \t\t\"total_faces\": total_faces,\n// \t\t\"recognized\": recognized,\n// \t\t\"camera\": camera ,\n// \t\t\"recofacesortable\": recofacesortable\n//  \t}\n//  };\n//  return test;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2040,"y":660,"wires":[["40f8e21c39f3f8bc","afedb702f35b0c65","0da283caf2f22ca9"]]},{"id":"f5b71d7a68b6bf15","type":"function","z":"14484d2a357fa501","name":"cam set","func":"// SETTINGS\nvar required_conf = 75;\n// SETTINGS\n\n\nvar matches = msg.payload.matches;\n\n\nvar recoface = new Object();\nvar recofacesortable = [];\nvar name = \"\";\nvar camera = \"camera.front_door\";\nvar conf = \"\";\nvar reconame = \"\";\nvar confidence = \"\";\nvar matched_faces_count = 0;\nvar reco = \"\";\n//declarations\nif ( matches.length > 0){\n\n\n    for (i = 0; i < matches.length; i++){\n\n                var name = matches[i].name;\n \t\t\t\tvar conf = matches[i].confidence;\n \t\t\t\trecofacesortable.push([name, conf, camera]);\n \t\t\t\tvar matched_faces_count = (matched_faces_count + 1);\n        \n    }\n} else {\n    \n}\n\nif (typeof msg.payload.unknown!==\"undefined\"){\n    recofacesortable.push([\"Unknown\", \"0\", camera]);\n}\n\n\n\n  var test = {\n   \t\"payload\":  {\n\t\t\"matches\": recofacesortable,\n\t\t\"matched_faces_count\":  matched_faces_count\n   \t}\n  };\n  return test;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1640,"y":680,"wires":[["0bc207fe43223f88","18d023cf8cc0e4e3"]]},{"id":"40f8e21c39f3f8bc","type":"debug","z":"14484d2a357fa501","name":"Compare","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2040,"y":600,"wires":[]},{"id":"6c570d7a5ff63f37","type":"inject","z":"14484d2a357fa501","name":"click","props":[{"p":"payload.event.command","v":"click","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":810,"y":720,"wires":[["af8b05e8de50da59","0861877d35bfe16e"]]},{"id":"42988384b18c311e","type":"function","z":"14484d2a357fa501","name":"Time Check + Cam Passthrough","func":"\nvar timestamp = msg.entity.attributes.timestamp;\n\nvar timestampUnix = new Date(timestamp).getTime();\n\n\nvar now = Date.now();\nvar timedif = (now - timestampUnix);\n\n\nif (timedif < 100000 ){\n     var nowfinal = 1;\n } else {\n     var nowfinal = 0;};\n\n\n\n  var test = {\n   \t\"payload\":  {\n\t\t\"nowfinal\":  nowfinal\n\t\t\n   \t},\n   \t\"entity\": msg.entity,\n   \t\"data\": msg.data\n  };\n  return test;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1410,"y":620,"wires":[["c5041027b8e134e0","8fbdc854c3139373"]]},{"id":"0861877d35bfe16e","type":"api-current-state","z":"14484d2a357fa501","name":"Double take Front Door","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"num","halt_if_compare":"gt","entity_id":"sensor.double_take_front_door","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"entity","propertyType":"msg","value":"","valueType":"entity"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1030,"y":620,"wires":[["42988384b18c311e","8fbdc854c3139373"]]},{"id":"660692c291ce0d61","type":"switch","z":"14484d2a357fa501","name":"Reco Confident?","property":"payload.recognized_confidently","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":2270,"y":420,"wires":[["68e202d57728a02c"],["26ed3a6f44375dca"]]},{"id":"b0ae24686447690e","type":"trigger","z":"14484d2a357fa501","name":"Face Not reco Enough","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2660,"y":420,"wires":[["ef1dda3e1adf46b9","4a05baf3976bade9"]]},{"id":"ef1dda3e1adf46b9","type":"function","z":"14484d2a357fa501","name":"Javascript","func":"var d = new Date();\nvar h = d.getHours();\nvar m = d.getMinutes();\nvar s = d.getSeconds();\nvar camera = msg.payload.camera;\nvar confidence = 0;\n\nif (typeof msg.payload.confidence !==\"undefined\"){\nvar confidence = msg.payload.confidence;\n}\n\nvar who = \"Unknown\";\nif (typeof msg.payload.name !==\"undefined\"){\nvar who = msg.payload.name;\n}\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n        \"name\": who,\n        \"data\": {\n            \"filename\":\"/config/www/portraits/\" + who + \"/\" + who + \"-\" + camera + \"-\" + h + m + s + \"-\" + confidence + \".jpg\",\n            \"entity_id\": camera\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2880,"y":420,"wires":[["f87196b3f1cac189"]]},{"id":"f87196b3f1cac189","type":"api-call-service","z":"14484d2a357fa501","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":3060,"y":420,"wires":[["84ce3ec7603cd21c"]]},{"id":"4bc46934e4fad499","type":"api-call-service","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3420,"y":420,"wires":[["ffd73041c96aeb47"]]},{"id":"84ce3ec7603cd21c","type":"function","z":"14484d2a357fa501","name":"Javascript","func":"var d = new Date();\nvar name = msg.payload.name;\nvar m = d.getMilliseconds();\nvar snapshot = msg.payload.data.filename;\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\" + m;\n\nvar snapshot = snapshot.replace(\"\\/config\\/www\",\"https:\\/\\/hass.purgatoire.ca\\/local\");\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": \"Someone is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"image\": snapshot,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3220,"y":420,"wires":[["4bc46934e4fad499","0780bf362a29ae82"]]},{"id":"0780bf362a29ae82","type":"change","z":"14484d2a357fa501","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"payload.data.title","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":3440,"y":460,"wires":[["d71380d25baade5a"]]},{"id":"800c68555a289aa4","type":"link out","z":"14484d2a357fa501","name":"Light and Speakers","mode":"link","links":["45904ca6429d867d"],"x":3795,"y":460,"wires":[]},{"id":"4a05baf3976bade9","type":"link out","z":"14484d2a357fa501","name":"Announcement input","mode":"link","links":["6c95d201f6c9daf3"],"x":2835,"y":380,"wires":[]},{"id":"f546f47e34358c73","type":"debug","z":"14484d2a357fa501","name":"Face","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1310,"y":720,"wires":[]},{"id":"0957f7e68479d041","type":"function","z":"14484d2a357fa501","name":"Name Payload","func":"var name = msg.payload.name;\n\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"value\": name\n        }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3500,"y":80,"wires":[["7958beafd0e53872"]]},{"id":"7958beafd0e53872","type":"api-call-service","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3730,"y":80,"wires":[[]]},{"id":"c90ed1f0e41371e2","type":"api-call-service","z":"14484d2a357fa501","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3700,"y":220,"wires":[["2735223105cee635"]]},{"id":"9b2ed8dad4eaa555","type":"ha-wait-until","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"binary_sensor.door_front_outside","entityIdFilterType":"exact","property":"state","comparator":"is","value":"on","valueType":"str","timeout":"30","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":4040,"y":220,"wires":[["40e5eb0d237b3098"],["40e5eb0d237b3098"]]},{"id":"40e5eb0d237b3098","type":"api-call-service","z":"14484d2a357fa501","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.waiting_someone"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3820,"y":300,"wires":[["8d68879fab9b827e"]]},{"id":"8d68879fab9b827e","type":"api-call-service","z":"14484d2a357fa501","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4000,"y":300,"wires":[["e774c1e55caf8651"]]},{"id":"e774c1e55caf8651","type":"function","z":"14484d2a357fa501","name":"Reset Name","func":"var newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"value\": \"UNKNOWN\"\n        }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4230,"y":300,"wires":[["c314da045d710791"]]},{"id":"c314da045d710791","type":"api-call-service","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4450,"y":300,"wires":[[]]},{"id":"a0dac4bb43fa12d7","type":"debug","z":"14484d2a357fa501","name":"unlock","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3630,"y":280,"wires":[]},{"id":"899a01a3f875d158","type":"function","z":"14484d2a357fa501","name":"Javascript","func":"var d = new Date();\nvar h = d.getHours();\nvar m = d.getMinutes();\nvar s = d.getSeconds();\nvar camera = msg.payload.camera;\nvar confidence = 0;\n\nif (typeof msg.payload.confidence !==\"undefined\"){\nvar confidence = msg.payload.confidence;\n}\n\nvar who = \"Unknown\";\nif (typeof msg.payload.name !==\"undefined\"){\nvar who = msg.payload.name;\n}\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n        \"name\": who,\n        \"data\": {\n            \"filename\":\"/config/www/portraits/\" + who + \"/\" + who + \"-\" + camera + \"-\" + h + m + s + \"-\" + confidence + \".jpg\",\n            \"entity_id\": camera\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3560,"y":140,"wires":[["60741d3ede1ab113"]]},{"id":"60741d3ede1ab113","type":"api-call-service","z":"14484d2a357fa501","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":3740,"y":140,"wires":[["10d1a7633c410ac8","37637e4f196eaa61"]]},{"id":"10d1a7633c410ac8","type":"debug","z":"14484d2a357fa501","name":"result of snapchot","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3930,"y":100,"wires":[]},{"id":"8e2af2d4484e16bb","type":"api-call-service","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4100,"y":140,"wires":[[]]},{"id":"37637e4f196eaa61","type":"function","z":"14484d2a357fa501","name":"Javascript","func":"var d = new Date();\nvar name = msg.payload.name;\nvar m = d.getMilliseconds();\nvar snapshot = msg.payload.data.filename;\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\" + m;\n\nvar snapshot = snapshot.replace(\"\\/config\\/www\",\"https:\\/\\/hass.purgatoire.ca\\/local\");\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": \"Welcoming \" + name,\n\t\t\t\"data\": {\n\t\t\t\t\"image\": snapshot,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3920,"y":140,"wires":[["8e2af2d4484e16bb","85344f47f3f54884","17893907670ec826"]]},{"id":"85344f47f3f54884","type":"change","z":"14484d2a357fa501","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"payload.data.title","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,255,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":4100,"y":180,"wires":[["04566cb55ad19575"]]},{"id":"17893907670ec826","type":"debug","z":"14484d2a357fa501","name":"result before notif","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4248.571533203125,"y":85.71429443359375,"wires":[]},{"id":"b61e3fe82467cd65","type":"link out","z":"14484d2a357fa501","name":"Light and Speakers","links":["45904ca6429d867d"],"x":4495,"y":180,"wires":[]},{"id":"313337e23f238993","type":"api-call-service","z":"14484d2a357fa501","name":"unLock Door","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"lock","service":"unlock","areaId":[],"deviceId":[],"entityId":["lock.lock_front_door"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3470,"y":280,"wires":[["a0dac4bb43fa12d7","80d0e06e2010c9a2"]]},{"id":"80d0e06e2010c9a2","type":"api-current-state","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"unlocked","halt_if_type":"str","halt_if_compare":"is","entity_id":"lock.lock_front_door","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3440,"y":220,"wires":[["c90ed1f0e41371e2"],["313337e23f238993"]]},{"id":"86bd928d040cab78","type":"delay","z":"14484d2a357fa501","name":"Waiting someone","pauseType":"delay","timeout":"1","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":3270,"y":140,"wires":[["0957f7e68479d041","899a01a3f875d158","313337e23f238993","1b2ca2456333eec4"]]},{"id":"a9f7a85966e01bbb","type":"link out","z":"14484d2a357fa501","name":"Announcement input","links":["6c95d201f6c9daf3"],"x":2315,"y":500,"wires":[]},{"id":"2735223105cee635","type":"trigger","z":"14484d2a357fa501","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"25","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":3870,"y":220,"wires":[["9b2ed8dad4eaa555"]]},{"id":"2b1a7a32e0739f94","type":"trigger","z":"14484d2a357fa501","name":"Not waiting","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2550,"y":320,"wires":[["c08a9e734d4838af","836799ab5789bfdd"]]},{"id":"c08a9e734d4838af","type":"function","z":"14484d2a357fa501","name":"Javascript","func":"var d = new Date();\nvar h = d.getHours();\nvar m = d.getMinutes();\nvar s = d.getSeconds();\nvar camera = msg.payload.camera;\nvar confidence = 0;\n\nif (typeof msg.payload.confidence !==\"undefined\"){\nvar confidence = msg.payload.confidence;\n}\n\nvar who = \"Unknown\";\nif (typeof msg.payload.name !==\"undefined\"){\nvar who = msg.payload.name;\n}\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n        \"name\": who,\n        \"data\": {\n            \"filename\":\"/config/www/portraits/\" + who + \"/\" + who + \"-\" + camera + \"-\" + h + m + s + \"-\" + confidence + \".jpg\",\n            \"entity_id\": camera\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2720,"y":340,"wires":[["8ff570914988d411"]]},{"id":"8ff570914988d411","type":"api-call-service","z":"14484d2a357fa501","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2900,"y":340,"wires":[["07f0e7c1e3ba7a5d"]]},{"id":"a4f5d2304535e7f3","type":"api-call-service","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3260,"y":340,"wires":[["ffd73041c96aeb47"]]},{"id":"07f0e7c1e3ba7a5d","type":"function","z":"14484d2a357fa501","name":"Javascript","func":"var d = new Date();\nvar name = msg.payload.name;\nvar m = d.getMilliseconds();\nvar snapshot = msg.payload.data.filename;\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\" + m;\n\nvar snapshot = snapshot.replace(\"\\/config\\/www\",\"https:\\/\\/hass.purgatoire.ca\\/local\");\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"image\": snapshot,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3080,"y":340,"wires":[["a4f5d2304535e7f3","0958bee360c44c1d"]]},{"id":"0958bee360c44c1d","type":"change","z":"14484d2a357fa501","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"payload.data.title","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":2880,"y":280,"wires":[["35a1804fd59f9be8"]]},{"id":"cda6edfe40da167c","type":"link out","z":"14484d2a357fa501","name":"Light and Speakers","links":["45904ca6429d867d","ad88dbd2.4726b8","3405e943.fd3ee6","9cf42cf7ef60f645"],"x":3235,"y":280,"wires":[]},{"id":"836799ab5789bfdd","type":"link out","z":"14484d2a357fa501","name":"Announcement input","mode":"link","links":["6c95d201f6c9daf3"],"x":2675,"y":300,"wires":[]},{"id":"adca23ed01fc6039","type":"change","z":"14484d2a357fa501","name":"reset","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2330,"y":1060,"wires":[["b9c00de82e84dac3","12c4c8382e0744d9","1c53442f1f8346db","071e62f4a8fb4411"]]},{"id":"b9c00de82e84dac3","type":"function","z":"14484d2a357fa501","name":"Javascript","func":"var recoface = [];\nvar facestring = \"\"\nvar d = new Date();\nvar m = d.getMilliseconds();\nvar url = \"https://hass.purgatoire.ca/local/ring.jpg?\" + m;\nvar facestring = msg.payload;\n\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n  \"message\": \"Someone is at the door but system crashed\",\n  \"data\": {\n    \"image\": url,\n    \"actions\": [\n      {\n        \"action\": \"unlock_door\",\n        \"title\": \"Unlock The Door\"\n      }\n                \n    ]\n  }\n}\n }\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2580,"y":1020,"wires":[["f8c520c15bdc3496"]]},{"id":"f8c520c15bdc3496","type":"api-call-service","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2760,"y":1020,"wires":[["ffd73041c96aeb47"]]},{"id":"8591b7ba9e35795f","type":"trigger","z":"14484d2a357fa501","name":"Crash","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2210,"y":1040,"wires":[["adca23ed01fc6039"]]},{"id":"12c4c8382e0744d9","type":"change","z":"14484d2a357fa501","name":"Set Data for mass alert","rules":[{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"},{"t":"set","p":"message","pt":"msg","to":"Someone is at the door","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2620,"y":1100,"wires":[["d97a6ca5f29095fa"]]},{"id":"3c31668009a3d6e2","type":"link out","z":"14484d2a357fa501","name":"Light and Speakers","links":["45904ca6429d867d","ad88dbd2.4726b8","3405e943.fd3ee6","9cf42cf7ef60f645"],"x":3035,"y":1100,"wires":[]},{"id":"3225b96d73d99955","type":"catch","z":"14484d2a357fa501","name":"","scope":["af8b05e8de50da59"],"uncaught":false,"x":2070,"y":1000,"wires":[["8591b7ba9e35795f"]]},{"id":"1c53442f1f8346db","type":"debug","z":"14484d2a357fa501","name":"result before notif","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2570,"y":980,"wires":[]},{"id":"071e62f4a8fb4411","type":"link out","z":"14484d2a357fa501","name":"Announcement input","links":["6c95d201f6c9daf3"],"x":2555,"y":1060,"wires":[]},{"id":"68e202d57728a02c","type":"api-current-state","z":"14484d2a357fa501","name":"party on?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.party_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2540,"y":80,"wires":[["56d8698dc3949500"],["8cc2908d43c2b0e6"]]},{"id":"8cc2908d43c2b0e6","type":"api-current-state","z":"14484d2a357fa501","name":"Waiting Friend?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.waiting_someone","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2720,"y":140,"wires":[["56d8698dc3949500"],["2b1a7a32e0739f94"]]},{"id":"56d8698dc3949500","type":"api-current-state","z":"14484d2a357fa501","name":"Front House Motion","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.motion_front","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2890,"y":80,"wires":[["86bd928d040cab78"],["2b1a7a32e0739f94"]]},{"id":"26ed3a6f44375dca","type":"switch","z":"14484d2a357fa501","name":"Reco?","property":"payload.recognized","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":2430,"y":420,"wires":[["b0ae24686447690e"],["e3baaad7235f860d"]]},{"id":"afedb702f35b0c65","type":"api-current-state","z":"14484d2a357fa501","name":"uber","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.waiting_uber","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"uber","propertyType":"msg","value":"","valueType":"entityState"},{"property":"uberentity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2270,"y":660,"wires":[["f4192181153226e6"],[]]},{"id":"aca7f51d5f5467f6","type":"trigger","z":"14484d2a357fa501","name":"Uber","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1750,"y":780,"wires":[["3aaca7bceb8c1e16","fe9a07db7ec23343"]]},{"id":"3aaca7bceb8c1e16","type":"function","z":"14484d2a357fa501","name":"Javascript","func":"var d = new Date();\nvar h = d.getHours();\nvar m = d.getMinutes();\nvar s = d.getSeconds();\nvar camera = \"camera.front_door\";\nvar confidence = 0;\n\nif (typeof msg.payload.confidence !==\"undefined\"){\nvar confidence = msg.payload.confidence;\n}\n\nvar who = \"Unknown\";\nif (typeof msg.payload.name !==\"undefined\"){\nvar who = msg.payload.name;\n}\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n        \"name\": who,\n        \"data\": {\n            \"filename\":\"/config/www/portraits/\" + who + \"/\" + who + \"-\" + camera + \"-\" + h + m + s + \"-\" + confidence + \".jpg\",\n            \"entity_id\": camera\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1960,"y":800,"wires":[["003c13e20cc28ae5","3e51ec47ed89c67e"]]},{"id":"003c13e20cc28ae5","type":"api-call-service","z":"14484d2a357fa501","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2100,"y":800,"wires":[["b1130b17e8e654ed","30b831c8da8ccd2f"]]},{"id":"a3636fb3c619cfea","type":"api-call-service","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2540,"y":760,"wires":[[]]},{"id":"b1130b17e8e654ed","type":"function","z":"14484d2a357fa501","name":"Javascript","func":"var d = new Date();\nvar name = \"Someone\";\nvar m = d.getMilliseconds();\nvar snapshot = msg.payload.data.filename;\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\" + m;\n\nvar snapshot = snapshot.replace(\"\\/config\\/www\",\"https:\\/\\/hass.purgatoire.ca\\/local\");\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"image\": snapshot,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2240,"y":800,"wires":[["a3636fb3c619cfea","5ced15bcb2b21f09"]]},{"id":"5ced15bcb2b21f09","type":"change","z":"14484d2a357fa501","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"payload.data.title","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":2520,"y":840,"wires":[["dd61d0b2cad7a585","5df29bf9a155a455"]]},{"id":"9bcf0ff17f4166b3","type":"link out","z":"14484d2a357fa501","name":"Light and Speakers","links":["45904ca6429d867d"],"x":2935,"y":860,"wires":[]},{"id":"fe9a07db7ec23343","type":"api-call-service","z":"14484d2a357fa501","name":"to package","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"script","service":"ptz_to_package","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1930,"y":760,"wires":[["87741f0405d05c21","a3954cb431d13482","93ce05f120ded01c"]]},{"id":"87741f0405d05c21","type":"link out","z":"14484d2a357fa501","name":"Announcement input","links":["6c95d201f6c9daf3"],"x":2035,"y":760,"wires":[]},{"id":"30b831c8da8ccd2f","type":"debug","z":"14484d2a357fa501","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2190,"y":820,"wires":[]},{"id":"3e51ec47ed89c67e","type":"debug","z":"14484d2a357fa501","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2070,"y":840,"wires":[]},{"id":"ba467450b6d6dcd2","type":"api-call-service","z":"14484d2a357fa501","name":"to regular position","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"script","service":"ptz_to_doorway","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2290,"y":720,"wires":[[]]},{"id":"a3954cb431d13482","type":"ha-wait-until","z":"14484d2a357fa501","name":"lock opens?","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"unlocked","valueType":"str","timeout":"120","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":false,"blockInputOverrides":true,"outputProperties":[],"x":2090,"y":720,"wires":[["ba467450b6d6dcd2"],["ba467450b6d6dcd2"]]},{"id":"5297d6f39c193257","type":"change","z":"14484d2a357fa501","name":"reset","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2790,"y":500,"wires":[["734b7304e89ca79e","99f47b25145a1f09","bdb95ccd4331168c"]]},{"id":"734b7304e89ca79e","type":"function","z":"14484d2a357fa501","name":"Javascript","func":"var recoface = [];\nvar facestring = \"\"\nvar d = new Date();\nvar m = d.getMilliseconds();\nvar url = \"https://hass.purgatoire.ca/local/ring.jpg?\" + m;\nvar facestring = msg.payload;\n\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n  \"message\": \"Someone is at the door\",\n  \"data\": {\n    \"image\": url,\n    \"actions\": [\n      {\n        \"action\": \"unlock_door\",\n        \"title\": \"Unlock The Door\"\n      }\n                \n    ]\n  }\n}\n }\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2960,"y":480,"wires":[["f6b532ffea29d27b"]]},{"id":"f6b532ffea29d27b","type":"api-call-service","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3140,"y":480,"wires":[["ffd73041c96aeb47","40200dddf08a041f"]]},{"id":"e3baaad7235f860d","type":"trigger","z":"14484d2a357fa501","name":"No Face","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2640,"y":500,"wires":[["5297d6f39c193257"]]},{"id":"99f47b25145a1f09","type":"change","z":"14484d2a357fa501","name":"Set Data for mass alert","rules":[{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"},{"t":"set","p":"message","pt":"msg","to":"Someone is at the door","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2990,"y":520,"wires":[["c7edae404be99e1a"]]},{"id":"e02e42d8570d1e35","type":"link out","z":"14484d2a357fa501","name":"Light and Speakers","links":["45904ca6429d867d"],"x":3375,"y":520,"wires":[]},{"id":"bdb95ccd4331168c","type":"link out","z":"14484d2a357fa501","name":"Announcement input","links":["6c95d201f6c9daf3"],"x":2915,"y":560,"wires":[]},{"id":"41c58a88bcf4a030","type":"server-events","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":2,"eventType":"mobile_app_notification_action","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":430,"y":200,"wires":[["e5df440fd885d7bc","49f2b70e9a7396bd"]]},{"id":"e5df440fd885d7bc","type":"debug","z":"14484d2a357fa501","name":"actionable","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":930,"y":80,"wires":[]},{"id":"49f2b70e9a7396bd","type":"switch","z":"14484d2a357fa501","name":"","property":"payload.event.action_1_title","propertyType":"msg","rules":[{"t":"eq","v":"Who is this?","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":670,"y":260,"wires":[["7beed4a06521b3d3","3a5e39d9485156dd"]]},{"id":"7beed4a06521b3d3","type":"function","z":"14484d2a357fa501","name":"Javascript","func":"var d = new Date();\nvar h = d.getHours();\nvar m = d.getMinutes();\nvar s = d.getSeconds();\n\nvar confidence = 0;\nif (typeof msg.payload.confidence !==\"undefined\"){\nvar confidence = msg.payload.confidence;\n}\n\n\nvar who = msg.payload.event.reply_text.toLowerCase().replace(\" \",\"\");\nvar replacestring = \"https://hass.purgatoire.ca/local/portraits/\" + who.toLowerCase();\nvar replacestring1 = msg.payload.event.image.replace(replacestring);\nvar replacestring2 = replacestring1.split(\"-\");\nvar camera = replacestring2[1];\n\n\n\n\nvar newMsg = {\n    \"image\": msg.payload.event.image,\n    \"payload\": {\n        \"name\": who,\n        \"data\": {\n            \"filename\":\"/config/double-take/\" + who +  \"/\" + camera + \"_\" + h + m + s + \"_\" + confidence + \".jpg\",\n            \"entity_id\": camera,\n            // \"1\": replacestring,\n            // \"2\": replacestring1,\n            // \"3\": replacestring2\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":780,"y":320,"wires":[["3a5e39d9485156dd","868b65e07deac98b"]]},{"id":"3a5e39d9485156dd","type":"debug","z":"14484d2a357fa501","name":"actionable","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":970,"y":200,"wires":[]},{"id":"868b65e07deac98b","type":"switch","z":"14484d2a357fa501","name":"Recod Faces 1/0","property":"payload.data.entity_id","propertyType":"msg","rules":[{"t":"eq","v":"camera.facecam_static","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":990,"y":320,"wires":[["f269e432af96e7cf"]]},{"id":"f269e432af96e7cf","type":"api-call-service","z":"14484d2a357fa501","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1160,"y":320,"wires":[["334a69225c8ff960","d5e0364259c9d2f7"]]},{"id":"334a69225c8ff960","type":"debug","z":"14484d2a357fa501","name":"result of snapchot","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1530,"y":340,"wires":[]},{"id":"d5e0364259c9d2f7","type":"function","z":"14484d2a357fa501","name":"Javascript","func":"var d = new Date();\nvar m = d.getMilliseconds();\nvar url = msg.image;\n\nvar url = url.replace(\"https:\\/\\/hass.purgatoire.ca\\/local\", \"\\/config\\/www\");\n\nvar newMsg = {\n \"name\": msg.payload.name,\n \"url\": \"http://192.168.0.14:3000/api/train/retrain/\" + msg.payload.name.toLowerCase(),\n \"data\":{\n    \"data\":{\n\t\"file_path\": url,\n\t\"name\": msg.payload.name.toLowerCase(),\n\t\"url\": \"http://192.168.0.14:3000/api/train/retrain/\" + msg.payload.name.toLowerCase()\n}}\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1200,"y":220,"wires":[["6bd4b336b2a94011","3a041018b34a7a99"]]},{"id":"6bd4b336b2a94011","type":"debug","z":"14484d2a357fa501","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1470,"y":140,"wires":[]},{"id":"3a041018b34a7a99","type":"http request","z":"14484d2a357fa501","name":"POST request","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":1420,"y":220,"wires":[["262670207fc2a028","7177d9971a37d755"]]},{"id":"262670207fc2a028","type":"debug","z":"14484d2a357fa501","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1715.71435546875,"y":132.85714721679688,"wires":[]},{"id":"7177d9971a37d755","type":"function","z":"14484d2a357fa501","name":"Javascript","func":"var d = new Date();\nvar m = d.getMilliseconds();\nvar url = msg.data.data.file_path;\n\n\nvar snapshot = url.replace(\"\\/config\\/www\",\"https:\\/\\/hass.purgatoire.ca\\/local\");\n\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n  \"message\": \"Faces learning for\" + \" \" + msg.name,\n  \"data\": {\n    \"image\": snapshot\n  }\n}\n }\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1680,"y":220,"wires":[["6da834e1d6cb8676","a1f03d69aff0468d"]]},{"id":"6da834e1d6cb8676","type":"api-call-service","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1900,"y":220,"wires":[["a1f03d69aff0468d"]]},{"id":"a1f03d69aff0468d","type":"debug","z":"14484d2a357fa501","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1870,"y":100,"wires":[]},{"id":"4c173b13c52a7625","type":"debug","z":"14484d2a357fa501","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":470,"y":380,"wires":[]},{"id":"130dabbc622bdd7c","type":"api-call-service","z":"14484d2a357fa501","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.front_door"],"data":"{\"filename\":\"/config/www/reolink.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1180,"y":1340,"wires":[[]]},{"id":"52c7a029e3d99227","type":"trigger","z":"14484d2a357fa501","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"10","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1030,"y":1340,"wires":[["130dabbc622bdd7c"]]},{"id":"3e79915f8de8b345","type":"change","z":"14484d2a357fa501","name":"","rules":[{"t":"set","p":"reset","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":840,"y":1400,"wires":[["52c7a029e3d99227"]]},{"id":"e529e2ebd8ba0cc3","type":"trigger","z":"14484d2a357fa501","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"units":"min","reset":"","bytopic":"all","outputs":1,"x":670,"y":1400,"wires":[["3e79915f8de8b345"]]},{"id":"c198ab088fd12cf2","type":"mqtt in","z":"14484d2a357fa501","name":"","topic":"frigate/faceshot_zone/person","qos":"0","datatype":"auto","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":400,"y":1340,"wires":[["0741c816d5e61590"]]},{"id":"0741c816d5e61590","type":"switch","z":"14484d2a357fa501","name":"click","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":670,"y":1340,"wires":[["52c7a029e3d99227"],["e529e2ebd8ba0cc3"]]},{"id":"57590a930154b3b5","type":"trigger","z":"14484d2a357fa501","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"45","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":750,"y":600,"wires":[["0861877d35bfe16e","96b3d130e3563de0"]]},{"id":"a7c52589eb409444","type":"api-call-service","z":"14484d2a357fa501","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.door_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1480,"y":780,"wires":[[]]},{"id":"dd31bc940ba436cd","type":"ha-wait-until","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"binary_sensor.door_front_outside","entityIdFilterType":"exact","property":"state","comparator":"is","value":"on","valueType":"str","timeout":"60","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":false,"blockInputOverrides":true,"outputProperties":[],"x":1300,"y":780,"wires":[["a7c52589eb409444"],["a7c52589eb409444"]]},{"id":"d4d993dd0b6b1e6d","type":"ha-wait-until","z":"14484d2a357fa501","name":"wait until Doubletake detect someone","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"sensor.double_take_facecam","entityIdFilterType":"exact","property":"state","comparator":"gt","value":"0","valueType":"num","timeout":"2","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[{"property":"doubletake","propertyType":"msg","value":"","valueType":"entity"}],"x":490,"y":560,"wires":[["57590a930154b3b5"],["57590a930154b3b5"]]},{"id":"93ce05f120ded01c","type":"debug","z":"14484d2a357fa501","name":"to package","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2180,"y":760,"wires":[]},{"id":"f4192181153226e6","type":"api-current-state","z":"14484d2a357fa501","name":"Kink=1","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.kink_party","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"uber","propertyType":"msg","value":"","valueType":"entityState"},{"property":"uberentity","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2310,"y":600,"wires":[["660692c291ce0d61"],["458fbd5918128bfa"]]},{"id":"458fbd5918128bfa","type":"trigger","z":"14484d2a357fa501","name":"Kink","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2570,"y":660,"wires":[["0bb5f84e75c93b34"]]},{"id":"0bb5f84e75c93b34","type":"function","z":"14484d2a357fa501","name":"Javascript","func":"var d = new Date();\nvar h = d.getHours();\nvar m = d.getMinutes();\nvar s = d.getSeconds();\nvar camera = \"camera.front_door\";\nvar confidence = 0;\n\nif (typeof msg.payload.confidence !==\"undefined\"){\nvar confidence = msg.payload.confidence;\n}\n\nvar who = \"Unknown\";\nif (typeof msg.payload.name !==\"undefined\"){\nvar who = msg.payload.name;\n}\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n        \"name\": who,\n        \"data\": {\n            \"filename\":\"/config/www/portraits/\" + who + \"/\" + who + \"-\" + camera + \"-\" + h + m + s + \"-\" + confidence + \".jpg\",\n            \"entity_id\": camera\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2780,"y":680,"wires":[["8761ead0cec960d3","630cbead206160c0"]]},{"id":"8761ead0cec960d3","type":"api-call-service","z":"14484d2a357fa501","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2920,"y":680,"wires":[["40e28c855edef985","1cd2dab97e94ddb6"]]},{"id":"0865a3bc30f7f16b","type":"api-call-service","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3220,"y":680,"wires":[["ffd73041c96aeb47"]]},{"id":"40e28c855edef985","type":"function","z":"14484d2a357fa501","name":"Javascript","func":"var d = new Date();\nvar name = \"A perv\";\nvar m = d.getMilliseconds();\nvar snapshot = msg.payload.data.filename;\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\" + m;\n\nvar snapshot = snapshot.replace(\"\\/config\\/www\",\"https:\\/\\/hass.purgatoire.ca\\/local\");\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"image\": snapshot,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3060,"y":680,"wires":[["0865a3bc30f7f16b","87fbabb7f224a018"]]},{"id":"87fbabb7f224a018","type":"change","z":"14484d2a357fa501","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"payload.data.title","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":3200,"y":640,"wires":[["49ff1245733f7615"]]},{"id":"333bc07437e9824c","type":"link out","z":"14484d2a357fa501","name":"Light and Speakers","links":["45904ca6429d867d","ad88dbd2.4726b8","3405e943.fd3ee6","9cf42cf7ef60f645"],"x":3555,"y":640,"wires":[]},{"id":"1cd2dab97e94ddb6","type":"debug","z":"14484d2a357fa501","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3050,"y":700,"wires":[]},{"id":"630cbead206160c0","type":"debug","z":"14484d2a357fa501","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2890,"y":720,"wires":[]},{"id":"18e6e4790a40d9dc","type":"server-state-changed","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.remote_doorbell_button_action","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"None","halt_if_type":"str","halt_if_compare":"is_not","output_only_on_state_change":true,"x":200,"y":660,"wires":[["79e4e71f5e0852e8","d4d993dd0b6b1e6d","8e3afe4418dd544b","85dd28056bc51434"],[]]},{"id":"79e4e71f5e0852e8","type":"debug","z":"14484d2a357fa501","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":550,"y":660,"wires":[]},{"id":"1b2ca2456333eec4","type":"api-call-service","z":"14484d2a357fa501","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.waiting_someone"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3280,"y":80,"wires":[[]]},{"id":"62ebb57ee56b1998","type":"api-call-service","z":"14484d2a357fa501","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4700,"y":760,"wires":[["3f3e07f49c27ac01"]]},{"id":"c76a570fe0a7f2c9","type":"ha-wait-until","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"binary_sensor.door_front_outside","entityIdFilterType":"exact","property":"state","comparator":"is","value":"on","valueType":"str","timeout":"30","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":3780,"y":840,"wires":[["52c948979f3a3aca"],["52c948979f3a3aca"]]},{"id":"52c948979f3a3aca","type":"api-call-service","z":"14484d2a357fa501","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.waiting_someone"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3940,"y":840,"wires":[["a51e1c8356c64b74"]]},{"id":"a51e1c8356c64b74","type":"api-call-service","z":"14484d2a357fa501","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4140,"y":840,"wires":[["5f99f60edf3b2662"]]},{"id":"5f99f60edf3b2662","type":"function","z":"14484d2a357fa501","name":"Reset Name","func":"var newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"value\": \"UNKNOWN\"\n        }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4350,"y":840,"wires":[["43b8809b9dc8292a"]]},{"id":"43b8809b9dc8292a","type":"api-call-service","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4730,"y":840,"wires":[[]]},{"id":"3f3e07f49c27ac01","type":"trigger","z":"14484d2a357fa501","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"25","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":4890,"y":760,"wires":[["c76a570fe0a7f2c9"]]},{"id":"ffd73041c96aeb47","type":"trigger","z":"14484d2a357fa501","name":"Manual unlock","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":3800,"y":660,"wires":[["e7dbb42f6b57e7ed"]]},{"id":"e7dbb42f6b57e7ed","type":"ha-wait-until","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"unlocked","valueType":"str","timeout":"60","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":3960,"y":760,"wires":[["99c11665f1ce940e"],[]]},{"id":"b348709007cc3c6d","type":"api-call-service","z":"14484d2a357fa501","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4330,"y":760,"wires":[["92083edde6a1bc99"]]},{"id":"99c11665f1ce940e","type":"function","z":"14484d2a357fa501","name":"Empty name","func":"var newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"value\": \" \"\n        }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4130,"y":760,"wires":[["b348709007cc3c6d"]]},{"id":"23dab3195e4bf115","type":"inject","z":"14484d2a357fa501","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":3900,"y":600,"wires":[["99c11665f1ce940e"]]},{"id":"92083edde6a1bc99","type":"change","z":"14484d2a357fa501","name":"reset","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":4510,"y":760,"wires":[["62ebb57ee56b1998"]]},{"id":"d71380d25baade5a","type":"subflow:233ac7dcd801a802","z":"14484d2a357fa501","name":"","x":3670,"y":460,"wires":[]},{"id":"49ff1245733f7615","type":"subflow:233ac7dcd801a802","z":"14484d2a357fa501","name":"","x":3450,"y":640,"wires":[]},{"id":"d97a6ca5f29095fa","type":"subflow:233ac7dcd801a802","z":"14484d2a357fa501","name":"","x":2890,"y":1100,"wires":[]},{"id":"04566cb55ad19575","type":"subflow:233ac7dcd801a802","z":"14484d2a357fa501","name":"","x":4350,"y":180,"wires":[]},{"id":"dd61d0b2cad7a585","type":"subflow:233ac7dcd801a802","z":"14484d2a357fa501","name":"","x":2870,"y":840,"wires":[]},{"id":"35a1804fd59f9be8","type":"subflow:233ac7dcd801a802","z":"14484d2a357fa501","name":"","x":3110,"y":260,"wires":[]},{"id":"0da283caf2f22ca9","type":"change","z":"14484d2a357fa501","name":"TV Announcement","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2210,"y":540,"wires":[["a9f7a85966e01bbb"]]},{"id":"5d8d33df42b78247","type":"subflow:a4f0ac9a6eed6b71","z":"14484d2a357fa501","name":"TV Alerts","x":2440,"y":540,"wires":[]},{"id":"40200dddf08a041f","type":"debug","z":"14484d2a357fa501","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3290,"y":560,"wires":[]},{"id":"c7edae404be99e1a","type":"subflow:233ac7dcd801a802","z":"14484d2a357fa501","name":"","x":3210,"y":520,"wires":[]},{"id":"14a6954cfb02badb","type":"inject","z":"14484d2a357fa501","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":2300,"y":860,"wires":[["5ced15bcb2b21f09"]]},{"id":"3a522a70e3e51c47","type":"api-current-state","z":"14484d2a357fa501","name":"light.bedroom_lights","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.bedroom_lights","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"state","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_inital","propertyType":"msg","value":"","valueType":"entity"},{"property":"payload.entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":2540,"y":1460,"wires":[["266c477a16663fb0"]],"outputLabels":["data.attributes"]},{"id":"b841b93f25f30a29","type":"api-call-service","z":"14484d2a357fa501","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["{{entity_inital.entity_id}}"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload.data.entity_id","propertyType":"msg","value":"payload.entity_id","valueType":"msg"}],"queue":"none","x":3000,"y":1460,"wires":[["7527924fc1f061a4","e9ec6b1c73677558"]]},{"id":"266c477a16663fb0","type":"change","z":"14484d2a357fa501","name":"rules","rules":[{"t":"move","p":"dbrigthness","pt":"msg","to":"payload.data.brightness_pct","tot":"msg"},{"t":"move","p":"color_value","pt":"msg","to":"payload.data.rgb_color","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2770,"y":1460,"wires":[["b841b93f25f30a29","e9ec6b1c73677558"]]},{"id":"7527924fc1f061a4","type":"trigger","z":"14484d2a357fa501","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"2","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":3200,"y":1460,"wires":[["22b5ad9b36ed6cc6"]]},{"id":"b64ae81ae20cf2a5","type":"api-call-service","z":"14484d2a357fa501","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3540,"y":1460,"wires":[["b0d705754518181d"]]},{"id":"b0d705754518181d","type":"api-current-state","z":"14484d2a357fa501","name":"light.bedroom_lights","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.bedroom_lights","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3740,"y":1460,"wires":[["8ace3253f8070032"]]},{"id":"8ace3253f8070032","type":"switch","z":"14484d2a357fa501","name":"!=same color","property":"data.attributes.rgb_color","propertyType":"msg","rules":[{"t":"eq","v":"color_value","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":3650,"y":1420,"wires":[["b64ae81ae20cf2a5"]]},{"id":"22b5ad9b36ed6cc6","type":"function","z":"14484d2a357fa501","name":"","func":"var brightness = msg.entity_inital.attributes.brightness;\nvar initial_color = msg.entity_inital.attributes.rgb_color;\nvar state = msg.entity_inital.state;\nvar entity = msg.entity_inital.entity_id;\nvar color_value = msg.payload.data.rgb_color;\nvar newMsg = \n\n{ \n    \"payload\": {\n                data: {\n                         \"brightness\": brightness,\n                         \"rgb_color\": initial_color,\n                \"entity_id\": entity\n                    \n                },\n               \n                \"service\": \"turn_\" + state,\n                \"color_value\": color_value\n                \n               }\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3360,"y":1460,"wires":[["b64ae81ae20cf2a5"]]},{"id":"e6776b38f590c7c8","type":"change","z":"14484d2a357fa501","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"payload.data.title","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":2250,"y":1440,"wires":[["3a522a70e3e51c47"]]},{"id":"78e3206309a9efd9","type":"inject","z":"14484d2a357fa501","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":2040,"y":1420,"wires":[["e6776b38f590c7c8"]]},{"id":"e9ec6b1c73677558","type":"debug","z":"14484d2a357fa501","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3000,"y":1380,"wires":[]},{"id":"ee4abadbba55767d","type":"inject","z":"14484d2a357fa501","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":2010,"y":880,"wires":[[]]},{"id":"5df29bf9a155a455","type":"debug","z":"14484d2a357fa501","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2770,"y":780,"wires":[]},{"id":"74e83bb54e13e800","type":"server-state-changed","z":"90585768a7a619f8","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.remote_doorbell_button_action","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"None","halt_if_type":"str","halt_if_compare":"is_not","output_only_on_state_change":true,"x":200,"y":540,"wires":[["d2ec41d6aac3af0d","de0d45e08d67309e"],[]]},{"id":"ffe3bf33bb370856","type":"inject","z":"90585768a7a619f8","name":"click","props":[{"p":"payload.event.command","v":"click","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":3090,"y":780,"wires":[[]]},{"id":"5468d4ebbfa0037c","type":"api-current-state","z":"90585768a7a619f8","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"camera.facecam_person","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":580,"y":480,"wires":[["4c880ba1a1e1524c","88a6d28e86a3933f"]]},{"id":"4c880ba1a1e1524c","type":"debug","z":"90585768a7a619f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1070,"y":360,"wires":[]},{"id":"88a6d28e86a3933f","type":"function","z":"90585768a7a619f8","name":"Time Check + Cam Passthrough","func":"\nvar timestamp = msg.data.last_updated;\nvar timestampUnix = new Date(timestamp).getTime();\nvar cameraurl = msg.data.attributes.entity_picture;\n\nvar now = Date.now();\nvar timedif = (now - timestampUnix);\n\n\nif (timedif < 50000 ){ // set back to 100000 after test\n     var nowfinal = 1;\n } else {\n     var nowfinal = 0;};\n\n\n\n  var test = {\n   \t\"payload\":  {\n\t\t\"now\":  nowfinal\n\t\t\n   \t},\n   \t\"entity\": msg.entity,\n   \t\"data\": msg.data,\n   \t\"cameraurl\": \"http://192.168.0.15:8123\" + cameraurl\n  };\n  return test;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":890,"y":480,"wires":[["7ae1ef352a10a3f3","9ddf2dd94d18f1c7"]]},{"id":"7ae1ef352a10a3f3","type":"debug","z":"90585768a7a619f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1270,"y":280,"wires":[]},{"id":"9ddf2dd94d18f1c7","type":"switch","z":"90585768a7a619f8","name":"Now pic top, old pic bottom","property":"payload.now","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1160,"y":500,"wires":[["02cd6a8a41ba903f"],["d53583062314d64f"]]},{"id":"7b192427da0ef0bd","type":"api-current-state","z":"90585768a7a619f8","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"camera.facecam","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1630,"y":560,"wires":[["c3229b8d83beacb2","b3d64d1e907a6f10"]]},{"id":"02cd6a8a41ba903f","type":"function","z":"90585768a7a619f8","name":"Double take URL set","func":"// SETTINGS\nvar required_conf = 75;\n// SETTINGS\n\n  var test = {\n   \t\"payload\":  {\n\t\t\"url\": \"http://192.168.0.14:3000/api/recognize?url=\" + msg.cameraurl + \"&camera=camera.facecam\"\n   \t},\n   \t\"url\": \"http://192.168.0.14:3000/api/recognize?url=\" + msg.cameraurl + \"&camera=camera.facecam\"\n  };\n  return test;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1400,"y":520,"wires":[["503b614ca1d1c1e4","26f440787c731b08"]]},{"id":"503b614ca1d1c1e4","type":"http request","z":"90585768a7a619f8","name":"[POST] Recognize Double-Take","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","senderr":false,"x":1650,"y":520,"wires":[["68892ec178b704a0"]]},{"id":"26f440787c731b08","type":"debug","z":"90585768a7a619f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1750,"y":360,"wires":[]},{"id":"200a580462a49ee8","type":"debug","z":"90585768a7a619f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1950,"y":340,"wires":[]},{"id":"68892ec178b704a0","type":"json","z":"90585768a7a619f8","name":"toJson","property":"payload","action":"","pretty":true,"x":1850,"y":520,"wires":[["200a580462a49ee8","8aa52921be81dcd1"]]},{"id":"c3229b8d83beacb2","type":"debug","z":"90585768a7a619f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1550,"y":680,"wires":[]},{"id":"6765ee0d50b6477f","type":"debug","z":"90585768a7a619f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2090,"y":880,"wires":[]},{"id":"258189335764afac","type":"http request","z":"90585768a7a619f8","name":"[POST] Recognize Double-Take","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","senderr":false,"x":2130,"y":560,"wires":[["8fdb94790e6d465c"]]},{"id":"8fdb94790e6d465c","type":"json","z":"90585768a7a619f8","name":"toJson","property":"payload","action":"","pretty":true,"x":2330,"y":560,"wires":[["08c4fd83861dd951","8aa52921be81dcd1"]]},{"id":"b3d64d1e907a6f10","type":"function","z":"90585768a7a619f8","name":"Double take URL set","func":"// SETTINGS\nvar cameraurl = \"http://192.168.0.15:8123\" + msg.data.attributes.entity_picture;\n// SETTINGS\n\n  var test = {\n   \t\"payload\":  {\n\t\t\"url\": \"http://192.168.0.14:3000/api/recognize?url=\" + cameraurl + \"&camera=camera.facecam\"\n   \t},\n   \t\"url\": \"http://192.168.0.14:3000/api/recognize?url=\" + cameraurl + \"&camera=camera.facecam\"\n  };\n  return test;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1880,"y":560,"wires":[["258189335764afac","e3e49b9d016e2510","7a252747939c703d"]]},{"id":"fe7d30b9a6cf08d3","type":"function","z":"90585768a7a619f8","name":"Time Check + Cam Passthrough","func":"var cameraurl = msg.data.attributes.entity_picture;\n\n\n\n\n\n  var test = {\n   \t\"entity\": msg.entity,\n   \t\"data\": msg.data,\n   \t\"cameraurl\": \"http://192.168.0.15:8123\" + cameraurl\n  };\n  return test;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1850,"y":900,"wires":[["6765ee0d50b6477f"]]},{"id":"d53583062314d64f","type":"change","z":"90585768a7a619f8","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"delete","p":"cameraurl","pt":"msg"},{"t":"delete","p":"data","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1400,"y":560,"wires":[["7b192427da0ef0bd","c3b86461750e7479"]]},{"id":"c3b86461750e7479","type":"debug","z":"90585768a7a619f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1317.552734375,"y":680.0081176757812,"wires":[]},{"id":"e3e49b9d016e2510","type":"debug","z":"90585768a7a619f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2070,"y":660,"wires":[]},{"id":"08c4fd83861dd951","type":"debug","z":"90585768a7a619f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2230,"y":780,"wires":[]},{"id":"8aa52921be81dcd1","type":"trigger","z":"90585768a7a619f8","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2410,"y":520,"wires":[["e4922cf0cc301205"]]},{"id":"ef9acd7f7033be91","type":"switch","z":"90585768a7a619f8","name":"Any recognition?","property":"payload.matches","propertyType":"msg","rules":[{"t":"nempty"},{"t":"empty"}],"checkall":"true","repair":false,"outputs":2,"x":2830,"y":520,"wires":[["b8b9ae0b6ea48a6c"],["b2fa752cb1061f91"]]},{"id":"d2ec41d6aac3af0d","type":"api-call-service","z":"90585768a7a619f8","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.door_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":480,"y":720,"wires":[["5a63b80c4e38e8e2"]]},{"id":"ef99c450fb2d33a0","type":"api-call-service","z":"90585768a7a619f8","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.door_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":840,"y":720,"wires":[[]]},{"id":"5a63b80c4e38e8e2","type":"ha-wait-until","z":"90585768a7a619f8","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"locked","valueType":"str","timeout":"60","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":false,"blockInputOverrides":true,"outputProperties":[],"x":660,"y":700,"wires":[["ef99c450fb2d33a0"],["ef99c450fb2d33a0"]]},{"id":"6c2461f1f43780f7","type":"debug","z":"90585768a7a619f8","name":"reco post process","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3250,"y":400,"wires":[]},{"id":"b8b9ae0b6ea48a6c","type":"function","z":"90585768a7a619f8","name":"Face Extractor compare 7.0","func":"// SETTINGS\nvar required_conf = 80;\n// SETTINGS\n\n\nvar recoface = new Object();\nvar recofacesortable = [];\nvar name = \"\";\nvar camera = \"\";\nvar conf = \"\";\nvar reconame = \"\";\nvar recognized = 69;\nvar confidence = \"\";\nvar reco = \"\";\nvar recognized_confidently = 0;\n//declarations\n\n    for (i = 0; i < msg.payload.matches.length; i++){\n         for (y = 0; y < Object.keys(msg.payload.matches[i]).length; y++){\n                var name = msg.payload.matches[i].name;\n \t\t\t\tvar conf = msg.payload.matches[i].confidence;\n \t\t\t\tvar camera = msg.payload.camera;\n \t\t\t// \tif (conf > 0){\n \t\t\t\t    recofacesortable.push([name, conf]);\n \t\t\t// \t}\n \t\t\t\t\n        }\n    }\n    \n    \n     \trecofacesortable.sort(function(a, b) {\n \t\treturn a[1] - b[1];\n \t}).reverse();\n \t\n    for (i = 0; i < recofacesortable.length; i++){\n        var reconame = recofacesortable[0][0];\n        var confidence = recofacesortable[0][1]\n        \n        \n    }\n\n\n\nif (confidence > required_conf) {\n\tvar recognized_confidently = 1;\n}\n\nif (confidence != \"\") {\n\tvar recognized = 1;\n} else if (confidence == \"\") {\n    var recognized = 0;\n} else { \n var recognized = \"bugging\";\n    \n}\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"name\": reconame,\n\t\t\"confidence\": confidence,\n\t\t\"recognized_confidently\": recognized_confidently,\n\t\t\"recognized\": recognized,\n \t\t\"camera\": camera,\n \t\t\"recoface\": recoface\n\t}\n};\n\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2980,"y":460,"wires":[["6c2461f1f43780f7","36a9e69a1f17495d","38d03566a7dd39f1"]]},{"id":"c7e58e1c25d2264a","type":"inject","z":"90585768a7a619f8","name":"","props":[{"p":"payload"},{"p":"url","v":"http://192.168.0.14:3000/api/recognize?url=http://192.168.0.15:8123/api/camera_proxy/camera.facecam?token=97699652c0e63bfb128474ffcab6bd3f242378cdaecf961254f9c81db7285299&camera=camera.facecam","vt":"str"},{"p":"_msgid","v":"c296082d21604113","vt":"str"},{"p":"header","v":"{\"x-powered-by\":\"Express\",\"access-control-allow-origin\":\"*\",\"content-type\":\"application/json; charset=utf-8\",\"content-length\":\"400\",\"etag\":\"W/\\\"190-gyeGbs7LKPjnWp7g/2Mvq8RxVDs\\\"\",\"date\":\"Thu, 07 Apr 2022 20:24:54 GMT\",\"connection\":\"close\",\"x-node-red-request-node\":\"7940a9f0\"}","vt":"json"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"id\":\"15477d6e-7fff-4f82-84c2-badf6e1ed31a\",\"duration\":1.52,\"timestamp\":\"2022-04-07T20:24:54.253Z\",\"attempts\":1,\"camera\":\"camera.facecam\",\"zones\":[],\"matches\":[{\"name\":\"maxi\",\"confidence\":99.92,\"match\":true,\"box\":{\"top\":377,\"left\":388,\"width\":526,\"height\":652},\"type\":\"manual\",\"duration\":0.55,\"detector\":\"compreface\",\"filename\":\"b237ed80-7efb-4902-80f3-9b6b67a94675.jpg\",\"base64\":null},{\"name\":\"test\",\"confidence\":90.92,\"match\":true,\"box\":{\"top\":377,\"left\":388,\"width\":526,\"height\":652},\"type\":\"manual\",\"duration\":0.55,\"detector\":\"compreface\",\"filename\":\"b237ed80-7efb-4902-80f3-9b6b67a94675.jpg\",\"base64\":null}],\"misses\":[]}","payloadType":"json","x":2510,"y":400,"wires":[["ef9acd7f7033be91"]]},{"id":"0facc085cf02d8de","type":"function","z":"90585768a7a619f8","name":"Name Payload","func":"var name = msg.match.name;\n\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"value\": name\n        }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4020,"y":140,"wires":[["913adc0e99a5f42b"]]},{"id":"913adc0e99a5f42b","type":"api-call-service","z":"90585768a7a619f8","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4230,"y":140,"wires":[[]]},{"id":"d32471499d5f1d14","type":"api-call-service","z":"90585768a7a619f8","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4200,"y":180,"wires":[[]]},{"id":"dd39d946f8395675","type":"function","z":"90585768a7a619f8","name":"Javascript","func":"var name = msg.payload.name;\nvar camera = \"/api/camera_proxy/\" + msg.payload.camera\n\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": \"Welcoming \" + name,\n\t\t\t\"data\": {\n\t\t\t\t\"image\": camera,\n\t\t\t\t\"actions\": [\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4020,"y":180,"wires":[["d32471499d5f1d14","32523a71b60ee78b","37fcf38a57be3072"]]},{"id":"32523a71b60ee78b","type":"change","z":"90585768a7a619f8","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"payload.data.title","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,255,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":4240,"y":220,"wires":[["150a6022ab095384"]]},{"id":"37fcf38a57be3072","type":"debug","z":"90585768a7a619f8","name":"result before notif","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4650,"y":180,"wires":[]},{"id":"150a6022ab095384","type":"subflow:233ac7dcd801a802","z":"90585768a7a619f8","name":"","x":4450,"y":220,"wires":[]},{"id":"5024bcdda15789c5","type":"api-call-service","z":"90585768a7a619f8","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4320,"y":260,"wires":[["5658d6f6198ff866"]]},{"id":"5658d6f6198ff866","type":"ha-wait-until","z":"90585768a7a619f8","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"locked","valueType":"str","timeout":"30","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":4480,"y":260,"wires":[["96968459f3bf5c4f"],["96968459f3bf5c4f"]]},{"id":"96968459f3bf5c4f","type":"api-call-service","z":"90585768a7a619f8","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized","input_boolean.waiting_someone"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4660,"y":260,"wires":[["88a988e7b7f4ba9f"]]},{"id":"88a988e7b7f4ba9f","type":"api-call-service","z":"90585768a7a619f8","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":" {             \"value\": \"UNKNOWN\"         }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4870,"y":260,"wires":[[]]},{"id":"6bf9206f0b2560da","type":"debug","z":"90585768a7a619f8","name":"unlock","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4190,"y":320,"wires":[]},{"id":"e55293568958083e","type":"api-call-service","z":"90585768a7a619f8","name":"unLock Door","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"lock","service":"unlock","areaId":[],"deviceId":[],"entityId":["lock.lock_front_door"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4010,"y":260,"wires":[["6bf9206f0b2560da","d2a5f7253ef0c10d"]]},{"id":"d2a5f7253ef0c10d","type":"ha-wait-until","z":"90585768a7a619f8","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"unlocked","valueType":"str","timeout":"2","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":4160,"y":260,"wires":[["5024bcdda15789c5"],[]]},{"id":"36a9e69a1f17495d","type":"switch","z":"90585768a7a619f8","name":"recognized_confidently = 1","property":"payload.recognized_confidently","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":2740,"y":200,"wires":[["5f1d4051491a8660"]]},{"id":"38d03566a7dd39f1","type":"switch","z":"90585768a7a619f8","name":"recognized_confidently = 0","property":"payload.recognized_confidently","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":1,"x":3360,"y":460,"wires":[["a40923a01527c162"]]},{"id":"610f658a4ddbf68f","type":"function","z":"90585768a7a619f8","name":"Name Payload","func":"var name = msg.payload.name;\n\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"value\": name\n        }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4060,"y":420,"wires":[["232b1651138d30b5"]]},{"id":"232b1651138d30b5","type":"api-call-service","z":"90585768a7a619f8","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4270,"y":420,"wires":[[]]},{"id":"d3cc5a4318a0557c","type":"api-call-service","z":"90585768a7a619f8","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_fold_3","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4310,"y":460,"wires":[[]]},{"id":"79431cc4783087cc","type":"function","z":"90585768a7a619f8","name":"Javascript","func":"var name = msg.payload.name;\nvar camera = \"/api/camera_proxy/\" + msg.payload.camera\n\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"image\": camera,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4060,"y":460,"wires":[["d3cc5a4318a0557c","830faea3f6b259f6","cebf5df5cb373342"]]},{"id":"830faea3f6b259f6","type":"change","z":"90585768a7a619f8","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"payload.data.title","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":4280,"y":500,"wires":[["0113d96a7ff8e5a3"]]},{"id":"cebf5df5cb373342","type":"debug","z":"90585768a7a619f8","name":"result before notif","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4690,"y":460,"wires":[]},{"id":"a40923a01527c162","type":"delay","z":"90585768a7a619f8","name":"Semi Reco","pauseType":"delay","timeout":"1","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":3830,"y":460,"wires":[["610f658a4ddbf68f","79431cc4783087cc"]]},{"id":"0113d96a7ff8e5a3","type":"subflow:233ac7dcd801a802","z":"90585768a7a619f8","name":"","x":4490,"y":500,"wires":[]},{"id":"4f82b69b536c66d0","type":"api-current-state","z":"90585768a7a619f8","name":"kink off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.kink_party","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3380,"y":200,"wires":[["2d86a08c6b26df85","c20eb2b3b2ee5c62"],["a40923a01527c162"]]},{"id":"2d86a08c6b26df85","type":"api-current-state","z":"90585768a7a619f8","name":"Party on","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.party_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3560,"y":140,"wires":[["ec17d2252465c097"],["a40923a01527c162"]]},{"id":"c20eb2b3b2ee5c62","type":"api-current-state","z":"90585768a7a619f8","name":"Waiting Friend?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.waiting_someone","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":3560,"y":200,"wires":[["ec17d2252465c097"],["a40923a01527c162"]]},{"id":"f39d0741c1e256e0","type":"api-current-state","z":"90585768a7a619f8","name":"Front House Motion","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.motion_front","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":3190,"y":200,"wires":[["4f82b69b536c66d0"],["a40923a01527c162"]]},{"id":"ec17d2252465c097","type":"trigger","z":"90585768a7a619f8","name":"Full Reco","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":3760,"y":200,"wires":[["0facc085cf02d8de","dd39d946f8395675","e55293568958083e"]]},{"id":"58966739a9aebde1","type":"api-call-service","z":"90585768a7a619f8","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_fold_3","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3550,"y":820,"wires":[[]]},{"id":"cfe3eb50c94051d9","type":"function","z":"90585768a7a619f8","name":"Javascript","func":"var camera = \"/api/camera_proxy/camera.front_door\"\n\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": \"Someone is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"image\": camera,\n\t\t\t\t\"actions\": [\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3300,"y":820,"wires":[["58966739a9aebde1","2384943a9be9ba20","5de2220a1888a23a","2d83c2efb9055c1f"]]},{"id":"2384943a9be9ba20","type":"change","z":"90585768a7a619f8","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"payload.data.title","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":3520,"y":860,"wires":[["6e676f7506441f0e"]]},{"id":"5de2220a1888a23a","type":"debug","z":"90585768a7a619f8","name":"result before notif","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3930,"y":820,"wires":[]},{"id":"6e676f7506441f0e","type":"subflow:233ac7dcd801a802","z":"90585768a7a619f8","name":"","x":3730,"y":860,"wires":[]},{"id":"ec1e25816f47c86c","type":"api-current-state","z":"90585768a7a619f8","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"camera.front_door","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3080,"y":820,"wires":[["cfe3eb50c94051d9","df1dfa3a6658beac"]]},{"id":"df1dfa3a6658beac","type":"debug","z":"90585768a7a619f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3290,"y":940,"wires":[]},{"id":"2d83c2efb9055c1f","type":"debug","z":"90585768a7a619f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3410,"y":880,"wires":[]},{"id":"b2fa752cb1061f91","type":"trigger","z":"90585768a7a619f8","name":"No reco","op1":"1","op2":"","op1type":"str","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2820,"y":820,"wires":[["ec1e25816f47c86c"]]},{"id":"c7146d518d08cb66","type":"inject","z":"90585768a7a619f8","name":"click","props":[{"p":"payload.event.command","v":"click","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":2670,"y":840,"wires":[["b2fa752cb1061f91"]]},{"id":"de0d45e08d67309e","type":"trigger","z":"90585768a7a619f8","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"min","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":670,"y":540,"wires":[["d53583062314d64f"]]},{"id":"5f1d4051491a8660","type":"api-current-state","z":"90585768a7a619f8","name":"Acid time off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.acid_time","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2970,"y":200,"wires":[["f39d0741c1e256e0"],["a40923a01527c162"]]},{"id":"e4922cf0cc301205","type":"api-current-state","z":"90585768a7a619f8","name":"Waiting Uber off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.waiting_uber","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2600,"y":520,"wires":[["ef9acd7f7033be91"],["6b628ad5808dab81"]]},{"id":"baf4c87c046a4182","type":"api-call-service","z":"90585768a7a619f8","name":"to package","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"script","service":"ptz_to_package","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3030,"y":560,"wires":[["6ec6bc5e344c63f4"]]},{"id":"6b628ad5808dab81","type":"trigger","z":"90585768a7a619f8","name":"Uber","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2830,"y":560,"wires":[["baf4c87c046a4182","b2fa752cb1061f91"]]},{"id":"6ec6bc5e344c63f4","type":"ha-wait-until","z":"90585768a7a619f8","name":"lock opens?","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"unlocked","valueType":"str","timeout":"120","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":false,"blockInputOverrides":true,"outputProperties":[],"x":3190,"y":560,"wires":[["887c2c0e9969deb7"],["887c2c0e9969deb7"]]},{"id":"887c2c0e9969deb7","type":"api-call-service","z":"90585768a7a619f8","name":"to regular position","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"script","service":"ptz_to_doorway","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":3370,"y":560,"wires":[[]]},{"id":"d9656c1802b67624","type":"api-current-state","z":"90585768a7a619f8","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"camera.facecam","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1690,"y":140,"wires":[["f54605c1989db8fd"]]},{"id":"f54605c1989db8fd","type":"function","z":"90585768a7a619f8","name":"Double take URL set","func":"// SETTINGS\nvar cameraurl = \"http://192.168.0.15:8123\" + msg.data.attributes.entity_picture;\n// SETTINGS\n\n  var test = {\n   \t\"payload\":  {\n\t\t\"url\": \"http://192.168.0.14:3000/api/recognize?url=\" + cameraurl + \"&camera=camera.facecam\"\n   \t},\n   \t\"url\": \"http://192.168.0.14:3000/api/recognize?url=\" + cameraurl + \"&camera=camera.facecam\"\n  };\n  return test;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1940,"y":140,"wires":[["40bd41f74a42d282"]]},{"id":"40bd41f74a42d282","type":"debug","z":"90585768a7a619f8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2150,"y":140,"wires":[]},{"id":"f5e1098cf6bf7a83","type":"inject","z":"90585768a7a619f8","name":"","props":[{"p":"payload"},{"p":"url","v":"http://192.168.0.14:3000/api/recognize?url=http://192.168.0.15:8123/api/camera_proxy/camera.facecam?token=97699652c0e63bfb128474ffcab6bd3f242378cdaecf961254f9c81db7285299&camera=camera.facecam","vt":"str"},{"p":"_msgid","v":"c296082d21604113","vt":"str"},{"p":"header","v":"{\"x-powered-by\":\"Express\",\"access-control-allow-origin\":\"*\",\"content-type\":\"application/json; charset=utf-8\",\"content-length\":\"400\",\"etag\":\"W/\\\"190-gyeGbs7LKPjnWp7g/2Mvq8RxVDs\\\"\",\"date\":\"Thu, 07 Apr 2022 20:24:54 GMT\",\"connection\":\"close\",\"x-node-red-request-node\":\"7940a9f0\"}","vt":"json"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"id\":\"15477d6e-7fff-4f82-84c2-badf6e1ed31a\",\"duration\":1.52,\"timestamp\":\"2022-04-07T20:24:54.253Z\",\"attempts\":1,\"camera\":\"camera.facecam\",\"zones\":[],\"matches\":[{\"name\":\"maxi\",\"confidence\":99.92,\"match\":true,\"box\":{\"top\":377,\"left\":388,\"width\":526,\"height\":652},\"type\":\"manual\",\"duration\":0.55,\"detector\":\"compreface\",\"filename\":\"b237ed80-7efb-4902-80f3-9b6b67a94675.jpg\",\"base64\":null},{\"name\":\"test\",\"confidence\":90.92,\"match\":true,\"box\":{\"top\":377,\"left\":388,\"width\":526,\"height\":652},\"type\":\"manual\",\"duration\":0.55,\"detector\":\"compreface\",\"filename\":\"b237ed80-7efb-4902-80f3-9b6b67a94675.jpg\",\"base64\":null}],\"misses\":[]}","payloadType":"json","x":1450,"y":120,"wires":[["d9656c1802b67624","d1cd688cd46a6d30"]]},{"id":"d1cd688cd46a6d30","type":"api-call-service","z":"90585768a7a619f8","name":"Save Facecam Ring.jpg","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.facecam"],"data":"{\"filename\":\"/config/www/ring.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1970,"y":220,"wires":[[]]},{"id":"7a252747939c703d","type":"api-call-service","z":"90585768a7a619f8","name":"Save Facecam Ring.jpg For Debug","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.facecam"],"data":"{\"filename\":\"/config/www/ring.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2140,"y":600,"wires":[[]]},{"id":"679f1d97bea54b16","type":"link out","z":"90585768a7a619f8","name":"","mode":"link","links":["6c95d201f6c9daf3"],"x":2535,"y":480,"wires":[]},{"id":"e3a3ae9d2537c03e","type":"server-state-changed","z":"dd89857c15f353c7","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.remote_doorbell_button_action","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"None","halt_if_type":"str","halt_if_compare":"is_not","output_only_on_state_change":true,"x":300,"y":520,"wires":[[],[]]},{"id":"911f051bb678cd1b","type":"debug","z":"dd89857c15f353c7","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2910,"y":160,"wires":[]},{"id":"5339f9d4e1b48ed7","type":"server-state-changed","z":"dd89857c15f353c7","name":"Doorbell","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.remote_doorbell_button_action","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"None","halt_if_type":"str","halt_if_compare":"is_not","output_only_on_state_change":true,"x":80,"y":1480,"wires":[["59f49b000db10ed9"],[]]},{"id":"59f49b000db10ed9","type":"trigger","z":"dd89857c15f353c7","name":"20s Cooldown","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"2","extend":false,"overrideDelay":false,"units":"min","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":240,"y":1480,"wires":[["f0ad81c29d51bce5","a8f19ee85e24054c"]]},{"id":"a8f19ee85e24054c","type":"api-call-service","z":"dd89857c15f353c7","name":"Turn on Door Rang","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.door_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":450,"y":1520,"wires":[["9d0699203619db9f"]]},{"id":"9d0699203619db9f","type":"ha-wait-until","z":"dd89857c15f353c7","name":"Wait for door to lock","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"locked","valueType":"str","timeout":"60","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":false,"blockInputOverrides":true,"outputProperties":[],"x":660,"y":1520,"wires":[["717675b89a8e5a53"],["717675b89a8e5a53"]]},{"id":"717675b89a8e5a53","type":"api-call-service","z":"dd89857c15f353c7","name":"Turn off \"Door rang\"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.door_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":880,"y":1520,"wires":[[]]},{"id":"3d6f34f957597508","type":"function","z":"dd89857c15f353c7","name":"Double take URL set","func":"// SETTINGS\nvar cameraurl = \"http://192.168.0.15:8123\" + msg.data.attributes.entity_picture;\n// SETTINGS\n\n  var test = {\n   \t\"payload\":  {\n\t\t\"url\": \"http://192.168.0.14:3000/api/recognize?url=\" + cameraurl + \"&camera=camera.facecam\"\n   \t},\n   \t\"url\": \"http://192.168.0.14:3000/api/recognize?url=\" + cameraurl + \"&camera=camera.facecam\"\n  };\n  return test;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":740,"wires":[[]]},{"id":"12d39ed3c0fd5f25","type":"api-current-state","z":"dd89857c15f353c7","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"0","halt_if_type":"num","halt_if_compare":"gt","entity_id":"sensor.double_take_facecam","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":910,"y":1480,"wires":[["177471418c06f764"],["e2c29f7712b2d101"]]},{"id":"3c28784c1321d67d","type":"function","z":"dd89857c15f353c7","name":"Face Extractor compare 10.4","func":"var matches = msg.data.attributes.matches;\n//-----------------------------------------\nvar today = new Date();\nvar dd = String(today.getDate()).padStart(2, '0');\nvar hh = today.getHours();\nvar month = String(today.getMonth() + 1).padStart(2, '0');\nvar minutes = today.getMinutes();\nvar yyyy = today.getFullYear();\nvar today = yyyy + '-' + month  + '-' + dd + '---' + hh + minutes;\n\n//-----------------------------------------\n\nif ( matches.length > 0){\nmatches.sort(({confidence:a}, {confidence:b}) => b-a);\nvar highest_match = matches[0];\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"matches\": matches,\n\t\t\"highest_match\": highest_match ,\n\t\t\"image_url\": \"http://192.168.0.14:3000/api/storage/matches/\" + highest_match.filename,\n\t\t\"save_path\": \"/mnt/hass/\" + highest_match.name + \"/\" + today + \"---\" + highest_match.confidence + \".jpg\",\n\t\t\"confidence\": highest_match.confidence\n\t}\n}\n\nreturn newMsg;\n\n}\nelse {\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"matches\": \"none\"}}\n\nreturn newMsg; \n\n}","outputs":1,"noerr":2,"initialize":"","finalize":"","libs":[],"x":1760,"y":1400,"wires":[["e5da28d1a2c6e1c8","7a3e943cd0c65032"]]},{"id":"f0ad81c29d51bce5","type":"api-current-state","z":"dd89857c15f353c7","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"0","halt_if_type":"num","halt_if_compare":"gt","entity_id":"sensor.double_take_front_door","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":530,"y":1480,"wires":[["2b2e4a2f72d68f73","9b5bc74d89ac6854"],["12d39ed3c0fd5f25"]]},{"id":"84982b380a3a869b","type":"debug","z":"dd89857c15f353c7","name":"debug 2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1960,"y":1580,"wires":[]},{"id":"8b0da6d89e41b31e","type":"function","z":"dd89857c15f353c7","name":"Face Extractor compare 10.0","func":"// SETTINGS\nvar required_conf = 80;\n// SETTINGS\n\n\nvar recoface = new Object();\nvar recofacesortable = [];\nvar name = \"\";\nvar camera = \"\";\nvar conf = \"\";\nvar reconame = \"\";\nvar recognized = 69;\nvar confidence = \"\";\nvar reco = \"\";\nvar recognized_confidently = 0;\n//declarations\n\n    for (i = 0; i < msg.data.attributes.matches.length; i++){\n         for (y = 0; y < Object.keys(msg.data.attributes.matches[i]).length; y++){\n                var name = msg.data.attributes.matches[i][y][0];\n \t\t\t\tvar conf = msg.data.attributes.matches[i][y][1];\n \t\t\t\tvar camera = msg.data.attributes.matches[i][y][2];\n \t\t\t// \tif (conf > 0){\n \t\t\t\t    recofacesortable.push([name, conf, camera]);\n \t\t\t// \t}\n \t\t\t\t\n        }\n    }\n    var recomsg = {\n\t\"payload\": {\n\t\t\"recofacesortable\": recofacesortable\n\t}\n};\n\nreturn recomsg;\n    \n     \trecofacesortable.sort(function(a, b) {\n \t\treturn a[1] - b[1];\n \t}).reverse();\n \t\n\n    for (i = 0; i < recofacesortable.length; i++){\n        var reconame = recofacesortable[0][0];\n        var confidence = recofacesortable[0][1]\n        var camera = recofacesortable[0][2]\n        \n        \n    }\n\n\nif (confidence > required_conf) {\n\tvar recognized_confidently = 1;\n}\n\nif (confidence != \"\") {\n\tvar recognized = 1;\n} else if (confidence == \"\") {\n    var recognized = 0;\n} else { \n var recognized = \"bugging\";\n    \n}\n\n if (camera == \"camera.front_door\"){\n     var camera = \"camera.reolink_static\";\n } else if (camera == \"camera.facecam\"){\n     var camera = \"camera.facecam_static\"\n }\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"name\": reconame,\n\t\t\"confidence\": confidence,\n\t//\t\"matched_faces\": total_matched_faces,\n\t//\t\"total_faces\": total_faces,\n\t\t\"recognized_confidently\": recognized_confidently,\n\t\t\"recognized\": recognized,\n \t\t\"camera\": camera \n\t}\n};\n\nreturn newMsg;\n\n\n//  var test = {\n//  \t\"payload\": {\n// \t\t\"name\": reconame,\n// \t\t\"confidence\": confidence,\n// \t\t\"matched_faces\": total_matched_faces,\n// \t\t\"total_faces\": total_faces,\n// \t\t\"recognized\": recognized,\n// \t\t\"camera\": camera ,\n// \t\t\"recofacesortable\": recofacesortable\n//  \t}\n//  };\n//  return test;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":660,"wires":[[]]},{"id":"2b2e4a2f72d68f73","type":"debug","z":"dd89857c15f353c7","name":"debug 1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":760,"y":1300,"wires":[]},{"id":"5945b7bdeca6f1f1","type":"debug","z":"dd89857c15f353c7","name":"debug 3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2000,"y":1760,"wires":[]},{"id":"5775b7cccd31e62b","type":"api-call-service","z":"dd89857c15f353c7","name":"Save Facecam Ring.jpg For Debug","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.facecam"],"data":"{\"filename\":\"/config/www/ring.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":900,"y":1100,"wires":[[]]},{"id":"4e0625ca602e7a8f","type":"api-call-service","z":"dd89857c15f353c7","name":"Save Reolink.jpgFor Debug","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.front_door"],"data":"{\"filename\":\"/config/www/reolink.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":880,"y":1140,"wires":[[]]},{"id":"9fb469eeb7720250","type":"http request","z":"dd89857c15f353c7","name":"[POST] Recognize Double-Take","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","senderr":false,"headers":[],"x":1870,"y":920,"wires":[[]]},{"id":"d73bf749ab740a63","type":"comment","z":"dd89857c15f353c7","name":"Doorbell pressed","info":"","x":100,"y":1440,"wires":[]},{"id":"a6bc5667c6639558","type":"comment","z":"dd89857c15f353c7","name":"20 seconds cooldown","info":"","x":480,"y":1200,"wires":[]},{"id":"e3254a08ffcbaea5","type":"comment","z":"dd89857c15f353c7","name":"Is double-take-front-door seeing someone?","info":"","x":520,"y":1440,"wires":[]},{"id":"41b845b86c3c5d99","type":"comment","z":"dd89857c15f353c7","name":"Is double-take-facecam seeing someone?","info":"","x":1040,"y":1060,"wires":[]},{"id":"614f12eee2c671d3","type":"inject","z":"dd89857c15f353c7","name":"1","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":270,"y":1440,"wires":[["f0ad81c29d51bce5"]]},{"id":"123f5ee375252c85","type":"inject","z":"dd89857c15f353c7","name":"Maxi at door","props":[{"p":"payload"},{"p":"data","v":"{\"entity_id\":\"sensor.double_take_front_door\",\"state\":\"3\",\"attributes\":{\"id\":\"1659459685.953183-1shuyf\",\"duration\":3.53,\"timestamp\":\"2022-08-02T17:01:31.497Z\",\"attempts\":11,\"camera\":\"front_door\",\"zones\":[\"entrance\",\"faceshot_zone\"],\"misses\":[{\"name\":\"alphonso\",\"confidence\":79.16,\"match\":false,\"box\":{\"top\":210,\"left\":529,\"width\":85,\"height\":105},\"checks\":[\"box area too low: 8925 < 10000\"],\"type\":\"latest\",\"duration\":0.21,\"detector\":\"deepstack\",\"filename\":\"bcfcd360-f639-45ef-97fa-2f68aa01d8eb.jpg\",\"base64\":null},{\"name\":\"maxi\",\"confidence\":75.7,\"match\":false,\"box\":{\"top\":212,\"left\":354,\"width\":62,\"height\":95},\"checks\":[\"box area too low: 5890 < 10000\"],\"type\":\"latest\",\"duration\":0.19,\"detector\":\"deepstack\",\"filename\":\"49e449d6-65e0-45c6-a21d-237a673b91da.jpg\",\"base64\":null}],\"matches\":[{\"name\":\"maxi\",\"confidence\":72.28,\"match\":true,\"box\":{\"top\":220,\"left\":244,\"width\":102,\"height\":104},\"type\":\"latest\",\"duration\":0.19,\"detector\":\"deepstack\",\"filename\":\"2a731787-cb90-4c90-bbc2-05e910f1576e.jpg\",\"base64\":null},{\"name\":\"nate\",\"confidence\":72.15,\"match\":true,\"box\":{\"top\":228,\"left\":203,\"width\":106,\"height\":98},\"type\":\"snapshot\",\"duration\":0.2,\"detector\":\"deepstack\",\"filename\":\"b5678550-20b0-4b04-a1b5-db4297d7a7ed.jpg\",\"base64\":null}],\"personCount\":3,\"icon\":\"mdi:camera\",\"friendly_name\":\"double_take_front_door\"},\"last_changed\":\"2022-08-02T17:01:31.518682+00:00\",\"last_updated\":\"2022-08-02T17:01:31.518682+00:00\",\"context\":{\"id\":\"01G9FR2RZYY9SBNXVSHJ5T9E0S\",\"parent_id\":null,\"user_id\":null},\"timeSinceChangedMs\":1499,\"original_state\":\"3\"}","vt":"json"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"sensor.remote_doorbell_button_action","payload":"3","payloadType":"num","x":1510,"y":1360,"wires":[["3c28784c1321d67d"]]},{"id":"4e6508dd082279dc","type":"inject","z":"dd89857c15f353c7","name":"Maxi recoed","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"matches\":[{\"name\":\"maxi\",\"confidence\":97.05,\"match\":true,\"box\":{\"top\":42,\"left\":6,\"width\":138,\"height\":171},\"type\":\"latest\",\"duration\":0,\"detector\":\"compreface\",\"filename\":\"248edd4f-c0e9-4060-88f5-ef9d9e36551d.jpg\",\"base64\":null}],\"highest_match\":{\"name\":\"maxi\",\"confidence\":97.05,\"match\":true,\"box\":{\"top\":42,\"left\":6,\"width\":138,\"height\":171},\"type\":\"latest\",\"duration\":0,\"detector\":\"compreface\",\"filename\":\"248edd4f-c0e9-4060-88f5-ef9d9e36551d.jpg\",\"base64\":null},\"image_url\":\"http://192.168.0.14:3000/api/storage/matches/248edd4f-c0e9-4060-88f5-ef9d9e36551d.jpg\"}","payloadType":"json","x":1810,"y":1480,"wires":[["84982b380a3a869b"]]},{"id":"2a6a536226e61940","type":"function","z":"dd89857c15f353c7","name":"Javascript","func":"var name = msg.payload.highest_match.name;\nvar url = msg.payload.save_path.replace(\"/mnt/hass\",\"https://hass.purgatoire.ca/local/nodered/\")\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"image\": url,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Enter Text\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2280,"y":1500,"wires":[["58d1fd26ab7e5f70"]]},{"id":"58d1fd26ab7e5f70","type":"api-call-service","z":"dd89857c15f353c7","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_galaxy_fold_4","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2490,"y":1440,"wires":[["e9e86f9f799dfc77","7e4a013511f695fb","a0c364c1923cfa06"]]},{"id":"32cedbc3a70263d5","type":"function","z":"dd89857c15f353c7","name":"Javascript","func":"var name = \"Someone\";\nvar url = \"https://hass.purgatoire.ca/local/reolinkring.jpg\";\nvar random = Date.now();\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"image\": url + \"?\" + random,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Enter Text\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2120,"y":1300,"wires":[["ca897dec181fdc7d"]]},{"id":"ca897dec181fdc7d","type":"api-call-service","z":"dd89857c15f353c7","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_galaxy_fold_4","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2370,"y":1300,"wires":[["3a18cd6f1cd00ffc","f415b56cb85073c5"]]},{"id":"97040eba8079d710","type":"comment","z":"dd89857c15f353c7","name":"LINK TO FIX DOORBELL","info":"","x":1450,"y":560,"wires":[]},{"id":"7e4a013511f695fb","type":"change","z":"dd89857c15f353c7","name":"Set Data for mass alert","rules":[{"t":"move","p":"payload.data.title","pt":"msg","to":"message","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"},{"t":"set","p":"video","pt":"msg","to":"on","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2820,"y":1420,"wires":[["e7bb87f2ce260b7c","085bae77e989c9f5"]]},{"id":"e7bb87f2ce260b7c","type":"subflow:233ac7dcd801a802","z":"dd89857c15f353c7","name":"","x":3050,"y":1420,"wires":[]},{"id":"e9e86f9f799dfc77","type":"debug","z":"dd89857c15f353c7","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2710,"y":1660,"wires":[]},{"id":"085bae77e989c9f5","type":"debug","z":"dd89857c15f353c7","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3010,"y":1360,"wires":[]},{"id":"e5da28d1a2c6e1c8","type":"debug","z":"dd89857c15f353c7","name":"debug 18","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1800,"y":1360,"wires":[]},{"id":"7a3e943cd0c65032","type":"switch","z":"dd89857c15f353c7","name":"Matches?","property":"payload.matches","propertyType":"msg","rules":[{"t":"eq","v":"none","vt":"str"},{"t":"nempty"}],"checkall":"false","repair":false,"outputs":2,"x":2000,"y":1400,"wires":[["5a9b99ad63b0e10d","c183cccda922e06d"],["2a6a536226e61940"]]},{"id":"2aafb5ed5fb7221d","type":"api-call-service","z":"dd89857c15f353c7","name":"Save Reolink.jpg for ingress","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.front_door"],"data":"{\"filename\":\"/config/www/reolink.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1160,"y":1540,"wires":[["de195cac02da5925"]]},{"id":"f415b56cb85073c5","type":"change","z":"dd89857c15f353c7","name":"Set Data for mass alert","rules":[{"t":"move","p":"payload.data.title","pt":"msg","to":"message","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"},{"t":"set","p":"video","pt":"msg","to":"on","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2720,"y":1300,"wires":[["74ae8cacb6d117d0"]]},{"id":"74ae8cacb6d117d0","type":"subflow:233ac7dcd801a802","z":"dd89857c15f353c7","name":"","x":2970,"y":1300,"wires":[]},{"id":"4dcbf0f53e16ca0a","type":"comment","z":"dd89857c15f353c7","name":"Save Reolink.jpg","info":"","x":1200,"y":1500,"wires":[]},{"id":"84c1917b4af61c0e","type":"comment","z":"dd89857c15f353c7","name":"No matches","info":"","x":2130,"y":1340,"wires":[]},{"id":"2d52e4dfe1464a83","type":"comment","z":"dd89857c15f353c7","name":"Matches over 85%","info":"","x":2790,"y":1560,"wires":[]},{"id":"3a9125b4093ed157","type":"api-current-state","z":"dd89857c15f353c7","name":"Acid time off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.acid_time","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3210,"y":1540,"wires":[["25f8feee00f8a4ca"],[]]},{"id":"813d47bcf5474aba","type":"api-current-state","z":"dd89857c15f353c7","name":"Front House Motion","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.motion_front","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":3270,"y":1460,"wires":[["25f8feee00f8a4ca"],[]]},{"id":"25f8feee00f8a4ca","type":"api-current-state","z":"dd89857c15f353c7","name":"kink off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.kink_party","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3400,"y":1540,"wires":[["92b9b19da0cc50b3","0cfa322e2f86ac01"],[]]},{"id":"cc9b4a03e1350d55","type":"api-current-state","z":"dd89857c15f353c7","name":"Waiting Friend?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.waiting_someone","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":3640,"y":1560,"wires":[["001784db32fff1e2"],[]]},{"id":"92b9b19da0cc50b3","type":"api-current-state","z":"dd89857c15f353c7","name":"Party on","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.party_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3540,"y":1500,"wires":[["8494a9adf85edace"],["9c935c7956118916"]]},{"id":"47f7f690aa57721a","type":"api-call-service","z":"dd89857c15f353c7","name":"unLock Door","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"lock","service":"unlock","areaId":[],"deviceId":[],"entityId":["lock.lock_front_door"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3950,"y":1540,"wires":[["9f712fd9a5e423d9","12255b636177e345"]]},{"id":"9f712fd9a5e423d9","type":"debug","z":"dd89857c15f353c7","name":"unlock","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4090,"y":1500,"wires":[]},{"id":"12255b636177e345","type":"ha-wait-until","z":"dd89857c15f353c7","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"unlocked","valueType":"str","timeout":"2","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":4100,"y":1540,"wires":[["e6d464424eb269b3"],[]]},{"id":"e6d464424eb269b3","type":"api-call-service","z":"dd89857c15f353c7","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4260,"y":1540,"wires":[["6080d27c4c13a53e"]]},{"id":"6080d27c4c13a53e","type":"ha-wait-until","z":"dd89857c15f353c7","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"locked","valueType":"str","timeout":"30","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":4440,"y":1540,"wires":[["f21a81aa4f977386"],["f21a81aa4f977386"]]},{"id":"f21a81aa4f977386","type":"api-call-service","z":"dd89857c15f353c7","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized","input_boolean.waiting_someone"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4620,"y":1540,"wires":[["b4db6f7962fed84e"]]},{"id":"9f08c99e58fab78f","type":"inject","z":"dd89857c15f353c7","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":4420,"y":1640,"wires":[["f21a81aa4f977386"]]},{"id":"b4db6f7962fed84e","type":"api-call-service","z":"dd89857c15f353c7","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":" {             \"value\": \"UNKNOWN\"         }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4830,"y":1540,"wires":[[]]},{"id":"001784db32fff1e2","type":"trigger","z":"dd89857c15f353c7","name":"1","op1":"1","op2":"","op1type":"num","op2type":"nul","duration":"2","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":3810,"y":1540,"wires":[["47f7f690aa57721a"]]},{"id":"cc3499d9e94623c4","type":"api-current-state","z":"dd89857c15f353c7","name":"Waiting Uber off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.waiting_uber","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3020,"y":1540,"wires":[["3a9125b4093ed157"],[]]},{"id":"8b8ab6894608285c","type":"api-call-service","z":"dd89857c15f353c7","name":"Save Ring.jpg for ingress","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.facecam"],"data":"{\"filename\":\"/config/www/ring.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1150,"y":1580,"wires":[["bba1e45017de6f51"]]},{"id":"bba1e45017de6f51","type":"http request","z":"dd89857c15f353c7","name":"POST request","method":"GET","ret":"obj","paytoqs":"ignore","url":"http://192.168.0.14:3000/api/recognize?url=http://192.168.0.15:8123/local/ring.jpg&camera=camera.facecam","tls":"","persist":false,"proxy":"","authType":"","senderr":false,"headers":[],"x":1380,"y":1580,"wires":[["46dfa9ffd07570ac"]]},{"id":"972f72dcf25a5390","type":"change","z":"dd89857c15f353c7","name":"Move matches","rules":[{"t":"move","p":"payload.matches","pt":"msg","to":"data.attributes.matches","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1680,"y":1560,"wires":[["5945b7bdeca6f1f1","3c28784c1321d67d"]]},{"id":"3ed2d0362f2fb2d4","type":"function","z":"dd89857c15f353c7","name":"Face Extractor compare 10.0","func":"var matches = msg.data.attributes.matches;\n//-----------------------------------------\nvar today = new Date();\nvar dd = String(today.getDate()).padStart(2, '0');\nvar hh = today.getHours();\nvar month = String(today.getMonth() + 1).padStart(2, '0');\nvar minutes = today.getMinutes();\nvar yyyy = today.getFullYear();\nvar today = yyyy + '-' + month  + '-' + dd + '---' + hh + minutes;\n\n//-----------------------------------------\n\nif ( matches.length > 0){\nmatches.sort(function(a, b) {return a[1] - b[1];}).reverse();\n\nvar highest_match = matches[0];\n\nif (highest_match.confidence > 85){\nvar newMsg = {\n\t\"payload\": {\n\t\t\"matches\": matches,\n\t\t\"highest_match\": highest_match ,\n\t\t\"image_url\": \"http://192.168.0.14:3000/api/storage/matches/\" + highest_match.filename,\n\t\t\"save_path\": \"/mnt/hass/\" + highest_match.name + \"/\" + today + \"---\" + highest_match.confidence + \".jpg\"\n\t}\n}\n\nreturn newMsg;\n} else {\n    var newMsg = {\n\t\"payload\": {\n\t\t\"matches\": \"none\"}}\n\nreturn newMsg; \n}\n}\nelse {\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"matches\": \"none\"}}\n\nreturn newMsg; \n\n}","outputs":1,"noerr":5,"initialize":"","finalize":"","libs":[],"x":1800,"y":1060,"wires":[[]]},{"id":"a0c364c1923cfa06","type":"switch","z":"dd89857c15f353c7","name":"Confidence > 85","property":"payload.highest_match.confidence","propertyType":"msg","rules":[{"t":"gt","v":"85","vt":"num"}],"checkall":"false","repair":false,"outputs":1,"x":2800,"y":1520,"wires":[["cc3499d9e94623c4"]]},{"id":"b64c54bd69ba1414","type":"comment","z":"dd89857c15f353c7","name":"Is double-take-facecam seeing someone?","info":"","x":900,"y":1440,"wires":[]},{"id":"46dfa9ffd07570ac","type":"join","z":"dd89857c15f353c7","name":"","mode":"custom","build":"merged","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"7","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"num","reduceFixup":"","x":1530,"y":1560,"wires":[["972f72dcf25a5390"]]},{"id":"de195cac02da5925","type":"http request","z":"dd89857c15f353c7","name":"POST request","method":"GET","ret":"obj","paytoqs":"ignore","url":"http://192.168.0.14:3000/api/recognize?url=http://192.168.0.15:8123/local/reolink.jpg&camera=camera.front_door","tls":"","persist":false,"proxy":"","authType":"","senderr":false,"headers":[],"x":1380,"y":1540,"wires":[["46dfa9ffd07570ac"]]},{"id":"39b095ab9eebbffd","type":"function","z":"dd89857c15f353c7","name":"Face Extractor compare 10.1","func":"var matches = msg.data.attributes.matches;\n//-----------------------------------------\nvar today = new Date();\nvar dd = String(today.getDate()).padStart(2, '0');\nvar hh = today.getHours();\nvar month = String(today.getMonth() + 1).padStart(2, '0');\nvar minutes = today.getMinutes();\nvar yyyy = today.getFullYear();\nvar today = yyyy + '-' + month  + '-' + dd + '---' + hh + minutes;\n\n//-----------------------------------------\n\nif ( matches.length > 0){\nmatches.sort(function(a, b) {return a[1] - b[1];}).reverse();\n\nvar highest_match = matches[0];\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"matches\": matches,\n\t\t\"highest_match\": highest_match ,\n\t\t\"image_url\": \"http://192.168.0.14:3000/api/storage/matches/\" + highest_match.filename,\n\t\t\"save_path\": \"/mnt/hass/\" + highest_match.name + \"/\" + today + \"---\" + highest_match.confidence + \".jpg\",\n\t\t\"confidence\": highest_match.confidence\n\t}\n}\n\nreturn newMsg;\n\n}\nelse {\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"matches\": \"none\"}}\n\nreturn newMsg; \n\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1800,"y":1020,"wires":[[]]},{"id":"5584461278c6fbeb","type":"function","z":"dd89857c15f353c7","name":"Face Extractor compare 5.1","func":"// SETTINGS\nvar required_conf = 80;\n// SETTINGS\n\n\nvar recoface = new Object();\nvar recofacesortable = [];\nvar name = \"\";\nvar camera = \"\";\nvar conf = \"\";\nvar reconame = \"\";\nvar confidence = \"\";\nvar reco = \"\";\n//declarations\n\n    for (i = 0; i < msg.payload.matches.length; i++){\n         for (y = 0; y < Object.keys(msg.payload.matches[i]).length; y++){\n                var name = msg.payload.matches[i][y][0];\n \t\t\t\tvar conf = msg.payload.matches[i][y][1];\n \t\t\t\tvar camera = msg.payload.matches[i][y][2];\n \t\t\t// \tif (conf > 0){\n \t\t\t\t    recofacesortable.push([name, conf, camera]);\n \t\t\t// \t}\n \t\t\t\t\n        }\n    }\n    \n    \n     \trecofacesortable.sort(function(a, b) {\n \t\treturn a[1] - b[1];\n \t}).reverse();\n \t\n    for (i = 0; i < recofacesortable.length; i++){\n        var reconame = recofacesortable[0][0];\n        var confidence = recofacesortable[0][1]\n        var camera = recofacesortable[0][2]\n        \n        \n    }\n\n\n\nif (confidence > required_conf) {\n\tvar recognized = 1;\n} else {\n\tvar recognized = 0;\n}\n\n if (camera == \"camera.front_door\"){\n     var camera = \"camera.reolink_static\";\n } else if (camera == \"camera.facecam\"){\n     var camera = \"camera.facecam_static\"\n }\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"name\": reconame,\n\t\t\"confidence\": confidence,\n\t//\t\"matched_faces\": total_matched_faces,\n\t//\t\"total_faces\": total_faces,\n\t\t\"recognized\": recognized,\n \t\t\"camera\": camera \n\t}\n};\n\nreturn newMsg;\n\n\n//  var test = {\n//  \t\"payload\": {\n// \t\t\"name\": reconame,\n// \t\t\"confidence\": confidence,\n// \t\t\"matched_faces\": total_matched_faces,\n// \t\t\"total_faces\": total_faces,\n// \t\t\"recognized\": recognized,\n// \t\t\"camera\": camera ,\n// \t\t\"recofacesortable\": recofacesortable\n//  \t}\n//  };\n//  return test;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1800,"y":840,"wires":[[]]},{"id":"ca9e4a8107a70787","type":"function","z":"dd89857c15f353c7","name":"Face Extractor compare 10.2","func":"var matches = msg.data.attributes.matches;\nvar recofacesortable = [];\n//-----------------------------------------\nvar today = new Date();\nvar dd = String(today.getDate()).padStart(2, '0');\nvar hh = today.getHours();\nvar month = String(today.getMonth() + 1).padStart(2, '0');\nvar minutes = today.getMinutes();\nvar yyyy = today.getFullYear();\nvar today = yyyy + '-' + month  + '-' + dd + '---' + hh + minutes;\n\n//-----------------------------------------\n\n\nif ( matches.length > 0){\n    \nfor (i = 0; i < matches.length; i++){\n    \n    if (matches[i].length > 0){\n\nrecofacesortable.push([name, confidence, filename]);\n}\n}\nrecofacesortable.sort(function(a, b) {return a[1] - b[1];}).reverse();\n\nvar highest_match = recofacesortable[0];\nvar newMsg = {\n\t\"payload\": {\n\t\t\"matches\": matches,\n\t\t\"highest_match\": highest_match ,\n\t\t\"image_url\": \"http://192.168.0.14:3000/api/storage/matches/\" + highest_match.filename,\n\t\t\"save_path\": \"/mnt/hass/\" + highest_match.name + \"/\" + today + \"---\" + highest_match.confidence + \".jpg\",\n\t\t\"confidence\": highest_match.confidence\n\t}\n}\n\nreturn newMsg;\n}\nelse {\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"matches\": \"none\"}}\n\nreturn newMsg; \n\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1800,"y":980,"wires":[[]]},{"id":"02421cc520e1fe71","type":"inject","z":"dd89857c15f353c7","name":"Maxi recoed","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"matches\":[{\"name\":\"maxi\",\"confidence\":97.05,\"match\":true,\"box\":{\"top\":42,\"left\":6,\"width\":138,\"height\":171},\"type\":\"latest\",\"duration\":0,\"detector\":\"compreface\",\"filename\":\"248edd4f-c0e9-4060-88f5-ef9d9e36551d.jpg\",\"base64\":null}],\"highest_match\":{\"name\":\"maxi\",\"confidence\":97.05,\"match\":true,\"box\":{\"top\":42,\"left\":6,\"width\":138,\"height\":171},\"type\":\"latest\",\"duration\":0,\"detector\":\"compreface\",\"filename\":\"248edd4f-c0e9-4060-88f5-ef9d9e36551d.jpg\",\"base64\":null},\"image_url\":\"http://192.168.0.14:3000/api/storage/matches/248edd4f-c0e9-4060-88f5-ef9d9e36551d.jpg\"}","payloadType":"json","x":2890,"y":1600,"wires":[["cc3499d9e94623c4"]]},{"id":"0b9af757ed9854ac","type":"function","z":"dd89857c15f353c7","name":"Face Extractor compare 10.1","func":"var matches = msg.data.attributes.matches;\n//-----------------------------------------\nvar today = new Date();\nvar dd = String(today.getDate()).padStart(2, '0');\nvar hh = today.getHours();\nvar month = String(today.getMonth() + 1).padStart(2, '0');\nvar minutes = today.getMinutes();\nvar yyyy = today.getFullYear();\nvar today = yyyy + '-' + month  + '-' + dd + '---' + hh + minutes;\n\n//-----------------------------------------\n\nif ( matches.length > 0){\nmatches.sort(function(a, b) {return a[1] - b[1];}).reverse();\n\nvar highest_match = matches[0];\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"matches\": matches,\n\t\t\"highest_match\": highest_match ,\n\t\t\"image_url\": \"http://192.168.0.14:3000/api/storage/matches/\" + highest_match.filename,\n\t\t\"save_path\": \"/mnt/hass/\" + highest_match.name + \"/\" + today + \"---\" + highest_match.confidence + \".jpg\",\n\t\t\"confidence\": highest_match.confidence\n\t}\n}\n\nreturn newMsg;\n\n}\nelse {\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"matches\": \"none\"}}\n\nreturn newMsg; \n\n}","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1800,"y":1100,"wires":[[]]},{"id":"5a9b99ad63b0e10d","type":"api-call-service","z":"dd89857c15f353c7","name":"Save Reolink.jpg for notif","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.front_door_camera_person"],"data":"{\"filename\":\"/config/www/reolinkring.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1930,"y":1300,"wires":[["32cedbc3a70263d5"]]},{"id":"2b01aa4d53a72942","type":"server-events","z":"dd89857c15f353c7","name":"","server":"7ab5c227.a3ce8c","version":2,"eventType":"mobile_app_notification_action","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":510,"y":2060,"wires":[["c02a5fbe787f494c","b204f545004af541"]]},{"id":"c02a5fbe787f494c","type":"debug","z":"dd89857c15f353c7","name":"actionable","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1010,"y":1940,"wires":[]},{"id":"b204f545004af541","type":"switch","z":"dd89857c15f353c7","name":"","property":"payload.event.action_1_title","propertyType":"msg","rules":[{"t":"eq","v":"Enter Text","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":750,"y":2120,"wires":[["c0da18a53116c3bd","5e5f5fd648ca6fd0"]]},{"id":"c0da18a53116c3bd","type":"function","z":"dd89857c15f353c7","name":"Javascript","func":"var text = msg.payload.event.reply_text;\n\n\n\nvar newMsg = {\n    \"text\": msg.payload.event.image,\n    \"payload\": {\n        \"data\": {\n            \"value\": text\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":860,"y":2180,"wires":[["5e5f5fd648ca6fd0","9b02d7dfc1fe644e"]]},{"id":"5e5f5fd648ca6fd0","type":"debug","z":"dd89857c15f353c7","name":"actionable","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1050,"y":2060,"wires":[]},{"id":"776066a2f5ffd3ea","type":"api-call-service","z":"dd89857c15f353c7","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1980,"y":2080,"wires":[[]]},{"id":"9b02d7dfc1fe644e","type":"api-call-service","z":"dd89857c15f353c7","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.front_door_phone_text"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1070,"y":2180,"wires":[["3c23b48c5835cf28"]]},{"id":"01d31433b8cc6c52","type":"api-call-service","z":"dd89857c15f353c7","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.front_door_phone_text"],"data":"{\"value\":\"Empty\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1770,"y":2180,"wires":[[]]},{"id":"5ab089c1d413064b","type":"inject","z":"dd89857c15f353c7","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1300,"y":2000,"wires":[["01d31433b8cc6c52"]]},{"id":"f90dcdf6497b6ea0","type":"inject","z":"dd89857c15f353c7","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":2500,"y":1200,"wires":[["f415b56cb85073c5"]]},{"id":"3c23b48c5835cf28","type":"trigger","z":"dd89857c15f353c7","name":"","op1":"","op2":"Empty","op1type":"nul","op2type":"str","duration":"2","extend":false,"overrideDelay":false,"units":"min","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1310,"y":2180,"wires":[["01d31433b8cc6c52"]]},{"id":"ebb7333b43a91f16","type":"inject","z":"dd89857c15f353c7","name":"Maxi at door","props":[{"p":"payload"},{"p":"data","v":"{\"entity_id\":\"sensor.double_take_front_door\",\"state\":\"3\",\"attributes\":{\"id\":\"1659459685.953183-1shuyf\",\"duration\":3.53,\"timestamp\":\"2022-08-02T17:01:31.497Z\",\"attempts\":11,\"camera\":\"front_door\",\"zones\":[\"entrance\",\"faceshot_zone\"],\"misses\":[{\"name\":\"alphonso\",\"confidence\":79.16,\"match\":false,\"box\":{\"top\":210,\"left\":529,\"width\":85,\"height\":105},\"checks\":[\"box area too low: 8925 < 10000\"],\"type\":\"latest\",\"duration\":0.21,\"detector\":\"deepstack\",\"filename\":\"bcfcd360-f639-45ef-97fa-2f68aa01d8eb.jpg\",\"base64\":null},{\"name\":\"maxi\",\"confidence\":75.7,\"match\":false,\"box\":{\"top\":212,\"left\":354,\"width\":62,\"height\":95},\"checks\":[\"box area too low: 5890 < 10000\"],\"type\":\"latest\",\"duration\":0.19,\"detector\":\"deepstack\",\"filename\":\"49e449d6-65e0-45c6-a21d-237a673b91da.jpg\",\"base64\":null}],\"matches\":[{\"name\":\"maxi\",\"confidence\":72.28,\"match\":true,\"box\":{\"top\":220,\"left\":244,\"width\":102,\"height\":104},\"type\":\"latest\",\"duration\":0.19,\"detector\":\"deepstack\",\"filename\":\"2a731787-cb90-4c90-bbc2-05e910f1576e.jpg\",\"base64\":null},{\"name\":\"nate\",\"confidence\":72.15,\"match\":true,\"box\":{\"top\":228,\"left\":203,\"width\":106,\"height\":98},\"type\":\"snapshot\",\"duration\":0.2,\"detector\":\"deepstack\",\"filename\":\"b5678550-20b0-4b04-a1b5-db4297d7a7ed.jpg\",\"base64\":null}],\"personCount\":3,\"icon\":\"mdi:camera\",\"friendly_name\":\"double_take_front_door\"},\"last_changed\":\"2022-08-02T17:01:31.518682+00:00\",\"last_updated\":\"2022-08-02T17:01:31.518682+00:00\",\"context\":{\"id\":\"01G9FR2RZYY9SBNXVSHJ5T9E0S\",\"parent_id\":null,\"user_id\":null},\"timeSinceChangedMs\":1499,\"original_state\":\"3\"}","vt":"json"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"sensor.remote_doorbell_button_action","payload":"3","payloadType":"num","x":1650,"y":1280,"wires":[["5a9b99ad63b0e10d","c183cccda922e06d"]]},{"id":"cba214656fa06f15","type":"inject","z":"dd89857c15f353c7","name":"Maxi at door","props":[{"p":"payload"},{"p":"data","v":"{\"entity_id\":\"sensor.double_take_front_door\",\"state\":\"3\",\"attributes\":{\"id\":\"1659459685.953183-1shuyf\",\"duration\":3.53,\"timestamp\":\"2022-08-02T17:01:31.497Z\",\"attempts\":11,\"camera\":\"front_door\",\"zones\":[\"entrance\",\"faceshot_zone\"],\"misses\":[{\"name\":\"alphonso\",\"confidence\":79.16,\"match\":false,\"box\":{\"top\":210,\"left\":529,\"width\":85,\"height\":105},\"checks\":[\"box area too low: 8925 < 10000\"],\"type\":\"latest\",\"duration\":0.21,\"detector\":\"deepstack\",\"filename\":\"bcfcd360-f639-45ef-97fa-2f68aa01d8eb.jpg\",\"base64\":null},{\"name\":\"maxi\",\"confidence\":75.7,\"match\":false,\"box\":{\"top\":212,\"left\":354,\"width\":62,\"height\":95},\"checks\":[\"box area too low: 5890 < 10000\"],\"type\":\"latest\",\"duration\":0.19,\"detector\":\"deepstack\",\"filename\":\"49e449d6-65e0-45c6-a21d-237a673b91da.jpg\",\"base64\":null}],\"matches\":[{\"name\":\"maxi\",\"confidence\":72.28,\"match\":true,\"box\":{\"top\":220,\"left\":244,\"width\":102,\"height\":104},\"type\":\"latest\",\"duration\":0.19,\"detector\":\"deepstack\",\"filename\":\"2a731787-cb90-4c90-bbc2-05e910f1576e.jpg\",\"base64\":null},{\"name\":\"nate\",\"confidence\":72.15,\"match\":true,\"box\":{\"top\":228,\"left\":203,\"width\":106,\"height\":98},\"type\":\"snapshot\",\"duration\":0.2,\"detector\":\"deepstack\",\"filename\":\"b5678550-20b0-4b04-a1b5-db4297d7a7ed.jpg\",\"base64\":null}],\"personCount\":3,\"icon\":\"mdi:camera\",\"friendly_name\":\"double_take_front_door\"},\"last_changed\":\"2022-08-02T17:01:31.518682+00:00\",\"last_updated\":\"2022-08-02T17:01:31.518682+00:00\",\"context\":{\"id\":\"01G9FR2RZYY9SBNXVSHJ5T9E0S\",\"parent_id\":null,\"user_id\":null},\"timeSinceChangedMs\":1499,\"original_state\":\"3\"}","vt":"json"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"sensor.remote_doorbell_button_action","payload":"3","payloadType":"num","x":2210,"y":1220,"wires":[[]]},{"id":"3a18cd6f1cd00ffc","type":"debug","z":"dd89857c15f353c7","name":"debug 177","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":2590,"y":1240,"wires":[]},{"id":"e474e1b9570f0a2f","type":"function","z":"dd89857c15f353c7","name":"Javascript","func":"var name = \"Someone\";\nvar url = \"https://hass.purgatoire.ca/local/faceshot.jpg\";\nvar random = Date.now();\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"image\": url + \"?\" + random,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Enter Text\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2100,"y":1260,"wires":[["e92f1d561b9915fa"]]},{"id":"e92f1d561b9915fa","type":"api-call-service","z":"dd89857c15f353c7","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_galaxy_fold_4","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2350,"y":1260,"wires":[[]]},{"id":"c183cccda922e06d","type":"api-call-service","z":"dd89857c15f353c7","name":"Save Reolink.jpg for notif","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.faceshot_camera_person"],"data":"{\"filename\":\"/config/www/faceshot.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1910,"y":1260,"wires":[["e474e1b9570f0a2f"]]},{"id":"d561e196abe3e3fe","type":"inject","z":"dd89857c15f353c7","name":"1","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"num","x":310,"y":880,"wires":[["08afb0445661ccf3"]]},{"id":"08afb0445661ccf3","type":"api-call-service","z":"dd89857c15f353c7","name":"Save Facecam Ring.jpg For Debug","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.faceshot_go2rtc"],"data":"{\"filename\":\"/config/www/ring.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":560,"y":880,"wires":[["4effb35fd04eac34"]]},{"id":"8ccb85b20be35531","type":"http request","z":"dd89857c15f353c7","name":"POST request","method":"GET","ret":"obj","paytoqs":"ignore","url":"http://192.168.0.14:3000/api/recognize?url=http://192.168.0.15:8123/local/ring.jpg&camera=camera.facecam","tls":"","persist":false,"proxy":"","authType":"","senderr":false,"headers":[],"x":980,"y":880,"wires":[[]]},{"id":"4effb35fd04eac34","type":"trigger","z":"dd89857c15f353c7","name":"20s Cooldown","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"3","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":800,"y":880,"wires":[["8ccb85b20be35531"]]},{"id":"8356b51a9007c3b7","type":"http request","z":"cd7a606d7931c143","name":"POST request with link to current image on faceshot camera","method":"GET","ret":"obj","paytoqs":"ignore","url":"http://192.168.0.14:3000/api/recognize?url=http://192.168.0.14:5000/api/faceshot_camera/latest.jpg?quality=100","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":580,"y":720,"wires":[["9d26e1a43b7468d6","3654de3dfbdb6a8c"]]},{"id":"ce230f98044f9ce1","type":"trigger","z":"cd7a606d7931c143","name":"2 minutes","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"2","extend":false,"overrideDelay":false,"units":"min","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":200,"y":720,"wires":[["757ceece5ae2a82f","8356b51a9007c3b7","5197a8dcb4f7e262"]]},{"id":"acdce7f00366b401","type":"debug","z":"cd7a606d7931c143","name":"debug 196","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3390,"y":600,"wires":[]},{"id":"ebe93d01362801ad","type":"inject","z":"cd7a606d7931c143","name":"","props":[{"p":"payload"},{"p":"data","v":"{\"entity_id\":\"sensor.remote_doorbell_button_action\",\"old_state\":{\"entity_id\":\"sensor.remote_doorbell_button_action\",\"state\":\"None\",\"attributes\":{\"action\":null,\"battery\":88,\"click\":\"\",\"device\":{\"applicationVersion\":10,\"dateCode\":\"20150424\",\"friendlyName\":\"remote_doorbell_button\",\"hardwareVersion\":2,\"ieeeAddr\":\"0x00158d000210d4d2\",\"manufacturerID\":4151,\"manufacturerName\":\"LUMI\",\"model\":\"WXKG01LM\",\"networkAddress\":36077,\"powerSource\":\"Battery\",\"softwareBuildID\":\"3000-0001\",\"stackVersion\":2,\"type\":\"EndDevice\"},\"linkquality\":47,\"power_outage_count\":78,\"voltage\":2982,\"icon\":\"mdi:gesture-double-tap\",\"friendly_name\":\"remote_doorbell_button_action\"},\"last_changed\":\"2023-02-24T23:35:13.214676+00:00\",\"last_updated\":\"2023-02-24T23:35:13.214676+00:00\",\"context\":{\"id\":\"01GT2WFQ1Y1GVKCW3ZJV32CPDN\",\"parent_id\":null,\"user_id\":null},\"original_state\":\"None\"},\"new_state\":{\"entity_id\":\"sensor.remote_doorbell_button_action\",\"state\":\"single\",\"attributes\":{\"action\":\"single\",\"battery\":88,\"click\":null,\"device\":{\"applicationVersion\":10,\"dateCode\":\"20150424\",\"friendlyName\":\"remote_doorbell_button\",\"hardwareVersion\":2,\"ieeeAddr\":\"0x00158d000210d4d2\",\"manufacturerID\":4151,\"manufacturerName\":\"LUMI\",\"model\":\"WXKG01LM\",\"networkAddress\":36077,\"powerSource\":\"Battery\",\"softwareBuildID\":\"3000-0001\",\"stackVersion\":2,\"type\":\"EndDevice\"},\"linkquality\":47,\"power_outage_count\":78,\"voltage\":2982,\"icon\":\"mdi:gesture-double-tap\",\"friendly_name\":\"remote_doorbell_button_action\"},\"last_changed\":\"2023-02-24T23:35:22.159493+00:00\",\"last_updated\":\"2023-02-24T23:35:22.159493+00:00\",\"context\":{\"id\":\"01GT2WFZSFAF0F9EAQK1V5CD7X\",\"parent_id\":null,\"user_id\":null},\"original_state\":\"single\",\"timeSinceChangedMs\":18}}","vt":"json"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"sensor.remote_doorbell_button_action","payload":"{\"id\":\"793e0807-1a43-4934-a9f3-590af05e8c1a\",\"duration\":1.62,\"timestamp\":\"2023-02-24T23:35:23.914Z\",\"attempts\":1,\"camera\":\"manual\",\"zones\":[],\"counts\":{\"person\":1,\"match\":1,\"miss\":0,\"unknown\":0},\"matches\":[{\"name\":\"alicia m\",\"confidence\":99.31,\"match\":true,\"box\":{\"top\":636,\"left\":69,\"width\":561,\"height\":681},\"type\":\"manual\",\"duration\":0.28,\"detector\":\"compreface\",\"filename\":\"972ed9f9-5b5b-4216-959d-2a8b1193b650.jpg\",\"base64\":null}],\"misses\":[],\"unknowns\":[]}","payloadType":"json","x":1090,"y":600,"wires":[["9d26e1a43b7468d6"]]},{"id":"757ceece5ae2a82f","type":"api-call-service","z":"cd7a606d7931c143","name":"Turn on Door Rang","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.door_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":410,"y":680,"wires":[["19d4608aca40257c"]]},{"id":"19d4608aca40257c","type":"ha-wait-until","z":"cd7a606d7931c143","name":"Wait for door to lock","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"locked","valueType":"str","timeout":"3","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":false,"blockInputOverrides":true,"outputProperties":[],"x":620,"y":680,"wires":[["fec1201a9f096ec4"],["fec1201a9f096ec4"]]},{"id":"fec1201a9f096ec4","type":"api-call-service","z":"cd7a606d7931c143","name":"Turn off \"Door rang\"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.door_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":840,"y":680,"wires":[[]]},{"id":"9d26e1a43b7468d6","type":"switch","z":"cd7a606d7931c143","name":"Are there matches?","property":"payload.counts.match","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1190,"y":720,"wires":[["d5035d7a4b8abde0","dc5c22f8fb2385a7"],["e8ce77d8da41bd8e"]]},{"id":"87766266822443bf","type":"comment","z":"cd7a606d7931c143","name":"Yes","info":"","x":1890,"y":660,"wires":[]},{"id":"ca41cbd48ba54a0e","type":"comment","z":"cd7a606d7931c143","name":"No","info":"","x":1370,"y":740,"wires":[]},{"id":"8a86d116cbd23a0c","type":"change","z":"cd7a606d7931c143","name":"Set msg.match","rules":[{"t":"set","p":"match","pt":"msg","to":"payload.matches[0]","tot":"msg","dc":true},{"t":"set","p":"match.camera","pt":"msg","to":"payload.camera","tot":"msg","dc":true},{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1520,"y":700,"wires":[["c4c2d8ee6f80df16"]]},{"id":"7755d95655d67413","type":"http request","z":"cd7a606d7931c143","name":"POST request with Reolink-double-take last image","method":"GET","ret":"obj","paytoqs":"ignore","url":"http://192.168.0.14:3000/api/recognize?url=http://192.168.0.14:3000/api/storage/latest/front_door_camera.jpg&camera=front_door_camera","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":2170,"y":740,"wires":[["e1b5a65264dfc11d"]]},{"id":"9323da00227c8c8b","type":"inject","z":"cd7a606d7931c143","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1840,"y":860,"wires":[["7755d95655d67413"]]},{"id":"e1b5a65264dfc11d","type":"switch","z":"cd7a606d7931c143","name":"Are there matches?","property":"payload.counts.match","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":2470,"y":740,"wires":[["f1e47b926b68837c"],["0f8df3cecc7769a3"]]},{"id":"b2a4e650595bca7e","type":"comment","z":"cd7a606d7931c143","name":"Yes","info":"","x":2650,"y":720,"wires":[]},{"id":"e204bf79e084d730","type":"comment","z":"cd7a606d7931c143","name":"No","info":"","x":2650,"y":760,"wires":[]},{"id":"44af510b1d02e54e","type":"inject","z":"cd7a606d7931c143","name":"Maxi at door","props":[{"p":"payload"},{"p":"data","v":"{\"entity_id\":\"sensor.double_take_front_door\",\"state\":\"3\",\"attributes\":{\"id\":\"1659459685.953183-1shuyf\",\"duration\":3.53,\"timestamp\":\"2022-08-02T17:01:31.497Z\",\"attempts\":11,\"camera\":\"front_door\",\"zones\":[\"entrance\",\"faceshot_zone\"],\"misses\":[{\"name\":\"alphonso\",\"confidence\":79.16,\"match\":false,\"box\":{\"top\":210,\"left\":529,\"width\":85,\"height\":105},\"checks\":[\"box area too low: 8925 < 10000\"],\"type\":\"latest\",\"duration\":0.21,\"detector\":\"deepstack\",\"filename\":\"bcfcd360-f639-45ef-97fa-2f68aa01d8eb.jpg\",\"base64\":null},{\"name\":\"maxi\",\"confidence\":75.7,\"match\":false,\"box\":{\"top\":212,\"left\":354,\"width\":62,\"height\":95},\"checks\":[\"box area too low: 5890 < 10000\"],\"type\":\"latest\",\"duration\":0.19,\"detector\":\"deepstack\",\"filename\":\"49e449d6-65e0-45c6-a21d-237a673b91da.jpg\",\"base64\":null}],\"matches\":[{\"name\":\"maxi\",\"confidence\":72.28,\"match\":true,\"box\":{\"top\":220,\"left\":244,\"width\":102,\"height\":104},\"type\":\"latest\",\"duration\":0.19,\"detector\":\"deepstack\",\"filename\":\"2a731787-cb90-4c90-bbc2-05e910f1576e.jpg\",\"base64\":null},{\"name\":\"nate\",\"confidence\":72.15,\"match\":true,\"box\":{\"top\":228,\"left\":203,\"width\":106,\"height\":98},\"type\":\"snapshot\",\"duration\":0.2,\"detector\":\"deepstack\",\"filename\":\"b5678550-20b0-4b04-a1b5-db4297d7a7ed.jpg\",\"base64\":null}],\"personCount\":3,\"icon\":\"mdi:camera\",\"friendly_name\":\"double_take_front_door\"},\"last_changed\":\"2022-08-02T17:01:31.518682+00:00\",\"last_updated\":\"2022-08-02T17:01:31.518682+00:00\",\"context\":{\"id\":\"01G9FR2RZYY9SBNXVSHJ5T9E0S\",\"parent_id\":null,\"user_id\":null},\"timeSinceChangedMs\":1499,\"original_state\":\"3\"}","vt":"json"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"sensor.remote_doorbell_button_action","payload":"3","payloadType":"num","x":2830,"y":860,"wires":[["fdc333b7d683f18c"]]},{"id":"b2c03746e03a6726","type":"function","z":"cd7a606d7931c143","name":"JavascriptNotification setter Reolink","func":"var name = \"Someone\";\nvar url1 = \"https://hass.purgatoire.ca/local/reolinkring.jpg\";\nvar url2 = \"https://hass.purgatoire.ca/local/ring.jpg\";\nvar random = Date.now();\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"sticky\": 'true',\n\t\t\t\t\"clickAction\": '/phone-landing/reolink?kiosk=1',\n\t\t\t\t\"priority\": 'high',\n\t\t\t\t\"image\": url1 + \"?\" + random,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Enter Text\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4260,"y":800,"wires":[["1a15e85a29c4f2bf","75f2fce62b13cbe7"]]},{"id":"759704f763b58501","type":"api-call-service","z":"cd7a606d7931c143","name":"Save Reolink.jpg for notif","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.front_door_go2rtc"],"data":"{\"filename\":\"/config/www/reolinkring.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3970,"y":760,"wires":[["b2c03746e03a6726","4d080cad7eb6e607"]]},{"id":"4d080cad7eb6e607","type":"function","z":"cd7a606d7931c143","name":"Notification setter Facecam","func":"var name = \"Someone\";\nvar url1 = \"https://hass.purgatoire.ca/local/reolinkring.jpg\";\nvar url2 = \"https://hass.purgatoire.ca/local/ring.jpg\";\nvar random = Date.now();\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"sticky\": 'true',\n\t\t\t\t\"clickAction\": '/phone-landing/reolink?kiosk=1',\n\t\t\t\t\"priority\": 'high',\n\t\t\t\t\"image\": url2 + \"?\" + random,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4260,"y":840,"wires":[["75f2fce62b13cbe7"]]},{"id":"7b4039020f84dc97","type":"inject","z":"cd7a606d7931c143","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":200,"y":640,"wires":[["ce230f98044f9ce1"]]},{"id":"dc5c22f8fb2385a7","type":"debug","z":"cd7a606d7931c143","name":"debug 199","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1410,"y":480,"wires":[]},{"id":"c4c2d8ee6f80df16","type":"switch","z":"cd7a606d7931c143","name":"confidence over 80%?","property":"match.confidence","propertyType":"msg","rules":[{"t":"gt","v":"80","vt":"num"},{"t":"lt","v":"80","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1720,"y":700,"wires":[["79ea6e5eebeb3dc4"],["1d8a1bf5c390d165"]]},{"id":"eff0a4e4802948b8","type":"comment","z":"cd7a606d7931c143","name":"No","info":"","x":1890,"y":740,"wires":[]},{"id":"84662acf4451979c","type":"change","z":"cd7a606d7931c143","name":"Set msg.match","rules":[{"t":"set","p":"match","pt":"msg","to":"payload.matches[0]","tot":"msg","dc":true},{"t":"set","p":"match.camera","pt":"msg","to":"payload.camera","tot":"msg","dc":true},{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2800,"y":720,"wires":[["52ab15905efdccbf"]]},{"id":"52ab15905efdccbf","type":"switch","z":"cd7a606d7931c143","name":"confidence over 80%?","property":"match.confidence","propertyType":"msg","rules":[{"t":"gt","v":"80","vt":"num"},{"t":"lt","v":"80","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":3000,"y":720,"wires":[["94e15e45a5dd4895"],["13611f4c75079d74"]]},{"id":"93d6cda3f0e6e049","type":"comment","z":"cd7a606d7931c143","name":"Yes","info":"","x":3190,"y":700,"wires":[]},{"id":"bb918eb43d688bdd","type":"comment","z":"cd7a606d7931c143","name":"No","info":"","x":3190,"y":740,"wires":[]},{"id":"1a15e85a29c4f2bf","type":"change","z":"cd7a606d7931c143","name":"Set Data for mass alert","rules":[{"t":"move","p":"payload.data.title","pt":"msg","to":"message","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"},{"t":"set","p":"video","pt":"msg","to":"on","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":4540,"y":760,"wires":[["869011ab1d65be1d"]]},{"id":"869011ab1d65be1d","type":"subflow:233ac7dcd801a802","z":"cd7a606d7931c143","name":"","x":4770,"y":760,"wires":[]},{"id":"1802a44a8c51174f","type":"api-current-state","z":"cd7a606d7931c143","name":"Acid time off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.acid_time","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3550,"y":660,"wires":[["ed706878831ed655"],["78575bad96d21598"]]},{"id":"ed706878831ed655","type":"api-current-state","z":"cd7a606d7931c143","name":"kink off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.kink_party","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3720,"y":660,"wires":[["5b7f84552314f7fb","f152504f7838b65f"],["f9d1114c3060999d"]]},{"id":"8f42a1e376b2f151","type":"api-current-state","z":"cd7a606d7931c143","name":"Waiting Friend?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.waiting_someone","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":3980,"y":700,"wires":[["622b280fd9e0e6f8"],["e6e258ae376ae884"]]},{"id":"5b7f84552314f7fb","type":"api-current-state","z":"cd7a606d7931c143","name":"Party on","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.party_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3880,"y":620,"wires":[["eca51006f7ccf6da"],["8f42a1e376b2f151"]]},{"id":"116f7fc3f104a266","type":"api-current-state","z":"cd7a606d7931c143","name":"Waiting Uber off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.waiting_uber","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3360,"y":660,"wires":[["1802a44a8c51174f"],["625b7fb50bb7a849"]]},{"id":"a74c2ad35eac8a53","type":"api-current-state","z":"cd7a606d7931c143","name":"Front House Motion","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.motion_front","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":4250,"y":660,"wires":[["36c151f20a99b664","491b918fb32cff35"],["e6e258ae376ae884"]]},{"id":"037893fa810691e1","type":"debug","z":"cd7a606d7931c143","name":"debug 200","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4790,"y":620,"wires":[]},{"id":"5b6f95c2a8b5d696","type":"comment","z":"cd7a606d7931c143","name":"No","info":"","x":3370,"y":740,"wires":[]},{"id":"8991ba94f70551a7","type":"comment","z":"cd7a606d7931c143","name":"No","info":"","x":3550,"y":740,"wires":[]},{"id":"f630f901bd03402a","type":"comment","z":"cd7a606d7931c143","name":"No","info":"","x":3730,"y":740,"wires":[]},{"id":"3286fb8b0a7a7ed7","type":"comment","z":"cd7a606d7931c143","name":"No","info":"","x":4130,"y":700,"wires":[]},{"id":"36c151f20a99b664","type":"function","z":"cd7a606d7931c143","name":"Notif setter","func":"var name = msg.match.name\nvar url1 = \"https://hass.purgatoire.ca/local/reolinkring.jpg\";\nvar url2 = \"https://hass.purgatoire.ca/local/ring.jpg\";\nvar random = Date.now();\nvar cameraused = msg.match.camera;\n\nif (cameraused == \"faceshot_camera\") {\n\tvar usedurl = url2;\n}\nif (cameraused == \"front_door_camera\") {\n\tvar usedurl = url1;\n}\n\n\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Guest Alert\",\n\t\t\t\"title\": name + \" is being let in\",\n\t\t\t\"data\": {\n\t\t\t\t\"sticky\": 'true',\n\t\t\t\t\"clickAction\": '/phone-landing/reolink?kiosk=1',\n\t\t\t\t\"priority\": 'high',\n\t\t\t\t\"image\": usedurl + \"?\" + random,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\"title\": \"Enter Text\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4470,"y":680,"wires":[["037893fa810691e1","37d31009dd04fd36","6344ca923892ef31"]]},{"id":"37d31009dd04fd36","type":"change","z":"cd7a606d7931c143","name":"Set Data for mass alert","rules":[{"t":"move","p":"payload.data.title","pt":"msg","to":"message","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[200,200.0]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"},{"t":"set","p":"video","pt":"msg","to":"on","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":4540,"y":720,"wires":[["869011ab1d65be1d"]]},{"id":"9be2f214cabf3c56","type":"delay","z":"cd7a606d7931c143","name":"1M/S","pauseType":"queue","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":4070,"y":640,"wires":[["a74c2ad35eac8a53"]]},{"id":"0751b4256605b31e","type":"api-call-service","z":"cd7a606d7931c143","name":"unLock Door","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"lock","service":"unlock","areaId":[],"deviceId":[],"entityId":["lock.lock_front_door"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4010,"y":520,"wires":[["a6c151d464d2a7bb","4b3622c38c8a3d4c"]]},{"id":"a6c151d464d2a7bb","type":"debug","z":"cd7a606d7931c143","name":"unlock","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4150,"y":480,"wires":[]},{"id":"4b3622c38c8a3d4c","type":"ha-wait-until","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"unlocked","valueType":"str","timeout":"2","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":4160,"y":520,"wires":[["3929f62648b94b4f"],[]]},{"id":"7329f3a0fc96f8f5","type":"ha-wait-until","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"locked","valueType":"str","timeout":"30","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":4500,"y":520,"wires":[["78e6c9cc2f3f3221"],["78e6c9cc2f3f3221"]]},{"id":"78e6c9cc2f3f3221","type":"api-call-service","z":"cd7a606d7931c143","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized","input_boolean.waiting_someone"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4680,"y":520,"wires":[["578b9966eaf564a5"]]},{"id":"578b9966eaf564a5","type":"api-call-service","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":" {             \"value\": \"UNKNOWN\"         }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4890,"y":520,"wires":[[]]},{"id":"491b918fb32cff35","type":"function","z":"cd7a606d7931c143","name":"Name Payload","func":"var name = msg.match.name;\n\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"value\": name\n        }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4360,"y":580,"wires":[["ec5c61fd69030e8e"]]},{"id":"ec5c61fd69030e8e","type":"api-call-service","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4560,"y":580,"wires":[["ceaf2b9901f10668"]]},{"id":"3929f62648b94b4f","type":"api-call-service","z":"cd7a606d7931c143","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4320,"y":520,"wires":[["7329f3a0fc96f8f5"]]},{"id":"ceaf2b9901f10668","type":"trigger","z":"cd7a606d7931c143","name":"","op1":"1","op2":"","op1type":"str","op2type":"nul","duration":"250","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":4080,"y":580,"wires":[["0751b4256605b31e"]]},{"id":"a03781b4d453187a","type":"api-call-service","z":"cd7a606d7931c143","name":"Save Facecam Ring.jpg For Debug","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.faceshot_go2rtc"],"data":"{\"filename\":\"/config/www/ring.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":520,"y":180,"wires":[[]]},{"id":"14716af57c8f9b9d","type":"inject","z":"cd7a606d7931c143","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":300,"y":160,"wires":[["a03781b4d453187a"]]},{"id":"6b34a4c899761c04","type":"api-call-service","z":"cd7a606d7931c143","name":"Save Reolink.jpg for notif","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.front_door_go2rtc"],"data":"{\"filename\":\"/config/www/reolinkring.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1730,"y":220,"wires":[[]]},{"id":"8a39449972026570","type":"api-call-service","z":"cd7a606d7931c143","name":"Save Facecam Ring.jpg For Debug","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.faceshot_go2rtc"],"data":"{\"filename\":\"/config/www/ring.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1400,"y":220,"wires":[["6b34a4c899761c04"]]},{"id":"31c62afa4e6e505f","type":"inject","z":"cd7a606d7931c143","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1160,"y":220,"wires":[["8a39449972026570"]]},{"id":"6b66e722564ac9a3","type":"exec","z":"cd7a606d7931c143","command":"rm /config/www/ring.jpg","addpay":"","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"","x":1410,"y":100,"wires":[["aa50610b81b16971"],["aa50610b81b16971"],["aa50610b81b16971"]]},{"id":"aa50610b81b16971","type":"debug","z":"cd7a606d7931c143","name":"debug 201","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2070,"y":140,"wires":[]},{"id":"53b3851fe8d777e6","type":"inject","z":"cd7a606d7931c143","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1194.8958129882812,"y":100,"wires":[["6b66e722564ac9a3"]]},{"id":"5197a8dcb4f7e262","type":"api-call-service","z":"cd7a606d7931c143","name":"Save Facecam Ring.jpg For Notification","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.faceshot_go2rtc"],"data":"{\"filename\":\"/config/www/ring.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":480,"y":760,"wires":[[]]},{"id":"df92c7792f1fbbd4","type":"comment","z":"cd7a606d7931c143","name":"No","info":"","x":3890,"y":660,"wires":[]},{"id":"6344ca923892ef31","type":"api-call-service","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_fold4","areaId":[],"deviceId":[],"entityId":[],"data":"{\"message\":\"Bedroom door open\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4810,"y":680,"wires":[[]]},{"id":"75f2fce62b13cbe7","type":"api-call-service","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_fold4","areaId":[],"deviceId":[],"entityId":[],"data":"{\"message\":\"Bedroom door open\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4570,"y":840,"wires":[[]]},{"id":"315f5569a3cd1e1f","type":"switch","z":"cd7a606d7931c143","name":"'Who is this?'?","property":"payload.event.action_1_title","propertyType":"msg","rules":[{"t":"eq","v":"Who is this?","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1150,"y":2660,"wires":[["c2662100f7dada1b"]]},{"id":"66870ae54d415f31","type":"function","z":"cd7a606d7931c143","name":"Javascript","func":"var name = msg.data.event.reply_text;\n\nvar newMsg = {\n \"url\": \"http://192.168.0.14:3000/api/train/retrain/\" + name,\n \"data\": msg.data\n };\n\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1840,"y":2700,"wires":[["c8a2221e9878688b","59387ed647db9b45"]]},{"id":"abb2babfbaf1f043","type":"server-events","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":2,"eventType":"mobile_app_notification_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":900,"y":2700,"wires":[["df207d122707860f","315f5569a3cd1e1f"]]},{"id":"59387ed647db9b45","type":"http request","z":"cd7a606d7931c143","name":"POST request","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":2040,"y":2700,"wires":[["1f14ea34c73aed0f","19d14fb87189e552"]]},{"id":"df207d122707860f","type":"debug","z":"cd7a606d7931c143","name":"actionable","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1250,"y":2760,"wires":[]},{"id":"19d14fb87189e552","type":"function","z":"cd7a606d7931c143","name":"Javascript","func":"var snapshot = msg.data.event.image;\nvar name = msg.data.event.reply_text;\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n  \"message\": \"Faces learning for\" + \" \" + name,\n  \"data\": {\n    \"image\": snapshot\n  }\n}\n }\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2680,"y":2700,"wires":[["f0ec948dd57314cf","1832a1b9f4db63f9"]]},{"id":"f0ec948dd57314cf","type":"api-call-service","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2880,"y":2700,"wires":[["19661f924505b1f0"]]},{"id":"19661f924505b1f0","type":"debug","z":"cd7a606d7931c143","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2870,"y":2640,"wires":[]},{"id":"b20fb29fbb0e92c3","type":"function","z":"cd7a606d7931c143","name":"Javascript","func":"var d = new Date();\nvar name = msg.payload.name;\nvar m = d.getMilliseconds();\nvar snapshot = msg.payload.data.filename;\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\" + m;\n\nvar snapshot = snapshot.replace(\"\\/config\\/www\",\"https:\\/\\/hass.purgatoire.ca\\/local\");\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"image\": snapshot,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3780,"y":960,"wires":[[]]},{"id":"b25e207878661b2c","type":"function","z":"cd7a606d7931c143","name":"Notification setter Facecam","func":"var name = \"Someone\";\nvar url1 = \"https://hass.purgatoire.ca/local/reolinkring.jpg\";\nvar url2 = \"https://hass.purgatoire.ca/local/ring.jpg\";\nvar random = Date.now();\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"sticky\": 'true',\n\t\t\t\t\"clickAction\": '/phone-landing/reolink?kiosk=1',\n\t\t\t\t\"priority\": 'high',\n\t\t\t\t\"image\": url2 + \"?\" + random,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\"title\": \"Unlock The Door!\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":680,"y":1940,"wires":[["222adf3ff52bb56b"]]},{"id":"222adf3ff52bb56b","type":"api-call-service","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_fold4","areaId":[],"deviceId":[],"entityId":[],"data":"{\"message\":\"Bedroom door open\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":990,"y":1940,"wires":[[]]},{"id":"cdd8368d7ec62007","type":"inject","z":"cd7a606d7931c143","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":460,"y":1940,"wires":[["b25e207878661b2c"]]},{"id":"c2662100f7dada1b","type":"switch","z":"cd7a606d7931c143","name":"","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"REPLY","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1300,"y":2700,"wires":[["3342da11fe49855e"]]},{"id":"7ca9b3d1c4953a79","type":"server-events","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":2,"eventType":"mobile_app_notification_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":290,"y":1240,"wires":[["fc2028b5a047d6c0"]]},{"id":"fc2028b5a047d6c0","type":"switch","z":"cd7a606d7931c143","name":"","property":"payload.event.action_1_title","propertyType":"msg","rules":[{"t":"eq","v":"Enter Text","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":550,"y":1240,"wires":[["2a770d5c5b0126d9"]]},{"id":"d377f9603c40973f","type":"function","z":"cd7a606d7931c143","name":"Javascript","func":"var text = msg.payload.event.reply_text;\n\n\n\nvar newMsg = {\n    \"text\": msg.payload.event.image,\n    \"payload\": {\n        \"data\": {\n            \"value\": text\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":820,"y":1240,"wires":[["9f3f959c6b7cf905"]]},{"id":"9f3f959c6b7cf905","type":"api-call-service","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.front_door_phone_text"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1020,"y":1240,"wires":[["035ecb8b05a7849e"]]},{"id":"92e9992baaede561","type":"api-call-service","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.front_door_phone_text"],"data":"{\"value\":\"Empty\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1500,"y":1240,"wires":[[]]},{"id":"2a770d5c5b0126d9","type":"switch","z":"cd7a606d7931c143","name":"","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"REPLY","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":690,"y":1240,"wires":[["d377f9603c40973f"]]},{"id":"035ecb8b05a7849e","type":"ha-wait-until","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"locked","valueType":"str","timeout":"120","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":false,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":1240,"y":1240,"wires":[["92e9992baaede561"],["92e9992baaede561"]]},{"id":"3654de3dfbdb6a8c","type":"debug","z":"cd7a606d7931c143","name":"debug 202","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":890,"y":780,"wires":[]},{"id":"9dfcedb9cabbcf13","type":"api-call-service","z":"cd7a606d7931c143","name":"Save Facecam Ring.jpg For Notification","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.faceshot_go2rtc"],"data":"{\"filename\":\"/config/www/ring.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1000,"y":760,"wires":[[]]},{"id":"2c76e0fbbabb090c","type":"inject","z":"cd7a606d7931c143","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":560,"y":3100,"wires":[["8e6d0b4579baf31a"]]},{"id":"6a37007e21a4e0d1","type":"api-call-service","z":"cd7a606d7931c143","name":"Turn on Door Rang","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.door_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":330,"y":3020,"wires":[["71e0d748146f24f3"]]},{"id":"71e0d748146f24f3","type":"ha-wait-until","z":"cd7a606d7931c143","name":"Wait for door to lock","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"locked","valueType":"str","timeout":"3","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":false,"blockInputOverrides":true,"outputProperties":[],"x":540,"y":3020,"wires":[["84c613ebdb9f54ce"],["84c613ebdb9f54ce"]]},{"id":"f8cff82299310dbf","type":"switch","z":"cd7a606d7931c143","name":"Are there matches?","property":"payload.counts.match","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1590,"y":3180,"wires":[["56d369d20406df30"],["e9d9c66b8213d739"]]},{"id":"84c613ebdb9f54ce","type":"api-call-service","z":"cd7a606d7931c143","name":"Turn off \"Door rang\"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.door_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":760,"y":3020,"wires":[[]]},{"id":"923786bcd627d0aa","type":"change","z":"cd7a606d7931c143","name":"Set msg.match","rules":[{"t":"set","p":"match","pt":"msg","to":"payload.matches[0]","tot":"msg","dc":true},{"t":"set","p":"match.camera","pt":"msg","to":"payload.camera","tot":"msg","dc":true},{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1780,"y":3120,"wires":[["d423506baddd2bd9"]]},{"id":"be28788662f968dd","type":"comment","z":"cd7a606d7931c143","name":"No","info":"","x":1790,"y":3200,"wires":[]},{"id":"4d0f23156408d18c","type":"api-call-service","z":"cd7a606d7931c143","name":"Save Facecam Ring.jpg For Notification","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.faceshot_go2rtc"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":560,"y":3180,"wires":[["9bdbe4a072ec21c8","6fbc1313b7294867"]]},{"id":"8e6d0b4579baf31a","type":"function","z":"cd7a606d7931c143","name":"Name Payload","func":"var random = Date.now();\n\nvar newMsg = {\n    \"payload\": {\n        \"data\": { \"filename\": \"/config/www/\" + random + \".jpg\" }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":300,"y":3180,"wires":[["4d0f23156408d18c"]]},{"id":"9bdbe4a072ec21c8","type":"function","z":"cd7a606d7931c143","name":"Convert path to http path","func":"var path = msg.payload.data.filename;\nvar http_path = path.replace('/config/www/', 'http://192.168.0.14:3000/api/recognize?url=http://192.168.0.15:8123/local/');\n\nvar newMsg = { \n          \"url\": http_path\n        \n};\nreturn newMsg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":870,"y":3180,"wires":[["71efb06c3d520ee0","daceeb7f34803375"]]},{"id":"71efb06c3d520ee0","type":"http request","z":"cd7a606d7931c143","name":"POST request with link to current image on faceshot camera","method":"GET","ret":"obj","paytoqs":"query","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1220,"y":3180,"wires":[["f8cff82299310dbf","b6978e3cb658ead3"]]},{"id":"daceeb7f34803375","type":"debug","z":"cd7a606d7931c143","name":"debug 249","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1071.111083984375,"y":3273.333251953125,"wires":[]},{"id":"a1af7a8ad1fdea77","type":"debug","z":"cd7a606d7931c143","name":"debug 250","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2350,"y":3040,"wires":[]},{"id":"d221db1c2369290c","type":"function","z":"cd7a606d7931c143","name":"JavascriptNotification setter Reolink","func":"var name = \"Someone\";\nvar url1 = \"https://hass.purgatoire.ca/local/reolinkring.jpg\";\nvar url2 = \"https://hass.purgatoire.ca/local/ring.jpg\";\nvar random = Date.now();\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"sticky\": 'true',\n\t\t\t\t\"clickAction\": '/phone-landing/reolink?kiosk=1',\n\t\t\t\t\"priority\": 'high',\n\t\t\t\t\"image\": url1 + \"?\" + random,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Enter Text\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3220,"y":3240,"wires":[["b905934c3421b60e","5ff3fb01d93f2688"]]},{"id":"929ec49d77f1d265","type":"api-call-service","z":"cd7a606d7931c143","name":"Save Reolink.jpg for notif","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.front_door_go2rtc"],"data":"{\"filename\":\"/config/www/reolinkring.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2910,"y":3200,"wires":[["d221db1c2369290c","31df4968113fd2ee","345d1ac027df0ad5"]]},{"id":"31df4968113fd2ee","type":"function","z":"cd7a606d7931c143","name":"Notification setter Facecam","func":"var name = \"Someone\";\nvar url = msg.responseUrl.split('?');\nvar urlfinal = url[1].replace('url=http://192.168.0.15:8123/','https://hass.purgatoire.ca/');\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"sticky\": 'true',\n\t\t\t\t\"clickAction\": '/phone-landing/reolink?kiosk=1',\n\t\t\t\t\"priority\": 'high',\n\t\t\t\t\"image\": urlfinal,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3180,"y":3280,"wires":[["5ff3fb01d93f2688","6a8d0ed87f9ea5f6"]]},{"id":"d423506baddd2bd9","type":"switch","z":"cd7a606d7931c143","name":"confidence over 80%?","property":"match.confidence","propertyType":"msg","rules":[{"t":"gt","v":"80","vt":"num"},{"t":"lt","v":"80","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":2020,"y":3120,"wires":[["11605bc3d4a5768c"],["a3210f29da2f7d89"]]},{"id":"39ab114fdce7d727","type":"comment","z":"cd7a606d7931c143","name":"Yes","info":"","x":1770,"y":3160,"wires":[]},{"id":"bdd1de021e541a9b","type":"comment","z":"cd7a606d7931c143","name":"No","info":"","x":2150,"y":3180,"wires":[]},{"id":"b905934c3421b60e","type":"change","z":"cd7a606d7931c143","name":"Set Data for mass alert","rules":[{"t":"move","p":"payload.data.title","pt":"msg","to":"message","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"},{"t":"set","p":"video","pt":"msg","to":"on","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":3500,"y":3200,"wires":[["46aa8fa7cc1812fe"]]},{"id":"46aa8fa7cc1812fe","type":"subflow:233ac7dcd801a802","z":"cd7a606d7931c143","name":"","x":3730,"y":3200,"wires":[]},{"id":"8245e2c93a5a6520","type":"api-current-state","z":"cd7a606d7931c143","name":"Acid time off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.acid_time","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2510,"y":3100,"wires":[["9e9926dbcd6718c4"],["c942ac776d6cd71f"]]},{"id":"9e9926dbcd6718c4","type":"api-current-state","z":"cd7a606d7931c143","name":"kink off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.kink_party","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":2680,"y":3100,"wires":[["9e9ec75f15412d60","8b8cbeaffef4fdea"],["da73e5a65b916aaa"]]},{"id":"839c614fc03c226c","type":"api-current-state","z":"cd7a606d7931c143","name":"Waiting Friend?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.waiting_someone","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2940,"y":3140,"wires":[["187a0a6344189bac"],["d1d80e74b4721828"]]},{"id":"9e9ec75f15412d60","type":"api-current-state","z":"cd7a606d7931c143","name":"Party on","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.party_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":2840,"y":3060,"wires":[["19ba7309e15502d7"],["839c614fc03c226c"]]},{"id":"379e425db7a8a166","type":"api-current-state","z":"cd7a606d7931c143","name":"Waiting Uber off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.waiting_uber","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":2320,"y":3100,"wires":[["8245e2c93a5a6520"],["749f9097f018277c"]]},{"id":"d86e08495bdfec13","type":"api-current-state","z":"cd7a606d7931c143","name":"Front House Motion","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.motion_front","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":3210,"y":3100,"wires":[["3cb315d24a542bdd","e8b98a63dc614820"],["d1d80e74b4721828"]]},{"id":"197c58d460754e34","type":"debug","z":"cd7a606d7931c143","name":"debug 251","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3750,"y":3060,"wires":[]},{"id":"487566f3cdab151e","type":"comment","z":"cd7a606d7931c143","name":"No","info":"","x":2310,"y":3140,"wires":[]},{"id":"bd09a8281cadc2cf","type":"comment","z":"cd7a606d7931c143","name":"No","info":"","x":2490,"y":3140,"wires":[]},{"id":"cb316946a26bcc8f","type":"comment","z":"cd7a606d7931c143","name":"No","info":"","x":2670,"y":3140,"wires":[]},{"id":"a28e789b76b73501","type":"comment","z":"cd7a606d7931c143","name":"No","info":"","x":3090,"y":3140,"wires":[]},{"id":"3cb315d24a542bdd","type":"function","z":"cd7a606d7931c143","name":"Notif setter","func":"var name = msg.match.name\nvar url1 = \"https://hass.purgatoire.ca/local/reolinkring.jpg\";\nvar url2 = \"https://hass.purgatoire.ca/local/ring.jpg\";\nvar random = Date.now();\nvar cameraused = msg.match.camera;\n\nif (cameraused == \"faceshot_camera\") {\n\tvar usedurl = url2;\n}\nif (cameraused == \"front_door_camera\") {\n\tvar usedurl = url1;\n}\n\n\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Guest Alert\",\n\t\t\t\"title\": name + \" is being let in\",\n\t\t\t\"data\": {\n\t\t\t\t\"sticky\": 'true',\n\t\t\t\t\"clickAction\": '/phone-landing/reolink?kiosk=1',\n\t\t\t\t\"priority\": 'high',\n\t\t\t\t\"image\": usedurl + \"?\" + random,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\"title\": \"Enter Text\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3430,"y":3120,"wires":[["197c58d460754e34","50c0e936582210bc","d08abd3713730c8e"]]},{"id":"50c0e936582210bc","type":"change","z":"cd7a606d7931c143","name":"Set Data for mass alert","rules":[{"t":"move","p":"payload.data.title","pt":"msg","to":"message","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[200,200.0]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"},{"t":"set","p":"video","pt":"msg","to":"on","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":3500,"y":3160,"wires":[["46aa8fa7cc1812fe"]]},{"id":"a58003ac74cf89ee","type":"delay","z":"cd7a606d7931c143","name":"1M/S","pauseType":"queue","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":3030,"y":3080,"wires":[["d86e08495bdfec13"]]},{"id":"b9f4bfaaf3a9a99a","type":"api-call-service","z":"cd7a606d7931c143","name":"unLock Door","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"lock","service":"unlock","areaId":[],"deviceId":[],"entityId":["lock.lock_front_door"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2970,"y":2960,"wires":[["dd81beb95daf3bac","5f28a51d294cc4e3"]]},{"id":"dd81beb95daf3bac","type":"debug","z":"cd7a606d7931c143","name":"unlock","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3110,"y":2920,"wires":[]},{"id":"5f28a51d294cc4e3","type":"ha-wait-until","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"unlocked","valueType":"str","timeout":"2","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":3120,"y":2960,"wires":[["e165660ed48ac3d0"],[]]},{"id":"dda34bae7cf620ec","type":"ha-wait-until","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"locked","valueType":"str","timeout":"30","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":3460,"y":2960,"wires":[["3e60e8997224cfa6"],["3e60e8997224cfa6"]]},{"id":"3e60e8997224cfa6","type":"api-call-service","z":"cd7a606d7931c143","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized","input_boolean.waiting_someone"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3640,"y":2960,"wires":[["c6595ae3eda7a8eb"]]},{"id":"c6595ae3eda7a8eb","type":"api-call-service","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":" {             \"value\": \"UNKNOWN\"         }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3850,"y":2960,"wires":[[]]},{"id":"e8b98a63dc614820","type":"function","z":"cd7a606d7931c143","name":"Name Payload","func":"var name = msg.match.name;\n\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"value\": name\n        }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3320,"y":3020,"wires":[["9ebcbf82e5caf5f3"]]},{"id":"9ebcbf82e5caf5f3","type":"api-call-service","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3520,"y":3020,"wires":[["2f033ae37ad81487"]]},{"id":"e165660ed48ac3d0","type":"api-call-service","z":"cd7a606d7931c143","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3280,"y":2960,"wires":[["dda34bae7cf620ec"]]},{"id":"2f033ae37ad81487","type":"trigger","z":"cd7a606d7931c143","name":"","op1":"1","op2":"","op1type":"str","op2type":"nul","duration":"250","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":3040,"y":3020,"wires":[["b9f4bfaaf3a9a99a"]]},{"id":"57143d0acb9869ee","type":"comment","z":"cd7a606d7931c143","name":"No","info":"","x":2850,"y":3100,"wires":[]},{"id":"d08abd3713730c8e","type":"api-call-service","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_fold4","areaId":[],"deviceId":[],"entityId":[],"data":"{\"message\":\"Bedroom door open\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3770,"y":3120,"wires":[[]]},{"id":"5ff3fb01d93f2688","type":"api-call-service","z":"cd7a606d7931c143","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_fold4","areaId":[],"deviceId":[],"entityId":[],"data":"{\"message\":\"Bedroom door open\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3530,"y":3280,"wires":[[]]},{"id":"7e7da62b1bae7963","type":"function","z":"cd7a606d7931c143","name":"Javascript","func":"var d = new Date();\nvar name = msg.payload.name;\nvar m = d.getMilliseconds();\nvar snapshot = msg.payload.data.filename;\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\" + m;\n\nvar snapshot = snapshot.replace(\"\\/config\\/www\",\"https:\\/\\/hass.purgatoire.ca\\/local\");\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"image\": snapshot,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2720,"y":3360,"wires":[[]]},{"id":"6a8d0ed87f9ea5f6","type":"debug","z":"cd7a606d7931c143","name":"debug 252","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3410,"y":3340,"wires":[]},{"id":"345d1ac027df0ad5","type":"debug","z":"cd7a606d7931c143","name":"debug 253","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3150,"y":3180,"wires":[]},{"id":"dcce339bc693f919","type":"inject","z":"cd7a606d7931c143","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"event_type","v":"mobile_app_notification_action","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"mobile_app_notification_action","payload":"{\"event_type\":\"mobile_app_notification_action\",\"event\":{\"action_2_title\":\"Unlock The Door\",\"sticky\":\"true\",\"image\":\"https://hass.purgatoire.ca/local/1682889557657.jpg\",\"title\":\"Someone is at the door\",\"webhook_id\":\"dc5b17a37680a99a6d5a4bec876571290bc9540b3eb9cdcb19aa3f9b40d898ab\",\"clickAction\":\"/phone-landing/reolink?kiosk=1\",\"message\":\"Doorbell Alert\",\"action_1_title\":\"Who is this?\",\"action_1_key\":\"REPLY\",\"action_2_key\":\"unlock_door\",\"server_id\":\"2\",\"reply_text\":\"Maxi\",\"action\":\"REPLY\",\"device_id\":\"abe9267b23414bbb\"},\"origin\":\"REMOTE\",\"time_fired\":\"2023-04-30T21:25:08.972910+00:00\",\"context\":{\"id\":\"01GZA0W8QC3AG77H5AHK50AE15\",\"parent_id\":null,\"user_id\":\"7f1de31122574f6fa2215e519d6083ea\"}}","payloadType":"json","x":930,"y":2640,"wires":[["315f5569a3cd1e1f","df207d122707860f"]]},{"id":"f0ec839492a6cc22","type":"exec","z":"cd7a606d7931c143","command":"","addpay":"command","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"Command wget ","x":1660,"y":2700,"wires":[["4d1544ef1ac3d09e","66870ae54d415f31"],[],[]]},{"id":"3342da11fe49855e","type":"function","z":"cd7a606d7931c143","name":"Javascript","func":"var image = msg.payload.event.image;\nvar name = msg.payload.event.reply_text;\nvar newMsg = {\n    \"command\": \"mkdir \" + \"/config/www/doubletake/\" + name + \";wget \" + image  + \" -P /config/www/doubletake/\" + name,\n    \"data\": msg.payload\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1480,"y":2700,"wires":[["f6222dfaaa9dc9b0","f0ec839492a6cc22"]]},{"id":"f6222dfaaa9dc9b0","type":"debug","z":"cd7a606d7931c143","name":"actionable","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1550,"y":2760,"wires":[]},{"id":"4d1544ef1ac3d09e","type":"debug","z":"cd7a606d7931c143","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1730.9090576171875,"y":2636.363525390625,"wires":[]},{"id":"c8a2221e9878688b","type":"debug","z":"cd7a606d7931c143","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2070,"y":2660,"wires":[]},{"id":"1f14ea34c73aed0f","type":"debug","z":"cd7a606d7931c143","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2290,"y":2640,"wires":[]},{"id":"1832a1b9f4db63f9","type":"debug","z":"cd7a606d7931c143","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2750,"y":2560,"wires":[]},{"id":"9bdca88a7d4fd421","type":"server-state-changed","z":"cd7a606d7931c143","name":"Doorbell","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.remote_doorbell_button_action","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"single","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":100,"y":3180,"wires":[["6a37007e21a4e0d1","8e6d0b4579baf31a","8d277ccd6bea87cf"],[]]},{"id":"8d277ccd6bea87cf","type":"debug","z":"cd7a606d7931c143","name":"debug 254","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":290,"y":3120,"wires":[]},{"id":"b6978e3cb658ead3","type":"debug","z":"cd7a606d7931c143","name":"debug 255","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1410,"y":3320,"wires":[]},{"id":"6fbc1313b7294867","type":"debug","z":"cd7a606d7931c143","name":"debug 256","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":790,"y":3300,"wires":[]},{"id":"7c6da2fd4be43b11","type":"debug","z":"cd7a606d7931c143","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2510,"y":2640,"wires":[]},{"id":"f81f9066c3642e33","type":"switch","z":"dc434684164184f3","name":"click","property":"payload.event.command","propertyType":"msg","rules":[{"t":"regex","v":"(click)","vt":"str","case":true}],"checkall":"true","repair":false,"outputs":1,"x":250,"y":840,"wires":[["e454c3be539b6285","d56d0261de5b568d"]]},{"id":"d0439c4b4704092f","type":"server-events","z":"dc434684164184f3","name":"Ringer","server":"7ab5c227.a3ce8c","version":2,"eventType":"zha_event","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":110,"y":840,"wires":[["f81f9066c3642e33"]]},{"id":"fcbc2284bd9e9322","type":"trigger","z":"dc434684164184f3","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"45","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":590,"y":840,"wires":[["73d5a5506a43fcd1","615613db29724c87","e919893a9841580a"]]},{"id":"73d5a5506a43fcd1","type":"trigger","z":"dc434684164184f3","name":"Snapshots","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":790,"y":860,"wires":[["7c8ab89cab1b4956","d49d22ab07c3d2ee"]]},{"id":"10758c426a0858aa","type":"inject","z":"dc434684164184f3","name":"scan","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payloadType":"date","x":2130,"y":600,"wires":[["9360acda1b161468","d49d22ab07c3d2ee"]]},{"id":"4185710a31385ab9","type":"switch","z":"dc434684164184f3","name":"Recod Faces 1/0","property":"payload.recognized","propertyType":"msg","rules":[{"t":"eq","v":"1","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":1990,"y":820,"wires":[["b4835ffffced14cd"],["2830e93ceb0cef1f"]]},{"id":"ca373eccc666f38c","type":"api-current-state","z":"dc434684164184f3","name":"party on?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.party_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2420,"y":800,"wires":[["89af71618b9c0faa"],["040c177eb917a566"]]},{"id":"d111259afef6d892","type":"change","z":"dc434684164184f3","name":"reset","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":3370,"y":800,"wires":[["c8843b8ac78ff90b"]]},{"id":"a9bdbe5fe49d2b6e","type":"function","z":"dc434684164184f3","name":"Name Payload","func":"var name = msg.payload.name;\n\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"value\": name\n        }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3440,"y":960,"wires":[["7a162e600a9e97be"]]},{"id":"040c177eb917a566","type":"api-current-state","z":"dc434684164184f3","name":"Waiting Friend?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.waiting_someone","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2460,"y":840,"wires":[["89af71618b9c0faa"],["06d4b8e6ac09e9b5"]]},{"id":"c8843b8ac78ff90b","type":"function","z":"dc434684164184f3","name":"Set Path","func":"var d = new Date();\nvar m = d.getMilliseconds();\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\"+m;\nvar newMsg = \n\n{ \n    \"payload\": {\n                data: {\n    \"media_content_id\": url,\n    \"media_content_type\": \"image/jpg\"\n                      }\n                }         \n};\nreturn newMsg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3500,"y":800,"wires":[["bc521ef8b67af4c3"]]},{"id":"7a162e600a9e97be","type":"api-call-service","z":"dc434684164184f3","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3670,"y":960,"wires":[[]]},{"id":"b499a1d86fc0a256","type":"api-call-service","z":"dc434684164184f3","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3900,"y":840,"wires":[["c8765eb38fe5e2eb"]]},{"id":"bc521ef8b67af4c3","type":"subflow:eb3b6592c8406c0d","z":"dc434684164184f3","name":"","env":[],"x":3730,"y":780,"wires":[]},{"id":"c8765eb38fe5e2eb","type":"ha-wait-until","z":"dc434684164184f3","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"binary_sensor.door_front_outside","entityIdFilterType":"exact","property":"state","comparator":"is","value":"on","valueType":"str","timeout":"30","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":4080,"y":820,"wires":[["6a1b71bb3d5da029"],["6a1b71bb3d5da029"]]},{"id":"6a1b71bb3d5da029","type":"api-call-service","z":"dc434684164184f3","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.waiting_someone"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4320,"y":800,"wires":[["54512cfe53d49af7"]]},{"id":"54512cfe53d49af7","type":"api-call-service","z":"dc434684164184f3","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4480,"y":860,"wires":[["02440b086a01d79d"]]},{"id":"02440b086a01d79d","type":"function","z":"dc434684164184f3","name":"Name Payload","func":"var newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"value\": \"UNKNOWN\"\n        }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4620,"y":800,"wires":[["fd73e469e2a05453"]]},{"id":"fd73e469e2a05453","type":"api-call-service","z":"dc434684164184f3","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4830,"y":800,"wires":[[]]},{"id":"cc7516bbde4f135b","type":"debug","z":"dc434684164184f3","name":"Compare","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1900,"y":660,"wires":[]},{"id":"e2e0e39a2bb3932e","type":"debug","z":"dc434684164184f3","name":"unlock","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3810,"y":900,"wires":[]},{"id":"aa27da83f6d208af","type":"function","z":"dc434684164184f3","name":"Set Path","func":"var d = new Date();\nvar m = d.getMilliseconds();\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\"+m;\nvar newMsg = \n\n{ \n    \"payload\": {\n                data: {\n    \"media_content_id\": url,\n    \"media_content_type\": \"image/jpg\"\n                      }\n                }         \n};\nreturn newMsg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2720,"y":880,"wires":[["67210b69f6801374"]]},{"id":"67210b69f6801374","type":"subflow:eb3b6592c8406c0d","z":"dc434684164184f3","name":"","env":[],"x":2890,"y":880,"wires":[]},{"id":"06d4b8e6ac09e9b5","type":"trigger","z":"dc434684164184f3","name":"Not waiting","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2550,"y":900,"wires":[["aa27da83f6d208af","32fd5b7cc87fce18"]]},{"id":"aa4d207fc89018f6","type":"change","z":"dc434684164184f3","name":"reset","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1950,"y":1520,"wires":[["f9c54cc9d58ea2ce","1f05f8606cdaa521","59c279e0d389e66e","12161e79cce07bcd"]]},{"id":"f9c54cc9d58ea2ce","type":"function","z":"dc434684164184f3","name":"Set Path","func":"var d = new Date();\nvar m = d.getMilliseconds();\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\"+m;\nvar newMsg = \n\n{ \n    \"payload\": {\n                data: {\n    \"media_content_id\": url,\n    \"media_content_type\": \"image/jpg\"\n                      }\n                }         \n};\nreturn newMsg;\n\n","outputs":1,"noerr":0,"x":2200,"y":1520,"wires":[["b5b3990469a88f46"]]},{"id":"1f05f8606cdaa521","type":"function","z":"dc434684164184f3","name":"Javascript","func":"var recoface = [];\nvar facestring = \"\"\nvar d = new Date();\nvar m = d.getMilliseconds();\nvar url = \"https://hass.purgatoire.ca/local/ring.jpg?\" + m;\nvar facestring = msg.payload;\n\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n  \"message\": \"Someone is at the door\",\n  \"data\": {\n    \"image\": url,\n    \"actions\": [\n      {\n        \"action\": \"unlock_door\",\n        \"title\": \"Unlock The Door\"\n      }\n                \n    ]\n  }\n}\n }\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2200,"y":1480,"wires":[["b985406500241595"]]},{"id":"b5b3990469a88f46","type":"subflow:eb3b6592c8406c0d","z":"dc434684164184f3","name":"","env":[],"x":2370,"y":1520,"wires":[]},{"id":"b985406500241595","type":"api-call-service","z":"dc434684164184f3","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2380,"y":1480,"wires":[[]]},{"id":"a24b5102df8c3ebf","type":"trigger","z":"dc434684164184f3","name":"Crash","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2010,"y":1380,"wires":[["aa4d207fc89018f6"]]},{"id":"59c279e0d389e66e","type":"change","z":"dc434684164184f3","name":"Set Data for mass alert","rules":[{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"},{"t":"set","p":"message","pt":"msg","to":"Someone is at the door","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2240,"y":1560,"wires":[["2185ba65d3b32ccb"]]},{"id":"2185ba65d3b32ccb","type":"link out","z":"dc434684164184f3","name":"Light and Speakers","links":["45904ca6429d867d","ad88dbd2.4726b8","3405e943.fd3ee6","9cf42cf7ef60f645"],"x":2375,"y":1560,"wires":[]},{"id":"faa50083e3ae1f1f","type":"catch","z":"dc434684164184f3","name":"","scope":["9f56048afecabe35"],"uncaught":false,"x":1810,"y":880,"wires":[["a24b5102df8c3ebf"]]},{"id":"b3c65ffba062ab08","type":"function","z":"dc434684164184f3","name":"Javascript","func":"var d = new Date();\nvar m = d.getMilliseconds();\nvar url = msg.image;\n\nvar url = url.replace(\"https:\\/\\/hass.purgatoire.ca\\/local\", \"\\/config\\/www\");\n\nvar newMsg = {\n \"name\": msg.payload.name,\n \"url\": \"http://192.168.0.14:3000/api/train/retrain/\" + msg.payload.name.toLowerCase(),\n \"data\":{\n    \"data\":{\n\t\"file_path\": url,\n\t\"name\": msg.payload.name.toLowerCase(),\n\t\"url\": \"http://192.168.0.14:3000/api/train/retrain/\" + msg.payload.name.toLowerCase()\n}}\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2480,"y":420,"wires":[["2487eb56be4a95b3","1837bd252cf0b8b2"]]},{"id":"efcc0d26c6fb51c0","type":"server-events","z":"dc434684164184f3","name":"","server":"7ab5c227.a3ce8c","version":2,"eventType":"mobile_app_notification_action","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":1710,"y":400,"wires":[["fac725887b00c8f5","bf36421868181d87"]]},{"id":"2487eb56be4a95b3","type":"debug","z":"dc434684164184f3","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2750,"y":340,"wires":[]},{"id":"3e6de3c6f5cb0f17","type":"function","z":"dc434684164184f3","name":"Javascript","func":"var d = new Date();\nvar m = d.getMilliseconds();\nvar url = msg.data.data.file_path;\n\n\nvar snapshot = url.replace(\"\\/config\\/www\",\"https:\\/\\/hass.purgatoire.ca\\/local\");\n\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n  \"message\": \"Faces learning for\" + \" \" + msg.name,\n  \"data\": {\n    \"image\": snapshot\n  }\n}\n }\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2960,"y":420,"wires":[["e5cd95667df3b1f2","757cc328cc541338"]]},{"id":"e5cd95667df3b1f2","type":"api-call-service","z":"dc434684164184f3","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3180,"y":420,"wires":[["757cc328cc541338"]]},{"id":"87caa448533c8d9b","type":"api-call-service","z":"dc434684164184f3","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.front_door"],"data":"{\"filename\":\"/config/www/reolink.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":740,"y":500,"wires":[[]]},{"id":"ecb63bd121dd5c2d","type":"ha-wait-until","z":"dc434684164184f3","name":"wait until facecam detect someone","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"sensor.facecam_persons","entityIdFilterType":"exact","property":"state","comparator":"gt","value":"0","valueType":"num","timeout":"30","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":380,"y":740,"wires":[[],[]]},{"id":"d76b686b96f8befd","type":"trigger","z":"dc434684164184f3","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"2","extend":false,"overrideDelay":false,"units":"min","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":510,"y":540,"wires":[["ecb63bd121dd5c2d","87caa448533c8d9b"]]},{"id":"59219d6d3e694135","type":"server-state-changed","z":"dc434684164184f3","name":"frigate reolink over 0","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.front_persons","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"0","halt_if_type":"num","halt_if_compare":"gt","output_only_on_state_change":true,"x":90,"y":540,"wires":[[],[]]},{"id":"9ddf5ca3edccdd85","type":"change","z":"dc434684164184f3","name":"","rules":[{"t":"set","p":"reset","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":440,"y":580,"wires":[["d76b686b96f8befd"]]},{"id":"e65cd0635908707b","type":"trigger","z":"dc434684164184f3","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"units":"min","reset":"","bytopic":"all","outputs":1,"x":270,"y":580,"wires":[["9ddf5ca3edccdd85"]]},{"id":"e454c3be539b6285","type":"debug","z":"dc434684164184f3","name":"click","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":90,"y":720,"wires":[]},{"id":"c1c0010cdeca663b","type":"inject","z":"dc434684164184f3","name":"scan","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payloadType":"date","x":3470,"y":1060,"wires":[["869e08ac92dc847d"]]},{"id":"615613db29724c87","type":"api-call-service","z":"dc434684164184f3","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.door_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":880,"y":1020,"wires":[["9e34afd93f69bbba"]]},{"id":"e919893a9841580a","type":"switch","z":"dc434684164184f3","name":"double","property":"payload.event.args.click_type","propertyType":"msg","rules":[{"t":"cont","v":"double","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":710,"y":1080,"wires":[["051eaa0a3bc81fd8"]]},{"id":"9e34afd93f69bbba","type":"trigger","z":"dc434684164184f3","name":"","op1":"","op2":"1","op1type":"nul","op2type":"num","duration":"1","extend":false,"units":"min","reset":"","bytopic":"all","outputs":1,"x":1190,"y":1020,"wires":[["f9a2017b6a2a8e68"]]},{"id":"051eaa0a3bc81fd8","type":"api-current-state","z":"dc434684164184f3","name":"rang?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.door_rang","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":850,"y":1080,"wires":[["135a89df5af43c6b"],[]]},{"id":"f9a2017b6a2a8e68","type":"api-call-service","z":"dc434684164184f3","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.door_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1400,"y":1020,"wires":[[]]},{"id":"135a89df5af43c6b","type":"api-call-service","z":"dc434684164184f3","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.door_double_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1020,"y":1080,"wires":[["30759e3e74abfcbc"]]},{"id":"30759e3e74abfcbc","type":"trigger","z":"dc434684164184f3","name":"","op1":"","op2":"1","op1type":"nul","op2type":"num","duration":"1","extend":false,"units":"min","reset":"","bytopic":"all","outputs":1,"x":1190,"y":1080,"wires":[["b43c21109dfa88c6"]]},{"id":"b43c21109dfa88c6","type":"api-call-service","z":"dc434684164184f3","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.door_double_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1400,"y":1080,"wires":[[]]},{"id":"8c06e0a3aebde655","type":"function","z":"dc434684164184f3","name":"Javascript","func":"var d = new Date();\nvar h = d.getHours();\nvar m = d.getMinutes();\nvar s = d.getSeconds();\nvar camera = msg.payload.camera;\nvar confidence = 0;\n\nif (typeof msg.payload.confidence !==\"undefined\"){\nvar confidence = msg.payload.confidence;\n}\n\nvar who = \"Unknown\";\nif (typeof msg.payload.name !==\"undefined\"){\nvar who = msg.payload.name;\n}\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n        \"name\": who,\n        \"data\": {\n            \"filename\":\"/config/www/portraits/\" + who + \"/\" + who + \"-\" + camera + \"-\" + h + m + s + \"-\" + confidence + \".jpg\",\n            \"entity_id\": camera\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3340,"y":680,"wires":[["1c4f42af07633df5"]]},{"id":"1c4f42af07633df5","type":"api-call-service","z":"dc434684164184f3","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":3520,"y":680,"wires":[["609158bb18808aa9","7b8fce8d5b789dee"]]},{"id":"609158bb18808aa9","type":"debug","z":"dc434684164184f3","name":"result of snapchot","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3770,"y":560,"wires":[]},{"id":"79fc99ef6e3fe4e8","type":"api-call-service","z":"dc434684164184f3","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3880,"y":680,"wires":[[]]},{"id":"7b8fce8d5b789dee","type":"function","z":"dc434684164184f3","name":"Javascript","func":"var d = new Date();\nvar name = msg.payload.name;\nvar m = d.getMilliseconds();\nvar snapshot = msg.payload.data.filename;\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\" + m;\n\nvar snapshot = snapshot.replace(\"\\/config\\/www\",\"https:\\/\\/hass.purgatoire.ca\\/local\");\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": \"Welcoming \" + name,\n\t\t\t\"data\": {\n\t\t\t\t\"image\": snapshot,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3700,"y":680,"wires":[["79fc99ef6e3fe4e8","417d9ddbc2aedfbd","4417fff8bb8b1560"]]},{"id":"417d9ddbc2aedfbd","type":"change","z":"dc434684164184f3","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"payload.data.title","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":3880,"y":720,"wires":[["9790cd5589899bc8"]]},{"id":"daa9cae4d006c055","type":"debug","z":"dc434684164184f3","name":"actionable","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2250,"y":400,"wires":[]},{"id":"4417fff8bb8b1560","type":"debug","z":"dc434684164184f3","name":"result before notif","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4028.571533203125,"y":625.7142944335938,"wires":[]},{"id":"2cf12fb174beb029","type":"debug","z":"dc434684164184f3","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2995.71435546875,"y":332.8571472167969,"wires":[]},{"id":"9790cd5589899bc8","type":"link out","z":"dc434684164184f3","name":"Light and Speakers","links":["45904ca6429d867d","ad88dbd2.4726b8","3405e943.fd3ee6","9cf42cf7ef60f645"],"x":4015,"y":720,"wires":[]},{"id":"757cc328cc541338","type":"debug","z":"dc434684164184f3","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3510,"y":380,"wires":[]},{"id":"37a8bfd412e08e5e","type":"inject","z":"dc434684164184f3","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payloadType":"date","x":560,"y":460,"wires":[["87caa448533c8d9b"]]},{"id":"12161e79cce07bcd","type":"debug","z":"dc434684164184f3","name":"result before notif","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2190,"y":1420,"wires":[]},{"id":"b4835ffffced14cd","type":"switch","z":"dc434684164184f3","name":"","property":"payload.name","propertyType":"msg","rules":[{"t":"nempty"}],"checkall":"false","repair":false,"outputs":1,"x":2150,"y":800,"wires":[["da2860a614a49ff1"]]},{"id":"d49d22ab07c3d2ee","type":"http request","z":"dc434684164184f3","name":"POST request","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://192.168.0.14:3000/api/recognize?url=http://192.168.0.15:8123/local/reolink.jpg&camera=camera.front_door","tls":"","persist":false,"proxy":"","authType":"","x":1100,"y":780,"wires":[["f185509b6fd7311d"]]},{"id":"f185509b6fd7311d","type":"json","z":"dc434684164184f3","name":"toJson","property":"payload","action":"","pretty":true,"x":1250,"y":780,"wires":[["f21d613ea08e3590","7446c1cb0213acde"]]},{"id":"9360acda1b161468","type":"http request","z":"dc434684164184f3","name":"POST request","method":"GET","ret":"txt","paytoqs":"ignore","url":"http://192.168.0.14:3000/api/recognize?url=http://192.168.0.15:8123/local/ring.jpg&camera=camera.facecam","tls":"","persist":false,"proxy":"","authType":"","senderr":false,"headers":[],"x":1120,"y":880,"wires":[["0f1586ce7c4017e7"]]},{"id":"7c8ab89cab1b4956","type":"api-call-service","z":"dc434684164184f3","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.facecam"],"data":"{\"filename\":\"/config/www/ring.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":940,"y":880,"wires":[["9360acda1b161468"]]},{"id":"3a1df7f09ea211e4","type":"join","z":"dc434684164184f3","name":"","mode":"custom","build":"array","property":"payload.matches","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"5","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"num","reduceFixup":"","x":1550,"y":820,"wires":[["9f56048afecabe35","ce41bc07cb1f5ec0"]]},{"id":"0f1586ce7c4017e7","type":"json","z":"dc434684164184f3","name":"toJson","property":"payload","action":"","pretty":true,"x":1270,"y":880,"wires":[["104f147483ea4de5","aa08583877f8a98d"]]},{"id":"9f56048afecabe35","type":"function","z":"dc434684164184f3","name":"Face Extractor compare 5.1","func":"// SETTINGS\nvar required_conf = 80;\n// SETTINGS\n\n\nvar recoface = new Object();\nvar recofacesortable = [];\nvar name = \"\";\nvar camera = \"\";\nvar conf = \"\";\nvar reconame = \"\";\nvar confidence = \"\";\nvar reco = \"\";\n//declarations\n\n    for (i = 0; i < msg.payload.matches.length; i++){\n         for (y = 0; y < Object.keys(msg.payload.matches[i]).length; y++){\n                var name = msg.payload.matches[i][y][0];\n \t\t\t\tvar conf = msg.payload.matches[i][y][1];\n \t\t\t\tvar camera = msg.payload.matches[i][y][2];\n \t\t\t// \tif (conf > 0){\n \t\t\t\t    recofacesortable.push([name, conf, camera]);\n \t\t\t// \t}\n \t\t\t\t\n        }\n    }\n    \n    \n     \trecofacesortable.sort(function(a, b) {\n \t\treturn a[1] - b[1];\n \t}).reverse();\n \t\n    for (i = 0; i < recofacesortable.length; i++){\n        var reconame = recofacesortable[0][0];\n        var confidence = recofacesortable[0][1]\n        var camera = recofacesortable[0][2]\n        \n        \n    }\n\n\n\nif (confidence > required_conf) {\n\tvar recognized = 1;\n} else {\n\tvar recognized = 0;\n}\n\n if (camera == \"camera.front_door\"){\n     var camera = \"camera.reolink_static\";\n } else if (camera == \"camera.facecam\"){\n     var camera = \"camera.facecam_static\"\n }\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"name\": reconame,\n\t\t\"confidence\": confidence,\n\t//\t\"matched_faces\": total_matched_faces,\n\t//\t\"total_faces\": total_faces,\n\t\t\"recognized\": recognized,\n \t\t\"camera\": camera \n\t}\n};\n\nreturn newMsg;\n\n\n//  var test = {\n//  \t\"payload\": {\n// \t\t\"name\": reconame,\n// \t\t\"confidence\": confidence,\n// \t\t\"matched_faces\": total_matched_faces,\n// \t\t\"total_faces\": total_faces,\n// \t\t\"recognized\": recognized,\n// \t\t\"camera\": camera ,\n// \t\t\"recofacesortable\": recofacesortable\n//  \t}\n//  };\n//  return test;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1760,"y":820,"wires":[["4185710a31385ab9","cc7516bbde4f135b"]]},{"id":"7446c1cb0213acde","type":"debug","z":"dc434684164184f3","name":"post1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1390,"y":700,"wires":[]},{"id":"aa08583877f8a98d","type":"debug","z":"dc434684164184f3","name":"post2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1510,"y":920,"wires":[]},{"id":"ce41bc07cb1f5ec0","type":"debug","z":"dc434684164184f3","name":"tojson","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1570,"y":740,"wires":[]},{"id":"3fa7103aee25b943","type":"inject","z":"dc434684164184f3","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":1820,"y":1040,"wires":[["73d5a5506a43fcd1"]]},{"id":"f21d613ea08e3590","type":"function","z":"dc434684164184f3","name":"cam set","func":"// SETTINGS\nvar required_conf = 75;\n// SETTINGS\n\n\nvar recoface = new Object();\nvar recofacesortable = [];\nvar name = \"\";\nvar camera = \"camera.front_door\";\nvar conf = \"\";\nvar reconame = \"\";\nvar confidence = \"\";\nvar reco = \"\";\n//declarations\n\n    for (i = 0; i < msg.payload.matches.length; i++){\n\n                var name = msg.payload.matches[i].name;\n \t\t\t\tvar conf = msg.payload.matches[i].confidence;\n \t\t\t// \tif (conf > 0){\n \t\t\t\t    recofacesortable.push([name, conf, camera]);\n \t\t\t// \t}\n \t\t\t\t\n        \n    }\n\nif (typeof msg.payload.unknown!==\"undefined\"){\n    recofacesortable.push([\"Unknown\", \"0\", camera]);\n}\n    \n    \n//      \trecofacesortable.sort(function(a, b) {\n//  \t\treturn a[1] - b[1];\n//  \t}).reverse();\n \t\n//     for (i = 0; i < recofacesortable.length; i++){\n//         var reconame = recofacesortable[0][0];\n//         var confidence = recofacesortable[0][1]\n//         var camera = recofacesortable[0][2]\n        \n        \n//     }\n\n\n\n// if (confidence > required_conf) {\n// \tvar recognized = 1;\n// } else {\n// \tvar recognized = 0;\n// }\n\n// if (camera == \"face_counter_reolink\"){\n//     var camera = \"camera.reolink_static\";\n// } else if (camera == \"face_counter_facecam\"){\n//     var camera = \"camera.facecam_static\"\n// }\n\n// var newMsg = {\n// \t\"payload\": {\n// \t\t\"name\": reconame,\n// \t\t\"confidence\": confidence,\n// \t\t\"recognized\": recognized,\n//  \t\t\"camera\": camera \n// \t}\n// };\n\n//return newMsg;\n\n\n  var test = {\n   \t\"payload\":  {\n\t\t\"matches\": recofacesortable,\n// //  \t\t\"confidence\": confidence,\n// //  \t\t\"recognized\": recognized,\n// //  \t\t\"camera\": camera ,\n// //  \t\t\"recofacesortable\": recofacesortable\n   \t}\n  };\n  return test;","outputs":1,"noerr":7,"initialize":"","finalize":"","libs":[],"x":1400,"y":800,"wires":[["3a1df7f09ea211e4","7446c1cb0213acde"]]},{"id":"104f147483ea4de5","type":"function","z":"dc434684164184f3","name":"cam set","func":"// SETTINGS\nvar required_conf = 75;\n// SETTINGS\n\n\nvar recoface = new Object();\nvar recofacesortable = [];\nvar name = \"\";\nvar camera = \"camera.facecam\";\nvar conf = \"\";\nvar reconame = \"\";\nvar confidence = \"\";\nvar reco = \"\";\n//declarations\n\n    for (i = 0; i < msg.payload.matches.length; i++){\n\n                var name = msg.payload.matches[i].name;\n \t\t\t\tvar conf = msg.payload.matches[i].confidence;\n \t\t\t// \tif (conf > 0){\n \t\t\t\t    recofacesortable.push([name, conf, camera]);\n \t\t\t// \t}\n \t\t\t\t\n        \n    }\n\nif (typeof msg.payload.unknown!==\"undefined\"){\n    recofacesortable.push([\"Unknown\", \"0\", camera]);\n}\n    \n    \n//      \trecofacesortable.sort(function(a, b) {\n//  \t\treturn a[1] - b[1];\n//  \t}).reverse();\n \t\n//     for (i = 0; i < recofacesortable.length; i++){\n//         var reconame = recofacesortable[0][0];\n//         var confidence = recofacesortable[0][1]\n//         var camera = recofacesortable[0][2]\n        \n        \n//     }\n\n\n\n// if (confidence > required_conf) {\n// \tvar recognized = 1;\n// } else {\n// \tvar recognized = 0;\n// }\n\n// if (camera == \"face_counter_reolink\"){\n//     var camera = \"camera.reolink_static\";\n// } else if (camera == \"face_counter_facecam\"){\n//     var camera = \"camera.facecam_static\"\n// }\n\n// var newMsg = {\n// \t\"payload\": {\n// \t\t\"name\": reconame,\n// \t\t\"confidence\": confidence,\n// \t\t\"recognized\": recognized,\n//  \t\t\"camera\": camera \n// \t}\n// };\n\n//return newMsg;\n\n\n  var test = {\n   \t\"payload\":  {\n\t\t\"matches\": recofacesortable,\n// //  \t\t\"confidence\": confidence,\n// //  \t\t\"recognized\": recognized,\n// //  \t\t\"camera\": camera ,\n// //  \t\t\"recofacesortable\": recofacesortable\n   \t}\n  };\n  return test;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1400,"y":840,"wires":[["3a1df7f09ea211e4","aa08583877f8a98d"]]},{"id":"fac725887b00c8f5","type":"debug","z":"dc434684164184f3","name":"actionable","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2210,"y":280,"wires":[]},{"id":"1837bd252cf0b8b2","type":"http request","z":"dc434684164184f3","name":"POST request","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","authType":"","x":2700,"y":420,"wires":[["2cf12fb174beb029","3e6de3c6f5cb0f17"]]},{"id":"2620e3257d6fa84d","type":"function","z":"dc434684164184f3","name":"Javascript","func":"var d = new Date();\nvar h = d.getHours();\nvar m = d.getMinutes();\nvar s = d.getSeconds();\nvar camera = msg.payload.camera;\nvar confidence = 0;\n\nif (typeof msg.payload.confidence !==\"undefined\"){\nvar confidence = msg.payload.confidence;\n}\n\n\nvar who = msg.payload.name;\n\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n        \"name\": who,\n        \"data\": {\n            \"filename\":\"/config/double-take/\" + who.toLowerCase() +  \"/\" + who + \"_\" + camera + \"_\" + h + m + s + \"_\" + confidence + \".jpg\",\n            \"entity_id\": camera\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3340,"y":640,"wires":[["d21500d7b53cd67a"]]},{"id":"d21500d7b53cd67a","type":"api-call-service","z":"dc434684164184f3","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":3520,"y":640,"wires":[[]]},{"id":"ac6262324beb2749","type":"function","z":"dc434684164184f3","name":"Javascript","func":"var d = new Date();\nvar h = d.getHours();\nvar m = d.getMinutes();\nvar s = d.getSeconds();\n\nvar confidence = 0;\nif (typeof msg.payload.confidence !==\"undefined\"){\nvar confidence = msg.payload.confidence;\n}\n\n\nvar who = msg.payload.event.reply_text.toLowerCase().replace(\" \",\"\");\nvar replacestring = \"https://hass.purgatoire.ca/local/portraits/\" + who.toLowerCase();\nvar replacestring1 = msg.payload.event.image.replace(replacestring);\nvar replacestring2 = replacestring1.split(\"-\");\nvar camera = replacestring2[1];\n\n\n\n\nvar newMsg = {\n    \"image\": msg.payload.event.image,\n    \"payload\": {\n        \"name\": who,\n        \"data\": {\n            \"filename\":\"/config/double-take/\" + who +  \"/\" + camera + \"_\" + h + m + s + \"_\" + confidence + \".jpg\",\n            \"entity_id\": camera,\n            // \"1\": replacestring,\n            // \"2\": replacestring1,\n            // \"3\": replacestring2\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2060,"y":520,"wires":[["daa9cae4d006c055","febfacf98e14230f"]]},{"id":"914d208ac8e90c6b","type":"api-call-service","z":"dc434684164184f3","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2440,"y":520,"wires":[["a55fc2865d50ea0f","b3c65ffba062ab08"]]},{"id":"a55fc2865d50ea0f","type":"debug","z":"dc434684164184f3","name":"result of snapchot","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2610,"y":540,"wires":[]},{"id":"32fd5b7cc87fce18","type":"function","z":"dc434684164184f3","name":"Javascript","func":"var d = new Date();\nvar h = d.getHours();\nvar m = d.getMinutes();\nvar s = d.getSeconds();\nvar camera = msg.payload.camera;\nvar confidence = 0;\n\nif (typeof msg.payload.confidence !==\"undefined\"){\nvar confidence = msg.payload.confidence;\n}\n\nvar who = \"Unknown\";\nif (typeof msg.payload.name !==\"undefined\"){\nvar who = msg.payload.name;\n}\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n        \"name\": who,\n        \"data\": {\n            \"filename\":\"/config/www/portraits/\" + who + \"/\" + who + \"-\" + camera + \"-\" + h + m + s + \"-\" + confidence + \".jpg\",\n            \"entity_id\": camera\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2720,"y":920,"wires":[["777be68bc82d9798"]]},{"id":"777be68bc82d9798","type":"api-call-service","z":"dc434684164184f3","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2900,"y":920,"wires":[["a92451862222ae6a"]]},{"id":"11ade2d568b39f66","type":"api-call-service","z":"dc434684164184f3","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3260,"y":920,"wires":[[]]},{"id":"a92451862222ae6a","type":"function","z":"dc434684164184f3","name":"Javascript","func":"var d = new Date();\nvar name = msg.payload.name;\nvar m = d.getMilliseconds();\nvar snapshot = msg.payload.data.filename;\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\" + m;\n\nvar snapshot = snapshot.replace(\"\\/config\\/www\",\"https:\\/\\/hass.purgatoire.ca\\/local\");\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"image\": snapshot,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3080,"y":920,"wires":[["11ade2d568b39f66","18292d736069ab1a"]]},{"id":"18292d736069ab1a","type":"change","z":"dc434684164184f3","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"payload.data.title","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":3240,"y":860,"wires":[["07dc8ff772761239"]]},{"id":"621cf8c7437be5fe","type":"link out","z":"dc434684164184f3","name":"Light and Speakers","links":["45904ca6429d867d","ad88dbd2.4726b8","3405e943.fd3ee6","9cf42cf7ef60f645"],"x":3275,"y":1180,"wires":[]},{"id":"49d8d5ab57bc2780","type":"function","z":"dc434684164184f3","name":"Set Path","func":"var d = new Date();\nvar m = d.getMilliseconds();\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\"+m;\nvar newMsg = \n\n{ \n    \"payload\": {\n                data: {\n    \"media_content_id\": url,\n    \"media_content_type\": \"image/jpg\"\n                      }\n                }         \n};\nreturn newMsg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2540,"y":1260,"wires":[["25416eae7693a8e4"]]},{"id":"25416eae7693a8e4","type":"subflow:eb3b6592c8406c0d","z":"dc434684164184f3","name":"","env":[],"x":2710,"y":1260,"wires":[]},{"id":"8b7cf867e5dd6af0","type":"trigger","z":"dc434684164184f3","name":"Face Not reco","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2240,"y":1100,"wires":[["49d8d5ab57bc2780","32980352dae1ed87","a9477e0fd3c6f536"]]},{"id":"32980352dae1ed87","type":"debug","z":"dc434684164184f3","name":"face not reco","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2590,"y":1200,"wires":[]},{"id":"a9477e0fd3c6f536","type":"function","z":"dc434684164184f3","name":"Javascript","func":"var d = new Date();\nvar h = d.getHours();\nvar m = d.getMinutes();\nvar s = d.getSeconds();\nvar camera = msg.payload.camera;\nvar confidence = 0;\n\nif (typeof msg.payload.confidence !==\"undefined\"){\nvar confidence = msg.payload.confidence;\n}\n\nvar who = \"Unknown\";\nif (typeof msg.payload.name !==\"undefined\"){\nvar who = msg.payload.name;\n}\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n        \"name\": who,\n        \"data\": {\n            \"filename\":\"/config/www/portraits/\" + who + \"/\" + who + \"-\" + camera + \"-\" + h + m + s + \"-\" + confidence + \".jpg\",\n            \"entity_id\": camera\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2540,"y":1300,"wires":[["69902b6ab60ec2ea"]]},{"id":"69902b6ab60ec2ea","type":"api-call-service","z":"dc434684164184f3","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2720,"y":1300,"wires":[["8a45cac1cf815583"]]},{"id":"fd6cc49b9bc3415b","type":"api-call-service","z":"dc434684164184f3","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3080,"y":1300,"wires":[[]]},{"id":"8a45cac1cf815583","type":"function","z":"dc434684164184f3","name":"Javascript","func":"var d = new Date();\nvar name = msg.payload.name;\nvar m = d.getMilliseconds();\nvar snapshot = msg.payload.data.filename;\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\" + m;\n\nvar snapshot = snapshot.replace(\"\\/config\\/www\",\"https:\\/\\/hass.purgatoire.ca\\/local\");\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": \"Someone is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"image\": snapshot,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2880,"y":1300,"wires":[["fd6cc49b9bc3415b","6fed897f15a1b7df"]]},{"id":"6fed897f15a1b7df","type":"change","z":"dc434684164184f3","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"payload.data.title","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":3080,"y":1340,"wires":[["a6b24fae2a2006c2"]]},{"id":"a6b24fae2a2006c2","type":"link out","z":"dc434684164184f3","name":"Light and Speakers","links":["45904ca6429d867d","ad88dbd2.4726b8","3405e943.fd3ee6","9cf42cf7ef60f645"],"x":3215,"y":1340,"wires":[]},{"id":"da2860a614a49ff1","type":"api-current-state","z":"dc434684164184f3","name":"uber","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.waiting_uber","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2270,"y":800,"wires":[["ca373eccc666f38c"],["a4e503149ac458a8"]]},{"id":"2830e93ceb0cef1f","type":"switch","z":"dc434684164184f3","name":"","property":"payload.name","propertyType":"msg","rules":[{"t":"nempty"},{"t":"eq","v":"","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":2090,"y":1000,"wires":[["8b7cf867e5dd6af0"],["b2a60458583628a1"]]},{"id":"febfacf98e14230f","type":"switch","z":"dc434684164184f3","name":"Recod Faces 1/0","property":"payload.data.entity_id","propertyType":"msg","rules":[{"t":"eq","v":"camera.facecam_static","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":2270,"y":520,"wires":[["914d208ac8e90c6b"]]},{"id":"869e08ac92dc847d","type":"api-call-service","z":"dc434684164184f3","name":"unLock Door","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"lock","service":"unlock","areaId":[],"deviceId":[],"entityId":["lock.front_door"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3650,"y":900,"wires":[["e2e0e39a2bb3932e","db63be43a45de51e"]]},{"id":"db63be43a45de51e","type":"api-current-state","z":"dc434684164184f3","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"unlocked","halt_if_type":"str","halt_if_compare":"is","entity_id":"lock.front_door","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3640,"y":840,"wires":[["b499a1d86fc0a256"],["869e08ac92dc847d"]]},{"id":"ff28ced5802c6663","type":"inject","z":"dc434684164184f3","name":"scan","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payloadType":"date","x":2910,"y":1220,"wires":[["a19802bc53c3e698"]]},{"id":"a19802bc53c3e698","type":"change","z":"dc434684164184f3","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"PSA, THIS IS A TEST, DO NOT REACT TO THIS, IT IS A TEST.","tot":"str"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":3100,"y":1220,"wires":[["621cf8c7437be5fe"]]},{"id":"29e077a48ee59080","type":"delay","z":"dc434684164184f3","name":"Waiting someone","pauseType":"delay","timeout":"1","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":2990,"y":800,"wires":[["d111259afef6d892","a9bdbe5fe49d2b6e","8c06e0a3aebde655","869e08ac92dc847d"]]},{"id":"89af71618b9c0faa","type":"api-current-state","z":"dc434684164184f3","name":"Front House Motion","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.motion_front","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2770,"y":800,"wires":[["29e077a48ee59080"],["06d4b8e6ac09e9b5"]]},{"id":"5c3a07277166a802","type":"change","z":"dc434684164184f3","name":"reset","rules":[{"t":"set","p":"payload","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2030,"y":1240,"wires":[["a4be2cbfac620b45","d6527d9b31a67e2b","620dc7e41c123988","39ca8227b74fd49d"]]},{"id":"a4be2cbfac620b45","type":"function","z":"dc434684164184f3","name":"Set Path","func":"var d = new Date();\nvar m = d.getMilliseconds();\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\"+m;\nvar newMsg = \n\n{ \n    \"payload\": {\n                data: {\n    \"media_content_id\": url,\n    \"media_content_type\": \"image/jpg\"\n                      }\n                }         \n};\nreturn newMsg;\n\n","outputs":1,"noerr":0,"x":2200,"y":1260,"wires":[["37c7747a6e0b9586"]]},{"id":"d6527d9b31a67e2b","type":"function","z":"dc434684164184f3","name":"Javascript","func":"var recoface = [];\nvar facestring = \"\"\nvar d = new Date();\nvar m = d.getMilliseconds();\nvar url = \"https://hass.purgatoire.ca/local/ring.jpg?\" + m;\nvar facestring = msg.payload;\n\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n  \"message\": \"Someone is at the door\",\n  \"data\": {\n    \"image\": url,\n    \"actions\": [\n      {\n        \"action\": \"unlock_door\",\n        \"title\": \"Unlock The Door\"\n      }\n                \n    ]\n  }\n}\n }\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2200,"y":1220,"wires":[["e7e97761c64767e9"]]},{"id":"37c7747a6e0b9586","type":"subflow:eb3b6592c8406c0d","z":"dc434684164184f3","name":"","env":[],"x":2370,"y":1260,"wires":[]},{"id":"e7e97761c64767e9","type":"api-call-service","z":"dc434684164184f3","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2380,"y":1220,"wires":[[]]},{"id":"b2a60458583628a1","type":"trigger","z":"dc434684164184f3","name":"No Face","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2020,"y":1120,"wires":[["5c3a07277166a802"]]},{"id":"620dc7e41c123988","type":"change","z":"dc434684164184f3","name":"Set Data for mass alert","rules":[{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"},{"t":"set","p":"message","pt":"msg","to":"Someone is at the door","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2240,"y":1300,"wires":[["691a7adae76a461c"]]},{"id":"691a7adae76a461c","type":"link out","z":"dc434684164184f3","name":"Light and Speakers","links":["45904ca6429d867d","ad88dbd2.4726b8","3405e943.fd3ee6","9cf42cf7ef60f645"],"x":2375,"y":1300,"wires":[]},{"id":"39ca8227b74fd49d","type":"debug","z":"dc434684164184f3","name":"result before notif","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2190,"y":1160,"wires":[]},{"id":"d56d0261de5b568d","type":"delay","z":"dc434684164184f3","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":400,"y":840,"wires":[["fcbc2284bd9e9322"]]},{"id":"bf36421868181d87","type":"switch","z":"dc434684164184f3","name":"","property":"payload.event.action_1_title","propertyType":"msg","rules":[{"t":"eq","v":"Who is this?","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":1950,"y":460,"wires":[["ac6262324beb2749","daa9cae4d006c055"]]},{"id":"07dc8ff772761239","type":"link out","z":"dc434684164184f3","name":"Light and Speakers","links":["45904ca6429d867d","ad88dbd2.4726b8","3405e943.fd3ee6","9cf42cf7ef60f645"],"x":3375,"y":860,"wires":[]},{"id":"2514a98f5322706e","type":"subflow:eb3b6592c8406c0d","z":"dc434684164184f3","name":"","env":[],"x":2990,"y":1020,"wires":[]},{"id":"a4e503149ac458a8","type":"trigger","z":"dc434684164184f3","name":"Uber","op1":"","op2":"","op1type":"nul","op2type":"payl","duration":"1","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2310,"y":1040,"wires":[["5a39e063f81f4934","ca181274192ce702"]]},{"id":"5a39e063f81f4934","type":"function","z":"dc434684164184f3","name":"Javascript","func":"var d = new Date();\nvar h = d.getHours();\nvar m = d.getMinutes();\nvar s = d.getSeconds();\nvar camera = msg.payload.camera;\nvar confidence = 0;\n\nif (typeof msg.payload.confidence !==\"undefined\"){\nvar confidence = msg.payload.confidence;\n}\n\nvar who = \"Unknown\";\nif (typeof msg.payload.name !==\"undefined\"){\nvar who = msg.payload.name;\n}\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n        \"name\": who,\n        \"data\": {\n            \"filename\":\"/config/www/portraits/\" + who + \"/\" + who + \"-\" + camera + \"-\" + h + m + s + \"-\" + confidence + \".jpg\",\n            \"entity_id\": camera\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2500,"y":1060,"wires":[["0622a15703bbaff4"]]},{"id":"0622a15703bbaff4","type":"api-call-service","z":"dc434684164184f3","name":"snapshot","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2960,"y":1060,"wires":[["11a0719ba4e2269b"]]},{"id":"ec801c1b335a58de","type":"api-call-service","z":"dc434684164184f3","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3280,"y":1060,"wires":[[]]},{"id":"11a0719ba4e2269b","type":"function","z":"dc434684164184f3","name":"Javascript","func":"var d = new Date();\nvar name = msg.payload.name;\nvar m = d.getMilliseconds();\nvar snapshot = msg.payload.data.filename;\nvar url = \"http://192.168.0.12:8765/picture/8/current/?\" + m;\n\nvar snapshot = snapshot.replace(\"\\/config\\/www\",\"https:\\/\\/hass.purgatoire.ca\\/local\");\n\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"image\": snapshot,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3100,"y":1060,"wires":[["ec801c1b335a58de","601dd7a48a2a870b"]]},{"id":"601dd7a48a2a870b","type":"change","z":"dc434684164184f3","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"payload.data.title","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":3220,"y":1020,"wires":[["7a91de5bae6af973"]]},{"id":"7a91de5bae6af973","type":"link out","z":"dc434684164184f3","name":"Light and Speakers","links":["45904ca6429d867d","ad88dbd2.4726b8","3405e943.fd3ee6","9cf42cf7ef60f645"],"x":3355,"y":1020,"wires":[]},{"id":"1e4ae4a2670f5fb5","type":"function","z":"dc434684164184f3","name":"Set Path","func":"var d = new Date();\nvar m = d.getMilliseconds();\nvar url = \"http://192.168.0.12:8765/picture/4/current/?\"+m;\nvar newMsg = \n\n{ \n    \"payload\": {\n                data: {\n    \"media_content_id\": url,\n    \"media_content_type\": \"image/jpg\"\n                      }\n                }         \n};\nreturn newMsg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2760,"y":1020,"wires":[["2514a98f5322706e"]]},{"id":"ca181274192ce702","type":"api-call-service","z":"dc434684164184f3","name":"to package","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"script","service":"ptz_to_package","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload666","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":2470,"y":1020,"wires":[["df6ec4f40fef1842"]]},{"id":"df6ec4f40fef1842","type":"delay","z":"dc434684164184f3","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":2620,"y":1020,"wires":[["1e4ae4a2670f5fb5"]]},{"id":"2b8f21d2930527fd","type":"server-state-changed","z":"7a1172b433a6cf9c","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"switch.zooz_livingroom_ac","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"(on)","ifStateType":"re","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":260,"y":160,"wires":[["de24400af7fb8682"],["b659f5b0b0949237"]]},{"id":"6ab2b0bf6efbdf06","type":"api-call-service","z":"7a1172b433a6cf9c","name":"Raise volume","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_up","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1140,"y":120,"wires":[[]]},{"id":"f5e830d6ddc96d84","type":"comment","z":"7a1172b433a6cf9c","name":"Adjust volume of players depending on AC state","info":"","x":280,"y":60,"wires":[]},{"id":"2dd272c9b019b4cb","type":"ha-get-entities","z":"7a1172b433a6cf9c","name":"Get Livingroom Media players","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.living.*[a-z]","valueType":"re"},{"property":"state","logic":"is","value":"playing","valueType":"str"},{"property":"attributes.is_volume_muted","logic":"is","value":"false","valueType":"bool"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":690,"y":120,"wires":[["b20d619270cc6150"]]},{"id":"b20d619270cc6150","type":"change","z":"7a1172b433a6cf9c","name":"","rules":[{"t":"delete","p":"parts","pt":"msg"},{"t":"move","p":"payload.entity_id","pt":"msg","to":"payload.data.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":920,"y":120,"wires":[["6ab2b0bf6efbdf06"]]},{"id":"4af896f52385062c","type":"api-call-service","z":"7a1172b433a6cf9c","name":"Lower Volume","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_up","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1140,"y":200,"wires":[[]]},{"id":"8983f64fe67807ba","type":"change","z":"7a1172b433a6cf9c","name":"","rules":[{"t":"delete","p":"parts","pt":"msg"},{"t":"move","p":"payload.entity_id","pt":"msg","to":"payload.data.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":920,"y":200,"wires":[["4af896f52385062c"]]},{"id":"194df1b5694d90f6","type":"comment","z":"7a1172b433a6cf9c","name":"AC ON?","info":"","x":240,"y":120,"wires":[]},{"id":"fdac127df5c14497","type":"comment","z":"7a1172b433a6cf9c","name":"AC ON?","info":"","x":480,"y":120,"wires":[]},{"id":"331ecc86cf62638c","type":"comment","z":"7a1172b433a6cf9c","name":"AC ON?","info":"","x":480,"y":200,"wires":[]},{"id":"6fa23a1db9f7c256","type":"comment","z":"7a1172b433a6cf9c","name":"Get Living room media players entities and output them one by one","info":"","x":700,"y":160,"wires":[]},{"id":"094384a7307219c9","type":"comment","z":"7a1172b433a6cf9c","name":"Place the entity_id properly","info":"","x":910,"y":80,"wires":[]},{"id":"129d6d45d0edfb1c","type":"comment","z":"7a1172b433a6cf9c","name":"Place the entity_id properly","info":"","x":910,"y":240,"wires":[]},{"id":"2fe6cbe753337547","type":"comment","z":"7a1172b433a6cf9c","name":"Sed volume command","info":"","x":1140,"y":160,"wires":[]},{"id":"b32a90c6168f15d7","type":"trigger-state","z":"7a1172b433a6cf9c","g":"4400d23658e76bdf","name":"Cover Closed and AC on","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"switch.zooz_livingroom_ac","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"entity_id","targetValue":"cover.cover_livingroom_blinds","propertyType":"property","propertyValue":"attributes.current_position","comparatorType":"<","comparatorValueDatatype":"num","comparatorValue":"26"},{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":210,"y":580,"wires":[["f6f59f0656592eed"],[]]},{"id":"f6f59f0656592eed","type":"api-call-service","z":"7a1172b433a6cf9c","g":"4400d23658e76bdf","name":"Blinds at 26% ","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"set_cover_position","areaId":[],"deviceId":[],"entityId":["cover.cover_livingroom_blinds"],"data":"{\"position\": \"26\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":520,"y":580,"wires":[[]]},{"id":"5f22a5944ac11de5","type":"api-call-service","z":"7a1172b433a6cf9c","name":"CLose blinds","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"set_cover_position","areaId":[],"deviceId":[],"entityId":["cover.cover_livingroom_blinds"],"data":"{\"position\": \"0\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":510,"y":700,"wires":[[]]},{"id":"cb5984111331e6ed","type":"api-call-service","z":"7a1172b433a6cf9c","g":"4400d23658e76bdf","name":"Blinds at 26% ","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"set_cover_position","areaId":[],"deviceId":[],"entityId":["cover.cover_livingroom_blinds"],"data":"{\"position\": \"26\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":520,"y":500,"wires":[[]]},{"id":"c300aac55d064248","type":"trigger-state","z":"7a1172b433a6cf9c","name":"Cover Closed and AC Off","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"switch.zooz_livingroom_ac","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"entity_id","targetValue":"cover.cover_livingroom_blinds","propertyType":"property","propertyValue":"attributes.current_position","comparatorType":"<","comparatorValueDatatype":"num","comparatorValue":"27"},{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"off"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":210,"y":700,"wires":[["5f22a5944ac11de5"],[]]},{"id":"3b1c32816a1299f8","type":"trigger-state","z":"7a1172b433a6cf9c","g":"4400d23658e76bdf","name":"Closed Cover and AC on","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"cover.cover_livingroom_blinds","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"property","propertyValue":"new_state.attributes.current_position","comparatorType":"<","comparatorValueDatatype":"num","comparatorValue":"26"},{"targetType":"entity_id","targetValue":"switch.zooz_livingroom_ac","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":210,"y":500,"wires":[["cb5984111331e6ed"],[]]},{"id":"bd59751a77bcba60","type":"comment","z":"7a1172b433a6cf9c","g":"4400d23658e76bdf","name":"If cover is under 26% and AC is on","info":"","x":240,"y":540,"wires":[]},{"id":"3f4d478a4f7e7def","type":"comment","z":"7a1172b433a6cf9c","g":"4400d23658e76bdf","name":"Set cover to 26% open","info":"","x":540,"y":540,"wires":[]},{"id":"f552d4b46029cb7d","type":"comment","z":"7a1172b433a6cf9c","name":"If cover is under 26% and AC is off","info":"","x":240,"y":660,"wires":[]},{"id":"4c0a54eac3d0f0cb","type":"comment","z":"7a1172b433a6cf9c","name":"Close blinds","info":"","x":510,"y":660,"wires":[]},{"id":"ca28f711101bffcc","type":"comment","z":"7a1172b433a6cf9c","name":"Ikea blind button","info":"","x":180,"y":820,"wires":[]},{"id":"e10059117be5de52","type":"comment","z":"7a1172b433a6cf9c","name":"Open or Close","info":"","x":370,"y":820,"wires":[]},{"id":"f929d29e13821eeb","type":"comment","z":"7a1172b433a6cf9c","name":"Open cover","info":"","x":630,"y":800,"wires":[]},{"id":"58aecdb12f173ad1","type":"comment","z":"7a1172b433a6cf9c","name":"Close cover","info":"","x":630,"y":920,"wires":[]},{"id":"ddcea114278daa7d","type":"api-call-service","z":"7a1172b433a6cf9c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"open_cover","areaId":[],"deviceId":[],"entityId":["cover.cover_livingroom_blinds"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":620,"y":840,"wires":[[]]},{"id":"874e0ddfe60e095c","type":"switch","z":"7a1172b433a6cf9c","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"open","vt":"str"},{"t":"eq","v":"close","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":370,"y":860,"wires":[["ddcea114278daa7d"],["af99c9c9b796b673"]]},{"id":"78da9fa3d7731367","type":"server-state-changed","z":"7a1172b433a6cf9c","name":"Blind Button","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"sensor.remote_livingroom_blind_button_action","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"(open|close)","ifStateType":"re","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":170,"y":860,"wires":[["874e0ddfe60e095c"],[]]},{"id":"af99c9c9b796b673","type":"api-call-service","z":"7a1172b433a6cf9c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"close_cover","areaId":[],"deviceId":[],"entityId":["cover.cover_livingroom_blinds"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":620,"y":880,"wires":[[]]},{"id":"70c42437dc758335","type":"ha-get-entities","z":"7a1172b433a6cf9c","name":"Get Livingroom Media players","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.living.*[a-z]","valueType":"re"},{"property":"state","logic":"is","value":"playing","valueType":"str"},{"property":"attributes.is_volume_muted","logic":"is","value":"false","valueType":"bool"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":690,"y":200,"wires":[["8983f64fe67807ba"]]},{"id":"eaf1c1f4ea0a8845","type":"server-state-changed","z":"7a1172b433a6cf9c","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.sleeper_in_livingroom","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":false,"x":330,"y":1740,"wires":[["b2a1574456ee77b3"],["9256791e63f40fbe"]]},{"id":"b2a1574456ee77b3","type":"ha-get-entities","z":"7a1172b433a6cf9c","name":"Get individual Hotbox lights","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"light\\.(?!.*?group.*?)(?!.*?lights.*?).*livingroom.*","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":680,"y":1720,"wires":[["cfe5e026b0d68c69"]]},{"id":"51e2b62bcf83fbb2","type":"api-call-service","z":"7a1172b433a6cf9c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1250,"y":1720,"wires":[[]]},{"id":"9256791e63f40fbe","type":"ha-get-entities","z":"7a1172b433a6cf9c","name":"Get individual Hotbox lights","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"light\\.(?!.*?group.*?)(?!.*?lights.*?).*livingroom.*","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":680,"y":1760,"wires":[["c1fdac440a2ebc24"]]},{"id":"01511e0acf840f79","type":"api-call-service","z":"7a1172b433a6cf9c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"transition\":\"20\",\"color_name\": \"white\"}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1250,"y":1760,"wires":[[]]},{"id":"8acc727c3836cfa2","type":"comment","z":"7a1172b433a6cf9c","name":"Trigger on Sleeper boolean change","info":"","x":320,"y":1700,"wires":[]},{"id":"0f850d015bb6c26a","type":"comment","z":"7a1172b433a6cf9c","name":"Get Livingroom light entities","info":"","x":700,"y":1680,"wires":[]},{"id":"63e2d4d4f1dfa2f6","type":"comment","z":"7a1172b433a6cf9c","name":"Call light_off service","info":"","x":1250,"y":1680,"wires":[]},{"id":"084c6f07fef9b86f","type":"comment","z":"7a1172b433a6cf9c","name":"Toggle the Livingroom  lights when someone sleeps","info":"","x":330,"y":1660,"wires":[]},{"id":"cfe5e026b0d68c69","type":"change","z":"7a1172b433a6cf9c","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":970,"y":1720,"wires":[["51e2b62bcf83fbb2"]]},{"id":"c1fdac440a2ebc24","type":"change","z":"7a1172b433a6cf9c","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":970,"y":1760,"wires":[["01511e0acf840f79"]]},{"id":"9bb315209fda59b9","type":"server-state-changed","z":"7a1172b433a6cf9c","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.sleeper_in_livingroom","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":false,"x":330,"y":1540,"wires":[["1cb927e5ac697efa"],["98ea0d51a9464f77"]]},{"id":"527a4dfb9eb86e1e","type":"comment","z":"7a1172b433a6cf9c","name":"Trigger on Sleeper boolean change","info":"","x":280,"y":1500,"wires":[]},{"id":"1cb927e5ac697efa","type":"ha-get-entities","z":"7a1172b433a6cf9c","name":"Get active living room Media players","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.(?!.*?group.*?)(?!.*?top.*?).*livingroom.*","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":770,"y":1500,"wires":[["8f24711d3c008c68"]]},{"id":"ee8e9edb5007f25e","type":"comment","z":"7a1172b433a6cf9c","name":"Pull livingroom media players that are playing","info":"","x":790,"y":1460,"wires":[]},{"id":"8f24711d3c008c68","type":"change","z":"7a1172b433a6cf9c","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":1500,"wires":[["c96710a197cff30e"]]},{"id":"e1d9dd6a1dfe05b1","type":"comment","z":"7a1172b433a6cf9c","name":"Extract the entity id","info":"","x":1090,"y":1460,"wires":[]},{"id":"009189ab4426c30b","type":"comment","z":"7a1172b433a6cf9c","name":"Mute player's volume","info":"","x":1320,"y":1460,"wires":[]},{"id":"4326fcfd8496cfba","type":"comment","z":"7a1172b433a6cf9c","name":"Stop playback","info":"","x":1930,"y":1460,"wires":[]},{"id":"1b550ceb534e0cab","type":"api-call-service","z":"7a1172b433a6cf9c","name":"stop player","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1930,"y":1500,"wires":[[]]},{"id":"c96710a197cff30e","type":"api-call-service","z":"7a1172b433a6cf9c","name":"mute player","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\":\"true\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1330,"y":1500,"wires":[["2ab8f0b4d628e884"]]},{"id":"2ab8f0b4d628e884","type":"api-current-state","z":"7a1172b433a6cf9c","name":"Home_Group off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.group_home_speakers","state_type":"str","blockInputOverrides":true,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":1600,"y":1500,"wires":[["1b550ceb534e0cab"],[]]},{"id":"7615b56747bef2b2","type":"comment","z":"7a1172b433a6cf9c","name":"MAke sure home_group is not playing","info":"","x":1610,"y":1460,"wires":[]},{"id":"98ea0d51a9464f77","type":"ha-get-entities","z":"7a1172b433a6cf9c","name":"Get active living room Media players","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.(?!.*?group.*?)(?!.*?top.*?).*livingroom.*","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":770,"y":1580,"wires":[["fe102fb1b94e4385"]]},{"id":"5fe2a1d1f9bb1435","type":"comment","z":"7a1172b433a6cf9c","name":"Pull livingroom media players","info":"","x":740,"y":1540,"wires":[]},{"id":"fe102fb1b94e4385","type":"change","z":"7a1172b433a6cf9c","name":"","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":1580,"wires":[["cb2a449d4b6f4060"]]},{"id":"51eadab95244344f","type":"comment","z":"7a1172b433a6cf9c","name":"Extract the entity id","info":"","x":1090,"y":1540,"wires":[]},{"id":"0ac943c319d49e4b","type":"comment","z":"7a1172b433a6cf9c","name":"unMute player's volume","info":"","x":1320,"y":1540,"wires":[]},{"id":"cb2a449d4b6f4060","type":"api-call-service","z":"7a1172b433a6cf9c","name":"unmute player","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\":\"false\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1340,"y":1580,"wires":[[]]},{"id":"56b9cda6cd5f6c3f","type":"server-state-changed","z":"7a1172b433a6cf9c","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.sleeper_in_livingroom","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":false,"x":330,"y":1900,"wires":[["a701eb41c2480220"],["59adec8248c94ab8"]]},{"id":"a701eb41c2480220","type":"api-call-service","z":"7a1172b433a6cf9c","name":"Close Blinds","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"cover","service":"close_cover","areaId":[],"deviceId":[],"entityId":["cover.cover_livingroom_blinds"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":730,"y":1900,"wires":[["b9cbf8db5e72a2aa"]]},{"id":"b9cbf8db5e72a2aa","type":"api-call-service","z":"7a1172b433a6cf9c","name":"Turn off TV","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":["media_player.livingroom_lg_webos_tv"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":990,"y":1900,"wires":[[]]},{"id":"59adec8248c94ab8","type":"api-call-service","z":"7a1172b433a6cf9c","name":"Turn on Tv","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"tts","service":"google_translate_say","areaId":[],"deviceId":[],"entityId":["media_player.livingroom_chromecast"],"data":"{    \"message\": \"Good morning\",    \"language\": \"en\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":730,"y":1940,"wires":[["2380227eec6c2976"]]},{"id":"2380227eec6c2976","type":"api-call-service","z":"7a1172b433a6cf9c","name":"Turn off chromecast","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":["media_player.livingroom_chromecast"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":980,"y":1940,"wires":[[]]},{"id":"c6df906663bb8ece","type":"comment","z":"7a1172b433a6cf9c","name":"Mute player's volume","info":"","x":660,"y":2020,"wires":[]},{"id":"161d30db7812414c","type":"api-call-service","z":"7a1172b433a6cf9c","name":"mute player","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":["media_player.hallway_speaker"],"data":"{\"is_volume_muted\":\"true\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":670,"y":2060,"wires":[[]]},{"id":"345c7fdabd0c4763","type":"comment","z":"7a1172b433a6cf9c","name":"unMute player's volume","info":"","x":660,"y":2100,"wires":[]},{"id":"e393b3c3753017f4","type":"api-call-service","z":"7a1172b433a6cf9c","name":"unmute player","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":["media_player.hallway_speaker"],"data":"{\"is_volume_muted\":\"false\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":680,"y":2140,"wires":[[]]},{"id":"53f8e91df936a6f2","type":"server-state-changed","z":"7a1172b433a6cf9c","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.sleeper_in_livingroom","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":false,"x":330,"y":2060,"wires":[["161d30db7812414c"],["e393b3c3753017f4"]]},{"id":"47c310b9a0506290","type":"mqtt in","z":"7a1172b433a6cf9c","name":"","topic":"zigbee2mqtt/remote_livingroom_dial","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":260,"y":2720,"wires":[["87b6e543dfa9ccf3"]]},{"id":"e91dac9449887e29","type":"comment","z":"7a1172b433a6cf9c","name":"Monitor mqtt of living room dial","info":"","x":270,"y":2680,"wires":[]},{"id":"87b6e543dfa9ccf3","type":"subflow:61f53235c712b2c2","z":"7a1172b433a6cf9c","name":"","x":570,"y":2720,"wires":[]},{"id":"f2a5ebec5b1f5bb2","type":"comment","z":"7a1172b433a6cf9c","name":"Trigger on Sleeper boolean change","info":"","x":280,"y":1860,"wires":[]},{"id":"f62e16aef2bb7969","type":"comment","z":"7a1172b433a6cf9c","name":"Trigger on Sleeper boolean change","info":"","x":280,"y":2020,"wires":[]},{"id":"31580b5012b0d0e4","type":"mqtt in","z":"7a1172b433a6cf9c","name":"","topic":"zigbee2mqtt/remote_livingroom_library_dial","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":290,"y":2840,"wires":[["a6f5c3c707e9e250"]]},{"id":"273db860d1dd0d6e","type":"comment","z":"7a1172b433a6cf9c","name":"Monitor mqtt of living room dial","info":"","x":270,"y":2800,"wires":[]},{"id":"a6f5c3c707e9e250","type":"subflow:61f53235c712b2c2","z":"7a1172b433a6cf9c","name":"","x":570,"y":2840,"wires":[]},{"id":"2a315c865000e777","type":"comment","z":"7a1172b433a6cf9c","name":"Toggle speaker's mute depending on sleeping state","info":"","x":330,"y":1460,"wires":[]},{"id":"fd084f7067902015","type":"comment","z":"7a1172b433a6cf9c","name":"Toggle the  TV depending on sleeping state","info":"","x":300,"y":1820,"wires":[]},{"id":"efb054dbc776420d","type":"comment","z":"7a1172b433a6cf9c","name":"Toggle hallway speaker volume depending on sleeping state","info":"","x":360,"y":1980,"wires":[]},{"id":"7a80902befcdccf8","type":"server-state-changed","z":"c6790bfa88a3b330","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"script.ptz_to","entityIdType":"substring","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":270,"y":620,"wires":[["8de3b2e6f3e0af19"]]},{"id":"8de3b2e6f3e0af19","type":"trigger","z":"c6790bfa88a3b330","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"10","extend":true,"overrideDelay":false,"units":"min","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":850,"y":620,"wires":[["1ac219c27e3b54df"]]},{"id":"b63f39827e4d68ab","type":"api-call-service","z":"c6790bfa88a3b330","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"script","service":"ptz_to_doorway","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1260,"y":560,"wires":[[]]},{"id":"19a709312c53342f","type":"comment","z":"c6790bfa88a3b330","name":"#### RETURN PTZ TO ENTRYWAY AFTER 10 MINUTES####","info":"","x":370,"y":540,"wires":[]},{"id":"1ac219c27e3b54df","type":"api-current-state","z":"c6790bfa88a3b330","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.waiting_pakidge","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":870,"y":560,"wires":[["b63f39827e4d68ab"],["8de3b2e6f3e0af19"]]},{"id":"6727f87cf9ac9c93","type":"comment","z":"c6790bfa88a3b330","name":"Trigger on activation of the PTZ script turning on","info":"","x":320,"y":580,"wires":[]},{"id":"bde18a11acf24fc9","type":"comment","z":"c6790bfa88a3b330","name":"Only continues if I am not waiting a package","info":"","x":850,"y":520,"wires":[]},{"id":"1e519a4e860f6bea","type":"comment","z":"c6790bfa88a3b330","name":"Repeat every 10 minutes","info":"","x":850,"y":660,"wires":[]},{"id":"98664762d97eeba8","type":"comment","z":"c6790bfa88a3b330","name":"Return PTZ to Entryway","info":"","x":1260,"y":520,"wires":[]},{"id":"38d05af222c8c2ef","type":"server-state-changed","z":"92fbb69b279db47c","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"sensor.phone_fold4_phone_state","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"ringing","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":340,"y":560,"wires":[["3298aa23644cb569"],[]]},{"id":"bb4c9008f4dc6e1c","type":"switch","z":"92fbb69b279db47c","name":"Location","property":"data.state","propertyType":"msg","rules":[{"t":"cont","v":"bedroom","vt":"str"},{"t":"cont","v":"closet","vt":"str"},{"t":"cont","v":"hotbox","vt":"str"},{"t":"cont","v":"livingroom","vt":"str"},{"t":"cont","v":"kitchen","vt":"str"},{"t":"cont","v":"not_home","vt":"str"},{"t":"cont","v":"office","vt":"str"}],"checkall":"false","repair":false,"outputs":7,"x":960,"y":560,"wires":[["b75c436b78a2db6c"],["e260196e89907e86"],["bdedb20f9338ddcd"],["a5ac27e54038ee89"],["432527c002c9480b"],["daac69a5cf6ec582"],["daac69a5cf6ec582"]]},{"id":"cf2bbfabad520e42","type":"api-current-state","z":"92fbb69b279db47c","name":"Maxi's location","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"sensor.maxi_location_v3","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":740,"y":560,"wires":[["56f0d45c70c74b03"]]},{"id":"f2327bfce2374697","type":"api-call-service","z":"92fbb69b279db47c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"tts","service":"google_translate_say","areaId":[],"deviceId":[],"entityId":["media_player.bedroom_speaker"],"data":"{\"message\":\"Incoming Call\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1470,"y":420,"wires":[["d1f215e6492373b7"]]},{"id":"888831edad836804","type":"api-call-service","z":"92fbb69b279db47c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"tts","service":"google_translate_say","areaId":[],"deviceId":[],"entityId":["media_player.closet_speaker"],"data":"{\"message\":\"Incoming Call\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1470,"y":480,"wires":[["9d68aadc72027592"]]},{"id":"7faf764f0f3bde7f","type":"api-call-service","z":"92fbb69b279db47c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"tts","service":"google_translate_say","areaId":[],"deviceId":[],"entityId":["media_player.group_hotbox_speakers"],"data":"{\"message\":\"Incoming Call\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1470,"y":540,"wires":[["f87dd9f0c8a97fc9"]]},{"id":"38f7d5fcaeeafa85","type":"api-call-service","z":"92fbb69b279db47c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"tts","service":"google_translate_say","areaId":[],"deviceId":[],"entityId":["media_player.kitchen_speaker"],"data":"{\"message\":\"Incoming Call\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1480,"y":640,"wires":[["ed7c5a901ae4ebbb"]]},{"id":"22ab49ec71e4c781","type":"api-call-service","z":"92fbb69b279db47c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"tts","service":"google_translate_say","areaId":[],"deviceId":[],"entityId":["media_player.office_speaker"],"data":"{\"message\":\"Incoming Call\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1470,"y":700,"wires":[["bd649c731c23b1eb"]]},{"id":"b75c436b78a2db6c","type":"api-call-service","z":"92fbb69b279db47c","name":"Set Volume","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.bedroom_speaker"],"data":"{\"volume_level\": \"1\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1270,"y":420,"wires":[["f2327bfce2374697"]]},{"id":"e260196e89907e86","type":"api-call-service","z":"92fbb69b279db47c","name":"Set Volume","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.closet_speaker"],"data":"{\"volume_level\": \"1\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1270,"y":480,"wires":[["888831edad836804"]]},{"id":"bdedb20f9338ddcd","type":"api-call-service","z":"92fbb69b279db47c","name":"Set Volume","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.group_hotbox_speakers"],"data":"{\"volume_level\": \"1\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1270,"y":540,"wires":[["7faf764f0f3bde7f"]]},{"id":"432527c002c9480b","type":"api-call-service","z":"92fbb69b279db47c","name":"Set Volume","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.kitchen_speaker"],"data":"{\"volume_level\": \"1\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1270,"y":640,"wires":[["38f7d5fcaeeafa85"]]},{"id":"daac69a5cf6ec582","type":"api-call-service","z":"92fbb69b279db47c","name":"Set Volume","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.office_speaker"],"data":"{\"volume_level\": \"1\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1270,"y":700,"wires":[["22ab49ec71e4c781"]]},{"id":"4631362288c522a6","type":"api-call-service","z":"92fbb69b279db47c","name":"stop speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":["media_player.bedroom_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1850,"y":420,"wires":[[]]},{"id":"23ee45554cf02635","type":"api-call-service","z":"92fbb69b279db47c","name":"stop speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":["media_player.closet_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1850,"y":480,"wires":[[]]},{"id":"d96e85146f80b7f8","type":"api-call-service","z":"92fbb69b279db47c","name":"stop speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":["f03ac06ccd22aec1b08572d089eb8d27"],"entityId":["media_player.group_hotbox_speakers"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1850,"y":540,"wires":[[]]},{"id":"50f2b0a2cd270989","type":"api-call-service","z":"92fbb69b279db47c","name":"stop speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":["media_player.kitchen_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1860,"y":640,"wires":[[]]},{"id":"bd7ef0aedbc2a16e","type":"api-call-service","z":"92fbb69b279db47c","name":"stop speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":["media_player.office_speaker"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1860,"y":700,"wires":[[]]},{"id":"d1f215e6492373b7","type":"trigger","z":"92fbb69b279db47c","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"4","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1680,"y":420,"wires":[["4631362288c522a6"]]},{"id":"9d68aadc72027592","type":"trigger","z":"92fbb69b279db47c","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"4","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1680,"y":480,"wires":[["23ee45554cf02635"]]},{"id":"f87dd9f0c8a97fc9","type":"trigger","z":"92fbb69b279db47c","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"4","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1680,"y":540,"wires":[["d96e85146f80b7f8"]]},{"id":"ed7c5a901ae4ebbb","type":"trigger","z":"92fbb69b279db47c","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"4","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1680,"y":640,"wires":[["50f2b0a2cd270989"]]},{"id":"bd649c731c23b1eb","type":"trigger","z":"92fbb69b279db47c","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"4","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1680,"y":700,"wires":[["bd7ef0aedbc2a16e"]]},{"id":"d8ef547c719fbe68","type":"comment","z":"92fbb69b279db47c","name":"Alert me in the room where I am when my phone rings","info":"","x":360,"y":520,"wires":[]},{"id":"391af25a3c63eb79","type":"api-call-service","z":"92fbb69b279db47c","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"tts","service":"google_translate_say","areaId":[],"deviceId":[],"entityId":["media_player.group_living_room_speakers"],"data":"{\"message\":\"Incoming Call\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1470,"y":600,"wires":[["a15e857ce732f7d0"]]},{"id":"a5ac27e54038ee89","type":"api-call-service","z":"92fbb69b279db47c","name":"Set Volume","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_set","areaId":[],"deviceId":[],"entityId":["media_player.group_living_room_speakers"],"data":"{\"volume_level\": \"1\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1270,"y":600,"wires":[["391af25a3c63eb79"]]},{"id":"2b069698f7095dbd","type":"api-call-service","z":"92fbb69b279db47c","name":"stop speaker","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":["media_player.group_living_room_speakers"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1860,"y":600,"wires":[[]]},{"id":"a15e857ce732f7d0","type":"trigger","z":"92fbb69b279db47c","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"4","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1680,"y":600,"wires":[["2b069698f7095dbd"]]},{"id":"fb4fd8b2bf4ed7e5","type":"comment","z":"92fbb69b279db47c","name":"Detect and change based on my location","info":"","x":840,"y":480,"wires":[]},{"id":"35ae3b6cb2c9519a","type":"server-state-changed","z":"effe1ca3bbc31144","name":"Samsung S7 FE battery level","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sensor.galaxy_tab_s7_fe_battery","entityIdType":"exact","outputInitially":true,"stateType":"str","ifState":"","ifStateType":"num","ifStateOperator":"is","outputOnlyOnStateChange":false,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":560,"y":700,"wires":[["26cce76adadd42af"]]},{"id":"26cce76adadd42af","type":"switch","z":"effe1ca3bbc31144","name":"","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"80","vt":"num"},{"t":"lt","v":"20","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":790,"y":700,"wires":[["da5e98c06e83f4e5"],["aa3d9a30fab50e93"]]},{"id":"da5e98c06e83f4e5","type":"api-call-service","z":"effe1ca3bbc31144","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_off","areaId":[],"deviceId":[],"entityId":["switch.plug_entrance_tablet"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1090,"y":680,"wires":[[]]},{"id":"aa3d9a30fab50e93","type":"api-call-service","z":"effe1ca3bbc31144","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_on","areaId":[],"deviceId":[],"entityId":["switch.plug_entrance_tablet"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1090,"y":720,"wires":[[]]},{"id":"36b65a18504e7a22","type":"server-state-changed","z":"effe1ca3bbc31144","name":"Samsung A7 lite battery level","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"sensor.galaxy_tab_a7_lite_battery_level","entityIdType":"exact","outputInitially":true,"stateType":"str","ifState":"","ifStateType":"num","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":560,"y":960,"wires":[["4cb6ad89f78061a4"]]},{"id":"4cb6ad89f78061a4","type":"switch","z":"effe1ca3bbc31144","name":"","property":"payload","propertyType":"msg","rules":[{"t":"gt","v":"95","vt":"num"},{"t":"lt","v":"20","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":790,"y":960,"wires":[["d0c7a34d3806e93e"],["b334e70bc7612de7"]]},{"id":"d0c7a34d3806e93e","type":"api-call-service","z":"effe1ca3bbc31144","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_off","areaId":[],"deviceId":[],"entityId":["switch.plug_bedroom_tablet"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1070,"y":920,"wires":[["081a136360d3db5a"]]},{"id":"b334e70bc7612de7","type":"api-call-service","z":"effe1ca3bbc31144","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_on","areaId":[],"deviceId":[],"entityId":["switch.plug_bedroom_tablet"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1070,"y":980,"wires":[[]]},{"id":"081a136360d3db5a","type":"trigger","z":"effe1ca3bbc31144","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"11","extend":false,"overrideDelay":false,"units":"hr","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1320,"y":920,"wires":[["44bb104f69f77c10"]]},{"id":"44bb104f69f77c10","type":"api-call-service","z":"effe1ca3bbc31144","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_on","areaId":[],"deviceId":[],"entityId":["switch.plug_bedroom_tablet"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1530,"y":920,"wires":[[]]},{"id":"6f667247f0c161d7","type":"comment","z":"effe1ca3bbc31144","name":"Check Battery level","info":"","x":530,"y":660,"wires":[]},{"id":"7a5ed9de8409c23f","type":"comment","z":"effe1ca3bbc31144","name":"Split on battery level","info":"","x":790,"y":660,"wires":[]},{"id":"200a1925d7ba53cc","type":"comment","z":"effe1ca3bbc31144","name":"Turn off the smart plug","info":"","x":1080,"y":640,"wires":[]},{"id":"68f6222e9ff2f39d","type":"comment","z":"effe1ca3bbc31144","name":"Turn on the smart plug","info":"","x":1080,"y":760,"wires":[]},{"id":"abcaad46c688b6a8","type":"comment","z":"effe1ca3bbc31144","name":"Turn off the smart plug","info":"","x":1060,"y":880,"wires":[]},{"id":"ada4fe0ce94933d6","type":"comment","z":"effe1ca3bbc31144","name":"Turn on the smart plug","info":"","x":1060,"y":1020,"wires":[]},{"id":"0c0e22622bcfac7e","type":"comment","z":"effe1ca3bbc31144","name":"Turn on the smart plug","info":"","x":1520,"y":880,"wires":[]},{"id":"eb926832575164d5","type":"comment","z":"effe1ca3bbc31144","name":"wait 11 hours","info":"","x":1310,"y":880,"wires":[]},{"id":"bd235f8ada148ddd","type":"comment","z":"effe1ca3bbc31144","name":"Check Battery level","info":"","x":530,"y":920,"wires":[]},{"id":"9b17860705a857dd","type":"comment","z":"effe1ca3bbc31144","name":"Split on battery level","info":"","x":790,"y":920,"wires":[]},{"id":"8c6d94ade940476f","type":"server-state-changed","z":"5906a7fb2733fdfc","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"vacuum.xiaomi_vacuum_cleaner","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"error","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":300,"y":460,"wires":[["44ba3b44224c44ec"],["79d77c2dfbee2cd2"]]},{"id":"c9176913f671b44c","type":"change","z":"5906a7fb2733fdfc","name":"Set Announcement Message","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"Vacuum Stuck","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1360,"y":420,"wires":[["dffe6a27dc2304f8"]]},{"id":"b652acd7f073d43a","type":"change","z":"5906a7fb2733fdfc","name":"Set Reset payload to 1","rules":[{"t":"set","p":"reset","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":800,"y":500,"wires":[["759b76f802152b90"]]},{"id":"759b76f802152b90","type":"trigger","z":"5906a7fb2733fdfc","name":"Repeat every 10 minutes","op1":"1","op2":"0","op1type":"str","op2type":"str","duration":"-10","extend":false,"overrideDelay":false,"units":"min","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":1070,"y":420,"wires":[["c9176913f671b44c"]]},{"id":"20b02da455a864e4","type":"comment","z":"5906a7fb2733fdfc","name":"####ALERT US UNTIL STUCK VACUUM IS FIXED####","info":"","x":330,"y":380,"wires":[]},{"id":"08e8514764dc823d","type":"comment","z":"5906a7fb2733fdfc","name":"Monitor the vacuum state","info":"","x":230,"y":420,"wires":[]},{"id":"5695e5b9b12cf123","type":"comment","z":"5906a7fb2733fdfc","name":"State = Error","info":"","x":610,"y":420,"wires":[]},{"id":"6c5329787354d691","type":"comment","z":"5906a7fb2733fdfc","name":"State != Error","info":"","x":610,"y":500,"wires":[]},{"id":"dffe6a27dc2304f8","type":"subflow:233ac7dcd801a802","z":"5906a7fb2733fdfc","name":"","x":1610,"y":420,"wires":[]},{"id":"9d4f0f1b4bf80fcc","type":"comment","z":"5906a7fb2733fdfc","name":"Set Reset payload to reset node","info":"","x":790,"y":460,"wires":[]},{"id":"abda12eaa520a373","type":"comment","z":"5906a7fb2733fdfc","name":"Annoy me every 10 minutes","info":"","x":1080,"y":380,"wires":[]},{"id":"35de4226eb828823","type":"comment","z":"5906a7fb2733fdfc","name":"Set Announcement data","info":"","x":1360,"y":380,"wires":[]},{"id":"59856a904239fc0a","type":"comment","z":"5906a7fb2733fdfc","name":"Send Announcement","info":"","x":1610,"y":380,"wires":[]},{"id":"add3c928ac8ef862","type":"comment","z":"5906a7fb2733fdfc","name":"Monitor Lock through MQTT","info":"This is meant to pull more data from the unlock event, such as unlock_pin","x":220,"y":880,"wires":[]},{"id":"30e87f2b1c0a52ed","type":"comment","z":"5906a7fb2733fdfc","name":"### PASS VACUUM AFTER 4 PEOPLE ENTERED ###","info":"","x":300,"y":840,"wires":[]},{"id":"0693e625e06fd094","type":"mqtt in","z":"5906a7fb2733fdfc","name":"","topic":"zigbee2mqtt/lock_front_door","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":220,"y":920,"wires":[["6bdf4cb0aeba112c"]]},{"id":"4ac5f5a6d10530e5","type":"comment","z":"5906a7fb2733fdfc","name":"Only allow unlocks","info":"This should only be inside unlocks as I never use the key","x":630,"y":880,"wires":[]},{"id":"6bdf4cb0aeba112c","type":"switch","z":"5906a7fb2733fdfc","name":"Action contains \"Unlock\"","property":"payload.action","propertyType":"msg","rules":[{"t":"cont","v":"unlock","vt":"str"}],"checkall":"false","repair":false,"outputs":1,"x":630,"y":920,"wires":[["78994aabdbe7d773"]]},{"id":"57d22bb27a9d4873","type":"counter","z":"5906a7fb2733fdfc","name":"","init":"0","step":"1","lower":"","upper":"4","mode":"increment","outputs":2,"x":1200,"y":920,"wires":[["5a7bd6537b6cb92f"],[]]},{"id":"5a7bd6537b6cb92f","type":"switch","z":"5906a7fb2733fdfc","name":"4 guests since last reset","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"4","vt":"str"}],"checkall":"false","repair":false,"outputs":1,"x":1450,"y":920,"wires":[["766f56ecab41d348","7179431f4b20ca48"]]},{"id":"c1c9fbfdddf4f7b6","type":"api-call-service","z":"5906a7fb2733fdfc","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"automation","service":"trigger","areaId":[],"deviceId":[],"entityId":["automation.clean_the_entrance"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2450,"y":920,"wires":[[]]},{"id":"49b70d1929946721","type":"api-current-state","z":"5906a7fb2733fdfc","name":"Vacuum is docked","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"docked","halt_if_type":"str","halt_if_compare":"is","entity_id":"vacuum.xiaomi_vacuum_cleaner","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":2150,"y":920,"wires":[["c1c9fbfdddf4f7b6"],[]]},{"id":"ce8ad4ee11178ee3","type":"change","z":"5906a7fb2733fdfc","name":"Set reset","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"reset","pt":"msg","to":"true","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1000,"y":1000,"wires":[["57d22bb27a9d4873"]]},{"id":"38db18300c353ec5","type":"server-state-changed","z":"5906a7fb2733fdfc","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"vacuum.xiaomi_vacuum_cleaner","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"docked","halt_if_type":"str","halt_if_compare":"is_not","output_only_on_state_change":true,"x":700,"y":1000,"wires":[["ce8ad4ee11178ee3"],[]]},{"id":"f2c735a07830f1c6","type":"comment","z":"5906a7fb2733fdfc","name":"Trigger when vacuum undocks","info":"","x":640,"y":960,"wires":[]},{"id":"d0b68746f097b631","type":"comment","z":"5906a7fb2733fdfc","name":"Set reset ","info":"","x":980,"y":960,"wires":[]},{"id":"5df8e7168e4503f8","type":"comment","z":"5906a7fb2733fdfc","name":"Call \"Clean Entrance\" Automation","info":"","x":2450,"y":880,"wires":[]},{"id":"d443e6401945927e","type":"comment","z":"5906a7fb2733fdfc","name":"Allow when 4 guests have been in","info":"","x":1460,"y":880,"wires":[]},{"id":"89beeec54a99cf98","type":"comment","z":"5906a7fb2733fdfc","name":"Count to 4","info":"","x":1200,"y":880,"wires":[]},{"id":"766f56ecab41d348","type":"delay","z":"5906a7fb2733fdfc","name":"Wait 15 minutes","pauseType":"rate","timeout":"15","timeoutUnits":"minutes","rate":"1","nbRateUnits":"15","rateUnits":"minute","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":1680,"y":920,"wires":[["409094357cff6704"]]},{"id":"373ad04471a30ec6","type":"comment","z":"5906a7fb2733fdfc","name":"Make sure vacuum is not busy","info":"","x":2160,"y":880,"wires":[]},{"id":"7e3cb08a22a7dd4e","type":"comment","z":"5906a7fb2733fdfc","name":"Only count when there's a party","info":"","x":970,"y":880,"wires":[]},{"id":"ec9ccf1ad0930e3d","type":"api-current-state","z":"5906a7fb2733fdfc","name":"Party mode is on","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.party_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":950,"y":920,"wires":[["57d22bb27a9d4873"],[]]},{"id":"409094357cff6704","type":"api-current-state","z":"5906a7fb2733fdfc","name":"No motion in the entrance","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_entrance_out_motion_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1910,"y":920,"wires":[["49b70d1929946721"],[]]},{"id":"733bdfb9404201d3","type":"comment","z":"5906a7fb2733fdfc","name":"Make sure no one is in the door","info":" - ","x":1890,"y":880,"wires":[]},{"id":"51901612cf7ebd2f","type":"comment","z":"5906a7fb2733fdfc","name":"<<--- Reset when 4 guests have been left in <<--","info":"","x":1480,"y":1000,"wires":[]},{"id":"1d53e0436b4d96b7","type":"mqtt in","z":"f9b109c0bb255002","name":"","topic":"zigbee2mqtt/remote_hallway_dial","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":350,"y":220,"wires":[["348f076b5a914b56"]]},{"id":"348f076b5a914b56","type":"subflow:61f53235c712b2c2","z":"f9b109c0bb255002","name":"","x":590,"y":220,"wires":[]},{"id":"43be64c5389825c2","type":"mqtt in","z":"24ea4eb63a576675","name":"","topic":"zigbee2mqtt/remote_server_dial","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":770,"y":400,"wires":[["9ff46d906fdbbe46"]]},{"id":"9ff46d906fdbbe46","type":"subflow:61f53235c712b2c2","z":"24ea4eb63a576675","name":"","x":1010,"y":400,"wires":[]},{"id":"374eb95dede24266","type":"trigger","z":"24ea4eb63a576675","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"2","extend":false,"units":"min","reset":"off","bytopic":"all","outputs":1,"x":930,"y":640,"wires":[["74428d2e172178fd"]]},{"id":"94b11876f2155a16","type":"change","z":"24ea4eb63a576675","name":"Server door open","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"Server door open","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2250,"y":600,"wires":[["7c5c2122b82a1513"]]},{"id":"74428d2e172178fd","type":"trigger","z":"24ea4eb63a576675","name":"","op1":"","op2":"1","op1type":"num","op2type":"str","duration":"-5","extend":false,"units":"min","reset":"off","bytopic":"all","outputs":1,"x":1110,"y":620,"wires":[["b897b6fb2c05aa71"]]},{"id":"ec82c83693d400b7","type":"server-state-changed","z":"24ea4eb63a576675","name":"Door Server","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.sensor_server_door_contact","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"(on|off)","ifStateType":"re","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":710,"y":620,"wires":[["374eb95dede24266","c4993ad6c39e8aa6"],[]]},{"id":"b897b6fb2c05aa71","type":"api-current-state","z":"24ea4eb63a576675","name":"Aerating?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.aerating_appartment","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1280,"y":620,"wires":[["b0662f83f0a758ae"],[]]},{"id":"dfe8df4adcc3bdbf","type":"api-current-state","z":"24ea4eb63a576675","name":"vacuum","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"docked","halt_if_type":"str","halt_if_compare":"is","entity_id":"vacuum.xiaomi_vacuum_cleaner","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1560,"y":620,"wires":[["e65fe0b2089e0bc8"],[]]},{"id":"e65fe0b2089e0bc8","type":"api-current-state","z":"24ea4eb63a576675","name":"Occupancy Patio","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_patio_motion_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1730,"y":620,"wires":[["2c49fe6e7dc03deb"],[]]},{"id":"0ada7e214e9b1c1c","type":"change","z":"24ea4eb63a576675","name":"Server door open","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"Server door open","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2830,"y":640,"wires":[["7c5c2122b82a1513"]]},{"id":"2c49fe6e7dc03deb","type":"api-current-state","z":"24ea4eb63a576675","name":"Temp","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"17","halt_if_type":"num","halt_if_compare":"lt","entity_id":"sensor.sensor_outside_temperature_temperature","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1910,"y":620,"wires":[["f95987478e497e05"],["3f73532b604b33b2"]]},{"id":"3f73532b604b33b2","type":"trigger","z":"24ea4eb63a576675","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"60","extend":false,"units":"min","reset":"off","bytopic":"all","outputs":1,"x":2090,"y":640,"wires":[["04970ec632c688f4"]]},{"id":"d955a6755a23e6f7","type":"server-state-changed","z":"24ea4eb63a576675","name":"Door Server","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.sensor_server_door_contact","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":1910,"y":660,"wires":[["3f73532b604b33b2"],[]]},{"id":"c4993ad6c39e8aa6","type":"switch","z":"24ea4eb63a576675","name":"","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":910,"y":600,"wires":[["74428d2e172178fd"]]},{"id":"b0662f83f0a758ae","type":"api-current-state","z":"24ea4eb63a576675","name":"Motion","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_server_workstation_motion_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":1410,"y":620,"wires":[["dfe8df4adcc3bdbf"],[]]},{"id":"c28676def1db1c7e","type":"server-state-changed","z":"24ea4eb63a576675","name":"aerating","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.aerating_appartment","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":1900,"y":700,"wires":[["3f73532b604b33b2"],[]]},{"id":"f95987478e497e05","type":"api-current-state","z":"24ea4eb63a576675","name":"Aerating?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.aerating_appartment","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2080,"y":600,"wires":[["94b11876f2155a16"],[]]},{"id":"09816a449ce83c3a","type":"api-current-state","z":"24ea4eb63a576675","name":"Aerating?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.aerating_appartment","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2660,"y":640,"wires":[["0ada7e214e9b1c1c"],[]]},{"id":"99a5faca0d226835","type":"api-current-state","z":"24ea4eb63a576675","name":"Party?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"input_boolean.party_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2510,"y":640,"wires":[["09816a449ce83c3a"],[]]},{"id":"04970ec632c688f4","type":"api-current-state","z":"24ea4eb63a576675","name":"patio door","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_patio_door_contact","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":2380,"y":640,"wires":[["99a5faca0d226835"],[]]},{"id":"7c5c2122b82a1513","type":"subflow:233ac7dcd801a802","z":"24ea4eb63a576675","name":"","x":3030,"y":600,"wires":[]},{"id":"0e3a9592613d851b","type":"server-state-changed","z":"24ea4eb63a576675","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"input_boolean.sleeper_in_patio","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":false,"x":1560,"y":2480,"wires":[["5b7048c95ebb871a"],["36f50d3fcd9e13ff"]]},{"id":"e5ee0836ed9a1209","type":"api-call-service","z":"24ea4eb63a576675","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"toggle","areaId":[],"deviceId":[],"entityId":["input_boolean.sleeper_in_patio"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1230,"y":2480,"wires":[[]]},{"id":"36f50d3fcd9e13ff","type":"api-call-service","z":"24ea4eb63a576675","name":"Patio lights off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_on","areaId":[],"deviceId":[],"entityId":["switch.plug_patio_lights"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1880,"y":2500,"wires":[[]]},{"id":"b50cf9911e5998ea","type":"server-state-changed","z":"24ea4eb63a576675","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":1,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.remote_patio_quiet_button_action","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":630,"y":2480,"wires":[["ec82ac8186da84ee","2b979c35a557d0fc"]]},{"id":"ec82ac8186da84ee","type":"debug","z":"24ea4eb63a576675","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":870,"y":2300,"wires":[]},{"id":"2b979c35a557d0fc","type":"switch","z":"24ea4eb63a576675","name":"click = off ( double) ","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":970,"y":2480,"wires":[["e5ee0836ed9a1209"]],"info":"Just expand the flow.count to how ever many\npresses you want/need."},{"id":"5b7048c95ebb871a","type":"api-call-service","z":"24ea4eb63a576675","name":"Patio lights on","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_off","areaId":[],"deviceId":[],"entityId":["switch.plug_patio_lights"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1880,"y":2460,"wires":[[]]},{"id":"68045bf516d54136","type":"change","z":"24ea4eb63a576675","name":"","rules":[{"t":"set","p":"action","pt":"msg","to":"payload.action","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":440,"y":2920,"wires":[["32589029ab766461","0cf45e3cf47639bc"]]},{"id":"5201a53d06e0df3b","type":"mqtt in","z":"24ea4eb63a576675","name":"","topic":"zigbee2mqtt/remote_patio_dial","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":140,"y":2920,"wires":[["68045bf516d54136","e81abc74dd145ea8"]]},{"id":"e81abc74dd145ea8","type":"debug","z":"24ea4eb63a576675","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":450,"y":2800,"wires":[]},{"id":"32589029ab766461","type":"api-current-state","z":"24ea4eb63a576675","name":"chromecast","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"media_player.patio_chromecast","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"entity","propertyType":"msg","value":"","valueType":"entity"},{"property":"payload.data.entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":670,"y":2920,"wires":[["2e7c0ae2d5bf44e0"],["c71e97589f3ff568"]]},{"id":"2e7c0ae2d5bf44e0","type":"switch","z":"24ea4eb63a576675","name":"","property":"action","propertyType":"msg","rules":[{"t":"neq","v":"","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":980,"y":2880,"wires":[["36bc9361d4ea4a9f"]]},{"id":"36bc9361d4ea4a9f","type":"switch","z":"24ea4eb63a576675","name":"","property":"action","propertyType":"msg","rules":[{"t":"eq","v":"rotate_right","vt":"str"},{"t":"eq","v":"play_pause","vt":"str"},{"t":"eq","v":"rotate_left","vt":"str"},{"t":"eq","v":"skip_forward","vt":"str"},{"t":"eq","v":"skip_backward","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":1100,"y":2880,"wires":[["e63e2fb6e57a9b28"],["28a7825ccc7984f6"],["14b0b7ba2f466a73"],["cb9715d36ee216bb","0cf45e3cf47639bc"],["e84605f373532d67"]]},{"id":"e63e2fb6e57a9b28","type":"api-call-service","z":"24ea4eb63a576675","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_up","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1340,"y":2820,"wires":[[]]},{"id":"28a7825ccc7984f6","type":"api-call-service","z":"24ea4eb63a576675","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_play_pause","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1360,"y":2880,"wires":[[]]},{"id":"14b0b7ba2f466a73","type":"api-call-service","z":"24ea4eb63a576675","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_down","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1340,"y":2920,"wires":[[]]},{"id":"cb9715d36ee216bb","type":"switch","z":"24ea4eb63a576675","name":"","property":"entity.attributes.is_volume_muted","propertyType":"msg","rules":[{"t":"cont","v":"false","vt":"str"},{"t":"cont","v":"true","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1250,"y":2960,"wires":[["3d5c2336620cf7bf"],["367ba297ac6a9f30"]]},{"id":"3d5c2336620cf7bf","type":"api-call-service","z":"24ea4eb63a576675","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\": 1}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1530,"y":2960,"wires":[[]]},{"id":"367ba297ac6a9f30","type":"api-call-service","z":"24ea4eb63a576675","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\": 0}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1530,"y":3000,"wires":[[]]},{"id":"0cf45e3cf47639bc","type":"debug","z":"24ea4eb63a576675","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":1160,"y":3080,"wires":[]},{"id":"c71e97589f3ff568","type":"api-current-state","z":"24ea4eb63a576675","name":"speaker","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"media_player.server_speaker","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"entity","propertyType":"msg","value":"","valueType":"entity"},{"property":"payload.data.entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":840,"y":2920,"wires":[["2e7c0ae2d5bf44e0"]]},{"id":"e84605f373532d67","type":"api-call-service","z":"24ea4eb63a576675","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_next_track","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1350,"y":3040,"wires":[[]]},{"id":"b3f083e4b5b056fa","type":"server-state-changed","z":"24ea4eb63a576675","name":"","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"media_player.patio_chromecast","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"off","halt_if_type":"str","halt_if_compare":"is_not","output_only_on_state_change":true,"x":200,"y":2660,"wires":[["e171d0295745709c","e03fbec62a6059c3"],["a9d644e0b6b0a287"]]},{"id":"2321051455afb1a8","type":"api-call-service","z":"24ea4eb63a576675","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":["media_player.server_speaker"],"data":"{ \"is_volume_muted\": 1}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":750,"y":2600,"wires":[[]]},{"id":"a9d644e0b6b0a287","type":"api-call-service","z":"24ea4eb63a576675","name":"unmute","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":["media_player.server_speaker"],"data":"{ \"is_volume_muted\": 0}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":620,"y":2700,"wires":[[]]},{"id":"e171d0295745709c","type":"switch","z":"24ea4eb63a576675","name":"","property":"entity.new_state.attributes.is_volume_muted","propertyType":"msg","rules":[{"t":"cont","v":"false","vt":"str"},{"t":"cont","v":"true","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":490,"y":2620,"wires":[["2321051455afb1a8"],["a9d644e0b6b0a287"]]},{"id":"e03fbec62a6059c3","type":"debug","z":"24ea4eb63a576675","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":410,"y":2720,"wires":[]},{"id":"343da71f7122bae9","type":"server-state-changed","z":"24ea4eb63a576675","name":"Noise","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"binary_sensor.sound_detected_binary","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":true,"x":250,"y":3460,"wires":[["03e05af9b7a9b8f7"],["c51dc4459bc37f29"]]},{"id":"bf1b0ef28750c1f7","type":"trigger","z":"24ea4eb63a576675","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"15","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":650,"y":3440,"wires":[["53961e7c08f34723"]]},{"id":"c51dc4459bc37f29","type":"change","z":"24ea4eb63a576675","name":"reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"1","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":470,"y":3500,"wires":[["bf1b0ef28750c1f7","53961e7c08f34723"]]},{"id":"b3a33bd5ddf662c1","type":"api-call-service","z":"24ea4eb63a576675","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"tts","service":"google_translate_say","areaId":[],"deviceId":[],"entityId":["media_player.patio_chromecast"],"data":"{\"message\": \"Hey kids, Kindly Lower the Volume\"}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1540,"y":3440,"wires":[[]]},{"id":"56cf401572d5daca","type":"inject","z":"24ea4eb63a576675","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":660,"y":3360,"wires":[["bf1b0ef28750c1f7"]]},{"id":"53961e7c08f34723","type":"trigger","z":"24ea4eb63a576675","name":"","op1":"","op2":"1","op1type":"pay","op2type":"str","duration":"-1","extend":false,"overrideDelay":false,"units":"min","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":890,"y":3440,"wires":[["994589caf181f121"]]},{"id":"ad341169a56b27a0","type":"server-state-changed","z":"24ea4eb63a576675","name":"Noise lvl","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"sensor.sound_level_averaged","entityidfiltertype":"exact","outputinitially":false,"state_type":"str","haltifstate":"0.08","halt_if_type":"num","halt_if_compare":"gt","output_only_on_state_change":true,"x":260,"y":3420,"wires":[["03e05af9b7a9b8f7"],[]]},{"id":"994589caf181f121","type":"api-current-state","z":"24ea4eb63a576675","name":"Party?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.party_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"entity","propertyType":"msg","value":"","valueType":"entity"},{"property":"payload.data.entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1090,"y":3440,"wires":[["33ca6d9a410d31f4"],[]]},{"id":"33ca6d9a410d31f4","type":"api-current-state","z":"24ea4eb63a576675","name":"Occupied?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.patio_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"entity","propertyType":"msg","value":"","valueType":"entity"},{"property":"payload.data.entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":1290,"y":3440,"wires":[["b3a33bd5ddf662c1"],[]]},{"id":"190f2d82d00997ab","type":"comment","z":"24ea4eb63a576675","name":"","info":"","x":220,"y":2580,"wires":[]},{"id":"40177ad21b288b49","type":"comment","z":"24ea4eb63a576675","name":"","info":"","x":260,"y":2920,"wires":[]},{"id":"3b98fd6078525109","type":"comment","z":"24ea4eb63a576675","name":"Detect when the server door is left open and broadcast regular alerts based on current temperature","info":"","x":980,"y":560,"wires":[]},{"id":"cc1485aedb0aa622","type":"server-state-changed","z":"ab060e89aa02a122","name":"Noise detector goes on","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.ffmpeg_noise","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":520,"y":840,"wires":[["d1161d2e4a1772a2"],[]]},{"id":"d1161d2e4a1772a2","type":"api-current-state","z":"ab060e89aa02a122","name":"Party mode on?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.party_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":720,"y":840,"wires":[["01da0996b379bcb7"],[]]},{"id":"01da0996b379bcb7","type":"api-current-state","z":"ab060e89aa02a122","name":"Patio occupied?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"binary_sensor.sensor_patio_occupancy","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":900,"y":840,"wires":[["94081c182ed022fc"],[]]},{"id":"94081c182ed022fc","type":"function","z":"ab060e89aa02a122","name":"Notification setter Facecam","func":"var newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"title\": \"Noise Alert\",\n\t\t\t\"message\": \"People on the patio are too noisy\",\n\t\t}\n\t}\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1180,"y":840,"wires":[["29bb36da4f79228d"]]},{"id":"29bb36da4f79228d","type":"api-call-service","z":"ab060e89aa02a122","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_fold4","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1490,"y":840,"wires":[[]]},{"id":"efcdbfba4761cb6c","type":"server-state-changed","z":"ab060e89aa02a122","name":"Sleeper in patio on","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.sleeper_in_patio","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":510,"y":720,"wires":[["0146b1fcea8616ab"],[]]},{"id":"0146b1fcea8616ab","type":"api-call-service","z":"ab060e89aa02a122","name":"Patio Light off","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":["light.group_patio_lights"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":740,"y":720,"wires":[[]]},{"id":"5675af2cb51ab0ca","type":"comment","z":"ab060e89aa02a122","name":"Alert me when people are too noisy on the patio during a party ","info":"","x":640,"y":800,"wires":[]},{"id":"c0cc95a13a9ac42e","type":"server-state-changed","z":"ab060e89aa02a122","name":"Sleeper in patio off","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"input_boolean.sleeper_in_patio","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"off","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":510,"y":620,"wires":[["14f348ac3946e1b2"],[]]},{"id":"14f348ac3946e1b2","type":"api-call-service","z":"ab060e89aa02a122","name":"Patio Light On","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":["light.group_patio_lights"],"data":"{\"color_name\":\"white\",\"brightness_pct\": \"100\",\"transition\": \"60\" }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":740,"y":620,"wires":[[]]},{"id":"76882583465105ba","type":"comment","z":"ab060e89aa02a122","name":"Turn lights off when someone goes to sleep on the patio","info":"","x":630,"y":680,"wires":[]},{"id":"75cdd3c79c389841","type":"comment","z":"ab060e89aa02a122","name":"Turn lights on when someone turns off sleeper on patio","info":"","x":620,"y":580,"wires":[]},{"id":"0099039ff15e011c","type":"trigger","z":"ab060e89aa02a122","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"15","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":910,"y":1020,"wires":[["093ad6f9ed217e99"]]},{"id":"1f0362c46f576f74","type":"comment","z":"ab060e89aa02a122","name":"15 seconds cooldown","info":"","x":900,"y":980,"wires":[]},{"id":"093ad6f9ed217e99","type":"ha-get-entities","z":"ab060e89aa02a122","name":"Get  patio group entities","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"light.group_patio_lights","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1170,"y":1020,"wires":[["9b0e54d1e3838e88"]]},{"id":"daa74f11a5ecf0b7","type":"comment","z":"ab060e89aa02a122","name":"Try to Pull all lit single groups","info":"","x":1140,"y":980,"wires":[]},{"id":"e1f87028ed72d917","type":"server-state-changed","z":"ab060e89aa02a122","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_button.patio_generate_fake_white","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":620,"y":1020,"wires":[["0099039ff15e011c"]]},{"id":"2e0ae371060cc06a","type":"comment","z":"ab060e89aa02a122","name":"Change light to fake white on press ","info":"","x":560,"y":980,"wires":[]},{"id":"9b0e54d1e3838e88","type":"switch","z":"ab060e89aa02a122","name":"","property":"payload.attributes.supported_color_modes","propertyType":"msg","rules":[{"t":"regex","v":"(xy|hs)","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":1390,"y":1020,"wires":[["975d9f268834fef4"]]},{"id":"9380095aca34c230","type":"comment","z":"ab060e89aa02a122","name":"Check for color support","info":"","x":1380,"y":980,"wires":[]},{"id":"e1c2a3fe513f176c","type":"api-call-service","z":"ab060e89aa02a122","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2450,"y":1020,"wires":[[]]},{"id":"b22a828cc711a2f2","type":"comment","z":"ab060e89aa02a122","name":"Generated random colors that equate to white","info":"","x":1670,"y":980,"wires":[]},{"id":"0ec5214a524e9de6","type":"comment","z":"ab060e89aa02a122","name":"Call light_on service","info":"","x":2450,"y":980,"wires":[]},{"id":"975d9f268834fef4","type":"function","z":"ab060e89aa02a122","name":"Generate fake white","func":"\nlet entity_ids = msg.payload.attributes.entity_id;\n\nlet complementaryColors = generateRandomComplementaryColors( entity_ids);\n\n\nfunction generateRandomComplementaryColors(entity_ids) {\n    let complementaryColors = [];\n    let numColors = entity_ids.length;\n    let h = Math.floor(Math.random() * 360);\n    let s = 100;\n    for (let i = 0; i < numColors; i++) {\n        h = (h + (360 / numColors)) % 360;\n        complementaryColors.push({ entity_id: entity_ids[i].toString(), hs_color: [h, s] });\n    }\n    return complementaryColors;\n}\n\n\nvar newMsg = {\"payload\":    complementaryColors \n\n           };\n\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1640,"y":1020,"wires":[["8fb8173ab905bcef"]]},{"id":"8fb8173ab905bcef","type":"split","z":"ab060e89aa02a122","name":"Split entities","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1950,"y":1020,"wires":[["dcd1d41cefb2544d"]]},{"id":"dcd1d41cefb2544d","type":"change","z":"ab060e89aa02a122","name":"","rules":[{"t":"move","p":"payload","pt":"msg","to":"payload.data","tot":"msg"},{"t":"set","p":"payload.data.brightness_pct","pt":"msg","to":"100","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2200,"y":1020,"wires":[["e1c2a3fe513f176c"]]},{"id":"840e324b2fdd4b44","type":"trigger","z":"ab060e89aa02a122","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":920,"y":1160,"wires":[["73b28b623aa14a5b"]]},{"id":"25afa308be753908","type":"comment","z":"ab060e89aa02a122","name":"15 seconds cooldown","info":"","x":920,"y":1120,"wires":[]},{"id":"73b28b623aa14a5b","type":"ha-get-entities","z":"ab060e89aa02a122","name":"Get  Light entities","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"light.patio_string_bulb_\\d*","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1150,"y":1160,"wires":[["502859e679d79a11"]]},{"id":"a24f33e4441fba3a","type":"comment","z":"ab060e89aa02a122","name":"Try to Pull all patio lights","info":"","x":1130,"y":1120,"wires":[]},{"id":"65b1bc05f44f3327","type":"server-state-changed","z":"ab060e89aa02a122","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_button.patio_generate_pastel_colors","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"0","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":630,"y":1160,"wires":[["840e324b2fdd4b44"]]},{"id":"044904d035161d0c","type":"comment","z":"ab060e89aa02a122","name":"Change patio light to random pastel colors on press","info":"","x":610,"y":1120,"wires":[]},{"id":"502859e679d79a11","type":"switch","z":"ab060e89aa02a122","name":"","property":"payload.attributes.supported_color_modes","propertyType":"msg","rules":[{"t":"regex","v":"(xy|hs)","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":1390,"y":1160,"wires":[["b8f1c15b2cad9c22"]]},{"id":"610cd74b35da7a80","type":"comment","z":"ab060e89aa02a122","name":"Check for color support","info":"","x":1380,"y":1120,"wires":[]},{"id":"adc4464aa3291cdf","type":"function","z":"ab060e89aa02a122","name":"Generate Random pastel color","func":"var entity_id = msg.payload.entity_id;\n\n\nvar hue = Math.floor(Math.random() * 360); //generate a random number up to 360\n\nvar hs_color = hue + \",45\";\nvar hs_color_array = hs_color.split(\",\");\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"hs_color\": hs_color_array,\n            \"entity_id\": entity_id,\n            \"brightness_pct\": 100\n            \n}\n        }\n    }\n;\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1910,"y":1160,"wires":[["93b689ccaa0f2e94"]]},{"id":"93b689ccaa0f2e94","type":"api-call-service","z":"ab060e89aa02a122","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2210,"y":1160,"wires":[["05a3524e15348ab6"]]},{"id":"7721c569794a2174","type":"comment","z":"ab060e89aa02a122","name":"Generated random HS 55% saturated color","info":"","x":1920,"y":1120,"wires":[]},{"id":"c9a0787109a493db","type":"comment","z":"ab060e89aa02a122","name":"Call light_on service","info":"","x":2210,"y":1120,"wires":[]},{"id":"b8f1c15b2cad9c22","type":"switch","z":"ab060e89aa02a122","name":"Exclude groups","property":"payload.attributes.entity_id","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","repair":false,"outputs":1,"x":1620,"y":1160,"wires":[["adc4464aa3291cdf"]]},{"id":"2a5a856a1e557215","type":"comment","z":"ab060e89aa02a122","name":"Exclude groups","info":"","x":1580,"y":1120,"wires":[]},{"id":"05a3524e15348ab6","type":"trigger","z":"ab060e89aa02a122","name":"","op1":"","op2":"1","op1type":"nul","op2type":"str","duration":"1","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2400,"y":1160,"wires":[[]]},{"id":"38c9cc964ee62995","type":"trigger","z":"ab060e89aa02a122","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"15","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":950,"y":1280,"wires":[["b5c72a2fc1db9a4e"]]},{"id":"44bb3a4bd52bdec0","type":"comment","z":"ab060e89aa02a122","name":"15 seconds cooldown","info":"","x":900,"y":1240,"wires":[]},{"id":"b5c72a2fc1db9a4e","type":"ha-get-entities","z":"ab060e89aa02a122","name":"Get  Light entities","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"light.patio_string_bulb_\\d*","valueType":"re"},{"property":"state","logic":"is","value":"on","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1150,"y":1280,"wires":[["2fbab02f2fc4357c"]]},{"id":"5ef51b1c2d41fbeb","type":"comment","z":"ab060e89aa02a122","name":"Try to Pull all lit single lights","info":"","x":1140,"y":1240,"wires":[]},{"id":"2fbab02f2fc4357c","type":"switch","z":"ab060e89aa02a122","name":"","property":"payload.attributes.supported_color_modes","propertyType":"msg","rules":[{"t":"regex","v":"(xy|hs)","vt":"str","case":false}],"checkall":"true","repair":false,"outputs":1,"x":1390,"y":1280,"wires":[["50d29ea8184d6455"]]},{"id":"80923978a4b69518","type":"comment","z":"ab060e89aa02a122","name":"Check for color support","info":"","x":1380,"y":1240,"wires":[]},{"id":"6c6bc0ba79443e42","type":"function","z":"ab060e89aa02a122","name":"Generate Random saturated color","func":"var entity_id = msg.payload.entity_id;\n\n\nvar hue = Math.floor(Math.random() * 360); //generate a random number up to 360\n\nvar hs_color = hue + \",100\";\nvar hs_color_array = hs_color.split(\",\");\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"hs_color\": hs_color_array,\n            \"entity_id\": entity_id,\n            \"brightness_pct\": 100\n            \n}\n        }\n    }\n;\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1920,"y":1280,"wires":[["29ef8a9058b12acd"]]},{"id":"29ef8a9058b12acd","type":"api-call-service","z":"ab060e89aa02a122","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2210,"y":1280,"wires":[[]]},{"id":"8f5b211da2e1e50f","type":"comment","z":"ab060e89aa02a122","name":"Generated random HS 100% saturated color","info":"","x":1930,"y":1240,"wires":[]},{"id":"5c503a932a492d04","type":"comment","z":"ab060e89aa02a122","name":"Call light_on service","info":"","x":2210,"y":1240,"wires":[]},{"id":"50d29ea8184d6455","type":"switch","z":"ab060e89aa02a122","name":"Exclude groups","property":"payload.attributes.entity_id","propertyType":"msg","rules":[{"t":"null"}],"checkall":"true","repair":false,"outputs":1,"x":1620,"y":1280,"wires":[["6c6bc0ba79443e42"]]},{"id":"0949dc9b123d2530","type":"comment","z":"ab060e89aa02a122","name":"Exclude groups","info":"","x":1580,"y":1240,"wires":[]},{"id":"8f9b80223b19cdaf","type":"server-state-changed","z":"ab060e89aa02a122","name":"","server":"7ab5c227.a3ce8c","version":5,"outputs":1,"exposeAsEntityConfig":"","entityId":"input_button.patio_generate_random_colors","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":"","forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":640,"y":1280,"wires":[["38c9cc964ee62995"]]},{"id":"aaab7740668ec67d","type":"comment","z":"ab060e89aa02a122","name":"Change light to random colors on press","info":"","x":570,"y":1240,"wires":[]},{"id":"64c326277e598dcd","type":"server-events","z":"450c81641a10c42d","name":"","server":"7ab5c227.a3ce8c","version":3,"exposeAsEntityConfig":"","eventType":"mobile_app_notification_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":370,"y":80,"wires":[["d9da3f994551ca6c"]]},{"id":"d9da3f994551ca6c","type":"switch","z":"450c81641a10c42d","name":"Enter text?","property":"payload.event.action_1_title","propertyType":"msg","rules":[{"t":"eq","v":"Enter Text","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":670,"y":80,"wires":[["1ffef80cf9b50e60"]]},{"id":"e38a31f12e417ca3","type":"function","z":"450c81641a10c42d","name":"Javascript code","func":"var text = msg.payload.event.reply_text;\n\n\n\nvar newMsg = {\n    \"text\": msg.payload.event.image,\n    \"payload\": {\n        \"data\": {\n            \"value\": text\n        }\n    }\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1160,"y":80,"wires":[["1659698d4abd266c"]]},{"id":"1659698d4abd266c","type":"api-call-service","z":"450c81641a10c42d","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.front_door_phone_text"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1480,"y":80,"wires":[["447fe301a941b8f3"]]},{"id":"7406062f8995db1c","type":"api-call-service","z":"450c81641a10c42d","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.front_door_phone_text"],"data":"{\"value\":\"Empty\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1960,"y":80,"wires":[[]]},{"id":"1ffef80cf9b50e60","type":"switch","z":"450c81641a10c42d","name":"Reply function?","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"REPLY","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":920,"y":80,"wires":[["e38a31f12e417ca3"]]},{"id":"447fe301a941b8f3","type":"ha-wait-until","z":"450c81641a10c42d","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"locked","valueType":"str","timeout":"120","timeoutType":"num","timeoutUnits":"seconds","checkCurrentState":false,"blockInputOverrides":true,"outputProperties":[],"entityLocation":"data","entityLocationType":"none","x":1700,"y":80,"wires":[["7406062f8995db1c"],["7406062f8995db1c"]]},{"id":"c0f99e79c11a8afe","type":"api-call-service","z":"450c81641a10c42d","name":"Turn on Door Rang","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.door_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"1","valueType":"str"}],"queue":"none","x":410,"y":1280,"wires":[[]]},{"id":"b096c4dadcba5f39","type":"api-call-service","z":"450c81641a10c42d","name":"Save faceshot image For Processing","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.faceshot_go2rtc"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":850,"y":1340,"wires":[["60905036d5e0e18f"]]},{"id":"1ad406d0cb57b30c","type":"function","z":"450c81641a10c42d","name":"Set filename to timestamp.jpg","func":"var timestamp = Date.now();\n\nvar newMsg = {\n    \"payload\": {\n        \"data\": { \"filename\": \"/config/www/facecam/\" + timestamp + \".jpg\" }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":1340,"wires":[["b096c4dadcba5f39","7d939edc1204269c"]]},{"id":"60905036d5e0e18f","type":"function","z":"450c81641a10c42d","name":"Convert path to http path","func":"var path = msg.payload.data.filename;\nvar http_path = path.replace('/config/www/', 'http://192.168.0.14:3000/api/recognize?url=http://192.168.0.15:8123/local/');\n\nvar newMsg = { \n    \"url\": http_path + \"&camera=faceshot\"\n        \n};\nreturn newMsg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1150,"y":1340,"wires":[["05f8cef37c645940"]]},{"id":"05f8cef37c645940","type":"http request","z":"450c81641a10c42d","name":"GET request with link to current image on faceshot camera","method":"GET","ret":"obj","paytoqs":"query","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1580,"y":1340,"wires":[["1b2009d7457c414d","a757e9e084a63171"]]},{"id":"c5a435a10e0237a1","type":"function","z":"450c81641a10c42d","name":"JavascriptNotification setter Reolink","func":"var name = \"Someone\";\nvar url = msg.frontdoor.responseUrl.split('?');\nvar url2 = url[1].replace('url=http://192.168.0.15:8123/', 'https://hass.purgatoire.ca/').split('&');\nvar urlfinal = url2[0];\n\nvar random = Date.now();\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"sticky\": 'true',\n\t\t\t\t\"clickAction\": '/phone-landing/reolink?kiosk=1',\n\t\t\t\t\"priority\": 'high',\n\t\t\t\t\"image\": urlfinal + \"?\" + random,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\t\"title\": \"Enter Text\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;\n\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3900,"y":1420,"wires":[["a6ee972424e25404","b6b9cbbb3d9f7d31"]]},{"id":"2929b2bc450dd368","type":"switch","z":"450c81641a10c42d","name":"confidence over 80%?","property":"matches[0].confidence","propertyType":"msg","rules":[{"t":"gt","v":"80","vt":"num"},{"t":"lt","v":"80","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":2640,"y":1280,"wires":[["96070bddb26b6c9e"],["cafb1e589f35c470"]]},{"id":"7d7bac7229fbc3a3","type":"comment","z":"450c81641a10c42d","name":"No","info":"","x":2650,"y":1380,"wires":[]},{"id":"128c9da2f61e9a86","type":"change","z":"450c81641a10c42d","name":"Set Data for mass alert","rules":[{"t":"move","p":"payload.data.title","pt":"msg","to":"message","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"},{"t":"set","p":"video","pt":"msg","to":"on","tot":"str"},{"t":"set","p":"video_content","pt":"msg","to":"payload.data.data.image","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":4480,"y":1400,"wires":[["32883d3e798a674f"]]},{"id":"18941321b47b01a9","type":"subflow:233ac7dcd801a802","z":"450c81641a10c42d","name":"","x":4910,"y":1380,"wires":[]},{"id":"72b7a8fc72115492","type":"api-current-state","z":"450c81641a10c42d","name":"Acid time off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.acid_time","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3210,"y":1260,"wires":[["8a3c016bfb720319"],["9a3c4deebc1f79d4"]]},{"id":"8a3c016bfb720319","type":"api-current-state","z":"450c81641a10c42d","name":"kink off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.kink_party","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3380,"y":1260,"wires":[["cbe71e8c31c91a64"],["50c10993b072d895"]]},{"id":"54a07d5786c0af49","type":"api-current-state","z":"450c81641a10c42d","name":"Waiting Friend?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.waiting_someone","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":3700,"y":1280,"wires":[["19e1dce6a1046296"],["149f29c5ca6bc3f3"]]},{"id":"cbe71e8c31c91a64","type":"api-current-state","z":"450c81641a10c42d","name":"Party on","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.party_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3540,"y":1260,"wires":[["1e06a97fc5de2f98"],["54a07d5786c0af49"]]},{"id":"f422810e7e1914b6","type":"api-current-state","z":"450c81641a10c42d","name":"Waiting Uber off","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"on","halt_if_type":"str","halt_if_compare":"is_not","entity_id":"input_boolean.waiting_uber","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":3000,"y":1260,"wires":[["72b7a8fc72115492"],["af19fdacd71359c6"]]},{"id":"cabc1736dc584d7d","type":"api-current-state","z":"450c81641a10c42d","name":"Maxi is present in the front","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"(office|closet)","halt_if_type":"re","halt_if_compare":"is","entity_id":"sensor.maxi_location","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"partyon","propertyType":"msg","value":"","valueType":"entityState"},{"property":"partydata","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","x":3940,"y":1260,"wires":[["3833068b40c659e5","61c0ad6a1211de3c","c20f9c4e8982d2cf","4e382e238eace54a"],["464cb39e0f997312"]]},{"id":"f319f8df438f1828","type":"comment","z":"450c81641a10c42d","name":"No","info":"","x":3010,"y":1300,"wires":[]},{"id":"a1030f85d7a7b137","type":"comment","z":"450c81641a10c42d","name":"No","info":"","x":3190,"y":1300,"wires":[]},{"id":"c4c57a99a656baf9","type":"comment","z":"450c81641a10c42d","name":"No","info":"","x":3370,"y":1300,"wires":[]},{"id":"d64aa4088012144a","type":"comment","z":"450c81641a10c42d","name":"No","info":"","x":3950,"y":1340,"wires":[]},{"id":"4e382e238eace54a","type":"function","z":"450c81641a10c42d","name":"Notif setter (let in)","func":"var name = msg.matches[0].name;\nvar url = msg.responseUrl.split('?');\nvar url2 = url[1].replace('url=http://192.168.0.15:8123/', 'https://hass.purgatoire.ca/').split('&');\nvar urlfinal = url2[0];\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is being let in\",\n\t\t\t\"data\": {\n\t\t\t\t\"sticky\": 'true',\n\t\t\t\t\"clickAction\": '/phone-landing/reolink?kiosk=1',\n\t\t\t\t\"priority\": 'high',\n\t\t\t\t\"image\": urlfinal\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4210,"y":1260,"wires":[["21c8c9ef879dd219"]]},{"id":"99828ddfbdbdbcd6","type":"change","z":"450c81641a10c42d","name":"Set Data for mass alert","rules":[{"t":"move","p":"payload.data.title","pt":"msg","to":"message","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[200,200.0]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"},{"t":"set","p":"video","pt":"msg","to":"on","tot":"str"},{"t":"set","p":"video_content","pt":"msg","to":"payload.data.data.image","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":4480,"y":1360,"wires":[["32883d3e798a674f"]]},{"id":"3833068b40c659e5","type":"function","z":"450c81641a10c42d","name":"Name Payload","func":"var name = msg.matches[0].name;\n\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"value\": name\n        }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4200,"y":1220,"wires":[["d51e645dedb4637b"]]},{"id":"bc0edcf904abdb95","type":"api-call-service","z":"450c81641a10c42d","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4700,"y":1220,"wires":[[]]},{"id":"cbcf55f52da90504","type":"comment","z":"450c81641a10c42d","name":"No","info":"","x":3730,"y":1320,"wires":[]},{"id":"8d97603bce8b64bb","type":"api-call-service","z":"450c81641a10c42d","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_fold4","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4650,"y":1280,"wires":[["7a681aa6f5a6c94c"]]},{"id":"b6e59cd9595ed79c","type":"api-call-service","z":"450c81641a10c42d","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"mobile_app_phone_fold4","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4670,"y":1460,"wires":[["7dfcb7d8a254db2a"]]},{"id":"a31229c83d998a1a","type":"server-state-changed","z":"450c81641a10c42d","name":"Doorbell","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"sensor.remote_doorbell_button_action","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"single","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":60,"y":1340,"wires":[["7eaa4e1be97de177"],[]]},{"id":"82a9919e4680d971","type":"comment","z":"450c81641a10c42d","name":"Receive the actionable notification","info":"","x":360,"y":40,"wires":[]},{"id":"77e91b817ef5acf7","type":"comment","z":"450c81641a10c42d","name":"Check if the action is \"enter text\"","info":"","x":670,"y":40,"wires":[]},{"id":"a1a3cebdf8ffe30c","type":"comment","z":"450c81641a10c42d","name":"Confirm that this is a reply","info":"","x":910,"y":40,"wires":[]},{"id":"6d202afea355b26a","type":"comment","z":"450c81641a10c42d","name":"Set the text as the data value","info":"","x":1180,"y":40,"wires":[]},{"id":"30a94d4d8ba45924","type":"comment","z":"450c81641a10c42d","name":"Set the phone screen text","info":"","x":1470,"y":40,"wires":[]},{"id":"97d555b41a081a9a","type":"comment","z":"450c81641a10c42d","name":"Reset the phone screen text","info":"","x":1960,"y":40,"wires":[]},{"id":"7e36b02423ed5780","type":"comment","z":"450c81641a10c42d","name":"Wait till door locks","info":"","x":1710,"y":40,"wires":[]},{"id":"7d5af98421225e69","type":"switch","z":"450c81641a10c42d","name":"'Who is this?'?","property":"payload.event.action_1_title","propertyType":"msg","rules":[{"t":"eq","v":"Who is this?","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":620,"y":220,"wires":[["92086f4b0cddef66"]]},{"id":"9a56d9a48613392f","type":"function","z":"450c81641a10c42d","name":"Javascript","func":"var name = msg.data.event.reply_text;\n\nvar newMsg = {\n \"url\": \"http://192.168.0.14:3000/api/train/retrain/\" + name,\n \"data\": msg.data\n };\n\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1640,"y":220,"wires":[["5b3a71af383f3e88"]]},{"id":"c4c2882ea1e0c324","type":"server-events","z":"450c81641a10c42d","name":"","server":"7ab5c227.a3ce8c","version":3,"exposeAsEntityConfig":"","eventType":"mobile_app_notification_action","eventData":"","waitForRunning":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"},{"property":"event_type","propertyType":"msg","value":"$outputData(\"eventData\").event_type","valueType":"jsonata"}],"x":350,"y":220,"wires":[["7d5af98421225e69"]]},{"id":"5b3a71af383f3e88","type":"http request","z":"450c81641a10c42d","name":"HTTP request","method":"GET","ret":"txt","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1960,"y":220,"wires":[["fbe6702c9c2ef8a5","c1e1f7400ca4a9b1"]]},{"id":"fbe6702c9c2ef8a5","type":"function","z":"450c81641a10c42d","name":"Javascript","func":"var snapshot = msg.data.event.image;\nvar name = msg.data.event.reply_text;\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n  \"message\": \"Faces learning for\" + \" \" + name,\n  \"data\": {\n    \"image\": snapshot\n  }\n}\n }\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2190,"y":220,"wires":[["ecb2c917f34c8209"]]},{"id":"ecb2c917f34c8209","type":"api-call-service","z":"450c81641a10c42d","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"notify","service":"notify","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2430,"y":220,"wires":[[]]},{"id":"92086f4b0cddef66","type":"switch","z":"450c81641a10c42d","name":"","property":"payload.event.action","propertyType":"msg","rules":[{"t":"eq","v":"REPLY","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":910,"y":220,"wires":[["2162299248bfc1b7"]]},{"id":"c64d9ed7449de049","type":"exec","z":"450c81641a10c42d","command":"","addpay":"command","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"Command wget ","x":1400,"y":220,"wires":[["9a56d9a48613392f"],[],[]]},{"id":"2162299248bfc1b7","type":"function","z":"450c81641a10c42d","name":"Javascript","func":"var image = msg.payload.event.image;\nvar name = msg.payload.event.reply_text;\nvar newMsg = {\n    \"command\": \"mkdir \" + \"/config/www/doubletake/\" + name + \";wget \" + image  + \" -P /config/www/doubletake/\" + name,\n    \"data\": msg.payload\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1160,"y":220,"wires":[["c64d9ed7449de049"]]},{"id":"cc8a04e83d793ac9","type":"comment","z":"450c81641a10c42d","name":"Receive the actionable notification","info":"","x":340,"y":180,"wires":[]},{"id":"d44564743e5c8b0e","type":"comment","z":"450c81641a10c42d","name":"Check if the action is \"Who is this?\"","info":"","x":640,"y":180,"wires":[]},{"id":"85dfa9b62c0fa7c7","type":"comment","z":"450c81641a10c42d","name":"Confirm that this is a reply","info":"","x":890,"y":180,"wires":[]},{"id":"7996f5f43b656f29","type":"comment","z":"450c81641a10c42d","name":"Set WGET command","info":"This requires to have a folder that is mounted on the Double-take machine and linked to the .storage/train folder","x":1160,"y":180,"wires":[]},{"id":"93333520d588e4e2","type":"comment","z":"450c81641a10c42d","name":"Call Wget command","info":"","x":1390,"y":180,"wires":[]},{"id":"2df6bced72655465","type":"comment","z":"450c81641a10c42d","name":"Set GET command to train on new images","info":"","x":1660,"y":180,"wires":[]},{"id":"4f381e20f259850e","type":"comment","z":"450c81641a10c42d","name":"LAunch the GET command","info":"","x":1950,"y":180,"wires":[]},{"id":"5d62fb0b5e7396cd","type":"comment","z":"450c81641a10c42d","name":"Set notification message","info":"","x":2190,"y":180,"wires":[]},{"id":"e0703e656d7adf08","type":"comment","z":"450c81641a10c42d","name":"confirm the images are ingressed ","info":"","x":2450,"y":180,"wires":[]},{"id":"abbeeaa80a7faea6","type":"comment","z":"450c81641a10c42d","name":"Check for doorbell events","info":"","x":130,"y":1300,"wires":[]},{"id":"cb7ec906f237ece7","type":"comment","z":"450c81641a10c42d","name":"This takes care of the phone door welcome text","info":"","x":500,"y":1240,"wires":[]},{"id":"d7214089b00ab89f","type":"comment","z":"450c81641a10c42d","name":"Set the desired timestamp","info":"","x":450,"y":1380,"wires":[]},{"id":"381de1a0cc1e483a","type":"comment","z":"450c81641a10c42d","name":"Call the snapshot function","info":"","x":830,"y":1380,"wires":[]},{"id":"82c911781c9c12de","type":"comment","z":"450c81641a10c42d","name":"Set url for HTML callback","info":"","x":1170,"y":1380,"wires":[]},{"id":"3d49a535ef2b4dac","type":"comment","z":"450c81641a10c42d","name":"This calls double-take with our image and looks for a match","info":"","x":1570,"y":1300,"wires":[]},{"id":"78e3db5e7ee67034","type":"comment","z":"450c81641a10c42d","name":"Those set the two notifications ( one per cam)","info":"","x":3910,"y":1380,"wires":[]},{"id":"c087d16d86c3397c","type":"comment","z":"450c81641a10c42d","name":"Here we have the inside broadcasts","info":"","x":4860,"y":1340,"wires":[]},{"id":"dc949857755b4c3a","type":"inject","z":"450c81641a10c42d","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":4240,"y":1020,"wires":[[]]},{"id":"7eaa4e1be97de177","type":"delay","z":"450c81641a10c42d","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"30","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":220,"y":1340,"wires":[["1ad406d0cb57b30c","c0f99e79c11a8afe"]]},{"id":"78dc3c650c8dc2ca","type":"delay","z":"450c81641a10c42d","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":4430,"y":1280,"wires":[["8d97603bce8b64bb"]]},{"id":"789d2e65e771e941","type":"delay","z":"450c81641a10c42d","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":4450,"y":1460,"wires":[["b6e59cd9595ed79c"]]},{"id":"61c0ad6a1211de3c","type":"ha-wait-until","z":"450c81641a10c42d","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"input_boolean.face_recognized","entityIdFilterType":"exact","property":"state","comparator":"is_not","value":"UNKNOWN","valueType":"str","timeout":"2","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":4180,"y":1180,"wires":[["2715d2fa9a416117"],[]]},{"id":"2715d2fa9a416117","type":"api-call-service","z":"450c81641a10c42d","name":"unLock Door","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"lock","service":"unlock","areaId":[],"deviceId":[],"entityId":["lock.lock_front_door"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"1","valueType":"str"}],"queue":"none","x":4370,"y":1180,"wires":[[]]},{"id":"c1e1f7400ca4a9b1","type":"function","z":"450c81641a10c42d","name":"Name Payload","func":"var name = msg.data.event.reply_text;\n\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"value\": name\n        }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2200,"y":300,"wires":[["e006b7220963bd05"]]},{"id":"e006b7220963bd05","type":"api-call-service","z":"450c81641a10c42d","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2400,"y":300,"wires":[["92daef79e0bacfea"]]},{"id":"92daef79e0bacfea","type":"ha-wait-until","z":"450c81641a10c42d","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"input_text.recognized_face","entityIdFilterType":"exact","property":"state","comparator":"is_not","value":"UNKNOWN","valueType":"str","timeout":"2","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"unlock","valueType":"str"},{"property":"data","propertyType":"msg","value":"","valueType":"str"}],"x":2640,"y":300,"wires":[["f91b9dda5f1e9458","154770427fb7e553"],[]]},{"id":"f91b9dda5f1e9458","type":"api-call-service","z":"450c81641a10c42d","name":"unLock Door","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"lock","service":"unlock","areaId":[],"deviceId":[],"entityId":["lock.lock_front_door"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"1","valueType":"str"}],"queue":"none","x":2850,"y":300,"wires":[[]]},{"id":"af8d08f7992d25cf","type":"inject","z":"450c81641a10c42d","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":120,"y":1400,"wires":[["7eaa4e1be97de177"]]},{"id":"026da4d507207193","type":"trigger-state","z":"450c81641a10c42d","g":"daa042542b94f545","name":"Locked and Recognized","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"lock.lock_front_door","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"locked"},{"targetType":"entity_id","targetValue":"input_boolean.face_recognized","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":280,"y":420,"wires":[["5d870c3cae125238"],[]]},{"id":"5d870c3cae125238","type":"api-call-service","z":"450c81641a10c42d","g":"daa042542b94f545","name":"Turn off \"Face Recognized\"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":599,"y":418,"wires":[[]]},{"id":"21e884512b585c28","type":"trigger-state","z":"450c81641a10c42d","g":"daa042542b94f545","name":"Locked and Rang","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"lock.lock_front_door","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"locked"},{"targetType":"entity_id","targetValue":"input_boolean.door_rang","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":260,"y":480,"wires":[["a6411babbdf53e5b"],[]]},{"id":"a6411babbdf53e5b","type":"api-call-service","z":"450c81641a10c42d","g":"daa042542b94f545","name":"Turn off \"Door rang\"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.door_double_rang","input_boolean.door_rang"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":579,"y":478,"wires":[[]]},{"id":"154770427fb7e553","type":"api-call-service","z":"450c81641a10c42d","name":"toggle boolean","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.face_recognized","input_boolean.waiting_someone"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2860,"y":260,"wires":[[]]},{"id":"c20f9c4e8982d2cf","type":"debug","z":"450c81641a10c42d","name":"debug 259","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3970,"y":980,"wires":[]},{"id":"36616d1ccd9b6c9e","type":"api-call-service","z":"450c81641a10c42d","g":"daa042542b94f545","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.recognized_face"],"data":" {             \"value\": \"UNKNOWN\"         }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":580,"y":540,"wires":[[]]},{"id":"57ac30854bd6c1c8","type":"trigger-state","z":"450c81641a10c42d","g":"daa042542b94f545","name":"Locked and Recoed name","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"lock.lock_front_door","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"locked"},{"targetType":"entity_id","targetValue":"input_text.recognized_face","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is_not","comparatorValueDatatype":"str","comparatorValue":"UNKNOWN"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":290,"y":540,"wires":[["36616d1ccd9b6c9e"],[]]},{"id":"f94192aa45f7dba1","type":"trigger-state","z":"450c81641a10c42d","g":"daa042542b94f545","name":"Locked and Waiting","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"lock.lock_front_door","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"locked"},{"targetType":"entity_id","targetValue":"input_boolean.waiting_someone","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":270,"y":380,"wires":[["6423b2c425560d42"],[]]},{"id":"6423b2c425560d42","type":"api-call-service","z":"450c81641a10c42d","g":"daa042542b94f545","name":"Turn off \"Waiting someone\"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.waiting_someone"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":599,"y":378,"wires":[[]]},{"id":"d0a4cc0dbf14f69d","type":"api-call-service","z":"450c81641a10c42d","g":"daa042542b94f545","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"input_text","service":"set_value","areaId":[],"deviceId":[],"entityId":["input_text.front_door_phone_text"],"data":" {             \"value\": \"Empty\"         }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":580,"y":580,"wires":[[]]},{"id":"f27991bfbd64b9b9","type":"trigger-state","z":"450c81641a10c42d","g":"daa042542b94f545","name":"Locked and Door text != Empty","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"lock.lock_front_door","entityIdType":"exact","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"locked"},{"targetType":"entity_id","targetValue":"input_text.front_door_phone_text","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is_not","comparatorValueDatatype":"str","comparatorValue":"Empty"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":310,"y":580,"wires":[["d0a4cc0dbf14f69d"],[]]},{"id":"840c8452fea3e6e9","type":"comment","z":"450c81641a10c42d","g":"daa042542b94f545","name":"This takes care of resetting the boolean inputs","info":"","x":410,"y":340,"wires":[]},{"id":"d1f98d054c33d13f","type":"debug","z":"450c81641a10c42d","name":"Match.msg","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2610,"y":1240,"wires":[]},{"id":"4996b5a3516c8bf9","type":"debug","z":"450c81641a10c42d","name":"NO","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3630,"y":1440,"wires":[]},{"id":"599abaa10da5079b","type":"server-state-changed","z":"450c81641a10c42d","name":"Fron door Faceshot zone","server":"7ab5c227.a3ce8c","version":5,"outputs":2,"exposeAsEntityConfig":"","entityId":"binary_sensor.faceshot_zone_person_occupancy","entityIdType":"exact","outputInitially":false,"stateType":"str","ifState":"on","ifStateType":"str","ifStateOperator":"is","outputOnlyOnStateChange":true,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":true,"ignorePrevStateUnknown":true,"ignorePrevStateUnavailable":true,"ignoreCurrentStateUnknown":true,"ignoreCurrentStateUnavailable":true,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"eventData"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"x":170,"y":960,"wires":[["e2b03208242c4a94"],[]]},{"id":"edba0fe6b1dbaf23","type":"api-call-service","z":"450c81641a10c42d","name":"Save faceshot image For Processing","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.front_door_go2rtc"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":970,"y":960,"wires":[["94f04e317b42ce95"]]},{"id":"ff0675c15d140b3b","type":"function","z":"450c81641a10c42d","name":"Set filename to timestamp.jpg","func":"var timestamp = Date.now();\n\nvar newMsg = {\n    \"payload\": {\n        \"data\": { \"filename\": \"/config/www/frontdoor/\" + timestamp + \".jpg\" }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":650,"y":960,"wires":[["edba0fe6b1dbaf23"]]},{"id":"e2b03208242c4a94","type":"delay","z":"450c81641a10c42d","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"10","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"allowrate":false,"outputs":1,"x":400,"y":960,"wires":[["ff0675c15d140b3b"]]},{"id":"134516bbd0fc3aa8","type":"comment","z":"450c81641a10c42d","name":"Detect when someone is approaching the camera","info":"","x":240,"y":920,"wires":[]},{"id":"7eeb609276c7f1cc","type":"comment","z":"450c81641a10c42d","name":"Take a snapshot of \"Front Door\"","info":"","x":830,"y":920,"wires":[]},{"id":"a7940206a5f7ccf8","type":"join","z":"450c81641a10c42d","name":"","mode":"custom","build":"array","property":"payload","propertyType":"msg","key":"payload.matches","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"3","count":"2","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"num","reduceFixup":"","x":1930,"y":1400,"wires":[["b4e6db4ae6877020","e0babb6b4fecaf49"]]},{"id":"b445c6a8730b4b53","type":"debug","z":"450c81641a10c42d","name":"debug 270","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1530,"y":960,"wires":[]},{"id":"6fd08c073f5e2828","type":"inject","z":"450c81641a10c42d","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":300,"y":1000,"wires":[["e2b03208242c4a94"]]},{"id":"94f04e317b42ce95","type":"change","z":"450c81641a10c42d","name":"","rules":[{"t":"set","p":"front_door_faceshot_path","pt":"flow","to":"payload.data.filename","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1280,"y":960,"wires":[["b445c6a8730b4b53"]]},{"id":"389db4774d51444d","type":"change","z":"450c81641a10c42d","name":"","rules":[{"t":"move","p":"front_door_faceshot_path","pt":"flow","to":"payload.data.filename","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":890,"y":1460,"wires":[["063e82eadc094e7d"]]},{"id":"063e82eadc094e7d","type":"function","z":"450c81641a10c42d","name":"Convert path to http path","func":"var path = msg.payload.data.filename;\nvar http_path = path.replace('/config/www/', 'http://192.168.0.14:3000/api/recognize?url=http://192.168.0.15:8123/local/');\n\nvar newMsg = { \n    \"url\": http_path + \"&camera=frontdoor\"\n        \n};\nreturn newMsg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1170,"y":1460,"wires":[["ae04649aa9de1c90"]]},{"id":"ae04649aa9de1c90","type":"http request","z":"450c81641a10c42d","name":"GET request with link to current image on faceshot camera","method":"GET","ret":"obj","paytoqs":"query","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":1580,"y":1460,"wires":[["1b2009d7457c414d"]]},{"id":"b4e6db4ae6877020","type":"debug","z":"450c81641a10c42d","name":"Join","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2070,"y":1420,"wires":[]},{"id":"6c805544f48fea6b","type":"inject","z":"450c81641a10c42d","name":"Maximiliano at the door","props":[{"p":"url","v":"http://192.168.0.14:3000/api/recognize?url=http://192.168.0.15:8123/local/facecam/1685486849252.jpg","vt":"str"},{"p":"payload"},{"p":"header","v":"{\"x-powered-by\":\"Express\",\"access-control-allow-origin\":\"*\",\"content-type\":\"application/json; charset=utf-8\",\"content-length\":\"466\",\"etag\":\"W/\\\"1d2-771MsXgJg7l9k65KvI2TTjtNxEY\\\"\",\"date\":\"Tue, 30 May 2023 22:47:30 GMT\",\"connection\":\"close\",\"x-node-red-request-node\":\"2a059ed6\"}","vt":"json"},{"p":"responseUrl","v":"http://192.168.0.14:3000/api/recognize?url=http://192.168.0.15:8123/local/facecam/1685486849252.jpg","vt":"str"},{"p":"statusCode","v":"200","vt":"str"},{"p":"redirectList","v":"[]","vt":"str"},{"p":"retry","v":"0","vt":"str"},{"p":"parts","v":"1","vt":"num"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"id\":\"4325b99f-f422-4fd3-bf96-70f4df250548\",\"duration\":0.53,\"timestamp\":\"2023-05-30T22:47:30.099Z\",\"attempts\":1,\"camera\":\"manual\",\"zones\":[],\"counts\":{\"person\":1,\"match\":1,\"miss\":0,\"unknown\":0},\"matches\":[{\"name\":\"maximiliano\",\"confidence\":99.66,\"match\":true,\"box\":{\"top\":285,\"left\":255,\"width\":489,\"height\":531},\"type\":\"manual\",\"duration\":0.45,\"detector\":\"compreface\",\"filename\":\"3ad0cf51-59b9-432e-9af2-458f525f6e38.jpg\",\"base64\":null}],\"misses\":[],\"unknowns\":[]}","payloadType":"json","x":1500,"y":1380,"wires":[["1b2009d7457c414d"]]},{"id":"027f7f85bd053936","type":"inject","z":"450c81641a10c42d","name":"Maximiliano at the door","props":[{"p":"url","v":"http://192.168.0.14:3000/api/recognize?url=http://192.168.0.15:8123/local/facecam/1685486849252.jpg","vt":"str"},{"p":"payload"},{"p":"header","v":"{\"x-powered-by\":\"Express\",\"access-control-allow-origin\":\"*\",\"content-type\":\"application/json; charset=utf-8\",\"content-length\":\"466\",\"etag\":\"W/\\\"1d2-771MsXgJg7l9k65KvI2TTjtNxEY\\\"\",\"date\":\"Tue, 30 May 2023 22:47:30 GMT\",\"connection\":\"close\",\"x-node-red-request-node\":\"2a059ed6\"}","vt":"json"},{"p":"responseUrl","v":"http://192.168.0.14:3000/api/recognize?url=http://192.168.0.15:8123/local/facecam/1685486849252.jpg","vt":"str"},{"p":"statusCode","v":"200","vt":"str"},{"p":"redirectList","v":"[]","vt":"str"},{"p":"retry","v":"0","vt":"str"},{"p":"parts","v":"2","vt":"num"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"id\":\"4325b99f-f422-4fd3-bf96-70f4df250548\",\"duration\":0.53,\"timestamp\":\"2023-05-30T22:47:30.099Z\",\"attempts\":1,\"camera\":\"manual\",\"zones\":[],\"counts\":{\"person\":1,\"match\":1,\"miss\":0,\"unknown\":0},\"matches\":[{\"name\":\"maximiliano\",\"confidence\":59.66,\"match\":true,\"box\":{\"top\":285,\"left\":255,\"width\":489,\"height\":531},\"type\":\"manual\",\"duration\":0.45,\"detector\":\"compreface\",\"filename\":\"3ad0cf51-59b9-432e-9af2-458f525f6e38.jpg\",\"base64\":null}],\"misses\":[],\"unknowns\":[]}","payloadType":"json","x":1500,"y":1420,"wires":[["1b2009d7457c414d"]]},{"id":"6cf321a7b89133c1","type":"debug","z":"450c81641a10c42d","name":"ChatGPT","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2400,"y":1340,"wires":[]},{"id":"af5c4879977768eb","type":"switch","z":"450c81641a10c42d","name":"Are there matches?","property":"payload.counts.match","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"eq","v":"0","vt":"num"}],"checkall":"true","repair":false,"outputs":2,"x":2230,"y":1100,"wires":[["d295dacce255c29b"],["f8c3bad32eedc603"]]},{"id":"f0885d09dd221150","type":"change","z":"450c81641a10c42d","name":"Set msg.match","rules":[{"t":"set","p":"match","pt":"msg","to":"payload.matches[0]","tot":"msg","dc":true},{"t":"set","p":"match.camera","pt":"msg","to":"payload.camera","tot":"msg","dc":true},{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":2360,"y":1040,"wires":[[]]},{"id":"0f3727c6be7d985e","type":"comment","z":"450c81641a10c42d","name":"No","info":"","x":2470,"y":1120,"wires":[]},{"id":"d2c02c47bf8cfdc5","type":"comment","z":"450c81641a10c42d","name":"Yes","info":"","x":2410,"y":1080,"wires":[]},{"id":"1b5e8dc4ed913300","type":"switch","z":"450c81641a10c42d","name":"Match Not Empty?","property":"matches","propertyType":"msg","rules":[{"t":"nempty"},{"t":"empty"},{"t":"null"}],"checkall":"false","repair":false,"outputs":3,"x":2450,"y":1380,"wires":[["2929b2bc450dd368"],["91cd40af7f2cd956"],["91cd40af7f2cd956"]]},{"id":"58245fb216b23619","type":"comment","z":"450c81641a10c42d","name":"Yes","info":"","x":2850,"y":1260,"wires":[]},{"id":"329a33b7758b5ead","type":"comment","z":"450c81641a10c42d","name":"No","info":"","x":2850,"y":1300,"wires":[]},{"id":"e0babb6b4fecaf49","type":"function","z":"450c81641a10c42d","name":"Face Extractor compare by CHATGPT 6.1","func":"let data = msg.payload;\n//Assuming the JSON is stored in a variable called data\n//Initialize an empty array to store the payload objects\nlet payload = [];\n\n//Check if the data array has only one element\nif (data.length === 1) {\n\t//Output the data array as it is\n\tpayload = data;\n\t//Check if there are any matches\n\tlet matches = data[0].matches;\n\tif (matches.length === 0) {\n\t\t//Check if the camera name is faceshot\n\t\tlet camera = data[0].camera;\n\t\tif (camera === \"faceshot\") {\n\t\t\t//Create an object with the key faceshot and the value as the data array element\n\t\t\tlet faceshot = { faceshot: data[0] };\n\t\t\t//Output the faceshot object instead of the payload array\n\t\t\treturn faceshot;\n\t\t}\n\t}\n} else {\n\t//Loop through the data array and check if there are any matches\n\tfor (let i = 0; i < data.length; i++) {\n\t\tlet matches = data[i].matches;\n\t\tif (matches.length > 0) {\n\t\t\t//Find the match with the highest confidence value\n\t\t\tlet maxConfidence = 0;\n\t\t\tlet maxMatch = null;\n\t\t\tfor (let j = 0; j < matches.length; j++) {\n\t\t\t\tlet confidence = matches[j].confidence;\n\t\t\t\tif (confidence > maxConfidence) {\n\t\t\t\t\tmaxConfidence = confidence;\n\t\t\t\t\tmaxMatch = matches[j];\n\t\t\t\t}\n\t\t\t}\n\t\t\t//Add the entire payload object with the highest confidence match to the payload array\n\t\t\tpayload.push(data[i]);\n\t\t} else {\n\t\t\t//If there are no matches, loop through the data array again and compare the camera names\n\t\t\tfor (let k = i + 1; k < data.length; k++) {\n\t\t\t\tlet camera1 = data[i].camera;\n\t\t\t\tlet camera2 = data[k].camera;\n\t\t\t\t//If the camera names are different, create a new payload object with both cameras and their urls and responseUrls\n\t\t\t\tif (camera1 !== camera2) {\n\t\t\t\t\tlet url1 = data[i].url;\n\t\t\t\t\tlet responseUrl1 = data[i].responseUrl;\n\t\t\t\t\tlet url2 = data[k].url;\n\t\t\t\t\tlet responseUrl2 = data[k].responseUrl;\n\t\t\t\t\tlet newPayload = {};\n\t\t\t\t\tnewPayload[camera1] = { url: url1, responseUrl: responseUrl1 };\n\t\t\t\t\tnewPayload[camera2] = { url: url2, responseUrl: responseUrl2 };\n\t\t\t\t\t//Add the new payload object to the payload array\n\t\t\t\t\tpayload.push(newPayload);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\n//Create an object with the key \"matches\" and the value as the payload array\nlet output = { matches: payload };\n\n//Output the output object\nreturn payload;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2180,"y":1380,"wires":[["1b5e8dc4ed913300","6cf321a7b89133c1"]]},{"id":"1b2009d7457c414d","type":"change","z":"450c81641a10c42d","name":"","rules":[{"t":"move","p":"responseUrl","pt":"msg","to":"payload.responseUrl","tot":"msg"},{"t":"move","p":"url","pt":"msg","to":"payload.url","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1740,"y":1400,"wires":[["a7940206a5f7ccf8"]]},{"id":"7d939edc1204269c","type":"switch","z":"450c81641a10c42d","name":"flow.front_door_faceshot_path not null","property":"front_door_faceshot_path","propertyType":"flow","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"false","repair":false,"outputs":2,"x":510,"y":1460,"wires":[["389db4774d51444d"],["497a104c428542a9"]]},{"id":"e1d56fd01058e96c","type":"function","z":"450c81641a10c42d","name":"Notif setter (doorbell)","func":"var name = msg.matches[0].name;\nvar url = msg.responseUrl.split('?');\nvar url2 = url[1].replace('url=http://192.168.0.15:8123/', 'https://hass.purgatoire.ca/').split('&');\nvar urlfinal = url2[0];\nvar random = Date.now();\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"sticky\": 'true',\n\t\t\t\t\"clickAction\": '/phone-landing/reolink?kiosk=1',\n\t\t\t\t\"priority\": 'high',\n\t\t\t\t\"image\": urlfinal + \"?\" + random,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\"title\": \"Enter Text\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":4220,"y":1340,"wires":[["21c8c9ef879dd219"]]},{"id":"7dfcb7d8a254db2a","type":"debug","z":"450c81641a10c42d","name":"Notification","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4910,"y":1460,"wires":[]},{"id":"7a681aa6f5a6c94c","type":"debug","z":"450c81641a10c42d","name":"Notification","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4890,"y":1280,"wires":[]},{"id":"526fbeafe6da4f45","type":"function","z":"450c81641a10c42d","name":"JavascriptNotification setter Faceshot","func":"var name = \"Someone\";\nvar url = msg.faceshot.responseUrl.split('?');\nvar url2 = url[1].replace('url=http://192.168.0.15:8123/', 'https://hass.purgatoire.ca/').split('&');\nvar urlfinal = url2[0];\n\nvar random = Date.now();\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": name + \" is at the door\",\n\t\t\t\"data\": {\n\t\t\t\t\"sticky\": 'true',\n\t\t\t\t\"clickAction\": '/phone-landing/reolink?kiosk=1',\n\t\t\t\t\"priority\": 'high',\n\t\t\t\t\"image\": urlfinal + \"?\" + random,\n\t\t\t\t\"actions\": [{\n\t\t\t\t\t\"action\": \"REPLY\",\n\t\t\t\t\t\"title\": \"Who is this?\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"action\": \"unlock_door\",\n\t\t\t\t\t\"title\": \"Unlock The Door\"\n\t\t\t\t}\n\n\t\t\t\t]\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3910,"y":1460,"wires":[["a6ee972424e25404"]]},{"id":"a757e9e084a63171","type":"debug","z":"450c81641a10c42d","name":"Double Take","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1910,"y":1340,"wires":[]},{"id":"74a89ea4dbc73713","type":"function","z":"450c81641a10c42d","name":"Face Extractor compare by CHATGPT 6 working","func":"let data = msg.payload;\n//Assuming the JSON is stored in a variable called data\n//Initialize an empty array to store the payload objects\nlet payload = [];\n\n//Check if the data array has only one element\nif (data.length === 1) {\n\t//Output the data array as it is\n\tpayload = data;\n\t//Check if the camera name is faceshot\n\tlet camera = data[0].camera;\n\tif (camera === \"faceshot\") {\n\t\t//Create an object with the key faceshot and the value as the data array element\n\t\tlet faceshot = { faceshot: data[0] };\n\t\t//Output the faceshot object instead of the payload array\n\t\treturn faceshot;\n\t}\n} else {\n\t//Loop through the data array and check if there are any matches\n\tfor (let i = 0; i < data.length; i++) {\n\t\tlet matches = data[i].matches;\n\t\tif (matches.length > 0) {\n\t\t\t//Find the match with the highest confidence value\n\t\t\tlet maxConfidence = 0;\n\t\t\tlet maxMatch = null;\n\t\t\tfor (let j = 0; j < matches.length; j++) {\n\t\t\t\tlet confidence = matches[j].confidence;\n\t\t\t\tif (confidence > maxConfidence) {\n\t\t\t\t\tmaxConfidence = confidence;\n\t\t\t\t\tmaxMatch = matches[j];\n\t\t\t\t}\n\t\t\t}\n\t\t\t//Add the entire payload object with the highest confidence match to the payload array\n\t\t\tpayload.push(data[i]);\n\t\t} else {\n\t\t\t//If there are no matches, loop through the data array again and compare the camera names\n\t\t\tfor (let k = i + 1; k < data.length; k++) {\n\t\t\t\tlet camera1 = data[i].camera;\n\t\t\t\tlet camera2 = data[k].camera;\n\t\t\t\t//If the camera names are different, create a new payload object with both cameras and their urls and responseUrls\n\t\t\t\tif (camera1 !== camera2) {\n\t\t\t\t\tlet url1 = data[i].url;\n\t\t\t\t\tlet responseUrl1 = data[i].responseUrl;\n\t\t\t\t\tlet url2 = data[k].url;\n\t\t\t\t\tlet responseUrl2 = data[k].responseUrl;\n\t\t\t\t\tlet newPayload = {};\n\t\t\t\t\tnewPayload[camera1] = { url: url1, responseUrl: responseUrl1 };\n\t\t\t\t\tnewPayload[camera2] = { url: url2, responseUrl: responseUrl2 };\n\t\t\t\t\t//Add the new payload object to the payload array\n\t\t\t\t\tpayload.push(newPayload);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\n\n//Output the payload array\nreturn payload;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2200,"y":1620,"wires":[[]]},{"id":"55ecf47b2c74fc32","type":"api-call-service","z":"450c81641a10c42d","name":"Save faceshot image For Processing","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"camera","service":"snapshot","areaId":[],"deviceId":[],"entityId":["camera.front_door_go2rtc"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":690,"y":1520,"wires":[["31a3fff9900f28fd"]]},{"id":"497a104c428542a9","type":"function","z":"450c81641a10c42d","name":"Set filename to timestamp.jpg","func":"var timestamp = Date.now();\n\nvar newMsg = {\n    \"payload\": {\n        \"data\": { \"filename\": \"/config/www/frontdoor/\" + timestamp + \".jpg\" }}};\nreturn newMsg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":370,"y":1520,"wires":[["55ecf47b2c74fc32"]]},{"id":"31a3fff9900f28fd","type":"change","z":"450c81641a10c42d","name":"","rules":[{"t":"set","p":"front_door_faceshot_path","pt":"flow","to":"payload.data.filename","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1000,"y":1520,"wires":[["389db4774d51444d"]]},{"id":"9a1eba95f48522e9","type":"api-call-service","z":"450c81641a10c42d","name":"Send popup to tablets","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"browser_mod","service":"popup","areaId":[],"deviceId":[],"entityId":[],"data":"{\"dismissable\":false,\"autoclose\":true,\"content\":{\"type\":\"vertical-stack\",\"cards\":[{\"type\":\"custom:frigate-card\",\"elements\":[{\"type\":\"custom:frigate-card-menu-state-icon\",\"entity\":\"lock.lock_front_door\",\"tap_action\":{\"action\":\"toggle\"}},{\"type\":\"custom:frigate-card-menu-state-icon\",\"entity\":\"light.front_door_light\",\"tap_action\":{\"action\":\"toggle\"},\"hold_action\":{\"action\":\"more-info\"}},{\"type\":\"custom:frigate-card-menu-state-icon\",\"entity\":\"input_boolean.waiting_someone\",\"tap_action\":{\"action\":\"toggle\"}},{\"type\":\"custom:frigate-card-conditional\",\"conditions\":{\"view\":[\"live\"]},\"elements\":[{\"type\":\"icon\",\"icon\":\"mdi:package\",\"style\":{\"background\":\"rgba(255, 255, 255, 0.25)\",\"border-radius\":\"5px\",\"right\":\"25px\",\"bottom\":\"0px\"},\"tap_action\":{\"action\":\"call-service\",\"service\":\"script.turn_on\",\"service_data\":{\"entity_id\":\"script.ptz_to_package\"}}},{\"type\":\"icon\",\"icon\":\"mdi:car\",\"style\":{\"background\":\"rgba(255, 255, 255, 0.25)\",\"border-radius\":\"5px\",\"right\":\"50px\",\"bottom\":\"25px\"},\"tap_action\":{\"action\":\"call-service\",\"service\":\"script.turn_on\",\"service_data\":{\"entity_id\":\"script.ptz_to_street\"}}},{\"type\":\"icon\",\"icon\":\"mdi:door\",\"style\":{\"background\":\"rgba(255, 255, 255, 0.25)\",\"border-radius\":\"5px\",\"right\":\"0px\",\"bottom\":\"25px\"},\"tap_action\":{\"action\":\"call-service\",\"service\":\"script.turn_on\",\"service_data\":{\"entity_id\":\"script.ptz_to_doorway\"}}}]}],\"live\":{\"draggable\":false,\"lazy_load\":false,\"preload\":true,\"auto_play\":\"selected\",\"auto_pause\":\"unselected\",\"auto_mute\":\"all\",\"auto_unmute\":\"never\",\"transition_effect\":\"slide\",\"zoomable\":true},\"menu\":{\"style\":\"overlay\",\"position\":\"top\",\"alignment\":\"right\",\"buttons\":{\"media_player\":{\"alignment\":\"opposing\",\"priority\":62,\"enabled\":false},\"download\":{\"enabled\":false},\"snapshots\":{\"enabled\":false},\"frigate\":{\"enabled\":false},\"live\":{\"priority\":66},\"cameras\":{\"enabled\":false},\"camera_ui\":{\"enabled\":false}}},\"cameras\":[{\"live_provider\":\"go2rtc\",\"webrtc_card\":{},\"dependencies\":{\"all_cameras\":true},\"frigate\":{\"url\":\"http://192.168.0.14:3750/\",\"camera_name\":\"front_door_camera\"},\"camera_entity\":\"camera.front_door_camera\",\"triggers\":{\"occupancy\":false},\"title\":\"Front Door\",\"id\":\"front_door\"}],\"view\":{\"default\":\"live\",\"camera_select\":\"clips\",\"dark_mode\":\"on\",\"timeout_seconds\":60,\"scan\":{\"enabled\":true}},\"dimensions\":{\"aspect_ratio_mode\":\"unconstrained\"},\"media_gallery\":{\"controls\":{\"thumbnails\":{\"size\":175}}},\"cameras_global\":{\"jsmpeg\":{\"options\":{\"disableWebAssembly\":true}}}},{\"color\":\"auto\",\"color_type\":\"card\",\"tap_action\":{\"action\":\"call-service\",\"service\":\"lock.unlock\",\"service_data\":{\"entity_id\":\"lock.lock_front_door\"}},\"icon\":\"mdi:lock-open-alert\",\"name\":\"UNLOCK\",\"styles\":{\"card\":[{\"font-size\":\"14px\"},{\"font-weight\":\"bold\"},{\"height\":\"120px\"},{\"color\":\"white\"},{\"background\":\"rgb(0, 230, 0)\"}]},\"type\":\"custom:button-card\"}]},\"timeout\":80000,\"size\":\"fullscreen\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"1","valueType":"str"}],"queue":"none","x":4900,"y":1420,"wires":[[]]},{"id":"7119a8895f38bb0e","type":"function","z":"450c81641a10c42d","name":"Set popup","func":"var image = msg.video_content\nvar message = msg.message\n\nvar newMsg = {\n\t\"payload\": {\n\t\t\"data\": {\n\t\t\t\"message\": \"Doorbell Alert\",\n\t\t\t\"title\": message ,\n\t\t\t\"data\": {\n\t\t\t\t\"dismissable\": false,\n\t\t\t\t\"autoclose\": true,\n\t\t\t\t\"content\": {\n\t\t\t\t\t\"type\": \"vertical-stack\",\n\t\t\t\t\t\"cards\": [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"type\": \"picture\",\n\t\t\t\t\t\t\t\"image\": image ,\n\t\t\t\t\t\t\t\"tap_action\": {\n\t\t\t\t\t\t\t\t\"action\": \"none\"\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\"hold_action\": {\n\t\t\t\t\t\t\t\t\"action\": \"none\"\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"color\": \"auto\",\n\t\t\t\t\t\t\t\"color_type\": \"card\",\n\t\t\t\t\t\t\t\"tap_action\": {\n\t\t\t\t\t\t\t\t\"action\": \"call-service\",\n\t\t\t\t\t\t\t\t\"service\": \"lock.unlock\",\n\t\t\t\t\t\t\t\t\"service_data\": {\n\t\t\t\t\t\t\t\t\t\"entity_id\": \"lock.lock_front_door\"\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\"icon\": \"mdi:lock-open-alert\",\n\t\t\t\t\t\t\t\"name\": \"UNLOCK\",\n\t\t\t\t\t\t\t\"styles\": {\n\t\t\t\t\t\t\t\t\"card\": [\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\"font-size\": \"14px\"\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\"font-weight\": \"bold\"\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\"height\": \"120px\"\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\"color\": \"white\"\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\"background\": \"rgb(0, 230, 0)\"\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t]\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\"type\": \"custom:button-card\"\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t\"timeout\": 80000,\n\t\t\t\t\"size\": \"fullscreen\"\n\t\t\t}\n\t\t}\n\t}\n};\nreturn newMsg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":4690,"y":1420,"wires":[["9a1eba95f48522e9"]]},{"id":"a897342dd6b5692d","type":"debug","z":"450c81641a10c42d","name":"Mass alert","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4710,"y":1340,"wires":[]},{"id":"d51e645dedb4637b","type":"ha-wait-until","z":"450c81641a10c42d","name":"","server":"7ab5c227.a3ce8c","version":2,"outputs":2,"entityId":"lock.lock_front_door","entityIdFilterType":"exact","property":"state","comparator":"is","value":"unlocked","valueType":"str","timeout":"2","timeoutType":"num","timeoutUnits":"minutes","checkCurrentState":true,"blockInputOverrides":true,"outputProperties":[],"x":4400,"y":1220,"wires":[["bc0edcf904abdb95"],[]]},{"id":"915ab7aa63e527cb","type":"bigtimer","z":"03d6b46677a5b50f","outtopic":"","outpayload1":"on","outpayload2":"off","name":"2AM to noon","comment":"This will trigger the muting of the wiim speakers","lat":0,"lon":0,"starttime":"105","endtime":"735","starttime2":0,"endtime2":0,"startoff":0,"endoff":"0","startoff2":0,"endoff2":0,"offs":0,"outtext1":"on","outtext2":"off","timeout":1440,"sun":true,"mon":true,"tue":true,"wed":true,"thu":true,"fri":true,"sat":true,"jan":true,"feb":true,"mar":true,"apr":true,"may":true,"jun":true,"jul":true,"aug":true,"sep":true,"oct":true,"nov":true,"dec":true,"day1":0,"month1":0,"day2":0,"month2":0,"day3":0,"month3":0,"day4":0,"month4":0,"day5":0,"month5":0,"day6":0,"month6":0,"day7":0,"month7":0,"day8":0,"month8":0,"day9":0,"month9":0,"day10":0,"month10":0,"day11":0,"month11":0,"day12":0,"month12":0,"d1":0,"w1":0,"d2":0,"w2":0,"d3":0,"w3":0,"d4":0,"w4":0,"d5":0,"w5":0,"d6":0,"w6":0,"xday1":0,"xmonth1":0,"xday2":0,"xmonth2":0,"xday3":0,"xmonth3":0,"xday4":0,"xmonth4":0,"xday5":0,"xmonth5":0,"xday6":0,"xmonth6":0,"xday7":0,"xmonth7":0,"xday8":0,"xmonth8":0,"xday9":0,"xmonth9":0,"xday10":0,"xmonth10":0,"xday11":0,"xmonth11":0,"xday12":0,"xmonth12":0,"xd1":0,"xw1":0,"xd2":0,"xw2":0,"xd3":0,"xw3":0,"xd4":0,"xw4":0,"xd5":0,"xw5":0,"xd6":0,"xw6":0,"suspend":false,"random":false,"randon1":false,"randoff1":false,"randon2":false,"randoff2":false,"repeat":false,"atstart":true,"odd":false,"even":false,"x":110,"y":1140,"wires":[[],[],[]]},{"id":"d8fd5d752780fcb7","type":"comment","z":"03d6b46677a5b50f","name":"Turn on at 2.15 am and Off at noon.15","info":"","x":190,"y":1080,"wires":[]},{"id":"3547c78a4391f57e","type":"switch","z":"03d6b46677a5b50f","name":"on/off","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"on","vt":"str"},{"t":"cont","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":270,"y":1140,"wires":[["93e218925b55ab51"],["30b0310b21d37f51"]]},{"id":"93e218925b55ab51","type":"api-call-service","z":"03d6b46677a5b50f","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_off","areaId":[],"deviceId":[],"entityId":["input_boolean.following_music"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload.entity_id","propertyType":"msg","value":"sensor","valueType":"msg"}],"queue":"none","x":500,"y":1080,"wires":[[]]},{"id":"30b0310b21d37f51","type":"api-call-service","z":"03d6b46677a5b50f","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"homeassistant","service":"turn_on","areaId":[],"deviceId":[],"entityId":["input_boolean.following_music"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload.entity_id","propertyType":"msg","value":"sensor","valueType":"msg"}],"queue":"none","x":500,"y":1180,"wires":[[]]},{"id":"e2f7b34a47fb1b19","type":"comment","z":"03d6b46677a5b50f","name":"Turn \"following music off\"","info":"","x":510,"y":1040,"wires":[]},{"id":"74073a72c618fda0","type":"comment","z":"03d6b46677a5b50f","name":"Turn \"following music\" on","info":"","x":510,"y":1220,"wires":[]},{"id":"2bb39d186857c0a1","type":"bigtimer","z":"03d6b46677a5b50f","outtopic":"","outpayload1":"on","outpayload2":"off","name":"2AM to noon","comment":"This will trigger the muting of the wiim speakers","lat":0,"lon":0,"starttime":"120","endtime":"720","starttime2":0,"endtime2":0,"startoff":"0","endoff":"0","startoff2":0,"endoff2":0,"offs":0,"outtext1":"on","outtext2":"off","timeout":1440,"sun":true,"mon":true,"tue":true,"wed":true,"thu":true,"fri":true,"sat":true,"jan":true,"feb":true,"mar":true,"apr":true,"may":true,"jun":true,"jul":true,"aug":true,"sep":true,"oct":true,"nov":true,"dec":true,"day1":0,"month1":0,"day2":0,"month2":0,"day3":0,"month3":0,"day4":0,"month4":0,"day5":0,"month5":0,"day6":0,"month6":0,"day7":0,"month7":0,"day8":0,"month8":0,"day9":0,"month9":0,"day10":0,"month10":0,"day11":0,"month11":0,"day12":0,"month12":0,"d1":0,"w1":0,"d2":0,"w2":0,"d3":0,"w3":0,"d4":0,"w4":0,"d5":0,"w5":0,"d6":0,"w6":0,"xday1":0,"xmonth1":0,"xday2":0,"xmonth2":0,"xday3":0,"xmonth3":0,"xday4":0,"xmonth4":0,"xday5":0,"xmonth5":0,"xday6":0,"xmonth6":0,"xday7":0,"xmonth7":0,"xday8":0,"xmonth8":0,"xday9":0,"xmonth9":0,"xday10":0,"xmonth10":0,"xday11":0,"xmonth11":0,"xday12":0,"xmonth12":0,"xd1":0,"xw1":0,"xd2":0,"xw2":0,"xd3":0,"xw3":0,"xd4":0,"xw4":0,"xd5":0,"xw5":0,"xd6":0,"xw6":0,"suspend":false,"random":false,"randon1":false,"randoff1":false,"randon2":false,"randoff2":false,"repeat":false,"atstart":true,"odd":false,"even":false,"x":110,"y":840,"wires":[["24559e0bad433379"],[],[]]},{"id":"371b83876f70539c","type":"comment","z":"03d6b46677a5b50f","name":"Turn on at 2.15 am and Off at noon.15","info":"","x":190,"y":780,"wires":[]},{"id":"24559e0bad433379","type":"switch","z":"03d6b46677a5b50f","name":"on/off","property":"payload","propertyType":"msg","rules":[{"t":"cont","v":"on","vt":"str"},{"t":"cont","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":270,"y":840,"wires":[["b7225a75e4802205"],["f9d9978831f72b4c"]]},{"id":"b7225a75e4802205","type":"api-call-service","z":"03d6b46677a5b50f","name":"Turn off FOSI receivers","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_off","areaId":[],"deviceId":[],"entityId":["switch.group_fosi_receivers"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload.entity_id","propertyType":"msg","value":"sensor","valueType":"msg"}],"queue":"none","x":510,"y":780,"wires":[[]]},{"id":"0f2275200a5e9472","type":"comment","z":"03d6b46677a5b50f","name":"Turn \"fosi receivers\" off","info":"","x":500,"y":740,"wires":[]},{"id":"db609c81ddad449d","type":"comment","z":"03d6b46677a5b50f","name":"Turn \"fosi receivers\" on","info":"","x":500,"y":920,"wires":[]},{"id":"f9d9978831f72b4c","type":"api-call-service","z":"03d6b46677a5b50f","name":"Turn on FOSI receivers","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"switch","service":"turn_on","areaId":[],"deviceId":[],"entityId":["switch.group_fosi_receivers"],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload.entity_id","propertyType":"msg","value":"sensor","valueType":"msg"}],"queue":"none","x":510,"y":880,"wires":[[]]},{"id":"e04c9672e46cf188","type":"trigger-state","z":"03d6b46677a5b50f","name":"","server":"7ab5c227.a3ce8c","version":4,"inputs":0,"outputs":2,"exposeAsEntityConfig":"","entityId":"^binary_sensor\\.(?!.*?bedroom.*?)(?!.*?closet.*?)sensor_.*_occupancy$","entityIdType":"regex","debugEnabled":false,"constraints":[{"targetType":"this_entity","targetValue":"","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"re","comparatorValue":"(on|off)"},{"targetType":"entity_id","targetValue":"input_boolean.following_music","propertyType":"current_state","propertyValue":"new_state.state","comparatorType":"is","comparatorValueDatatype":"str","comparatorValue":"on"}],"customOutputs":[],"outputInitially":false,"stateType":"str","enableInput":false,"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"x":470,"y":1980,"wires":[["e4addfdc3f2206af","779638e0b852b3a6"],[]]},{"id":"e4addfdc3f2206af","type":"function","z":"03d6b46677a5b50f","name":"Extract room from motion sensor entity an and extract playing speakers","func":"var motion_entity_id = msg.data.event.new_state.entity_id; // binary_sensor.sensor_bedroom_motion_occupancy\nvar motion_entity_id_split = motion_entity_id.split(\".\");// split on the dot to separate domain and entity\nvar room = motion_entity_id_split[1].replace(\"sensor_\", \"\").replace(\"_motion\", \"\").replace(\"_fp1\", \"\").replace(\"fp2_\", \"\").replace(\"_presence\", \"\").replace(\"_occupancy\", \"\").replace(\"_entry\", \"\").replace(\"_exit\", \"\");// remove sensor_ and more substrings\nconst rules_object = [{ 'property': 'entity_id', 'logic': 'is', 'value': \"media_player\\.(?!.*?speakers.*?)(?!.*?plex.*?)(?!.*?group.*?).*\" + room + \".*_speaker\", 'valueType': 're' }, { 'property': 'state', 'logic': 'is', 'value': \"playing\", 'valueType': 'str' }];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object},\"room\": room, \"action\": msg.payload\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1130,"y":1980,"wires":[["c76ce6e104bcc6ef","1bd78c807625944b"]]},{"id":"c76ce6e104bcc6ef","type":"ha-get-entities","z":"03d6b46677a5b50f","name":"Get entities","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload.results","output_results_count":1,"x":1670,"y":1980,"wires":[["27134fcdc6848fa5","9c2fc2e7aa363875"]]},{"id":"27134fcdc6848fa5","type":"change","z":"03d6b46677a5b50f","name":"rules","rules":[{"t":"move","p":"payload","pt":"msg","to":"entity","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1890,"y":1980,"wires":[["7df1cfdd74c1f221"]]},{"id":"930c4a5e919c96c1","type":"comment","z":"03d6b46677a5b50f","name":"Detect motion across ocupancy sensors","info":"","x":210,"y":1940,"wires":[]},{"id":"ea90434799d08073","type":"comment","z":"03d6b46677a5b50f","name":"(Ignores \"Closet\", \"Bedroom\" sensors)","info":"","x":530,"y":1940,"wires":[]},{"id":"6a39e10ee4f7b696","type":"comment","z":"03d6b46677a5b50f","name":"Generate the regex for get entity node","info":"","x":1210,"y":1940,"wires":[]},{"id":"6eeb43af48fa769e","type":"comment","z":"03d6b46677a5b50f","name":"Get playing speakers","info":"","x":1680,"y":1940,"wires":[]},{"id":"4056be01d626e90c","type":"comment","z":"03d6b46677a5b50f","name":"Move payload to entity","info":"","x":1900,"y":1940,"wires":[]},{"id":"779638e0b852b3a6","type":"debug","z":"03d6b46677a5b50f","name":"debug 308","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":950,"y":1940,"wires":[]},{"id":"1bd78c807625944b","type":"debug","z":"03d6b46677a5b50f","name":"debug 309","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1690,"y":2080,"wires":[]},{"id":"7df1cfdd74c1f221","type":"api-current-state","z":"03d6b46677a5b50f","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"sensor.active_sleeper_rooms","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"room_sleepers","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":2130,"y":1980,"wires":[["cd9957e263db1f03"]]},{"id":"9c2fc2e7aa363875","type":"debug","z":"03d6b46677a5b50f","name":"speakers being output","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1980,"y":2080,"wires":[]},{"id":"f6149016b17428fd","type":"inject","z":"03d6b46677a5b50f","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"data","v":"{\"event_type\":\"state_changed\",\"entity_id\":\"binary_sensor.sensor_hallway_motion_occupancy\",\"event\":{\"entity_id\":\"binary_sensor.sensor_hallway_motion_occupancy\",\"old_state\":{\"entity_id\":\"binary_sensor.sensor_hallway_motion_occupancy\",\"state\":\"off\",\"attributes\":{\"battery\":100,\"device\":{\"applicationVersion\":11,\"dateCode\":\"20160524\",\"friendlyName\":\"sensor_hallway_motion\",\"hardwareVersion\":2,\"ieeeAddr\":\"0x00158d0002275fd4\",\"manufacturerID\":4151,\"manufacturerName\":\"LUMI\",\"model\":\"RTCGQ01LM\",\"networkAddress\":36327,\"powerSource\":\"Battery\",\"softwareBuildID\":\"3000-0001\",\"stackVersion\":2,\"type\":\"EndDevice\",\"zclVersion\":1},\"linkquality\":29,\"occupancy\":false,\"power_outage_count\":23115,\"voltage\":3035,\"device_class\":\"motion\",\"friendly_name\":\"Hallway Motion_occupancy\"},\"last_changed\":\"2023-08-02T15:45:12.640577+00:00\",\"last_updated\":\"2023-08-02T15:45:12.640577+00:00\",\"context\":{\"id\":\"01H6VESCE0WYF8ZX13SQC5N487\",\"parent_id\":null,\"user_id\":null},\"original_state\":\"off\"},\"new_state\":{\"entity_id\":\"binary_sensor.sensor_hallway_motion_occupancy\",\"state\":\"on\",\"attributes\":{\"battery\":100,\"device\":{\"applicationVersion\":11,\"dateCode\":\"20160524\",\"friendlyName\":\"sensor_hallway_motion\",\"hardwareVersion\":2,\"ieeeAddr\":\"0x00158d0002275fd4\",\"manufacturerID\":4151,\"manufacturerName\":\"LUMI\",\"model\":\"RTCGQ01LM\",\"networkAddress\":36327,\"powerSource\":\"Battery\",\"softwareBuildID\":\"3000-0001\",\"stackVersion\":2,\"type\":\"EndDevice\",\"zclVersion\":1},\"linkquality\":29,\"occupancy\":false,\"power_outage_count\":23115,\"voltage\":3035,\"device_class\":\"motion\",\"friendly_name\":\"Hallway Motion_occupancy\"},\"last_changed\":\"2023-08-02T15:50:28.404423+00:00\",\"last_updated\":\"2023-08-02T15:50:28.404423+00:00\",\"context\":{\"id\":\"01H6VF30SMTSYD1N217CFJ7GQT\",\"parent_id\":null,\"user_id\":\"7f1de31122574f6fa2215e519d6083ea\"},\"original_state\":\"on\",\"timeSinceChangedMs\":5}},\"origin\":\"LOCAL\",\"time_fired\":\"2023-08-02T15:50:28.404423+00:00\",\"context\":{\"id\":\"01H6VF30SMTSYD1N217CFJ7GQT\",\"parent_id\":null,\"user_id\":\"7f1de31122574f6fa2215e519d6083ea\"}}","vt":"json"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"binary_sensor.sensor_hallway_motion_occupancy","payload":"on","payloadType":"str","x":1670,"y":1900,"wires":[["27134fcdc6848fa5"]]},{"id":"d222b3b27c3bab57","type":"switch","z":"03d6b46677a5b50f","name":"Is \"active_sleeper_present\" 0?","property":"payload.active_sleeper_present","propertyType":"msg","rules":[{"t":"eq","v":"0","vt":"num"},{"t":"gt","v":"0","vt":"num"}],"checkall":"false","repair":false,"outputs":2,"x":3170,"y":1980,"wires":[["3c0e2cc8cc0f18f3"],["7a367c039a7c208f"]]},{"id":"9f3d9426655fa09b","type":"comment","z":"03d6b46677a5b50f","name":"Check that \"active_sleeper_present\" is off","info":" - ","x":3140,"y":1940,"wires":[]},{"id":"f0a15bb62e7696f5","type":"inject","z":"03d6b46677a5b50f","name":"office motion","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"data","v":"{\"event_type\":\"state_changed\",\"entity_id\":\"binary_sensor.sensor_office_motion_occupancy\",\"event\":{\"entity_id\":\"binary_sensor.sensor_office_motion_occupancy\",\"old_state\":{\"entity_id\":\"binary_sensor.sensor_office_motion_occupancy\",\"state\":\"off\",\"attributes\":{\"battery\":100,\"device\":{\"applicationVersion\":11,\"friendlyName\":\"sensor_office_motion\",\"ieeeAddr\":\"0x00158d0002281294\",\"manufacturerID\":4151,\"manufacturerName\":\"LUMI\",\"model\":\"RTCGQ01LM\",\"networkAddress\":28396,\"powerSource\":\"Battery\",\"type\":\"EndDevice\"},\"linkquality\":87,\"occupancy\":false,\"power_outage_count\":77,\"voltage\":3075,\"device_class\":\"motion\",\"friendly_name\":\"Hotbox Down Motion_occupancy\"},\"last_changed\":\"2023-08-03T13:07:10.739670+00:00\",\"last_updated\":\"2023-08-03T13:07:10.739670+00:00\",\"context\":{\"id\":\"01H6XR4QRKMSW2KB245H9T6KFT\",\"parent_id\":null,\"user_id\":null},\"original_state\":\"off\"},\"new_state\":{\"entity_id\":\"binary_sensor.sensor_office_motion_occupancy\",\"state\":\"on\",\"attributes\":{\"battery\":100,\"device\":{\"applicationVersion\":11,\"friendlyName\":\"sensor_office_motion\",\"ieeeAddr\":\"0x00158d0002281294\",\"manufacturerID\":4151,\"manufacturerName\":\"LUMI\",\"model\":\"RTCGQ01LM\",\"networkAddress\":28396,\"powerSource\":\"Battery\",\"type\":\"EndDevice\"},\"linkquality\":87,\"occupancy\":false,\"power_outage_count\":77,\"voltage\":3075,\"device_class\":\"motion\",\"friendly_name\":\"Hotbox Down Motion_occupancy\"},\"last_changed\":\"2023-08-03T13:28:46.214518+00:00\",\"last_updated\":\"2023-08-03T13:28:46.214518+00:00\",\"context\":{\"id\":\"01H6XSC8W6W0RJ9N7G6RVXA89K\",\"parent_id\":null,\"user_id\":\"7f1de31122574f6fa2215e519d6083ea\"},\"original_state\":\"on\",\"timeSinceChangedMs\":4}},\"origin\":\"LOCAL\",\"time_fired\":\"2023-08-03T13:28:46.214518+00:00\",\"context\":{\"id\":\"01H6XSC8W6W0RJ9N7G6RVXA89K\",\"parent_id\":null,\"user_id\":\"7f1de31122574f6fa2215e519d6083ea\"}}","vt":"json"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"binary_sensor.sensor_office_motion_occupancy","payload":"on","payloadType":"str","x":850,"y":2040,"wires":[["e4addfdc3f2206af"]]},{"id":"cd9957e263db1f03","type":"function","z":"03d6b46677a5b50f","name":"Check if any sleeper is in the triggered room","func":"\n\nvar room = msg.room.replace('_down', '').replace('_exit', '').replace('_top', '');\nvar room_sleepers = msg.room_sleepers;\nvar active = 0;\n\nvar active = compareArrayToString(room_sleepers, room);\n\n\nvar msg = {\n    \"payload\": {\n    \"room\": room,\n    \"room_sleepers\": room_sleepers,\n    \"entity\": msg.entity,\n    \"active_sleeper_present\": active,\n    \"data\": msg.entity\n    },\n    \"entity_id\": msg.entity.entity_id,\n    \"action\": msg.action\n\n}\nreturn msg;\n\n\nfunction compareArrayToString(array, string) {\n    var array_string = String(array)\n\n\n    if (array_string.includes(string)) {\n        // return 1 if found\n        return 1;\n    }\n\n\n    // return off if none found\n    return 0;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":2490,"y":1980,"wires":[["f881d0833ea3f85c"]]},{"id":"47324fd399b388cf","type":"api-call-service","z":"03d6b46677a5b50f","name":"Unmute speakers","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\": \"false\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4190,"y":1900,"wires":[[]]},{"id":"e64f402206944ab4","type":"comment","z":"03d6b46677a5b50f","name":"Move payload to payload.data","info":"","x":3940,"y":1860,"wires":[]},{"id":"a5c70917aae8f20d","type":"comment","z":"03d6b46677a5b50f","name":"unMute speakers","info":"","x":4180,"y":1860,"wires":[]},{"id":"72a52d6d52ab0eb1","type":"api-call-service","z":"03d6b46677a5b50f","name":"Mute speakers","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_mute","areaId":[],"deviceId":[],"entityId":[],"data":"{\"is_volume_muted\": \"true\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4420,"y":2100,"wires":[["dcd4e81de0056db6"]]},{"id":"378dda93ed6d8753","type":"change","z":"03d6b46677a5b50f","name":"rules","rules":[{"t":"move","p":"payload.data","pt":"msg","to":"payload.olddata","tot":"msg"},{"t":"delete","p":"room","pt":"msg"},{"t":"delete","p":"room_sleepers","pt":"msg"},{"t":"move","p":"entity_id","pt":"msg","to":"payload.data.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":4070,"y":2100,"wires":[["72a52d6d52ab0eb1"]]},{"id":"3b8692f05ae4cea5","type":"comment","z":"03d6b46677a5b50f","name":"Move payload to payload.data","info":"","x":4160,"y":2140,"wires":[]},{"id":"8116173fab07ad49","type":"comment","z":"03d6b46677a5b50f","name":"Mute speakers","info":"","x":4400,"y":2140,"wires":[]},{"id":"dcd4e81de0056db6","type":"debug","z":"03d6b46677a5b50f","name":"debug 313","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":4630,"y":2100,"wires":[]},{"id":"7bfe41169c71a8b3","type":"switch","z":"03d6b46677a5b50f","name":"","property":"payload.data.attributes.is_volume_muted","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":3630,"y":1900,"wires":[["3b555b893e95ad45"]]},{"id":"1e7708df190fa822","type":"comment","z":"03d6b46677a5b50f","name":"Make sure the muted state is adequate","info":"","x":3650,"y":1860,"wires":[]},{"id":"467b85f84faa19e6","type":"trigger","z":"03d6b46677a5b50f","name":"","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"6","extend":false,"overrideDelay":false,"units":"min","reset":"","bytopic":"topic","topic":"entity_id","outputs":1,"x":3890,"y":2100,"wires":[["378dda93ed6d8753"]]},{"id":"91430ff8427678d6","type":"change","z":"03d6b46677a5b50f","name":"Set reset to 1","rules":[{"t":"set","p":"reset","pt":"msg","to":"true","tot":"bool","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":3630,"y":1940,"wires":[["d285a6df06408469"]]},{"id":"9638ab6174792c98","type":"switch","z":"03d6b46677a5b50f","name":"","property":"payload.data.attributes.is_volume_muted","propertyType":"msg","rules":[{"t":"false"}],"checkall":"true","repair":false,"outputs":1,"x":3490,"y":2100,"wires":[["467b85f84faa19e6"]]},{"id":"f881d0833ea3f85c","type":"switch","z":"03d6b46677a5b50f","name":"Is action ON or OFF?","property":"action","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":2780,"y":1980,"wires":[["8d60a95dfcc5fb5c"],["2dfae27128e21d1e"]]},{"id":"92409aea8e89e516","type":"inject","z":"03d6b46677a5b50f","name":"office no motion","props":[{"p":"payload"},{"p":"topic","vt":"str"},{"p":"data","v":"{\"event_type\":\"state_changed\",\"entity_id\":\"binary_sensor.sensor_office_motion_occupancy\",\"event\":{\"entity_id\":\"binary_sensor.sensor_office_motion_occupancy\",\"old_state\":{\"entity_id\":\"binary_sensor.sensor_office_motion_occupancy\",\"state\":\"off\",\"attributes\":{\"battery\":100,\"device\":{\"applicationVersion\":11,\"friendlyName\":\"sensor_office_motion\",\"ieeeAddr\":\"0x00158d0002281294\",\"manufacturerID\":4151,\"manufacturerName\":\"LUMI\",\"model\":\"RTCGQ01LM\",\"networkAddress\":28396,\"powerSource\":\"Battery\",\"type\":\"EndDevice\"},\"linkquality\":87,\"occupancy\":false,\"power_outage_count\":77,\"voltage\":3075,\"device_class\":\"motion\",\"friendly_name\":\"Hotbox Down Motion_occupancy\"},\"last_changed\":\"2023-08-03T13:07:10.739670+00:00\",\"last_updated\":\"2023-08-03T13:07:10.739670+00:00\",\"context\":{\"id\":\"01H6XR4QRKMSW2KB245H9T6KFT\",\"parent_id\":null,\"user_id\":null},\"original_state\":\"off\"},\"new_state\":{\"entity_id\":\"binary_sensor.sensor_office_motion_occupancy\",\"state\":\"on\",\"attributes\":{\"battery\":100,\"device\":{\"applicationVersion\":11,\"friendlyName\":\"sensor_office_motion\",\"ieeeAddr\":\"0x00158d0002281294\",\"manufacturerID\":4151,\"manufacturerName\":\"LUMI\",\"model\":\"RTCGQ01LM\",\"networkAddress\":28396,\"powerSource\":\"Battery\",\"type\":\"EndDevice\"},\"linkquality\":87,\"occupancy\":false,\"power_outage_count\":77,\"voltage\":3075,\"device_class\":\"motion\",\"friendly_name\":\"Hotbox Down Motion_occupancy\"},\"last_changed\":\"2023-08-03T13:28:46.214518+00:00\",\"last_updated\":\"2023-08-03T13:28:46.214518+00:00\",\"context\":{\"id\":\"01H6XSC8W6W0RJ9N7G6RVXA89K\",\"parent_id\":null,\"user_id\":\"7f1de31122574f6fa2215e519d6083ea\"},\"original_state\":\"on\",\"timeSinceChangedMs\":4}},\"origin\":\"LOCAL\",\"time_fired\":\"2023-08-03T13:28:46.214518+00:00\",\"context\":{\"id\":\"01H6XSC8W6W0RJ9N7G6RVXA89K\",\"parent_id\":null,\"user_id\":\"7f1de31122574f6fa2215e519d6083ea\"}}","vt":"json"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"binary_sensor.sensor_office_motion_occupancy","payload":"off","payloadType":"str","x":860,"y":1880,"wires":[["e4addfdc3f2206af"]]},{"id":"3b555b893e95ad45","type":"change","z":"03d6b46677a5b50f","name":"rules","rules":[{"t":"move","p":"payload.data","pt":"msg","to":"payload.olddata","tot":"msg"},{"t":"delete","p":"room","pt":"msg"},{"t":"delete","p":"room_sleepers","pt":"msg"},{"t":"move","p":"entity_id","pt":"msg","to":"payload.data.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":3950,"y":1900,"wires":[["47324fd399b388cf"]]},{"id":"5b9387942e9a5211","type":"api-current-state","z":"666f64b87ddc48a7","name":"Kink?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.kink_party","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":770,"y":400,"wires":[["19a8d6d6a819bbae"],[]]},{"id":"338077fbb9f91c33","type":"switch","z":"666f64b87ddc48a7","name":"","property":"video","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":610,"y":400,"wires":[["5b9387942e9a5211"]]},{"id":"19a8d6d6a819bbae","type":"api-current-state","z":"666f64b87ddc48a7","name":"Party","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"input_boolean.party_mode","state_type":"str","blockInputOverrides":false,"outputProperties":[],"for":0,"forType":"num","forUnits":"minutes","x":950,"y":400,"wires":[["958e7e748bad9e90"],[]]},{"id":"4ac9c0290a4539cc","type":"trigger","z":"666f64b87ddc48a7","name":"TV Fuse","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"10","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":460,"y":400,"wires":[["338077fbb9f91c33"]]},{"id":"958e7e748bad9e90","type":"ha-get-entities","z":"666f64b87ddc48a7","name":"Get ChromecastMedia players","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.(?!plex)(?!universal)(?!template).*_chromecast","valueType":"re"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1210,"y":400,"wires":[["58f220515c793b88","e380bd3a43559191"]]},{"id":"5ea4c3b50a5cee30","type":"change","z":"666f64b87ddc48a7","name":"Set Data for mass alert","rules":[{"t":"move","p":"payload.data.title","pt":"msg","to":"message","tot":"msg"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"},{"t":"set","p":"video","pt":"msg","to":"on","tot":"str"},{"t":"set","p":"video_content","pt":"msg","to":"https://hass.purgatoire.ca/local/pakidge.jpg","tot":"str","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":260,"y":400,"wires":[["4ac9c0290a4539cc"]]},{"id":"58f220515c793b88","type":"debug","z":"666f64b87ddc48a7","name":"alert","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1490,"y":360,"wires":[]},{"id":"e380bd3a43559191","type":"switch","z":"666f64b87ddc48a7","name":"state?","property":"payload.state","propertyType":"msg","rules":[{"t":"eq","v":"playing","vt":"str"},{"t":"nnull"}],"checkall":"false","repair":false,"outputs":2,"x":1510,"y":400,"wires":[["8f1946a851c57c44"],["5b1c993c8ee963e0"]]},{"id":"d2f06ad8a569630d","type":"inject","z":"666f64b87ddc48a7","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":2620,"y":580,"wires":[["5ea4c3b50a5cee30"]]},{"id":"8f1946a851c57c44","type":"function","z":"666f64b87ddc48a7","name":"Javascript","func":"var video_content = msg.video_content;\nvar entity_id = msg.payload.entity_id;\n\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n     \"entity_id\": entity_id\n}\n }\n};\nreturn newMsg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1660,"y":360,"wires":[["4b6e8b79a3f8fd2e"]]},{"id":"4b6e8b79a3f8fd2e","type":"api-call-service","z":"666f64b87ddc48a7","name":"Pause playback","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_pause","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"result","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1880,"y":360,"wires":[[]]},{"id":"0e557ba60c5d54f7","type":"function","z":"666f64b87ddc48a7","name":"prepare Regex to check other motion sensors","func":"var room = msg.payload.entity_id.replace(\"_chromecast\", \".*_tv\");\nvar video_content = msg.video_content;\nconst rules_object = [{ 'property': 'entity_id', 'logic': 'is', 'value': room, 'valueType': 're' }, { 'property': 'attributes.source' ,  'logic': 'is' , 'value': \"chromecast\" ,  'valueType': 'str' }];// arranges the array \nvar entity_id = msg.payload.entity_id;\n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object},\n    \"room\": room,\n    \"entity_id\": entity_id,\n    \"video_content\": video_content\n\n}\nreturn msg;\n\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":1790,"y":460,"wires":[["c1850e3a966890d0","5eea42ca3208ea7b"]]},{"id":"c1850e3a966890d0","type":"ha-get-entities","z":"666f64b87ddc48a7","name":"Get Smart TVs","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"split","output_empty_results":true,"output_location_type":"msg","output_location":"tv_entities","output_results_count":1,"x":2120,"y":460,"wires":[["2d02f435b884fbe2","6a497306eef0315f"]]},{"id":"5eea42ca3208ea7b","type":"debug","z":"666f64b87ddc48a7","name":"debug 315","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1990,"y":400,"wires":[]},{"id":"7b933c9e182f2076","type":"function","z":"666f64b87ddc48a7","name":"Javascript","func":"var video_content = msg.video_content;\nvar entity_id = msg.payload.entity_id;\n\nvar newMsg = {\n \"payload\": {\n  \"data\": {\n     \"media_content_id\": video_content,\n      \"media_content_type\": \"image/jpeg\",\n     \"entity_id\": entity_id\n}\n }\n};\nreturn newMsg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":3420,"y":460,"wires":[["bb314661a27d1635"]]},{"id":"2d02f435b884fbe2","type":"debug","z":"666f64b87ddc48a7","name":"debug 314","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2850,"y":380,"wires":[]},{"id":"bb314661a27d1635","type":"api-call-service","z":"666f64b87ddc48a7","name":"Cast reolink image","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"payload","valueType":"msg"}],"queue":"none","x":3630,"y":460,"wires":[["055a2e97d5c19c6f"]]},{"id":"055a2e97d5c19c6f","type":"trigger","z":"666f64b87ddc48a7","name":"this seems to erase the payload to stop broadcast","op1":"","op2":"","op1type":"nul","op2type":"pay","duration":"50","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"topic","topic":"payload.data.entity_id","outputs":1,"x":3950,"y":460,"wires":[["01c18e83827d4acd"]]},{"id":"01c18e83827d4acd","type":"change","z":"666f64b87ddc48a7","name":"remove inutile data","rules":[{"t":"delete","p":"payload.data.media_content_id","pt":"msg"},{"t":"delete","p":"payload.data.media_content_type","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":4290,"y":460,"wires":[["9ed8e93f67e608d2"]]},{"id":"9ed8e93f67e608d2","type":"api-call-service","z":"666f64b87ddc48a7","name":"Remove alert","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"result","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":4510,"y":460,"wires":[[]]},{"id":"87f389916d72367f","type":"ha-get-entities","z":"666f64b87ddc48a7","name":"Get ChromecastMedia players","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"media_player\\.(?!plex)(?!universal)(?!template).*_chromecast","valueType":"re"},{"property":"entity_id","logic":"does_not_include","value":"tv_entities","valueType":"msg"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":3170,"y":460,"wires":[["18744442ceacacb7","7b933c9e182f2076"]]},{"id":"8eed6c092d20111b","type":"change","z":"666f64b87ddc48a7","name":"","rules":[{"t":"move","p":"payload.entity_id","pt":"msg","to":"tv_entities","tot":"msg"},{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2880,"y":460,"wires":[["87f389916d72367f","09b9cd5cc352131e"]]},{"id":"18744442ceacacb7","type":"debug","z":"666f64b87ddc48a7","name":"debug 316","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3410,"y":360,"wires":[]},{"id":"6a497306eef0315f","type":"join","z":"666f64b87ddc48a7","name":"","mode":"custom","build":"array","property":"payload.entity_id","propertyType":"msg","key":"payload.entity_id","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"1","count":"4","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"num","reduceFixup":"","x":2530,"y":460,"wires":[["c2b9a83e99913c61","8eed6c092d20111b"]]},{"id":"09b9cd5cc352131e","type":"debug","z":"666f64b87ddc48a7","name":"debug 317","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3090,"y":340,"wires":[]},{"id":"c2b9a83e99913c61","type":"debug","z":"666f64b87ddc48a7","name":"debug 318","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2750,"y":540,"wires":[]},{"id":"aa81cc5ee75d6c63","type":"api-call-service","z":"60d15080ad880ed5","name":"cast to display","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":["media_player.living_room_tv"],"data":"{\"media_content_type\":\"image\",\"media_content_id\":\"http://192.168.0.15:8123/local/reolink.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":820,"y":1000,"wires":[["73ce0a9ed9c98f8f"]]},{"id":"73ce0a9ed9c98f8f","type":"trigger","z":"60d15080ad880ed5","name":"","op1":"","op2":"1","op1type":"nul","op2type":"num","duration":"20","extend":false,"units":"s","reset":"closed","bytopic":"all","outputs":1,"x":1010,"y":1000,"wires":[["cc7881c3657ee8e1"]]},{"id":"cc7881c3657ee8e1","type":"api-call-service","z":"60d15080ad880ed5","name":"change source","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"select_source","areaId":[],"deviceId":[],"entityId":["media_player.living_room_lg"],"data":"{\"source\":\"HDMI 2\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1180,"y":1000,"wires":[[]]},{"id":"c710a60112927245","type":"api-current-state","z":"60d15080ad880ed5","name":"Living Room  TV?","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"playing","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.living_room_tv","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"input","propertyType":"msg","value":"","valueType":"entityState"}],"for":0,"forType":"num","forUnits":"minutes","x":270,"y":980,"wires":[["89582a6e689437b6"],["92e9d937121cce70"]]},{"id":"89582a6e689437b6","type":"change","z":"60d15080ad880ed5","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":480,"y":960,"wires":[["4bfc8ef846a9971f"]]},{"id":"4bfc8ef846a9971f","type":"api-call-service","z":"60d15080ad880ed5","name":"pause living room tv","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"media_pause","areaId":[],"deviceId":[],"entityId":[],"data":"{\"entity_id\":\"media_player.living_room_tv\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":680,"y":960,"wires":[[]]},{"id":"92e9d937121cce70","type":"api-current-state","z":"60d15080ad880ed5","name":"Living Room LG?","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"media_player.living_room_lg","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"input","propertyType":"msg","value":"","valueType":"entityState"}],"for":0,"forType":"num","forUnits":"minutes","x":490,"y":1000,"wires":[["086c4b2caa05f483"]]},{"id":"086c4b2caa05f483","type":"switch","z":"60d15080ad880ed5","name":"","property":"payload.attributes.source","propertyType":"msg","rules":[{"t":"eq","v":"HDMI 2","vt":"str"},{"t":"neq","v":"HDMI 2","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":650,"y":1000,"wires":[["aa81cc5ee75d6c63"],["6e209500758d0fbb"]]},{"id":"6e209500758d0fbb","type":"api-call-service","z":"60d15080ad880ed5","name":"cast to display","server":"7ab5c227.a3ce8c","version":5,"debugenabled":true,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":["media_player.living_room_tv"],"data":"{\"media_content_type\":\"image\",\"media_content_id\":\"https://hass.purgatoire.ca/local/reolink.jpg\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":820,"y":1040,"wires":[["57925d66f1757bcb"]]},{"id":"57925d66f1757bcb","type":"trigger","z":"60d15080ad880ed5","name":"","op1":"","op2":"1","op1type":"nul","op2type":"num","duration":"20","extend":false,"units":"s","reset":"closed","bytopic":"all","outputs":1,"x":1010,"y":1040,"wires":[["1093d5b5ae877ab1"]]},{"id":"1093d5b5ae877ab1","type":"api-call-service","z":"60d15080ad880ed5","name":"stop","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_stop","areaId":[],"deviceId":[],"entityId":["media_player.living_room_tv"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"data"}],"queue":"none","x":1150,"y":1040,"wires":[[]]},{"id":"bbac801cfca12719","type":"inject","z":"60d15080ad880ed5","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":80,"y":980,"wires":[["c710a60112927245"]]},{"id":"be1856fa89c02c1c","type":"subflow:dfb97c6505f003d9","z":"60d15080ad880ed5","name":"","x":2000,"y":960,"wires":[]},{"id":"222c6ea37fc5f1fd","type":"inject","z":"60d15080ad880ed5","name":"","props":[{"p":"color_value","v":"[0,255,0]","vt":"json"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":1410,"y":920,"wires":[["8d7549550611cb06"]]},{"id":"d33f7d1e61b49a33","type":"api-call-service","z":"60d15080ad880ed5","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3080,"y":900,"wires":[["af7106e55fc26559"]]},{"id":"6c75e24a2f371759","type":"change","z":"60d15080ad880ed5","name":"","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"entity_old.attributes.rgb_color","tot":"msg"},{"t":"set","p":"payload.data.brightness","pt":"msg","to":"entity_old.attributes.brightness","tot":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2680,"y":900,"wires":[["b53220987b3f75a3"]]},{"id":"b53220987b3f75a3","type":"template","z":"60d15080ad880ed5","name":"Extract status","field":"payload.service","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"\"turn_{{status}}\"","output":"json","x":2880,"y":900,"wires":[["d33f7d1e61b49a33"]]},{"id":"6180b4ada706bc70","type":"delay","z":"60d15080ad880ed5","name":"","pauseType":"random","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"1","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":2500,"y":900,"wires":[["6c75e24a2f371759"]]},{"id":"8b5fc8b2dddd61a9","type":"change","z":"60d15080ad880ed5","name":"rules","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"color_value","tot":"msg"},{"t":"set","p":"payload.data.brightness_pct","pt":"msg","to":"dbrigthness","tot":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2120,"y":900,"wires":[["0e26c518c4b7f87f"]]},{"id":"0e26c518c4b7f87f","type":"api-call-service","z":"60d15080ad880ed5","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2280,"y":900,"wires":[["6180b4ada706bc70"]]},{"id":"af7106e55fc26559","type":"api-current-state","z":"60d15080ad880ed5","name":"light.bedroom_lights","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.bedroom_lights","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":3320,"y":900,"wires":[["e48b0a2a6c0e603e"]]},{"id":"e48b0a2a6c0e603e","type":"switch","z":"60d15080ad880ed5","name":"!=rain","property":"data.attributes.rgb_color","propertyType":"msg","rules":[{"t":"eq","v":"color_value","vt":"msg"}],"checkall":"true","repair":false,"outputs":1,"x":3190,"y":860,"wires":[["d33f7d1e61b49a33"]]},{"id":"0cdd0984f0759061","type":"debug","z":"60d15080ad880ed5","name":"1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":870,"y":1300,"wires":[]},{"id":"8426df596c13d4de","type":"api-current-state","z":"60d15080ad880ed5","name":"light.bedroom_lights","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.bedroom_lights","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"status","propertyType":"msg","value":"","valueType":"entityState"},{"property":"entity_old","propertyType":"msg","value":"","valueType":"entity"},{"property":"entity_id","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","x":1940,"y":900,"wires":[["8b5fc8b2dddd61a9"]],"outputLabels":["data.attributes"]},{"id":"f7f702600182309f","type":"inject","z":"60d15080ad880ed5","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"str","x":490,"y":1180,"wires":[["4c4ce8679c935e51"]]},{"id":"59e7c8fdee91b212","type":"change","z":"60d15080ad880ed5","name":"","rules":[{"t":"set","p":"payload.data","pt":"msg","to":"{}","tot":"json"},{"t":"delete","p":"payload.data.brightness","pt":"msg"},{"t":"move","p":"entity_inital.attributes.rgb_color","pt":"msg","to":"payload.data.rgb_color","tot":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"data.entity_id","tot":"msg"},{"t":"set","p":"payload.data.brightness","pt":"msg","to":"entity_inital.attributes.brightness","tot":"msg"},{"t":"delete","p":"entity_inital","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1820,"y":1060,"wires":[[]]},{"id":"be8acf73221c1b19","type":"debug","z":"60d15080ad880ed5","name":"3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1710,"y":1040,"wires":[]},{"id":"303a3c5c50022a22","type":"debug","z":"60d15080ad880ed5","name":"4","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1990,"y":1040,"wires":[]},{"id":"4961393dfa77fc29","type":"change","z":"60d15080ad880ed5","name":"","rules":[{"t":"set","p":"payload.data","pt":"msg","to":"{}","tot":"json"},{"t":"delete","p":"payload.data.brightness","pt":"msg"},{"t":"move","p":"entity_inital.attributes.rgb_color","pt":"msg","to":"payload.data.rgb_color","tot":"msg"},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"entity_initial.entity_id","tot":"msg","dc":true},{"t":"set","p":"payload.data.brightness","pt":"msg","to":"entity_inital.attributes.brightness","tot":"msg"},{"t":"delete","p":"entity_inital","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1820,"y":1100,"wires":[[]]},{"id":"4c4ce8679c935e51","type":"change","z":"60d15080ad880ed5","name":"Set Data for light alert","rules":[{"t":"set","p":"color_value","pt":"msg","to":"[0,255,0]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"},{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"message","pt":"msg","to":"this is a test","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":680,"y":1180,"wires":[["7b1ae33189e60228"]]},{"id":"7b1ae33189e60228","type":"subflow:233ac7dcd801a802","z":"60d15080ad880ed5","name":"","x":930,"y":1180,"wires":[]},{"id":"ad0f7b2d36c619f1","type":"switch","z":"60d15080ad880ed5","name":"","property":"message","propertyType":"msg","rules":[{"t":"nempty"}],"checkall":"true","repair":false,"outputs":1,"x":810,"y":1700,"wires":[["09feb048bb363c03"]]},{"id":"652818978159b5a1","type":"trigger","z":"60d15080ad880ed5","name":"MEssage fuse","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"10","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":580,"y":1700,"wires":[["ad0f7b2d36c619f1"]]},{"id":"11c9492a3ef65fc0","type":"api-call-service","z":"60d15080ad880ed5","name":"play media","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"tts","service":"google_translate_say","areaId":[],"deviceId":[],"entityId":["media_player.group_home_speakers","media_player.group_home_speakers"],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1630,"y":2280,"wires":[[]]},{"id":"ed8c945d46b67b07","type":"change","z":"60d15080ad880ed5","name":"Set Data for mass alert","rules":[{"t":"set","p":"message","pt":"msg","to":"testing alerts","tot":"str"},{"t":"set","p":"color_value","pt":"msg","to":"[0,0,255]","tot":"json"},{"t":"set","p":"dbrigthness","pt":"msg","to":"100","tot":"num"},{"t":"set","p":"video","pt":"msg","to":"on","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":420,"y":1460,"wires":[["6b5b11bea220d3eb"]]},{"id":"c6344df5235a60a4","type":"inject","z":"60d15080ad880ed5","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":200,"y":1460,"wires":[["ed8c945d46b67b07"]]},{"id":"67f34e4b412cdbe1","type":"debug","z":"60d15080ad880ed5","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1370,"y":2240,"wires":[]},{"id":"4f4afa06302200e9","type":"change","z":"60d15080ad880ed5","name":"Set message","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"payload.data.message","pt":"msg","to":"message","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1130,"y":2280,"wires":[["11c9492a3ef65fc0","67f34e4b412cdbe1"]]},{"id":"09feb048bb363c03","type":"function","z":"60d15080ad880ed5","name":" Set payload for play media ","func":"var msg = {\n    \"payload\": {\n      \"message\": msg.message\n}\n\n}\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1160,"y":1580,"wires":[["b33b62e88fc77332"]]},{"id":"b33b62e88fc77332","type":"http request","z":"60d15080ad880ed5","name":"POST request","method":"POST","ret":"obj","paytoqs":"ignore","url":"http://192.168.0.14:8085/broadcast","tls":"","persist":false,"proxy":"","authType":"","senderr":false,"x":1480,"y":1580,"wires":[["48d1de5a66fe3a06"]]},{"id":"48d1de5a66fe3a06","type":"debug","z":"60d15080ad880ed5","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1690,"y":1580,"wires":[]},{"id":"6d2299d0388ebbf2","type":"api-call-service","z":"60d15080ad880ed5","name":"play visuals","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"play_media","areaId":[],"deviceId":[],"entityId":["media_player.bedroom_chromecast"],"data":"{\"media_content_id\":\"jellyfin://{ \\\"title\\\": \\\"Forest Gump\\\" }\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":650,"y":2060,"wires":[[]]},{"id":"e6585439391aca1b","type":"inject","z":"60d15080ad880ed5","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":330,"y":2080,"wires":[["6d2299d0388ebbf2"]]},{"id":"6b5b11bea220d3eb","type":"ha-get-entities","z":"60d15080ad880ed5","name":"Get Lights","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"^light.*[a-z].*(?<!s)$","valueType":"re"},{"property":"state","logic":"is_not","value":"unavailable","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":690,"y":1460,"wires":[["92b0b1407620f85f"]]},{"id":"92b0b1407620f85f","type":"switch","z":"60d15080ad880ed5","name":"Check color support","property":"payload.attributes.supported_color_modes","propertyType":"msg","rules":[{"t":"cont","v":"xy","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":940,"y":1460,"wires":[["d381e97329e6ef70"]]},{"id":"d381e97329e6ef70","type":"switch","z":"60d15080ad880ed5","name":"Check initial light state","property":"payload.state","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1220,"y":1460,"wires":[["53c674301a0a2c44"],["66053ed75200fe0b"]]},{"id":"2c01270cd7ece713","type":"comment","z":"60d15080ad880ed5","name":"Pull all individual lights","info":"","x":700,"y":1420,"wires":[]},{"id":"7936d2da68036493","type":"comment","z":"60d15080ad880ed5","name":"Check if they support color","info":"","x":950,"y":1420,"wires":[]},{"id":"d7063b9d3964f17a","type":"api-call-service","z":"60d15080ad880ed5","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1680,"y":1420,"wires":[["e2741e1d14fbc480"]]},{"id":"53c674301a0a2c44","type":"change","z":"60d15080ad880ed5","name":"Set desired Values","rules":[{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"color_value","tot":"msg","dc":true},{"t":"set","p":"payload.data.brightness_pct","pt":"msg","to":"dbrigthness","tot":"msg","dc":true},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1450,"y":1420,"wires":[["d7063b9d3964f17a"]]},{"id":"64b3e9d7919fccc1","type":"change","z":"60d15080ad880ed5","name":"Set Initial color","rules":[{"t":"delete","p":"payload.data.brightness_pct","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"payload.attributes.rgb_color","tot":"msg","dc":true},{"t":"set","p":"payload.data.brightness","pt":"msg","to":"payload.attributes.brightness","tot":"msg","dc":true},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":2160,"y":1420,"wires":[["d1c74c92d8b884d1"]]},{"id":"d1c74c92d8b884d1","type":"api-call-service","z":"60d15080ad880ed5","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2380,"y":1420,"wires":[[]]},{"id":"e2741e1d14fbc480","type":"delay","z":"60d15080ad880ed5","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1940,"y":1420,"wires":[["64b3e9d7919fccc1"]]},{"id":"471d148223611eac","type":"api-call-service","z":"60d15080ad880ed5","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1680,"y":1500,"wires":[["4006deb6767c7ac9"]]},{"id":"66053ed75200fe0b","type":"change","z":"60d15080ad880ed5","name":"Set desired Values","rules":[{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"color_value","tot":"msg","dc":true},{"t":"set","p":"payload.data.brightness_pct","pt":"msg","to":"dbrigthness","tot":"msg","dc":true},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1450,"y":1500,"wires":[["471d148223611eac"]]},{"id":"cde3dacab7301554","type":"api-call-service","z":"60d15080ad880ed5","name":"Turn off lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2360,"y":1500,"wires":[[]]},{"id":"4006deb6767c7ac9","type":"delay","z":"60d15080ad880ed5","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":1940,"y":1500,"wires":[["1fcdac9ab0cf1f3f"]]},{"id":"1fcdac9ab0cf1f3f","type":"change","z":"60d15080ad880ed5","name":"Set entity","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true},{"t":"delete","p":"payload.data.rgb_color","pt":"msg"},{"t":"delete","p":"payload.data.brightness_pct","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2160,"y":1500,"wires":[["cde3dacab7301554"]]},{"id":"6e2778b658d06197","type":"server-state-changed","z":"60d15080ad880ed5","name":"Motion Kitchen ON","server":"7ab5c227.a3ce8c","version":4,"outputs":2,"for":0,"forType":"num","forUnits":"minutes","ignorePrevStateNull":false,"ignorePrevStateUnknown":false,"ignorePrevStateUnavailable":false,"ignoreCurrentStateUnknown":false,"ignoreCurrentStateUnavailable":false,"outputProperties":[{"property":"sensor","propertyType":"msg","value":"","valueType":"triggerId"},{"property":"sensorstate","propertyType":"msg","value":"","valueType":"entityState"}],"exposeToHomeAssistant":false,"haConfig":[{"property":"name","value":""},{"property":"icon","value":""}],"entityidfilter":"group.motion_kitchen_group","entityidfiltertype":"regex","outputinitially":false,"state_type":"str","haltifstate":"on","halt_if_type":"str","halt_if_compare":"is","output_only_on_state_change":false,"x":210,"y":840,"wires":[[],[]]},{"id":"ca492510b6db0635","type":"api-current-state","z":"60d15080ad880ed5","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":2,"halt_if":"off","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.group_kitchen_lights","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"entity.entity_id","propertyType":"msg","value":"","valueType":"triggerId"},{"property":"topic","propertyType":"msg","value":"","valueType":"triggerId"}],"for":0,"forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":520,"y":840,"wires":[["9a2813dc56837f7b"],[]]},{"id":"9a2813dc56837f7b","type":"subflow:cd4b600533b9308c","z":"60d15080ad880ed5","name":"","x":820,"y":840,"wires":[]},{"id":"39ad5887f056ac7d","type":"comment","z":"60d15080ad880ed5","name":"Motion group on","info":"","x":200,"y":800,"wires":[]},{"id":"160142c2e085fef4","type":"comment","z":"60d15080ad880ed5","name":"Set light","info":"","x":470,"y":800,"wires":[]},{"id":"c9c8c07687c1bcd3","type":"comment","z":"60d15080ad880ed5","name":"Send to subflow","info":"","x":820,"y":800,"wires":[]},{"id":"ecf585a68fd38734","type":"debug","z":"60d15080ad880ed5","name":"1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":210,"y":700,"wires":[]},{"id":"cdedcc37df6c93eb","type":"debug","z":"60d15080ad880ed5","name":"4","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2050,"y":700,"wires":[]},{"id":"b4a9eaa2f2ec29a7","type":"debug","z":"60d15080ad880ed5","name":"3","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2090,"y":660,"wires":[]},{"id":"b157de1ed8d94494","type":"debug","z":"60d15080ad880ed5","name":"5","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2530,"y":700,"wires":[]},{"id":"4a67b311648353b8","type":"debug","z":"60d15080ad880ed5","name":"6","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3190,"y":680,"wires":[]},{"id":"40a542aa75e3c089","type":"debug","z":"60d15080ad880ed5","name":"7","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2950,"y":720,"wires":[]},{"id":"f51a64fec283f48b","type":"inject","z":"60d15080ad880ed5","name":"","props":[{"p":"topic","vt":"str"},{"p":"data","v":"{\"event_type\":\"state_changed\",\"entity_id\":\"binary_sensor.sensor_hotbox_exit_motion_occupancy\",\"event\":{\"entity_id\":\"binary_sensor.sensor_hotbox_exit_motion_occupancy\",\"old_state\":{\"entity_id\":\"binary_sensor.sensor_hotbox_exit_motion_occupancy\",\"state\":\"off\",\"attributes\":{\"battery\":100,\"device\":{\"applicationVersion\":11,\"dateCode\":\"20160524\",\"friendlyName\":\"sensor_hotbox_exit_motion\",\"hardwareVersion\":2,\"ieeeAddr\":\"0x00158d0002c087b5\",\"manufacturerID\":4151,\"manufacturerName\":\"LUMI\",\"model\":\"RTCGQ01LM\",\"networkAddress\":36543,\"powerSource\":\"Battery\",\"softwareBuildID\":\"3000-0001\",\"stackVersion\":2,\"type\":\"EndDevice\",\"zclVersion\":1},\"linkquality\":43,\"occupancy\":true,\"voltage\":3025,\"device_class\":\"motion\",\"friendly_name\":\"sensor_hotbox_exit_motion_occupancy\"},\"last_changed\":\"2022-07-26T20:23:59.903455+00:00\",\"last_updated\":\"2022-07-26T20:42:49.530541+00:00\",\"context\":{\"id\":\"01G8Y3YYSTXRNQ9ZF613DY6W5N\",\"parent_id\":null,\"user_id\":null},\"original_state\":\"off\"},\"new_state\":{\"entity_id\":\"binary_sensor.sensor_hotbox_exit_motion_occupancy\",\"state\":\"off\",\"attributes\":{\"battery\":100,\"device\":{\"applicationVersion\":11,\"dateCode\":\"20160524\",\"friendlyName\":\"sensor_hotbox_exit_motion\",\"hardwareVersion\":2,\"ieeeAddr\":\"0x00158d0002c087b5\",\"manufacturerID\":4151,\"manufacturerName\":\"LUMI\",\"model\":\"RTCGQ01LM\",\"networkAddress\":36543,\"powerSource\":\"Battery\",\"softwareBuildID\":\"3000-0001\",\"stackVersion\":2,\"type\":\"EndDevice\",\"zclVersion\":1},\"linkquality\":43,\"occupancy\":true,\"voltage\":3025,\"device_class\":\"motion\",\"friendly_name\":\"sensor_hotbox_exit_motion_occupancy\"},\"last_changed\":\"2022-07-26T20:42:49.530862+00:00\",\"last_updated\":\"2022-07-26T20:42:49.530862+00:00\",\"context\":{\"id\":\"01G8Y3YYSTC5JNKK4JCEF1WQNQ\",\"parent_id\":null,\"user_id\":null},\"original_state\":\"on\",\"timeSinceChangedMs\":9}},\"origin\":\"LOCAL\",\"time_fired\":\"2022-07-26T20:42:49.530862+00:00\",\"context\":{\"id\":\"01G8Y3YYSTC5JNKK4JCEF1WQNQ\",\"parent_id\":null,\"user_id\":null}}","vt":"json"},{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"binary_sensor.sensor_hotbox_exit_motion_occupancy","payload":"off","payloadType":"str","x":870,"y":700,"wires":[["ecf585a68fd38734"]]},{"id":"0e0e624ef3ca7559","type":"inject","z":"60d15080ad880ed5","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"12345","payloadType":"str","x":430,"y":1300,"wires":[["efd8d877e675377d"]]},{"id":"efd8d877e675377d","type":"function","z":"60d15080ad880ed5","name":"function 1","func":"var number = msg.payload;   // Change this \"msg.payload\" to whatever you need\n\nvar number_end = (number / 1000).toFixed(1);\n\n\nvar msg = {\n    \"payload\": {\n        \"number\": number_end\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":620,"y":1300,"wires":[["0cdd0984f0759061"]]},{"id":"402e74849cbfe580","type":"function","z":"60d15080ad880ed5","name":"Extract room from dial mqtt name and set regex to find chromecast playing","func":"var friendlyName = msg.payload.device.friendlyName; // Extract dial name\nvar room = friendlyName.replace(\"remote_\", \"\").replace(\"_dial\", \"\"); // Extract room from the name\n\n// This statement is used to allow for sub-locations in a room while controling the main room.\n// I.e: remote_livingroom_library_dial. \nif (!room.includes('hotbox')) { // Continue if the room does not containt \"hotbox\"\n    var roomtemp = room.split(\"_\"); // This is due to hotbox having two real variations of room\n    var roomfinal = roomtemp[0];\n} else {\n\n    var roomfinal = room;\n\n}\n\n\nvar action = msg.payload.action;\n\nconst rules_object = [{ 'property': 'entity_id', 'logic': 'is', 'value': \"media_player.\" + roomfinal + \"_chromecast\", 'valueType': 're' }, { 'property': 'state', 'logic': 'is', 'value': \"playing\", 'valueType': 'str' }];// arranges the array \n\nvar msg = {\n    \"payload\": { \"rules\": rules_object },\n    \"action\": action,\n    \"room\": roomfinal\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":3240,"wires":[["b2d33401cdde77da"]]},{"id":"b2d33401cdde77da","type":"ha-get-entities","z":"60d15080ad880ed5","name":"","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"array","output_empty_results":true,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":710,"y":3240,"wires":[["ad72b182e909fdf4"]]},{"id":"ad72b182e909fdf4","type":"switch","z":"60d15080ad880ed5","name":"Device present?","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"empty"}],"checkall":"true","repair":false,"outputs":2,"x":880,"y":3240,"wires":[["22b90cba8204b8d8"],["71364916a3fa9188"]]},{"id":"22b90cba8204b8d8","type":"switch","z":"60d15080ad880ed5","name":"muted?","property":"payload[0].attributes.is_volume_muted","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":1060,"y":3220,"wires":[["2350a18ac22e98b4"],["71364916a3fa9188"]]},{"id":"8227ededf045f556","type":"function","z":"60d15080ad880ed5","name":"Extract room from dial mqtt name and set regex to find speaker playing","func":"\nvar room = msg.room\nvar action = msg.action\n\nconst rules_object = [{ 'property': 'entity_id', 'logic': 'is', 'value': \"media_player.\" + room + \".*_speaker\", 'valueType': 're' }, { 'property': 'state', 'logic': 'is_not', 'value': \"off\", 'valueType': 'str' }, { 'property': 'state', 'logic': 'is_not', 'value': \"unavailable\", 'valueType': 'str' }];// arranges the array \n\nvar msg = {\n    \"payload\": { \"rules\": rules_object },\n    \"action\": action,\n    \"room\": room\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":350,"y":3300,"wires":[["f28ae5eb9b298f94"]]},{"id":"f28ae5eb9b298f94","type":"ha-get-entities","z":"60d15080ad880ed5","name":"","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"array","output_empty_results":true,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":710,"y":3300,"wires":[["75cc44445d6070d3"]]},{"id":"1e73bfe953d85067","type":"split","z":"60d15080ad880ed5","name":"Split entities","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1430,"y":3240,"wires":[["9e484da9f1aae230"]]},{"id":"75cc44445d6070d3","type":"switch","z":"60d15080ad880ed5","name":"Device present?","property":"payload","propertyType":"msg","rules":[{"t":"nempty"},{"t":"empty"}],"checkall":"true","repair":false,"outputs":2,"x":880,"y":3300,"wires":[["a151f373fbc9b9d8"],["9435748e43e9af6b"]]},{"id":"3ec3535295a275ae","type":"switch","z":"60d15080ad880ed5","name":"muted?","property":"payload[0].attributes.is_volume_muted","propertyType":"msg","rules":[{"t":"false"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":1520,"y":3300,"wires":[["1e73bfe953d85067"],["fc24a4d83551bb84"]]},{"id":"9e484da9f1aae230","type":"change","z":"60d15080ad880ed5","name":"set entity data","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":1620,"y":3240,"wires":[["748c3443362286c1"]]},{"id":"482e4d154347c1b9","type":"switch","z":"60d15080ad880ed5","name":"Play_Pause action?","property":"action","propertyType":"msg","rules":[{"t":"eq","v":"play_pause","vt":"str"},{"t":"nnull"}],"checkall":"false","repair":false,"outputs":2,"x":1380,"y":3340,"wires":[["16caf9e7df604790"],["16caf9e7df604790"]]},{"id":"748c3443362286c1","type":"switch","z":"60d15080ad880ed5","name":"Light mode off?","property":"lightmode","propertyType":"flow","rules":[{"t":"neq","v":"1","vt":"num"},{"t":"null"},{"t":"eq","v":"1","vt":"num"}],"checkall":"true","repair":false,"outputs":3,"x":1800,"y":3240,"wires":[["9ab098a019fd22ce"],["9ab098a019fd22ce"],["5469aa11819e92e8"]]},{"id":"98374cfc9c7927e4","type":"switch","z":"60d15080ad880ed5","name":"paused?","property":"payload[0].state","propertyType":"msg","rules":[{"t":"eq","v":"playing","vt":"str"},{"t":"eq","v":"paused","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":1160,"y":3300,"wires":[["4210fb87830effc6"],["8ed80b13f732fd7b"]]},{"id":"5469aa11819e92e8","type":"trigger","z":"60d15080ad880ed5","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"100","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2020,"y":3340,"wires":[["73b27ff747e845a7"]]},{"id":"73b27ff747e845a7","type":"switch","z":"60d15080ad880ed5","name":"","property":"action","propertyType":"msg","rules":[{"t":"neq","v":"","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":2170,"y":3340,"wires":[["f04ab692bd5202d4"]]},{"id":"145d1c3ddc56b191","type":"switch","z":"60d15080ad880ed5","name":"","property":"action","propertyType":"msg","rules":[{"t":"eq","v":"brightness_move_up","vt":"str"},{"t":"eq","v":"brightness_stop","vt":"str"},{"t":"eq","v":"brightness_move_down","vt":"str"},{"t":"eq","v":"toggle","vt":"str"},{"t":"eq","v":"brightness_step_up","vt":"str"},{"t":"eq","v":"brightness_step_down","vt":"str"}],"checkall":"false","repair":false,"outputs":6,"x":2050,"y":3080,"wires":[["4879ae3cc6ccd4ff"],["10e5360fcfcdfaa4"],["e7237d49aeaff20b"],["dae8d45a62564765"],["2c71f9c380155606"],["a034ef3358676a77"]]},{"id":"f04ab692bd5202d4","type":"function","z":"60d15080ad880ed5","name":"Extract room from dial mqtt name and set regex to find light groups","func":"\nvar room = msg.room;\nvar action = msg.action\n\nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': \"light.group_\" + room + \"_lights\" ,  'valueType': 're' }];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object},\n     \"action\": action,\n     \"room\": room\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":2480,"y":3340,"wires":[["3c3f3e4d5fe850f9"]]},{"id":"cdeab6f181fe9bee","type":"api-call-service","z":"60d15080ad880ed5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_up","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2650,"y":3020,"wires":[[]]},{"id":"dae8d45a62564765","type":"api-call-service","z":"60d15080ad880ed5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_play_pause","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2700,"y":3140,"wires":[[]]},{"id":"9d081c7433d48e52","type":"api-call-service","z":"60d15080ad880ed5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"volume_down","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2680,"y":3100,"wires":[[]]},{"id":"2c71f9c380155606","type":"api-call-service","z":"60d15080ad880ed5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"media_player","service":"media_next_track","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2710,"y":3180,"wires":[[]]},{"id":"a034ef3358676a77","type":"change","z":"60d15080ad880ed5","name":"set flow light mode = 1","rules":[{"t":"set","p":"lightmode","pt":"flow","to":"1","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":2620,"y":3220,"wires":[["65abf1efb2ecd4df"]]},{"id":"3c3f3e4d5fe850f9","type":"ha-get-entities","z":"60d15080ad880ed5","name":"","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"array","output_empty_results":true,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":2830,"y":3340,"wires":[["a6d74612f9e186c8"]]},{"id":"65abf1efb2ecd4df","type":"trigger","z":"60d15080ad880ed5","name":"","op1":"","op2":"0","op1type":"nul","op2type":"str","duration":"10","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":2830,"y":3220,"wires":[["86580a68d60d7b2f"]]},{"id":"a6d74612f9e186c8","type":"split","z":"60d15080ad880ed5","name":"Split entities","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":3010,"y":3340,"wires":[["b1101ae9667784fb","db7c1359712ef877"]]},{"id":"86580a68d60d7b2f","type":"change","z":"60d15080ad880ed5","name":"set flow light mode = 0","rules":[{"t":"set","p":"lightmode","pt":"flow","to":"0","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":3040,"y":3220,"wires":[[]]},{"id":"b1101ae9667784fb","type":"change","z":"60d15080ad880ed5","name":"set entity data","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":3200,"y":3340,"wires":[["83d44a4889bd23c9","103fb01b00721863"]]},{"id":"83d44a4889bd23c9","type":"switch","z":"60d15080ad880ed5","name":"","property":"action","propertyType":"msg","rules":[{"t":"eq","v":"brightness_move_up","vt":"str"},{"t":"eq","v":"brightness_stop","vt":"str"},{"t":"eq","v":"brightness_move_down","vt":"str"},{"t":"eq","v":"toggle","vt":"str"},{"t":"eq","v":"brightness_step_up","vt":"str"},{"t":"eq","v":"brightness_step_down","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":3350,"y":3340,"wires":[["347733c303de345e"],["f970561f7c491512"],["2494297b60f14c40"],["c7110136ae98e695","103fb01b00721863"],["b87a96ea2cb5463d"],[]]},{"id":"a4e835f606e98b6c","type":"function","z":"60d15080ad880ed5","name":"Extract room from motion sensor entity an extract off lights to regex","func":"var room = msg.room;\n\n\nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': \"light.\" + room ,  'valueType': 're' }];// arranges the array \n\nvar msg = {\n    \"payload\":{ \"rules\": rules_object}\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":3740,"y":3160,"wires":[["03f90739e91981f9","7d90a0c9591c08e9"]]},{"id":"71c91c7457a86584","type":"api-call-service","z":"60d15080ad880ed5","name":"Dim light","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"brightness_step_pct\": -10}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3940,"y":3340,"wires":[[]]},{"id":"c7110136ae98e695","type":"api-call-service","z":"60d15080ad880ed5","name":"","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"toggle","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3710,"y":3380,"wires":[[]]},{"id":"b87a96ea2cb5463d","type":"api-call-service","z":"60d15080ad880ed5","name":"Max white brightness","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"brightness_pct\": 100,\"color_name\": \"white\"}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3720,"y":3420,"wires":[[]]},{"id":"03f90739e91981f9","type":"debug","z":"60d15080ad880ed5","name":"debug 188","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":4090,"y":3220,"wires":[]},{"id":"7d90a0c9591c08e9","type":"ha-get-entities","z":"60d15080ad880ed5","name":"","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"","logic":"is","value":"","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":4100,"y":3160,"wires":[["b9dd9e7574ea655e","25a6b9348083ccb4"]]},{"id":"b9dd9e7574ea655e","type":"trigger","z":"60d15080ad880ed5","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"600","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"topic","topic":"payload.entity_id","outputs":1,"x":4320,"y":3140,"wires":[["4cc0cc10963787e1"]]},{"id":"25a6b9348083ccb4","type":"debug","z":"60d15080ad880ed5","name":"debug 189","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":4320,"y":3180,"wires":[]},{"id":"4cc0cc10963787e1","type":"switch","z":"60d15080ad880ed5","name":"Brightness?","property":"payload.attributes.brightness","propertyType":"msg","rules":[{"t":"null"},{"t":"lt","v":"250","vt":"str"},{"t":"gte","v":"250","vt":"str"}],"checkall":"false","repair":false,"outputs":3,"x":4510,"y":3140,"wires":[["f7d41b5b3087ef03"],["f7d41b5b3087ef03"],["20f2078298677051","85c258c3dba4d4f6"]]},{"id":"f7d41b5b3087ef03","type":"change","z":"60d15080ad880ed5","name":"set entity","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":4680,"y":3140,"wires":[["b98c62bf6b7b21b8"]]},{"id":"20f2078298677051","type":"debug","z":"60d15080ad880ed5","name":"debug 190","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":4680,"y":3180,"wires":[]},{"id":"85c258c3dba4d4f6","type":"function","z":"60d15080ad880ed5","name":"White addist","func":"// Declare variation\nvar saturation = msg.payload.attributes.hs_color[1];\nvar colorfinal = msg.payload.attributes.hs_color[0];\nvar entity_id = msg.payload.entity_id;\n\n// If saturation is over 10\nif(saturation > 10){\nvar saturationlesser = saturation - 20;\n} else if(saturation < 20){// If saturation is under 10\nvar saturationlesser = 0;\nvar colorfinal = 0;\n}\n else {\nvar saturationlesser = saturation;}\n\n\n\n\n\n\nvar newMsg = {\n    \"payload\": {\n            \"data\": {\n            \"hs_color\": [colorfinal, saturationlesser],\n            \"entity_id\": entity_id\n            }\n            }\n            \n   }\n\nreturn newMsg;\n\n\n","outputs":1,"noerr":2,"initialize":"","finalize":"","libs":[],"x":4690,"y":3220,"wires":[["5cf3e4c0c9e45a1a","666fc2c726db2a62"]]},{"id":"b98c62bf6b7b21b8","type":"api-call-service","z":"60d15080ad880ed5","name":"Brightnen light","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"brightness_step_pct\": 30}","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4920,"y":3140,"wires":[[]]},{"id":"5cf3e4c0c9e45a1a","type":"debug","z":"60d15080ad880ed5","name":"debug 191","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":4900,"y":3180,"wires":[]},{"id":"666fc2c726db2a62","type":"api-call-service","z":"60d15080ad880ed5","name":"Add white","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"jsonata","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":4900,"y":3220,"wires":[[]]},{"id":"4879ae3cc6ccd4ff","type":"trigger","z":"60d15080ad880ed5","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"-500","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"topic","topic":"topic","outputs":1,"x":2420,"y":3020,"wires":[["cdeab6f181fe9bee"]]},{"id":"db7c1359712ef877","type":"debug","z":"60d15080ad880ed5","name":"split entity","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":3200,"y":3400,"wires":[]},{"id":"103fb01b00721863","type":"debug","z":"60d15080ad880ed5","name":"debug 192","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","statusVal":"","statusType":"auto","x":3530,"y":3480,"wires":[]},{"id":"e543d558cabf7f9e","type":"mqtt in","z":"60d15080ad880ed5","name":"","topic":"zigbee2mqtt/remote_office_dial","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":170,"y":3160,"wires":[[]]},{"id":"ae8bb2afbec25bb8","type":"inject","z":"60d15080ad880ed5","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":580,"y":3060,"wires":[[]]},{"id":"784e47e50bee6476","type":"debug","z":"60d15080ad880ed5","name":"debug 193","active":true,"tosidebar":true,"console":false,"tostatus":true,"complete":"true","targetType":"full","statusVal":"payload.action","statusType":"msg","x":650,"y":3160,"wires":[]},{"id":"114aaa37e7d270b9","type":"debug","z":"60d15080ad880ed5","name":"debug 194","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":430,"y":3120,"wires":[]},{"id":"f2ce01c788075d7b","type":"switch","z":"60d15080ad880ed5","name":"payload.action","property":"payload.action","propertyType":"msg","rules":[{"t":"neq","v":"","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":420,"y":3160,"wires":[["784e47e50bee6476","402e74849cbfe580"]]},{"id":"10e5360fcfcdfaa4","type":"change","z":"60d15080ad880ed5","name":"set reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"1","tot":"str","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":2240,"y":3060,"wires":[["4879ae3cc6ccd4ff","e7237d49aeaff20b"]]},{"id":"e7237d49aeaff20b","type":"trigger","z":"60d15080ad880ed5","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"-250","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"topic","topic":"topic","outputs":1,"x":2420,"y":3080,"wires":[["9d081c7433d48e52"]]},{"id":"347733c303de345e","type":"trigger","z":"60d15080ad880ed5","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"-700","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"topic","topic":"topic","outputs":1,"x":3640,"y":3260,"wires":[["a4e835f606e98b6c"]]},{"id":"f970561f7c491512","type":"change","z":"60d15080ad880ed5","name":"set reset","rules":[{"t":"set","p":"reset","pt":"msg","to":"1","tot":"str","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":3520,"y":3320,"wires":[["347733c303de345e","2494297b60f14c40"]]},{"id":"2494297b60f14c40","type":"trigger","z":"60d15080ad880ed5","name":"","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"-400","extend":false,"overrideDelay":false,"units":"ms","reset":"","bytopic":"topic","topic":"topic","outputs":1,"x":3720,"y":3340,"wires":[["71c91c7457a86584"]]},{"id":"e967d2350da5dcbd","type":"split","z":"60d15080ad880ed5","name":"Split entities","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":530,"y":260,"wires":[["2363a0f4dd77a603"]]},{"id":"2363a0f4dd77a603","type":"change","z":"60d15080ad880ed5","name":"","rules":[{"t":"move","p":"payload","pt":"msg","to":"payload.data","tot":"msg"},{"t":"set","p":"payload.data.brightness_pct","pt":"msg","to":"100","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":700,"y":340,"wires":[[]]},{"id":"230d3ea0a4d847ef","type":"inject","z":"60d15080ad880ed5","name":"","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"1","payloadType":"str","x":90,"y":340,"wires":[["f91ad48d5c8cc841"]]},{"id":"f91ad48d5c8cc841","type":"api-current-state","z":"60d15080ad880ed5","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.group_notifications_light","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":330,"y":400,"wires":[["5b52f483c1f280fa"]]},{"id":"3d5edb80cf332733","type":"split","z":"60d15080ad880ed5","name":"Split entities","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":890,"y":400,"wires":[["f17dd0a24018a152"]]},{"id":"5b52f483c1f280fa","type":"change","z":"60d15080ad880ed5","name":"","rules":[{"t":"move","p":"data.attributes.entity_id","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":660,"y":400,"wires":[["3d5edb80cf332733"]]},{"id":"018805b61bbf1682","type":"ha-get-entities","z":"60d15080ad880ed5","name":"Get Lights","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"^light(?!.*?door.*?)(?!.*?group.*?)(?!.*?k95_rgb_2_led.*?)(?!.*?lights.*?).*[a-z].*(?<!s)$","valueType":"re"},{"property":"state","logic":"is_not","value":"unavailable","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1230,"y":400,"wires":[[]]},{"id":"f17dd0a24018a152","type":"function","z":"60d15080ad880ed5","name":"Set rules","func":"var entity_id = msg.payload;\n\nconst rules_object = [{ 'property': 'entity_id', 'logic': 'is', 'value': entity_id, 'valueType': 're' }];// arranges the array \n\nvar msg = {\n    \"payload\": { \"rules\": rules_object }\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1080,"y":400,"wires":[["018805b61bbf1682"]]},{"id":"5f07c4efd9031d47","type":"switch","z":"60d15080ad880ed5","name":"","property":"color_value","propertyType":"msg","rules":[{"t":"nempty"}],"checkall":"true","repair":false,"outputs":1,"x":510,"y":160,"wires":[["95c56796a2c13d87"]]},{"id":"95c56796a2c13d87","type":"trigger","z":"60d15080ad880ed5","name":"Lights fuse","op1":"","op2":"","op1type":"pay","op2type":"nul","duration":"10","extend":false,"overrideDelay":false,"units":"s","reset":"","bytopic":"all","topic":"topic","outputs":1,"x":670,"y":160,"wires":[["ef92c7c8c033fa73"]]},{"id":"ef92c7c8c033fa73","type":"api-current-state","z":"60d15080ad880ed5","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"light.group_notifications_light","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"payload","propertyType":"msg","value":"","valueType":"entityState"},{"property":"data","propertyType":"msg","value":"","valueType":"entity"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":930,"y":160,"wires":[["7fac1c1581ec2ae3"]]},{"id":"7fac1c1581ec2ae3","type":"change","z":"60d15080ad880ed5","name":"","rules":[{"t":"move","p":"data.attributes.entity_id","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1280,"y":160,"wires":[["506875952baeac0c"]]},{"id":"506875952baeac0c","type":"split","z":"60d15080ad880ed5","name":"Split entities","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":1510,"y":160,"wires":[["6946c4ef9bba417d"]]},{"id":"6946c4ef9bba417d","type":"function","z":"60d15080ad880ed5","name":"Set rules","func":"var entity_id = msg.payload;\nvar color_value = msg.color_value;\n\nconst rules_object = [{ 'property': 'entity_id', 'logic': 'is', 'value': entity_id, 'valueType': 're' }];// arranges the array \n\nvar msg = {\n    \"payload\": { \"rules\": rules_object }, \"color_value\": color_value\n\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1660,"y":160,"wires":[["0a62ed11d47bfd14"]]},{"id":"0a62ed11d47bfd14","type":"ha-get-entities","z":"60d15080ad880ed5","name":"Get Lights","server":"7ab5c227.a3ce8c","version":0,"rules":[],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1810,"y":160,"wires":[["52f8aa1d6cb59df8","64721dbc1abe5058"]]},{"id":"52f8aa1d6cb59df8","type":"switch","z":"60d15080ad880ed5","name":"Check color support","property":"payload.attributes.supported_color_modes","propertyType":"msg","rules":[{"t":"cont","v":"xy","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":2040,"y":160,"wires":[["47d58b62d9811738","e7c37707ea7b8ee4"]]},{"id":"47d58b62d9811738","type":"switch","z":"60d15080ad880ed5","name":"Check initial light state","property":"payload.state","propertyType":"msg","rules":[{"t":"eq","v":"on","vt":"str"},{"t":"eq","v":"off","vt":"str"}],"checkall":"false","repair":false,"outputs":2,"x":2280,"y":160,"wires":[["1f16598bbc0a7de4","26163aa62fac4b8d"],["ef8167b2107a1dd2"]]},{"id":"1f16598bbc0a7de4","type":"change","z":"60d15080ad880ed5","name":"Set desired Values","rules":[{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"color_value","tot":"msg","dc":true},{"t":"set","p":"payload.data.brightness_pct","pt":"msg","to":"dbrigthness","tot":"msg","dc":true},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2510,"y":120,"wires":[["91015b3bd2c5a3e9","26163aa62fac4b8d"]]},{"id":"ef8167b2107a1dd2","type":"change","z":"60d15080ad880ed5","name":"Set desired Values","rules":[{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"color_value","tot":"msg","dc":true},{"t":"set","p":"payload.data.brightness_pct","pt":"msg","to":"dbrigthness","tot":"msg","dc":true},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":2510,"y":200,"wires":[["bd0d96e7f8c64a2d"]]},{"id":"91015b3bd2c5a3e9","type":"api-call-service","z":"60d15080ad880ed5","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2720,"y":120,"wires":[["e57a6b867145bf7a"]]},{"id":"bd0d96e7f8c64a2d","type":"api-call-service","z":"60d15080ad880ed5","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2720,"y":200,"wires":[["83e7ec8ce5ba9bf6"]]},{"id":"e57a6b867145bf7a","type":"delay","z":"60d15080ad880ed5","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":2980,"y":120,"wires":[["15570b12c946775e"]]},{"id":"83e7ec8ce5ba9bf6","type":"delay","z":"60d15080ad880ed5","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"allowrate":false,"outputs":1,"x":2980,"y":200,"wires":[["821307b39b439363"]]},{"id":"15570b12c946775e","type":"change","z":"60d15080ad880ed5","name":"Set Initial color","rules":[{"t":"delete","p":"payload.data.brightness_pct","pt":"msg"},{"t":"set","p":"payload.data.rgb_color","pt":"msg","to":"payload.attributes.rgb_color","tot":"msg","dc":true},{"t":"set","p":"payload.data.brightness","pt":"msg","to":"payload.attributes.brightness","tot":"msg","dc":true},{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":3200,"y":120,"wires":[["105919fbaf88d2c9"]]},{"id":"821307b39b439363","type":"change","z":"60d15080ad880ed5","name":"Set entity","rules":[{"t":"set","p":"payload.data.entity_id","pt":"msg","to":"payload.entity_id","tot":"msg","dc":true},{"t":"delete","p":"payload.data.rgb_color","pt":"msg"},{"t":"delete","p":"payload.data.brightness_pct","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":3200,"y":200,"wires":[["b5d228494292d0cf"]]},{"id":"105919fbaf88d2c9","type":"api-call-service","z":"60d15080ad880ed5","name":"Change Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3420,"y":120,"wires":[[]]},{"id":"b5d228494292d0cf","type":"api-call-service","z":"60d15080ad880ed5","name":"Turn off lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_off","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":3400,"y":200,"wires":[[]]},{"id":"3d465c8581ff6bf8","type":"inject","z":"60d15080ad880ed5","name":"","props":[{"p":"color_value","v":"[0,0,255]","vt":"json"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","x":370,"y":160,"wires":[["5f07c4efd9031d47"]]},{"id":"64721dbc1abe5058","type":"debug","z":"60d15080ad880ed5","name":"1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1970,"y":220,"wires":[]},{"id":"e7c37707ea7b8ee4","type":"debug","z":"60d15080ad880ed5","name":"2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2230,"y":220,"wires":[]},{"id":"26163aa62fac4b8d","type":"debug","z":"60d15080ad880ed5","name":"2","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":2610,"y":160,"wires":[]},{"id":"7901846ee942300e","type":"mqtt in","z":"a05fceb6d51a1c04","name":"","topic":"zigbee2mqtt/remote_xiaomi_cube","qos":"2","datatype":"json","broker":"21000c19b97da572","nl":false,"rap":true,"rh":0,"inputs":0,"x":210,"y":500,"wires":[["2e46d8cd68bf0f55","5e5e43e4698ef870"]]},{"id":"2e46d8cd68bf0f55","type":"debug","z":"a05fceb6d51a1c04","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":330,"y":420,"wires":[]},{"id":"703fec6beccb3829","type":"switch","z":"a05fceb6d51a1c04","name":"action","property":"action","propertyType":"msg","rules":[{"t":"cont","v":"tap","vt":"str"},{"t":"cont","v":"right","vt":"str"},{"t":"cont","v":"left","vt":"str"},{"t":"cont","v":"shake","vt":"str"},{"t":"cont","v":"180","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":1510,"y":500,"wires":[["aad4a99c0d590c9e"],["699ac5d9aeb161e6"],["c04c50f55402136b"],["c7cd87d6084b0d77","24ae0c54fc85343b"],["97dda100fae9bded"]]},{"id":"aad4a99c0d590c9e","type":"switch","z":"a05fceb6d51a1c04","name":"FAce","property":"payload.side","propertyType":"msg","rules":[{"t":"cont","v":"0","vt":"str"},{"t":"cont","v":"1","vt":"str"},{"t":"cont","v":"2","vt":"str"},{"t":"cont","v":"3","vt":"str"},{"t":"cont","v":"4","vt":"str"},{"t":"cont","v":"5","vt":"str"}],"checkall":"false","repair":true,"outputs":6,"x":1830,"y":420,"wires":[["b17736ebd629acbd"],["f3a0202554c3ea28"],["35c5b1c4d579c2f4"],["735322aa33e55b88"],["de33686f058e0f71"],["74527edd377de7ed"]]},{"id":"699ac5d9aeb161e6","type":"api-call-service","z":"a05fceb6d51a1c04","name":"Brighten Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"brightness_step_pct\":\"25\"}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1680,"y":460,"wires":[[]]},{"id":"c04c50f55402136b","type":"api-call-service","z":"a05fceb6d51a1c04","name":"Dim Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{\"brightness_step\":-25}","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1670,"y":500,"wires":[[]]},{"id":"c7cd87d6084b0d77","type":"api-call-service","z":"a05fceb6d51a1c04","name":"Toggle Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"toggle","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1670,"y":540,"wires":[[]]},{"id":"b17736ebd629acbd","type":"api-call-service","z":"a05fceb6d51a1c04","name":"White Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{ \"color_name\": \"white\", \"brightness_pct\": \"100\" }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1990,"y":320,"wires":[[]]},{"id":"f3a0202554c3ea28","type":"api-call-service","z":"a05fceb6d51a1c04","name":"Green Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{ \"color_name\": \"green\", \"brightness_pct\": \"100\" }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1990,"y":360,"wires":[[]]},{"id":"35c5b1c4d579c2f4","type":"api-call-service","z":"a05fceb6d51a1c04","name":"Blue Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{ \"color_name\": \"blue\", \"brightness_pct\": \"100\" }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1990,"y":400,"wires":[[]]},{"id":"735322aa33e55b88","type":"api-call-service","z":"a05fceb6d51a1c04","name":"Purple Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{ \"color_name\": \"purple\", \"brightness_pct\": \"100\" }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1990,"y":440,"wires":[[]]},{"id":"de33686f058e0f71","type":"api-call-service","z":"a05fceb6d51a1c04","name":"Pink Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{ \"color_name\": \"pink\", \"brightness_pct\": \"100\" }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1990,"y":480,"wires":[[]]},{"id":"74527edd377de7ed","type":"api-call-service","z":"a05fceb6d51a1c04","name":"Red Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"{ \"color_name\": \"red\", \"brightness_pct\": \"100\" }","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":1990,"y":520,"wires":[[]]},{"id":"97dda100fae9bded","type":"function","z":"a05fceb6d51a1c04","name":"Generate Random saturated color","func":"var entity_id = msg.payload.data.entity_id\nvar hue = Math.floor(Math.random() * 360); //generate a random number up to 360\n\nvar hs_color = hue + \",60\";\nvar hs_color_array = hs_color.split(\",\");\nvar newMsg = {\n    \"payload\": {\n        \"data\": {\n            \"hs_color\": hs_color_array,\n            \"brightness_pct\": 100,\n            \"entity_id\": entity_id\n            \n}\n        }\n    }\n;\nreturn newMsg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1640,"y":660,"wires":[["c2428015969674e0","a20394293cc5a61a"]]},{"id":"c2428015969674e0","type":"api-call-service","z":"a05fceb6d51a1c04","name":"Colored Lights","server":"7ab5c227.a3ce8c","version":5,"debugenabled":false,"domain":"light","service":"turn_on","areaId":[],"deviceId":[],"entityId":[],"data":"","dataType":"json","mergeContext":"","mustacheAltTags":false,"outputProperties":[],"queue":"none","x":2000,"y":680,"wires":[[]]},{"id":"a20394293cc5a61a","type":"debug","z":"a05fceb6d51a1c04","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1990,"y":640,"wires":[]},{"id":"22e85a99e8f5c35a","type":"ha-get-entities","z":"a05fceb6d51a1c04","name":"Get Lights","server":"7ab5c227.a3ce8c","version":0,"rules":[{"property":"entity_id","logic":"is","value":"^light.*[a-z].*(?<!s)$","valueType":"re"},{"property":"state","logic":"is_not","value":"unavailable","valueType":"str"}],"output_type":"split","output_empty_results":false,"output_location_type":"msg","output_location":"payload","output_results_count":1,"x":1070,"y":500,"wires":[["36c67c699ef6d553","b1ba45db67ac7a35"]]},{"id":"f2d83e3ce5b79d1d","type":"function","z":"a05fceb6d51a1c04","name":"prepare Regex to check for lights","func":"var room = msg.room\nvar action = msg.payload.action\nvar regex = \"light\\.*\" + room + \".*_light$\"; \nconst rules_object = [{ 'property': 'entity_id' ,  'logic': 'is' , 'value': regex ,  'valueType': 're' }];// arranges the array \n\nvar msg = {\n    \"payload\": { \"rules\": rules_object },\n    \"room\": room,\n    \"action\": action\n\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":840,"y":500,"wires":[["22e85a99e8f5c35a"]]},{"id":"5e5e43e4698ef870","type":"api-current-state","z":"a05fceb6d51a1c04","name":"","server":"7ab5c227.a3ce8c","version":3,"outputs":1,"halt_if":"","halt_if_type":"str","halt_if_compare":"is","entity_id":"sensor.maxi_location_v3","state_type":"str","blockInputOverrides":false,"outputProperties":[{"property":"room","propertyType":"msg","value":"","valueType":"entityState"}],"for":"0","forType":"num","forUnits":"minutes","override_topic":false,"state_location":"payload","override_payload":"msg","entity_location":"data","override_data":"msg","x":530,"y":500,"wires":[["f2d83e3ce5b79d1d"]]},{"id":"36c67c699ef6d553","type":"debug","z":"a05fceb6d51a1c04","name":"get light","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1380,"y":400,"wires":[]},{"id":"b1ba45db67ac7a35","type":"change","z":"a05fceb6d51a1c04","name":"","rules":[{"t":"move","p":"payload.entity_id","pt":"msg","to":"payload.data.entity_id","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1280,"y":500,"wires":[["703fec6beccb3829","c0bed4c55940bcc0"]]},{"id":"c0bed4c55940bcc0","type":"debug","z":"a05fceb6d51a1c04","name":"change data","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1450,"y":440,"wires":[]},{"id":"24ae0c54fc85343b","type":"debug","z":"a05fceb6d51a1c04","name":"shake action","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":1670,"y":600,"wires":[]}]